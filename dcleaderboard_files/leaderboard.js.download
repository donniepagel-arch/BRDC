var ENV_PREFIX;
var SYNCTIMER;
var LOCSTORENABLED;
var BACK_PREFIX;
var LI;
var TOURCARD_WINNERS_MODE = false;

var global_3da_label;

var suppress_3da_msg;

/*
var MP_LABEL = {
	visible: false,
	hideTimer: null,

	show: function() {
		if (!MP_LABEL.visible) {
			$('#mp_label').animate({opacity: 1})
			MP_LABEL.visible = true;

			if (MP_LABEL.hideTimer) {
				clearTimeout(MP_LABEL.hideTimer);
			}

			MP_LABEL.hideTimer = setTimeout(function() {
				MP_LABEL.hide();
			}, 3000);

		}
	},

	hide: function() {
		if (MP_LABEL.visible) {

			if (MP_LABEL.hideTimer) {
				clearTimeout(MP_LABEL.hideTimer);
			}

			$('#mp_label').animate({opacity: 0})
			MP_LABEL.visible = false;
		}
	}
}
*/


var KIOSK_FILTER = {
    kioskSearchTimer: null,
    kioskSearchLetter: '',
    left: 0,
    kiosk_label: 'hidden',
    hold_sort: null,

    kioskSearch: function kioskSearch(that) {

        if (KIOSK_FILTER.kioskSearchLetter == that.html()) {
            // Cancel search
            $('#kiosk_searchbox span').removeClass('letter_selected');
            KIOSK_FILTER.kiosk_label = 'hidden';
            KIOSK_FILTER.kioskSearchLetter = '';

            LEADERBOARD.sort(KIOSK_FILTER.hold_sort);

            LEADERBOARD.render();
            $('html, body').animate({scrollTop: 0}, 350);
            return;
        }

        /*
        if (KIOSK_FILTER.kioskSearchTimer) {
            clearTimeout(KIOSK_FILTER.kioskSearchTimer);
            $('#kiosk_searchbox span').removeClass('letter_selected');
        }
        */

        $('#kiosk_searchbox span').removeClass('letter_selected');

        var letter = that.html();

        if (!KIOSK_FILTER.kioskSearchLetter) {
            // User has not changed from one letter to another
            KIOSK_FILTER.hold_sort = LEADERBOARD.current_sort; // Hold sort to return to
        }

        KIOSK_FILTER.kioskSearchLetter = letter;
        that.addClass('letter_selected');

        // var top = that.offset().top;
        // top += that.height();
        var left = that.offset().left;

        // $(".kiosk_label").css('left', (left - 34) + "px");

        KIOSK_FILTER.left = left - 34;
        KIOSK_FILTER.kiosk_label = 'visible';

        // $('.kiosk_label').fadeIn(100);

        if (LEADERBOARD.current_sort != 'country') {
            LEADERBOARD.sort('last_name');
        } // Filter should not interupt Country sort

        LEADERBOARD.render();

        /*
        KIOSK_FILTER.kioskSearchTimer = setTimeout(function() {
            $('#kiosk_searchbox span').removeClass('letter_selected');
            KIOSK_FILTER.kiosk_label = 'hidden';
            KIOSK_FILTER.kioskSearchLetter = '';
            LEADERBOARD.render();

            $('html, body').animate({scrollTop: 0}, 350);

        }, 20000);
        */

    },

    clearFilter: function () {
        $('#kiosk_searchbox span').removeClass('letter_selected');
        KIOSK_FILTER.kiosk_label = 'hidden';
        KIOSK_FILTER.kioskSearchLetter = '';

        LEADERBOARD.sort(KIOSK_FILTER.hold_sort);

        LEADERBOARD.render();

        $('html, body').animate({scrollTop: 0}, 350);

        /*
        if (KIOSK_FILTER.kioskSearchTimer) {
            clearTimeout(KIOSK_FILTER.kioskSearchTimer);
            // $('#kiosk_searchbox span').removeClass('letter_selected');
            // KIOSK_FILTER.kiosk_label = 'hidden';
        }
        */


    }

};


var SETTINGS = {

    newUrl: null,
    subFiltersOpen: false,
    sec2_toggle: 1,
    sec3_toggle: 1,

    processFilters: function (level) {

        var new_rollup_id = 'all'; // Default if used

        if (level == 'primary') {
            if ((SETTINGS.event_type == 'L') && (this.new.finish != 'all')) {
                // When filtering league on a rollup divsion, force sub-division to ALL
                this.new.range = 'all';
            }

            this.newUrl = '?x=' + new Date().valueOf() + '#' + this.event_type.toLowerCase() + '-' + this.new.event_id + '-';
            this.newUrl += this.new.game_filters + '-' + this.new.finish + '-' + this.new.legs + '-' + this.new.category + '-' + this.new.matchCount + '-' + this.new.range;

            SETTINGS.runFilters();
            return;
        }

        if ((this.new.event_id == this.event_id) &&
            (this.new.game_filters == this.game_filters) &&
            (this.new.finish == this.finish) &&
            (this.new.legs == this.legs) &&
            (this.new.category == this.category) &&
            (this.new.matchCount == this.matchCount) &&
            (this.new.range == this.range)) {

            $('#runFilters').removeClass('filterButtonActive');
            $('#runFilters').attr("disabled", true);

            $('#runFilters').addClass('grayButton');
            $('#runFilters').attr("disabled", true);

            return;
        }

        this.newUrl = '?x=' + new Date().valueOf() + '#' + this.event_type.toLowerCase() + '-' + this.new.event_id + '-';

        if ((SETTINGS.event_type == 'L') && (this.range != this.new.range) && (this.new.range == 'all')) {
            // Sub-division filter being removed, so re-default roll-up division
            for (var i = 0; i < LEADERBOARD.divisions.length; i++) {
                if (LEADERBOARD.divisions[i].id == this.range) {
                    if (LEADERBOARD.divisions[i].rollup_id) {
                        new_rollup_id = LEADERBOARD.divisions[i].rollup_id;
                    }
                    break;
                }
            }

        } else {
            new_rollup_id = this.new.finish;
        }

        if ((SETTINGS.event_type == 'L') && (this.new.range != 'all')) {
            // When filtering league on a sub divsion, force rollup to ALL
            this.newUrl += this.new.game_filters + '-all-' + this.new.legs + '-' + this.new.category + '-' + this.new.matchCount + '-' + this.new.range;
        } else {
            this.newUrl += this.new.game_filters + '-' + new_rollup_id + '-' + this.new.legs + '-' + this.new.category + '-' + this.new.matchCount + '-' + this.new.range;
        }

        $('#runFilters').addClass('filterButtonActive');
        $('#runFilters').removeAttr("disabled");

        $('#runFilters').removeClass('grayButton');
        $('#submenu_filters button:last-of-type').removeAttr("disabled");
    },

    filterCount: function () {
        var filters = 0;

        $('.filter_status').hide();

        if (this.matchCount != 'all') {
            filters += 1;
            $('#menu_match_count .filter_state').show();
        }
        if (this.legs != 'all') {
            filters += 1;
            $('#menu_legs .filter_state').show();
        }

        switch (SETTINGS.event_type) {
            case 'T':
                if (this.category != 'all') { // Players
                    filters += 1;
                    $('#menu_category .filter_state').show();
                }
                if (this.finish != 'all') { // Finish
                    filters += 1;
                    $('#menu_finish .filter_state').show();
                }
                break;
            case 'L':
                if (this.category != 'all') { // Players
                    filters += 1;
                    $('#menu_category .filter_state').show();
                }
                if (this.range != 'all') { // Players
                    filters += 1;
                    $('#menu_div .filter_state').show();
                }

                var leagueIdParts = SETTINGS.event_id.split('_');
                if (leagueIdParts.length == 3) {
                    if (leagueIdParts[2] != 'all') { // Season
                        filters += 1;
                        $('#menu_finish .filter_state').show();
                    }
                }
                break;
            case 'P':
                if (this.category != 'all') { // Players
                    filters += 1;
                    $('#menu_category .filter_state').show();
                }
                if (this.finish != 'all') { // History range
                    filters += 1;
                    $('#menu_finish .filter_state').show();
                }
                break;
        }

        return filters;
    },

    resetFilters: function () {

        this.new.event_id = this.event_id;
        this.new.game_filters = this.game_filters;
        this.new.finish = this.finish;
        this.new.legs = this.legs;
        this.new.category = this.category;
        this.new.matchCount = this.matchCount;
        this.new.range = this.range;

        $('.subfilter_header').find('span').html('▼');
        $('.subfilter_menu').hide();
        $('.submenu_filters_container').slideUp(120);
        SETTINGS.subFiltersOpen = false;

        $('.subfilter_menu a').removeClass('selected_filterbutton');
        LEADERBOARD.initMenus('reloadHandlers');
    },

    runFilters: function () {
        location.assign(this.newUrl);

    },

    handlePrimaryMenuClick: function (event, domElem) {
        event.preventDefault();

        var thisClass = domElem.attr('class');
        var thisProp;
        var thisId;

        var new_event_id;

        switch (thisClass) {
            case 'game_name_menu':
                thisProp = 'game_filters';
                thisId = '#menu_game_name';
                break;
            case 'season_menu':
                if (SETTINGS.event_type == 'L') {
                    thisProp = 'finish';
                } else {
                    thisProp = 'range';
                }
                thisId = '#menu_season';

                // Reset game filter for new defaults based on event chosen
                if (LEADERBOARD.bracket_interface != 'None') {
                    new_event_id = domElem.attr('name');

                    if (new_event_id) {
                        if (new_event_id.startsWith('t-t_')) {
                            location.assign('/leaderboard#' + new_event_id);
                            location.reload();
                            return;
                        }
                    }

                    if (SETTINGS.event_id.substring(0, 2) == 't_') {
                        // location.assign('/leaderboard.html#t-' + new_event_id);

                        for (var e = 0; e < LEADERBOARD.eventList.length; e++) {
                            if (String(LEADERBOARD.eventList[e].id) == String(new_event_id)) {
                                location.assign('/leaderboard#t-' + new_event_id + '-' + LEADERBOARD.eventList[e].lb_game_link + '-all-all-all-all-all');
                                location.reload();
                                return;
                            }
                        }
                        return;
                    }

                    if (new_event_id == 'all') {
                        SETTINGS.new.game_filters = 'all_01';
                    } else {

                        // Get default menu for new event chosen

                        SETTINGS.new.game_filters = 'all_01'; // Default in case we can't find it
                        for (var e = 0; e < LEADERBOARD.eventList.length; e++) {
                            if (String(LEADERBOARD.eventList[e].id) == String(new_event_id)) {
                                // alert('event default game menu to use: ' + JSON.stringify(LEADERBOARD.eventList[e].defaultMenu));


                                // SETTINGS.new.game_filters = buildGamesFilter(LEADERBOARD.eventList[e].defaultMenu);
                                SETTINGS.new.game_filters = LEADERBOARD.eventList[e].lb_game_link;


                                //alert('New game_filters = ' + SETTINGS.new.game_filters);
                                break;
                            }
                        }

                        /*
						function buildGamesFilter(defaultMenu) {
							var game_settings = '';
							if (defaultMenu.hasOwnProperty('player_format')) {
			                    game_settings = defaultMenu.player_format.toLowerCase();
			                    if (defaultMenu.game_type == '01') {
			                        game_settings += '_01_' + defaultMenu.game_name + '_' + defaultMenu.in_format.toLowerCase() + '_' + defaultMenu.out_format.toLowerCase();
			                    } else {
			                        game_settings += '_cricket';
			                    }
			                } else {
			                    game_settings = 'all_01';
			                }
			                return game_settings;
						}
						*/

                    }
                }

                break;
        }

        SETTINGS.new[thisProp] = domElem.attr('name');
        SETTINGS.processFilters('primary');

    },

    handleMenuClick: function (event, thisDomElem) {
        event.preventDefault();

        var domElem = thisDomElem.find('a');
        var thisClass = domElem.attr('class');

        $('.' + thisClass).removeClass('selected_filterbutton');
        domElem.addClass('selected_filterbutton');

        var thisProp;
        var thisId;
        var idParts;

        switch (thisClass) {
            case 'legs_menu':
                thisProp = 'legs';
                thisId = '#menu_legs';
                break;
            case 'matchcount_menu':
                thisProp = 'matchCount';
                thisId = '#menu_match_count';
                break;
            case 'category_menu':
                thisProp = 'category';
                thisId = '#menu_category';
                break;
            case 'finish_menu':
                thisProp = 'finish';
                thisId = '#menu_finish';
                break;
            case 'div_menu':
                thisProp = 'range';
                thisId = '#menu_div';
                break;
        }

        if ((thisClass == 'finish_menu') && (SETTINGS.event_type == 'L')) {
            // league season (all, reg, post)
            idParts = SETTINGS.event_id.split('_');
            if (idParts.length == 3) {
                SETTINGS.new.event_id = idParts[0] + '_' + idParts[1] + '_' + domElem.attr('name');
                if (SETTINGS.new.event_id != SETTINGS.event_id) {
                    $(thisId).addClass('menuChanged');
                } else {
                    $(thisId).removeClass('menuChanged');
                }
            } else {
                // alert('Error - bad event_id');
            }

        } else {
            SETTINGS.new[thisProp] = domElem.attr('name');

            if (SETTINGS.new[thisProp] != SETTINGS[thisProp]) {
                $(thisId).addClass('menuChanged');
            } else {
                $(thisId).removeClass('menuChanged');
            }
        }

        $(thisId + ' h2').html(domElem.html());
        $(thisId).next('div').delay(100).slideUp(250);
        $(thisId).find('span').html('▼');

        SETTINGS.processFilters();

    }

};


var AD_ROW;
var AD_ROW2;

var spin_opts = {
    lines: 13, // The number of lines to draw
    length: 20, // The length of each line
    width: 5, // The line thickness
    radius: 12, // The radius of the inner circle
    corners: 1, // Corner roundness (0..1)
    rotate: 0, // The rotation offset
    direction: 1, // 1: clockwise, -1: counterclockwise
    color: '#fff', // #rgb or #rrggbb or array of colors
    speed: 1, // Rounds per second
    trail: 60, // Afterglow percentage
    shadow: false, // Whether to render a shadow
    hwaccel: false, // Whether to use hardware acceleration
    className: 'spinner', // The CSS class to assign to the spinner
    zIndex: 2e9, // The z-index (defaults to 2000000000)
    top: '50%', // Top position relative to parent
    left: '50%' // Left position relative to parent
};

var spinner_target;
var spinner;

$(document).ready(function () {

    // Fixed header
    ;(function ($) {
        $.fn.fixMe = function () {
            return this.each(function () {
                var $this = $(this),
                    $t_fixed;

                function init() {
                    $this.wrap('<div class="container" />');
                    $t_fixed = $this.clone();
                    $t_fixed.find("tbody, tfoot").remove().end().addClass("fixed").insertBefore($this);
                    // resizeFixed();
                }

                /*
	         function resizeFixed() {
	            $t_fixed.find("th").each(function(index) {
	            	// alert($this.find("th").eq(index).outerWidth());
	               // $(this).css("width",$this.find("th").eq(index).outerWidth()+"%");
	            });
	         }
	         */
                // function scrollFixed() {
                //    var offset = $(this).scrollTop(),
                //    tableOffsetTop = $this.offset().top,
                //    tableOffsetBottom = tableOffsetTop + $this.height() - $this.find("thead").height();
                //    if(offset < tableOffsetTop || offset > tableOffsetBottom)
                //       $t_fixed.hide();
                //    else if(offset >= tableOffsetTop && offset <= tableOffsetBottom && $t_fixed.is(":hidden"))
                //       $t_fixed.show();
                //
                //   var ftr = $('.legend_container').offset().top
                //
                //   /*
                //   var lbl = $('#mp_label').offset().top
                //
                //   if (lbl > ftr) {
                //        MP_LABEL.hide();
                //   } else {
                //   	    MP_LABEL.show();
                //   }
                //   */
                //
                // }
                // // $(window).resize(resizeFixed);
                // $(window).scroll(scrollFixed);
                init();
            });
        };
    })(jQuery);

    // Pop-up mask setup
    var maskHeight = $(document).height();
    var maskWidth = $(window).width();

    $('#mask').css({
        'width': maskWidth,
        'height': maskHeight
    });

    $(window).scroll(function () {
        var height = $(window).scrollTop();

        if (height < 199) {
            $('.titlesection .sec1 span,.titlesection .sec2 span,.titlesection .sec3 span').show();
            $('.titlesection .sec1,.titlesection .sec2,.titlesection .sec3').removeClass('small');
            $('#explain-columns').removeClass('sticky');
        }

        if (height > 400) {
            $('.titlesection .sec1 span,.titlesection .sec2 span,.titlesection .sec3 span').hide();
            $('.titlesection .sec1,.titlesection .sec2,.titlesection .sec3').addClass('small');
            $('#explain-columns').addClass('sticky');
        }
    });


    $(window).resize(function () {
        var maskHeight = $(document).height();
        var maskWidth = $(window).width();

        $('#mask').css({
            'width': maskWidth,
            'height': maskHeight
        });

        SCREEN_RESIZE.resizeHandler();
    });

    $('#loginForm').submit(function (event) {
        event.preventDefault();
        login();
        return false;
    });

    $(".up").click(function () {
        $('html, body').animate({
            scrollTop: 0
        }, 2000);
    });

    $(".hideTooltips").click(function () {
        $('#tooltips').children().hide();
    })

    $(window).bind('orientationchange', function (event) {
        if ($('.shepherd-content').is(':visible')) {
            location.reload(true);
        }
    });

    // Local storage setup
    if (typeof (Storage) !== 'undefined') {
        LOCSTORENABLED = true;
    } else {
        LOCSTORENABLED = false;
    }

    setupEnvLinks();

    // leaderboard#1-2-3-4-5-6-7-8
    // 1: t = tournament; l = league; p = personal leaderboard
    // 2: event id (or member_id for Personal leaderboard)
    // 3: game type
    // 4: finish level
    // 5: legs
    // 6: category
    // 7: match count
    // 8: range (used for division in league leaderboard)

    var hashRoute = window.location.hash.toLowerCase();
    var params = hashRoute.split('-');
    var div_parts;

    spinner_target = document.getElementById('topWrapper');
    spinner = new Spinner(spin_opts).spin(spinner_target);


    if (params.length == 2) {
        // Initial leaderboard request for default filters

        if (params[0].slice(1, 2).toUpperCase() == 'L') {
            if (params[1].split('_').length != 3) {
                // Invalid league event coumpound id
                location.replace('/');
                return;
            }
        }

        if (params[0].slice(1, 2).toUpperCase() != 'P') {

            $.ajax({
                url: '/getLeaderboardInit',
                type: 'POST',
                cache: false,
                timeout: 30000,
                dataType: 'json',
                processData: false,
                contentType: 'application/json',
                data: JSON.stringify({
                    mode: params[0].slice(1, 2).toUpperCase(),
                    id: params[1]
                }),
                success: function (data) {

                    var range_param = 'all';
                    var default_event_id;

                    if (data.status == 'OK') {

                        var default_game;
                        var default_rollup_id;

                        if (data.payload.default_game.length == 1) {
                            default_game = data.payload.default_game[0];
                            /*
		            		if (default_game.event_id) {
		            			default_event_id = default_game.event_id;
		            		}
		            		*/
                        } else {
                            default_game = null;
                        }

                        if (data.payload.default_rollup_id) {
                            if (data.payload.default_rollup_id.length == 1) {
                                default_rollup_id = data.payload.default_rollup_id[0].id;
                            } else {
                                default_rollup_id = "all";
                            }
                        } else {
                            // Exception
                            default_rollup_id = "all";
                        }

                        if (params[0].slice(1, 2).toUpperCase() == 'T') {
                            if (data.bracket_interface != 'None') {
                                // Pro Event - use default event it
                                // range_param = default_event_id;
                                range_param = 'all'; // new default
                            } else {
                                // Default to Tournament Darts for tournament leaderboards
                                range_param = 'tournament';
                            }
                        }

                        // Redirect to current default menu for this event
                        if (default_game) {
                            // Example: singles_01_501_si_do
                            var game_settings = default_game.player_format.toLowerCase();
                            if (default_game.game_type == '01') {
                                game_settings += '_01_' + default_game.game_name + '_' + default_game.in_format.toLowerCase() + '_' + default_game.out_format.toLowerCase();
                            } else {
                                game_settings += '_cricket';
                            }

                            if (params[0].slice(1, 2).toUpperCase() == 'P') {
                                // Location reloaded via hash tag change listener
                                location.assign('?x=' + new Date().valueOf() + '#' + params[0].slice(1, 2).toLowerCase() + '-' + params[1] + '-' + game_settings + '-12_month-all-all-all-all');
                            } else {
                                location.assign('?x=' + new Date().valueOf() + '#' + params[0].slice(1, 2).toLowerCase() + '-' + params[1] + '-' + game_settings + '-' + default_rollup_id + '-all-all-all-' + range_param);
                            }

                        } else {
                            // Default if no matches played yet (no results)
                            location.assign('?x=' + new Date().valueOf() + hashRoute + '-all_01-' + default_rollup_id + '-all-all-all-' + range_param);

                        }

                    } else {
                        alert('Error getting event data, please try again: ' + data.status_text);

                    }
                },
                error: function (a, b, c) {
                    // alert('Could not get leaderboard: ' + JSON.stringify(a) + JSON.stringify(b) + JSON.stringify(c));
                    alert('Error initializing Leaderboard, please try again.');

                }
            });

        } else {
            // Personal leaderboard
            location.replace('?x=' + new Date().valueOf() + hashRoute + '-all_01-12_month-all-all-all-all');
        }

        return;
    }

    // Redirect to TDCTV if invalid URL is passed
    if (params.length != 8) {
        location.replace(BACK_PREFIX);
        return;
    }

    // Save URL values into SETTINGS
    SETTINGS.event_type = params[0].slice(1, 2).toUpperCase();
    SETTINGS.event_id = params[1];
    SETTINGS.game_filters = params[2];
    SETTINGS.game_filter_vals = {}; // WIll be used for data calls
    SETTINGS.finish = params[3];
    SETTINGS.legs = params[4];
    SETTINGS.category = params[5];
    SETTINGS.matchCount = params[6];
    SETTINGS.range = params[7]; // Used for division in league leaderboard
    SETTINGS.game_name_text = ''; // Holds game filter setting name to use in menu title

    // Track filter menu changes
    SETTINGS.new = {};
    SETTINGS.new.event_id = SETTINGS.event_id;
    SETTINGS.new.game_filters = SETTINGS.game_filters;
    SETTINGS.new.finish = SETTINGS.finish;
    SETTINGS.new.legs = SETTINGS.legs;
    SETTINGS.new.category = SETTINGS.category;
    SETTINGS.new.matchCount = SETTINGS.matchCount;
    SETTINGS.new.range = SETTINGS.range;


    if (localStorage.getItem(SETTINGS.event_id + '-logged_in')) {
        LI = true;
    }


    // Loading message
    switch (SETTINGS.event_type) {
        case 'T':
            SETTINGS.default_sort = 'xpr';

            if (SETTINGS.event_id.substring(0, 2) == 'a_') {
                $('#loading_msg span').html('These players throw a TON of darts!<br>This may take a minute...');

                $('#loading_msg').show();

                $('#header').addClass('black-header');
                $('#leaderboardContext .who').addClass('black-header');

                // Hide top finish menu for affiliate board
                $('#menu_finish').hide();
                $('#menu_finish').next('div').hide();
            } else {

                if (SETTINGS.event_id.substring(0, 2) == 't_') {
                    $('#loading_msg span').html('These players throw a TON of darts!<br>This may take a minute...');

                    $('#header').addClass('black-header');
                    $('#leaderboardContext .who').addClass('black-header');
                }

                $('#loading_msg').show();
            }

            break;
        case 'L':
            if (SETTINGS.finish == 'all') {
                $('#loading_msg span').html('Loading All Divisions...');
            } else {
                $('#loading_msg span').html('Loading Division Data...');
            }
            $('#loading_msg').show();
            SETTINGS.default_sort = 'xpr';

            $('#gender_tagline').html('Leagues: Update player gender in the League Portal to utilize this filter');

            break;
        case 'P':
            $('#loading_msg span').html('Loading past ' + getHistVal(SETTINGS.finish) + '...');
            $('#loading_msg').show();

            //SETTINGS.default_sort = 'last_name';
            SETTINGS.default_sort = 'matches';

            $('th.a3-ml').addClass('hilight_th');
            $('th.c1-ml').removeClass('hilight_th')
            break;
    }

    // Handle game filters
    var game_filter_vals;
    game_filter_vals = SETTINGS.game_filters.split('_'); // Game filters are underscore delimited
    // ex: singles_01_501_si_do    all_cricket   doubles_01_401_di_do   triples_cricket

    if (game_filter_vals.length == 2) {
        // all 01 or all cricket
        SETTINGS.game_filter_vals.player_format = game_filter_vals[0];
        SETTINGS.game_filter_vals.game_type = game_filter_vals[1];
        if (game_filter_vals[1] == '01') {
            SETTINGS.game_name_text = formatPlayerFormat(SETTINGS.game_filter_vals.player_format) + ' 01';
        } else {
            SETTINGS.game_name_text = formatPlayerFormat(SETTINGS.game_filter_vals.player_format) + ' Cricket';
        }
    } else {
        if (game_filter_vals.length == 5) {
            // 01 only
            SETTINGS.game_filter_vals.player_format = game_filter_vals[0];

            if (SETTINGS.game_filter_vals.player_format == 'all') {
                SETTINGS.game_filter_vals.game_type = null;
                SETTINGS.game_filter_vals.game_name = null;
                SETTINGS.game_filter_vals.in_format = null;
                SETTINGS.game_filter_vals.out_format = null;
                if (SETTINGS.event_type == 'P') {
                    SETTINGS.game_name_text = 'All 01';
                } else {
                    SETTINGS.game_name_text = 'All Singles 01';
                }
            } else {
                SETTINGS.game_filter_vals.game_type = game_filter_vals[1];
                SETTINGS.game_filter_vals.game_name = game_filter_vals[2];
                SETTINGS.game_filter_vals.in_format = game_filter_vals[3];
                SETTINGS.game_filter_vals.out_format = game_filter_vals[4];
                SETTINGS.game_name_text = formatPlayerFormat(SETTINGS.game_filter_vals.player_format) + ' ' +
                    SETTINGS.game_filter_vals.game_name + ' ' +
                    SETTINGS.game_filter_vals.in_format.toUpperCase() +
                    SETTINGS.game_filter_vals.out_format.toUpperCase();
            }
        } else {
            // Invalid URL
            location.replace(BACK_PREFIX);
            return;
        }
    }

    // PDC Q-School 2021
    if (SETTINGS.event_id == 't_125') {
        TOURCARD_WINNERS_MODE = true;

        LEADERBOARD.selected_players = {
            T: [12, 2134, 32505, 31047, 34006, 655, 30842, 11902, 33014, 317, 821, 35168, 33673, 185, 568, 31015, 32499, 231, 32068, 33013, 8820, 37349, 228, 11581, 113, 11400, 2033, 11384, 2072],
            L: [],
            P: []
        }

        LEADERBOARD.peg_selected_players = true;
        $('.toggleMarkedPlayers').html('Ungroup');
        $('.toggleMarkedPlayers').addClass('hilighted_button');

    // PDC Q-School 2022
    } else if (SETTINGS.event_id == 't_187') {
        TOURCARD_WINNERS_MODE = true;

        LEADERBOARD.selected_players = {
            T: [
                // UK
                33110,
                31030,
                32081,
                141,
                11300,
                135,
                30857,
                2040,
                220,
                254,
                667,
                162,
                732,
                31506,
                32097,
                38552,
                38854,

                // EU
                31213,
                38534,
                32895,
                35330,
                1951,
                195,
                34583,
                31212,
                35266,
                32515,
                470,
                33672,
                35013,
                229,
                10978
            ],
            L: [],
            P: []
        }

        LEADERBOARD.peg_selected_players = true;
        $('.toggleMarkedPlayers').html('Ungroup');
        $('.toggleMarkedPlayers').addClass('hilighted_button')
    // Q-School 2023
    } else if (SETTINGS.event_id == 't_348') {
        TOURCARD_WINNERS_MODE = true;

        LEADERBOARD.selected_players = {
            T: [
                // UK
                55,
                1729,
                39188,
                46,

                // Ranking
                38454, // Slevin
                30860, // Evans
                32040, // Burton
                741, // Brown
                39109, // Warner
                30931, // Hall
                183, // Perez
                570, // Kenny
                32485, // Goffin

                // EU
                33998,
                31162,
                668,
                36868, // Knoops

                // Ranking
                33630, // Kuivenhoven
                31027, // Veenstra
                33014, // Zonneveld
                39727, // Rupprecht
                960, // Huybrechts
                2771, // Sedlacek
                34958, // Klose
                11866, // Labre
                33091, // Van Veen
                33138, // Roelofs
            ],
            L: [],
            P: []
        }

        LEADERBOARD.peg_selected_players = true;
        $('.toggleMarkedPlayers').html('Ungroup');
        $('.toggleMarkedPlayers').addClass('hilighted_button');
    // Q-School 2024
    } else if (SETTINGS.event_id == 't_636') {
        TOURCARD_WINNERS_MODE = true;

        LEADERBOARD.selected_players = {
            T: [
                // UK
                1282,
                40297,
                38823,
                34992,

                // Ranking
                34135, // dennant
                32865, // borland
                32052, // richardson
                36373, // hurrell
                667, // killington
                361, // lauby
                11829, // griffin
                2033, // claydon
                32466, // beveridge
                45, // hunt

                // EU
                35012,
                892,
                33694,
                31031,

                // Ranking
                33669, // puha
                38534, // van dongen
                1951, // Szaganski
                36408, // landman
                41728, // geeraets
                35916, // van der wal
                41158, // krohne
                33281, // reus
                31213, // vandenbogaerde
                33009, // wenig
                33793, // tricole
                33719, // turetta
                36143, // wolters
            ],
            L: [],
            P: []
        }

        LEADERBOARD.peg_selected_players = true;
        $('.toggleMarkedPlayers').html('Ungroup');
        $('.toggleMarkedPlayers').addClass('hilighted_button');
    // Q-School 2025
    } else if (SETTINGS.event_id == 't_951') {
        TOURCARD_WINNERS_MODE = true;

        $('.toggleMarkedPlayers').html('Ungroup');
        $('.toggleMarkedPlayers').addClass('hilighted_button');
    } else if (LOCSTORENABLED) {
        // Init selected players
        if (localStorage.getItem('leaderboard_selected_players')) {
            try {
                var conversionRemoves = 0;
                var sp = JSON.parse(localStorage.getItem('leaderboard_selected_players'));

                if (Array.isArray(sp)) {
                    // Convert from old format
                    LEADERBOARD.selected_players = {
                        T: sp,
                        L: [],
                        P: []
                    }
                } else {
                    if (sp.hasOwnProperty('T')) {
                        for (var i = (sp.T.length - 1); i >= 0; i--) {
                            if (isNaN(sp.T[i])) {
                                if (sp.T[i].indexOf('@') != -1) {
                                    sp.T.splice(i, 1);
                                    conversionRemoves += 1;
                                }
                            }
                        }

                        if (conversionRemoves > 0) {
                            localStorage.setItem('leaderboard_selected_players', JSON.stringify(sp));
                        }

                    }

                    LEADERBOARD.selected_players = sp;
                }

                if (localStorage.getItem('leaderboard_peg_selected_players')) {
                    if (localStorage.getItem('leaderboard_peg_selected_players') == 'Y') {
                        LEADERBOARD.peg_selected_players = true;
                        $('.toggleMarkedPlayers').html('Ungroup');
                        $('.toggleMarkedPlayers').addClass('hilighted_button');
                    }
                }
            } catch (err) {
                // Silent failure
            }
        }

        if (localStorage.getItem('leaderboardSort_' + SETTINGS.event_type)) {
            try {
                var ls = JSON.parse(localStorage.getItem('leaderboardSort_' + SETTINGS.event_type));
                var last_sort_time;
                var rightNow = new Date();

                last_sort_time = new Date(ls.last_sort_time);

                if ((rightNow.valueOf() - last_sort_time.valueOf()) < (1000 * 60 * 60)) {

                    if (ls.game_type == SETTINGS.game_filter_vals.game_type) {
                        SETTINGS.default_sort = ls.last_sort;
                        LEADERBOARD.current_sort = ls.last_sort;

                        if (SETTINGS.event_type != 'P') {
                            SETTINGS.sec2_toggle = ls.sec2_toggle;
                            SETTINGS.sec3_toggle = ls.sec3_toggle;
                        }
                    } else {
                        // Game type change - fall back to default
                    }

                }

                if (SETTINGS.event_id != ls.last_event_id) {
                    // Ungroup players when user changes tournament / league / member
                    LEADERBOARD.peg_selected_players = false;
                }

            } catch (err) {
                // Silent failure
            }
        }

        if (localStorage.getItem('leaderboard_selected_matches')) {
            try {
                LEADERBOARD.selected_matches = JSON.parse(localStorage.getItem('leaderboard_selected_matches'));
            } catch (err) {
                // Silent failure
            }
        }

        if (localStorage.getItem('leaderboard_last_state')) {
            try {
                LEADERBOARD.last_state = JSON.parse(localStorage.getItem('leaderboard_last_state'));
            } catch (err) {
                // Silent failure
            }
        }
    }


    LEADERBOARD.getStats(init_page);

});

function init_handlers() {

    $('.menu_title').click(function (event) {
        event.preventDefault();
        return false;
    });

    $('.reset_home_filters').click(function () {
        if (SETTINGS.filterCount() > 0) {
            $('.reset').trigger('click');
        }
    });

    $('.reset').click(function () {
        var defaultUrl = '?x=' + new Date().valueOf() + '#';
        switch (SETTINGS.event_type.toLowerCase()) {

            case 'p':
                defaultUrl += SETTINGS.event_type.toLowerCase() + '-' + SETTINGS.event_id + '-' + SETTINGS.game_filters + '-all-all-all-all-all';
                break;

            case 'l':
                var leagueIdParts = SETTINGS.event_id.split('_');
                var default_finish = SETTINGS.finish; // roll-up division

                if ((SETTINGS.event_type == 'L') && (SETTINGS.range != 'all')) {
                    // Current sub-division filter is set, so re-default to its roll-up division
                    for (var i = 0; i < LEADERBOARD.divisions.length; i++) {
                        if (LEADERBOARD.divisions[i].id == SETTINGS.range) {
                            if (LEADERBOARD.divisions[i].rollup_id) {
                                default_finish = LEADERBOARD.divisions[i].rollup_id;
                            }
                            break;
                        }
                    }
                }

                if (leagueIdParts.length == 3) {
                    defaultUrl += SETTINGS.event_type.toLowerCase() + '-' + leagueIdParts[0] + '_' + leagueIdParts[1] + '_all-' + SETTINGS.game_filters + '-' + default_finish + '-all-all-all-all';
                } else {
                    // Exception
                    defaultUrl += SETTINGS.event_type.toLowerCase() + '-' + SETTINGS.event_id + '-' + SETTINGS.game_filters + '-' + default_finish + '-all-all-all-all';
                }
                break;

            case 't':
                if (LEADERBOARD.bracket_interface == 'None') {
                    defaultUrl += SETTINGS.event_type.toLowerCase() + '-' + SETTINGS.event_id + '-' + SETTINGS.game_filters + '-all-all-all-all-tournament';
                } else {
                    defaultUrl += SETTINGS.event_type.toLowerCase() + '-' + SETTINGS.event_id + '-' + SETTINGS.game_filters + '-all-all-all-all-' + SETTINGS.range;
                }
                break;
        }
        location.assign(defaultUrl);

    });

    $('.footerShortcut').click(function (event) {
        event.preventDefault();

    });

    $('#runFilters').click(function () {
        SETTINGS.runFilters();
    });

    $('#menufilter_cancel, .cancel_button').click(function (event) {
        event.preventDefault();
        SETTINGS.resetFilters();
    });

    $('#general_popup_cancel').click(function (event) {
        event.preventDefault();
        $('#general_popup').slideUp(120);
    });



    $('.show_subfilters').click(function (event) {
        event.preventDefault();

        if (SETTINGS.subFiltersOpen == false) {
            $('.submenu_filters_container').slideDown(120);
            SETTINGS.subFiltersOpen = true;
        } else {
            $('.submenu_filters_container').slideUp(120);
            SETTINGS.subFiltersOpen = false;
        }
    });

    $('.subfilter_header').click(function () {
        var menubox = $(this).next('div');
        $('.subfilter_menu:visible').not(menubox).prev('div').find('span').html('▼');
        $('.subfilter_menu:visible').slideUp(150);
        if ($(this).find('span').html() == '▼') {
            $(this).find('span').html('▲');
            $(this).next('div').slideDown(120);
        } else {
            $(this).find('span').html('▼');
            $(this).next('div').slideUp(120);
        }
    });

    // Alphabet search
    $('#kiosk_searchbox span').click(function () {
        var that = $(this);
        KIOSK_FILTER.kioskSearch(that);
    });

    $('#viewOverviewMode').click(function (event) {
        $('#viewVideoModal').fadeIn();
        $('.videoClass').each(function(){
            this.contentWindow.postMessage('{"event":"command","func":"playVideo","args":""}', '*')
        });
    });

    $('.hideVideoOverviewMode').click(function (event) {
        $('#viewVideoModal').fadeOut();
        $('.videoClass').each(function(){
            this.contentWindow.postMessage('{"event":"command","func":"stopVideo","args":""}', '*')
        });
    });

    $('#enableTvMode').click(function (event) {
        event.preventDefault();
        $('#disableTvMode').show();
        SCROLL.initScroll();
    });

    $('#disableTvMode').click(function (event) {
        event.preventDefault();
        $('#disableTvMode').hide();
        SCROLL.scrollTop();
    });

    /*
    $('#mp_label').click(function() {
    	MP_LABEL.hide();
    });
    */

    if ((SETTINGS.event_type == 'T') && (LEADERBOARD.suppress_player_3da == 'Y')) {
        $('#general_popup_title').html('Results Pending');

        $('#general_popup_content').html('Competition organizers are temporarily suppressing the group stage results until further notice. They will notify players and fans when results are published.');

        $('#general_popup').slideDown(120);
    }

}

var SCROLL = {

    current_row: null,
    last_row: null,
    rows: 0,
    rows_per: 10,
    scrollTimer: null,

    initScroll: function () {
        if (SCROLL.rows == 0) {
            return false;
        }

        SCROLL.current_row = 0;
        SCROLL.scrollToRow(SCROLL.current_row);
        SCROLL.scrollTimer = setInterval(function () {
            SCROLL.nextRow();
        }, 1000);
    },

    nextRow: function () {
        var nextRow = SCROLL.current_row + 1;

        if (nextRow > SCROLL.last_row) {
            nextRow = 0;
        }

        SCROLL.current_row = nextRow;
        SCROLL.scrollToRow(SCROLL.current_row);
    },

    scrollToRow: function (row) {
        if ($('#player-row_' + row).length) {
            var theadHeight = $('table.scroll.outer thead').outerHeight();
            $('body, html').animate({scrollTop: $('#player-row_' + row).offset().top - theadHeight}, 850);
        } else {
            SCROLL.nextRow();
        }
    },

    scrollTop: function () {
        if (SCROLL.scrollTimer) {
            clearInterval(SCROLL.scrollTimer);
        }

        SCROLL.scrollToRow(0);
    }
}


var LEADERBOARD = {

    pdc_tourcard_winners: [],
    dataset: [],
    event_info: {},
    member_level: null,
    current_sort: 'xpr',
    current_game_desc: '',
    current_sortorder: null,
    selected_players: {
        T: [],
        L: [],
        P: []
    },
    selected_matches: [],
    peg_selected_players: false,
    suppress_player_3da: 'N', // From league season suppress_player_3da in event data

    last_state: {
        event_type: null,
        event_id: null,
        accordion_open: false,
        row_player_id: null,
        last_match_id: null,
        state_timestamp: null
    },

    bracket_interface: 'None',
    pdc: null,

    saveSelectedPlayers: function () {
        if (LOCSTORENABLED) {
            localStorage.setItem('leaderboard_selected_players', JSON.stringify(LEADERBOARD.selected_players));
        }
    },

    saveSelectedMatches: function () {
        if (LOCSTORENABLED) {
            localStorage.setItem('leaderboard_selected_matches', JSON.stringify(LEADERBOARD.selected_matches));
        }
    },

    savePegSelectedPlayers: function () {
        if (LOCSTORENABLED) {
            if (LEADERBOARD.peg_selected_players) {
                localStorage.setItem('leaderboard_peg_selected_players', 'Y');
            } else {
                localStorage.setItem('leaderboard_peg_selected_players', 'N');
            }
        }
    },

    saveLastState: function () {
        if (LOCSTORENABLED) {
            localStorage.setItem('leaderboard_last_state', JSON.stringify(LEADERBOARD.last_state));
        }
    },

    clearLastState: function () {
        LEADERBOARD.last_state = {
            event_type: null,
            event_id: null,
            accordion_open: false,
            row_player_id: null,
            last_match_id: null,
            state_timestamp: null
        };
        LEADERBOARD.saveLastState();
    },

    clearSelectedPlayers: function () {
        LEADERBOARD.selected_players[SETTINGS.event_type] = [];
        LEADERBOARD.peg_selected_players = true; // Will be toggled during sort
        $('.toggleMarkedPlayers').html('Group Players');
        $('.toggleMarkedPlayers').removeClass('hilighted_button');
        LEADERBOARD.saveSelectedPlayers();
        LEADERBOARD.sort('selected_players');
        TOURCARD_WINNERS_MODE = false;
    },

    getStats: function (callback) {

        var filter_game_name, filter_player_format;

        if (!SETTINGS.event_type) {
            return;
        }

        var gameTypeFilter = {
            game_type: SETTINGS.game_filter_vals.game_type,
            game_name: SETTINGS.game_filter_vals.game_name,
            player_format: SETTINGS.game_filter_vals.player_format,
            in_format: SETTINGS.game_filter_vals.in_format,
            out_format: SETTINGS.game_filter_vals.out_format,
            finish: SETTINGS.finish,
            legs: SETTINGS.legs,
            category: SETTINGS.category,
            matchCount: SETTINGS.matchCount,
            range: SETTINGS.range
        };

        var post_data = {
            mode: SETTINGS.event_type,
            id: SETTINGS.event_id,
            gameTypeFilter: gameTypeFilter,
            logged_in: LI
        };

        if (LEADERBOARD.bracket_interface) {
            post_data.bracket_interface = LEADERBOARD.bracket_interface;
        }
        if (LEADERBOARD.pdc) {
            post_data.pdc = LEADERBOARD.pdc;
        }
        if (LEADERBOARD.tour_roster_type) {
            post_data.tour_roster_type = LEADERBOARD.tour_roster_type;
        }

        var datacachestr, datacache;

        if (callback) {
            // init page in process, so ask for event data
            post_data.getEvent = true;
        } else {
            post_data.getEvent = false;
            post_data.leaderboard_access = LEADERBOARD.event_info.leaderboard_access;
        }

        /*
        if ((SETTINGS.event_id == 'a_pdc2017') && (LOCSTORENABLED)) {
        	datacachestr = localStorage.getItem('lb_datacache');
        	if (datacachestr) {
        		try {
        			datacache = JSON.parse(datacachestr);
        		} catch(e) {
        			datacache = null;
        			// Silent failure
        		}
        	} else {
        		datacache = null;
        	}

        	if (datacache) {

        		if ((gameTypeFilter.game_type == datacache.gameTypeFilter.game_type) &&
        			(gameTypeFilter.game_name == datacache.gameTypeFilter.game_name) &&
        			(gameTypeFilter.player_format == datacache.gameTypeFilter.player_format) &&
        			(gameTypeFilter.in_format == datacache.gameTypeFilter.in_format) &&
        			(gameTypeFilter.out_format == datacache.gameTypeFilter.out_format) &&
        			(gameTypeFilter.finish == datacache.gameTypeFilter.finish) &&
        			(gameTypeFilter.legs == datacache.gameTypeFilter.legs) &&
        			(gameTypeFilter.category == datacache.gameTypeFilter.category) &&
        			(gameTypeFilter.matchCount == datacache.gameTypeFilter.matchCount) &&
        			(gameTypeFilter.range == datacache.gameTypeFilter.range)) {

	        		if (((new Date().valueOf()) - (new Date(datacache.timestamp).valueOf())) < (1000 * 60 * 5)) {

		            	LEADERBOARD.dataset = datacache.data.stats;
		            	LEADERBOARD.member_level = datacache.data.member_level;
		            	LEADERBOARD.otherPlayers = datacache.data.other_players;
		            	LEADERBOARD.gameMenu = datacache.data.gameMenu;
			            LEADERBOARD.rollupMenu = datacache.data.rollupMenu;

			            LEADERBOARD.player_count = LEADERBOARD.dataset.length;
			            if (LEADERBOARD.otherPlayers) {
			            	LEADERBOARD.player_count += LEADERBOARD.otherPlayers.length;
			            }

			            switch(SETTINGS.event_type) {
			            	case 'P':
			            		LEADERBOARD.my_dca = datacache.data.my_dca;
			            		break;
			            	case 'L':
			            		LEADERBOARD.divisions = datacache.data.divisions;
			            		break;
			            }

		            	if (datacache.data.event) {
		            		LEADERBOARD.event_info = datacache.data.event;
		            	}

		            	if (datacache.data.events_list) {
		            		LEADERBOARD.events_list = datacache.data.events_list;
		            	}

		            	LEADERBOARD.calcData();

						if (callback) {
							LEADERBOARD.current_sort = SETTINGS.default_sort;
			            }

		            	LEADERBOARD.sort(LEADERBOARD.current_sort, callback);
		            	return;
	        		} else {
	        			// console.log('Data cache expired...');
	        		}
	        	} else {
	        		// console.log('Filters have changed - need new server data');
	        	}
        	}

        }
        */

        // console.log('Getting data from server...');

        // console.log('/getLeaderboard: ' + JSON.stringify(post_data));

        $.ajax({
            url: '/getLeaderboard',
            type: 'POST',
            cache: false,
            timeout: 60000,
            dataType: 'json',
            processData: false,
            contentType: 'application/json',
            data: JSON.stringify(post_data),
            success: function (data) {

                if (data.status == 'OK') {

                    /*
	            	if ((SETTINGS.event_id == 'a_pdc2017') && (LOCSTORENABLED)) {
	            		// console.log('Writing data cache to local storage...');
	            		localStorage.setItem('lb_datacache', JSON.stringify({
	            			timestamp: new Date(),
	            			gameTypeFilter: gameTypeFilter,
	            			data: data.payload}));
	            	}
	            	*/

                    if (data.payload.status == 'login_required') {
                        spinner.stop();
                        $('#login').removeClass('hidden');
                        $('#main').addClass('hidden');
                        $('#email').focus();
                        console.log('login required');
                        return false;
                    }

                    LEADERBOARD.dataset = data.payload.stats;
                    LEADERBOARD.member_level = data.payload.member_level;
                    LEADERBOARD.otherPlayers = data.payload.other_players;
                    LEADERBOARD.gameMenu = data.payload.gameMenu;
                    LEADERBOARD.rollupMenu = data.payload.rollupMenu;
                    LEADERBOARD.report_dart_avg_units = data.payload.event.report_dart_avg_units;

                    if (!LEADERBOARD.report_dart_avg_units) {
                        // Tournaments, personal leaderboards, etc default:
                        LEADERBOARD.report_dart_avg_units = 'PPR';
                    }

                    LEADERBOARD.player_count = LEADERBOARD.dataset.length;
                    if (LEADERBOARD.otherPlayers) {
                        LEADERBOARD.player_count += LEADERBOARD.otherPlayers.length;
                    }

                    if (data.payload.event) {
                        if (data.payload.event.bracket_interface) {
                            LEADERBOARD.bracket_interface = data.payload.event.bracket_interface;
                        } else {
                            LEADERBOARD.bracket_interface = 'None'; // For league
                        }

                        if (data.payload.event.pdc) {
                            LEADERBOARD.pdc = data.payload.event.pdc;
                        } else {
                            LEADERBOARD.pdc = 'N';
                        }

                        if (data.payload.event.tour_roster_type) {
                            LEADERBOARD.tour_roster_type = data.payload.event.tour_roster_type;
                        } else {
                            LEADERBOARD.tour_roster_type = 'T';
                        }

                        if (data.payload.event.suppress_player_3da == 'Y') {
                            LEADERBOARD.suppress_player_3da = 'Y';
                        }

                        // alert('data.payload.event.tour_roster_type = ' + data.payload.event.tour_roster_type);
                    }

                    if (data.payload.eventList) {
                        LEADERBOARD.eventList = data.payload.eventList;
                        // console.log('LEADERBOARD.eventList = ' + JSON.stringify(LEADERBOARD.eventList));
                    }

                    switch (SETTINGS.event_type) {
                        case 'P':
                            LEADERBOARD.my_dca = data.payload.my_dca;
                            break;
                        case 'L':
                            LEADERBOARD.divisions = data.payload.divisions;
                            suppress_3da_msg = 'Event organizers have requested this feature be suppressed until the competition is complete.';
                            break;
                        case 'T':
                            suppress_3da_msg = 'Event organizers have requested this feature be suppressed.';
                            break;
                    }

                    if (data.payload.event) {
                        LEADERBOARD.event_info = data.payload.event;
                    }

                    if (data.payload.events_list) {
                        LEADERBOARD.events_list = data.payload.events_list;
                    }

                    LEADERBOARD.pdc_tourcard_winners = [];

                    if (data.payload.pdc_tourcard_winners) {
                        LEADERBOARD.pdc_tourcard_winners = data.payload.pdc_tourcard_winners || [];

                        LEADERBOARD.peg_selected_players = false;
                        LEADERBOARD.selected_players = {
                            T: [
                                ...LEADERBOARD.pdc_tourcard_winners,

                                // EU
                                31054,
                                33630,
                                409,
                                2771,
                                35887,
                                30992,
                                33043,
                                32107,
                                33950,
                                585,
                                39541,
                                41742,
                                33070,

                                // UK
                                32078,
                                33598,
                                32087,
                                32704,
                                32962,
                                358,
                                39109,
                                38159,
                                199,
                                32497, // Lovely, only in if keefe wins.
                            ],
                            L: [],
                            P: []
                        };
                        LEADERBOARD.saveSelectedPlayers();
                        LEADERBOARD.sort('selected_players');
                    }

                    setBanners();

                    LEADERBOARD.calcData();

                    if (callback) {
                        LEADERBOARD.current_sort = SETTINGS.default_sort;
                    }

                    LEADERBOARD.sort(LEADERBOARD.current_sort, callback);

                    if (SETTINGS.event_type === 'T' || SETTINGS.event_type === 'L') {
                        document.getElementById('videoOverviewIFrame').src = 'https://www.youtube.com/embed/Yo-8NJzPgf8?start=2&enablejsapi=1';
                    }
                } else {
                    // silent fail in case user goes off-line
                    if (callback) {
                        spinner.stop();
                        $('#loading_msg').css('text-align', 'center');
                        $('#loading_msg span').html(data.status_text);
                        $('#loading_msg').show();
                    }

                }
            },
            error: function (a, b, c) {
                if (callback) {
                    spinner.stop();
                    $('#loading_msg').css('text-align', 'center');
                    $('#loading_msg span').html('The Leaderboard did not<br>finish loading completely.<br>Use &quot;Refresh&quot; to try again.');

                } else {
                    // silent fail in case user goes off-line
                }

            }
        });

    },

    calcData: function () {

        // Add calculated columns to dataset

        var tot_op_darts = 0;
        var tot_op_x = 0;
        var tot_op_legs = 0;
        var tot_my_legs = 0;
        var tot_all_op_firstnine = 0;
        var tot_all_op_avgfinish = 0;
        var tot_all_op_trip_bull_per = 0;
        var tot_all_op_miss = 0;
        var tot_all_my_firstnine = 0;
        var tot_all_my_avgfinish = 0;
        var tot_all_my_matches = 0;
        var tot_all_my_leg_wins = 0;
        var tot_all_my_handicap_legs = 0;
        var tot_all_my_trip_bull_per = 0;
        var tot_all_my_miss = 0;

        for (var i = 0; i < LEADERBOARD.dataset.length; i++) {

            if (SETTINGS.event_type != 'P') {

                // LEADERBOARD.dataset[i].country = cnull(LEADERBOARD.dataset[i].country);

                LEADERBOARD.dataset[i].winp = per(LEADERBOARD.dataset[i].wins, LEADERBOARD.dataset[i].legs);
                LEADERBOARD.dataset[i].xpr = calcXpr(LEADERBOARD.dataset[i].points_scored, LEADERBOARD.dataset[i].darts_thrown);
                LEADERBOARD.dataset[i].oppXpr = calcXpr(LEADERBOARD.dataset[i].op_points_scored, LEADERBOARD.dataset[i].op_darts_thrown);

                if (SETTINGS.game_filter_vals.game_type == '01') {
                    LEADERBOARD.dataset[i].p100_per = per((LEADERBOARD.dataset[i].p100 * 3), LEADERBOARD.dataset[i].darts_thrown);
                    LEADERBOARD.dataset[i].p140_per = per((LEADERBOARD.dataset[i].p140 * 3), LEADERBOARD.dataset[i].darts_thrown);
                    LEADERBOARD.dataset[i].ton80_per = per((LEADERBOARD.dataset[i].ton80 * 3), LEADERBOARD.dataset[i].darts_thrown);
                    LEADERBOARD.dataset[i].p100_leg = ratio(LEADERBOARD.dataset[i].p100, LEADERBOARD.dataset[i].legs);
                    LEADERBOARD.dataset[i].p140_leg = ratio(LEADERBOARD.dataset[i].p140, LEADERBOARD.dataset[i].legs);
                    LEADERBOARD.dataset[i].ton80_leg = ratio(LEADERBOARD.dataset[i].ton80, LEADERBOARD.dataset[i].legs);

                    LEADERBOARD.dataset[i].coe = per(LEADERBOARD.dataset[i].cod, LEADERBOARD.dataset[i].coo);
                    LEADERBOARD.dataset[i].co_perc = per(LEADERBOARD.dataset[i].tcod, LEADERBOARD.dataset[i].coa);

                } else {
                    LEADERBOARD.dataset[i].m5_per = per((LEADERBOARD.dataset[i].m5 * 3), LEADERBOARD.dataset[i].darts_thrown);
                    LEADERBOARD.dataset[i].m7_per = per((LEADERBOARD.dataset[i].m7 * 3), LEADERBOARD.dataset[i].darts_thrown);
                    LEADERBOARD.dataset[i].m9_per = per((LEADERBOARD.dataset[i].m9 * 3), LEADERBOARD.dataset[i].darts_thrown);
                    LEADERBOARD.dataset[i].m5_leg = ratio(LEADERBOARD.dataset[i].m5, LEADERBOARD.dataset[i].legs);
                    LEADERBOARD.dataset[i].m7_leg = ratio(LEADERBOARD.dataset[i].m7, LEADERBOARD.dataset[i].legs);
                    LEADERBOARD.dataset[i].m9_leg = ratio(LEADERBOARD.dataset[i].m9, LEADERBOARD.dataset[i].legs);

                    LEADERBOARD.dataset[i].bulls_3_per = per((LEADERBOARD.dataset[i].bulls_3), LEADERBOARD.dataset[i].rounds_played);
                    LEADERBOARD.dataset[i].bulls_4_per = per((LEADERBOARD.dataset[i].bulls_4), LEADERBOARD.dataset[i].rounds_played);
                    LEADERBOARD.dataset[i].bulls_5_per = per((LEADERBOARD.dataset[i].bulls_5), LEADERBOARD.dataset[i].rounds_played);
                    LEADERBOARD.dataset[i].bulls_6_per = per((LEADERBOARD.dataset[i].bulls_6), LEADERBOARD.dataset[i].rounds_played);
                    LEADERBOARD.dataset[i].hat_tricks_per = per((LEADERBOARD.dataset[i].hat_tricks), LEADERBOARD.dataset[i].rounds_played);
                }

                // "All" game stats
                if (SETTINGS.event_id.substring(0, 2) == 'a_') {

                } else {

                    LEADERBOARD.dataset[i].all_leg_loses = LEADERBOARD.dataset[i].all_legs - LEADERBOARD.dataset[i].all_leg_wins;
                    LEADERBOARD.dataset[i].all_leg_wins_per = per(LEADERBOARD.dataset[i].all_leg_wins, LEADERBOARD.dataset[i].all_legs);
                    LEADERBOARD.dataset[i].all_set_loses = LEADERBOARD.dataset[i].all_sets - LEADERBOARD.dataset[i].all_set_ties - LEADERBOARD.dataset[i].all_set_wins;
                    LEADERBOARD.dataset[i].all_set_wins_per = per(LEADERBOARD.dataset[i].all_set_wins, LEADERBOARD.dataset[i].all_sets);

                    if (SETTINGS.event_type == 'L') {
                        if (LEADERBOARD.event_info.league_type == 'SINGLES') {
                            LEADERBOARD.dataset[i].all_match_loses = LEADERBOARD.dataset[i].all_matches - LEADERBOARD.dataset[i].all_match_ties - LEADERBOARD.dataset[i].all_match_wins;
                            LEADERBOARD.dataset[i].all_match_wins_per = per(LEADERBOARD.dataset[i].all_match_wins, LEADERBOARD.dataset[i].all_matches);
                        }
                    } else {
                        // Tournaments
                        LEADERBOARD.dataset[i].all_match_loses = LEADERBOARD.dataset[i].all_matches - LEADERBOARD.dataset[i].all_match_ties - LEADERBOARD.dataset[i].all_match_wins;
                        LEADERBOARD.dataset[i].all_match_wins_per = per(LEADERBOARD.dataset[i].all_match_wins, LEADERBOARD.dataset[i].all_matches);
                    }
                }

                // Leg Start Records
                LEADERBOARD.dataset[i].againstdarts_legs = LEADERBOARD.dataset[i].legs - LEADERBOARD.dataset[i].withdarts_legs;
                LEADERBOARD.dataset[i].withdarts_wins_per = per(LEADERBOARD.dataset[i].withdarts_wins, LEADERBOARD.dataset[i].withdarts_legs);
                LEADERBOARD.dataset[i].againstdarts_wins_per = per(LEADERBOARD.dataset[i].againstdarts_wins, LEADERBOARD.dataset[i].againstdarts_legs);

            } else {
                LEADERBOARD.dataset[i].winp = per(LEADERBOARD.dataset[i].mywins, LEADERBOARD.dataset[i].mylegs);
                LEADERBOARD.dataset[i].xpr = calcXpr(LEADERBOARD.dataset[i].mypoints_scored, LEADERBOARD.dataset[i].mydarts_thrown);
                LEADERBOARD.dataset[i].op_xpr = calcXpr(LEADERBOARD.dataset[i].points_scored, LEADERBOARD.dataset[i].darts_thrown);

                tot_op_darts += LEADERBOARD.dataset[i].darts_thrown;
                tot_op_x += LEADERBOARD.dataset[i].points_scored;
                tot_op_legs += LEADERBOARD.dataset[i].legs;
                tot_all_op_firstnine += LEADERBOARD.dataset[i].first_nine;
                tot_all_op_avgfinish += LEADERBOARD.dataset[i].avg_finish;

                tot_my_legs += LEADERBOARD.dataset[i].mylegs;
                tot_all_my_matches += parseInt(LEADERBOARD.dataset[i].matches);
                tot_all_my_handicap_legs += parseInt(LEADERBOARD.dataset[i].myhc_legs);
                tot_all_my_leg_wins += LEADERBOARD.dataset[i].mywins;
                tot_all_my_avgfinish += LEADERBOARD.dataset[i].myavg_finish;
                tot_all_my_firstnine += LEADERBOARD.dataset[i].myfirst_nine;
            }

            // Correct for non-marksman mode
            if (SETTINGS.game_filter_vals.game_type != '01') {
                if (LEADERBOARD.dataset[i].targ_per == null) {
                    LEADERBOARD.dataset[i].trip_bull_per = null;
                } else {
                    tot_all_op_miss += LEADERBOARD.dataset[i].targ_per;
                    tot_all_op_trip_bull_per += LEADERBOARD.dataset[i].trip_bull_per;
                    tot_all_my_miss += LEADERBOARD.dataset[i].mytarg_per;
                    tot_all_my_trip_bull_per += LEADERBOARD.dataset[i].mytrip_bull_per;
                }
            }

        }

        if (SETTINGS.event_type == 'P') {
            LEADERBOARD.all_op_xpr = calcXpr(tot_op_x, tot_op_darts);
            LEADERBOARD.all_op_legs = tot_op_legs;
            LEADERBOARD.all_my_legs = tot_my_legs;
            LEADERBOARD.all_op_firstnine = tot_all_op_firstnine / LEADERBOARD.player_count;
            LEADERBOARD.all_op_avgfinish = tot_all_op_avgfinish / LEADERBOARD.player_count;
            LEADERBOARD.all_op_miss = 1 - (tot_all_op_miss / LEADERBOARD.player_count);
            LEADERBOARD.all_op_tripbull_per = tot_all_op_trip_bull_per / LEADERBOARD.player_count;

            LEADERBOARD.all_my_firstnine = tot_all_my_firstnine / LEADERBOARD.player_count;
            LEADERBOARD.all_my_avgfinish = tot_all_my_avgfinish / LEADERBOARD.player_count;
            LEADERBOARD.all_my_matches = tot_all_my_matches;
            LEADERBOARD.all_my_leg_wins = per(tot_all_my_leg_wins, tot_my_legs);
            LEADERBOARD.all_my_handicap_legs = tot_all_my_handicap_legs;
            LEADERBOARD.all_my_miss = 1 - (tot_all_my_miss / LEADERBOARD.player_count);
            LEADERBOARD.all_my_tripbull_per = tot_all_my_trip_bull_per / LEADERBOARD.player_count;

            LEADERBOARD.op_dca_outperform = 0;
            LEADERBOARD.op_dca_underperform = 0;
            LEADERBOARD.xpr_outperform = 0;
            LEADERBOARD.xpr_underperform = 0;
            LEADERBOARD.op_xpr_outperform = 0;
            LEADERBOARD.op_xpr_underperform = 0;

            for (var i = 0; i < LEADERBOARD.dataset.length; i++) {
                if (parseFloat(LEADERBOARD.dataset[i].op_dca) < parseFloat(LEADERBOARD.dataset[i].op_xpr)) {
                    LEADERBOARD.op_dca_outperform += 1;
                } else if (parseFloat(LEADERBOARD.dataset[i].op_dca) > parseFloat(LEADERBOARD.dataset[i].op_xpr)) {
                    LEADERBOARD.op_dca_underperform += 1;
                }

                if (parseFloat(LEADERBOARD.dataset[i].xpr) > parseFloat(LEADERBOARD.my_dca)) {
                    LEADERBOARD.xpr_outperform += 1;
                } else if (parseFloat(LEADERBOARD.dataset[i].xpr) < parseFloat(LEADERBOARD.my_dca)) {
                    LEADERBOARD.xpr_underperform += 1;
                }

                if (parseFloat(LEADERBOARD.dataset[i].op_xpr) > parseFloat(LEADERBOARD.all_op_xpr)) {
                    LEADERBOARD.op_xpr_outperform += 1;
                } else if (parseFloat(LEADERBOARD.dataset[i].op_xpr) < parseFloat(LEADERBOARD.all_op_xpr)) {
                    LEADERBOARD.op_xpr_underperform += 1;
                }
            }
        }

    },

    render: function (callback, header_class) {
        var html = '';
        var hclass = '';
        var hstyle = '';
        var data = LEADERBOARD.dataset;
        var otherPlayers = LEADERBOARD.otherPlayers;
        var gameMenu = LEADERBOARD.gameMenu;
        var card_link, target;
        var menuHtml, menuItem, menuVal, game_abbrev;
        var rendered_ad_row = false;
        var rendered_my_dca = false;
        var rendered_op_xpr = false;
        var thisSelected;
        var lastSelected;
        var table_container_id;
        var colClassSfx = '';
        var grouped_rank = 1; // Counter for when selected players are grouped
        var ext_rank = data.length + 1; // rank counter for "other" players
        var otherPlayerCount;
        var countryCount = 0;
        var primMenuClass;
        var playerCompVal;
        var group_pos_ad; // whether ad banner should be positioned under grouped players sections
        var contentVal;
        var found_selected_player = false;
        var clsPfx;
        var xpr_unit;
        var toggle_tot;
        var plr_group_label;

        var last_country = '';

        var cricket_game_types = 0;
        var oh1_game_types = 0;

        var totTogCheck;

        var nameDisp;

        switch (SETTINGS.event_type) {
            case 'T':
            case 'L':
                table_container_id = '#group_leaderboard';
                $('.tog').hide();
                $('.tog2-' + SETTINGS.sec2_toggle).show();
                $('.tog3-' + SETTINGS.sec3_toggle).show();

                // Validate toggle settings are not out of range

                // Sec 2
                if (SETTINGS.game_filter_vals.game_type == '01') {
                    totTogCheck = 8;
                } else {
                    totTogCheck = 6;
                }
                if (SETTINGS.event_type == 'T') {
                    totTogCheck -= 1; // No "team/div" section for tournaments
                }
                if (SETTINGS.sec2_toggle > totTogCheck) {
                    // alert('Sec 2 Issue: ' + SETTINGS.sec2_toggle + ' > ' + totTogCheck);
                    SETTINGS.sec2_toggle = 1;
                }

                // Sec 3
                totTogCheck = 6;
                if (SETTINGS.event_type == 'L') {
                    if (LEADERBOARD.event_info.league_type == 'TEAM') {
                        totTogCheck -= 1;
                    }
                } else {
                    // Tournaments
                    totTogCheck -= 1;
                }
                if (SETTINGS.sec3_toggle > totTogCheck) {
                    // alert('SEC 3 Issue: ' + SETTINGS.sec3_toggle + ' > ' + totTogCheck);
                    SETTINGS.sec3_toggle = 1;
                }

                break;

            case 'P':
                table_container_id = '#my_leaderboard';
                colClassSfx = '-ml'; // my leaderboard classes
                break;
        }

        if (SETTINGS.event_type == 'L') {
            if (LEADERBOARD.event_info.league_type == 'SINGLES') {
                plr_group_label = 'Division';
            } else {
                plr_group_label = 'Team';
            }
        }

        game_abbrev = '';

        // Render game menu
        menuHtml = '';
        for (var i = 0; i < gameMenu.length; i++) {

            menuItem = gameMenu[i].player_format + " ";
            if (gameMenu[i].game_type.toLowerCase() == 'cricket') {
                cricket_game_types += 1;
                menuItem += 'Cricket';
                menuVal = gameMenu[i].player_format.toLowerCase() + '_cricket';
            } else {
                oh1_game_types += 1;
                menuItem += gameMenu[i].game_name + " ";
                menuItem += gameMenu[i].in_format;
                menuItem += gameMenu[i].out_format;
                // Underscore deliminated such as doubles_01_401_si_do
                if (gameMenu[i].player_format && gameMenu[i].in_format && gameMenu[i].out_format) {
                    menuVal = gameMenu[i].player_format.toLowerCase() + '_01_' + gameMenu[i].game_name + '_' + gameMenu[i].in_format.toLowerCase() + '_' + gameMenu[i].out_format.toLowerCase()
                } else {
                    console.log('Invalid game format: ' + JSON.stringify(gameMenu[i]));
                }
            }

            if (SETTINGS.game_filters == menuVal) {
                primMenuClass = " selected_filterbutton";
                LEADERBOARD.current_game_desc = menuItem;
                LEADERBOARD.game_name = gameMenu[i].game_name;

                switch (gameMenu[i].player_format.toLowerCase()) {
                    case 'singles':
                        LEADERBOARD.game_abbrev = 'S ' + abbrevCricket(gameMenu[i].game_name);
                        LEADERBOARD.game_legend = 'Singles ' + gameMenu[i].game_name;
                        break;
                    case 'doubles':
                        LEADERBOARD.game_abbrev = 'D ' + abbrevCricket(gameMenu[i].game_name);
                        LEADERBOARD.game_legend = 'Doubles ' + gameMenu[i].game_name;
                        break;
                    case 'triples':
                        LEADERBOARD.game_abbrev = 'T ' + abbrevCricket(gameMenu[i].game_name);
                        LEADERBOARD.game_legend = 'Triples ' + gameMenu[i].game_name;
                        break;
                    case 'quads':
                        LEADERBOARD.game_abbrev = 'Q ' + abbrevCricket(gameMenu[i].game_name);
                        LEADERBOARD.game_legend = 'Quads ' + gameMenu[i].game_name;
                        break;
                    default:
                        LEADERBOARD.game_abbrev = 'All ' + abbrevCricket(gameMenu[i].game_name);
                        LEADERBOARD.game_legend = 'All ' + gameMenu[i].game_name;
                        break;
                }

            } else {
                primMenuClass = "";
            }

            menuHtml += '<li><a href="" class="game_name_menu' + primMenuClass + '" name="' + menuVal + '">' + menuItem + '</a></li>';
        }

        // if ((LEADERBOARD.bracket_interface == 'None') || (SETTINGS.range == 'all')) {

        if (SETTINGS.game_filters == 'all_01') {
            if (SETTINGS.event_type == 'P') {
                menuHtml += '<li><a href="" class="game_name_menu selected_filterbutton" name="all_01">All Singles 01</a></li>';
                LEADERBOARD.current_game_desc = 'All Singles 01';
                LEADERBOARD.game_name = 'All Singles 01';
                LEADERBOARD.game_abbrev = 'All Singles \'01';
                LEADERBOARD.game_legend = 'All Singles \'01';
            } else {
                menuHtml += '<li><a href="" class="game_name_menu selected_filterbutton" name="all_01">All 01</a></li>';
                LEADERBOARD.current_game_desc = 'All 01';
                LEADERBOARD.game_name = 'All 01';
                LEADERBOARD.game_abbrev = 'All \'01';
                LEADERBOARD.game_legend = 'All \'01';
            }

        } else {
            if (oh1_game_types > 1) {
                if (SETTINGS.event_type == 'P') {
                    menuHtml += '<li><a href="" class="game_name_menu" name="all_01">All Singles 01</a></li>';
                } else {
                    menuHtml += '<li><a href="" class="game_name_menu" name="all_01">All 01</a></li>';
                }
            }
        }

        if (SETTINGS.game_filters == 'all_cricket') {
            menuHtml += '<li><a href="" class="game_name_menu selected_filterbutton" name="all_cricket">All Cricket</a></li>';
            LEADERBOARD.current_game_desc = 'All Cricket';
            LEADERBOARD.game_name = 'All Cricket';
            LEADERBOARD.game_abbrev = 'All Crick';
            LEADERBOARD.game_legend = 'All Cricket';
        } else {
            if (cricket_game_types > 1) {
                menuHtml += '<li><a href="" class="game_name_menu" name="all_cricket">All Cricket</a></li>';
            }
        }
        // }

        $('.game_name_label').html(LEADERBOARD.game_legend);

        $('#menu_game_name ul').html(menuHtml);

        LEADERBOARD.initMenus();

        if (!TOURCARD_WINNERS_MODE && LEADERBOARD.peg_selected_players && (LEADERBOARD.selected_players[SETTINGS.event_type].length > 0)) {
            group_pos_ad = true;
        } else {
            group_pos_ad = false;
        }


        // ***** Table Header *********

        if (SETTINGS.game_filter_vals.game_type == '01') {
            if (LEADERBOARD.report_dart_avg_units == 'PPR') {
                xpr_unit = '3DA';
            } else {
                xpr_unit = '1DA';
            }
        } else {
            xpr_unit = 'MPR';
        }

        $('.xpr_unit').html(xpr_unit);

        switch (SETTINGS.event_type) {
            case 'L':
            case 'T':

                if (SETTINGS.game_filter_vals.game_type == '01') {
                    toggle_tot = 6;
                } else {
                    toggle_tot = 3;
                }

                if (SETTINGS.event_type == 'T') {
                    toggle_tot -= 1;
                }

                html = '';

                // html += '<tr class="thead_sections bluesection event_headline"><th class="event_headline" colspan="4">david' + LEADERBOARD.event_headline + '<div class="kiosk_label">Reset Search: <span>' + KIOSK_FILTER.kioskSearchLetter + '</span></div></th></tr>';

                html += '<tr class="thead_sections thead_titlesections titlesection"><th colspan="5" class="sec1"><span>Players</span></th><th colspan="5" class="sec2"><span>Performance</span></th><th colspan="5" class="sec3"><span>Match / Leg Record</span></th></tr>';

                // html += '<tr class="thead_sections legendsection"><th colspan="15"><span><button> <svg class="legend-icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>Learn More</button> About Each Category</span></th></tr>';

                html += '<tr class="thead_sections bluesection">';

                // Logic is reversed because of toggle done in sort process
                if (!LEADERBOARD.peg_selected_players) {
                    html += '   <th colspan="5" class="sec1" style="text-align: center;"><button class="toggleMarkedPlayers">Group<span class="ext_text"> Players</span></button>Total Entries: ' + LEADERBOARD.player_count + '</th>';
                } else {
                    html += '   <th colspan="5" class="sec1" style="text-align: center;"><button class="toggleMarkedPlayers hilighted_button">Ungroup</button>Entries</th>';
                }

                // SECTION 2 *******************
                html += '   <th colspan="5" class="sec2">';
                if (SETTINGS.game_filter_vals.game_type == '01') {
                    switch (SETTINGS.sec2_toggle) {
                        case 1:
                            html += genTogSec(2, LEADERBOARD.game_abbrev + ' Ton %');
                            break;
                        case 2:
                            html += genTogSec(2, LEADERBOARD.game_abbrev + ' Ton Per Leg');
                            break;
                        case 3:
                            html += genTogSec(2, LEADERBOARD.game_abbrev + ' Ton Counts');
                            break;
                        case 4:
                            html += genTogSec(2, LEADERBOARD.game_abbrev + ' Ton Points');
                            break;
                        case 5:
                            html += genTogSec(2, LEADERBOARD.game_abbrev + ' High Turns');
                            break;
                        case 6:
                            html += genTogSec(2, LEADERBOARD.game_abbrev + ' Breakdown');
                            break;
                        case 7:
                            html += genTogSec(2, LEADERBOARD.game_abbrev + ' Check Outs');
                            break;
                        case 8:
                            if (SETTINGS.event_type == 'L') {
                                html += genTogSec(2, fmtPlrGrpLbl(plr_group_label));
                            }
                            break;
                    }
                } else {
                    // Cricket
                    switch (SETTINGS.sec2_toggle) {
                        case 1:
                            html += genTogSec(2, LEADERBOARD.game_abbrev + ' Mark %');
                            break;
                        case 2:
                            html += genTogSec(2, LEADERBOARD.game_abbrev + ' Mark Count');
                            break;
                        case 3:
                            html += genTogSec(2, LEADERBOARD.game_abbrev + ' Bulls Count');
                            break;
                        case 4:
                            html += genTogSec(2, LEADERBOARD.game_abbrev + ' Bulls %');
                            break;
                        case 5:
                            html += genTogSec(2, LEADERBOARD.game_abbrev + ' Breakdown');
                            break;
                        case 6:
                            if (SETTINGS.event_type == 'L') {
                                html += genTogSec(2, fmtPlrGrpLbl(plr_group_label));
                            }
                            break;

                    }
                }
                html += '</th>';


                // SECTION 3 *******************
                html += '   <th colspan="5" class="sec3">';
                switch (SETTINGS.sec3_toggle) {
                    case 1:
                        html += genTogSec(3, LEADERBOARD.game_abbrev + ' Record');
                        break;
                    case 2:
                        html += genTogSec(3, LEADERBOARD.game_abbrev + ' Start Record');
                        break;
                    case 3:
                        html += genTogSec(3, 'All Legs Record');
                        break;
                    case 4:
                        html += genTogSec(3, 'All Sets Record');
                        break;
                    case 5:
                        if (SETTINGS.event_type == 'L') {
                            if (LEADERBOARD.event_info.league_type == 'SINGLES') {
                                html += genTogSec(3, 'All Matches Record');
                                break;
                            }
                            html += genTogSec(3, fmtPlrGrpLbl(plr_group_label)); // Team leagues only
                            break;
                        } else {
                            // Tournaments
                            html += genTogSec(3, 'All Matches Record');
                            break;
                        }

                        break;
                    case 6:
                        // Only used for singles leagues
                        html += genTogSec(3, fmtPlrGrpLbl(plr_group_label));
                        break;
                }


                html += '</tr>';

                $('#group_leaderboard tr.thead_sections').remove();
                $('#group_leaderboard thead').prepend(html);
                // $('#group_leaderboard tr.thead_sections').replaceWith(html);

                // Generate toggle arrow controls based on section
            function genTogSec(sec, label) {
                var curTog, totTog, prevTog, nextTog;
                switch (sec) {
                    case 2:
                        curTog = SETTINGS.sec2_toggle;
                        if (SETTINGS.game_filter_vals.game_type == '01') {
                            totTog = 8;
                        } else {
                            totTog = 6;
                        }
                        if (SETTINGS.event_type == 'T') {
                            totTog -= 1; // No "team/div" section for tournaments
                        }
                        break;

                    case 3:
                        curTog = SETTINGS.sec3_toggle;
                        totTog = 6;
                        if (SETTINGS.event_type == 'L') {
                            if (LEADERBOARD.event_info.league_type == 'TEAM') {
                                totTog -= 1;
                            }
                        } else {
                            // Tournaments
                            totTog -= 1;
                        }
                }
                if (curTog == 1) {
                    prevTog = totTog;
                } else {
                    prevTog = curTog - 1;
                }
                if (curTog == totTog) {
                    nextTog = 1;
                } else {
                    nextTog = curTog + 1;
                }
                return '<button class="tog_btn left_toggle_btn" data-section="' + sec + '" data-next="' + prevTog + '"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>' + label + '<span class="section-label">(' + curTog + ' of ' + totTog + ')</span><button class="tog_btn right_toggle_btn" data-section="' + sec + '" data-next="' + nextTog + '"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>';
            }


                html = '<tr class="column_label_row">';
                html += '   <th class="a1"><img class="clearMarkedBtn" src="/images/close-button.png" width="25" height="25" alt="Clear Selected Players"></th>';
                html += '   <th class="a2"><span class="desktop">Rnk</span><span class="mobile">#</span></th>';
                html += '   <th class="a2b"><a href="#" name="country" class="flagsort"><span class="flagsort-holder"><span class="flagsort-count"></span></span><img src="/images/flagsort.png" class="flagsort-flag"></a></th>';
                html += '   <th class="a3"><a href="#" name="last_name">Name</a></th>';
                html += '   <th class="a4"><a href="#" name="xpr">' + xpr_unit + '</a></th>';


                // SECTION 2 **********

                if (SETTINGS.game_filter_vals.game_type == '01') {
                    switch (SETTINGS.sec2_toggle) {
                        case 1:
                            html += '   <th class="b1"><a href="#" name="first_nine"><span class="show-on-mobile">Fir9</span><span class="show-on-desktop">First 9</span></a></th>';
                            html += '   <th class="b2"><a href="#" name="avg_finish"><span class="show-on-mobile">AFin</span><span class="show-on-desktop">Avg Fin.</span></a></th>';
                            html += '   <th class="b3"><a href="#" name="p100_per">100+</a></th>';
                            html += '   <th class="b4"><a href="#" name="p140_per">140+</a></th>';
                            html += '   <th class="b5"><a href="#" name="ton80_per">180</a></th>';
                            break;
                        case 2:
                            html += '   <th class="b1"><a href="#" name="first_nine"><span class="show-on-mobile">Fir9</span><span class="show-on-desktop">First 9</span></a></th>';
                            html += '   <th class="b2"><a href="#" name="avg_finish"><span class="show-on-mobile">AFin</span><span class="show-on-desktop">Avg Fin.</span></a></th>';
                            html += '   <th class="b3"><a href="#" name="p100_leg">100+</a></th>';
                            html += '   <th class="b4"><a href="#" name="p140_leg">140+</a></th>';
                            html += '   <th class="b5"><a href="#" name="ton80_leg">180</a></th>';
                            break;
                        case 3:
                            html += '   <th class="b1"><a href="#" name="first_nine"><span class="show-on-mobile">Fir9</span><span class="show-on-desktop">First 9</span></a></th>';
                            html += '   <th class="b2"><a href="#" name="avg_finish"><span class="show-on-mobile">AFin</span><span class="show-on-desktop">Avg Fin.</span></a></th>';
                            html += '   <th class="b3"><a href="#" name="p100">100+</a></th>';
                            html += '   <th class="b4"><a href="#" name="p140">140+</a></th>';
                            html += '   <th class="b5"><a href="#" name="ton80">180</a></th>';
                            break;
                        case 4:
                            html += '   <th class="b1"><a href="#" name="first_nine"><span class="show-on-mobile">Fir9</span><span class="show-on-desktop">First 9</span></a></th>';
                            html += '   <th class="b2"><a href="#" name="avg_finish"><span class="show-on-mobile">AFin</span><span class="show-on-desktop">Avg Fin.</span></a></th>';
                            html += '   <th class="b3"><a href="#" name="p100">100+</a></th>';
                            html += '   <th class="b4-b5tot" colspan="2"><a href="#" name="ton_points">Ton Points</a></th>';
                            break;
                        case 5:
                            html += '   <th class="b1"><a href="#" name="high_turn">HTurn</a></th>';
                            html += '   <th class="b2"><a href="#" name="high_first_turn">HSI</a></th>';
                            html += '   <th class="b3"><a href="#" name="high_double_in_turn">HDIT</a></th>';
                            html += '   <th class="b4"><a href="#" name="high_double_in">HDI</a></th>';
                            html += '   <th class="b5"><a href="#" name="high_double_out">HDO</a></th>';
                            break;
                        case 6:
                            if (SETTINGS.event_type == 'L') {
                                if (LEADERBOARD.event_info.dart_dist_class == '20') {
                                    html += '   <th class="b1"><a href="#" name="t00">T00</a></th>';
                                    html += '   <th class="b2"><a href="#" name="t20">T20</a></th>';
                                    html += '   <th class="b3"><a href="#" name="t40">T40</a></th>';
                                    html += '   <th class="b4"><a href="#" name="t60">T60</a></th>';
                                    html += '   <th class="b5"><a href="#" name="t80">T80</a></th>';
                                } else {
                                    html += '   <th class="b1"><a href="#" name="t00">95</a></th>';
                                    html += '   <th class="b2"><a href="#" name="t20">T14</a></th>';
                                    html += '   <th class="b3"><a href="#" name="t40">T33</a></th>';
                                    html += '   <th class="b4"><a href="#" name="t60">T152</a></th>';
                                    html += '   <th class="b5"><a href="#" name="t80">T171</a></th>';
                                }
                            } else {
                                html += '   <th class="b1"><a href="#" name="t00">T00</a></th>';
                                html += '   <th class="b2"><a href="#" name="t20">T20</a></th>';
                                html += '   <th class="b3"><a href="#" name="t40">T40</a></th>';
                                html += '   <th class="b4"><a href="#" name="t60">T60</a></th>';
                                html += '   <th class="b5"><a href="#" name="t80">T80</a></th>';
                            }
                            break;
                        case 7:
                            html += '   <th class="b1"><a href="#" name="avg_finish"><span class="show-on-mobile">AFin</span><span class="show-on-desktop">Avg Fin.</span></a></th>';
                            html += '   <th class="b2-b3"><a href="#" name="coe">CO Turn %</a></th>';
                            html += '   <th class="b4-b5-2"><a href="#" name="co_perc">CO Darts %</a></th>';
                            break;
                        case 8:
                            html += '   <th class="b1-b3" colspan="3"><a href="#" name="team_name">' + fmtPlrGrpLbl(plr_group_label) + ' Name</a></th>';
                            html += '   <th class="b4-b5" colspan="2"><a href="#" name="sub_division">Sub Division</a></th>';
                            break;
                    }
                } else {
                    switch (SETTINGS.sec2_toggle) {
                        case 1:
                            html += '   <th class="b1"><a href="#" name="targ_per">Miss%</a></th>';
                            html += '   <th class="b2"><a href="#" name="trip_bull_per">T&amp;B%</a></th>';
                            html += '   <th class="b3"><a href="#" name="m5_per">5M+</a></th>';
                            html += '   <th class="b4"><a href="#" name="m7_per">7M+</a></th>';
                            html += '   <th class="b5"><a href="#" name="m9_per">9M</a></th>';
                            break;
                        case 2:
                            html += '   <th class="b1"><a href="#" name="targ_per">Miss%</a></th>';
                            html += '   <th class="b2"><a href="#" name="trip_bull_per">T&amp;B%</a></th>';
                            html += '   <th class="b3"><a href="#" name="m5">5M+</a></th>';
                            html += '   <th class="b4"><a href="#" name="m7">7M+</a></th>';
                            html += '   <th class="b5"><a href="#" name="m9">9M</a></th>';
                            break;
                        case 3:
                            html += '   <th class="b1"><a href="#" name="bulls_3">3B</a></th>';
                            html += '   <th class="b2"><a href="#" name="bulls_4">4B</a></th>';
                            html += '   <th class="b3"><a href="#" name="bulls_5">5B</a></th>';
                            html += '   <th class="b4"><a href="#" name="bulls_6">6B</a></th>';
                            html += '   <th class="b5"><a href="#" name="hat_tricks">HT</a></th>';
                            break;
                        case 4:
                            html += '   <th class="b1"><a href="#" name="bulls_3_per">3B%</a></th>';
                            html += '   <th class="b2"><a href="#" name="bulls_4_per">4B%</a></th>';
                            html += '   <th class="b3"><a href="#" name="bulls_5_per">5B%</a></th>';
                            html += '   <th class="b4"><a href="#" name="bulls_6_per">6B%</a></th>';
                            html += '   <th class="b5"><a href="#" name="hat_tricks_per">HT%</a></th>';
                            break;
                        case 5:
                            html += '   <th class="b1"><a href="#" name="em5">5M</a></th>';
                            html += '   <th class="b2"><a href="#" name="em6">6M</a></th>';
                            html += '   <th class="b3"><a href="#" name="em7">7M</a></th>';
                            html += '   <th class="b4"><a href="#" name="em8">8M</a></th>';
                            html += '   <th class="b5"><a href="#" name="em9">9M</a></th>';
                            break;
                        case 6:
                            html += '   <th class="b1-b3" colspan="3"><a href="#" name="team_name">' + fmtPlrGrpLbl(plr_group_label) + ' Name</a></th>';
                            html += '   <th class="b4-b5" colspan="2"><a href="#" name="sub_division">Sub Division</a></th>';
                            break;
                    }
                }


                // SECTION 3 **********

                switch (SETTINGS.sec3_toggle) {
                    case 1:
                        html += '   <th class="c1"><a href="#" name="matches"><span class="show-on-mobile">MP</span><span class="show-on-desktop">Matches</span></a></a></th>';
                        html += '   <th class="c2"><a href="#" name="legs">Legs</a></th>';
                        html += '   <th class="c3"><a href="#" name="winp"><span class="show-on-mobile">Legs W</span><span class="show-on-desktop">Legs Win</span></a></a></th>';

                        if (LEADERBOARD.report_dart_avg_units == 'PPR') {
                            html += '   <th class="c4"><a href="#" name="oppXpr">O-3DA</a></th>';
                        } else {
                            html += '   <th class="c4"><a href="#" name="oppXpr">O-1DA</a></th>';
                        }

                        if (SETTINGS.event_type == 'T') {
                            if ((SETTINGS.event_id.substring(0, 2) == 't_') || (SETTINGS.event_id.substring(0, 2) == 'a_')) {
                                html += '   <th class="c5"><a href="#" name="finish">TC</a></th>';
                            } else {
                                html += '   <th class="c5"><a href="#" name="finish">HF</a></th>';
                            }
                        } else {
                            html += '   <th class="c5"><a href="#" name="finish">Div</a></th>';
                        }
                        break;

                    case 2:
                        html += '   <th class="c1"><a href="#" name="legs">Legs</a></th>';
                        html += '   <th class="c2"><a href="#" name="withdarts_legs">LWD</a></th>';
                        html += '   <th class="c3"><a href="#" name="withdarts_wins_per">WD%</a></th>';
                        html += '   <th class="c4"><a href="#" name="againstdarts_legs">LAD</a></th>';
                        html += '   <th class="c5"><a href="#" name="againstdarts_wins_per">AD%</a></th>';
                        break;

                    case 3:
                        html += '   <th class="c1"><a href="#" name="all_matches"><span class="show-on-mobile">MP</span><span class="show-on-desktop">Matches</span></a></a></th>';
                        html += '   <th class="c2"><a href="#" name="all_legs">Legs</a></th>';
                        html += '   <th class="c3"><a href="#" name="all_leg_wins">LWon</a></th>';
                        html += '   <th class="c4"><a href="#" name="all_leg_loses">LLost</a></th>';
                        html += '   <th class="c5"><a href="#" name="all_leg_wins_per"><span class="show-on-mobile">Legs W</span><span class="show-on-desktop">Legs Win</span></a></a></th>';
                        break;

                    case 4:
                        html += '   <th class="c1"><a href="#" name="all_sets">Sets</a></th>';
                        html += '   <th class="c2"><a href="#" name="all_set_wins">SWon</a></th>';
                        html += '   <th class="c3"><a href="#" name="all_set_loses">SLost</a></th>';
                        html += '   <th class="c4"><a href="#" name="all_set_ties">STied</a></th>';
                        html += '   <th class="c5"><a href="#" name="all_set_wins_per">SW%</a></th>';
                        break;

                    case 5:
                        if (SETTINGS.event_type == 'L') {
                            if (LEADERBOARD.event_info.league_type == 'SINGLES') {
                                html += '   <th class="c1"><a href="#" name="all_matches"><span class="show-on-mobile">MP</span><span class="show-on-desktop">Matches</span></a></a></th>';
                                html += '   <th class="c2"><a href="#" name="all_match_wins">MWon</a></th>';
                                html += '   <th class="c3"><a href="#" name="all_match_loses">MLost</a></th>';
                                html += '   <th class="c4"><a href="#" name="all_match_ties">MTied</a></th>';
                                html += '   <th class="c5"><a href="#" name="all_match_wins_per">MW%</a></th>';
                                break;
                            }
                        } else {
                            html += '   <th class="c1"><a href="#" name="all_matches"><span class="show-on-mobile">MP</span><span class="show-on-desktop">Matches</span></a></a></th>';
                            html += '   <th class="c2"><a href="#" name="all_match_wins">MWon</a></th>';
                            html += '   <th class="c3"><a href="#" name="all_match_loses">MLost</a></th>';
                            html += '   <th class="c4"><a href="#" name="all_match_ties">MTied</a></th>';
                            html += '   <th class="c5"><a href="#" name="all_match_wins_per">MW%</a></th>';
                            break;
                        }
                        // Team leagues
                        html += '   <th class="c1-c3" colspan="3"><a href="#" name="team_name">' + fmtPlrGrpLbl(plr_group_label) + ' Name</a></th>';
                        html += '   <th class="c4-c5" colspan="2"><a href="#" name="sub_division">Sub Division</a></th>';
                        break;
                    case 6:
                        // Singles leagues have Divsions in toggle 5
                        html += '   <th class="c1-c3" colspan="3"><a href="#" name="team_name">' + fmtPlrGrpLbl(plr_group_label) + ' Name</a></th>';
                        html += '   <th class="c4-c5" colspan="2"><a href="#" name="sub_division">Sub Division</a></th>';
                        break;
                }

                html += '</tr>';

                $('#group_leaderboard tr.column_label_row').replaceWith(html);
                break;

            case 'P':

                html = '<tr class="thead_sections thead_titlesections titlesection"><th colspan="4" class="sec1 sec1-p"><span>My ' + LEADERBOARD.player_count + ' ' + maybePluralize(LEADERBOARD.player_count, 'Opponent') + '</span></th><th colspan="4" class="sec2 sec2-p"><span>Opponent Performance</span></th><th colspan="7" class="sec3 sec3-p"><span>' + LEADERBOARD.event_info.first_name + '\'s Performance & Record</span></th></tr>';

                html += '<tr class="thead_sections bluesection">';

                var all_op_xr = LEADERBOARD.member_level === 'P' ? LEADERBOARD.all_op_xpr : ICONS.lock();

                // Logic is reversed because of toggle done in sort process
                if (!LEADERBOARD.peg_selected_players) {
                    html += '   <th colspan="5" class="sec1-ml"><button class="toggleMarkedPlayers">Group<span class="ext_text"> Players</span></th>';
                    html += '   <th colspan="3" class="sec1a-ml"><span>All Opponents ' + xpr_unit + ' vs. ' + LEADERBOARD.event_info.first_name + ': ' + all_op_xr + '</span></th>';
                } else {
                    html += '   <th colspan="5" class="sec1-ml"><button class="toggleMarkedPlayers hilighted_button">Ungroup<span class="ext_text"> Players</span></button></th>';
                    html += '   <th colspan="3" class="sec1a-ml"><span>All Opponents ' + xpr_unit + ' vs. ' + LEADERBOARD.event_info.first_name + ': ' + all_op_xr + '</span></th>';
                }

                // html += '   <th colspan="7" class="sec1-ml"><button class="toggleMarkedPlayers">Group<span class="ext_text"> Players</span></button> <span class="player_count">' + LEADERBOARD.player_count + '</span> Opponent\'s <span class="dca_unit">' + xpr_unit + '</span> vs. <span class="first_name_label">' + LEADERBOARD.event_info.first_name + '</span>: <span class="all_opp_dca"> ' + LEADERBOARD.all_op_xpr + '</span></th>';

                var my_dca = LEADERBOARD.member_level === 'P' ? cnullZero(LEADERBOARD.my_dca) : ICONS.lock();

                html += '   <th colspan="7" class="sec2-ml"><span>' + LEADERBOARD.event_info.first_name + '</span>\'s ' + xpr_unit + ' vs. All Opponents: ' + my_dca + '</span></th>';
                html += '</tr>';

                $('#my_leaderboard tr.thead_sections').remove();
                $('#my_leaderboard thead').prepend(html);

                html = '<tr class="column_label_row">';
                html += '   <th class="a1-ml"><img class="clearMarkedBtn" src="/images/close-button.png" width="25" height="25" alt="Clear Selected Players"></th>';

                if (LEADERBOARD.current_sort == 'last_name') {
                    html += '   <th class="a2-ml"><span class="tot_op_label">' + LEADERBOARD.player_count + '</span></th>';
                } else {
                    html += '   <th class="a2-ml"><span class="desktop">Rnk</span><span class="mobile">#</span></th>';
                }

                html += '   <th class="a2b-ml"><a href="#" name="country" class="flagsort"><span class="flagsort-holder"><span class="flagsort-count"></span></span><img src="/images/flagsort.png" class="flagsort-flag"></a></th>';

                html += '   <th class="a3-ml"><a href="#" name="last_name">Opponents</a></th>';

                html += '   <th class="a4-ml"><a href="#" name="op_dca"><span class="show-on-mobile">Opp. <br /> ' + xpr_unit + '</span><span class="show-on-desktop">Current <br /> Opp. ' + xpr_unit + '</span></a></th>';

                html += '   <th class="b1-ml"><a href="#" name="op_xpr">Opp. ' + xpr_unit + ' <br /> vs. ' + LEADERBOARD.event_info.first_name + '</a></th>';

                if (SETTINGS.game_filter_vals.game_type == '01') {
                    html += '   <th class="b2-ml"><a href="#" name="first_nine"><span class="show-on-mobile">Fir9</span><span class="show-on-desktop">First 9 <br /> vs. ' + LEADERBOARD.event_info.first_name + '</span></a></th>';
                    html += '   <th class="b3-ml"><a href="#" name="avg_finish"><span class="show-on-mobile">AFin</span><span class="show-on-desktop">Avg Finish <br /> vs. ' + LEADERBOARD.event_info.first_name + '</span></a></th>';
                } else {
                    html += '   <th class="b2-ml"><a href="#" name="first_nine">Miss% <br /> vs. ' + LEADERBOARD.event_info.first_name + '</a></th>';
                    html += '   <th class="b3-ml"><a href="#" name="avg_finish">T&amp;B% <br /> vs. ' + LEADERBOARD.event_info.first_name + '</a></th>';
                }

                html += '   <th class="c1-ml"><div class="tooltip"><a href="#" name="xpr">My <br /> ' + xpr_unit + '</a></th>';

                if (SETTINGS.game_filter_vals.game_type == '01') {
                    html += '   <th class="c2-ml"><a href="#" name="myfirst_nine"><span class="show-on-mobile">Fir9</span><span class="show-on-desktop">My <br /> First 9</span></a></th>';
                    html += '   <th class="c3-ml"><a href="#" name="myavg_finish"><span class="show-on-mobile">AFin</span><span class="show-on-desktop">My <br /> Avg. Finish</span></a></th>';
                } else {
                    html += '   <th class="c2-ml"><a href="#" name="myfirst_nine">My <br /> Miss%</a></th>';
                    html += '   <th class="c3-ml"><a href="#" name="myavg_finish">My <br /> T&amp;B%</a></th>';
                }

                html += '   <th class="d1-ml"><a href="#" name="matches"><span class="show-on-mobile">MP</span><span class="show-on-desktop">Match <br /> Count</span></a></a></th>';
                html += '   <th class="d2-ml"><a href="#" name="legs"><span class="show-on-mobile">Legs</span><span class="show-on-desktop">Leg <br /> Count</span></a></th>';
                html += '   <th class="d3-ml"><a href="#" name="winp"><span class="show-on-mobile">Legs W</span><span class="show-on-desktop">Leg <br /> Win %</span></a></a></th>';
                html += '   <th class="d4-ml"><a href="#" name="hc"><span class="show-on-mobile">HLC</span><span class="show-on-desktop">HC <br /> Legs</span></a></th>';
                html += '</tr>';

                $('#my_leaderboard tr.column_label_row').replaceWith(html);

                break;
        }

        // Highlight current sorted header column
        $('th.' + LEADERBOARD.sortMap(LEADERBOARD.current_sort)).addClass('hilight_th');
        showTooltip(LEADERBOARD.current_sort);

        // Handle sorts for dupe columns in multiple sections
        if (SETTINGS.event_type == 'L') {
            if ((LEADERBOARD.current_sort == 'team_name') && (
                ((LEADERBOARD.event_info.league_type == 'SINGLES') && (SETTINGS.sec3_toggle == 6))
                || ((LEADERBOARD.event_info.league_type == 'TEAM') && (SETTINGS.sec3_toggle == 5)))
            ) {
                $('th.c1-c3').addClass('hilight_th');
            }
            if ((LEADERBOARD.current_sort == 'sub_division') && (
                ((LEADERBOARD.event_info.league_type == 'SINGLES') && (SETTINGS.sec3_toggle == 6))
                || ((LEADERBOARD.event_info.league_type == 'TEAM') && (SETTINGS.sec3_toggle == 5)))
            ) {
                $('th.c4-c5').addClass('hilight_th');
            }
        }


        // Remove sort links for suppressed tourny results

        if (LEADERBOARD.event_info.suppress_match_results == 'Y') {

            LEADERBOARD.suppress_player_3da = 'Y';

            $('th.c1 a, th.c2 a, th.c3 a, th.c4 a, th.c5 a').each(function () {
                var colTxt = $(this).html();
                $(this).replaceWith(colTxt);
            });
        }

        // Table header handlers

        // Sort
        $('.leaderboard_container th a').click(function (event) {
            event.preventDefault();

            if (SETTINGS.event_type === 'P' && LEADERBOARD.member_level !== 'P') {
                return;
            }

            // $('.leaderboard_container th').removeClass('hilight_th');

            var thisClass = $(this).parent().attr('class');
            // $('th.' + thisClass).addClass('hilight_th');

            var field = $(this).attr('name');
            LEADERBOARD.sort(field, null, thisClass);

        });

        // Toggle group marked players
        $('.toggleMarkedPlayers').click(function () {

            if (KIOSK_FILTER.kioskSearchLetter) {
                KIOSK_FILTER.clearFilter();
            }

            LEADERBOARD.sort('selected_players');
        });

        // Clear selected players
        $('.clearMarkedBtn').click(function (event) {
            event.preventDefault();
            LEADERBOARD.clearSelectedPlayers();
        });

        // Toggle navigation
        $('.tog_btn').click(function () {

            var sec = $(this).data('section');

            switch (sec) {
                case 2:
                    SETTINGS.sec2_toggle = $(this).data('next');
                    break;
                case 3:
                    SETTINGS.sec3_toggle = $(this).data('next');

                    /*
					if (SETTINGS.sec3_toggle == 1) {
						$('#mp_label').show();
					} else {
						$('#mp_label').hide();
					}
					*/

                    break;
            }

            LEADERBOARD.saveState();

            if (LEADERBOARD.player_count > 800) {
                $(this).css('color', '#446');
                setTimeout(function () {
                    LEADERBOARD.render();
                }, 100);
            } else {
                LEADERBOARD.render();
            }

        });


        // ********************** Rows ***********************

        html = '';
        for (var i = 0; i < data.length; i++) {
            // if (LEADERBOARD.event_info.leaderboard_login === 'Password' && data[i].publish_on_leaderboard === 'N') {
            if (data[i].publish_on_leaderboard === 'N') {
                continue;
            }


            if (i == 0 && TOURCARD_WINNERS_MODE && LEADERBOARD.peg_selected_players && SETTINGS.event_id == 't_125') {
                html += '<tr class="tourcard-winners-row" style="height: 44px; line-height: 42px;"><td colspan="15" align="center" style="width: 100%; font-size: 19px; color: #fff;"><div class="flex items-center justify-center"><span><img src="/images/pdc-white-small.svg" class="w-auto h-7 mr-2" /></span><span>Tour Card Winners 2021</span></div></td></tr>';
            }

            if (i == 0 && TOURCARD_WINNERS_MODE && LEADERBOARD.peg_selected_players && SETTINGS.event_id == 't_187') {
                html += '<tr class="tourcard-winners-row" style="height: 44px; line-height: 42px;"><td colspan="15" align="center" style="width: 100%; font-size: 19px; color: #fff;"><div class="flex items-center justify-center"><span><img src="/images/pdc-white-small.svg" class="w-auto h-7 mr-2" /></span><span>Tour Card Winners 2022</span></div></td></tr>';
            }

            if (i == 0 && TOURCARD_WINNERS_MODE && LEADERBOARD.peg_selected_players && SETTINGS.event_id == 't_348') {
                html += '<tr class="tourcard-winners-row" style="height: 44px; line-height: 42px;"><td colspan="15" align="center" style="width: 100%; font-size: 19px; color: #fff;"><div class="flex items-center justify-center"><span><img src="/images/pdc-white-small.svg" class="w-auto h-7 mr-2" /></span><span>Tour Card Winners 2023</span></div></td></tr>';
            }

            if (i == 0 && TOURCARD_WINNERS_MODE && LEADERBOARD.peg_selected_players && SETTINGS.event_id == 't_636') {
                html += '<tr class="tourcard-winners-row" style="height: 44px; line-height: 42px;"><td colspan="15" align="center" style="width: 100%; font-size: 19px; color: #fff;"><div class="flex items-center justify-center"><span><img src="/images/pdc-white-small.svg" class="w-auto h-7 mr-2" /></span><span>Tour Card Winners 2024</span></div></td></tr>';
            }

            if (i == 0 && TOURCARD_WINNERS_MODE && LEADERBOARD.peg_selected_players && SETTINGS.event_id == 't_951') {
                html += '<tr class="tourcard-winners-row" style="height: 44px; line-height: 42px;"><td colspan="15" align="center" style="width: 100%; font-size: 19px; color: #fff;"><div class="flex items-center justify-center"><span><img src="/images/pdc-white-small.svg" class="w-auto h-7 mr-2" /></span><span>Tour Card Winners 2025</span></div></td></tr>';
            }

            // Kiosk filter
            if (KIOSK_FILTER.kioskSearchLetter) {
                if (data[i].last_name.charAt(0).toUpperCase() != KIOSK_FILTER.kioskSearchLetter) {
                    continue;
                }
            }

            // Inject Ad
            if ((i == 10) && (!group_pos_ad)) {
                html += '<tr class="end_selected_players"><td colspan="15" align="center" style="width: 100%;">&nbsp;</td></tr>';
                html += AD_ROW;
                rendered_ad_row = true;
            }

            // My Opponent 3DA Row
            // Show this row when clicked on the column and show divider between high or lower than own average
            if ((SETTINGS.event_type == 'P') && (['op_xpr', 'first_nine', 'avg_finish'].includes(LEADERBOARD.current_sort)) && (!rendered_op_xpr)) {
                var showRow = false;

                if (LEADERBOARD.current_sort === 'op_xpr' && parseFloat(LEADERBOARD.all_op_xpr) >= parseFloat(data[i].op_xpr)) {
                    showRow = true;
                }
                //

                if (LEADERBOARD.current_sort === 'first_nine'
                    && (
                        parseFloat(LEADERBOARD.all_op_firstnine) >= data[i].first_nine
                        || parseFloat(LEADERBOARD.all_op_miss) >= (1 - data[i].targ_per)
                    )
                ) {
                    showRow = true;
                }

                if (LEADERBOARD.current_sort === 'avg_finish'
                    && (
                        parseFloat(LEADERBOARD.all_op_avgfinish) >= data[i].avg_finish
                        || parseFloat(LEADERBOARD.all_op_tripbull_per) >= data[i].trip_bull_per
                    )
                ) {
                    showRow = true;
                }

                if (showRow) {
                    if (LEADERBOARD.current_sort === 'op_xpr') {
                        html += '<tr class="op_xpr_row" style="background: #000; color: #b5b5b5 !important; text-align: center;">';
                        html += '<td class="a1-a4-ml text-center" style="color: #b5b5b5 !important;" colspan="4"><span class="flex items-center h-full justify-end xl:text-lg pr-4"><span class="inline-flex justify-center lg:w-3"><svg xmlns="http://www.w3.org/2000/svg" class="triangle flex-shrink-0 inline-flex w-4 h-4 text-green-400 mr-4" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.022 1.566a1.13 1.13 0 0 1 1.96 0l6.857 11.667c.457.778-.092 1.767-.98 1.767H1.144c-.889 0-1.437-.99-.98-1.767L7.022 1.566z"/></svg></span><span class="font-semibold"><span>' + cnullZero(LEADERBOARD.op_xpr_outperform) + '</span> ' + maybePluralize(LEADERBOARD.op_xpr_outperform, 'Opponent') + '</span></span></td>';
                        html += '<td colspan="8" style="width: 70%; text-align: left; color: #b5b5b5 !important;" class="pl-4">These opponents <u>out-perform</u> the overall opponent ' + xpr_unit + ' of ' + LEADERBOARD.all_op_xpr + '.</td>';
                        html += '</td>';
                    }

                    var op_xpr = SETTINGS.event_type === 'P' && LEADERBOARD.member_level === 'P' ? LEADERBOARD.all_op_xpr : ICONS.lock();

                    html += '<tr class="op_xpr_row">';
                    html += '<td class="a1-a4-ml mydca-lastcol text-center md:text-right flex items-center justify-center lg:justify-end" colspan="4"><span class="show-on-mobile italic text-sm xl:text-base">The collective average for All Opponents (' + LEADERBOARD.all_op_legs + ' Legs):</span><span class="show-on-desktop italic text-sm xl:text-base">The collective average for ' + LEADERBOARD.event_info.first_name + '\'s Opponents (' + LEADERBOARD.all_op_legs + ' Legs):</span></td>';
                    if (LEADERBOARD.current_sort === 'op_xpr') {
                        html += '<td class="b1-ml mydca-lastcol"><span class="lg:w-10 justify-end inline-flex">' + op_xpr + '</span> <span class="inline-flex justify-center w-3 opacity-0"></span></td>';
                    } else {
                        html += '<td class="b1-ml mydca-lastcol">' + op_xpr + '</td>';
                    }
                    if (LEADERBOARD.current_sort === 'first_nine') {
                        if (SETTINGS.game_filter_vals.game_type == '01') {
                            html += '<td class="b2-ml mydca-lastcol"><span class="lg:w-10 justify-end inline-flex">' + dispDecStat(LEADERBOARD.all_op_firstnine) + '</span> <span class="inline-flex justify-center w-3 opacity-0"></span></td>';
                        } else {
                            html += '<td class="b2-ml mydca-lastcol"><span class="lg:w-10 justify-end inline-flex">' + formatMissPer(LEADERBOARD.all_op_miss, '%') + '</span> <span class="inline-flex justify-center w-3 opacity-0"></span></td>';
                        }
                    } else {
                        if (SETTINGS.game_filter_vals.game_type == '01') {
                            html += '<td class="b2-ml mydca-lastcol">' + dispDecStat(LEADERBOARD.all_op_firstnine) + '</td>';
                        } else {
                            html += '<td class="b2-ml mydca-lastcol">' + formatMissPer(LEADERBOARD.all_op_miss, '%') + '</td>';
                        }
                    }
                    if (LEADERBOARD.current_sort === 'avg_finish') {
                        if (SETTINGS.game_filter_vals.game_type == '01') {
                            html += '<td class="b3-ml mydca-lastcol"><span class="lg:w-10 justify-end inline-flex">' + dispDecStat(LEADERBOARD.all_op_avgfinish) + '</span> <span class="inline-flex justify-center w-3 opacity-0"></span></td>';
                        } else {
                            html += '<td class="b3-ml mydca-lastcol"><span class="lg:w-10 justify-end inline-flex">' + formatMissPer(LEADERBOARD.all_op_tripbull_per, '%') + '</span> <span class="inline-flex justify-center w-3 opacity-0"></span></td>';
                        }
                    } else {
                        if (SETTINGS.game_filter_vals.game_type == '01') {
                            html += '<td class="b3-ml mydca-lastcol">' + dispDecStat(LEADERBOARD.all_op_avgfinish) + '</td>';
                        } else {
                            html += '<td class="b3-ml mydca-lastcol">' + formatMissPer(LEADERBOARD.all_op_tripbull_per, '%') + '</td>';
                        }
                    }
                    html += '<td class="c1-ml mydca-lastcol-transparent">' + my_dca + '</td>';
                    if (SETTINGS.game_filter_vals.game_type == '01') {
                        html += '<td class="c2-ml mydca-lastcol-transparent">' + dispDecStat(LEADERBOARD.all_my_firstnine) + '</td>';
                        html += '<td class="c3-ml mydca-lastcol-transparent">' + dispDecStat(LEADERBOARD.all_my_avgfinish) + '</td>';
                    } else {
                        html += '<td class="c2-ml mydca-lastcol-transparent">' + formatMissPer(LEADERBOARD.all_my_miss, '%') + '</td>';
                        html += '<td class="c3-ml mydca-lastcol-transparent">' + formatMissPer(LEADERBOARD.all_my_tripbull_per, '%') + '</td>';
                    }
                    html += '<td class="d1-ml mydca-lastcol-transparent">' + LEADERBOARD.all_my_matches + '</td>';
                    html += '<td class="d2-ml mydca-lastcol-transparent">' + LEADERBOARD.all_my_legs + '</td>';
                    html += '<td class="d3-ml mydca-lastcol-transparent">' + formatPer(LEADERBOARD.all_my_leg_wins, '%') + '</td>';
                    html += '<td class="d4-ml mydca-lastcol-transparent">' + LEADERBOARD.all_my_handicap_legs || '-' + '</td>';
                    html += '</tr>';
                    rendered_op_xpr = true;

                    if (LEADERBOARD.current_sort === 'op_xpr') {
                        html += '<tr class="op_xpr_row" style="background: #000; color: #b5b5b5 !important; text-align: center;">';
                        html += '<td class="a1-a4-ml text-center" colspan="4" style="color: #b5b5b5 !important;"><span class="flex items-center h-full justify-end xl:text-lg pr-4"><span class="inline-flex justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="triangle flex-shrink-0 transform -rotate-180 inline-flex w-4 h-4 text-pink-500 mr-2" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.022 1.566a1.13 1.13 0 0 1 1.96 0l6.857 11.667c.457.778-.092 1.767-.98 1.767H1.144c-.889 0-1.437-.99-.98-1.767L7.022 1.566z"/></svg></span><span class="font-semibold"><span>' + cnullZero(LEADERBOARD.op_xpr_underperform) + '</span> ' + maybePluralize(LEADERBOARD.op_xpr_underperform, 'Opponent') + '</span></span></td>';
                        html += '<td colspan="8" style="width: 70%; text-align: left; color: #b5b5b5 !important;" class="pl-4">These opponents <u>under-perform</u> the overall opponent ' + xpr_unit + ' of ' + LEADERBOARD.all_op_xpr + '.</td>';
                        html += '</td>';
                    }
                }
            }

            // My DCA Row
            if ((SETTINGS.event_type == 'P') && (['xpr', 'myfirst_nine', 'myavg_finish'].includes(LEADERBOARD.current_sort)) && (!rendered_my_dca)) {
                var showRow = false;

                if (LEADERBOARD.current_sort === 'xpr' && parseFloat(LEADERBOARD.my_dca) >= parseFloat(data[i].xpr)) {
                    showRow = true;
                }

                if (LEADERBOARD.current_sort === 'myfirst_nine'
                    && (
                        parseFloat(LEADERBOARD.all_my_firstnine) >= data[i].myfirst_nine
                        || parseFloat(LEADERBOARD.all_my_miss) >= (1 - data[i].mytarg_per)
                    )
                ) {
                    showRow = true;
                }

                if (LEADERBOARD.current_sort === 'myavg_finish'
                    && (
                        parseFloat(LEADERBOARD.all_my_avgfinish) >= data[i].myavg_finish
                        || parseFloat(LEADERBOARD.all_my_tripbull_per) >= data[i].mytrip_bull_per
                    )
                ) {
                    showRow = true;
                }

                if (showRow) {
                    if (LEADERBOARD.current_sort === 'xpr') {
                        html += '<tr class="my_dca_row" style="background: #000; color: #b5b5b5 !important; text-align: center;">';
                        html += '<td colspan="5" class="sec1-ml"></td>';
                        html += '<td colspan="3" class="sec1a-ml"><span class="flex items-center h-full justify-end xl:text-lg pr-4"><span class="inline-flex justify-center lg:w-3"><svg xmlns="http://www.w3.org/2000/svg" class="triangle flex-shrink-0 inline-flex w-4 h-4 text-green-400 mr-4" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.022 1.566a1.13 1.13 0 0 1 1.96 0l6.857 11.667c.457.778-.092 1.767-.98 1.767H1.144c-.889 0-1.437-.99-.98-1.767L7.022 1.566z"/></svg></span><span class="font-semibold"><span>' + cnullZero(LEADERBOARD.xpr_outperform) + '</span> ' + maybePluralize(LEADERBOARD.xpr_outperform, 'Opponent') + '</span></span></td>';
                        html += '<td colspan="8" class="sec2-ml pl-4" style="text-align: left;">You <u>out-perform</u> your <span>' + xpr_unit + '</span> against <u>' + formatMissPer(cnullZero(LEADERBOARD.xpr_outperform) / LEADERBOARD.player_count, '%', 0) + '</u> of your opponents.</td>';
                        html += '</td>';
                        html += '</tr>';
                    }

                    var my_dca = SETTINGS.event_type === 'P' && LEADERBOARD.member_level === 'P' ? LEADERBOARD.my_dca : ICONS.lock();

                    html += '<tr class="my_dca_row">';
                    html += '<td class="a1-a4-ml mydca-lastcol-transparent text-center flex items-center justify-center" colspan="5"><span class="show-on-mobile italic text-sm xl:text-base text-center">vs. All ' + LEADERBOARD.player_count + ' ' + maybePluralize(LEADERBOARD.player_count, 'Opponent') + ' for ' + LEADERBOARD.all_my_legs + ' legs</span><span class="show-on-desktop italic text-sm xl:text-base text-center">' + LEADERBOARD.event_info.first_name + '\'s ' + xpr_unit + ' vs all ' + LEADERBOARD.player_count + ' ' + maybePluralize(LEADERBOARD.player_count, 'Opponent') + ' for ' + LEADERBOARD.all_my_legs + ' legs</span></td>';
                    html += '<td class="b1-ml mydca-lastcol-transparent">' + LEADERBOARD.all_op_xpr + '</td>';
                    if (SETTINGS.game_filter_vals.game_type == '01') {
                        html += '<td class="b2-ml mydca-lastcol-transparent">' + dispDecStat(LEADERBOARD.all_op_firstnine) + '</td>';
                        html += '<td class="b3-ml mydca-lastcol-transparent">' + dispDecStat(LEADERBOARD.all_op_avgfinish) + '</td>';
                    } else {
                        html += '<td class="b2-ml mydca-lastcol-transparent">' + formatMissPer(LEADERBOARD.all_op_miss, '%') + '</td>';
                        html += '<td class="b3-ml mydca-lastcol-transparent">' + formatMissPer(LEADERBOARD.all_op_tripbull_per, '%') + '</td>';
                    }
                    if (LEADERBOARD.current_sort === 'xpr') {
                        html += '<td class="c1-ml mydca-lastcol"><span class="lg:w-10 justify-end inline-flex">' + my_dca + '</span> <span class="inline-flex justify-center w-3 opacity-0"></span></td>';
                    } else {
                        html += '<td class="c1-ml mydca-lastcol">' + my_dca + '</td>';
                    }
                    if (LEADERBOARD.current_sort === 'myfirst_nine') {
                        if (SETTINGS.game_filter_vals.game_type == '01') {
                            html += '<td class="c2-ml mydca-lastcol"><span class="lg:w-10 justify-end inline-flex">' + dispDecStat(LEADERBOARD.all_my_firstnine) + '</span> <span class="inline-flex justify-center w-3 opacity-0"></span></td>';
                        } else {
                            html += '<td class="c2-ml mydca-lastcol"><span class="lg:w-10 justify-end inline-flex">' + formatMissPer(LEADERBOARD.all_my_miss, '%') + '</span> <span class="inline-flex justify-center w-3 opacity-0"></span></td>';
                        }
                    } else {
                        if (SETTINGS.game_filter_vals.game_type == '01') {
                            html += '<td class="c2-ml mydca-lastcol">' + dispDecStat(LEADERBOARD.all_my_firstnine) + '</td>';
                        } else {
                            html += '<td class="c2-ml mydca-lastcol">' + formatMissPer(LEADERBOARD.all_my_miss, '%') + '</td>';
                        }
                    }
                    if (LEADERBOARD.current_sort === 'myavg_finish') {
                        if (SETTINGS.game_filter_vals.game_type == '01') {
                            html += '<td class="c3-ml mydca-lastcol"><span class="lg:w-10 justify-end inline-flex">' + dispDecStat(LEADERBOARD.all_my_avgfinish) + '</span> <span class="inline-flex justify-center w-3 opacity-0"></span></td>';
                        } else {
                            html += '<td class="c3-ml mydca-lastcol"><span class="lg:w-10 justify-end inline-flex">' + formatMissPer(LEADERBOARD.all_my_tripbull_per, '%') + '</span> <span class="inline-flex justify-center w-3 opacity-0"></span></td>';
                        }
                    } else {
                        if (SETTINGS.game_filter_vals.game_type == '01') {
                            html += '<td class="c3-ml mydca-lastcol">' + dispDecStat(LEADERBOARD.all_my_avgfinish) + '</td>';
                        } else {
                            html += '<td class="c3-ml mydca-lastcol">' + formatMissPer(LEADERBOARD.all_my_tripbull_per, '%') + '</td>';
                        }
                    }
                    html += '<td class="d1-ml mydca-lastcol">' + LEADERBOARD.all_my_matches + '</td>';
                    html += '<td class="d2-ml mydca-lastcol">' + LEADERBOARD.all_my_legs + '</td>';
                    html += '<td class="d3-ml mydca-lastcol">' + formatPer(LEADERBOARD.all_my_leg_wins, '%') + '</td>';
                    html += '<td class="d4-ml mydca-lastcol">' + LEADERBOARD.all_my_handicap_legs || '-' + '</td>';
                    html += '</tr>';
                    rendered_my_dca = true;

                    if (LEADERBOARD.current_sort === 'xpr') {
                        html += '<tr class="my_dca_row" style="background: #000; color: #b5b5b5 !important; text-align: center;">';
                        html += '<td colspan="5" class="sec1-ml"></td>';
                        html += '<td colspan="3" class="sec1a-ml"><span class="flex items-center h-full justify-end xl:text-lg pr-4"><span class="inline-flex justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="triangle flex-shrink-0 transform -rotate-180 inline-flex w-4 h-4 text-pink-500 mr-2" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.022 1.566a1.13 1.13 0 0 1 1.96 0l6.857 11.667c.457.778-.092 1.767-.98 1.767H1.144c-.889 0-1.437-.99-.98-1.767L7.022 1.566z"/></svg></span><span class="font-semibold"><span>' + cnullZero(LEADERBOARD.xpr_underperform) + '</span> ' + maybePluralize(LEADERBOARD.xpr_underperform, 'Opponent') + '</span></span></td>';
                        html += '<td colspan="8" class="sec2-ml pl-4" style="text-align: left;">You <u>under-perform</u> your <span>' + xpr_unit + '</span> against <u>' + formatMissPer(cnullZero(LEADERBOARD.xpr_underperform) / LEADERBOARD.player_count, '%', 0) + '</u> of your opponents.</td>';
                        html += '</td>';
                        html += '</tr>';
                    }
                }
            }


            // Country Header
            if ((LEADERBOARD.current_sort == 'country') && !LEADERBOARD.peg_selected_players) {
                if (data[i].country != last_country) {
                    countryCount += 1;

                    const totalPlayersInCountry = data.filter(e => e.country === data[i].country).length;
                    const playersLabel = totalPlayersInCountry > 1 ? 'players' : 'player';

                    html += '<tr class="rowsubdiv">';
                    html += '<th colspan="15" style="width: 100%;">' + cnullcountry(data[i].country) + ' (' + totalPlayersInCountry + ' ' + playersLabel + ')</th></tr>';

                    /*
					html += '<tr class="rowsubdiv"><th class="a1"></th><th class="a2"></th><th class="a2b hilight" style="background-color: #4f6a84;"></th>';
					html += '<th colspan="12" class="a2b-end">' + cnull(data[i].country) + '</th></tr>';
					*/


                    /*
					html += '<tr class="rowsubdiv"><th class="a1"></th><th class="a2"></th><th class="a2b hilight" style="background-color: #4f6a84;"></th>';
					html += '<th colspan=2 class="a3-a4">' + cnull(data[i].country) + '</th>';
					html += '<th class="b1"></th>';
					html += '<th class="b2"></th>';
					html += '<th class="b3"></th>';
					html += '<th class="b4"></th>';
					html += '<th class="b5"></th>';

					html += '<th class="c1"></th>';
					html += '<th class="c2"></th>';
					html += '<th class="c3"></th>';
					html += '<th class="c4"></th>';
					html += '<th class="c5"></th>';
					html += '</tr>';
					*/

                    last_country = data[i].country;
                }
            }


            card_link = data[i].last_name + '-';
            if (data[i].xpr) {
                card_link += '' + data[i].xpr + '-';
            } else {
                card_link += 'x-';
            }

            card_link += 'x';

            target = SETTINGS.event_id + '-' + data[i].last_name + '-' + data[i].first_name;

            // console.log(SETTINGS.event_id.substring(0, 2) + ' : ' + LEADERBOARD.pdc + ' : ' + data[i].player_guid);

            switch (SETTINGS.event_type) {
                case 'T':

                    /*
					if (((LEADERBOARD.bracket_interface == 'None') || (!LEADERBOARD.bracket_interface))
						|| ((SETTINGS.event_id.substring(0, 2) == 't_') && (LEADERBOARD.pdc == 'N'))) {
					*/

                    if (((LEADERBOARD.bracket_interface == 'None') || (!LEADERBOARD.bracket_interface))
                        || ((SETTINGS.event_id.substring(0, 2) == 't_') && (LEADERBOARD.pdc == 'N') && (LEADERBOARD.tour_roster_type == 'T'))) {

                        playerCompVal = cnull(data[i].email);
                    } else {
                        // Pro event
                        playerCompVal = cnull(data[i].player_guid);
                    }
                    break;
                case 'L':
                    playerCompVal = cnull(data[i].player_guid);
                    break;
                case 'P':
                    playerCompVal = cnull(data[i].member_id);
                    break;
                default:
                    playerCompVal = 'xxx';
                    break;
            }

            thisSelected = false;

            for (var sp = 0; sp < LEADERBOARD.selected_players[SETTINGS.event_type].length; sp++) {
                if (LEADERBOARD.selected_players[SETTINGS.event_type][sp] == playerCompVal) {
                    thisSelected = true;
                    found_selected_player = true;
                    break;
                }
            }

            if (LEADERBOARD.peg_selected_players && lastSelected && !thisSelected) {
                // Inject Ad
                if (group_pos_ad) {

                    if ((SETTINGS.event_type === 'P' && LEADERBOARD.member_level !== 'P') || (SETTINGS.event_id == 'a_target2018') || (SETTINGS.event_id == 'a_winmau2018')) {
                        html += '<tr class="end_selected_players"><td colspan="15" align="center" style="width: 100%;">&nbsp;</td></tr>';
                    } else if (TOURCARD_WINNERS_MODE) {
                        html += '<tr class="end_selected_players"><td colspan="15" align="center" style="width: 100%;">&nbsp;</td></tr>';
                    } else {
                        html += '<tr class="end_selected_players"><td colspan="15" align="center" style="width: 100%;"><h3>&quot;My Marked Players&quot; &nbsp;&nbsp; Brought to you by:</h3></td></tr>';
                    }

                    html += AD_ROW;
                    rendered_ad_row = true;
                }
            }
            lastSelected = thisSelected;


            if (i > SCROLL.last_row) {
                SCROLL.last_row = i;
            }

            if (thisSelected && !LEADERBOARD.peg_selected_players) {
                html += '<tr class="selected_player">';
            } else {
                html += '<tr id="player-row_' + i + '">';
            }


            if (LEADERBOARD.peg_selected_players) {
                if (thisSelected) {
                    html += '<td class="a1' + colClassSfx + '" style="background-color:rgba(255,220,40,0.3);">';
                    html += '<span class="grouped_rank">' + grouped_rank + '</span></td>';
                    grouped_rank += 1;
                } else {
                    html += '<td class="a1' + colClassSfx + '">';
                    html += '</td>';
                }
            } else {
                html += '<td class="a1' + colClassSfx + '">';
                html += '<a href="#" data-id="' + playerCompVal + '" ';
                if (SETTINGS.event_type === 'P' && LEADERBOARD.member_level !== 'P') {
                    html += '></a></td>';
                } else {
                    if (thisSelected) {
                        html += 'class="select_player"><span class="checked" style="color: #b71e1a;"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg></span><span class="unchecked" style="display: none;"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg></span></a></td>';
                    } else {
                        html += 'class="select_player"><span class="unchecked" style="color: #cecece;"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg></span><span class="checked" style="display: none; color: #b71e1a;"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg></span></a></td>';
                    }
                }
            }

            // case 'matches':
            // case 'legs':
            switch (LEADERBOARD.current_sort) {
                case 'last_name':
                case 'selected_players':
                    html += '<td class="a2' + colClassSfx + '"></td>';
                    break;
                default:
                    html += '<td class="a2' + colClassSfx + '">' + data[i].rank + '</td>';
                    break;
            }

            // console.log((1 + i) + ',' + data[i].last_name + ',' + data[i].first_name + ',' + data[i].xpr + ',' + data[i].matches);

            // Nation
            if (SETTINGS.event_type == 'L') {

                // content: '<img src="/images/blank.gif" class="flag flag' + fmtCoutryCd(LEADERBOARD.event_info.country_iso2) + '">'
                // content: '<img src="/images/blank.gif" class="flag flag' + fmtCoutryCd(data[i].iso2) + '">'

                html += buildStatCol({
                    sort_id: 'country',
                    selected: thisSelected,
                    class: 'a2b',
                    content: genFlag(data[i].iso2, SETTINGS.event_type),
                });
            } else if (SETTINGS.event_type == 'T') {
                html += buildStatCol({
                    sort_id: 'country',
                    selected: thisSelected,
                    class: 'a2b',
                    content: genFlag(data[i].iso2)
                });
            } else {
                html += buildStatCol({
                    sort_id: 'country',
                    selected: thisSelected,
                    class: 'a2b-ml',
                    content: genFlag(data[i].iso2)
                });
            }

            // Last Name

            nameDisp = data[i].last_name + ', ' + data[i].first_name.charAt(0) + '<label>' + data[i].first_name.substring(1) + '</label>';

            switch (SETTINGS.event_type) {
                case 'T':
                    if (((LEADERBOARD.bracket_interface == 'None') || (!LEADERBOARD.bracket_interface))
                        || ((SETTINGS.event_id.substring(0, 2) == 't_') && (LEADERBOARD.pdc == 'N') && (LEADERBOARD.tour_roster_type == 'T'))) {

                        // Non-ProEvent
                        if (LEADERBOARD.current_sort == 'last_name') {
                            if (data[i].member_id) {
                                contentVal = '<span class="lblink-inv" data-player_id="' + data[i].member_id + '" data-i="' + i + '">' + nameDisp + '</span>';
                            } else {
                                contentVal = '<span class="lblink-inv" data-player_id="' + data[i].email + '" data-i="' + i + '">' + nameDisp + '</span>';
                            }
                        } else {
                            if (data[i].member_id) {
                                contentVal = '<span class="lblink" data-player_id="' + data[i].member_id + '" data-i="' + i + '">' + nameDisp + '</span>';
                            } else {
                                contentVal = '<span class="lblink" data-player_id="' + data[i].email + '" data-i="' + i + '">' + nameDisp + '</span>';
                            }
                        }

                    } else {

                        // Pro Event
                        if (LEADERBOARD.current_sort == 'last_name') {
                            contentVal = '<span class="lblink-inv" data-player_id="' + data[i].player_guid + '" data-i="' + i + '">' + nameDisp + '</span>';
                        } else {
                            contentVal = '<span class="lblink" data-player_id="' + data[i].player_guid + '" data-i="' + i + '">' + nameDisp + '</span>';
                        }
                    }
                    break;

                case 'L':
                    if (LEADERBOARD.current_sort == 'last_name') {
                        contentVal = '<span class="lblink-inv" data-player_id="' + data[i].player_guid + '" data-i="' + i + '">' + nameDisp + '</span>';
                    } else {
                        contentVal = '<span class="lblink" data-player_id="' + data[i].player_guid + '" data-i="' + i + '">' + nameDisp + '</span>';
                    }
                    break;

                default:
                    contentVal = nameDisp;
                    break;
            }

            html += buildStatCol({
                sort_id: 'last_name',
                selected: thisSelected,
                class: 'a3' + colClassSfx,
                content: contentVal
            });

            /*
	       	html += buildStatCol({
	        	sort_id: 'last_name',
	        	selected: thisSelected,
	        	class: 'a3' + colClassSfx,
	        	content: data[i].last_name + ', ' + data[i].first_name.charAt(0) + '<span>' + data[i].first_name.substring(1) + '</span>'
	        });
			*/

            if ((SETTINGS.event_type == 'T') || (SETTINGS.event_type == 'L')) {
                // GROUP LEADERBOARD

                // Xpr

                if (LEADERBOARD.suppress_player_3da == 'Y') {
                    html += buildStatCol({
                        sort_id: 'xpr',
                        selected: thisSelected,
                        class: 'a4',
                        content: '<span onclick="alert(\'' + suppress_3da_msg + '\');">?</span>'
                    });
                } else {
                    html += buildStatCol({
                        sort_id: 'xpr',
                        selected: thisSelected,
                        class: 'a4',
                        content: '<span onclick="showCard(\'' + cleanApos(data[i].last_name) + '\',\'' + cnullx(data[i].xpr) + '\',\'' + data[i].finish + '\',\'' + data[i].event_finals_outcome + '\')">' + data[i].xpr + '</span>'
                    });
                }

                if (SETTINGS.game_filter_vals.game_type == '01') {

                    switch (SETTINGS.sec2_toggle) {
                        case 1:
                            // F9
                            html += buildStatCol({
                                sort_id: 'first_nine',
                                selected: thisSelected,
                                class: 'b1',
                                content: dispDecStat(data[i].first_nine)
                            });
                            // Avg Finish
                            html += buildStatCol({
                                sort_id: 'avg_finish',
                                selected: thisSelected,
                                class: 'b2',
                                content: dispDecStat(data[i].avg_finish)
                            });
                            // P100
                            html += buildStatCol({
                                sort_id: 'p100_per',
                                selected: thisSelected,
                                class: 'b3',
                                content: formatPer(data[i].p100_per, '%')
                            });
                            // P140
                            html += buildStatCol({
                                sort_id: 'p140_per',
                                selected: thisSelected,
                                class: 'b4',
                                content: formatPer(data[i].p140_per, '%')
                            });
                            // Ton80
                            html += buildStatCol({
                                sort_id: 'ton80_per',
                                selected: thisSelected,
                                class: 'b5',
                                content: formatPer(data[i].ton80_per, '%')
                            });
                            break;

                        case 2:
                            // F9
                            html += buildStatCol({
                                sort_id: 'first_nine',
                                selected: thisSelected,
                                class: 'b1',
                                content: dispDecStat(data[i].first_nine)
                            });
                            // Avg Finish
                            html += buildStatCol({
                                sort_id: 'avg_finish',
                                selected: thisSelected,
                                class: 'b2',
                                content: dispDecStat(data[i].avg_finish)
                            });
                            // P100
                            html += buildStatCol({
                                sort_id: 'p100_leg',
                                selected: thisSelected,
                                class: 'b3',
                                content: data[i].p100_leg
                            });
                            // P140
                            html += buildStatCol({
                                sort_id: 'p140_leg',
                                selected: thisSelected,
                                class: 'b4',
                                content: data[i].p140_leg
                            });
                            // Ton80
                            html += buildStatCol({
                                sort_id: 'ton80_leg',
                                selected: thisSelected,
                                class: 'b5',
                                content: data[i].ton80_leg
                            });
                            break;

                        case 3:
                            // F9
                            html += buildStatCol({
                                sort_id: 'first_nine',
                                selected: thisSelected,
                                class: 'b1',
                                content: dispDecStat(data[i].first_nine)
                            });
                            // Avg Finish
                            html += buildStatCol({
                                sort_id: 'avg_finish',
                                selected: thisSelected,
                                class: 'b2',
                                content: dispDecStat(data[i].avg_finish)
                            });
                            // P100
                            html += buildStatCol({
                                sort_id: 'p100',
                                selected: thisSelected,
                                class: 'b3',
                                content: data[i].p100
                            });
                            // P140
                            html += buildStatCol({
                                sort_id: 'p140',
                                selected: thisSelected,
                                class: 'b4',
                                content: data[i].p140
                            });
                            // Ton80
                            html += buildStatCol({
                                sort_id: 'ton80',
                                selected: thisSelected,
                                class: 'b5',
                                content: data[i].ton80
                            });
                            break;

                        case 4:
                            // F9
                            html += buildStatCol({
                                sort_id: 'first_nine',
                                selected: thisSelected,
                                class: 'b1',
                                content: dispDecStat(data[i].first_nine)
                            });
                            // Avg Finish
                            html += buildStatCol({
                                sort_id: 'avg_finish',
                                selected: thisSelected,
                                class: 'b2',
                                content: dispDecStat(data[i].avg_finish)
                            });
                            // P100
                            html += buildStatCol({
                                sort_id: 'p100',
                                selected: thisSelected,
                                class: 'b3',
                                content: data[i].p100
                            });
                            // Total ton points - 2 columns
                            html += buildStatCol({
                                sort_id: 'ton_points',
                                selected: thisSelected,
                                class: 'b4-b5tot',
                                content: dispIntVal(data[i].ton_points)
                            });
                            break;

                        case 5:
                            // Hi Turns (01 only)

                            // H-Turn
                            html += buildStatCol({
                                sort_id: 'high_turn',
                                selected: thisSelected,
                                class: 'b1',
                                content: fmtStat(data[i].high_turn)
                            });

                            // H-SI
                            html += buildStatCol({
                                sort_id: 'high_first_turn',
                                selected: thisSelected,
                                class: 'b2',
                                content: fmtStat(data[i].high_first_turn)
                            });

                            // H-DIT
                            html += buildStatCol({
                                sort_id: 'high_double_in_turn',
                                selected: thisSelected,
                                class: 'b3',
                                content: fmtStat(data[i].high_double_in_turn)
                            });

                            // H-DI
                            html += buildStatCol({
                                sort_id: 'high_double_in',
                                selected: thisSelected,
                                class: 'b4',
                                content: fmtStat(data[i].high_double_in)
                            });

                            // H-DO
                            html += buildStatCol({
                                sort_id: 'high_double_out',
                                selected: thisSelected,
                                class: 'b5',
                                content: fmtStat(data[i].high_double_out)
                            });
                            break;

                        case 6:
                            // Extended Counts
                            // T00
                            html += buildStatCol({
                                sort_id: 't00',
                                selected: thisSelected,
                                class: 'b1',
                                content: data[i].t00
                            });
                            //  T20
                            html += buildStatCol({
                                sort_id: 't20',
                                selected: thisSelected,
                                class: 'b2',
                                content: data[i].t20
                            });
                            // T40
                            html += buildStatCol({
                                sort_id: 't40',
                                selected: thisSelected,
                                class: 'b3',
                                content: data[i].t40
                            });
                            // T60
                            html += buildStatCol({
                                sort_id: 't60',
                                selected: thisSelected,
                                class: 'b4',
                                content: data[i].t60
                            });
                            // T80
                            html += buildStatCol({
                                sort_id: 't80',
                                selected: thisSelected,
                                class: 'b5',
                                content: data[i].t80
                            });
                            break;

                        case 7:
                            // Avg Finish
                            html += buildStatCol({
                                sort_id: 'avg_finish',
                                selected: thisSelected,
                                class: 'b1',
                                content: dispDecStat(data[i].avg_finish)
                            });
                            // COE
                            html += buildStatCol({
                                sort_id: 'coe',
                                selected: thisSelected,
                                class: 'b2',
                                content: formatPer(data[i].coe, '%')
                            });
                            // COD
                            html += buildStatCol({
                                sort_id: 'cod',
                                selected: thisSelected,
                                class: 'b3 frac',
                                content: data[i].cod + '/' + data[i].coo
                            });
                            // co_perc
                            html += buildStatCol({
                                sort_id: 'co_perc',
                                selected: thisSelected,
                                class: 'b4',
                                content: formatPer(data[i].co_perc, '%/' + data[i].tcod)
                            });
                            // COA
                            html += buildStatCol({
                                sort_id: 'coa',
                                selected: thisSelected,
                                class: 'b5 frac',
                                content: cnullFrac(data[i].tcod, data[i].coa)
                            });
                            break;

                        case 8:
                            // Team Name
                            html += buildStatCol({
                                sort_id: 'team_name',
                                selected: thisSelected,
                                class: 'b1-b3',
                                content: data[i].team_name
                            });

                            // Team Name
                            html += buildStatCol({
                                sort_id: 'sub_division',
                                selected: thisSelected,
                                class: 'b4-b5',
                                content: data[i].division
                            });
                            break;
                    }

                } else {
                    // Cricket

                    switch (SETTINGS.sec2_toggle) {
                        case 1:
                            // Miss %
                            if (data[i].targ_per) {
                                contentVal = 1 - data[i].targ_per;
                            } else {
                                contentVal = '';
                            }
                            html += buildStatCol({
                                sort_id: 'targ_per',
                                selected: thisSelected,
                                class: 'b1',
                                content: formatPer(contentVal, '%')
                            });

                            // Trip-Bull%
                            html += buildStatCol({
                                sort_id: 'trip_bull_per',
                                selected: thisSelected,
                                class: 'b2',
                                content: formatPer(data[i].trip_bull_per, '%')
                            });

                            // 5M
                            html += buildStatCol({
                                sort_id: 'm5_per',
                                selected: thisSelected,
                                class: 'b3',
                                content: formatPer(data[i].m5_per, '%')
                            });

                            // 7M
                            html += buildStatCol({
                                sort_id: 'm7_per',
                                selected: thisSelected,
                                class: 'b4',
                                content: formatPer(data[i].m7_per, '%')
                            });

                            // 9M
                            html += buildStatCol({
                                sort_id: 'm9_per',
                                selected: thisSelected,
                                class: 'b5',
                                content: formatPer(data[i].m9_per, '%')
                            });
                            break;

                        case 2:
                            // Miss %
                            if (data[i].targ_per) {
                                contentVal = 1 - data[i].targ_per;
                            } else {
                                contentVal = '';
                            }
                            html += buildStatCol({
                                sort_id: 'targ_per',
                                selected: thisSelected,
                                class: 'b1',
                                content: formatPer(contentVal, '%')
                            });

                            // Trip-Bull%
                            html += buildStatCol({
                                sort_id: 'trip_bull_per',
                                selected: thisSelected,
                                class: 'b2',
                                content: formatPer(data[i].trip_bull_per, '%')
                            });

                            // 5M
                            html += buildStatCol({
                                sort_id: 'm5',
                                selected: thisSelected,
                                class: 'b3',
                                content: data[i].m5
                            });

                            // 7M
                            html += buildStatCol({
                                sort_id: 'm7',
                                selected: thisSelected,
                                class: 'b4',
                                content: data[i].m7
                            });

                            // 9M
                            html += buildStatCol({
                                sort_id: 'm9',
                                selected: thisSelected,
                                class: 'b5',
                                content: data[i].m9
                            });
                            break;

                        case 3:
                            // 3 bulls
                            html += buildStatCol({
                                sort_id: 'bulls_3',
                                selected: thisSelected,
                                class: 'b1',
                                content: data[i].bulls_3
                            });

                            // 4 bulls
                            html += buildStatCol({
                                sort_id: 'bulls_4',
                                selected: thisSelected,
                                class: 'b2',
                                content: data[i].bulls_4
                            });

                            // 5 bulls
                            html += buildStatCol({
                                sort_id: 'bulls_5',
                                selected: thisSelected,
                                class: 'b3',
                                content: data[i].bulls_5
                            });

                            // 6 bulls
                            html += buildStatCol({
                                sort_id: 'bulls_6',
                                selected: thisSelected,
                                class: 'b4',
                                content: data[i].bulls_6
                            });

                            // Hat Tricks
                            html += buildStatCol({
                                sort_id: 'hat_tricks',
                                selected: thisSelected,
                                class: 'b5',
                                content: data[i].hat_tricks
                            });
                            break;

                        case 4:
                            // 3 bulls %
                            html += buildStatCol({
                                sort_id: 'bulls_3_per',
                                selected: thisSelected,
                                class: 'b1',
                                content: formatPer(data[i].bulls_3_per, '%')
                            });

                            // 4 bulls %
                            html += buildStatCol({
                                sort_id: 'bulls_4_per',
                                selected: thisSelected,
                                class: 'b2',
                                content: formatPer(data[i].bulls_4_per, '%')
                            });

                            // 5 bulls %
                            html += buildStatCol({
                                sort_id: 'bulls_5_per',
                                selected: thisSelected,
                                class: 'b3',
                                content: formatPer(data[i].bulls_5_per, '%')
                            });

                            // 6 bulls %
                            html += buildStatCol({
                                sort_id: 'bulls_6_per',
                                selected: thisSelected,
                                class: 'b4',
                                content: formatPer(data[i].bulls_6_per, '%')
                            });

                            // Hat Tricks %
                            html += buildStatCol({
                                sort_id: 'hat_tricks_per',
                                selected: thisSelected,
                                class: 'b5',
                                content: formatPer(data[i].hat_tricks_per, '%')
                            });
                            break;

                        case 5:
                            // Extended Counts
                            // 5M
                            html += buildStatCol({
                                sort_id: 'em5',
                                selected: thisSelected,
                                class: 'b1',
                                content: data[i].em5
                            });
                            //  6M
                            html += buildStatCol({
                                sort_id: 'em6',
                                selected: thisSelected,
                                class: 'b2',
                                content: data[i].em6
                            });
                            // 7M
                            html += buildStatCol({
                                sort_id: 'em7',
                                selected: thisSelected,
                                class: 'b3',
                                content: data[i].em7
                            });
                            // 8M
                            html += buildStatCol({
                                sort_id: 'em8',
                                selected: thisSelected,
                                class: 'b4',
                                content: data[i].em8
                            });
                            // 9M
                            html += buildStatCol({
                                sort_id: 'em9',
                                selected: thisSelected,
                                class: 'b5',
                                content: data[i].em9
                            });
                            break;

                        case 6:
                            // Team Name
                            html += buildStatCol({
                                sort_id: 'team_name',
                                selected: thisSelected,
                                class: 'b1-b3',
                                content: data[i].team_name
                            });

                            // Team Name
                            html += buildStatCol({
                                sort_id: 'sub_division',
                                selected: thisSelected,
                                class: 'b4-b5',
                                content: data[i].division
                            });
                            break;
                    }

                }

                if (((SETTINGS.event_type == 'T') && (LEADERBOARD.event_info.suppress_match_results == 'Y')) || (LEADERBOARD.suppress_player_3da == 'Y')) {
                    // Suppress data for active tournament

                    if (i == 0) {
                        html += buildStatCol({
                            sort_id: '',
                            selected: thisSelected,
                            class: 'sec3',
                            content: 'Results Pending *'
                        });
                    } else {
                        for (var col = 1; col <= 5; col++) {
                            html += buildStatCol({
                                sort_id: '',
                                selected: thisSelected,
                                class: 'c' + col,
                                content: '-'
                            });
                        }
                    }
                } else {

                    switch (SETTINGS.sec3_toggle) {
                        case 1:
                            // Player Record

                            switch (SETTINGS.event_type) {
                                case 'T':

                                    /*
			    					if (((LEADERBOARD.bracket_interface == 'None') || (!LEADERBOARD.bracket_interface))
										|| ((SETTINGS.event_id.substring(0, 2) == 't_') && (LEADERBOARD.pdc == 'N'))) {
									*/

                                    if (((LEADERBOARD.bracket_interface == 'None') || (!LEADERBOARD.bracket_interface))
                                        || ((SETTINGS.event_id.substring(0, 2) == 't_') && (LEADERBOARD.pdc == 'N') && (LEADERBOARD.tour_roster_type == 'T'))) {

                                        // Non-ProEvent
                                        if (LEADERBOARD.current_sort == 'matches') {
                                            if (data[i].member_id) {
                                                contentVal = '<span class="lblink-inv mp_ref" data-player_id="' + data[i].member_id + '" data-i="' + i + '">' + data[i].matches + '</span>';
                                            } else {
                                                contentVal = '<span class="lblink-inv mp_ref" data-player_id="' + data[i].email + '" data-i="' + i + '">' + data[i].matches + '</span>';
                                            }
                                        } else {
                                            if (data[i].member_id) {
                                                contentVal = '<span class="lblink mp_ref" data-player_id="' + data[i].member_id + '" data-i="' + i + '">' + data[i].matches + '</span>';
                                            } else {
                                                contentVal = '<span class="lblink mp_ref" data-player_id="' + data[i].email + '" data-i="' + i + '">' + data[i].matches + '</span>';
                                            }
                                        }

                                    } else {

                                        // Pro Event
                                        if (LEADERBOARD.current_sort == 'matches') {
                                            contentVal = '<span class="lblink-inv mp_ref" data-player_id="' + data[i].player_guid + '" data-i="' + i + '">' + data[i].matches + '</span>';
                                        } else {
                                            contentVal = '<span class="lblink mp_ref" data-player_id="' + data[i].player_guid + '" data-i="' + i + '">' + data[i].matches + '</span>';
                                        }
                                    }
                                    break;

                                case 'L':
                                    if (LEADERBOARD.current_sort == 'matches') {
                                        contentVal = '<span class="lblink-inv mp_ref" data-player_id="' + data[i].player_guid + '" data-i="' + i + '">' + data[i].matches + '</span>';
                                    } else {
                                        contentVal = '<span class="lblink mp_ref" data-player_id="' + data[i].player_guid + '" data-i="' + i + '">' + data[i].matches + '</span>';
                                    }
                                    break;

                                default:
                                    contentVal = data[i].matches;
                                    break;
                            }

                            // Match count
                            html += buildStatCol({
                                sort_id: 'matches',
                                selected: thisSelected,
                                class: 'c1',
                                content: contentVal
                            });

                            // Legs
                            html += buildStatCol({
                                sort_id: 'legs',
                                selected: thisSelected,
                                class: 'c2',
                                content: data[i].legs
                            });

                            // Win %
                            html += buildStatCol({
                                sort_id: 'winp',
                                selected: thisSelected,
                                class: 'c3',
                                content: formatPer(data[i].winp, '%')
                            });

                            // Op Xpr
                            html += buildStatCol({
                                sort_id: 'oppXpr',
                                selected: thisSelected,
                                class: 'c4',
                                content: data[i].oppXpr
                            });

                            // Finish/Division
                            if (SETTINGS.event_type == 'T') {
                                // Finish
                                html += buildStatCol({
                                    sort_id: 'finish',
                                    selected: thisSelected,
                                    class: 'c5',
                                    content: formatFinish(data[i].finish),
                                });
                            } else {
                                // Division
                                html += buildStatCol({
                                    sort_id: 'finish',
                                    selected: thisSelected,
                                    class: 'c5',
                                    content: cnull(data[i].rollup_number)
                                });
                            }
                            break;

                        case 2:
                            // Leg Start Record

                            // LC Leg Count
                            html += buildStatCol({
                                sort_id: 'legs',
                                selected: thisSelected,
                                class: 'c1',
                                content: data[i].legs
                            });

                            // LWD - Legs with darts
                            html += buildStatCol({
                                sort_id: 'withdarts_legs',
                                selected: thisSelected,
                                class: 'c2',
                                content: data[i].withdarts_legs
                            });

                            // LW% - Leg with darts win %
                            html += buildStatCol({
                                sort_id: 'withdarts_wins_per',
                                selected: thisSelected,
                                class: 'c3',
                                content: formatPer(data[i].withdarts_wins_per, '%')
                            });

                            // LAD - Legs against darts
                            html += buildStatCol({
                                sort_id: 'againstdarts_legs',
                                selected: thisSelected,
                                class: 'c4',
                                content: data[i].againstdarts_legs
                            });

                            // LW% - Leg against darts win  %
                            html += buildStatCol({
                                sort_id: 'againstdarts_wins_per',
                                selected: thisSelected,
                                class: 'c5',
                                content: formatPer(data[i].againstdarts_wins_per, '%')
                            });
                            break;

                        case 3:
                            // Overall Legs Record

                            // AMC - All Match Count
                            html += buildStatCol({
                                sort_id: 'all_matches',
                                selected: thisSelected,
                                class: 'c1',
                                content: data[i].all_matches
                            });

                            // ALC - All Legs Count
                            html += buildStatCol({
                                sort_id: 'all_legs',
                                selected: thisSelected,
                                class: 'c2',
                                content: data[i].all_legs
                            });

                            // ALW - All Leg Wins
                            html += buildStatCol({
                                sort_id: 'all_leg_wins',
                                selected: thisSelected,
                                class: 'c3',
                                content: data[i].all_leg_wins
                            });

                            // ALL - All Leg Loses
                            html += buildStatCol({
                                sort_id: 'all_leg_loses',
                                selected: thisSelected,
                                class: 'c4',
                                content: data[i].all_leg_loses
                            });

                            // ALW% - All Leg Wins %
                            html += buildStatCol({
                                sort_id: 'all_leg_wins_per',
                                selected: thisSelected,
                                class: 'c5',
                                content: formatPer(data[i].all_leg_wins_per, '%')
                            });
                            break;

                        case 4:
                            // Overall Sets Record

                            // ASC - All Sets Count
                            html += buildStatCol({
                                sort_id: 'all_sets',
                                selected: thisSelected,
                                class: 'c1',
                                content: data[i].all_sets
                            });

                            // ASW - All Set Wins
                            html += buildStatCol({
                                sort_id: 'all_set_wins',
                                selected: thisSelected,
                                class: 'c2',
                                content: data[i].all_set_wins
                            });

                            // ASL - All Set Loses
                            html += buildStatCol({
                                sort_id: 'all_set_loses',
                                selected: thisSelected,
                                class: 'c3',
                                content: data[i].all_set_loses
                            });


                            // AST - All Set Ties
                            html += buildStatCol({
                                sort_id: 'all_set_ties',
                                selected: thisSelected,
                                class: 'c4',
                                content: fmtStat(data[i].all_set_ties)
                            });

                            // ASW% - All Set Wins %
                            html += buildStatCol({
                                sort_id: 'all_set_wins_per',
                                selected: thisSelected,
                                class: 'c5',
                                content: formatPer(data[i].all_set_wins_per, '%')
                            });
                            break;

                        case 5:
                            if (SETTINGS.event_type == 'L') {
                                if (LEADERBOARD.event_info.league_type == 'TEAM') {
                                    // Team leagues
                                    html += buildStatCol({
                                        sort_id: 'team_name',
                                        selected: thisSelected,
                                        class: 'c1-c3',
                                        content: data[i].team_name
                                    });

                                    // Team Name
                                    html += buildStatCol({
                                        sort_id: 'sub_division',
                                        selected: thisSelected,
                                        class: 'c4-c5',
                                        content: data[i].division
                                    });
                                    break;
                                }
                            }

                            // Singles leagues and tournaments

                            // AMC - All Match Count
                            html += buildStatCol({
                                sort_id: 'all_matches',
                                selected: thisSelected,
                                class: 'c1',
                                content: data[i].all_matches
                            });

                            // AMW - All Match Wins
                            html += buildStatCol({
                                sort_id: 'all_match_wins',
                                selected: thisSelected,
                                class: 'c2',
                                content: data[i].all_match_wins
                            });

                            // AML - All Match Loses
                            html += buildStatCol({
                                sort_id: 'all_match_loses',
                                selected: thisSelected,
                                class: 'c3',
                                content: data[i].all_match_loses
                            });

                            // AMT - All Match Ties
                            html += buildStatCol({
                                sort_id: 'all_match_ties',
                                selected: thisSelected,
                                class: 'c4',
                                content: fmtStat(data[i].all_match_ties)
                            });

                            // AMW% - All Match Win %
                            html += buildStatCol({
                                sort_id: 'all_match_wins_per',
                                selected: thisSelected,
                                class: 'c5',
                                content: formatPer(data[i].all_match_wins_per, '%')
                            });
                            break;

                        case 6:
                            // Singles leagues have Divsions in toggle 5

                            // division
                            html += buildStatCol({
                                sort_id: 'team_name',
                                selected: thisSelected,
                                class: 'c1-c3',
                                content: data[i].team_name
                            });

                            // Sub division
                            html += buildStatCol({
                                sort_id: 'sub_division',
                                selected: thisSelected,
                                class: 'c4-c5',
                                content: data[i].division
                            });
                            break;

                    }
                }

            } else {

                // PERSONAL LEADERBOARD

                // Op DCA
                html += buildStatCol({
                    sort_id: 'op_dca',
                    selected: thisSelected,
                    class: 'a4-ml',
                    content: LEADERBOARD.member_level === 'P' ? data[i].op_dca : ICONS.lock(),
                });

                // Op Xpr
                var opXpr = positiveOrNegative(['op_xpr'], data[i].op_xpr, LEADERBOARD.all_op_xpr);

                if (LEADERBOARD.current_sort === 'op_dca') {
                    opXpr = positiveOrNegative(['op_dca'], data[i].op_xpr, data[i].op_dca);
                }

                html += buildStatCol({
                    sort_id: 'op_xpr',
                    selected: thisSelected,
                    class: 'b1-ml',
                    content: opXpr,
                });

                if (SETTINGS.game_filter_vals.game_type == '01') {
                    // OP F9
                    html += buildStatCol({
                        sort_id: 'first_nine',
                        selected: thisSelected,
                        class: 'b2-ml',
                        content: positiveOrNegative(['first_nine'], dispDecStat(data[i].first_nine), dispDecStat(LEADERBOARD.all_op_firstnine)),
                    });

                    // OP Avg Finish
                    html += buildStatCol({
                        sort_id: 'avg_finish',
                        selected: thisSelected,
                        class: 'b3-ml',
                        content: positiveOrNegative(['avg_finish'], dispDecStat(data[i].avg_finish), dispDecStat(LEADERBOARD.all_op_avgfinish)),
                    });
                } else {
                    // OP Miss %
                    var contentOpMissVal;
                    var contentMyMissVal;
                    if (data[i].targ_per) {
                        contentOpMissVal = 1 - data[i].targ_per;
                    } else {
                        contentOpMissVal = '';
                    }

                    if (data[i].mytarg_per) {
                        contentMyMissVal = 1 - data[i].mytarg_per;
                    } else {
                        contentMyMissVal = '';
                    }

                    html += buildStatCol({
                        sort_id: 'first_nine',
                        selected: thisSelected,
                        class: 'b2-ml',
                        content: positiveOrNegative(['first_nine'], contentOpMissVal, LEADERBOARD.all_op_miss, 'formatMissPer'),
                    });

                    // OP Trip Bull %
                    html += buildStatCol({
                        sort_id: 'avg_finish',
                        selected: thisSelected,
                        class: 'b3-ml',
                        content: positiveOrNegative(['avg_finish'], data[i].trip_bull_per, LEADERBOARD.all_op_tripbull_per, 'formatMissPer'),
                    });
                }

                // Xpr
                html += buildStatCol({
                    sort_id: 'xpr',
                    selected: thisSelected,
                    class: 'c1-ml',
                    content: positiveOrNegative(['xpr', 'matches', 'legs'], data[i].xpr, LEADERBOARD.my_dca),
                });

                if (SETTINGS.game_filter_vals.game_type == '01') {
                    // F9
                    html += buildStatCol({
                        sort_id: 'myfirst_nine',
                        selected: thisSelected,
                        class: 'c2-ml',
                        content: positiveOrNegative(['myfirst_nine'], dispDecStat(data[i].myfirst_nine), dispDecStat(LEADERBOARD.all_my_firstnine)),
                    });

                    // Avg Finish
                    html += buildStatCol({
                        sort_id: 'myavg_finish',
                        selected: thisSelected,
                        class: 'c3-ml',
                        content: positiveOrNegative(['myavg_finish'], dispDecStat(data[i].myavg_finish), dispDecStat(LEADERBOARD.all_my_avgfinish)),
                    });

                } else {
                    // -- CRICKET --
                    // Miss %
                    html += buildStatCol({
                        sort_id: 'myfirst_nine',
                        selected: thisSelected,
                        class: 'c2-ml',
                        content: positiveOrNegative(['myfirst_nine'], contentMyMissVal, LEADERBOARD.all_my_miss, 'formatMissPer'),
                    });

                    // Trip-Bull %
                    html += buildStatCol({
                        sort_id: 'myavg_finish',
                        selected: thisSelected,
                        class: 'c3-ml',
                        content: positiveOrNegative(['myavg_finish'], data[i].mytrip_bull_per, LEADERBOARD.all_my_tripbull_per, 'formatMissPer'),
                    });
                }

                // Match count

                if (LEADERBOARD.current_sort == 'matches') {
                    contentVal = '<span class="lblink-inv" data-player_id="' + data[i].member_id + '" data-i="' + i + '">' + data[i].matches + '</span>';
                } else {
                    contentVal = '<span class="lblink" data-player_id="' + data[i].member_id + '" data-i="' + i + '">' + data[i].matches + '</span>';
                }

                html += buildStatCol({
                    sort_id: 'matches',
                    selected: thisSelected,
                    class: 'd1-ml',
                    content: contentVal,
                });

                // Legs
                html += buildStatCol({
                    sort_id: 'legs',
                    selected: thisSelected,
                    class: 'd2-ml',
                    content: LEADERBOARD.member_level === 'P' ? data[i].legs : ICONS.lock(),
                });

                // Win %
                html += buildStatCol({
                    sort_id: 'winp',
                    selected: thisSelected,
                    class: 'd3-ml',
                    content: legWinPostiveOrNegative(['winp', 'matches', 'legs'], data[i].winp),
                });

                // HC
                html += buildStatCol({
                    sort_id: 'hc',
                    selected: thisSelected,
                    class: 'd4-ml',
                    content: LEADERBOARD.member_level === 'P' ? formatHC(data[i].myhc_legs) : ICONS.lock(),
                });

            }

        }

        html += '</tr>';

        if (data.length > 0) {
            SCROLL.rows = $('table.scroll.outer tbody tr').length - 2; // -2 to remove header rows
        }

        if (LEADERBOARD.current_sort == 'country') {
            $('.flagsort-count').html(countryCount);
            $('.flagsort-holder').show();
            $('.flagsort .flagsort-flag').hide();
        }

        $('#explain-columns').click(function () {
            const bluesection = $(".thead_sections.bluesection").height();
            const columnlabelrow = $(".column_label_row").height();

            $('html, body').animate({
                scrollTop: $('.legend_container').offset().top - bluesection - columnlabelrow
            }, 500, function () {
                $('.legend_container').css('overflow', 'hidden');

                const element = document.querySelector('.legend_container');
                element.classList.add('animate__animated', 'animate__pulse');

                element.addEventListener('animationend', () => {
                    $('.legend_container').css('overflow', 'auto');
                    element.classList.remove('animate__animated', 'animate__pulse');
                });
            });
        });

        function buildStatCol(info) {
            var thisClass;
            var thisStyle = '';
            var custom_styles = [];
            var colspan = '';

            var secSrt = '#C4D8EB';
            var secSrtHi = '#d0e4f0';

            var secSrtDflt = '#4f6a84';
            var secSrtDfltFont = '#eee';

            var ss;

            if (info.selected) {
                ss = secSrtHi;
            } else {
                ss = secSrt;
            }

            switch (info.class) {
                case 'b4-b5':
                    colspan = ' colspan="2"';
                    break;
                case 'b1-b2':
                    colspan = ' colspan="2"';
                    break;
                case 'b3-b5':
                    colspan = ' colspan="3"';
                    break;
                case 'b1-b3':
                    colspan = ' colspan="3"';
                    break;
                case 'b4-b5':
                    colspan = ' colspan="2"';
                    break;
            }

            if ((LEADERBOARD.current_sort == info.sort_id) && info.selected) {
                custom_styles.push({attr: 'background-color', style: '#25435f'});
            }

            if (LEADERBOARD.current_sort == info.sort_id) {
                if (info.class != 'a2b') {
                    thisClass = ' hilight';
                } else {
                    thisClass = ' hilight'; // Do no hilight nation flag col when sorted
                }
            } else {
                thisClass = '';

                switch (LEADERBOARD.current_sort) {
                    case 'country':
                        if (info.class == 'a2b') {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'xpr':
                        if (info.class == 'b1-ml') {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'op_xpr':
                        if (info.class == 'c1-ml') {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        // if (info.class == 'c1-ml') {
                        //     custom_styles.push({attr: 'background-color', style: '#4f6a84'});
                        //     custom_styles.push({attr: 'color', style: '#fff'});
                        // }
                        // if (info.class == 'b4-ml') {
                        //     custom_styles.push({attr: 'background-color', style: '#4f6a84'});
                        //     custom_styles.push({attr: 'color', style: '#fff'});
                        // }
                        break;
                    case 'myfirst_nine':
                        if (info.class == 'b2-ml') {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'first_nine':
                        if ((info.class == 'c2-ml') || ((info.class == 'b2') && (SETTINGS.game_filter_vals.game_type == '01') && (SETTINGS.sec2_toggle >= 1) && (SETTINGS.sec2_toggle <= 4))) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'myavg_finish':
                        if (info.class == 'b3-ml') {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'avg_finish':
                        if ((info.class == 'c3-ml') || ((info.class == 'b1') && (SETTINGS.game_filter_vals.game_type == '01') && (SETTINGS.sec2_toggle >= 1) && (SETTINGS.sec2_toggle <= 4))) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;

                    case 'legs':
                        if ((SETTINGS.event_type == 'P') && (info.class == 'd3-ml')) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'winp':
                        if ((SETTINGS.event_type == 'P') && (info.class == 'd2-ml')) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        if ((info.class == 'c4') && (SETTINGS.sec3_toggle == 1)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;

                    case 'op_dca':
                        if (info.class == 'b1-ml') {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        // if (info.class == 'c1-ml') {
                        //     custom_styles.push({attr: 'background-color', style: ss});
                        //     custom_styles.push({attr: 'color', style: '#4b4c42'});
                        // }
                        break;

                    case 'targ_per':
                        if ((info.class == 'b2') && ((SETTINGS.sec2_toggle == 1) || (SETTINGS.sec2_toggle == 2))) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'trip_bull_per':
                        if ((info.class == 'b1') && ((SETTINGS.sec2_toggle == 1) || (SETTINGS.sec2_toggle == 2))) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;

                    case 'winp':
                        if ((info.class == 'c4') && (SETTINGS.sec3_toggle == 1)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'oppXpr':
                        if ((info.class == 'c3') && (SETTINGS.sec3_toggle == 1)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;

                    case 'withdarts_legs':
                        if ((info.class == 'c3') && (SETTINGS.sec3_toggle == 2)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'withdarts_wins_per':
                        if ((info.class == 'c2') && (SETTINGS.sec3_toggle == 2)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'againstdarts_legs':
                        if ((info.class == 'c5') && (SETTINGS.sec3_toggle == 2)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'againstdarts_wins_per':
                        if ((info.class == 'c4') && (SETTINGS.sec3_toggle == 2)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;

                    case 'all_legs':
                        if ((info.class == 'c5') && (SETTINGS.sec3_toggle == 3)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;

                    case 'all_leg_wins_per':
                        /*
	        			if ((info.class == 'c1') && (SETTINGS.sec3_toggle == 3)) {
	        				custom_styles.push({attr: 'background-color', style: ss});
	        			}
	        			*/
                        break;

                    case 'all_leg_wins':
                        if ((info.class == 'c4') && (SETTINGS.sec3_toggle == 3)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'all_leg_loses':
                        if ((info.class == 'c3') && (SETTINGS.sec3_toggle == 3)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;

                    case 'all_sets':
                        if ((info.class == 'c5') && (SETTINGS.sec3_toggle == 4)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'all_set_wins_per':
                        if ((info.class == 'c1') && (SETTINGS.sec3_toggle == 4)) {
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                            custom_styles.push({attr: 'background-color', style: ss});
                        }
                        break;
                    case 'all_set_wins':
                        if (((info.class == 'c3') || (info.class == 'c4')) && (SETTINGS.sec3_toggle == 4)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'all_set_loses':
                        if (((info.class == 'c2') || (info.class == 'c4')) && (SETTINGS.sec3_toggle == 4)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'all_set_ties':
                        if (((info.class == 'c2') || (info.class == 'c3')) && (SETTINGS.sec3_toggle == 4)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;

                    case 'all_matches':
                        if ((info.class == 'c5') && (SETTINGS.sec3_toggle == 5)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'all_match_wins_per':
                        if ((info.class == 'c1') && (SETTINGS.sec3_toggle == 5)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'all_match_wins':
                        if (((info.class == 'c3') || (info.class == 'c4')) && (SETTINGS.sec3_toggle == 5)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'all_match_loses':
                        if (((info.class == 'c2') || (info.class == 'c4')) && (SETTINGS.sec3_toggle == 5)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'all_match_ties':
                        if (((info.class == 'c2') || (info.class == 'c3')) && (SETTINGS.sec3_toggle == 5)) {
                            custom_styles.push({attr: 'background-color', style: ss});
                            custom_styles.push({attr: 'color', style: '#4b4c42'});
                        }
                        break;
                    case 'coe':
                        if (((info.class == 'b2') || (info.class == 'b3 frac')) && (SETTINGS.sec2_toggle == 7)) {
                            custom_styles.push({attr: 'background-color', style: secSrtDflt});
                            custom_styles.push({attr: 'color', style: secSrtDfltFont});
                        }
                        break;
                    case 'co_perc':
                        if (((info.class == 'b4') || (info.class == 'b5 frac')) && (SETTINGS.sec2_toggle == 7)) {
                            custom_styles.push({attr: 'background-color', style: secSrtDflt});
                            custom_styles.push({attr: 'color', style: secSrtDfltFont});
                        }
                        break;

                }

            }

            if (info.content == 'Results Pending *') {
                custom_styles.push({attr: 'color', style: '#d00 !important'});
                custom_styles.push({attr: 'font-style', style: 'italic !important'});
            }

            if (custom_styles.length > 0) {
                thisStyle = ' style="';
                for (var i = 0; i < custom_styles.length; i++) {
                    thisStyle += custom_styles[i].attr + ':' + custom_styles[i].style + ';';
                }
                thisStyle += '"';
            }

            if ((info.content === undefined) || (info.content === null)) {
                info.content = '';
            }

            if ((info.class == 'a3') || (info.class == 'a3-ml')) {
                if (LEADERBOARD.current_sort == 'last_name') {
                    thisClass += ' lblink-inv';
                } else {
                    thisClass += ' lblink';
                }

                if (SETTINGS.event_type === 'P' && LEADERBOARD.member_level !== 'P') {
                    return '<td' + colspan + thisStyle + ' class="' + info.class + thisClass + ' tooltip">' + info.content + '<span class="flex flex-col tooltip-text bg-blue-200 leading-tight px-3 py-2 rounded" style="text-shadow: none;"><span>Unlock to view Performance Graph</span><a href="https://www.dartconnect.com/how-to/#renew-extend-subscription" target="_blank">Learn How</a></span></span></td>';
                }
            }


            return '<td' + colspan + thisStyle + ' class="' + info.class + thisClass + '">' + info.content + '</td>';
        }

        // Other players (guests and label players)
        if (otherPlayers) {
            otherPlayerCount = otherPlayers.length;

            if (otherPlayerCount) {
                html += AD_ROW2;
                html += '<tr class="end_selected_players" colspan="15"><td align="center" style="width: 100%;"><h3>Non-Member Opponents:</h3></td></tr>';
            }

            for (var i = 0; i < otherPlayerCount; i++) {

                // Inject Ad
                if ((ext_rank == 11) && (!group_pos_ad)) {
                    html += AD_ROW;
                    rendered_ad_row = true;
                }

                html += '<tr class="inactive"><td class="a1-ml"></td>';

                switch (LEADERBOARD.current_sort) {
                    case 'last_name':
                    case 'selected_players':
                    case 'matches':
                    case 'legs':
                        html += '<td class="a2-ml"></td>';
                        break;
                    default:
                        html += '<td class="a2-ml">' + ext_rank + '</td>';
                        break;
                }

                html += '<td class="a2b-ml"></td>';
                // html += '<td class="a3-ml">' + otherPlayers[i].last_name + ', ' + otherPlayers[i].first_name.charAt(0) + '</td>';

                html += '<td class="a3-ml">' + otherPlayers[i].last_name + ', ' + otherPlayers[i].first_name.charAt(0) + '<span>' + otherPlayers[i].first_name.substring(1) + '</span></td>';

                html += '<td class="b1-ml"></td><td class="b2-ml"></td><td class="b3-ml"></td><td class="b4-ml"></td>';
                html += '<td class="c1-ml"></td><td class="c2-ml"></td><td class="c3-ml"></td>';

                /*
		        if (otherPlayers[i].email == 'Y') {
		        	html += '<a href="#">Send<span class="ext_text"> Invite</span></a>';
		        } else {
		        	html += '<h3>Missing Email</h3>';
		        }
		        */

                html += '<td class="d1-ml">' + otherPlayers[i].matches + '</td>';
                html += '<td class="d2-ml">' + otherPlayers[i].legs + '</td>';
                html += '<td class="d3-ml"></td>';
                html += '<td class="d4-ml"></td></tr>';
                ext_rank += 1;
            }
        } else {
            otherPlayerCount = 0;
        }

        // Inject Ad
        if (!rendered_ad_row) {
            if (parseInt(otherPlayerCount) + parseInt(data.length) > 0) {
                html += '<tr class="end_selected_players"><td colspan="15" align="left" style="width: 100%;"></td></tr>';
            } else {
                if (SETTINGS.filterCount()) {
                    html += '<tr class="no_results_found"><td colspan="15" align="center" style="width: 100%; text-align: center;"><div><h2>No Matches Found</h2><p>Unfortunately, we do not have any match history for ' + LEADERBOARD.event_info.first_name + ' with these filter settings.</p><div class="reset_home_filters">Reset Filters<span class="filterCnt"></span></div></div></td></tr>';
                } else {
                    html += '<tr class="no_results_found"><td colspan="15" align="center" style="width: 100%; text-align: center;"><div class="max-w-xl mx-auto"><h2>No Matches Found</h2><p>Unfortunately, we do not have any match history for ' + LEADERBOARD.event_info.first_name + '.</p><p>When using DartConnect, be sure to select yourself and an opponent from your player library in the scoring application. We will track & display your performance history for all opponents. <a href="https://www.dartconnect.com/how-to/#managing-connections" target="_blank" style="color: #a61210;">Learn More</a></p></div></td></tr>';
                }
            }
            html += AD_ROW;
        }

        // render html

        if (LEADERBOARD.current_sort == 'country') {
            $(table_container_id + ' table tbody').addClass('allwhite');
        } else {
            $(table_container_id + ' table tbody').removeClass('allwhite');
        }

        $(table_container_id + ' table tbody').html(html);


        $('.kiosk_label').css('left', KIOSK_FILTER.left + 'px');
        $('.kiosk_label').css('visibility', KIOSK_FILTER.kiosk_label);

        $('.kiosk_label').click(function () {
            KIOSK_FILTER.clearFilter();
        });

        /*
		setTimeout(function() {
			// Set static accordion help label
			var offset = $('.mp_ref').offset();
			if (offset) {
				$('#mp_label').css('left', (offset.left - 72) + 'px');
				$('#mp_label').fadeIn(250);
			}
		}, 500);
		*/

        // Match count handler
        $('td.c1 span, td.d1-ml span').click(function () {

            if (LEADERBOARD.suppress_player_3da == 'Y') {
                alert(suppress_3da_msg);
                return;
            }

            if (SETTINGS.event_type === 'P' && LEADERBOARD.member_level !== 'P') {
                return;
            }

            var player_id = $(this).data('player_id');
            var player_index = $(this).data('i');

            if ((LEADERBOARD.last_state.accordion_open) && (LEADERBOARD.last_state.row_player_id == player_id)) {
                closeMatchAccordion();
                return;
            }

            plr(player_id, player_index, $(this).closest('tr'));
        });

        // Player name opens graph accordion
        $('td.a3 span.lblink, td.a3 span.lblink-inv').click(function () {

            if (LEADERBOARD.suppress_player_3da == 'Y') {
                alert(suppress_3da_msg);
                return;
            }

            if (SETTINGS.event_type === 'P' && LEADERBOARD.member_level !== 'P') {
                return;
            }

            var player_id = $(this).data('player_id');
            var player_index = $(this).data('i');

            if ((LEADERBOARD.last_state.accordion_open) && (LEADERBOARD.last_state.row_player_id == player_id)) {
                closeMatchAccordion();
                return;
            }

            // $(this).closest('tr').animate({scrollTop: 0}, 2000);

            plr(player_id, player_index, $(this).closest('tr'));
        });

        /*
		$('td.a3').click(function() {
			var thisTd = $(this).closest('tr').find('span.mp_ref');
			var player_id = thisTd.data('player_id');
			var player_index = thisTd.data('i');

			if ((LEADERBOARD.last_state.accordion_open) && (LEADERBOARD.last_state.row_player_id == player_id)) {
				closeMatchAccordion();
				return;
			}

			plr(player_id, player_index, $(this).closest('tr'));
		});
		*/

        $('td.a3-ml').click(function () {
            if (SETTINGS.event_type === 'P' && LEADERBOARD.member_level !== 'P') {
                return;
            }

            var thisTd = $(this).closest('tr').find('td.d1-ml span');
            var player_id = thisTd.data('player_id');
            var player_index = thisTd.data('i');

            if ((LEADERBOARD.last_state.accordion_open) && (LEADERBOARD.last_state.row_player_id == player_id)) {
                closeMatchAccordion();
                return;
            }

            plr(player_id, player_index, $(this).closest('tr'));
        });


        // Select player toggle handler
        $('.select_player').click(function (event) {
            event.preventDefault();

            if (SETTINGS.event_type === 'P' && LEADERBOARD.member_level !== 'P') {
                return;
            }

            // Toggle player selection
            var playerCompVal = $(this).data('id');

            if (playerCompVal == null) {
                return false;
            }

            var found = false;

            for (var sp = 0; sp < LEADERBOARD.selected_players[SETTINGS.event_type].length; sp++) {
                if (LEADERBOARD.selected_players[SETTINGS.event_type][sp] == playerCompVal) {
                    found = true;
                    LEADERBOARD.selected_players[SETTINGS.event_type].splice(sp, 1);
                    break;
                }
            }

            if (found) {
                $(this).closest('tr').removeClass('selected_player');
                $(this).find('.checked').hide();
                $(this).find('.unchecked').show();

                // Retain sort highlight
                $(this).closest('tr').find('.' + LEADERBOARD.sortMap(LEADERBOARD.current_sort)).css('background-color', '#4f6a84');

            } else {
                // Augment sort hilight for selected player
                $(this).closest('tr').find('.' + LEADERBOARD.sortMap(LEADERBOARD.current_sort)).css('background-color', '#25435f');

                $(this).find('.checked').show();
                $(this).find('.unchecked').hide();

                LEADERBOARD.selected_players[SETTINGS.event_type].push(playerCompVal);
                $(this).closest('tr').addClass('selected_player');
            }


            if (LEADERBOARD.selected_players[SETTINGS.event_type].length > 0) {
                $('.clearMarkedBtn').show();
                $('.toggleMarkedPlayers').show();
            } else {
                $('.clearMarkedBtn').hide();
                $('.toggleMarkedPlayers').hide();
            }
            LEADERBOARD.saveSelectedPlayers();


        });

        if ((LEADERBOARD.selected_players[SETTINGS.event_type].length > 0) && found_selected_player) {
            $('.clearMarkedBtn').show();
            $('.toggleMarkedPlayers').show();
        } else {
            $('.clearMarkedBtn').hide();
            if (LEADERBOARD.peg_selected_players) {
                $('.toggleMarkedPlayers').show();
            } else {
                $('.toggleMarkedPlayers').hide();
            }
        }

        $('.filterCnt').html('(' + SETTINGS.filterCount() + ')');

        // Deal with state / potential nav from back button
        if (LEADERBOARD.last_state.accordion_open) {

            if ((LEADERBOARD.last_state.event_type == SETTINGS.event_type) && (LEADERBOARD.last_state.event_id == SETTINGS.event_id)) {
                // User is on same leaderboard they last viewed

                var player_id = LEADERBOARD.last_state.row_player_id;
                var thisPlayer;

                if (SETTINGS.event_type == 'P') {
                    thisPlayer = $('.d1-ml').find("[data-player_id='" + player_id + "']");
                } else {
                    thisPlayer = $('.c1').find("[data-player_id='" + player_id + "']");
                }

                var thisRow = thisPlayer.closest('tr');
                var player_index = thisPlayer.data('i');

                // Open player match accordion
                plr(player_id, player_index, thisRow, 'doScroll');

            } else {
                // User has moved on to a different leaderboard
                LEADERBOARD.clearLastState();
                LEADERBOARD.saveLastState();
            }

        }

        if (callback) {
            callback();
        } else {

            // reset menu handlers
            $('.mobile-menus nav ul ul li a').off('click');

            $('.mobile-menus nav ul ul li a').click(function (event) {
                event.preventDefault();
                SETTINGS.handlePrimaryMenuClick(event, $(this));
            });

            if (SETTINGS.event_type == 'L') {
                // reload division menu
                $('#menu_finish').next('div').find('li').off('click');

                $('#menu_finish').next('div').find('li').click(function (event) {
                    event.preventDefault();
                    SETTINGS.handleMenuClick(event, $(this));
                });
            }

        }

    },


    initMenus: function (reloadHandlers) {
        // Set current menu labels
        var menu_html = '';
        var leagueIdParts;
        var displayText;
        var dca_text;
        var submenu_class;
        var screenWidth = $(window).width();

        var unit;
        if (SETTINGS.game_filter_vals.game_type == '01') {
            unit = 'Ton';
        } else {
            unit = 'Mark';
        }

        $('#gameTypeLabel p').html(SETTINGS.game_name_text); // Filter menu page label

        // var headline_coda = '&nbsp;•&nbsp;<span class="headline-coda">' + truncateText(LEADERBOARD.event_info.dctv_title, 24) + '</span>';
        var headline_coda = '<span class="headline-coda">' + LEADERBOARD.event_info.dctv_title + '</span>';

        switch (SETTINGS.event_type) {

            case 'T':
                menu_html = '<li><a class="finish_menu" name="all">All Players</a></li>';
                menu_html += '<li><a class="finish_menu" name="t2">Top 2</a></li>';
                menu_html += '<li><a class="finish_menu" name="t4">Top 4</a></li>';
                menu_html += '<li><a class="finish_menu" name="t8">Top 8</a></li>';
                menu_html += '<li><a class="finish_menu" name="t16">Top 16</a></li>';
                menu_html += '<li><a class="finish_menu" name="t32">Top 32</a></li>';
                // $('#menu_finish ul').html(menu_html);
                $('#menu_finish').next('div').find('ul').html(menu_html);

                switch (SETTINGS.finish) {
                    case 'all':
                        $('#menu_finish h2').html('All Players');
                        break;
                    case 't2':
                        $('#menu_finish h2').html('Top 2');
                        break;
                    case 't4':
                        $('#menu_finish h2').html('Top 4');
                        break;
                    case 't8':
                        $('#menu_finish h2').html('Top 8');
                        break;
                    case 't16':
                        $('#menu_finish h2').html('Top 16');
                        break;
                    case 't32':
                        $('#menu_finish h2').html('Top 32');
                        break;
                    default:
                        $('#menu_finish h2').html(SETTINGS.finish);
                        break;
                }
                $('.finish_menu[name="' + SETTINGS.finish + '"]').addClass('selected_filterbutton');

                if (LEADERBOARD.bracket_interface != 'None') {

                    $('.what').css('padding-top', '0');
                    $('.what').css('padding-left', '8px');

                    $('#menu_season span').html('Event List');
                    $('.what').html('A Digital Steel Event');

                    menu_html = '';


                    menu_html += '<li style="font-weight: bold;"><a class="season_menu" name="all">- All Events -</a></li>';

                    /*
					if (SETTINGS.event_id.substring(0, 2) == 't_') {
						menu_html += '<li><a class="season_menu" name="all">All Events</a></li>';
					} else {
						menu_html += '<li><a class="season_menu" name="all">All Darts</a></li>';
					}
					*/


                    for (var i = 0; i < LEADERBOARD.eventList.length; i++) {
                        if (LEADERBOARD.eventList[i].lb_game_link) {
                            menu_html += '<li><a class="season_menu" name="' + LEADERBOARD.eventList[i].id + '">' + LEADERBOARD.eventList[i].event_label + '</a></li>';
                        }

                        if (String(LEADERBOARD.eventList[i].id) == String(SETTINGS.range)) {
                            if (LEADERBOARD.eventList[i].gametype_count > 1) {
                                LEADERBOARD.event_headline = LEADERBOARD.eventList[i].event_label + '&nbsp;&nbsp;•&nbsp;&nbsp;' + LEADERBOARD.current_game_desc + headline_coda;
                            } else {
                                LEADERBOARD.event_headline = LEADERBOARD.eventList[i].event_label + headline_coda;
                            }
                            $('#showcard_subtitle').val(LEADERBOARD.eventList[i].event_label);
                        }

                        /*
                        if (LEADERBOARD.eventList[i].display_results == 'N') {
                            LEADERBOARD.suppress_player_3da = 'Y';
                        }
                        */
                    }

                    if (LEADERBOARD.event_info.tour_id && LEADERBOARD.event_info.tour_lb_link) {
                        menu_html += '<li id="tourReturnLnk"><a class="season_menu" name="t-t_' + LEADERBOARD.event_info.tour_id + '-' + LEADERBOARD.event_info.tour_lb_link + '-all-all-all-all-all">&lt; ' + LEADERBOARD.event_info.tour_name + '</a></li>';
                    }

                    if (SETTINGS.event_id.substring(0, 2) == 't_') {
                        LEADERBOARD.event_headline = "Tour Leaderboard";
                    }

                    if (SETTINGS.range == 'all') {
                        // $('.what').html('All Darts : ' + LEADERBOARD.current_game_desc);
                        LEADERBOARD.event_headline = 'All Events&nbsp;&nbsp;•&nbsp;&nbsp;' + LEADERBOARD.current_game_desc + headline_coda
                    }

                    $('#menu_season ul').html(menu_html);
                    $('.season_menu[name="' + SETTINGS.range + '"]').addClass('selected_filterbutton');

                } else {

                    menu_html = '<li><a class="season_menu" name="tournament">Event Darts</a></li>';

                    $('#showcard_subtitle').val(LEADERBOARD.event_info.tour_name);

                    // menu_html = '<li><a class="season_menu" name="tournament">Tournament</a></li>';

                    /*
					if (!((SETTINGS.event_id == 'a_pdc2017') || (SETTINGS.event_id == 'a_napowerindex2018'))) {
						menu_html += '<li><a class="season_menu" name="women">Women\'s Event</a></li>';
						menu_html += '<li><a class="season_menu" name="side">Side Match</a></li>';
						menu_html += '<li><a class="season_menu" name="youth">Youth Event</a></li>';
						menu_html += '<li><a class="season_menu" name="all">All Darts</a></li>';
					}
					*/

                    $('#menu_season ul').html(menu_html);
                    $('.season_menu[name="' + SETTINGS.range + '"]').addClass('selected_filterbutton');

                    $('#menu_season span').html('Event Type'); // Default
                    // $('.what').html('All Tournaments'); // Default
                    // LEADERBOARD.event_headline = 'All Tournaments';

                    $('.what').html('Event Darts'); // Default
                    // LEADERBOARD.event_headline = 'Event Darts';
                    LEADERBOARD.event_headline = LEADERBOARD.current_game_desc + headline_coda;

                    /*
					switch(SETTINGS.range) {
						case 'all':
							$('#settingTypeLabel p').html('All Event Types');
							$('.what').html('All Darts : ' + LEADERBOARD.current_game_desc);
							LEADERBOARD.event_headline = 'All Darts&nbsp;&nbsp;•&nbsp;&nbsp;' + LEADERBOARD.current_game_desc + headline_coda;
							break;
						case 'tournament':
							$('#settingTypeLabel p').html('Tournaments');
							$('.what').html('Tournament&nbsp;&nbsp;•&nbsp;&nbsp;' + LEADERBOARD.current_game_desc);
							LEADERBOARD.event_headline = 'Tournament&nbsp;&nbsp;•&nbsp;&nbsp;' + LEADERBOARD.current_game_desc + headline_coda;
							break;
						case 'women':
							$('#settingTypeLabel p').html('Women');
							$('.what').html('Women\'s Event&nbsp;&nbsp;•&nbsp;&nbsp;' + LEADERBOARD.current_game_desc);
							LEADERBOARD.event_headline = 'Women\'s Event&nbsp;&nbsp;•&nbsp;&nbsp;' + LEADERBOARD.current_game_desc + headline_coda;
							break;
						case 'side':
							$('#settingTypeLabel p').html('Side Matches');
							$('.what').html('Side Match&nbsp;&nbsp;•&nbsp;&nbsp;' + LEADERBOARD.current_game_desc);
							LEADERBOARD.event_headline = 'Side Match&nbsp;&nbsp;•&nbsp;&nbsp;' + LEADERBOARD.current_game_desc + headline_coda;
							break;
						case 'youth':
							$('#settingTypeLabel p').html('Youth');
							$('.what').html('Youth Event&nbsp;&nbsp;•&nbsp;&nbsp;' + LEADERBOARD.current_game_desc);
							LEADERBOARD.event_headline = 'Youth Event&nbsp;&nbsp;•&nbsp;&nbsp;' + LEADERBOARD.current_game_desc + headline_coda;
							break;
					}
					*/

                }


                break;

            case 'L':

                displayText = '';

                // Show Rollup Divisions menu in primary season_menu menu
                if (SETTINGS.finish == 'all') {
                    menu_html = '<li><a class="season_menu selected_filterbutton" name="all">All Divisions</a></li>';
                    displayText += 'All Divisions&nbsp;&nbsp;•&nbsp;&nbsp;';
                } else {
                    menu_html = '<li><a class="season_menu" name="all">All Divisions</a></li>';
                }

                for (var m = 0; m < LEADERBOARD.rollupMenu.length; m++) {

                    if (LEADERBOARD.rollupMenu[m].id == SETTINGS.finish) {
                        menu_html += '<li><a class="season_menu selected_filterbutton" name="' + LEADERBOARD.rollupMenu[m].id + '">' + LEADERBOARD.rollupMenu[m].rollup_number + '. ' + LEADERBOARD.rollupMenu[m].rollup + ' Div</a></li>';
                        displayText += LEADERBOARD.rollupMenu[m].rollup_number + '. ' + LEADERBOARD.rollupMenu[m].rollup + ' Division&nbsp;&nbsp;•&nbsp;&nbsp;';
                    } else {
                        menu_html += '<li><a class="season_menu" name="' + LEADERBOARD.rollupMenu[m].id + '">' + LEADERBOARD.rollupMenu[m].rollup_number + '. ' + LEADERBOARD.rollupMenu[m].rollup + ' Div</a></li>';
                    }

                }
                $('#menu_season span').html('Division'); // Label
                $('#menu_season ul').html(menu_html);

                if ((LEADERBOARD.rollupMenu.length > 5) && (screenWidth <= 700)) {
                    $('#menu_season ul').css('width', (screenWidth - 24) + 'px');
                }


                // Show season filter menu
                leagueIdParts = SETTINGS.event_id.split('_');
                if (leagueIdParts.length == 3) {

                    $('#menu_finish h2').html('Full Season'); // Default
                    $('#menu_finish h3').html('Season:');

                    switch (leagueIdParts[2]) {
                        case 'reg':
                            $('#menu_finish h2').html('Regular Season');
                            break
                        case 'post':
                            $('#menu_finish h2').html('Post Season');
                            break;
                        case 'all':
                            $('#menu_finish h2').html('Full Season');
                            break;
                        default:
                            location.replace('/');
                            // Bad URL
                            return;
                    }

                    menu_html = '<li><a class="finish_menu" name="all">Full Season</a></li>';
                    menu_html += '<li><a class="finish_menu" name="reg">Regular Season</a></li>';
                    menu_html += '<li><a class="finish_menu" name="post">Post Season</a></li>';

                    $('#menu_finish').next('div').find('ul').html(menu_html);
                    $('.finish_menu[name="' + leagueIdParts[2] + '"]').addClass('selected_filterbutton');
                }


                // Show sub divisions filter menu
                menu_html = '<li><a class="div_menu" name="all">All</a></li>';

                if (SETTINGS.range == 'all') {
                    $('#menu_div h2').html('All Sub Divisions');
                    displayText += 'All Sub Divisions&nbsp;&nbsp;•&nbsp;&nbsp;';
                }

                for (var i = 0; i < LEADERBOARD.divisions.length; i++) {
                    menu_html += '<li><a class="div_menu" name="' + LEADERBOARD.divisions[i].id + '">' + LEADERBOARD.divisions[i].division + '</a></li>';
                    if (LEADERBOARD.divisions[i].id == SETTINGS.range) {
                        $('#menu_div h2').html(LEADERBOARD.divisions[i].division);
                        displayText += LEADERBOARD.divisions[i].division + ' Sub Division&nbsp;&nbsp;•&nbsp;&nbsp;';
                    }
                }

                $('#menu_div').next('div').find('ul').html(menu_html);
                $('.div_menu[name="' + SETTINGS.range + '"]').addClass('selected_filterbutton');

                $('#menu_div').show();

                $('.what').html(displayText + LEADERBOARD.current_game_desc);
                LEADERBOARD.event_headline = displayText + LEADERBOARD.current_game_desc;

                break;


            case 'P':
                menu_html = '<li><a class="season_menu" name="all">All Darts</a></li>';
                menu_html += '<li><a class="season_menu" name="social">Play/Social</a></li>';
                menu_html += '<li><a class="season_menu" name="singles">Singles Leagues</a></li>';
                menu_html += '<li><a class="season_menu" name="teams">Team Leagues</a></li>';
                menu_html += '<li><a class="season_menu" name="tournaments">Tournaments</a></li>';
                $('#menu_season ul').html(menu_html);

                $('#menu_season span').html('Activity Type'); // Label

                displayText = 'All Darts'; // Default

                switch (SETTINGS.range) {
                    case 'all':
                        displayText = 'All Darts';
                        $('#settingTypeLabel p').html('All Darts');
                        break;
                    case 'social':
                        $('#settingTypeLabel p').html('Play/Social');
                        displayText = 'Play/Social';
                        break;
                    case 'singles':
                        $('#settingTypeLabel p').html('Singles Leagues');
                        displayText = 'Singles Leagues';
                        break;
                    case 'teams':
                        $('#settingTypeLabel p').html('Team Leagues');
                        displayText = 'Team Leagues';
                        break;
                    case 'tournaments':
                        $('#settingTypeLabel p').html('Tournaments');
                        displayText = 'Tournaments';
                        break;
                }
                $('.season_menu[name="' + SETTINGS.range + '"]').addClass('selected_filterbutton');


                SETTINGS.filter_desc_label = displayText;

                if (SETTINGS.game_filter_vals.game_type == '01') {
                    dca_text = cnullZero(LEADERBOARD.my_dca) + ' PPR';
                } else {
                    dca_text = cnullZero(LEADERBOARD.my_dca) + ' MPR';
                }

                // $('.dca_header_display').html(cnullZero(LEADERBOARD.my_dca));
                $('.op_dca_tooltip_outperform').html(cnullZero(LEADERBOARD.op_dca_outperform));
                $('.op_dca_tooltip_percentage').html(formatMissPer(cnullZero(LEADERBOARD.op_dca_outperform) / LEADERBOARD.player_count, '%', 0));
                $('.xpr_tooltip_outperform').html(cnullZero(LEADERBOARD.xpr_outperform));
                $('.xpr_tooltip_percentage').html(formatMissPer(cnullZero(LEADERBOARD.xpr_outperform) / LEADERBOARD.player_count, '%', 0));
                $('.op_xpr_tooltip_outperform').html(cnullZero(LEADERBOARD.op_xpr_outperform));
                $('.op_xpr_tooltip_percentage').html(formatMissPer(cnullZero(LEADERBOARD.op_xpr_outperform) / LEADERBOARD.player_count, '%', 0));
                $('.what').html(displayText);
                LEADERBOARD.event_headline = displayText;

                menu_html = '<li class="history"><a class="finish_menu" name="7_day">7 Days</a></li>';
                menu_html += '<li class="history"><a class="finish_menu" name="30_day">30 Days</a></li>';
                menu_html += '<li class="history"><a class="finish_menu" name="60_day">60 Days</a></li>';
                menu_html += '<li class="history"><a class="finish_menu" name="90_day">90 Days</a></li>';
                menu_html += '<li style="clear: both;" class="history"><a class="finish_menu" name="6_month">6 Months</a></li>';
                menu_html += '<li class="history"><a class="finish_menu" name="12_month">12 Months</a></li>';
                menu_html += '<li class="history"><a class="finish_menu" name="18_month">18 Months</a></li>';
                menu_html += '<li class="history"><a class="finish_menu" name="24_month">24 Months</a></li>';
                menu_html += '<li class="history"><a class="finish_menu" name="all">All</a></li>';

                $('#menu_finish').next('div').find('ul').html(menu_html);
                $('#menu_finish h3').html('History:');

                displayText = getHistVal(SETTINGS.finish);

                $('#menu_finish h2').html(displayText);
                SETTINGS.filter_desc_label += $('#menu_finish h2').html();
                $('.when').html(displayText + ' : ' + dca_text);
                $('.finish_menu[name="' + SETTINGS.finish + '"]').addClass('selected_filterbutton');

                break;
        }

        switch (SETTINGS.legs) {
            case 'all':
                $('#menu_legs h2').html('All Legs');
                break;
            default:
                $('#menu_legs h2').html(SETTINGS.legs + '+ Legs');
                break;
        }
        $('.legs_menu[name="' + SETTINGS.legs + '"]').addClass('selected_filterbutton');

        $('.femaleNotice').hide();

        switch (SETTINGS.category) {
            case 'all':
                $('#menu_category h2').html('All Players');
                break;
            case 'men':
                $('#menu_category h2').html('Male');
                $('.femaleNotice').show();
                break;
            case 'women':
                $('#menu_category h2').html('Female');
                $('.femaleNotice').show();
                break;
            case 'youth':
                $('#menu_category h2').html('Youth');
                break;
            default:
                $('#menu_category h2').html(SETTINGS.category);
                break;
        }
        $('.category_menu[name="' + SETTINGS.category + '"]').addClass('selected_filterbutton');


        switch (SETTINGS.matchCount) {
            case 'all':
                $('#menu_match_count h2').html('All Matches');
                break;
            default:
                $('#menu_match_count h2').html(SETTINGS.matchCount + '+ Matches');
                break;
        }
        $('.matchcount_menu[name="' + SETTINGS.matchCount + '"]').addClass('selected_filterbutton');


        if (SETTINGS.event_type == 'P') {
            $('.finish_menu').each(function () {
                switch ($(this).attr('name')) {
                    case 'all':
                        $(this).html('All History');
                        break;
                    case '1_day':
                        $(this).html('1 D');
                        break;
                    case '3_day':
                        $(this).html('3 D');
                        break;
                    case '7_day':
                        $(this).html('7 D');
                        break;
                    case '30_day':
                        $(this).html('30 D');
                        break;
                    case '60_day':
                        $(this).html('60 D');
                        break;
                    case '90_day':
                        $(this).html('90 D');
                        break;
                    case '6_month':
                        $(this).html('6 M');
                        break;
                    case '12_month':
                        $(this).html('12 M');
                        break;
                    case '18_month':
                        $(this).html('18 M');
                        break;
                    case '24_month':
                        $(this).html('24 M');
                        break;

                    default:
                        $(this).html(unit + ' ' + $(this).attr('name'));
                }
            });
        }

        // Reload handlers
        $('.mobile-menus nav ul ul li a').off('click');
        $('.subfilter_menu ul li').off('click');

        $('.mobile-menus nav ul ul li a').click(function (event) {
            event.preventDefault();
            SETTINGS.handlePrimaryMenuClick(event, $(this));
        });

        $('.subfilter_menu ul li').click(function (event) {
            event.preventDefault();
            SETTINGS.handleMenuClick(event, $(this));
        });

    },

    buildSeasonItem: function (currentId, newSeason) {
        // Replace 3rd component of comount league id field (guid_seasonGuid_seasonStatus)
        var idParts = currentId.split('_');
        if (idParts.length == 3) {
            return idParts[0] + '_' + String(idParts[1]) + '_' + newSeason;
        } else {
            return id; // Error condition
        }
    },

    sort: function (field, callback, header_class) {

        if (field == 'selected_players') {
            if (LEADERBOARD.peg_selected_players == true) {
                LEADERBOARD.peg_selected_players = false;
            } else {
                LEADERBOARD.peg_selected_players = true;
            }

            field = LEADERBOARD.current_sort; // Keep current sort
            LEADERBOARD.savePegSelectedPlayers();
        }

        var reverse = -1;

        if ((LEADERBOARD.suppress_player_3da == 'Y') && (field == 'xpr')) {
            field = 'last_name';
        }

        LEADERBOARD.current_sort = field;


        // Save sort if coming form user activated sort
        if (header_class) {
            LEADERBOARD.saveState();
        }

        if ((SETTINGS.event_type == 'L') && (field == 'finish')) {
            field = 'rollup_number';
            reverse = 1;
        }

        if ((field == 'last_name') || (LEADERBOARD.selected_players[SETTINGS.event_type].length == 0)) {
            $('.sel_sort').hide();
        } else {
            $('.sel_sort').show();
        }

        if (field == 'last_name') {
            $('th.a2-ml').html('<span class="tot_op_label">' + LEADERBOARD.player_count + '</span>');
        } else {
            $('th.a2-ml').html('R');
        }

        switch (field) {

            case 'country':
                LEADERBOARD.dataset.sort(function (a, b) {

                    var a_country, b_country;

                    if (a.country) {
                        a_country = a.country.toUpperCase();
                    } else {
                        a_country = 'zzz';
                    }

                    if (b.country) {
                        b_country = b.country.toUpperCase();
                    } else {
                        b_country = 'zzz';
                    }

                    if (a.hasOwnProperty('country')) {
                        if (a_country < b_country) return reverse;
                        if (a_country > b_country) return -1 * reverse;
                    }

                    if (a.last_name.toUpperCase() < b.last_name.toUpperCase()) return reverse;
                    if (a.last_name.toUpperCase() > b.last_name.toUpperCase()) return -1 * reverse;

                    if (a.first_name.toUpperCase() < b.first_name.toUpperCase()) return reverse;
                    if (a.first_name.toUpperCase() > b.first_name.toUpperCase()) return -1 * reverse;

                    return 0;
                });

                break;

            case 'last_name':
                LEADERBOARD.dataset.sort(function (a, b) {
                    if (a.last_name.toUpperCase() < b.last_name.toUpperCase()) return reverse;
                    if (a.last_name.toUpperCase() > b.last_name.toUpperCase()) return -1 * reverse;

                    if (a.first_name.toUpperCase() < b.first_name.toUpperCase()) return reverse;
                    if (a.first_name.toUpperCase() > b.first_name.toUpperCase()) return -1 * reverse;

                    return 0;
                });
                break;

            case 'team_name':

                LEADERBOARD.dataset.sort(function (a, b) {
                    if (a.hasOwnProperty('team_name')) {
                        if (a.team_name.toUpperCase() < b.team_name.toUpperCase()) return reverse;
                        if (a.team_name.toUpperCase() > b.team_name.toUpperCase()) return -1 * reverse;
                    }
                    return 0;
                });

                break;

            case 'sub_division':
                LEADERBOARD.dataset.sort(function (a, b) {
                    if (a.division.toUpperCase() < b.division.toUpperCase()) return reverse;
                    if (a.division.toUpperCase() > b.division.toUpperCase()) return -1 * reverse;
                    return 0;
                });
                break;

            case 'finish':
                if ((SETTINGS.event_id.substring(0, 2) == 't_') || (SETTINGS.event_id.substring(0, 2) == 'a_')) {
                    reverse = -1;
                } else {
                    reverse = 1;
                }

                LEADERBOARD.dataset.sort(function (a, b) {

                    if (parseInt(cnullZero(a[field])) > parseInt(cnullZero(b[field]))) {
                        return reverse;
                    }
                    if (parseInt(cnullZero(a[field])) < parseInt(cnullZero(b[field]))) {
                        return -1 * reverse;
                    }

                    if (a.last_name.toUpperCase() < b.last_name.toUpperCase()) return -1 * reverse;
                    if (a.last_name.toUpperCase() > b.last_name.toUpperCase()) return reverse;

                    if (a.first_name.toUpperCase() < b.first_name.toUpperCase()) return -1 * reverse;
                    if (a.first_name.toUpperCase() > b.first_name.toUpperCase()) return reverse;

                });
                break;

            case 'myfirst_nine':
                if (SETTINGS.game_filter_vals.game_type !== '01') {
                    LEADERBOARD.dataset.sort(function (a, b) {
                        if (a.mytarg_per === null) {
                            return 1;
                        }
                        if (b.mytarg_per === null) {
                            return -1;
                        }

                        if (parseFloat(cnullZero(a.mytarg_per)) < parseFloat(cnullZero(b.mytarg_per))) {
                            return reverse;
                        }
                        if (parseFloat(cnullZero(a.mytarg_per)) > parseFloat(cnullZero(b.mytarg_per))) {
                            return -1 * reverse;
                        }

                        // return parseFloat(cnullZero(1 - a.mytarg_per)) - parseFloat(cnullZero(1 - b.mytarg_per));
                    });
                } else {
                    LEADERBOARD.dataset.sort(function (a, b) {
                        if (parseFloat(cnullZero(a[field])) > parseFloat(cnullZero(b[field]))) {
                            return reverse;
                        }
                        if (parseFloat(cnullZero(a[field])) < parseFloat(cnullZero(b[field]))) {
                            return -1 * reverse;
                        }

                        if (field != 'xpr') {
                            if (parseFloat(cnullZero(a.xpr)) > parseFloat(cnullZero(b.xpr))) {
                                return reverse;
                            }
                            if (parseFloat(cnullZero(a.xpr)) < parseFloat(cnullZero(b.xpr))) {
                                return -1 * reverse;
                            }
                        }

                        if (a.last_name.toUpperCase() < b.last_name.toUpperCase()) return reverse;
                        if (a.last_name.toUpperCase() > b.last_name.toUpperCase()) return -1 * reverse;

                        if (a.first_name.toUpperCase() < b.first_name.toUpperCase()) return reverse;
                        if (a.first_name.toUpperCase() > b.first_name.toUpperCase()) return -1 * reverse;

                    });
                }
                break;

            case 'myavg_finish':
                if (SETTINGS.game_filter_vals.game_type !== '01') {
                    LEADERBOARD.dataset.sort(function (a, b) {
                        if (parseFloat(cnullZero(a.mytrip_bull_per)) > parseFloat(cnullZero(b.mytrip_bull_per))) {
                            return reverse;
                        }
                        if (parseFloat(cnullZero(a.mytrip_bull_per)) < parseFloat(cnullZero(b.mytrip_bull_per))) {
                            return -1 * reverse;
                        }

                        return parseFloat(cnullZero(a.mytrip_bull_per)) - parseFloat(cnullZero(b.mytrip_bull_per));
                    });
                } else {
                    LEADERBOARD.dataset.sort(function (a, b) {
                        if (parseFloat(cnullZero(a[field])) > parseFloat(cnullZero(b[field]))) {
                            return reverse;
                        }
                        if (parseFloat(cnullZero(a[field])) < parseFloat(cnullZero(b[field]))) {
                            return -1 * reverse;
                        }

                        if (field != 'xpr') {
                            if (parseFloat(cnullZero(a.xpr)) > parseFloat(cnullZero(b.xpr))) {
                                return reverse;
                            }
                            if (parseFloat(cnullZero(a.xpr)) < parseFloat(cnullZero(b.xpr))) {
                                return -1 * reverse;
                            }
                        }

                        if (a.last_name.toUpperCase() < b.last_name.toUpperCase()) return reverse;
                        if (a.last_name.toUpperCase() > b.last_name.toUpperCase()) return -1 * reverse;

                        if (a.first_name.toUpperCase() < b.first_name.toUpperCase()) return reverse;
                        if (a.first_name.toUpperCase() > b.first_name.toUpperCase()) return -1 * reverse;

                    });
                }
                break;

            case 'first_nine':
                if (SETTINGS.game_filter_vals.game_type !== '01') {
                    LEADERBOARD.dataset.sort(function (a, b) {
                        if (a.targ_per === null) {
                            return 1;
                        }
                        if (b.targ_per === null) {
                            return -1;
                        }

                        if (parseFloat(cnullZero(a.targ_per)) < parseFloat(cnullZero(b.targ_per))) {
                            return reverse;
                        }
                        if (parseFloat(cnullZero(a.targ_per)) > parseFloat(cnullZero(b.targ_per))) {
                            return -1 * reverse;
                        }

                        // return parseFloat(cnullZero(1 - a.mytarg_per)) - parseFloat(cnullZero(1 - b.mytarg_per));
                    });
                } else {
                    LEADERBOARD.dataset.sort(function (a, b) {
                        if (parseFloat(cnullZero(a[field])) > parseFloat(cnullZero(b[field]))) {
                            return reverse;
                        }
                        if (parseFloat(cnullZero(a[field])) < parseFloat(cnullZero(b[field]))) {
                            return -1 * reverse;
                        }

                        if (field != 'xpr') {
                            if (parseFloat(cnullZero(a.xpr)) > parseFloat(cnullZero(b.xpr))) {
                                return reverse;
                            }
                            if (parseFloat(cnullZero(a.xpr)) < parseFloat(cnullZero(b.xpr))) {
                                return -1 * reverse;
                            }
                        }

                        if (a.last_name.toUpperCase() < b.last_name.toUpperCase()) return reverse;
                        if (a.last_name.toUpperCase() > b.last_name.toUpperCase()) return -1 * reverse;

                        if (a.first_name.toUpperCase() < b.first_name.toUpperCase()) return reverse;
                        if (a.first_name.toUpperCase() > b.first_name.toUpperCase()) return -1 * reverse;

                    });
                }
                break;

            case 'avg_finish':
                if (SETTINGS.game_filter_vals.game_type !== '01') {
                    LEADERBOARD.dataset.sort(function (a, b) {
                        if (parseFloat(cnullZero(a.trip_bull_per)) > parseFloat(cnullZero(b.trip_bull_per))) {
                            return reverse;
                        }
                        if (parseFloat(cnullZero(a.trip_bull_per)) < parseFloat(cnullZero(b.trip_bull_per))) {
                            return -1 * reverse;
                        }

                        return parseFloat(cnullZero(a.trip_bull_per)) - parseFloat(cnullZero(b.trip_bull_per));
                    });
                } else {
                    LEADERBOARD.dataset.sort(function (a, b) {
                        if (parseFloat(cnullZero(a[field])) > parseFloat(cnullZero(b[field]))) {
                            return reverse;
                        }
                        if (parseFloat(cnullZero(a[field])) < parseFloat(cnullZero(b[field]))) {
                            return -1 * reverse;
                        }

                        if (field != 'xpr') {
                            if (parseFloat(cnullZero(a.xpr)) > parseFloat(cnullZero(b.xpr))) {
                                return reverse;
                            }
                            if (parseFloat(cnullZero(a.xpr)) < parseFloat(cnullZero(b.xpr))) {
                                return -1 * reverse;
                            }
                        }

                        if (a.last_name.toUpperCase() < b.last_name.toUpperCase()) return reverse;
                        if (a.last_name.toUpperCase() > b.last_name.toUpperCase()) return -1 * reverse;

                        if (a.first_name.toUpperCase() < b.first_name.toUpperCase()) return reverse;
                        if (a.first_name.toUpperCase() > b.first_name.toUpperCase()) return -1 * reverse;

                    });
                }
                break;

            default:
                LEADERBOARD.dataset.sort(function (a, b) {

                    if (parseFloat(cnullZero(a[field])) > parseFloat(cnullZero(b[field]))) {
                        return reverse;
                    }
                    if (parseFloat(cnullZero(a[field])) < parseFloat(cnullZero(b[field]))) {
                        return -1 * reverse;
                    }

                    if (field != 'xpr') {
                        if (parseFloat(cnullZero(a.xpr)) > parseFloat(cnullZero(b.xpr))) {
                            return reverse;
                        }
                        if (parseFloat(cnullZero(a.xpr)) < parseFloat(cnullZero(b.xpr))) {
                            return -1 * reverse;
                        }
                    }

                    if (a.last_name.toUpperCase() < b.last_name.toUpperCase()) return reverse;
                    if (a.last_name.toUpperCase() > b.last_name.toUpperCase()) return -1 * reverse;

                    if (a.first_name.toUpperCase() < b.first_name.toUpperCase()) return reverse;
                    if (a.first_name.toUpperCase() > b.first_name.toUpperCase()) return -1 * reverse;

                });
                break;
        }

        // Add rank
        for (var r = 0; r < LEADERBOARD.dataset.length; r++) {
            LEADERBOARD.dataset[r].rank = (r + 1);
        }

        // If pegging selected players, then pull them to the top
        if (LEADERBOARD.peg_selected_players) {
            LEADERBOARD.dataset = LEADERBOARD.pegSelectedPlayers();
        }

        LEADERBOARD.render(callback, header_class);
    },

    saveState: function () {

        if (SETTINGS.event_type == 'P') {
            localStorage.setItem('leaderboardSort_' + SETTINGS.event_type, JSON.stringify({
                last_sort: LEADERBOARD.current_sort,
                last_sort_time: new Date(),
                game_type: SETTINGS.game_filter_vals.game_type,
                last_event_id: SETTINGS.event_id
            }));
        } else {
            localStorage.setItem('leaderboardSort_' + SETTINGS.event_type, JSON.stringify({
                last_sort: LEADERBOARD.current_sort,
                last_sort_time: new Date(),
                sec2_toggle: SETTINGS.sec2_toggle,
                sec3_toggle: SETTINGS.sec3_toggle,
                game_type: SETTINGS.game_filter_vals.game_type,
                last_event_id: SETTINGS.event_id
            }));
        }
    },

    sortMap: function (sort_field) {
        switch (SETTINGS.event_type) {
            case 'L':
            case 'T':
                switch (sort_field) {
                    case 'country':
                        return 'a2b';
                    case 'last_name':
                        return 'a3';
                    case 'xpr':
                        return 'a4';
                    case 'first_nine':
                        if (SETTINGS.sec2_toggle < 5) {
                            return 'b1';
                        } else {
                            return 'xxx';
                        }
                    case 'avg_finish':
                        if (SETTINGS.sec2_toggle < 5) {
                            return 'b2';
                        } else if (SETTINGS.sec2_toggle == 7) { // Check Outs
                            return 'b1';
                        } else {
                            return 'xxx';
                        }

                    case 'p100_per':
                        if (SETTINGS.sec2_toggle == 1) {
                            return 'b3';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'p100_leg':
                        if (SETTINGS.sec2_toggle == 2) {
                            return 'b3';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'p100':
                        if ((SETTINGS.sec2_toggle == 3) || (SETTINGS.sec2_toggle == 4)) {
                            return 'b3';
                        } else {
                            return 'xxx';
                        }
                        break;

                    case 'p140_per':
                        if (SETTINGS.sec2_toggle == 1) {
                            return 'b4';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'p140_leg':
                        if (SETTINGS.sec2_toggle == 2) {
                            return 'b4';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'p140':
                        if (SETTINGS.sec2_toggle == 3) {
                            return 'b4';
                        } else {
                            return 'xxx';
                        }
                        break;

                    case 'ton80_per':
                        if (SETTINGS.sec2_toggle == 1) {
                            return 'b5';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'ton80_leg':
                        if (SETTINGS.sec2_toggle == 2) {
                            return 'b5';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'ton80':
                        if (SETTINGS.sec2_toggle == 3) {
                            return 'b5';
                        } else {
                            return 'xxx';
                        }
                        break;

                    case 'ton_points':
                        return 'b4-b5tot';

                    case 'high_turn':
                        if (SETTINGS.sec2_toggle == 5) {
                            return 'b1';
                        } else {
                            return 'xxx';
                        }
                    case 'high_first_turn':
                        if (SETTINGS.sec2_toggle == 5) {
                            return 'b2';
                        } else {
                            return 'xxx';
                        }
                    case 'high_double_in_turn':
                        if (SETTINGS.sec2_toggle == 5) {
                            return 'b3';
                        } else {
                            return 'xxx';
                        }
                    case 'high_double_in':
                        if (SETTINGS.sec2_toggle == 5) {
                            return 'b4';
                        } else {
                            return 'xxx';
                        }
                    case 'high_double_out':
                        if (SETTINGS.sec2_toggle == 5) {
                            return 'b5';
                        } else {
                            return 'xxx';
                        }

                    case 'matches':
                        if (SETTINGS.sec3_toggle == 1) {
                            return 'c1';
                        } else {
                            return 'xxx';
                        }
                    case 'legs':
                        if (SETTINGS.sec3_toggle == 1) {
                            return 'c2';
                        } else if (SETTINGS.sec3_toggle == 2) {
                            return 'c1';
                        } else {
                            return 'xxx';
                        }
                    case 'winp':
                        if (SETTINGS.sec3_toggle == 1) {
                            return 'c3';
                        } else {
                            return 'xxx';
                        }
                    case 'oppXpr':
                        if (SETTINGS.sec3_toggle == 1) {
                            return 'c4';
                        } else {
                            return 'xxx';
                        }
                    case 'finish':
                        if (SETTINGS.sec3_toggle == 1) {
                            return 'c5';
                        } else {
                            return 'xxx';
                        }

                    case 'team_name':
                        return 'b1-b3';
                    case 'sub_division':
                        return 'b4-b5';


                    case 'withdarts_legs':
                        if (SETTINGS.sec3_toggle == 2) {
                            return 'c2';
                        } else {
                            return 'xxx';
                        }
                    case 'withdarts_wins_per':
                        if (SETTINGS.sec3_toggle == 2) {
                            return 'c3';
                        } else {
                            return 'xxx';
                        }
                    case 'againstdarts_legs':
                        if (SETTINGS.sec3_toggle == 2) {
                            return 'c4';
                        } else {
                            return 'xxx';
                        }
                    case 'againstdarts_wins_per':
                        if (SETTINGS.sec3_toggle == 2) {
                            return 'c5';
                        } else {
                            return 'xxx';
                        }

                    case 'targ_per':
                        if ((SETTINGS.sec2_toggle == 1) || (SETTINGS.sec2_toggle == 2)) {
                            return 'b1';
                        } else {
                            return 'xxx';
                        }
                    case 'trip_bull_per':
                        if ((SETTINGS.sec2_toggle == 1) || (SETTINGS.sec2_toggle == 2)) {
                            return 'b2';
                        } else {
                            return 'xxx';
                        }
                    case 'm5_per':
                        if (SETTINGS.sec2_toggle == 1) {
                            return 'b3';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'm7_per':
                        if (SETTINGS.sec2_toggle == 1) {
                            return 'b4';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'm9_per':
                        if (SETTINGS.sec2_toggle == 1) {
                            return 'b5';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'm5':
                        if (SETTINGS.sec2_toggle == 2) {
                            return 'b3';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'm7':
                        if (SETTINGS.sec2_toggle == 2) {
                            return 'b4';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'm9':
                        if (SETTINGS.sec2_toggle == 2) {
                            return 'b5';
                        } else {
                            return 'xxx';
                        }
                        break;


                    case 'bulls_3':
                        if (SETTINGS.sec2_toggle == 3) {
                            return 'b1';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'bulls_4':
                        if (SETTINGS.sec2_toggle == 3) {
                            return 'b2';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'bulls_5':
                        if (SETTINGS.sec2_toggle == 3) {
                            return 'b3';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'bulls_6':
                        if (SETTINGS.sec2_toggle == 3) {
                            return 'b4';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'hat_tricks':
                        if (SETTINGS.sec2_toggle == 3) {
                            return 'b5';
                        } else {
                            return 'xxx';
                        }
                        break;

                    case 'bulls_3_per':
                        if (SETTINGS.sec2_toggle == 4) {
                            return 'b1';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'bulls_4_per':
                        if (SETTINGS.sec2_toggle == 4) {
                            return 'b2';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'bulls_5_per':
                        if (SETTINGS.sec2_toggle == 4) {
                            return 'b3';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'bulls_6_per':
                        if (SETTINGS.sec2_toggle == 4) {
                            return 'b4';
                        } else {
                            return 'xxx';
                        }
                        break;
                    case 'hat_tricks_per':
                        if (SETTINGS.sec2_toggle == 4) {
                            return 'b5';
                        } else {
                            return 'xxx';
                        }
                        break;


                    case 'all_matches':
                        if ((SETTINGS.sec3_toggle == 3) || (SETTINGS.sec3_toggle == 5)) {
                            return 'c1';
                        } else {
                            return 'xxx';
                        }
                    case 'all_legs':
                        if (SETTINGS.sec3_toggle == 3) {
                            return 'c2';
                        } else {
                            return 'xxx';
                        }
                    case 'all_leg_wins':
                        if (SETTINGS.sec3_toggle == 3) {
                            return 'c3';
                        } else {
                            return 'xxx';
                        }
                    case 'all_leg_loses':
                        if (SETTINGS.sec3_toggle == 3) {
                            return 'c4';
                        } else {
                            return 'xxx';
                        }
                    case 'all_leg_wins_per':
                        if (SETTINGS.sec3_toggle == 3) {
                            return 'c5';
                        } else {
                            return 'xxx';
                        }

                    case 'all_sets':
                        if (SETTINGS.sec3_toggle == 4) {
                            return 'c1';
                        } else {
                            return 'xxx';
                        }
                    case 'all_set_wins':
                        if (SETTINGS.sec3_toggle == 4) {
                            return 'c2';
                        } else {
                            return 'xxx';
                        }
                    case 'all_set_loses':
                        if (SETTINGS.sec3_toggle == 4) {
                            return 'c3';
                        } else {
                            return 'xxx';
                        }
                    case 'all_set_ties':
                        if (SETTINGS.sec3_toggle == 4) {
                            return 'c4';
                        } else {
                            return 'xxx';
                        }
                    case 'all_set_wins_per':
                        if (SETTINGS.sec3_toggle == 4) {
                            return 'c5';
                        } else {
                            return 'xxx';
                        }

                    case 'all_matches':
                        if (SETTINGS.sec3_toggle == 4) {
                            return 'c1';
                        } else {
                            return 'xxx';
                        }
                    case 'all_match_wins':
                        if (SETTINGS.sec3_toggle == 5) {
                            return 'c2';
                        } else {
                            return 'xxx';
                        }
                    case 'all_match_loses':
                        if (SETTINGS.sec3_toggle == 5) {
                            return 'c3';
                        } else {
                            return 'xxx';
                        }
                    case 'all_match_ties':
                        if (SETTINGS.sec3_toggle == 5) {
                            return 'c4';
                        } else {
                            return 'xxx';
                        }
                    case 'all_match_wins_per':
                        if (SETTINGS.sec3_toggle == 5) {
                            return 'c5';
                        } else {
                            return 'xxx';
                        }

                    case 't00':
                        if (SETTINGS.sec2_toggle == 6) {
                            return 'b1';
                        } else {
                            return 'xxx';
                        }
                    case 't20':
                        if (SETTINGS.sec2_toggle == 6) {
                            return 'b2';
                        } else {
                            return 'xxx';
                        }
                    case 't40':
                        if (SETTINGS.sec2_toggle == 6) {
                            return 'b3';
                        } else {
                            return 'xxx';
                        }
                    case 't60':
                        if (SETTINGS.sec2_toggle == 6) {
                            return 'b4';
                        } else {
                            return 'xxx';
                        }
                    case 't80':
                        if (SETTINGS.sec2_toggle == 6) {
                            return 'b5';
                        } else {
                            return 'xxx';
                        }

                    case 'em5':
                        if (SETTINGS.sec2_toggle == 5) {
                            return 'b1';
                        } else {
                            return 'xxx';
                        }
                    case 'em6':
                        if (SETTINGS.sec2_toggle == 5) {
                            return 'b2';
                        } else {
                            return 'xxx';
                        }
                    case 'em7':
                        if (SETTINGS.sec2_toggle == 5) {
                            return 'b3';
                        } else {
                            return 'xxx';
                        }
                    case 'em8':
                        if (SETTINGS.sec2_toggle == 5) {
                            return 'b4';
                        } else {
                            return 'xxx';
                        }
                    case 'em9':
                        if (SETTINGS.sec2_toggle == 5) {
                            return 'b5';
                        } else {
                            return 'xxx';
                        }
                    case 'coe':
                        if (SETTINGS.sec2_toggle == 7) {
                            return 'b2-b3';
                        } else {
                            return 'xxx';
                        }
                    case 'co_perc':
                        if (SETTINGS.sec2_toggle == 7) {
                            return 'b4-b5-2';
                        } else {
                            return 'xxx';
                        }

                }
                break;

            case 'P':
                switch (sort_field) {
                    case 'country':
                        return 'a2b';
                    case 'last_name':
                        return 'a3-ml';
                    case 'op_dca':
                        return 'a4-ml';
                    case 'op_xpr':
                        return 'b1-ml';
                    case 'first_nine':
                        return 'b2-ml';
                    case 'avg_finish':
                        return 'b3-ml';

                    case 'xpr':
                        return 'c1-ml';
                    case 'myfirst_nine':
                        return 'c2-ml';
                    case 'myavg_finish':
                        return 'c3-ml';

                    case 'matches':
                        return 'd1-ml';
                    case 'legs':
                        return 'd2-ml';
                    case 'winp':
                        return 'd3-ml';
                    case 'hc':
                        return 'd4-ml';
                }
                break;
        }
    },

    pegSelectedPlayers: function () {
        var new_dataset = [];
        var found;
        var compProp;

        switch (SETTINGS.event_type) {
            case 'T':

                /*
				if (((LEADERBOARD.bracket_interface == 'None') || (!LEADERBOARD.bracket_interface))
					|| ((SETTINGS.event_id.substring(0, 2) == 't_') && (LEADERBOARD.pdc == 'N'))) {
				*/

                if (((LEADERBOARD.bracket_interface == 'None') || (!LEADERBOARD.bracket_interface))
                    || ((SETTINGS.event_id.substring(0, 2) == 't_') && (LEADERBOARD.pdc == 'N') && (LEADERBOARD.tour_roster_type == 'T'))) {

                    compProp = 'email';
                } else {
                    compProp = 'player_guid';
                }
                break;
            case 'L':
                compProp = 'player_guid';
                break;
            case 'P':
                compProp = 'member_id';
                break;
            default:
                compProp = 'member_id'; // Exception
                break;
        }

        for (var i = 0; i < LEADERBOARD.dataset.length; i++) {
            for (var sp = 0; sp < LEADERBOARD.selected_players[SETTINGS.event_type].length; sp++) {
                if (LEADERBOARD.dataset[i][compProp] == LEADERBOARD.selected_players[SETTINGS.event_type][sp]) {
                    new_dataset.push(LEADERBOARD.dataset[i]);
                    break;
                }
            }
        }

        for (var i = 0; i < LEADERBOARD.dataset.length; i++) {
            found = false;
            for (var sp = 0; sp < LEADERBOARD.selected_players[SETTINGS.event_type].length; sp++) {
                if (LEADERBOARD.dataset[i][compProp] == LEADERBOARD.selected_players[SETTINGS.event_type][sp]) {
                    found = true;
                    break;
                }
            }
            if (!found) {
                new_dataset.push(LEADERBOARD.dataset[i]);
            }
        }

        return new_dataset;

    },

    toggle_tot_ton_points: function () {
        if (SETTINGS.sec2_toggle == 4) {
            $('#group_leaderboard th.b5').remove();
            $('#group_leaderboard th.b4').replaceWith('<th class="b4-b5"><a href="#" name="ton_points">Points</a></th>');
        } else {
            $('#group_leaderboard th.b4-b5').replaceWith('<th class="b4"><a href="#" name="p140">T40+</a></th><th class="b5"><a href="#" name="ton80">T80</a></th>');
        }

        $('.leaderboard_container th a').off('click');

        $('.leaderboard_container th a').click(function (event) {
            event.preventDefault();

            if (SETTINGS.event_type === 'P' && LEADERBOARD.member_level !== 'P') {
                return;
            }

            $('.leaderboard_container th').removeClass('hilight_th');

            var thisClass = $(this).parent().attr('class');
            $('th.' + thisClass).addClass('hilight_th');

            var field = $(this).attr('name');
            LEADERBOARD.sort(field);

        });

    },

    toggle_team_name: function () {
        if (SETTINGS.sec2_toggle == 6) {
            $('th.b1, th.b2, th.b3, th.b4, th.b5').remove();
            $('th.a4').after('<th class="b1-b2" colspan="2"><a href="#" name="division">Division</a></th><th class="b3-b5" colspan="3"><a href="#" name="team_name">Team</a></th>');
        }
    }

}


function setBreadcrumbs() {
    var breadcrumbs = '<a href="' + DCTV_URL + '">Home</a>';

    var audience_link;

    /*
    } else if (SETTINGS.event_id.substring(0, 2) == 't_') {
                // breadcrumbs += '/<a href="/">Leaderboards</a>/<span>Tour Leaderboard</span>';
                breadcrumbs += '/<span>Tour Leaderboard</span>';
    */

    // todotodo
    switch (SETTINGS.event_type) {
        case 'T':
            if (SETTINGS.event_id.substring(0, 2) == 'a_') {
                breadcrumbs += '/<a href="/">Performance Leaderboards</a>/<span>' + LEADERBOARD.event_info.dctv_title + '</span>';

            } else {
                switch (LEADERBOARD.event_info.audience) {
                    case 'GE':
                        audience_link = '/<a href="' + DCTV_URL + '/events/dartconnect">Events</a>';
                        break;
                    case 'PDC':
                        audience_link = '/<a href="' + DCTV_URL + '/events/pdc">PDC Events</a>';
                        break;
                    case 'WDF':
                        audience_link = '/<a href="' + DCTV_URL + '/events/wdf">WDF Events</a>';
                        break;
                    case 'LE':
                        audience_link = '/<a href="' + DCTV_URL + '/events/local">Local Events</a>';
                        break;
                    case 'YE':
                        audience_link = '/<a href="' + DCTV_URL + '/events/youth">Youth Events</a>';
                        break;
                    case 'LG':
                        audience_link = '/<a href="' + DCTV_URL + '/events/league">League Events</a>';
                        break;
                }

                breadcrumbs += audience_link;

                if (SETTINGS.event_id.substring(0, 2) == 't_') {
                    // Tour leaderboard
                    breadcrumbs += '/<span>Tour Leaderboard</span>';

                    $('.dctv_link_url').attr('href', DCTV_URL);

                } else {
                    // Tournament event board
                    if (LEADERBOARD.event_info.tour_id) {
                        breadcrumbs += '/<a href="/leaderboard#t-t_' + LEADERBOARD.event_info.tour_id + '-' + LEADERBOARD.event_info.tour_lb_link + '-all-all-all-all-all" onclick="window.location.href = this.href; window.location.reload(); return false;">' + LEADERBOARD.event_info.tour_name + '</a>';
                    }

                    breadcrumbs += '/<a href="' + DCTV_URL + '/eventmenu/' + SETTINGS.event_id + '">Event Menu</a>';

                    breadcrumbs += '/<span>Event Leaderboard</span>';

                    $('.dctv_link_url').attr('href', DCTV_URL + '/eventmenu/' + SETTINGS.event_id);
                }
            }
            break;
        case 'L':
            switch (LEADERBOARD.event_info.audience) {
                case 'YE':
                    audience_link = '/<a href="' + DCTV_URL + '/events/youth">Youth Darts</a>';
                    breadcrumbs += audience_link + '/<a href="' + DCTV_URL + '/leaguemenu/' + LEADERBOARD.event_info.league_id + '">League Menu</a>/<span>League Leaderboard</span>';
                    break;
                case 'GE':
                    // audience_link = '/<a href="' + DCTV_URL + '/league-events/' + LEADERBOARD.event_info.league_id + '">League Events</a>';
                    audience_link = '/<a href="' + DCTV_URL + '/events/dartconnect">Events</a>';
                    breadcrumbs += audience_link + '/<a href="' + DCTV_URL + '/leaguemenu/' + LEADERBOARD.event_info.league_id + '">Event Menu</a>/<span>Event Leaderboard</span>';
                    break;
                default:
                    // L = League
                    audience_link = '/<a href="' + DCTV_URL + '/events/league">Leagues</a>';
                    breadcrumbs += audience_link + '/<a href="' + DCTV_URL + '/leaguemenu/' + LEADERBOARD.event_info.league_id + '">League Menu</a>/<span>League Leaderboard</span>';
            }

            $('.dctv_link_url').attr('href', DCTV_URL + '/leaguemenu/' + LEADERBOARD.event_info.league_id);

            break;
        case 'P':
            $('#breadcrumbs').hide();
            break;
    }

    $('#breadcrumbs').html(breadcrumbs);
}


function setupEnvLinks() {
    var host = location.host.toLowerCase();
    var is_dev = (host.slice(0, 4) == 'dev.');
    var is_test = (host.slice(0, 16) == 'leaderboardtest.');
    var is_train = (host.slice(0, 6) == 'train.');
    var prefix = '';
    var env_prefix = '';

    BACK_PREFIX = 'https://tv.dartconnect.com';

    if (is_dev) {
        prefix = 'http://dev.leaderboard.dartconnect.red';
        env_prefix = 'dev.';
        BACK_PREFIX = 'http://dev.tv.dartconnect.red';
    } else if (is_test) {
        prefix = 'https://leaderboardtest.dartconnect.com';
        env_prefix = 'test.';
        BACK_PREFIX = 'https://test.tv.dartconnect.com';
    } else if (is_train) {
        prefix = 'https://train.leaderboard.dartconnect.com';
        env_prefix = 'train.';
        BACK_PREFIX = 'https://train.tv.dartconnect.com';
    }
    ENV_PREFIX = env_prefix;
}

function cnull(x) {
    if (x == 0) {
        return 0;
    } else {
        if (x) {
            return x;
        } else {
            return '';
        }
    }
}

function cnullx(x) {
    if (x) {
        return x;
    } else {
        return 'x';
    }
}

function cnullcountry(x) {
    if (x) {
        return x;
    } else {
        return 'Missing Nation Flag';
    }
}

function dispStat(x) {
    if (x == 0) {
        return '0';
    } else {
        if (x) {
            return Math.round(x);
        } else {
            return '-';
        }
    }
}

function dispDecStat(x, twoDig = true) {
    if (x == 0) {
        return '0';
    } else {
        if (x) {
            if (twoDig) {
                return x.toFixed(2);
            }

            return x.toFixed(2).slice(0, -1);
        } else {
            return '-';
        }
    }
}

function cnullZero(x) {
    if (x) {
        return x;
    } else {
        return 0;
    }
}

function calcXpr(x, darts, twoDig = true) {
    if (darts) {
        var xprFloat;

        if (LEADERBOARD.report_dart_avg_units == 'PPR') {
            xprFloat = (x / darts) * 3;
        } else {
            xprFloat = (x / darts);
        }

        return xprFloat.toFixed(2); // truncate instead of round

        /*
        if (SETTINGS.game_filter_vals.game_type === '01') {
            if (!twoDig) {
				return xprFloat.toFixed(2).slice(0, -1);
			}

			return xprFloat.toFixed(2);
		}
		*/

        // return xprFloat.toFixed(1)
    } else {
        return '-';
    }
}


function per(tot, div) {

    var ret;
    if (div > 0) {
        ret = tot / div;
        return ret.toFixed(3);
    } else {
        return null;
    }
}

function ratio(tot, div) {
    var ret;
    if (div > 0) {
        ret = tot / div;
        return ret.toFixed(1);
    } else {
        return null;
    }
}

function formatPer(x, sfx) {

    if (!sfx) {
        sfx = '';
    }

    var y;
    if (x) {
        if (x == 0) {
            return '0' + sfx;
        }
        if (x < .10) {
            y = (100 * x);
            return y.toFixed(1) + sfx;
        } else {
            return Math.round(100 * x) + sfx;
        }
    } else {
        return '-';
    }
}

function formatMissPer(x, sfx, defaultValue = null) {
    if (!sfx) {
        sfx = '';
    }

    var y;
    if (x) {
        if (x == 0) {
            return '0' + sfx;
        }
        return Math.round(100 * x) + sfx;
    } else {
        return defaultValue !== null ? defaultValue + sfx : '-';
    }
}


function finishVal(x) {
    if (x) {
        if (x.length > 0) {
            return x.slice(1);
        } else {
            return '999';
        }
    } else {
        return '999';
    }
}


function formatFinish(x) {

    if ((SETTINGS.event_id.substring(0, 2) == 't_') || (SETTINGS.event_id.substring(0, 2) == 'a_')) {
        return x;
    }

    if (x == '999') {
        return '-';
    } else {
        return 'T' + x;
    }
}

function formatSpecFinish(x, win) {

    if (x == '999') {
        return '';
    } else if (x == '2' && win) {
        return '<strong class="flex items-center" style="color: gold;">Champion<svg style="width: 18px; height: 18px; margin-left: 2px" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M15 9a3 3 0 0 0 3-3h2a5 5 0 0 1-5.1 5 5 5 0 0 1-3.9 3.9V17l5 2v1H4v-1l5-2v-2.1A5 5 0 0 1 5.1 11H5a5 5 0 0 1-5-5h2a3 3 0 0 0 3 3V4H2v2H0V2h5V0h10v2h5v4h-2V4h-3v5z"></path></svg></strong>';
    } else if (x == '2' && !win) {
        return '<strong class="flex items-center" style="color: #ffb9b9;">Runner-Up</strong>';
    } else {
        return 'Top ' + x;
    }
}


function formatHC(x) {
    if (x) {
        return x;
    } else {
        return '-';
    }
}

function formatPlayerFormat(x) {
    var y;
    if (x) {
        y = x.toLowerCase();
        switch (y) {
            case 'all':
                return 'All';
            case 'singles':
                return "Singles";
            case 'doubles':
                return "Doubles";
            case 'triples':
                return "Triples";
            case 'quads':
                return "Quads";
            default:
                return y;
        }
    } else {
        return 'All';
    }

}

function dispIntVal(x) {
    var xStr;
    if (x == parseInt(x)) {
        xStr = x.toString();
        if (xStr.length > 3) {
            return xStr.substring(0, xStr.length - 3) + ',' + xStr.substring(xStr.length - 3, xStr.length);
        } else {
            return xStr;
        }
    } else {
        if (x) {
            return x;
        } else {
            return '-';
        }
    }
}

function getHistVal(x) {
    switch (x) {
        case 'all':
            return 'All History';
        case '1_day':
            return '1 Day';
        case '3_day':
            return '3 Days';
        case '7_day':
            return '7 Days';
        case '30_day':
            return '30 Days';
        case '60_day':
            return '60 Days';
        case '90_day':
            return '90 Days';
        case '6_month':
            return '6 Months';
        case '12_month':
            return '12 Months';
        case '18_month':
            return '18 Months';
        case '24_month':
            return '24 Months';
        default:
            return x;
    }
}


function fmtStat(x) {
    if (x) {
        return parseInt(x);
    } else {
        return '-';
    }
}

function fmtPlrGrpLbl(x) {
    if (x == 'Team') {
        return 'Team &amp; Division';
    } else {
        return x;
    }
}

function abbrevCricket(x) {
    if (x == 'Cricket') {
        return 'Crick';
    } else {
        return x;
    }
}


// Open player row matches accordion
function plr(x, player_index, thisRow, doScroll) {

    var gameTypeFilter = {
        game_type: SETTINGS.game_filter_vals.game_type,
        game_name: SETTINGS.game_filter_vals.game_name,
        player_format: SETTINGS.game_filter_vals.player_format,
        in_format: SETTINGS.game_filter_vals.in_format,
        out_format: SETTINGS.game_filter_vals.out_format,
        finish: SETTINGS.finish,
        legs: SETTINGS.legs,
        category: SETTINGS.category,
        matchCount: SETTINGS.matchCount,
        range: SETTINGS.range
    };

    var post_data = {
        mode: SETTINGS.event_type,
        id: SETTINGS.event_id,
        gameTypeFilter: gameTypeFilter,
        player_id: x
    };

    post_data.leaderboard_access = LEADERBOARD.event_info.leaderboard_access;

    if (LEADERBOARD.bracket_interface) {
        post_data.bracket_interface = LEADERBOARD.bracket_interface;
    }

    // alert(JSON.stringify(post_data));
    // alert('player_id = ' + x + '; player_index = ' + player_index);

    $.ajax({
        url: '/getLeaderboard',
        type: 'POST',
        cache: false,
        timeout: 60000,
        dataType: 'json',
        processData: false,
        contentType: 'application/json',
        data: JSON.stringify(post_data),
        success: function (data) {

            var html = '';
            var matches;
            var match_number;
            var cur_tourny = '';
            var row_class = '';
            var end_section_class = '';
            var selected_match;
            var selected_match_class;
            var win_flag;
            var max_opponents = 1;
            var opponent_count;
            var max_opponent_count = 1;
            var colClassSfx;
            var player_xpr_value;
            var player_xpr;
            var player_header_label;
            var match_source;
            var last_match_source = '';
            var lblink_game_param;
            var graph_ind;
            var player_win;
            var opponent_label;


            if (data.status == 'OK') {

                matches = data.payload.stats;

                // console.log(JSON.stringify(matches));

                switch (SETTINGS.event_type) {
                    case 'T':
                        // Tournament
                        player_header_label = LEADERBOARD.dataset[player_index].first_name + ' ' + LEADERBOARD.dataset[player_index].last_name;

                        match_number = 1;

                        if (matches.length > 0) {
                            cur_tourny = matches[matches.length - 1].match_event;
                        }

                        for (var i = (matches.length - 1); i >= 0; i--) {
                            if (matches[i].match_event == cur_tourny) {
                                matches[i].match_number = 'Match <span class="mnum">' + match_number + '</span>';
                                matches[i].match_abbrev = 'M' + match_number;
                                match_number += 1;
                            } else {
                                match_number = 1;
                                cur_tourny = matches[i].match_event;
                                matches[i].match_number = 'Match <span class="mnum">' + match_number + '</span>';
                                matches[i].match_abbrev = 'M' + match_number;
                                match_number += 1;
                            }
                        }

                        for (var i = 0; i < matches.length; i++) {
                            if (matches[i].opponent_label) {
                                opponent_count = matches[i].opponent_label.split('•').length;
                                if (opponent_count > max_opponent_count) {
                                    max_opponent_count = opponent_count;
                                }
                            }
                        }
                        break;

                    case 'L':
                        // League
                        player_header_label = LEADERBOARD.dataset[player_index].first_name + ' ' + LEADERBOARD.dataset[player_index].last_name + ' - ' + LEADERBOARD.dataset[player_index].team_name;

                        for (var i = 0; i < matches.length; i++) {
                            matches[i].match_number = 'Match <span class="mnum">' + (matches.length - i) + '</span>';
                            matches[i].match_abbrev = 'M' + (matches.length - i);
                        }

                        max_opponent_count = 2; // doubles size works best for league layout
                        break;

                    case 'P':
                        // My Leaderboard
                        player_header_label = 'vs.&nbsp;' + LEADERBOARD.dataset[player_index].first_name + ' ' + LEADERBOARD.dataset[player_index].last_name;

                        for (var i = 0; i < matches.length; i++) {
                            matches[i].match_number = 'Match <span class="mnum">' + (matches.length - i) + '</span>';
                            matches[i].match_abbrev = 'M' + (matches.length - i);
                        }

                        max_opponent_count = 2; // doubles size works best for personal leaderboard layout
                        break;
                }

                player_xpr_value = LEADERBOARD.dataset[player_index].xpr;
                if (SETTINGS.game_filter_vals.game_type == '01') {
                    player_xpr = player_xpr_value + ' PPR';
                    lblink_game_param = 'all_01';
                } else {
                    player_xpr = player_xpr_value + ' MPR';
                    lblink_game_param = 'all_cricket';
                }

                html += '<tr class="match-detail-row" data-xpr="' + player_xpr_value + '"><td colspan="15" align="center" style="width: 100%;">';

                html += '<div class="accordion-buffer"><img src="/images/rotate-smartphone.svg" /><span>Pro Tip: Rotate your device!</span></div>';

                // Start Matches Detail
                html += '<div class="flex flex-col text-left">';

                // Start Header Bar
                html += '<div class="match-detail-header flex items-center bg-red-500 text-white text-lg py-1 px-6">';
                html += '<span>' + player_header_label + ' ' + LEADERBOARD.current_game_desc + ' - ' + player_xpr + '</span>';
                html += '<button class="ml-auto"><img class="close_match_detail h-7 w-7" src="/images/close-button.png"></button>';
                html += '</div>';
                // End Header Bar

                // Start Graph Row
                html += '<div class="bg-white"><div class="graph-row"></div></div>';
                html += '<div class="graph-actions"></div>';
                // End Graph Row

                // Start Matches
                html += '<div class="flex flex-col p-4 text-white w-full" style="background: #4f6a84;">';
                html += '<span class="text-xl font-bold mb-4">Matches (' + matches.length + ')</span>';

                // Start Headers
                html += '<div style="min-width: 640px;"><div class="flex items-center py-1.5 mb-2 px-3 text-white text-sm bg-blue-400 uppercase font-semibold rounded-md">';

                html += '<div class="w-26">Date</div>';

                if (LEADERBOARD.report_dart_avg_units == 'PPR') {
                    html += '<div class="w-20">3DA</div>';
                } else {
                    html += '<div class="w-20">1DA</div>';
                }

                if (SETTINGS.event_type === 'T') {
                    html += '<div class="w-24">Round</div>';
                }

                if (LEADERBOARD.event_info.league_type == 'TEAM') {
                    html += '<div class="w-8"></div>';
                } else {
                    html += '<div class="w-8">#</div>';
                }


                html += '<div class="w-52 xl:w-64">Opponent</div>';

                if (LEADERBOARD.report_dart_avg_units == 'PPR') {
                    html += '<div class="w-20">O-3DA</div>';
                } else {
                    html += '<div class="w-20">O-1DA</div>';
                }

                html += '<div class="w-24">Match</div>';
                html += '<div class="w-16">Legs</div>';
                html += '<div class="flex-grow">Activity</div>';

                html += '</div>';
                // End Headers

                html += '<div>';

                for (var i = 0; i < matches.length; i++) {
                    if (matches[i].match_event != last_match_source) {
                        if (last_match_source) {
                            html += '<div class="mb-8 border-b-2"></div>';
                        }
                        last_match_source = matches[i].match_event;
                    }

                    if (SETTINGS.event_type == 'P') {
                        if (matches[i].sets_won > matches[i].sets_lost) {
                            // Player win
                            win_flag = '<span class="form_indicator win">W</span>';
                            player_win = true;
                        } else if (matches[i].sets_won < matches[i].sets_lost) {
                            // Opponent win
                            win_flag = '<span class="form_indicator lost">L</span>';
                            player_win = false;
                        } else {
                            // Draw
                            win_flag = '<span class="form_indicator draw">D</span>';
                            player_win = false;
                        }
                    } else {
                        if (matches[i].sets_won > matches[i].sets_lost) {
                            // Player win
                            win_flag = '<span class="form_indicator win">W</span>';
                            player_win = true;
                        } else if (matches[i].sets_won < matches[i].sets_lost) {
                            // Opponent win
                            win_flag = '<span class="form_indicator lost">L</span>';
                            player_win = false;
                        } else {
                            // Draw
                            win_flag = '<span class="form_indicator draw">D</span>';
                            player_win = false;
                        }
                    }

                    matches[i].player_win = player_win;

                    html += '<div class="flex items-center py-2 px-3 text-blue-100 even:bg-coolBlue-700 border-b border-blue-400">';

                    html += '<div class="w-26">' + formatLongDate(matches[i].match_start_date) + '</div>';

                    html += '<div class="w-20">' + calcXpr(matches[i].points_scored, matches[i].darts_thrown) + '</div>';

                    if (SETTINGS.event_type === 'T') {
                        html += '<div class="w-24">' + formatSpecFinish(matches[i].spec_finish, matches[i].player_win) + '</div>';
                    }

                    if (LEADERBOARD.event_info.league_type == 'TEAM') {
                        html += '<div class="w-8"></div>';
                    } else {
                        html += '<div class="w-8">' + win_flag + '</div>';
                    }


                    // Start Opponent Column
                    var opponent_average = calcXpr(matches[i].op_points_scored, matches[i].op_darts_thrown);
                    var opponent_name;

                    if (SETTINGS.event_type == 'P') {
                        opponent_name = matches[i].first_name + ' ' + matches[i].last_name;
                    } else {
                        opponent_name = formatOppName(matches[i].opponent_label);
                    }

                    html += '<div class="w-52 xl:w-64"><span class="text-blue-200">vs.</span> ' + opponent_name + '</div>';

                    // End Opponent Column

                    html += '<div class="w-20">' + opponent_average + '</div>';

                    html += '<div class="w-24"><a href="' + RECAP_URL + '/history/report/match/' + matches[i].match_id + '" class="flex items-center" style="color: #6aceff;" target="_blank">' + matches[i].match_number + ' <svg class="w-4 h-4 xl:w-5 xl:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a></div>';
                    html += '<div class="w-16">' + matches[i].legs + ' legs</div>';


                    // Start Category Column
                    switch (SETTINGS.event_type) {
                        case 'T':
                            if ((SETTINGS.event_id.substring(0, 2) == 'a_') || (SETTINGS.event_id.substring(0, 2) == 't_')) {
                                match_source = '<a class="flex items-center lblink" style="color: #6aceff;" href="/leaderboard?x=' + new Date().valueOf() + '#t-' + matches[i].tournament_link + '-' + lblink_game_param + '-all-all-all-all-all" target="_blank">' + matches[i].match_event + ' <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>';
                            } else {
                                match_source = matches[i].match_event;
                            }
                            break;

                        case 'L':
                            if (matches[i].league_season_status == 'POST') {
                                match_source = 'Division ' + matches[i].division + ' - Post&nbsp;Season';
                            } else {
                                match_source = 'Division ' + matches[i].division + ' - ' + LEADERBOARD.event_info.season;
                            }
                            break;

                        case 'P':
                            match_source = 'Play/Social';


                            if (matches[i].tournament_name) {
                                match_source = '<a href="/leaderboard#t-' + matches[i].tournament_link + '-' + lblink_game_param + '-all-all-all-all-all" class="flex items-center lblink" style="color: #6aceff;" target="_blank">' + matches[i].tournament_name + ' <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>';
                            }
                            if (matches[i].league_name) {
                                match_source = '<a class="flex items-center lblink" style="color: #6aceff;" href="/leaderboard#l-' + matches[i].league_link + '_all-' + lblink_game_param + '-all-all-all-all-all" target="_blank">' + matches[i].league_name + ' - ' + matches[i].league_season + ' <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>';
                            }
                            break;
                    }


                    html += '<div class="flex-grow">' + match_source + '</div>';
                    // End Category Column

                    html += '</div>';
                }
                html += '</div>';

                html += '</div>';
                // End Matches

                html += '</div></div>';
                // End Matches Detail

                LEADERBOARD.player_graph_data = [];

                for (var i = 0; i < matches.length; i++) {
                    graph_ind = matches.length - i - 1;

                    if (SETTINGS.event_type == 'P') {

                        // opponent_label = matches[graph_ind].first_name + '&nbsp;' + matches[graph_ind].last_name
                        opponent_label = '';

                        LEADERBOARD.player_graph_data.push({
                            match_id: matches[graph_ind].match_id,
                            op_xpr: parseFloat(calcXpr(matches[graph_ind].op_points_scored, matches[graph_ind].op_darts_thrown)),
                            xpr: parseFloat(calcXpr(matches[graph_ind].points_scored, matches[graph_ind].darts_thrown)),
                            match_abbrev: matches[graph_ind].match_abbrev,
                            op_label: opponent_label,
                            player_win: matches[graph_ind].player_win,
                            match_event: matches[graph_ind].match_event,
                            match_event_abbrev: matches[graph_ind].match_event_abbrev,
                            darts: matches[graph_ind].op_darts_thrown,
                            points: matches[graph_ind].op_points_scored
                        });
                    } else {

                        opponent_label = matches[graph_ind].opponent_label || 'Away';

                        LEADERBOARD.player_graph_data.push({
                            match_id: matches[graph_ind].match_id,
                            xpr: parseFloat(calcXpr(matches[graph_ind].points_scored, matches[graph_ind].darts_thrown)),
                            op_xpr: parseFloat(calcXpr(matches[graph_ind].op_points_scored, matches[graph_ind].op_darts_thrown)),
                            match_abbrev: matches[graph_ind].match_abbrev,
                            op_label: opponent_label,
                            player_win: matches[graph_ind].player_win,
                            match_event: matches[graph_ind].match_event,
                            match_event_abbrev: matches[graph_ind].match_event_abbrev,
                            darts: matches[graph_ind].darts_thrown,
                            points: matches[graph_ind].points_scored
                        });
                    }
                }

                // html += '<tr class="match-detail-header">';
                // html += '<td colspan=4>' + player_header_label + ' - ' + LEADERBOARD.current_game_desc;
                // html += ' - ' + player_xpr;
                // html += '<img class="close_match_detail" src="/images/close-button.png"></td></tr>';

                html += '</table>';

                html += '</td></tr>';

                $('.match-detail-row').remove();
                $('tbody.inner tr').removeClass('player-row-selected');
                $(thisRow).addClass('player-row-selected');

                thisRow.after(html);

                // $('#mp_label').hide(); // Hide help tooltip

                if (doScroll) {
                    // Returning from back button
                    $('html, body').animate({
                        scrollTop: thisRow.offset().top - 100
                    }, 500);

                } else {
                    // User clicked accordion link
                    LEADERBOARD.last_state = {
                        event_type: SETTINGS.event_type,
                        event_id: SETTINGS.event_id,
                        accordion_open: true,
                        row_player_id: x,
                        last_match_id: null,
                        state_timestamp: new Date()
                    };

                    LEADERBOARD.saveLastState();
                }

                createMatchGraph(player_xpr_value, 25);

                $('.close_match_detail').click(function () {
                    closeMatchAccordion();
                    $(thisRow).removeClass('player-row-selected');
                });

                return;
            } else {
                // silent fail in case user goes off-line
                return;
            }

            return false;

        },
        error: function (a, b, c) {
            alert('Error getting matches');

        }
    });
}

function closeMatchAccordion() {
    $('.match-detail-row').slideUp(400, function () {
        $('tbody.inner tr').removeClass('player-row-selected');
        $('.match-detail-header').remove();
        $('.match-detail-row').remove();
        LEADERBOARD.clearLastState();
        LEADERBOARD.saveLastState();

        // $('#mp_label').show(); // Show help tooltip
    });
}

function makeTwo(x) {
    if (x) {
        if (x.toString().length == 1) {
            return '&nbsp;' + x.toString();
        } else {
            return x.toString();
        }
    } else {
        return '';
    }
}

function formatOppName(x) {
    if (x) {
        return x;
    } else {
        return 'Away';
    }
}

function formatDate(x) {
    if (x) {
        var d = new Date(x);
        curr_date = d.getDate();
        curr_month = d.getMonth() + 1;
        curr_year = d.getFullYear();
        return curr_month + '/' + curr_date + '/' + curr_year.toString().slice(2);
    } else {
        return '-';
    }
}


function formatLongDate(x) {
    if (x) {
        return moment(x).format('DD MMM YYYY');
    } else {
        return '-';
    }
}


function createMatchGraph(player_xpr_value, match_limit, toggle_used) {

    if ($('.graph-row svg').length > 0) {
        $('.graph-row svg').remove();
        $('.graph-actions').remove();
        if (!toggle_used) {
            return;
        }
    }

    // var html = '<tr class="graph-row">';
    // html += '<td colspan=4></td></tr>';
    // $('.match-detail-header').first().after(html);

    var w = 0;
    var h = 170;
    // var ypad = 26;
    var ypad = 31;
    var xpad = 38;

    var op_label_size;

    w = $('.match-detail-header').first().width();

    var dataset;

    // Only add relevant matches
    if (match_limit) {
        if (LEADERBOARD.player_graph_data.length <= match_limit) {
            dataset = LEADERBOARD.player_graph_data;
        } else {
            dataset = [];
            for (var mi = (LEADERBOARD.player_graph_data.length - match_limit); mi < LEADERBOARD.player_graph_data.length; mi++) {
                dataset.push(LEADERBOARD.player_graph_data[mi]);
            }
        }
    } else {
        dataset = LEADERBOARD.player_graph_data;
    }

    var max_xpr = parseFloat(0);
    var min_xpr = parseFloat(500);
    var xpr_units;
    var match_event_count = 1;
    var cur_event = dataset[0].match_event_abbrev;

    if (dataset.length >= 15) {
        op_label_size = '11px';
    } else if (dataset.length >= 10) {
        op_label_size = '12px';
    } else if (dataset.length >= 5) {
        op_label_size = '13px';
    } else {
        op_label_size = '14px';
    }

    for (var i = 0; i < dataset.length; i++) {

        if (dataset[i].xpr > max_xpr) {
            max_xpr = dataset[i].xpr;
        }
        if (dataset[i].op_xpr > max_xpr) {
            max_xpr = dataset[i].op_xpr;
        }
        if (dataset[i].xpr < min_xpr) {
            min_xpr = dataset[i].xpr;
        }
        if (dataset[i].op_xpr < min_xpr) {
            min_xpr = dataset[i].op_xpr;
        }

        if (dataset[i].match_event_abbrev != cur_event) {
            match_event_count += 1;
            cur_event = dataset[i].match_event_abbrev;
        }

    }

    if (SETTINGS.game_filter_vals.game_type == '01') {
        max_xpr += 10;
        min_xpr -= 10;

        if (LEADERBOARD.report_dart_avg_units == 'PPR') {
            xpr_units = '3DA';
        } else {
            xpr_units = '1DA';
        }

    } else {
        max_xpr += .4;
        min_xpr -= .4;
        xpr_units = 'MPR';
    }


    var svg = d3.select(".graph-row").append("svg")
        .attr("width", w)
        .attr("height", h);

    var yScale = d3.scale.linear()
        .domain([min_xpr, max_xpr])
        .range([h - ypad, ypad]);

    var xScale = d3.scale.linear()
        .domain([0, dataset.length - 1])
        .range([xpad, (w - xpad)]);

    var yAxis = d3.svg.axis()
        .scale(yScale)
        .orient("left")
        .ticks(5);

    var xAxis = d3.svg.axis()
        .scale(xScale)
        .tickFormat(function (d, i) {
            return dataset[i].match_abbrev;
        })
        .orient("bottom")
        .ticks(dataset.length - 1);

    var opLineFunction = d3.svg.line()
        .x(function (d, i) {
            return xScale(i);
        })
        .y(function (d) {
            return yScale(d.op_xpr);
        })
        .interpolate("linear");

    var lineFunction = d3.svg.line()
        .x(function (d, i) {
            return xScale(i);
        })
        .y(function (d) {
            return yScale(d.xpr);
        })
        .interpolate("linear");


    // Event boxes (tours and affiliates)
    // if ((SETTINGS.event_id.substring(0, 2) == 't_') || (SETTINGS.event_id.substring(0, 2) == 'a_')) {

    if ((SETTINGS.event_id.substring(0, 2) == 't_') || (SETTINGS.event_id.substring(0, 2) == 'a_') || (SETTINGS.event_type == 'L') || (LEADERBOARD.bracket_interface != 'None')) {
        if (match_event_count > 1) {

            cur_event = dataset[0].match_event_abbrev;
            var start_match, end_match;
            var event_color = altEventColor();
            var event_match_count = 0;
            var cur_label_height;
            var cur_event_darts = 0;
            var cur_event_points = 0;


            start_match = 0;
            for (var i = 0; i < dataset.length; i++) {

                if (dataset[i].match_event_abbrev != cur_event) {

                    // Only render box if more than one match played in event
                    if (event_match_count > 1) {

                        svg.selectAll("rect-" + i)
                            .data(dataset)
                            .enter()
                            .append("rect")
                            .attr("x", xScale(start_match))
                            .attr("y", ypad - 3)
                            .attr("width", xScale(i - 1) - xScale(start_match) + 3)
                            .attr("height", h - 20 - ypad)
                            .attr("fill", event_color);

                        // Event label
                        cur_label_height = labelHeight(cur_label_height);
                        svg.append("text")
                            .attr("x", xScale(start_match) + ((xScale(i - 1) - xScale(start_match)) / 2))
                            .attr("y", cur_label_height - 12)
                            .attr("text-anchor", "middle")
                            .style("font-size", "13px")
                            .text(calcXpr(cur_event_points, cur_event_darts) + ' ' + xpr_units);
                        svg.append("text")
                            .attr("x", xScale(start_match) + ((xScale(i - 1) - xScale(start_match)) / 2))
                            .attr("y", cur_label_height)
                            .attr("text-anchor", "middle")
                            .style("font-size", "11px")
                            .text(abbrev_event(cur_event));
                    }

                    cur_event = dataset[i].match_event_abbrev;
                    start_match = i;
                    event_color = altEventColor(event_color);
                    event_match_count = 0;
                    cur_event_darts = 0;
                    cur_event_points = 0;
                }
                event_match_count += 1;
                cur_event_darts += dataset[i].darts;
                cur_event_points += dataset[i].points;
            }

            function labelHeight(x) {

                return 24;

                if (w >= 850) {
                    return 22;
                }

                if (!x) {
                    return 28;
                }
                if (x == 28) {
                    return 16;
                } else {
                    return 28;
                }
            }

            // Write out last box
            if (event_match_count > 1) {
                svg.selectAll("rect-" + i)
                    .data(dataset)
                    .enter()
                    .append("rect")
                    .attr("x", xScale(start_match))
                    .attr("y", ypad)
                    .attr("width", w - xScale(start_match) - xpad)
                    .attr("height", h - 20 - ypad)
                    .attr("fill", event_color);

                // Event label
                cur_label_height = labelHeight(cur_label_height);

                svg.append("text")
                    .attr("x", xScale(start_match) + (((w - xpad) - xScale(start_match)) / 2))
                    .attr("y", cur_label_height - 12)
                    .attr("text-anchor", "middle")
                    .style("font-size", "13px")
                    .text(calcXpr(cur_event_points, cur_event_darts) + ' ' + xpr_units);
                svg.append("text")
                    .attr("x", xScale(start_match) + (((w - xpad) - xScale(start_match)) / 2))
                    .attr("y", cur_label_height)
                    .attr("text-anchor", "middle")
                    .style("font-size", "11px")
                    .text(abbrev_event(cur_event));

                /*
				svg.append("text")
			        .attr("x", xScale(start_match) + (((w - xpad) - xScale(start_match)) / 2) )
			        .attr("y", cur_label_height)
			        .attr("text-anchor", "middle")
			        .style("font-size", "11px")
			        .text(cur_event + ' (' + calcXpr(cur_event_points, cur_event_darts) + ')');
			    */
            }

            function altEventColor(x) {
                var color1 = '#f8f8e2';
                var color2 = '#e0e0d0';
                if (!x) {
                    return color1;
                }
                if (x == color1) {
                    return color2;
                } else {
                    return color1;
                }
            }

            // &#8230; &hellip;
            function abbrev_event(x) {
                if (w >= 850) {
                    return x;
                } else {
                    if (x.length > 12) {
                        return x.slice(0, 12) + '...';
                    } else {
                        return x;
                    }
                }
            }

        }
    }


    // Player average xpr: player_xpr
    var avg_xpr = svg.append("line")
        .attr("x1", xpad)
        .attr("y1", yScale(player_xpr_value))
        .attr("x2", w - xpad)
        .attr("y2", yScale(player_xpr_value))
        .attr("stroke-width", 2)
        .style("stroke-dasharray", ("6, 4"))
        .attr("stroke", "#f99");

    var opLineGraph = svg.append("path")
        .attr("d", opLineFunction(dataset))
        .attr("stroke", "#00f")
        .attr("stroke-width", 2)
        .attr("fill", "none");

    var lineGraph = svg.append("path")
        .attr("d", lineFunction(dataset))
        .attr("stroke", "#f00")
        .attr("stroke-width", 2)
        .attr("fill", "none");

    svg.selectAll("op-circle")
        .data(dataset)
        .enter()
        .append("circle")
        .attr("cx", function (d, i) {
            return xScale(i);
        })
        .attr("cy", function (d) {
            return yScale(d.op_xpr);
        })
        .attr("r", 5)
        .attr("stroke", "#00d")
        .attr("stroke-width", 2)
        .attr("fill", function (d) {
            if (d.player_win) {
                return "#fff";
            } else {
                return "#00d";
            }
        });

    svg.selectAll("my-circle")
        .data(dataset)
        .enter()
        .append("circle")
        .attr("cx", function (d, i) {
            return xScale(i);
        })
        .attr("cy", function (d) {
            return yScale(d.xpr);
        })
        .attr("r", 5)
        .attr("stroke", "#d00")
        .attr("stroke-width", 2)
        .attr("fill", function (d) {
            if (d.player_win) {
                return "#d00";
            } else {
                return "#fff";
            }
        });


    svg.selectAll("op-label")
        .data(dataset)
        .enter()
        .append("text")
        .text(function (d) {
            return d.op_label;
        })
        .attr("x", function (d, i) {
            if (i == 0) {
                return xScale(i);
            } else {
                return xScale(i) - (d.op_label.length * 3);
            }
        })
        .attr("y", function (d) {
            if (d.op_xpr > d.xpr) {
                return yScale(d.op_xpr) - 9;
            } else {
                return yScale(d.op_xpr) + 18;
            }
        })
        .attr("font-family", "sans-serif")
        .attr("font-size", op_label_size)
        .attr("fill", "#88f");

    svg.selectAll("xpr-label")
        .data(dataset)
        .enter()
        .append("text")
        .text(function (d) {
            if (SETTINGS.game_filter_vals.game_type == '01') {
                return d.xpr.toFixed(1);
            } else {
                return d.xpr.toFixed(2);
            }
        })
        .attr("x", function (d, i) {
            if (i == 0) {
                return xScale(i) - 4;
            } else {
                return xScale(i) - 10;
            }
        })
        .attr("y", function (d) {
            if (d.xpr >= d.op_xpr) {
                return yScale(d.xpr) - 11;
            } else {
                return yScale(d.xpr) + 20;
            }
        })
        .attr("font-family", "sans-serif")
        .attr("font-size", op_label_size)
        .attr("fill", "#f22");

    svg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(30 ,0)")
        .call(yAxis);

    var xAxisSVG = svg.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + (h - 20) + ")")
        .call(xAxis);

    if (LEADERBOARD.player_graph_data.length > 25) {
        if (match_limit) {
            html = '<div style="width: 100%;" class="pt-4 px-4"><a href="#" data-xpr="' + player_xpr_value + '" data-limit="all" class="toggle_graph_size"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>Graph all ' + LEADERBOARD.player_graph_data.length + ' matches</span></a></div>';
        } else {
            html = '<div style="width: 100%;" class="pt-4 px-4"><a href="#" data-xpr="' + player_xpr_value + '" data-limit="25" class="toggle_graph_size"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span>Graph last 25 matches</span></a></div>';
        }
        $('.graph-actions').append(html);
    }

    $('.toggle_graph_size').click(function (event) {
        event.preventDefault();
        var player_xpr_value = $(this).data("xpr");
        var limit = $(this).data("limit");

        if (limit == 'all') {
            createMatchGraph(player_xpr_value, null, 'toggle_used');
        } else {
            createMatchGraph(player_xpr_value, limit, 'toggle_used');
        }
    });

}


var SCREEN_RESIZE = {

    delta: 500,
    resizeId: null,

    resizeHandler: function () {
        clearTimeout(SCREEN_RESIZE.resizeId);
        SCREEN_RESIZE.resizeId = setTimeout(SCREEN_RESIZE.resizeComplete, SCREEN_RESIZE.delta);
    },

    resizeComplete: function () {
        if (LEADERBOARD.last_state.accordion_open) {
            var player_xpr_value = $('.match-detail-row').first().data('xpr');
            var limit = $('.toggle_graph_size').data('limit');
            if (limit == 'all') {
                limit = '25';
            } else {
                limit = null;
            }

            createMatchGraph(player_xpr_value, limit, 'screen_resize');

        }
    }

};


function truncateText(text, size) {
    if (text) {
        if (text.length > size) {
            return text.substr(0, size) + '...';
        } else {
            return text;
        }
    } else {
        return '';
    }
}

function cnullFrac(n, d) {
    if ((d == null) || (n == null)) {
        return '-';
    }

    if ((!d) && (!n)) {
        return '-';
    }

    return n + '/' + d;
}

function showCard(last_name, xpr, finish, event_finals_outcome) {
    // alert(last_name + ' : ' + xpr + ' : ' + finish + ' : ' + event_finals_outcome);

    var clean_last_name;

    if (last_name) {
        clean_last_name = last_name.replace(/~/g, "'");
    } else {
        clean_last_name = '';
    }

    $('#showcard_last_name').val(clean_last_name);
    $('#showcard_xpr').val(xpr);
    $('#showcard_finish').val(finish);
    $('#showcard_event_finals_outcome').val(event_finals_outcome);
    $('#showcard_event_date').val(LEADERBOARD.event_info.event_dates);
    $('#showcard_bracket_interface').val(LEADERBOARD.bracket_interface);

    $('#showcardForm').submit();
    return false;
}

function cleanApos(x) {
    var r;
    if (x) {
        r = x.replace(/'/g, "~");
        return r;
    } else {
        return '';
    }
}

function genFlag(iso2, event_type = null) {
    if (iso2) {
        return '<img src="https://cdn.dartconnect.com/flags/' + fmtCoutryCd(iso2) + '.svg" class="flag flag-sm" />';
    } else {
        if (event_type === 'L') {
            // Back end now assigns flag, null means to use the world flag
            return '<img src="https://cdn.dartconnect.com/flags/world.svg" class="flag flag-sm" />';
            // return '<img src="https://cdn.dartconnect.com/flags/' + fmtCoutryCd(LEADERBOARD.event_info.country_iso2) + '.svg" class="flag flag-sm" />';
        } else {
            return '<img src="https://cdn.dartconnect.com/flags/world.svg" class="flag flag-sm" />';
        }
    }
}

function fmtCoutryCd(x) {
    if (x) {
        return x.toLowerCase();
    } else {
        return '';
    }
}


function login() {

    var league_settings = SETTINGS.event_id.split('_');

    if (league_settings.length == 3) {
        var league_guid = league_settings[0];
        var season_id = league_settings[1];
    } else {
        $('#login_msg_text').html('League not found.');
        $('#login_msg').show(300);
        return false;
    }

    var email = $('#email').val();
    var password = $('#password').val();

    $.ajax({
        url: MEMBER_URL + "/corsajax/memberLeaderboardLogin",
        type: 'POST',
        cache: false,
        timeout: 20000,
        dataType: 'json',
        data: JSON.stringify({
            email: email,
            password: password,
            league_guid: league_guid,
            season_id: season_id
        }),
        success: function (data) {
            processLogin(data);

        },
        error: function (a, b, c) {
            $('#login_msg_text').html('Could not reach server.');
            $('#login_msg').show(300);
        }
    });
}

function processLogin(data) {

    if (data.status == 'OK') {
        LI = true;
        localStorage.setItem(SETTINGS.event_id + '-logged_in', true);

        $('#login').addClass('hidden');
        $('#main').removeClass('hidden');

        LEADERBOARD.getStats(init_page);
        return;
    }

    $('#login_msg_text').html(data.status_text);
    $('#login_msg').show(300);
}


var WALKTHROUGH_PORTRAIT = {
    tip: function () {
        const oneSectionTour = new Shepherd.Tour({
            defaultStepOptions: {
                cancelIcon: {
                    enabled: true
                },
                scrollTo: {
                    behavior: 'smooth',
                    block: 'center'
                },
                popperOptions: {
                    modifiers: [{name: 'offset', options: {offset: [25, 10]}}]
                },
            },
            steps: [
                {
                    title: 'Pro Tip',
                    text: '<div class="pro-tip rotate-tip"><div>For best experience, rotate your device.</div> <img src="/images/rotate-smartphone.svg" style="margin-top: 2px; width: 28px; height: 28px;" /></div>',
                    buttons: [
                        {
                            action: function () {
                                return this.next();
                            },
                            text: 'Close'
                        }
                    ],
                    id: 'welcome'
                },
            ],
            useModalOverlay: true,
        });

        if (!localStorage.getItem('introV3')) {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            oneSectionTour.start();
        }

        ['close', 'cancel', 'complete'].forEach(event => oneSectionTour.on(event, () => {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').hide();

            localStorage.setItem('introV3', 'dismissed');
        }));

        $('#resetWalkthrough').click(function () {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            oneSectionTour.start();
        });
    },
}

var WALKTROUGH_TOURNAMENT = {

    oneSection: function () {
        const oneSectionTour = new Shepherd.Tour({
            defaultStepOptions: {
                cancelIcon: {
                    enabled: true
                },
                scrollTo: {
                    behavior: 'smooth',
                    block: 'center'
                },
                popperOptions: {
                    modifiers: [{name: 'offset', options: {offset: [25, 10]}}]
                },
            },
            steps: [
                {
                    title: 'Welcome to the EVENT <br /> Performance Leaderboard!',
                    text: 'This leaderboard tracks and displays the performance of all participants throughout each competition. <div class="pro-tip rotate-tip"><strong>Pro Tip:</strong> <br/> <div>To see more stats, rotate your device.</div> <img src="/images/rotate-smartphone.svg" style="margin-top: 2px; width: 28px; height: 28px;" /></div>',
                    buttons: [
                        {
                            action: function () {
                                return this.cancel();
                            },
                            secondary: true,
                            text: 'Exit'
                        },
                        {
                            action: function () {
                                return this.next();
                            },
                            text: 'Start'
                        }
                    ],
                    id: 'welcome'
                },
                WALKTHROUGH_GENERAL.headerSection(),
                WALKTHROUGH_GENERAL.playerSection(),
                WALKTHROUGH_GENERAL.clickOnPlayerForChart('td.a3'),
                WALKTHROUGH_GENERAL.helpSection(),
                WALKTHROUGH_GENERAL.explainStartWalkthroughButton(),
            ],
            useModalOverlay: true,
        });

        if (!localStorage.getItem('introV3')) {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            oneSectionTour.start();
        }

        ['close', 'cancel', 'complete'].forEach(event => oneSectionTour.on(event, () => {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').hide();

            localStorage.setItem('introV3', 'dismissed');
        }));

        $('#resetWalkthrough').click(function () {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            oneSectionTour.start();
        });
    },

    allSections: function () {
        const allSectionsTour = new Shepherd.Tour({
            defaultStepOptions: {
                cancelIcon: {
                    enabled: true
                },
                scrollTo: {
                    behavior: 'smooth',
                    block: 'center'
                },
                popperOptions: {
                    modifiers: [{name: 'offset', options: {offset: [25, 10]}}]
                },
            },
            steps: [
                {
                    title: 'Welcome to the EVENT <br /> Performance Leaderboard!',
                    text: 'This leaderboard tracks and displays the performance of all participants throughout each competition.  <div class="pro-tip rotate-tip"><strong>Pro Tip:</strong> <br/> <div>To see more stats, rotate your device.</div> <img src="/images/rotate-smartphone.svg" style="margin-top: 2px; width: 28px; height: 28px;" /></div>',
                    // attachTo: {
                    // 	element: '.hero-welcome',
                    // 	on: 'bottom'
                    // },
                    buttons: [
                        {
                            action: function () {
                                return this.cancel();
                            },
                            secondary: true,
                            text: 'Exit'
                        },
                        {
                            action: function () {
                                return this.next();
                            },
                            text: 'Start'
                        }
                    ],
                    id: 'welcome'
                },
                WALKTHROUGH_GENERAL.headerSection(),
                WALKTHROUGH_GENERAL.playerSection(),
                WALKTHROUGH_GENERAL.performanceSection(),
                WALKTHROUGH_GENERAL.matchLegSection(),
                WALKTHROUGH_GENERAL.statisticsSection(),
                WALKTHROUGH_GENERAL.columnHeaders(),
                WALKTHROUGH_GENERAL.clickOnPlayerForChart('td.a3'),
                WALKTHROUGH_GENERAL.helpSection(),
                WALKTHROUGH_GENERAL.explainStartWalkthroughButton(),
            ],
            useModalOverlay: true,
        });

        if (!localStorage.getItem('introV3')) {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            allSectionsTour.start();
        }

        ['close', 'cancel', 'complete'].forEach(event => allSectionsTour.on(event, () => {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').hide();

            localStorage.setItem('introV3', 'dismissed');
        }));

        $('#resetWalkthrough').click(function () {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            allSectionsTour.start();
        });
    },
}

var WALKTROUGH_PERSONAL = {
    guestSection: function () {
        if (LEADERBOARD.member_level === 'P') {
            return {
                title: 'Welcome to YOUR Opponent Leaderboard!',
                text: 'You have competed against <br /> <span class="flex items-center text-lg mt-2"><svg class="w-7 h-7" viewBox="0 0 618 818" fill="currentColor" style="color:#FFC107;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g><path d="M555,816.25c-16.25,-1.667 -29.583,-8.333 -37.917,-23.333c-5.416,-9.584 -7.916,-20 -5,-30.834c0.834,-2.5 -0.833,-4.166 -1.666,-5.416c-17.084,-29.584 -34.584,-59.167 -52.084,-88.75c-4.166,-7.084 -7.916,-14.167 -12.083,-21.25c-1.25,-2.084 -1.667,-3.334 -4.583,-1.667c-17.5,10.417 -35.417,20.417 -53.334,30.833c-18.333,10.834 -36.666,21.25 -55,32.084c-2.5,1.25 -3.75,4.583 -7.916,3.75c-5.417,-1.667 -7.084,-7.084 -4.167,-11.667c10.417,-15.833 20.833,-31.667 31.667,-47.5c5.833,-8.75 10.833,-17.5 17.083,-25.417c4.583,-5.833 11.667,-8.333 17.917,-11.666c2.916,-1.667 5.416,-3.75 8.75,-5c2.5,-0.834 -0,-2.5 -0.417,-3.75c-5,-9.167 -10.417,-17.917 -15.833,-26.667c-10,-17.5 -20.417,-34.583 -30.417,-52.083c-10.833,-18.75 -22.083,-37.917 -32.917,-56.667c-10,-17.083 -19.583,-33.75 -29.583,-50.833c-10,-17.5 -20.417,-34.584 -30.417,-52.084c-11.25,-19.583 -22.5,-39.166 -34.166,-58.75c-10.417,-17.5 -20.834,-35 -30.834,-52.5c-13.75,-25 -27.916,-49.583 -42.083,-73.75c-15,-25.416 -29.583,-50.833 -44.583,-76.25c-2.5,-4.166 -4.584,-8.333 -7.084,-12.5c-3.75,-5.416 -1.25,-11.25 -0.833,-16.666c1.25,-7.917 0.833,-15.834 1.667,-23.75c2.083,-16.667 3.333,-33.334 5,-49.584c0.416,-4.166 4.583,-5.416 9.166,-3.333c9.167,3.75 18.334,7.5 27.5,12.083c11.25,5.417 22.5,10.417 34.167,15.417c4.167,2.083 8.75,3.75 12.917,5.833c5.416,2.5 7.083,8.75 10,13.75c11.25,19.584 22.5,39.167 33.75,58.75c10.833,18.75 21.666,37.084 32.5,55.834c13.75,23.75 27.916,47.5 41.666,71.25c10,17.5 19.584,35 30,52.5c11.25,19.583 23.334,39.166 34.584,58.75c9.166,15.416 17.916,30.833 26.666,46.25c9.584,16.25 19.167,32.5 28.75,48.75c10.417,17.916 20.417,35.416 30.834,53.333c10.416,17.917 20.833,35.417 31.25,52.917c1.666,2.5 2.083,6.666 5,7.5c2.916,0.833 5.416,-2.917 8.333,-4.167c6.667,-3.333 12.5,-8.333 20,-10.417c1.667,-0.416 3.75,-0.833 5.417,-0.833c20,-0.833 40,-2.083 60,-4.583c7.083,-0.834 14.583,-0 21.666,-1.25c3.334,-0.417 6.667,1.25 7.917,5c1.25,3.75 -0.833,6.666 -4.167,8.333c-22.083,12.917 -44.166,25.417 -66.25,38.333c-14.583,8.334 -29.166,17.084 -43.75,25.417c-2.083,1.25 -2.5,1.667 -1.25,4.167c10.417,19.166 21.667,37.5 32.5,56.25c9.167,15.833 17.917,31.25 27.084,47.083c2.083,3.333 4.583,6.667 6.25,10.417c0.416,0.833 1.25,0.833 2.083,1.25c26.667,9.166 37.083,35.416 28.333,59.583c-5.833,16.25 -18.75,25.833 -36.25,27.917c-1.25,-0.834 -3.333,1.666 -5.833,-0.417Z" style="fill-rule:nonzero;"/><path d="M237.917,359.167c13.75,23.333 26.666,45.833 39.583,68.333c7.083,12.5 14.167,24.583 21.25,36.667c2.083,3.333 1.667,5.416 0,7.916c-16.25,25.417 -30.833,52.084 -46.25,78.334c-10.833,17.916 -20.833,36.666 -32.083,54.583c-1.667,2.5 -2.917,4.583 1.666,6.667c7.084,3.333 13.75,7.916 20.417,11.666c3.333,1.667 5.833,5.417 7.5,8.75c7.083,12.084 15.417,23.334 22.917,35.417c6.666,10.417 14.166,20.833 20.416,31.25c0.834,1.25 1.667,2.5 2.084,3.75c1.25,3.333 -0,5.417 -2.5,7.917c-2.5,2.5 -5,1.25 -7.084,-0c-27.5,-16.25 -55,-32.5 -82.916,-48.75c-8.75,-5 -17.5,-10.417 -26.25,-15.417c-3.75,-2.083 -5.834,-2.5 -8.334,2.083c-13.333,23.334 -27.083,46.667 -40.833,69.584c-7.5,12.916 -15,25.833 -22.083,38.75c-0.834,1.666 -2.084,2.916 -1.25,5c3.333,13.333 -0,25 -7.917,35.833c-15.833,22.083 -47.917,25 -67.917,5.417c-16.25,-15.834 -17.916,-44.167 -2.083,-62.084c5,-5.416 11.25,-10 18.333,-12.083c2.5,-0.833 4.167,-2.083 5,-4.167c8.75,-16.666 19.167,-32.083 27.917,-48.75c7.917,-14.583 17.083,-28.75 25.417,-42.916c3.75,-6.25 7.5,-12.917 11.25,-19.167c1.25,-2.083 1.25,-3.333 -1.25,-5c-30,-17.083 -59.584,-34.583 -89.584,-52.083c-6.666,-3.75 -12.916,-7.5 -19.583,-11.25c-3.333,-2.084 -5.417,-4.584 -4.583,-8.75c1.25,-4.167 4.583,-5.417 8.333,-5c12.5,1.666 25.417,1.666 37.917,2.916c7.5,0.834 15.416,0.834 22.916,1.667c8.75,0.833 17.917,0.833 26.667,2.083c5.417,0.834 9.167,4.167 13.75,6.667c4.583,2.5 9.583,7.917 13.75,7.083c4.167,-0.833 5.417,-7.916 8.333,-12.5c13.75,-23.75 27.917,-47.083 42.084,-70.416c12.916,-21.667 25.416,-43.75 37.916,-65.834c9.584,-14.166 17.917,-28.75 27.084,-44.166Z" style="fill-rule:nonzero;"/><path d="M379.167,334.167c-5.834,-10.417 -11.25,-20 -16.667,-29.167c-6.667,-11.667 -13.75,-23.333 -20.417,-34.583c-8.333,-14.167 -16.25,-28.334 -24.583,-42.5c-1.25,-1.667 -1.25,-3.334 0,-5c7.917,-12.917 15.833,-25.834 22.917,-39.167c10,-17.917 20.416,-35.417 30.833,-53.333c6.667,-11.667 13.75,-23.334 20.833,-35.417c9.167,-15.417 19.167,-30.417 26.667,-46.667c5.833,-12.916 17.5,-16.666 28.75,-22.083c11.667,-5.417 23.75,-10 35,-15.833c7.083,-3.75 14.583,-6.25 22.083,-9.584c4.167,-1.666 7.917,0.834 8.334,5.417c1.25,13.333 1.666,26.667 3.75,40c2.083,13.333 1.25,27.083 4.166,40c0.834,3.75 -0.833,7.083 -2.5,10c-14.583,25 -29.166,49.583 -43.75,74.583c-20.416,34.584 -40.416,69.167 -60.416,104.167c-12.084,19.167 -23.334,38.75 -35,59.167Z" style="fill-rule:nonzero;"/></g></svg> <strong>' + LEADERBOARD.player_count + ' DC Member Opponents</strong></span>',
                buttons: [
                    {
                        action: function () {
                            return this.cancel();
                        },
                        secondary: true,
                        text: 'Exit'
                    },
                    {
                        action: function () {
                            return this.next();
                        },
                        text: 'Start'
                    }
                ],
                id: 'welcome'
            }
        } else {
            return {
                title: 'Welcome to YOUR Opponent Leaderboard!',
                text: 'You have competed against <br /> <span class="flex items-center text-lg mt-2"><svg class="w-7 h-7" viewBox="0 0 618 818" fill="currentColor" style="color:#FFC107;fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><g><path d="M555,816.25c-16.25,-1.667 -29.583,-8.333 -37.917,-23.333c-5.416,-9.584 -7.916,-20 -5,-30.834c0.834,-2.5 -0.833,-4.166 -1.666,-5.416c-17.084,-29.584 -34.584,-59.167 -52.084,-88.75c-4.166,-7.084 -7.916,-14.167 -12.083,-21.25c-1.25,-2.084 -1.667,-3.334 -4.583,-1.667c-17.5,10.417 -35.417,20.417 -53.334,30.833c-18.333,10.834 -36.666,21.25 -55,32.084c-2.5,1.25 -3.75,4.583 -7.916,3.75c-5.417,-1.667 -7.084,-7.084 -4.167,-11.667c10.417,-15.833 20.833,-31.667 31.667,-47.5c5.833,-8.75 10.833,-17.5 17.083,-25.417c4.583,-5.833 11.667,-8.333 17.917,-11.666c2.916,-1.667 5.416,-3.75 8.75,-5c2.5,-0.834 -0,-2.5 -0.417,-3.75c-5,-9.167 -10.417,-17.917 -15.833,-26.667c-10,-17.5 -20.417,-34.583 -30.417,-52.083c-10.833,-18.75 -22.083,-37.917 -32.917,-56.667c-10,-17.083 -19.583,-33.75 -29.583,-50.833c-10,-17.5 -20.417,-34.584 -30.417,-52.084c-11.25,-19.583 -22.5,-39.166 -34.166,-58.75c-10.417,-17.5 -20.834,-35 -30.834,-52.5c-13.75,-25 -27.916,-49.583 -42.083,-73.75c-15,-25.416 -29.583,-50.833 -44.583,-76.25c-2.5,-4.166 -4.584,-8.333 -7.084,-12.5c-3.75,-5.416 -1.25,-11.25 -0.833,-16.666c1.25,-7.917 0.833,-15.834 1.667,-23.75c2.083,-16.667 3.333,-33.334 5,-49.584c0.416,-4.166 4.583,-5.416 9.166,-3.333c9.167,3.75 18.334,7.5 27.5,12.083c11.25,5.417 22.5,10.417 34.167,15.417c4.167,2.083 8.75,3.75 12.917,5.833c5.416,2.5 7.083,8.75 10,13.75c11.25,19.584 22.5,39.167 33.75,58.75c10.833,18.75 21.666,37.084 32.5,55.834c13.75,23.75 27.916,47.5 41.666,71.25c10,17.5 19.584,35 30,52.5c11.25,19.583 23.334,39.166 34.584,58.75c9.166,15.416 17.916,30.833 26.666,46.25c9.584,16.25 19.167,32.5 28.75,48.75c10.417,17.916 20.417,35.416 30.834,53.333c10.416,17.917 20.833,35.417 31.25,52.917c1.666,2.5 2.083,6.666 5,7.5c2.916,0.833 5.416,-2.917 8.333,-4.167c6.667,-3.333 12.5,-8.333 20,-10.417c1.667,-0.416 3.75,-0.833 5.417,-0.833c20,-0.833 40,-2.083 60,-4.583c7.083,-0.834 14.583,-0 21.666,-1.25c3.334,-0.417 6.667,1.25 7.917,5c1.25,3.75 -0.833,6.666 -4.167,8.333c-22.083,12.917 -44.166,25.417 -66.25,38.333c-14.583,8.334 -29.166,17.084 -43.75,25.417c-2.083,1.25 -2.5,1.667 -1.25,4.167c10.417,19.166 21.667,37.5 32.5,56.25c9.167,15.833 17.917,31.25 27.084,47.083c2.083,3.333 4.583,6.667 6.25,10.417c0.416,0.833 1.25,0.833 2.083,1.25c26.667,9.166 37.083,35.416 28.333,59.583c-5.833,16.25 -18.75,25.833 -36.25,27.917c-1.25,-0.834 -3.333,1.666 -5.833,-0.417Z" style="fill-rule:nonzero;"/><path d="M237.917,359.167c13.75,23.333 26.666,45.833 39.583,68.333c7.083,12.5 14.167,24.583 21.25,36.667c2.083,3.333 1.667,5.416 0,7.916c-16.25,25.417 -30.833,52.084 -46.25,78.334c-10.833,17.916 -20.833,36.666 -32.083,54.583c-1.667,2.5 -2.917,4.583 1.666,6.667c7.084,3.333 13.75,7.916 20.417,11.666c3.333,1.667 5.833,5.417 7.5,8.75c7.083,12.084 15.417,23.334 22.917,35.417c6.666,10.417 14.166,20.833 20.416,31.25c0.834,1.25 1.667,2.5 2.084,3.75c1.25,3.333 -0,5.417 -2.5,7.917c-2.5,2.5 -5,1.25 -7.084,-0c-27.5,-16.25 -55,-32.5 -82.916,-48.75c-8.75,-5 -17.5,-10.417 -26.25,-15.417c-3.75,-2.083 -5.834,-2.5 -8.334,2.083c-13.333,23.334 -27.083,46.667 -40.833,69.584c-7.5,12.916 -15,25.833 -22.083,38.75c-0.834,1.666 -2.084,2.916 -1.25,5c3.333,13.333 -0,25 -7.917,35.833c-15.833,22.083 -47.917,25 -67.917,5.417c-16.25,-15.834 -17.916,-44.167 -2.083,-62.084c5,-5.416 11.25,-10 18.333,-12.083c2.5,-0.833 4.167,-2.083 5,-4.167c8.75,-16.666 19.167,-32.083 27.917,-48.75c7.917,-14.583 17.083,-28.75 25.417,-42.916c3.75,-6.25 7.5,-12.917 11.25,-19.167c1.25,-2.083 1.25,-3.333 -1.25,-5c-30,-17.083 -59.584,-34.583 -89.584,-52.083c-6.666,-3.75 -12.916,-7.5 -19.583,-11.25c-3.333,-2.084 -5.417,-4.584 -4.583,-8.75c1.25,-4.167 4.583,-5.417 8.333,-5c12.5,1.666 25.417,1.666 37.917,2.916c7.5,0.834 15.416,0.834 22.916,1.667c8.75,0.833 17.917,0.833 26.667,2.083c5.417,0.834 9.167,4.167 13.75,6.667c4.583,2.5 9.583,7.917 13.75,7.083c4.167,-0.833 5.417,-7.916 8.333,-12.5c13.75,-23.75 27.917,-47.083 42.084,-70.416c12.916,-21.667 25.416,-43.75 37.916,-65.834c9.584,-14.166 17.917,-28.75 27.084,-44.166Z" style="fill-rule:nonzero;"/><path d="M379.167,334.167c-5.834,-10.417 -11.25,-20 -16.667,-29.167c-6.667,-11.667 -13.75,-23.333 -20.417,-34.583c-8.333,-14.167 -16.25,-28.334 -24.583,-42.5c-1.25,-1.667 -1.25,-3.334 0,-5c7.917,-12.917 15.833,-25.834 22.917,-39.167c10,-17.917 20.416,-35.417 30.833,-53.333c6.667,-11.667 13.75,-23.334 20.833,-35.417c9.167,-15.417 19.167,-30.417 26.667,-46.667c5.833,-12.916 17.5,-16.666 28.75,-22.083c11.667,-5.417 23.75,-10 35,-15.833c7.083,-3.75 14.583,-6.25 22.083,-9.584c4.167,-1.666 7.917,0.834 8.334,5.417c1.25,13.333 1.666,26.667 3.75,40c2.083,13.333 1.25,27.083 4.166,40c0.834,3.75 -0.833,7.083 -2.5,10c-14.583,25 -29.166,49.583 -43.75,74.583c-20.416,34.584 -40.416,69.167 -60.416,104.167c-12.084,19.167 -23.334,38.75 -35,59.167Z" style="fill-rule:nonzero;"/></g></svg> <strong>' + LEADERBOARD.player_count + ' DC Member Opponents</strong></span> <br /> Upgrade to Premium to gain access to your match history and gain insights into who and when you perform best.',
                buttons: [
                    {
                        action: function () {
                            return this.cancel();
                        },
                        secondary: true,
                        text: 'Continue'
                    },
                    {
                        action: function () {
                            return window.open(MY_URL + '/membership');
                        },
                        text: 'Upgrade Now'
                    }
                ],
                id: 'welcome'
            }
        }
    },

    oneSection: function () {
        const oneSectionTour = new Shepherd.Tour({
            defaultStepOptions: {
                cancelIcon: {
                    enabled: true
                },
                scrollTo: {
                    behavior: 'smooth',
                    block: 'center'
                },
            },
            steps: [
                WALKTROUGH_PERSONAL.guestSection(),
                {
                    title: 'Welcome to <br /> YOUR Opponent Leaderboard!',
                    text: 'This leaderboard tracks and displays all YOUR opponents who have a DartConnect Membership. Now you can determine how well you compete overall, as well as against individual players. <div class="pro-tip rotate-tip"><strong>Pro Tip:</strong> <br/> <div>To see more stats, rotate your device.</div> <img src="/images/rotate-smartphone.svg" style="margin-top: 2px; width: 28px; height: 28px;" /></div>',
                    buttons: [
                        {
                            action: function () {
                                return this.back();
                            },
                            secondary: true,
                            text: 'Back'
                        },
                        {
                            action: function () {
                                return this.next();
                            },
                            text: 'Next'
                        }
                    ],
                    id: 'welcome'
                },
                WALKTHROUGH_GENERAL.headerSection(),
                {
                    title: 'Your Opponents',
                    text: 'Opponents are listed according to frequency of match play. To performance rank them, select a column header. <br /><br /> <strong>Current Opponent ' + global_3da_label + '</strong> is their last 100 legs against ANY player. When selecting this column, DC will identify which players perform better against YOU, marking their average against you with a green arrow. <br /><br /> <i>Pro Tip: Star & Group players to create a specific list of opponents.</i>',
                    attachTo: {
                        element: '#introjs-sec1',
                        on: 'right-start'
                    },
                    buttons: [
                        {
                            action: function () {
                                return this.back();
                            },
                            secondary: true,
                            text: 'Back'
                        },
                        {
                            action: function () {
                                return this.next();
                            },
                            text: 'Next'
                        }
                    ],
                    id: 'sec1'
                },
                WALKTHROUGH_GENERAL.columnHeaders(),
                WALKTHROUGH_GENERAL.clickOnPlayerForChart('td.a3-ml'),
                WALKTHROUGH_GENERAL.helpSection(),
                WALKTHROUGH_GENERAL.explainStartWalkthroughButton(),
            ],
            useModalOverlay: true,
        });


        if (!localStorage.getItem('personalIntroOneSectionTourV3')) {
            $('#introjs-sec2').hide();
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            oneSectionTour.start();
        }

        ['close', 'cancel', 'complete'].forEach(event => oneSectionTour.on(event, () => {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').hide();

            localStorage.setItem('personalIntroOneSectionTourV3', 'dismissed');
        }));

        $('#resetWalkthrough').click(function () {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            oneSectionTour.start();
        });
    },

    allSections: function () {
        const allSectionsTour = new Shepherd.Tour({
            defaultStepOptions: {
                cancelIcon: {
                    enabled: true
                },
                scrollTo: {
                    behavior: 'smooth',
                    block: 'center'
                },
            },
            steps: [
                WALKTROUGH_PERSONAL.guestSection(),
                {
                    title: 'Welcome to <br /> YOUR Opponent Leaderboard!',
                    text: 'This leaderboard tracks and displays all YOUR opponents who have a DartConnect Membership. Now you can determine how well you compete overall, as well as against individual players. <div class="pro-tip rotate-tip"><strong>Pro Tip:</strong> <br/> <div>To see more stats, rotate your device.</div> <img src="/images/rotate-smartphone.svg" style="margin-top: 2px; width: 28px; height: 28px;" /></div>',
                    buttons: [
                        {
                            action: function () {
                                return this.back();
                            },
                            secondary: true,
                            text: 'Back'
                        },
                        {
                            action: function () {
                                return this.next();
                            },
                            text: 'Next'
                        }
                    ],
                    id: 'welcome'
                },
                WALKTHROUGH_GENERAL.headerSection(),
                {
                    title: 'Your Opponents',
                    text: 'Opponents are listed according to frequency of match play. To performance rank them, select a column header. <br /><br /> <strong>Current Opponent ' + global_3da_label + '</strong> is their last 100 legs against ANY player. When selecting this column, DC will identify which players perform better against YOU, marking their average against you with a green arrow. <br /><br /> <i>Pro Tip: Star & Group players to create a specific list of opponents.</i>',
                    attachTo: {
                        element: '#introjs-sec1',
                        on: 'right-start'
                    },
                    buttons: [
                        {
                            action: function () {
                                return this.back();
                            },
                            secondary: true,
                            text: 'Back'
                        },
                        {
                            action: function () {
                                return this.next();
                            },
                            text: 'Next'
                        }
                    ],
                    id: 'sec1'
                },
                {
                    title: 'Opponent Performance',
                    text: 'Select the header for each performance column to rank your opponents darts against you.',
                    attachTo: {
                        element: '#introjs-sec2',
                        on: 'right-start'
                    },
                    buttons: [
                        {
                            action: function () {
                                return this.back();
                            },
                            secondary: true,
                            text: 'Back'
                        },
                        {
                            action: function () {
                                return this.next();
                            },
                            text: 'Next'
                        }
                    ],
                    id: 'sec2'
                },
                {
                    title: 'YOUR Performance Section',
                    text: 'Select any column to determine when and how you perform the best against your opponents.',
                    attachTo: {
                        element: '#introjs-sec3',
                        on: 'right-start'
                    },
                    buttons: [
                        {
                            action: function () {
                                return this.back();
                            },
                            secondary: true,
                            text: 'Back'
                        },
                        {
                            action: function () {
                                return this.next();
                            },
                            text: 'Next'
                        }
                    ],
                    id: 'sec3'
                },
                WALKTHROUGH_GENERAL.columnHeaders(),
                WALKTHROUGH_GENERAL.clickOnPlayerForChart('td.a3-ml'),
                WALKTHROUGH_GENERAL.helpSection(),
                WALKTHROUGH_GENERAL.explainStartWalkthroughButton(),
            ],
            useModalOverlay: true,
        });


        if (!localStorage.getItem('personalIntroAllSectionsTourV3')) {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            allSectionsTour.start();
        }

        ['close', 'cancel', 'complete'].forEach(event => allSectionsTour.on(event, () => {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').hide();

            localStorage.setItem('personalIntroAllSectionsTourV3', 'dismissed');
        }));

        $('#resetWalkthrough').click(function () {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            allSectionsTour.start();
        });
    }
}

var WALKTROUGH_LEAGUE = {

    oneSection: function () {
        const oneSectionTour = new Shepherd.Tour({
            defaultStepOptions: {
                cancelIcon: {
                    enabled: true
                },
                scrollTo: {
                    behavior: 'smooth',
                    block: 'center'
                },
                popperOptions: {
                    modifiers: [{name: 'offset', options: {offset: [25, 10]}}]
                },
            },
            steps: [
                {
                    title: 'Welcome to the LEAGUE <br /> Performance Leaderboard!',
                    text: 'This leaderboard tracks and displays the performance of all league players throughout the season. <div class="pro-tip rotate-tip"><strong>Pro Tip:</strong> <br/> <div>To see more stats, rotate your device.</div> <img src="/images/rotate-smartphone.svg" style="margin-top: 2px; width: 28px; height: 28px;" /></div>',
                    // attachTo: {
                    // 	element: '.hero-welcome',
                    // 	on: 'bottom'
                    // },
                    buttons: [
                        {
                            action: function () {
                                return this.cancel();
                            },
                            secondary: true,
                            text: 'Exit'
                        },
                        {
                            action: function () {
                                return this.next();
                            },
                            text: 'Start'
                        }
                    ],
                    id: 'welcome'
                },
                WALKTHROUGH_GENERAL.headerSection(),
                WALKTHROUGH_GENERAL.playerSection(),
                WALKTHROUGH_GENERAL.clickOnPlayerForChart('td.a3'),
                WALKTHROUGH_GENERAL.helpSection(),
                WALKTHROUGH_GENERAL.explainStartWalkthroughButton(),
            ],
            useModalOverlay: true,
        });

        if (!localStorage.getItem('introLeagueOneSectionTourV3')) {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            oneSectionTour.start();
        }

        ['close', 'cancel', 'complete'].forEach(event => oneSectionTour.on(event, () => {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').hide();

            localStorage.setItem('introLeagueOneSectionTourV3', 'dismissed');
        }));

        $('#resetWalkthrough').click(function () {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            oneSectionTour.start();
        });
    },

    allSections: function () {
        const allSectionsTour = new Shepherd.Tour({
            defaultStepOptions: {
                cancelIcon: {
                    enabled: true
                },
                scrollTo: {
                    behavior: 'smooth',
                    block: 'center'
                },
                popperOptions: {
                    modifiers: [{name: 'offset', options: {offset: [25, 10]}}]
                },
            },
            steps: [
                {
                    title: 'Welcome to the LEAGUE <br /> Performance Leaderboard!',
                    text: 'This leaderboard tracks and displays the performance of all league players throughout the season. <div class="pro-tip rotate-tip"><strong>Pro Tip:</strong> <br/> <div>To see more stats, rotate your device.</div> <img src="/images/rotate-smartphone.svg" style="margin-top: 2px; width: 28px; height: 28px;" /></div>',
                    // attachTo: {
                    // 	element: '.hero-welcome',
                    // 	on: 'bottom'
                    // },
                    buttons: [
                        {
                            action: function () {
                                return this.cancel();
                            },
                            secondary: true,
                            text: 'Exit'
                        },
                        {
                            action: function () {
                                return this.next();
                            },
                            text: 'Start'
                        }
                    ],
                    id: 'welcome'
                },
                WALKTHROUGH_GENERAL.headerSection(),
                WALKTHROUGH_GENERAL.playerSection(),
                WALKTHROUGH_GENERAL.performanceSection(),
                WALKTHROUGH_GENERAL.matchLegSection(),
                WALKTHROUGH_GENERAL.statisticsSection(),
                WALKTHROUGH_GENERAL.columnHeaders(),
                WALKTHROUGH_GENERAL.clickOnPlayerForChart('td.a3'),
                WALKTHROUGH_GENERAL.helpSection(),
                WALKTHROUGH_GENERAL.explainStartWalkthroughButton(),
            ],
            useModalOverlay: true,
        });

        if (!localStorage.getItem('introLeagueThreeSectionTourV3')) {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            allSectionsTour.start();
        }

        ['close', 'cancel', 'complete'].forEach(event => allSectionsTour.on(event, () => {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').hide();

            localStorage.setItem('introLeagueThreeSectionTourV3', 'dismissed');
        }));

        $('#resetWalkthrough').click(function () {
            $('#introjs-header, #introjs-sec1, #introjs-sec2, #introjs-sec3').show();
            allSectionsTour.start();
        });
    },
}

var WALKTHROUGH_GENERAL = {
    headerSection() {
        return {
            title: 'Leaderboard Overview',
            text: 'Use <strong>Filters</strong>, <strong>Activity</strong> and <strong>Game Menus</strong> to refine your search. The <strong>Alphabet Bar</strong> allows you to quickly find opponents.',
            attachTo: {
                element: '#introjs-header',
                on: 'bottom'
            },
            buttons: [
                {
                    action: function () {
                        return this.back();
                    },
                    secondary: true,
                    text: 'Back'
                },
                {
                    action: function () {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'sec1'
        };
    },

    playerSection() {
        return {
            title: 'Player Section',
            text: 'Select the <strong>Player Column</strong> to sort by last name or use the <strong>Alphabet Bar</strong> to quickly find a player. <br /><br /> <div class="pro-tip"><strong>Pro Tip:</strong> <br/> <div style="display: flex;align-items: center; margin-top: 2px;"><svg style="width: 20px;height: 20px;align-self: center; flex-shrink: 0; margin-right: 9px;" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg> Star your favorite players and group them, to pin them at the top of the chart.</div></div>',
            attachTo: {
                element: '#introjs-sec1',
                on: 'right-start'
            },
            buttons: [
                {
                    action: function () {
                        return this.back();
                    },
                    secondary: true,
                    text: 'Back'
                },
                {
                    action: function () {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'sec1'
        };
    },

    performanceSection() {
        return {
            title: 'Performance Section',
            text: 'Over 30 performance metrics are available for every player!',
            attachTo: {
                element: '#introjs-sec2',
                on: 'right-start'
            },
            buttons: [
                {
                    action: function () {
                        return this.back();
                    },
                    secondary: true,
                    text: 'Back'
                },
                {
                    action: function () {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'sec2'
        };
    },

    helpSection() {
        return {
            title: 'Need Help?',
            text: 'Use the <strong>Info Button</strong> to find out more about each column and performance metric.',
            attachTo: {
                element: '#explain-columns',
                on: 'left-start'
            },
            popperOptions: {
                modifiers: [{name: 'offset', options: {offset: [0, 5]}}]
            },
            buttons: [
                {
                    action: function () {
                        return this.back();
                    },
                    secondary: true,
                    text: 'Back'
                },
                {
                    action: function () {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'info'
        };
    },

    matchLegSection() {
        var ppr_label;
        var ppr_short_label;
        var ppr_desc;

        if (LEADERBOARD.report_dart_avg_units == 'PPR') {
            ppr_label = 'O-3DA';
            ppr_short_label = '3DA';
            ppr_desc = 'Opponent 3 Dart Avg';
        } else {
            ppr_label = 'O-1DA';
            ppr_short_label = '1DA';
            ppr_desc = 'Opponent 1 Dart Avg';
        }

        return {
            title: 'Match / Leg Section',
            text: 'Review players win / loss record <br /><br /> <div class="pro-tip"><strong>Pro Tip:</strong><br />Select <strong>' + ppr_label + '</strong> (' + ppr_desc + ') to rank players by their opponents collective <strong>' + ppr_short_label + '</strong> (3 Dart Average).</div>',
            attachTo: {
                element: '#introjs-sec3',
                on: 'left-start'
            },
            buttons: [
                {
                    action: function () {
                        return this.back();
                    },
                    secondary: true,
                    text: 'Back'
                },
                {
                    action: function () {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'sec3'
        };
    },

    columnHeaders() {
        return {
            title: 'Column Headers',
            text: 'Select any column header to rank players by that performance metric.',
            attachTo: {
                element: '.column_label_row',
                on: 'bottom'
            },
            popperOptions: {
                modifiers: [{name: 'offset', options: {offset: [0, 5]}}]
            },
            buttons: [
                {
                    action: function () {
                        return this.back();
                    },
                    secondary: true,
                    text: 'Back'
                },
                {
                    action: function () {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'column_label_row'
        };
    },

    statisticsSection() {
        return {
            title: 'Statistics',
            text: 'Each section contains multiple performance groups. Use the red / gold arrow buttons to advance to the next group.',
            attachTo: {
                element: '.thead_sections.bluesection',
                on: 'bottom'
            },
            popperOptions: {
                modifiers: [{name: 'offset', options: {offset: [0, 5]}}]
            },
            buttons: [
                {
                    action: function () {
                        return this.back();
                    },
                    secondary: true,
                    text: 'Back'
                },
                {
                    action: function () {
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'bluesection'
        };
    },

    clickOnPlayerForChart(element) {
        return {
            title: 'Match Performance Chart',
            text: 'Select any opponent to display a performance graph and access your match history with this player.',
            attachTo: {
                element: element,
                on: 'bottom'
            },
            scrollToHandler: function (e) {
                $('html, body').animate({
                    scrollTop: $(e).offset().top - 200
                }, 1000, function () {
                    if (element === 'td.a3-ml') {
                        $(element + '.lblink:first').click();
                    } else {
                        $(element + ':first span').click();
                    }
                });
            },
            // popperOptions: {
            // 	modifiers: [{name: 'offset', options: {offset: [0, 5]}}]
            // },
            buttons: [
                {
                    action: function () {
                        return this.back();
                    },
                    secondary: true,
                    text: 'Back'
                },
                {
                    action: function () {
                        if (element === 'td.a3-ml') {
                            $(element + '.lblink:first').click();
                        } else {
                            $(element + ':first span').click();
                        }
                        return this.next();
                    },
                    text: 'Next'
                }
            ],
            id: 'bluesection'
        };
    },

    explainStartWalkthroughButton() {
        return {
            title: 'Walk Through',
            text: 'Repeat this overview anytime. All the Best!',
            attachTo: {
                element: '#resetWalkthrough',
                on: 'bottom'
            },
            popperOptions: {
                modifiers: [{name: 'offset', options: {offset: [0, 5]}}]
            },
            buttons: [
                {
                    action: function () {
                        return this.back();
                    },
                    secondary: true,
                    text: 'Back'
                },
                {
                    action: function () {
                        return this.next();
                    },
                    text: 'End'
                }
            ],
            id: 'bluesection'
        };
    },
}

var ICONS = {
    lock() {
        return '<span class="inline-flex justify-center items-center text-gray-500 tooltip"><svg class="w-4 h-4" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M4 8V6a6 6 0 1 1 12 0v2h1a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-8c0-1.1.9-2 2-2h1zm5 6.73V17h2v-2.27a2 2 0 1 0-2 0zM7 6v2h6V6a3 3 0 0 0-6 0z"></path></svg><span class="flex flex-col tooltip-text bg-blue-200 leading-tight px-3 py-2 rounded" style="text-shadow: none;"><span>Unlock by upgrading to Premium.</span><a href="https://www.dartconnect.com/how-to/#renew-extend-subscription" target="_blank">Learn How</a></span></span>';
    },
};


function init_page(data) {

    var html;
    var refresh_rate = 300000;

    /*
	if ((SETTINGS.event_id == 'a_pdc2017') && (LOCSTORENABLED)) {
		refresh_rate = (1000 * 60 * 10);
	}
	*/

    // refresh_rate = 10000000000000; // for testing only

    if (LEADERBOARD.event_info) {

        if (SETTINGS.game_filter_vals.game_type == '01') {

            $('#01legend').show();
            $('#cricketLegend').hide();

            $('.legend_01').show();

            if (SETTINGS.event_type == 'L') {
                if (LEADERBOARD.event_info.dart_dist_class == '20') {
                    $('.legend_dist20').show();
                } else {
                    $('.legend_dist19').show();
                }
            } else {
                $('.legend_dist20').show();
            }

            $('.legend_cricket').hide();

            if (LEADERBOARD.report_dart_avg_units == 'PPR') {
                $('.dca_unit').html('3DA');
                $('.not3da').hide();
            } else {
                $('.dca_unit').html('1DA');
                $('.not1da').hide();
            }

        } else {

            $('#01legend').hide();
            $('#cricketLegend').show();

            $('.legend_01, .legend_dist20, .legend_dist19').hide();
            $('.legend_cricket').show();

            $('.dca_unit').html('MPR');
        }

        if ((SETTINGS.event_id.substring(0, 2) == 't_') || (SETTINGS.event_id.substring(0, 2) == 'a_')) {
            $('.hi-fiish-legend').html('<span class="legendLabel ">TC:</span> Tournament Count');
        }

        setBreadcrumbs();

        if (LEADERBOARD.event_info.info_url) {
            $('.header-right').click(function () {
                location.href = LEADERBOARD.event_info.info_url;
            });
        }

        if (LEADERBOARD.event_info.logo_url) {
            $('<img/>').attr('src', LEADERBOARD.event_info.logo_url).on('load', function () {
                $(this).remove();
                $('.header-right').css('background-image', "url('" + LEADERBOARD.event_info.logo_url + "')");
            });
        }

        switch (SETTINGS.event_type) {
            case 'T':
                $('.who').html(LEADERBOARD.event_info.dctv_title);
                $('#showcard_event_name').val(LEADERBOARD.event_info.dctv_title);

                if ((SETTINGS.event_id.substring(0, 2) == 't_') || (SETTINGS.event_id.substring(0, 2) == 'a_')) {
                    $('.when').html(LEADERBOARD.event_info.tour_header);
                    $('.when').show();

                    if (LEADERBOARD.event_info.tour_tagline) {
                        $('.tagline').html(LEADERBOARD.event_info.tour_tagline);
                        $('.tagline').show();
                    }

                    if (LEADERBOARD.event_info.leaderboard_footer) {
                        $('.footer_description').html(LEADERBOARD.event_info.leaderboard_footer);
                        $('.footer_description').show();
                    }

                    if (LEADERBOARD.events_list) {

                        if (LEADERBOARD.events_list.length > 1) {
                            html = '<span style="font-size: 26px; display: block;">' + LEADERBOARD.events_list.length + ' Competitions:</span><br>';
                        } else {
                            html = '<span style="font-size: 26px; display: block;">Competition:</span> ';
                        }

                        for (var tli = 0; tli < LEADERBOARD.events_list.length; tli++) {
                            if (tli > 0) {
                                if (tli == (LEADERBOARD.events_list.length - 1)) {
                                    html += ' •  ';
                                } else {
                                    html += ' • ';
                                }
                            }
                            html += LEADERBOARD.events_list[tli].event_name;
                        }

                        $('.footer_events_list').html(html);
                        $('.footer_events_list').show();
                    }

                } else {
                    if (LEADERBOARD.event_info.event_dates) {
                        $('.when').html(LEADERBOARD.event_info.event_dates);
                        $('.when').show();
                    } else {
                        $('.when').html('');
                        $('.when').hide();
                    }
                }

                document.title = $('.who').text() + ' ' + $('.when').text() + ' - DartConnect';

                $('#group_leaderboard .legend_tournament').show();
                $('#group_leaderboard .legend_league').hide();

                if (LEADERBOARD.event_info.suppress_match_results == 'Y') {
                    $('.results_pending').show();
                }

                if (SETTINGS.event_id.substring(0, 2) == 't_') {
                    // Tour
                    $('#dctvLink').attr('href', BACK_PREFIX + '/menu');
                    $('#dctvLink-mobile').attr('href', BACK_PREFIX + '/menu');
                } else if (SETTINGS.event_id.substring(0, 2) == 'a_') {
                    // Affiiate
                    $('#dctvLink').hide();
                    $('#dctvLink-mobile').hide();
                } else {
                    // Tournament
                    $('#dctvLink').attr('href', BACK_PREFIX + '/menu#t-' + SETTINGS.event_id);
                    $('#dctvLink-mobile').attr('href', BACK_PREFIX + '/menu#t-' + SETTINGS.event_id);
                }


                break;

            case 'L':
                document.title = LEADERBOARD.event_info.league_name + ' ' + LEADERBOARD.event_info.season + ' - DartConnect';

                $('.who').html(LEADERBOARD.event_info.league_name);
                $('.when').html(LEADERBOARD.event_info.season);
                $('.when').show(); // Hide Season

                if (LEADERBOARD.event_info.league_type == 'SINGLES') {
                    $('.legend_singles_league').show();
                } else {
                    $('.legend_team_league').show();
                }

                $('#group_leaderboard .legend_tournament').hide();
                $('#group_leaderboard .legend_league').show();

                $('#dctvLink').attr('href', BACK_PREFIX + '/menu#l-' + LEADERBOARD.event_info.league_id);
                $('#dctvLink-mobile').attr('href', BACK_PREFIX + '/menu#l-' + LEADERBOARD.event_info.league_id);

                break;

            case 'P':
                $('.header-center-ml').show();
                $('.header-center').hide();
                $('.regular-logo').hide();
                $('.personal-leaderboard-logo').show();

                if (LEADERBOARD.member_level !== 'P') {
                    $('#tooltips').remove();
                }

                if (LEADERBOARD.member_level === 'P' && LEADERBOARD.my_dca) {
                    $('.your_dca').html(LEADERBOARD.my_dca);
                    $('.tooltip_all_opp_dca').html(LEADERBOARD.all_op_xpr);
                } else {
                    $('.your_dca').html('<span class="flex text-white tooltip"><svg class="w-8 h-8" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M4 8V6a6 6 0 1 1 12 0v2h1a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-8c0-1.1.9-2 2-2h1zm5 6.73V17h2v-2.27a2 2 0 1 0-2 0zM7 6v2h6V6a3 3 0 0 0-6 0z"></path></svg><span class="flex flex-col tooltip-text bg-blue-200 text-base leading-tight px-3 py-2 mt-8 -ml-20 rounded"><span>Unlock by upgrading to Premium.</span><a href="https://www.dartconnect.com/how-to/#renew-extend-subscription" target="_blank">Learn How</a></span></span>');
                }

                $('.who').html(LEADERBOARD.event_info.first_name);
                $('.first_name_label').html(LEADERBOARD.event_info.first_name);
                $('.player_count').html(LEADERBOARD.player_count);
                if (LEADERBOARD.member_level === 'P') {
                    $('.all_op_xpr').html(LEADERBOARD.all_op_xpr);
                    $('.total_opponents').html(LEADERBOARD.player_count);
                    $('.total_matches').html(LEADERBOARD.dataset.map(s => s.matches).reduce((sum, current) => sum + current, 0));
                } else {
                    $('.all_op_xpr').html('<span class="flex text-white tooltip"><svg class="w-8 h-8" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M4 8V6a6 6 0 1 1 12 0v2h1a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-8c0-1.1.9-2 2-2h1zm5 6.73V17h2v-2.27a2 2 0 1 0-2 0zM7 6v2h6V6a3 3 0 0 0-6 0z"></path></svg><span class="flex flex-col tooltip-text bg-blue-200 text-base leading-tight px-3 py-2 mt-8 -ml-20 rounded"><span>Unlock by upgrading to Premium.</span><a href="https://www.dartconnect.com/how-to/#renew-extend-subscription" target="_blank">Learn How</a></span></span>');
                    $('.total_opponents').html('<span class="flex text-white tooltip"><svg class="w-8 h-8" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M4 8V6a6 6 0 1 1 12 0v2h1a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-8c0-1.1.9-2 2-2h1zm5 6.73V17h2v-2.27a2 2 0 1 0-2 0zM7 6v2h6V6a3 3 0 0 0-6 0z"></path></svg><span class="flex flex-col tooltip-text bg-blue-200 text-base leading-tight px-3 py-2 mt-8 -ml-20 rounded"><span>Unlock by upgrading to Premium.</span><a href="https://www.dartconnect.com/how-to/#renew-extend-subscription" target="_blank">Learn How</a></span></span>');
                    $('.total_matches').html('<span class="flex text-white tooltip"><svg class="w-8 h-8" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M4 8V6a6 6 0 1 1 12 0v2h1a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-8c0-1.1.9-2 2-2h1zm5 6.73V17h2v-2.27a2 2 0 1 0-2 0zM7 6v2h6V6a3 3 0 0 0-6 0z"></path></svg><span class="flex flex-col tooltip-text bg-blue-200 text-base leading-tight px-3 py-2 mt-8 -ml-20 rounded"><span>Unlock by upgrading to Premium.</span><a href="https://www.dartconnect.com/how-to/#renew-extend-subscription" target="_blank">Learn How</a></span></span>');
                }
                $('.current_game_type').html(LEADERBOARD.game_legend);
                $('.selected_activity').html(LEADERBOARD.event_headline);
                $('.month_period').html(getHistVal(SETTINGS.finish));

                $('#dctvLink').attr('href', BACK_PREFIX + '/menu');
                $('#dctvLink-mobile').attr('href', BACK_PREFIX + '/menu');

                document.title = LEADERBOARD.event_info.first_name + '\'s Leaderboard - DartConnect';

                break;

            default:
                break;
        }
    }

    spinner.stop();
    $('#footer').show();
    $('#loading_msg').hide();
    $('#mask').hide();

    if (SETTINGS.event_type == 'P') {
        $('#group_leaderboard').remove();
        $('#my_leaderboard').show();
    } else {
        $('#my_leaderboard').remove();
        $('#group_leaderboard').show();
    }

    if (SETTINGS.filterCount() > 0) {
        $('.reset_home_filters').show();
    } else {
        $('.reset_home_filters').hide();
    }

    init_handlers();
    $('.mobile-menus li:has(ul)').doubleTapToGo();

    switch (SETTINGS.event_type) {
        case 'T':

            if ((SETTINGS.event_id.substring(0, 2) == 't_') || (SETTINGS.event_id.substring(0, 2) == 'a_')) {
                // No refresh for tour and affiliate boards
                // $('#header-table').css('background', '#000');
                $('#header-table').addClass('black-header');
                $('.who').css('text-shadow', 'initial');
            } else {
                SYNCTIMER = setInterval(function () {
                    if ((!SETTINGS.subFiltersOpen) && (!LEADERBOARD.last_state.accordion_open)) {
                        LEADERBOARD.getStats();
                    }
                }, refresh_rate);
            }

            if (window.matchMedia("(orientation: portrait)").matches) {
                if ($(window).width() < 480) {
                    WALKTHROUGH_PORTRAIT.tip();
                } else {
                    WALKTROUGH_TOURNAMENT.oneSection();
                }
            }

            if (window.matchMedia("(orientation: landscape)").matches) {
                WALKTROUGH_TOURNAMENT.allSections();
            }

            break;

        case 'L':

            if (window.matchMedia("(orientation: portrait)").matches) {
                if ($(window).width() < 480) {
                    WALKTHROUGH_PORTRAIT.tip();
                } else {
                    WALKTROUGH_LEAGUE.oneSection();
                }
            }

            if (window.matchMedia("(orientation: landscape)").matches) {
                WALKTROUGH_LEAGUE.allSections();
            }

            break;
        case 'P':

            if (window.matchMedia("(orientation: portrait)").matches) {
                if ($(window).width() < 480) {
                    WALKTHROUGH_PORTRAIT.tip();
                } else {
                    WALKTROUGH_PERSONAL.oneSection();
                }
            }

            if (window.matchMedia("(orientation: landscape)").matches) {
                WALKTROUGH_PERSONAL.allSections();
            }

            break;
    }

    // Adjust title based on size
    if ($('.who').html().length > 25) {
        $('.who').addClass('small-title');
    }

    LEADERBOARD.saveState();


}


function setBanners() {
    // Ad Banners
    var banner = getBanner();

    if (banner) {
        AB_small = banner.small_url;
        AB_large = banner.large_url;
        AB_link = banner.link;
        AB_class = banner.adclass;

        if (AB_link) {
            AD_ROW = '<tr class="dynmsg"><td colspan="15" class="dyn_msg"><a href="' + AB_link + '" target="_blank"><picture><source media="(min-width: 799px)" srcset="' + AB_large + '" style="width:100%;" class="banner-img pdc-affiliate-leaderboard-ad"><img src="' + AB_small + '" style="width:100%;" class="banner-img ' + AB_class + '"></picture></a></td></tr>';
        } else {
            AD_ROW = '<tr class="dynmsg"><td colspan="15" class="dyn_msg"><picture><source media="(min-width: 799px)" srcset="' + AB_large + '" style="width:100%;" class="banner-img pdc-affiliate-leaderboard-ad"><img src="' + AB_small + '" style="width:100%;" class="banner-img ' + AB_class + '"></picture></td></tr>';
        }

        if (SETTINGS.event_id == 'a_target2018') {
            AD_ROW = '<tr class="dynmsg"><td colspan="15" class="dyn_msg"><a href="http://www.target-darts.co.uk/" target="_blank"><picture><source media="(min-width: 799px)" srcset="/images/banner-large-target.jpg" style="width:100%;" class="banner-img pdc-affiliate-leaderboard-ad"><img src="/images/banner-small-target.jpg" style="width:100%;" class="banner-img"></picture></a></td></tr>';
        }
        if (SETTINGS.event_id == 'a_winmau2018') {
            AD_ROW = '<tr class="dynmsg"><td colspan="15" class="dyn_msg"><a href="http://www.winmau.com/" target="_blank"><picture><source media="(min-width: 799px)" srcset="/images/banner-large-winmau.jpg" style="width:100%;" class="banner-img pdc-affiliate-leaderboard-ad"><img src="/images/banner-small-winmau.jpg" style="width:100%;" class="banner-img"></picture></a></td></tr>';
        }

        if ((SETTINGS.event_id == 'a_pdc2017') || (SETTINGS.event_id == 'a_napowerindex2018')) {
            AD_ROW2 = AD_ROW;
        } else {
            AD_ROW2 = '<tr class="dynmsg"><td colspan="15" class="dyn_msg"><a href="http://dartconnect.com/join.php" target="_blank"><picture><source media="(max-width: 599px)" srcset="/images/dartconnect-leaderboard-mobile.jpg"><source media="(min-width: 600px)" srcset="/images/dartconnect-leaderboard.jpg"><img src="/images/dartconnect-leaderboard.jpg" width="100%"></picture></a></td></tr>';
        }
    }
}


function getBanner() {
    var banners = [];

    if (SETTINGS.event_id === 'wsdtqs21') {
        banners.push({
            small_url: 'https://dartconnect.com/b/target-corona-small.jpg',
            large_url: 'https://dartconnect.com/b/target-corona-large.jpg',
            link: 'https://bit.ly/3C7eioy',
            adclass: 'other-target-corona',
        });
        return banners[Math.floor(Math.random() * banners.length)];
    } else if (SETTINGS.event_id == 'a_target2020') {
        banners.push({
            small_url: 'https://www.dartconnect.com/b/target-products-small.jpg',
            large_url: 'https://www.dartconnect.com/b/target-products-large.jpg',
            link: 'https://bit.ly/2RSpSQ6',
            adclass: 'other-target-products'
        });
    } else if (SETTINGS.event_type === 'P' && LEADERBOARD.member_level !== 'P') {
        banners.push({
            small_url: 'https://www.dartconnect.com/b/premium-upgrade-small.jpg',
            large_url: 'https://www.dartconnect.com/b/premium-upgrade-large.jpg',
            link: 'https://www.dartconnect.com/players/why-upgrade-to-premium/',
            adclass: 'other-premium-upgrade'
        });
    } else if (TOURCARD_WINNERS_MODE) {
        if (SETTINGS.event_id == 't_125') {
            banners.push({
                small_url: 'https://www.dartconnect.com/b/2021-pdc-q-school-leaderboard-small.jpg',
                large_url: 'https://www.dartconnect.com/b/2021-pdc-q-school-leaderboard-large.jpg',
                link: '',
                adclass: ''
            });
        }

        if (SETTINGS.event_id == 't_187') {
            banners.push({
                small_url: 'https://www.dartconnect.com/b/2022-pdc-q-school-leaderboard-small.jpg',
                large_url: 'https://www.dartconnect.com/b/2022-pdc-q-school-leaderboard-large.jpg',
                link: '',
                adclass: ''
            });
        }

        if (SETTINGS.event_id == 't_348') {
            banners.push({
                small_url: 'https://www.dartconnect.com/b/2023-pdc-q-school-leaderboard-small.jpg',
                large_url: 'https://www.dartconnect.com/b/2023-pdc-q-school-leaderboard-large.jpg',
                link: '',
                adclass: ''
            });
        }

        if (SETTINGS.event_id == 't_636') {
            banners.push({
                small_url: 'https://dartconnect.com/b/2024-pdc-q-school-leaderboard-small.jpg',
                large_url: 'https://dartconnect.com/b/2024-pdc-q-school-leaderboard-large.jpg',
                link: '',
                adclass: ''
            });
        }
    } else if (SETTINGS.event_id.includes('y9y7')) {
        banners.push({
            small_url: 'https://dartconnect.com/b/winmau-blade5-small.jpg',
            large_url: 'https://dartconnect.com/b/winmau-blade5-large.jpg',
            link: 'https://www.reddragondarts.com/winmau-blade-5-dual-core-dartboard-z0068',
            adclass: 'other-winmau-blade5'
        });

        banners.push({
            small_url: 'https://www.dartconnect.com/b/reddragon-back-to-back-wc-small.jpg',
            large_url: 'https://www.dartconnect.com/b/reddragon-back-to-back-wc-large.jpg',
            link: 'https://www.reddragondarts.com/brochure',
            adclass: 'other-reddragon-back-to-back'
        });
    }

    if (banners.length > 0) {
        return banners[Math.floor(Math.random() * banners.length)];
    }

    $.ajax({
        url: 'https://tvold.dartconnect.com/corsapi/insignes',
        type: 'POST',
        cache: false,
        timeout: 20000,
        async: false,
        dataType: 'json',
        processData: true,
        data: {
            type: 'leaderboard',
            item_id: '',
            channels: LEADERBOARD.event_info.audience,
        },
        success: function (data) {
            if (data.status == 'OK') {
                banners = data.payload;
                return;
            } else {
                return;
            }
        },
        error: function (a, b, c) {
            return;
        }
    });

    return banners[Math.floor(Math.random() * banners.length)];
}

function positiveOrNegative(sortIds, firstValue, secondValue, format = null) {
    var triangleUp = '<span class="inline-flex justify-center lg:w-3"><svg xmlns="http://www.w3.org/2000/svg" class="triangle flex-shrink-0 inline-flex w-2 h-2 lg:w-2.5 lg:h-2.5 text-green-400 ml-0.5 lg:ml-1" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.022 1.566a1.13 1.13 0 0 1 1.96 0l6.857 11.667c.457.778-.092 1.767-.98 1.767H1.144c-.889 0-1.437-.99-.98-1.767L7.022 1.566z"/></svg></span>';
    var triangleDown = '<span class="inline-flex justify-center lg:w-3"><svg xmlns="http://www.w3.org/2000/svg" class="triangle flex-shrink-0 transform -rotate-180 inline-flex w-2 h-2 lg:w-2.5 lg:h-2.5 text-pink-500 ml-0.5 lg:ml-1" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.022 1.566a1.13 1.13 0 0 1 1.96 0l6.857 11.667c.457.778-.092 1.767-.98 1.767H1.144c-.889 0-1.437-.99-.98-1.767L7.022 1.566z"/></svg></span>';

    if (LEADERBOARD.member_level === 'P') {
        if (sortIds.includes(LEADERBOARD.current_sort)) {
            if (firstValue == '-' && secondValue == '-') {
                return '<span> <span class="lg:w-10 justify-end inline-flex">' + firstValue + '</span> <span class="inline-flex w-3 h-1 opacity-0"></span></span>';
            } else if (secondValue == '-') {
                if (format == 'formatMissPer') {
                    firstValue = formatMissPer(firstValue, '%');
                }

                return '<span> <span class="lg:w-10 justify-end inline-flex">' + firstValue + '</span> <span class="inline-flex w-3 h-1 opacity-0"></span></span>';
            } else if (parseFloat(firstValue) > parseFloat(secondValue)) {
                if (format == 'formatMissPer') {
                    firstValue = formatMissPer(firstValue, '%');
                }

                return '<span><span class="lg:w-10 justify-end inline-flex">' + firstValue + '</span>  ' + triangleUp + '</span>';
            } else if (parseFloat(firstValue) < parseFloat(secondValue)) {
                if (format == 'formatMissPer') {
                    firstValue = formatMissPer(firstValue, '%');
                }

                if (sortIds.includes('op_dca')) {
                    return '<span><span class="lg:w-10 justify-end inline-flex">' + firstValue + '</span><span class="inline-flex justify-center lg:w-3.5 opacity-0"><svg xmlns="http://www.w3.org/2000/svg" class="triangle flex-shrink-0 inline-flex w-2 h-2 lg:w-2.5 lg:h-2.5 text-green-400 ml-0.5 lg:ml-1" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.022 1.566a1.13 1.13 0 0 1 1.96 0l6.857 11.667c.457.778-.092 1.767-.98 1.767H1.144c-.889 0-1.437-.99-.98-1.767L7.022 1.566z"/></svg></span></span>';
                } else {
                    return '<span><span class="lg:w-10 justify-end inline-flex">' + firstValue + '</span>  ' + triangleDown + '</span>';
                }
            }
        }

        if (format == 'formatMissPer') {
            firstValue = formatMissPer(firstValue, '%');
        }

        return firstValue;
    } else {
        return ICONS.lock();
    }
}

function legWinPostiveOrNegative(sortIds, value, format = null) {
    var triangleUp = '<span class="inline-flex justify-center lg:w-3"><svg xmlns="http://www.w3.org/2000/svg" class="triangle flex-shrink-0 inline-flex w-2 h-2 lg:w-2.5 lg:h-2.5 text-green-400 ml-0.5 lg:ml-1" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.022 1.566a1.13 1.13 0 0 1 1.96 0l6.857 11.667c.457.778-.092 1.767-.98 1.767H1.144c-.889 0-1.437-.99-.98-1.767L7.022 1.566z"/></svg></span>';
    var triangleDown = '<span class="inline-flex justify-center lg:w-3"><svg xmlns="http://www.w3.org/2000/svg" class="triangle flex-shrink-0 transform -rotate-180 inline-flex w-2 h-2 lg:w-2.5 lg:h-2.5 text-pink-500 ml-0.5 lg:ml-1" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.022 1.566a1.13 1.13 0 0 1 1.96 0l6.857 11.667c.457.778-.092 1.767-.98 1.767H1.144c-.889 0-1.437-.99-.98-1.767L7.022 1.566z"/></svg></span>';

    if (LEADERBOARD.member_level === 'P') {
        if (sortIds.includes(LEADERBOARD.current_sort)) {
            if (value == '-') {
                return '<span> <span class="justify-end inline-flex">' + value + '</span> <span class="inline-flex w-3 h-1 opacity-0"></span></span>';
            } else if (parseFloat(value) > 0.5) {
                value = formatMissPer(value, '%');

                return '<span><span class="lg:w-10 justify-end inline-flex">' + value + '</span>  ' + triangleUp + '</span>';
            } else if (parseFloat(value) < 0.5) {
                value = formatMissPer(value, '%');

                return '<span><span class="lg:w-10 justify-end inline-flex">' + value + '</span>  ' + triangleDown + '</span>';
            }
        }

        return formatMissPer(value, '%');
    } else {
        return ICONS.lock();
    }
}

function showTooltip(value) {
    $("#tooltips").children().hide();
    $('#' + value + '_tooltip').fadeIn();
}

function maybePluralize(count, noun, suffix = 's') {
    var niceNoun = count !== 1 ? suffix : '';
    return noun + niceNoun;
}
