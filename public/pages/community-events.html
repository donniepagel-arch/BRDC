<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Community Events - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FF469A">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap');

        :root {
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --orange: #FF9800;
            --purple: #9C27B0;
            --green: #4CAF50;
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --text-light: #f0f0f0;
            --text-dim: #8a8aa3;
            --border-color: rgba(255,255,255,0.15);
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { min-height: 100%; overflow-x: hidden; width: 100%; }
        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            color: var(--text-light);
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Header */
        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .back-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--pink);
        }

        .header-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            letter-spacing: 2px;
            color: var(--yellow);
        }

        .add-event-btn {
            margin-left: auto;
            background: linear-gradient(180deg, var(--pink) 0%, #d63384 100%);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .add-event-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 70, 154, 0.4);
        }

        /* Main Layout */
        .page-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: calc(100vh - 73px);
        }

        @media (max-width: 900px) {
            .page-layout {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr;
                height: auto;
                min-height: calc(100vh - 73px);
            }

            .page-layout.show-map .map-container {
                display: block;
            }

            .page-layout.show-map .events-sidebar {
                display: none;
            }

            .page-layout:not(.show-map) .map-container {
                display: none;
            }

            .page-layout:not(.show-map) .events-sidebar {
                display: flex;
                min-height: calc(100vh - 140px);
            }
        }

        /* Mobile View Toggle */
        .mobile-view-toggle {
            display: none;
            padding: 12px 16px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
        }

        @media (max-width: 900px) {
            .mobile-view-toggle {
                display: flex;
                gap: 8px;
            }
        }

        .view-toggle-btn {
            flex: 1;
            padding: 10px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--text-dim);
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .view-toggle-btn.active {
            background: var(--teal);
            border-color: var(--teal);
            color: var(--bg-dark);
        }

        .view-toggle-btn:not(.active):hover {
            border-color: var(--teal);
            color: var(--text-light);
        }

        /* Map Container */
        .map-container {
            position: relative;
        }

        #eventsMap {
            width: 100%;
            height: 100%;
            min-height: 300px;
        }

        /* Map Legend */
        .map-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 12px;
            z-index: 500;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .legend-title {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.tournament { background: var(--pink); }
        .legend-dot.league { background: var(--teal); }
        .legend-dot.blind-draw { background: var(--orange); }
        .legend-dot.social { background: var(--green); }
        .legend-dot.other { background: var(--purple); }

        /* Events Sidebar */
        .events-sidebar {
            background: var(--bg-panel);
            border-left: 2px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @media (max-width: 900px) {
            .events-sidebar {
                border-left: none;
                border-top: 2px solid rgba(255,255,255,0.1);
            }
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 22px;
            color: var(--teal);
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        /* Filter Pills */
        .filter-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-pill {
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 10px 16px;
            min-height: 44px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-pill:hover {
            border-color: var(--teal);
        }

        .filter-pill.active {
            background: var(--teal);
            border-color: var(--teal);
            color: var(--bg-dark);
        }

        /* Events List */
        .events-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .event-card {
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .event-card:hover {
            border-color: var(--teal);
            transform: translateX(4px);
        }

        .event-card:last-child {
            margin-bottom: 0;
        }

        .event-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .event-type-badge {
            font-size: 9px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 4px;
            color: white;
        }

        .event-type-badge.tournament { background: var(--pink); }
        .event-type-badge.league { background: var(--teal); color: var(--bg-dark); }
        .event-type-badge.blind-draw { background: var(--orange); }
        .event-type-badge.social { background: var(--green); }
        .event-type-badge.other { background: var(--purple); }

        .event-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .dart-type-badge {
            font-size: 9px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.15);
            color: var(--text-light);
        }

        .dart-type-badge.steel { border: 1px solid #aaa; }
        .dart-type-badge.soft { border: 1px solid var(--teal); color: var(--teal); }
        .dart-type-badge.both { border: 1px solid var(--yellow); color: var(--yellow); }

        .recurring-badge {
            font-size: 9px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(156, 39, 176, 0.3);
            color: #ce93d8;
        }

        .event-date {
            font-size: 11px;
            color: var(--text-dim);
        }

        .event-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        .event-venue {
            font-size: 13px;
            color: var(--teal);
            margin-bottom: 4px;
        }

        .event-time {
            font-size: 12px;
            color: var(--text-dim);
        }

        .event-link {
            display: inline-block;
            margin-top: 10px;
            background: rgba(255,255,255,0.1);
            color: var(--yellow);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.15s;
        }

        .event-link:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .empty-state h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-panel);
            border-radius: 16px;
            border: 3px solid var(--pink);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.2s;
        }

        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 26px;
            color: var(--yellow);
            letter-spacing: 1px;
        }

        .modal-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-dim);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            padding: 20px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            font-size: 15px;
            color: var(--text-light);
            transition: all 0.15s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--teal);
            background: rgba(145, 215, 235, 0.05);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-hint {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .btn-cancel {
            flex: 1;
            padding: 14px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text-light);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-cancel:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-submit {
            flex: 2;
            padding: 14px;
            background: linear-gradient(180deg, var(--pink) 0%, #d63384 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 70, 154, 0.4);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .form-section-divider {
            text-align: center;
            margin: 20px 0 16px;
            position: relative;
        }

        .form-section-divider::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: var(--border-color);
        }

        .form-section-divider span {
            background: var(--bg-panel);
            padding: 0 12px;
            position: relative;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            font-weight: 700;
        }

        .image-upload-box {
            background: var(--bg-card);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.15s;
        }

        .image-upload-box:hover {
            border-color: var(--teal);
        }

        .image-upload-box span {
            display: block;
            font-size: 24px;
            margin-bottom: 4px;
        }

        .image-upload-box small {
            font-size: 11px;
        }

        /* Event Detail Modal */
        .event-detail-header {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .event-detail-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: var(--text-light);
            line-height: 1.1;
        }

        .event-detail-row {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .event-detail-icon {
            font-size: 20px;
            width: 28px;
            text-align: center;
            flex-shrink: 0;
        }

        .event-detail-content {
            flex: 1;
        }

        .event-detail-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 700;
            letter-spacing: 1px;
        }

        .event-detail-value {
            font-size: 15px;
            color: var(--text-light);
        }

        .event-detail-value a {
            color: var(--teal);
            text-decoration: none;
        }

        .event-detail-value a:hover {
            text-decoration: underline;
        }

        .event-detail-description {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 14px;
            margin-top: 16px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.5;
        }

        .event-detail-actions {
            margin-top: 20px;
            display: flex;
            gap: 12px;
        }

        .event-info-btn {
            flex: 1;
            padding: 14px;
            background: linear-gradient(180deg, var(--teal) 0%, #147a94 100%);
            border: none;
            border-radius: 8px;
            color: var(--bg-dark);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: all 0.15s;
        }

        .event-info-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(145, 215, 235, 0.4);
        }

        .event-directions-btn {
            padding: 14px 20px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text-light);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s;
        }

        .event-directions-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .submitted-by {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-dim);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--teal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Leaflet customizations */
        .leaflet-popup-content-wrapper {
            background: var(--bg-panel);
            color: var(--text-light);
            border-radius: 8px;
        }

        .leaflet-popup-tip {
            background: var(--bg-panel);
        }

        .leaflet-popup-content {
            margin: 12px;
        }

        .popup-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .popup-venue {
            font-size: 12px;
            color: var(--teal);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-bar">
        <a href="/pages/dashboard.html" class="back-btn">‚Üê BACK</a>
        <div class="header-title">COMMUNITY EVENTS</div>
        <button class="add-event-btn" onclick="showAddEventModal()">+ ADD EVENT</button>
    </div>

    <!-- Mobile View Toggle -->
    <div class="mobile-view-toggle">
        <button class="view-toggle-btn active" onclick="setMobileView('list')">
            <span>üìã</span> List View
        </button>
        <button class="view-toggle-btn" onclick="setMobileView('map')">
            <span>üó∫Ô∏è</span> Map View
        </button>
    </div>

    <!-- Main Layout -->
    <div class="page-layout" id="pageLayout">
        <!-- Map -->
        <div class="map-container">
            <div id="eventsMap"></div>
            <div class="map-legend">
                <div class="legend-title">Event Types</div>
                <div class="legend-item"><span class="legend-dot tournament"></span> Tournament</div>
                <div class="legend-item"><span class="legend-dot league"></span> League Night</div>
                <div class="legend-item"><span class="legend-dot blind-draw"></span> Blind Draw</div>
                <div class="legend-item"><span class="legend-dot social"></span> Social / Open Play</div>
                <div class="legend-item"><span class="legend-dot other"></span> Other</div>
            </div>
        </div>

        <!-- Events Sidebar -->
        <div class="events-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Upcoming Events</div>
                <div class="filter-pills" style="margin-bottom: 8px;">
                    <div class="filter-pill active" data-filter="all" data-filter-type="event">All</div>
                    <div class="filter-pill" data-filter="tournament" data-filter-type="event">Tournaments</div>
                    <div class="filter-pill" data-filter="league" data-filter-type="event">League</div>
                    <div class="filter-pill" data-filter="blind-draw" data-filter-type="event">Blind Draw</div>
                    <div class="filter-pill" data-filter="social" data-filter-type="event">Social</div>
                </div>
                <div class="filter-pills">
                    <div class="filter-pill active" data-filter="all" data-filter-type="dart">All Tips</div>
                    <div class="filter-pill" data-filter="steel" data-filter-type="dart">Steel</div>
                    <div class="filter-pill" data-filter="soft" data-filter-type="dart">Soft</div>
                </div>
            </div>
            <div class="events-list" id="eventsList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading events...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal-overlay" id="addEventModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add Community Event</div>
                <button class="modal-close" onclick="closeAddEventModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="addEventForm" onsubmit="submitEvent(event)">
                    <div class="form-group">
                        <label class="form-label">Event Name *</label>
                        <input type="text" class="form-input" id="eventName" required placeholder="e.g. Saturday Night Blind Draw">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Event Type *</label>
                            <select class="form-select" id="eventType" required>
                                <option value="">Select type...</option>
                                <option value="tournament">Tournament</option>
                                <option value="league">League Night</option>
                                <option value="blind-draw">Blind Draw</option>
                                <option value="social">Social / Open Play</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dart Type *</label>
                            <select class="form-select" id="dartType" required>
                                <option value="">Select...</option>
                                <option value="steel">Steel Tip</option>
                                <option value="soft">Soft Tip</option>
                                <option value="both">Both</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Frequency *</label>
                        <select class="form-select" id="eventFrequency" required onchange="toggleRecurringFields()">
                            <option value="once">One-time Event</option>
                            <option value="weekly">Weekly (repeats every week)</option>
                            <option value="biweekly">Bi-weekly (every 2 weeks)</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" id="dateLabel">Date *</label>
                            <input type="date" class="form-input" id="eventDate" required>
                            <div class="form-hint" id="dateHint" style="display: none;">First occurrence or next upcoming date</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Time *</label>
                            <input type="time" class="form-input" id="eventTime" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Venue Name *</label>
                        <input type="text" class="form-input" id="eventVenue" required placeholder="e.g. The Treehouse">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Address *</label>
                        <input type="text" class="form-input" id="eventAddress" required placeholder="e.g. 820 College Ave, Cleveland, OH 44113">
                        <div class="form-hint">Full address for map placement</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Event Info Link *</label>
                        <input type="url" class="form-input" id="eventLink" required placeholder="https://...">
                        <div class="form-hint">Official event page, Facebook event, etc.</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="eventDescription" placeholder="Entry fee, format, prizes, etc."></textarea>
                    </div>

                    <!-- Host/Organizer Section -->
                    <div class="form-section-divider">
                        <span>Host / Organizer (Optional)</span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Host Name</label>
                            <input type="text" class="form-input" id="hostName" placeholder="e.g. Cleveland Dart League">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Host Website</label>
                            <input type="url" class="form-input" id="hostUrl" placeholder="https://...">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Host Logo</label>
                            <div class="image-upload-box" id="hostLogoUpload" onclick="document.getElementById('hostLogoInput').click()">
                                <input type="file" id="hostLogoInput" accept="image/*" style="display: none;" onchange="handleHostLogoSelect(event)">
                                <div id="hostLogoPreview" style="display: none;">
                                    <img id="hostLogoPreviewImg" src="" alt="Logo preview" style="max-height: 60px; border-radius: 4px;">
                                    <button type="button" onclick="removeHostLogo(event)" style="margin-left: 8px; background: none; border: none; color: var(--danger); cursor: pointer;">‚úï</button>
                                </div>
                                <div id="hostLogoPlaceholder">
                                    <span>üì∑</span>
                                    <small>Tap to add logo</small>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Event Image</label>
                            <div class="image-upload-box" id="eventImageUpload" onclick="document.getElementById('eventImageInput').click()">
                                <input type="file" id="eventImageInput" accept="image/*" style="display: none;" onchange="handleEventImageSelect(event)">
                                <div id="eventImagePreview" style="display: none;">
                                    <img id="eventImagePreviewImg" src="" alt="Event preview" style="max-height: 60px; border-radius: 4px;">
                                    <button type="button" onclick="removeEventImage(event)" style="margin-left: 8px; background: none; border: none; color: var(--danger); cursor: pointer;">‚úï</button>
                                </div>
                                <div id="eventImagePlaceholder">
                                    <span>üñºÔ∏è</span>
                                    <small>Tap to add image</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Your Name</label>
                        <input type="text" class="form-input" id="submitterName" placeholder="Optional - who's submitting this">
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closeAddEventModal()">Cancel</button>
                        <button type="submit" class="btn-submit" id="submitEventBtn">Add Event</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div class="modal-overlay" id="eventDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="event-type-badge" id="detailEventType">Tournament</span>
                <button class="modal-close" onclick="closeEventDetailModal()">√ó</button>
            </div>
            <div class="modal-body" id="eventDetailBody">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyApov-xE5l1EJo0CADJ3OXP5aPvFmTmrZA",
            authDomain: "brdc-v2.firebaseapp.com",
            projectId: "brdc-v2",
            storageBucket: "brdc-v2.firebasestorage.app",
            messagingSenderId: "858304543457",
            appId: "1:858304543457:web:e119e7c6fb7d616ea57ba3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // State
        let map = null;
        let markers = [];
        let allEvents = [];
        let currentEventFilter = 'all';
        let currentDartFilter = 'all';
        let hostLogoFile = null;
        let eventImageFile = null;

        // Image upload handlers
        function handleHostLogoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { alert('Image must be less than 5MB'); return; }
            hostLogoFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('hostLogoPreviewImg').src = e.target.result;
                document.getElementById('hostLogoPreview').style.display = 'flex';
                document.getElementById('hostLogoPlaceholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
            event.stopPropagation();
        }

        function removeHostLogo(event) {
            event.stopPropagation();
            hostLogoFile = null;
            document.getElementById('hostLogoInput').value = '';
            document.getElementById('hostLogoPreview').style.display = 'none';
            document.getElementById('hostLogoPlaceholder').style.display = 'block';
        }

        function handleEventImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { alert('Image must be less than 5MB'); return; }
            eventImageFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('eventImagePreviewImg').src = e.target.result;
                document.getElementById('eventImagePreview').style.display = 'flex';
                document.getElementById('eventImagePlaceholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
            event.stopPropagation();
        }

        function removeEventImage(event) {
            event.stopPropagation();
            eventImageFile = null;
            document.getElementById('eventImageInput').value = '';
            document.getElementById('eventImagePreview').style.display = 'none';
            document.getElementById('eventImagePlaceholder').style.display = 'block';
        }

        async function uploadImage(file, folder) {
            const filename = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
            const storageRef = storage.ref(`${folder}/${filename}`);
            await storageRef.put(file);
            return await storageRef.getDownloadURL();
        }

        // Event type colors
        const eventColors = {
            'tournament': '#FF469A',
            'league': '#91D7EB',
            'blind-draw': '#FF9800',
            'social': '#4CAF50',
            'other': '#9C27B0'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadEvents();
            setupFilterListeners();
            setMinDate();
        });

        // Initialize map centered on Cleveland
        function initMap() {
            map = L.map('eventsMap').setView([41.4993, -81.6944], 11);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Set minimum date to today
        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('eventDate').min = today;
        }

        // Setup filter listeners
        function setupFilterListeners() {
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.addEventListener('click', () => {
                    const filterType = pill.dataset.filterType;

                    // Only deactivate pills of the same filter type
                    document.querySelectorAll(`.filter-pill[data-filter-type="${filterType}"]`).forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');

                    if (filterType === 'event') {
                        currentEventFilter = pill.dataset.filter;
                    } else if (filterType === 'dart') {
                        currentDartFilter = pill.dataset.filter;
                    }

                    renderEvents();
                    updateMapMarkers();
                });
            });
        }

        // Toggle recurring fields hint
        function toggleRecurringFields() {
            const frequency = document.getElementById('eventFrequency').value;
            const dateHint = document.getElementById('dateHint');
            const dateLabel = document.getElementById('dateLabel');

            if (frequency === 'once') {
                dateHint.style.display = 'none';
                dateLabel.textContent = 'Date *';
            } else {
                dateHint.style.display = 'block';
                dateLabel.textContent = 'Next Date *';
            }
        }

        // Load events from Firestore
        async function loadEvents() {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const snapshot = await db.collection('community_events')
                    .where('event_date', '>=', today)
                    .where('status', '==', 'approved')
                    .orderBy('event_date', 'asc')
                    .get();

                allEvents = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                renderEvents();
                updateMapMarkers();

            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('eventsList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3>Error Loading Events</h3>
                        <p>Please try refreshing the page.</p>
                    </div>
                `;
            }
        }

        // Render events list
        function renderEvents() {
            const container = document.getElementById('eventsList');

            let filteredEvents = allEvents;

            // Apply event type filter
            if (currentEventFilter !== 'all') {
                filteredEvents = filteredEvents.filter(e => e.event_type === currentEventFilter);
            }

            // Apply dart type filter
            if (currentDartFilter !== 'all') {
                filteredEvents = filteredEvents.filter(e =>
                    e.dart_type === currentDartFilter || e.dart_type === 'both'
                );
            }

            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <h3>No Upcoming Events</h3>
                        <p>Know of a dart event? Add it above!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredEvents.map(event => {
                const eventDate = event.event_date?.toDate ? event.event_date.toDate() : new Date(event.event_date);
                const dateStr = eventDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                const timeStr = formatTime(event.event_time);
                const dartTypeLabel = formatDartType(event.dart_type);
                const frequencyLabel = formatFrequency(event.frequency);

                return `
                    <div class="event-card" onclick="showEventDetail('${event.id}')">
                        <div class="event-card-header">
                            <div class="event-badges">
                                <span class="event-type-badge ${event.event_type}">${formatEventType(event.event_type)}</span>
                                <span class="dart-type-badge ${event.dart_type || 'steel'}">${dartTypeLabel}</span>
                                ${event.frequency && event.frequency !== 'once' ? `<span class="recurring-badge">${frequencyLabel}</span>` : ''}
                            </div>
                            <span class="event-date">${dateStr}</span>
                        </div>
                        <div class="event-name">${escapeHtml(event.name)}</div>
                        <div class="event-venue">${escapeHtml(event.venue)}</div>
                        <div class="event-time">${timeStr}</div>
                    </div>
                `;
            }).join('');
        }

        // Update map markers
        function updateMapMarkers() {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            let filteredEvents = allEvents;

            if (currentEventFilter !== 'all') {
                filteredEvents = filteredEvents.filter(e => e.event_type === currentEventFilter);
            }

            if (currentDartFilter !== 'all') {
                filteredEvents = filteredEvents.filter(e =>
                    e.dart_type === currentDartFilter || e.dart_type === 'both'
                );
            }

            filteredEvents.forEach(event => {
                if (event.lat && event.lng) {
                    const color = eventColors[event.event_type] || eventColors.other;

                    const icon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="
                            background: ${color};
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        "></div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    const marker = L.marker([event.lat, event.lng], { icon })
                        .addTo(map)
                        .bindPopup(`
                            <div class="popup-title">${escapeHtml(event.name)}</div>
                            <div class="popup-venue">${escapeHtml(event.venue)}</div>
                        `)
                        .on('click', () => showEventDetail(event.id));

                    markers.push(marker);
                }
            });

            // Fit bounds if we have markers
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Show event detail modal
        function showEventDetail(eventId) {
            const event = allEvents.find(e => e.id === eventId);
            if (!event) return;

            const eventDate = event.event_date?.toDate ? event.event_date.toDate() : new Date(event.event_date);
            const dateStr = eventDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const timeStr = formatTime(event.event_time);

            document.getElementById('detailEventType').className = `event-type-badge ${event.event_type}`;
            document.getElementById('detailEventType').textContent = formatEventType(event.event_type);

            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.address)}`;

            const dartTypeLabel = formatDartType(event.dart_type);
            const frequencyLabel = formatFrequency(event.frequency);
            const isRecurring = event.frequency && event.frequency !== 'once';

            document.getElementById('eventDetailBody').innerHTML = `
                <div class="event-detail-title">${escapeHtml(event.name)}</div>

                <div class="event-badges" style="margin-bottom: 16px;">
                    <span class="dart-type-badge ${event.dart_type || 'steel'}">${dartTypeLabel}</span>
                    ${isRecurring ? `<span class="recurring-badge">${frequencyLabel}</span>` : ''}
                </div>

                <div class="event-detail-row">
                    <span class="event-detail-icon">üìÖ</span>
                    <div class="event-detail-content">
                        <div class="event-detail-label">${isRecurring ? 'Schedule' : 'Date & Time'}</div>
                        <div class="event-detail-value">
                            ${isRecurring ? `Every ${getRecurringDay(eventDate, event.frequency)} at ${timeStr}` : `${dateStr} at ${timeStr}`}
                            ${isRecurring ? `<br><small style="color: var(--text-dim);">Next: ${dateStr}</small>` : ''}
                        </div>
                    </div>
                </div>

                <div class="event-detail-row">
                    <span class="event-detail-icon">üìç</span>
                    <div class="event-detail-content">
                        <div class="event-detail-label">Location</div>
                        <div class="event-detail-value">
                            <strong>${escapeHtml(event.venue)}</strong><br>
                            ${escapeHtml(event.address)}
                        </div>
                    </div>
                </div>

                ${event.host_name ? `
                    <div class="event-detail-row">
                        <span class="event-detail-icon">üéØ</span>
                        <div class="event-detail-content">
                            <div class="event-detail-label">Hosted By</div>
                            <div class="event-detail-value">
                                ${event.host_logo ? `<img src="${event.host_logo}" alt="" style="height: 32px; margin-right: 8px; vertical-align: middle; border-radius: 4px;">` : ''}
                                ${event.host_url ? `<a href="${escapeHtml(event.host_url)}" target="_blank">${escapeHtml(event.host_name)}</a>` : escapeHtml(event.host_name)}
                            </div>
                        </div>
                    </div>
                ` : ''}

                ${event.description ? `
                    <div class="event-detail-description">${escapeHtml(event.description)}</div>
                ` : ''}

                <div class="event-detail-actions">
                    <a href="${escapeHtml(event.event_link)}" target="_blank" class="event-info-btn">
                        View Event Info ‚Üí
                    </a>
                    <a href="${mapsUrl}" target="_blank" class="event-directions-btn">
                        Directions
                    </a>
                </div>

                ${event.submitted_by ? `
                    <div class="submitted-by">Added by ${escapeHtml(event.submitted_by)}</div>
                ` : ''}
            `;

            document.getElementById('eventDetailModal').classList.add('visible');
        }

        // Close event detail modal
        function closeEventDetailModal() {
            document.getElementById('eventDetailModal').classList.remove('visible');
        }

        // Show add event modal
        function showAddEventModal() {
            document.getElementById('addEventForm').reset();
            document.getElementById('addEventModal').classList.add('visible');
        }

        // Close add event modal
        function closeAddEventModal() {
            document.getElementById('addEventModal').classList.remove('visible');
            // Reset image uploads
            hostLogoFile = null;
            eventImageFile = null;
            document.getElementById('hostLogoInput').value = '';
            document.getElementById('eventImageInput').value = '';
            document.getElementById('hostLogoPreview').style.display = 'none';
            document.getElementById('hostLogoPlaceholder').style.display = 'block';
            document.getElementById('eventImagePreview').style.display = 'none';
            document.getElementById('eventImagePlaceholder').style.display = 'block';
        }

        // Submit new event
        async function submitEvent(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitEventBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';

            try {
                const address = document.getElementById('eventAddress').value.trim();

                // Geocode the address
                const coords = await geocodeAddress(address);

                // Upload images if provided
                let hostLogoUrl = null;
                let eventImageUrl = null;

                if (hostLogoFile) {
                    submitBtn.textContent = 'Uploading logo...';
                    hostLogoUrl = await uploadImage(hostLogoFile, 'community-events');
                }

                if (eventImageFile) {
                    submitBtn.textContent = 'Uploading image...';
                    eventImageUrl = await uploadImage(eventImageFile, 'community-events');
                }

                submitBtn.textContent = 'Saving...';

                const eventData = {
                    name: document.getElementById('eventName').value.trim(),
                    event_type: document.getElementById('eventType').value,
                    dart_type: document.getElementById('dartType').value,
                    frequency: document.getElementById('eventFrequency').value,
                    event_date: new Date(document.getElementById('eventDate').value + 'T00:00:00'),
                    event_time: document.getElementById('eventTime').value,
                    venue: document.getElementById('eventVenue').value.trim(),
                    address: address,
                    event_link: document.getElementById('eventLink').value.trim(),
                    description: document.getElementById('eventDescription').value.trim() || null,
                    submitted_by: document.getElementById('submitterName').value.trim() || null,
                    host_name: document.getElementById('hostName').value.trim() || null,
                    host_url: document.getElementById('hostUrl').value.trim() || null,
                    host_logo: hostLogoUrl,
                    event_image: eventImageUrl,
                    lat: coords?.lat || null,
                    lng: coords?.lng || null,
                    status: 'approved',  // Auto-approve for now; could add moderation later
                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('community_events').add(eventData);

                // Add to local array and re-render
                allEvents.push({
                    id: 'new',
                    ...eventData,
                    event_date: eventData.event_date
                });
                allEvents.sort((a, b) => {
                    const dateA = a.event_date?.toDate ? a.event_date.toDate() : new Date(a.event_date);
                    const dateB = b.event_date?.toDate ? b.event_date.toDate() : new Date(b.event_date);
                    return dateA - dateB;
                });

                renderEvents();
                updateMapMarkers();
                closeAddEventModal();

                alert('Event added! Thanks for sharing with the community.');

            } catch (error) {
                console.error('Error adding event:', error);
                alert('Error adding event. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Event';
            }
        }

        // Geocode address using Nominatim (free, no API key needed)
        async function geocodeAddress(address) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`,
                    { headers: { 'User-Agent': 'BRDC-Community-Events' } }
                );
                const data = await response.json();

                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            return null;
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function formatEventType(type) {
            const labels = {
                'tournament': 'Tournament',
                'league': 'League Night',
                'blind-draw': 'Blind Draw',
                'social': 'Social',
                'other': 'Other'
            };
            return labels[type] || type;
        }

        function formatDartType(type) {
            const labels = {
                'steel': 'Steel Tip',
                'soft': 'Soft Tip',
                'both': 'Steel & Soft'
            };
            return labels[type] || 'Steel Tip';
        }

        function formatFrequency(freq) {
            const labels = {
                'once': 'One-time',
                'weekly': 'Weekly',
                'biweekly': 'Bi-weekly',
                'monthly': 'Monthly'
            };
            return labels[freq] || '';
        }

        function formatTime(time) {
            if (!time) return '';
            const [hours, minutes] = time.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes} ${ampm}`;
        }

        function getRecurringDay(date, frequency) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = days[date.getDay()];

            if (frequency === 'weekly') {
                return dayName;
            } else if (frequency === 'biweekly') {
                return `other ${dayName}`;
            } else if (frequency === 'monthly') {
                const weekNum = Math.ceil(date.getDate() / 7);
                const ordinals = ['', '1st', '2nd', '3rd', '4th', '5th'];
                return `${ordinals[weekNum]} ${dayName} of the month`;
            }
            return dayName;
        }

        // Close modals on overlay click
        document.getElementById('addEventModal').addEventListener('click', (e) => {
            if (e.target.id === 'addEventModal') closeAddEventModal();
        });

        document.getElementById('eventDetailModal').addEventListener('click', (e) => {
            if (e.target.id === 'eventDetailModal') closeEventDetailModal();
        });

        // Mobile view toggle
        function setMobileView(view) {
            const layout = document.getElementById('pageLayout');
            const toggleBtns = document.querySelectorAll('.view-toggle-btn');

            toggleBtns.forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(view));
            });

            if (view === 'map') {
                layout.classList.add('show-map');
                // Invalidate map size after showing (Leaflet needs this)
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
            } else {
                layout.classList.remove('show-map');
            }
        }
    </script>
<script src="/js/nav-menu.js"></script>
</body>
</html>
