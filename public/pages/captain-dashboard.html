<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captain Dashboard - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/brdc-styles.css">
    <style>
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .header-logo {
            width: 40px;
            height: 40px;
            
        }
        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 3px;
            color: var(--pink);
        }
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            color: var(--yellow);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .team-name-text {
            cursor: pointer;
            transition: color 0.2s;
        }
        .team-name-text:hover {
            color: var(--teal);
        }
        .edit-icon {
            font-size: 24px;
            opacity: 0.5;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .edit-icon:hover {
            opacity: 1;
        }
        .team-name-input {
            font-family: 'Bebas Neue', cursive;
            font-size: 40px;
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--yellow);
            color: var(--yellow);
            padding: 5px 15px;
            width: 300px;
        }
        .league-name {
            font-size: 18px;
            color: var(--teal);
        }
        .record {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: white;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 12px 24px;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab:hover { background: rgba(255,255,255,0.1); }
        .tab.active {
            background: var(--yellow);
            color: black;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .roster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .roster-card {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 20px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
        }
        .roster-card.unavailable {
            border-color: #ef4444;
            opacity: 0.7;
        }
        .player-position {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--teal);
            margin-bottom: 5px;
        }
        .player-name-roster {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: white;
            margin-bottom: 10px;
        }
        .player-stats-mini {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }
        .stat-mini {
            background: rgba(0,0,0,0.3);
            padding: 8px;
            text-align: center;
        }
        .stat-mini-label { font-size: 11px; color: #aaa; }
        .stat-mini-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--yellow);
        }
        .player-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .action-btn {
            flex: 1;
            padding: 8px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            border: 2px solid var(--black);
            cursor: pointer;
        }
        .action-btn.replace { background: #ef4444; color: white; }

        .attendance-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding: 8px 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        .attendance-toggle-label {
            font-size: 12px;
            color: #aaa;
        }
        .attendance-switch {
            position: relative;
            width: 50px;
            height: 26px;
            cursor: pointer;
        }
        .attendance-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .attendance-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ef4444;
            border-radius: 26px;
            transition: 0.3s;
        }
        .attendance-slider:before {
            content: "";
            position: absolute;
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        .attendance-switch input:checked + .attendance-slider {
            background-color: #22c55e;
        }
        .attendance-switch input:checked + .attendance-slider:before {
            transform: translateX(24px);
        }
        .attendance-status {
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
        }
        .attendance-status.available { color: #22c55e; }
        .attendance-status.unavailable { color: #ef4444; }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }
        .schedule-table th, .schedule-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        .schedule-table th {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--teal);
            background: rgba(0,0,0,0.3);
        }
        .schedule-table tr:hover { background: rgba(255,255,255,0.05); }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-badge.scheduled { background: #3b82f6; color: white; }
        .status-badge.in_progress { background: var(--yellow); color: black; }
        .status-badge.completed { background: #22c55e; color: white; }

        .availability-indicator { display: flex; gap: 5px; }
        .avail-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .avail-dot.available { background: #22c55e; color: white; }
        .avail-dot.unavailable { background: #ef4444; color: white; }
        .avail-dot.unknown { background: #666; color: white; }

        .lineup-section {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 20px;
            margin-bottom: 20px;
        }
        .lineup-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--yellow);
            margin-bottom: 15px;
        }
        .lineup-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 10px;
            border-radius: 8px;
        }
        .lineup-position {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--teal);
            width: 30px;
        }
        .lineup-select {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 2px solid var(--black);
        }

        .notifications-list { max-height: 300px; overflow-y: auto; }
        .notification-item {
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-left: 4px solid var(--yellow);
            margin-bottom: 10px;
        }
        .notification-item.unread {
            border-left-color: var(--pink);
            background: rgba(255,70,154,0.1);
        }
        .notification-time { font-size: 12px; color: #aaa; }

        .subs-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .sub-card {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 15px;
        }
        .sub-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: white;
        }
        .sub-skill { font-size: 12px; color: var(--teal); text-transform: uppercase; }

        /* Level Badges */
        .level-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
            vertical-align: middle;
        }
        .level-badge.level-A { background: gold; color: #000; }
        .level-badge.level-B { background: silver; color: #000; }
        .level-badge.level-C { background: #cd7f32; color: #fff; }
        .level-badge.level-unknown { background: #666; color: #fff; }

        /* Sub Level Filters */
        .sub-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 16px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            border: 2px solid var(--black);
            background: rgba(0,0,0,0.3);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.1); }
        .filter-btn.active { background: var(--teal); color: black; }

        /* Fill-in Request UI */
        .fillin-request-section {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 20px;
            margin-bottom: 20px;
        }
        .fillin-section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--yellow);
            margin-bottom: 15px;
        }
        .pending-requests {
            margin-top: 20px;
        }
        .request-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--black);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .request-match {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--teal);
        }
        .request-status {
            padding: 4px 10px;
            font-size: 11px;
            font-weight: bold;
            border-radius: 12px;
        }
        .request-status.pending { background: var(--yellow); color: black; }
        .request-status.confirmed { background: #22c55e; color: white; }
        .response-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
        }
        .response-column {
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 4px;
        }
        .response-label {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .response-list { color: white; }
        .response-list.interested { color: #22c55e; }
        .response-list.declined { color: #ef4444; }

        /* Message Team Button */
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .header-action-btn {
            padding: 8px 16px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            border: 2px solid var(--black);
            cursor: pointer;
            transition: all 0.2s;
        }
        .header-action-btn.message-btn {
            background: var(--pink);
            color: white;
        }
        .header-action-btn.message-btn:hover { background: #d63384; }

        /* Checkbox list for subs selection */
        .sub-select-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .sub-select-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        .sub-select-item:hover { background: rgba(255,255,255,0.1); }
        .sub-select-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .sub-select-name {
            flex: 1;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
        }
        .sub-select-level {
            font-size: 11px;
            padding: 2px 6px;
            background: var(--teal);
            color: black;
            border-radius: 3px;
        }

        /* Channel checkboxes */
        .channel-options {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        .channel-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .channel-option input { width: 18px; height: 18px; }
        .channel-option label { cursor: pointer; }

        /* Free Agent Cards */
        .free-agent-card {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 15px;
            position: relative;
        }
        .free-agent-card.invited {
            border-color: var(--yellow);
            opacity: 0.7;
        }
        .free-agent-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: white;
        }
        .free-agent-level {
            display: inline-block;
            padding: 2px 8px;
            font-size: 11px;
            background: var(--teal);
            color: black;
            font-weight: bold;
            margin-top: 5px;
        }
        .free-agent-note {
            font-size: 12px;
            color: #aaa;
            margin-top: 8px;
            font-style: italic;
        }
        .invite-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: var(--pink);
            border: 2px solid var(--black);
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
        }
        .invite-btn:hover { background: #d63384; }
        .invite-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .invited-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--yellow);
            color: black;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: bold;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: linear-gradient(180deg, #1F85AF 0%, #001F4D 100%);
            border: 4px solid var(--black);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
        }
        .modal-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--yellow);
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .team-name { font-size: 32px; }
            .record { font-size: 24px; }
            .tabs {
                gap: 6px;
                overflow-x: auto;
                flex-wrap: nowrap;
                padding-bottom: 8px;
            }
            .tab {
                padding: 10px 14px;
                font-size: 14px;
                white-space: nowrap;
                flex-shrink: 0;
            }
            .roster-grid {
                grid-template-columns: 1fr;
            }
            .roster-card {
                padding: 16px;
            }
            .player-name-roster {
                font-size: 24px;
            }
            .schedule-table th,
            .schedule-table td {
                padding: 10px 8px;
                font-size: 13px;
            }
            .availability-indicator {
                flex-wrap: wrap;
            }
            .lineup-row {
                flex-wrap: wrap;
            }
            .lineup-select {
                width: 100%;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            .dashboard-header {
                flex-direction: column;
                text-align: center;
            }
            .dashboard-header > div:last-child {
                text-align: center;
            }
            .subs-list {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .team-name { font-size: 26px; }
            .record { font-size: 20px; }
            .header-title { font-size: 22px; }
            .tab {
                padding: 8px 12px;
                font-size: 12px;
            }
            .player-stats-mini {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }
            .stat-mini {
                padding: 6px;
            }
            .stat-mini-value {
                font-size: 18px;
            }
            .schedule-table th,
            .schedule-table td {
                padding: 8px 6px;
                font-size: 12px;
            }
            .schedule-table th:nth-child(5),
            .schedule-table td:nth-child(5),
            .schedule-table th:nth-child(6),
            .schedule-table td:nth-child(6) {
                display: none;
            }
            .lineup-title {
                font-size: 20px;
            }
            .brdc-btn, .action-btn {
                padding: 10px 16px;
                font-size: 14px;
            }
        }

        /* Accessibility - Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus Indicators */
        :focus-visible {
            outline: 2px solid var(--yellow);
            outline-offset: 2px;
        }

        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--yellow);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <header class="header-bar" role="banner">
        <button class="back-btn" onclick="history.back()" aria-label="Go back to previous page">← BACK</button>
        <img src="/images/gold_logo.png" alt="Burning River Dart Club" class="header-logo">
        <h1 class="header-title">CAPTAIN DASHBOARD</h1>
    </header>

    <!-- Login Modal - hidden by default, shown only if no valid session -->
    <div class="modal-overlay" id="loginModal" role="dialog" aria-modal="true" aria-labelledby="loginModalTitle">
        <div class="modal-content">
            <h2 class="modal-title" id="loginModalTitle">Captain Login</h2>
            <label for="loginEmail" class="sr-only">Email Address</label>
            <input type="email" id="loginEmail" placeholder="Email Address" class="brdc-input" style="margin-bottom: 15px;" aria-required="true">
            <button class="brdc-btn" onclick="captainLogin()" style="width: 100%;">LOGIN</button>
            <button class="brdc-btn brdc-btn-secondary" onclick="window.location.href='/pages/dashboard.html'" style="width: 100%; margin-top: 10px;">CANCEL</button>
        </div>
    </div>

    <!-- Fill-in Request Modal -->
    <div class="modal-overlay" id="fillinModal">
        <div class="modal-content">
            <div class="modal-title">Send Fill-in Request</div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #aaa;">Position Needing Fill-in</label>
                <select id="fillinPosition" class="brdc-select">
                    <option value="A">A Level</option>
                    <option value="B">B Level</option>
                    <option value="C">C Level</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #aaa;">Select Match</label>
                <select id="fillinMatch" class="brdc-select"></select>
            </div>
            <div style="margin-bottom: 10px;">
                <label style="display: block; margin-bottom: 5px; color: #aaa;">Select Subs to Contact</label>
                <div class="sub-filters" id="fillinSubFilters">
                    <button class="filter-btn active" onclick="filterFillinSubs('ALL')">ALL</button>
                    <button class="filter-btn" onclick="filterFillinSubs('A')">A</button>
                    <button class="filter-btn" onclick="filterFillinSubs('B')">B</button>
                    <button class="filter-btn" onclick="filterFillinSubs('C')">C</button>
                </div>
            </div>
            <div class="sub-select-list" id="fillinSubList"></div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #aaa;">Custom Message (optional)</label>
                <textarea id="fillinMessage" class="brdc-input" rows="3" placeholder="Leave blank for default message"></textarea>
            </div>
            <div style="display: flex; gap: 15px;">
                <button class="brdc-btn brdc-btn-secondary" onclick="closeFillinModal()" style="flex: 1;">CANCEL</button>
                <button class="brdc-btn" onclick="sendFillinRequests()" style="flex: 1;">SEND REQUESTS</button>
            </div>
        </div>
    </div>

    <!-- Team Message Modal -->
    <div class="modal-overlay" id="messageModal">
        <div class="modal-content">
            <div class="modal-title">Message Team</div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #aaa;">Recipients</label>
                <div class="sub-select-list" id="messageRecipientList" style="max-height: 200px;"></div>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #aaa;">Send Via</label>
                <div class="channel-options">
                    <label class="channel-option">
                        <input type="checkbox" id="channelSms" checked>
                        <span>SMS</span>
                    </label>
                    <label class="channel-option">
                        <input type="checkbox" id="channelEmail">
                        <span>Email</span>
                    </label>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #aaa;">Message</label>
                <textarea id="teamMessage" class="brdc-input" rows="4" placeholder="Enter your message..."></textarea>
            </div>
            <div style="display: flex; gap: 15px;">
                <button class="brdc-btn brdc-btn-secondary" onclick="closeMessageModal()" style="flex: 1;">CANCEL</button>
                <button class="brdc-btn" onclick="sendTeamMessage()" style="flex: 1;">SEND</button>
            </div>
        </div>
    </div>

    <!-- Replace Player Modal -->
    <div class="modal-overlay" id="replaceModal">
        <div class="modal-content">
            <div class="modal-title">Replace Player</div>
            <p style="margin-bottom: 15px;">Select a replacement for <strong id="replacePlayerName">-</strong></p>
            <select id="replacementSelect" class="brdc-select" style="margin-bottom: 15px;"></select>
            <input type="text" id="replaceReason" placeholder="Reason (optional)" class="brdc-input" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 15px;">
                <button class="brdc-btn brdc-btn-secondary" onclick="closeReplaceModal()" style="flex: 1;">CANCEL</button>
                <button class="brdc-btn" onclick="confirmReplacement()" style="flex: 1;">CONFIRM</button>
            </div>
        </div>
    </div>

    <div class="dashboard-container" id="dashboardContent" style="display: none;">
        <div class="dashboard-header">
            <div>
                <div class="team-name">
                    <span class="team-name-text" id="teamName" onclick="startEditTeamName()">Loading...</span>
                    <span class="edit-icon" onclick="startEditTeamName()">✏️</span>
                    <input type="text" class="team-name-input" id="teamNameInput" style="display: none;"
                           onblur="saveTeamName()" onkeypress="if(event.key==='Enter') saveTeamName()">
                </div>
                <div class="league-name" id="leagueName">-</div>
            </div>
            <div class="header-actions">
                <button class="header-action-btn message-btn" onclick="openMessageModal()">MESSAGE TEAM</button>
                <div style="text-align: right;">
                    <div class="record" id="teamRecord">0-0</div>
                    <div style="font-size: 14px; color: #aaa;">Games: <span id="gamesRecord">0-0</span></div>
                </div>
            </div>
        </div>

        <nav class="tabs" role="tablist" aria-label="Captain dashboard sections">
            <button class="tab active" role="tab" aria-selected="true" aria-controls="tab-roster" onclick="showTab('roster', event)">ROSTER</button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="tab-schedule" onclick="showTab('schedule', event)">SCHEDULE</button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="tab-lineup" onclick="showTab('lineup', event)">SET LINEUP</button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="tab-subs" onclick="showTab('subs', event)">SUBSTITUTES</button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="tab-freeagents" id="freeAgentsTab" onclick="showTab('freeagents', event)" style="display: none;">FREE AGENTS</button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="tab-notifications" onclick="showTab('notifications', event)">ALERTS <span id="alertCount" aria-label="alert count"></span></button>
        </nav>

        <!-- Roster Tab -->
        <section class="tab-content active" id="tab-roster" role="tabpanel" aria-label="Team roster">
            <div class="roster-grid" id="rosterGrid">
                <div style="text-align: center; color: #aaa; padding: 40px;">Loading roster...</div>
            </div>
        </div>

        <!-- Schedule Tab -->
        <section class="tab-content" id="tab-schedule" role="tabpanel" aria-label="Match schedule">
            <div style="overflow-x: auto;">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Week</th>
                            <th>Date</th>
                            <th>Opponent</th>
                            <th>Status</th>
                            <th>Score</th>
                            <th>Availability</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Lineup Tab -->
        <section class="tab-content" id="tab-lineup" role="tabpanel" aria-label="Set lineup">
            <div class="lineup-section">
                <div class="lineup-title">Select Match</div>
                <select id="lineupMatchSelect" class="brdc-select" onchange="loadLineupForMatch()" style="margin-bottom: 20px;">
                    <option value="">Select upcoming match...</option>
                </select>
                <div id="lineupBuilder" style="display: none;">
                    <div class="lineup-title">Set Your Lineup</div>
                    <div id="lineupRows"></div>
                    <button class="brdc-btn" onclick="saveLineup()" style="margin-top: 20px;">SAVE LINEUP</button>
                </div>
            </div>
        </div>

        <!-- Subs Tab -->
        <section class="tab-content" id="tab-subs" role="tabpanel" aria-label="Substitutes">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px;">
                <div class="sub-filters" id="subFilters">
                    <button class="filter-btn active" data-level="ALL" onclick="filterSubs('ALL', this)">ALL</button>
                    <button class="filter-btn" data-level="A" onclick="filterSubs('A', this)">A</button>
                    <button class="filter-btn" data-level="B" onclick="filterSubs('B', this)">B</button>
                    <button class="filter-btn" data-level="C" onclick="filterSubs('C', this)">C</button>
                </div>
                <button class="brdc-btn" onclick="openFillinModal()">SEND FILL-IN REQUEST</button>
            </div>
            <div class="subs-list" id="subsList"></div>

            <!-- Pending Fill-in Requests Section -->
            <div class="pending-requests" id="pendingRequestsSection" style="display: none;">
                <div class="fillin-section-title">Pending Fill-in Requests</div>
                <div id="pendingRequestsList"></div>
            </div>
        </div>

        <!-- Free Agents Tab -->
        <section class="tab-content" id="tab-freeagents" role="tabpanel" aria-label="Free agents">
            <div style="margin-bottom: 20px;">
                <div style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--teal); margin-bottom: 10px;">
                    Available Free Agents
                </div>
                <div style="font-size: 14px; color: #aaa;">
                    Invite players to join your team. They'll receive a notification and can accept or decline.
                </div>
            </div>
            <div class="subs-list" id="freeAgentsList"></div>
        </div>

        <!-- Notifications Tab -->
        <section class="tab-content" id="tab-notifications" role="tabpanel" aria-label="Alerts and notifications">
            <div class="notifications-list" id="notificationsList"></div>
        </div>

        <div style="margin-top: 30px; text-align: center;">
            <button class="brdc-btn brdc-btn-secondary" onclick="logout()">LOGOUT</button>
        </div>
    </div>

    <script type="module">
        import { callFunction } from '/js/firebase-config.js';

        let dashboardData = null;
        let currentLeagueId = null;
        let currentTeamId = null;
        let captainEmail = null;
        let replacePlayerId = null;

        const params = new URLSearchParams(window.location.search);
        currentLeagueId = params.get('league_id');

        // Check for saved session FIRST before showing login
        const savedSession = localStorage.getItem('captainSession');
        if (savedSession) {
            const session = JSON.parse(savedSession);
            captainEmail = session.email;
            currentTeamId = session.teamId;
            currentLeagueId = session.leagueId || currentLeagueId;

            // Validate the session
            (async () => {
                try {
                    const result = await callFunction('getCaptainDashboard', {
                        league_id: currentLeagueId,
                        team_id: currentTeamId,
                        captain_email: captainEmail
                    });
                    if (result.success) {
                        dashboardData = result;
                        document.getElementById('dashboardContent').style.display = 'block';
                        renderDashboard();
                        return; // Session valid, don't show login
                    }
                } catch (error) {
                    console.error('Session check failed:', error);
                }
                // Session invalid, clear it and show login
                localStorage.removeItem('captainSession');
                captainEmail = null;
                currentTeamId = null;
                document.getElementById('loginModal').classList.add('active');
            })();
        } else {
            // No saved session, show login modal
            document.getElementById('loginModal').classList.add('active');
        }

        window.captainLogin = async function() {
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            if (!email) { alert('Please enter your email'); return; }

            try {
                const result = await callFunction('captainLogin', { league_id: currentLeagueId, email });
                if (result.success) {
                    captainEmail = email;
                    currentTeamId = result.team.id;
                    currentLeagueId = currentLeagueId || result.league_id;
                    localStorage.setItem('captainSession', JSON.stringify({ email: captainEmail, teamId: currentTeamId, leagueId: currentLeagueId }));
                    loadDashboard();
                } else {
                    alert(result.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
            }
        };

        window.logout = function() {
            localStorage.removeItem('captainSession');
            location.reload();
        };

        async function loadDashboard() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('dashboardContent').style.display = 'block';

            try {
                const result = await callFunction('getCaptainDashboard', { league_id: currentLeagueId, team_id: currentTeamId, captain_email: captainEmail });
                if (result.success) {
                    dashboardData = result;
                    renderDashboard();
                } else {
                    alert(result.error || 'Failed to load dashboard');
                }
            } catch (error) {
                console.error('Load dashboard error:', error);
                alert('Failed to load dashboard');
            }
        }

        function renderDashboard() {
            const { team, league, matches, player_stats, available_subs, free_agents, notifications, pending_fillin_requests } = dashboardData;

            document.getElementById('teamName').textContent = team.team_name || '(Set Team Name)';
            document.getElementById('leagueName').textContent = formatLeagueName(league.league_name);
            document.getElementById('teamRecord').textContent = `${team.wins || 0}-${team.losses || 0}${(team.ties || 0) > 0 ? '-' + team.ties : ''}`;
            document.getElementById('gamesRecord').textContent = `${team.games_won || 0}-${team.games_lost || 0}`;

            // Show free agents tab if league allows and team has open spots
            const hasOpenSpots = (team.roster_count || 0) < (team.max_roster || 4);
            if (league.league_mode === 'team' && (league.allow_free_agents || free_agents?.length > 0)) {
                document.getElementById('freeAgentsTab').style.display = 'block';
            }

            renderRoster(team, player_stats);
            renderSchedule(matches, team);
            renderLineupMatches(matches);
            renderSubs(available_subs);
            renderFreeAgents(free_agents || [], team);
            renderNotifications(notifications);

            // Load pending fill-in requests
            if (pending_fillin_requests && pending_fillin_requests.length > 0) {
                pendingFillinRequests = pending_fillin_requests;
                document.getElementById('pendingRequestsSection').style.display = 'block';
                renderPendingRequests();
            }
        }

        // Team name editing
        window.startEditTeamName = function() {
            const nameSpan = document.getElementById('teamName');
            const nameInput = document.getElementById('teamNameInput');
            const currentName = dashboardData?.team?.team_name || '';

            nameSpan.style.display = 'none';
            document.querySelector('.edit-icon').style.display = 'none';
            nameInput.style.display = 'block';
            nameInput.value = currentName;
            nameInput.focus();
            nameInput.select();
        };

        window.saveTeamName = async function() {
            const nameSpan = document.getElementById('teamName');
            const nameInput = document.getElementById('teamNameInput');
            const newName = nameInput.value.trim();

            nameSpan.style.display = 'inline';
            document.querySelector('.edit-icon').style.display = 'inline';
            nameInput.style.display = 'none';

            if (!newName || newName === dashboardData?.team?.team_name) return;

            try {
                const result = await callFunction('updateTeamName', {
                    league_id: currentLeagueId,
                    team_id: currentTeamId,
                    captain_email: captainEmail,
                    team_name: newName
                });

                if (result.success) {
                    dashboardData.team.team_name = newName;
                    nameSpan.textContent = newName;
                } else {
                    alert(result.error || 'Failed to update team name');
                }
            } catch (error) {
                console.error('Update team name error:', error);
                alert('Failed to update team name');
            }
        };

        // Free agents rendering
        function renderFreeAgents(freeAgents, team) {
            const list = document.getElementById('freeAgentsList');
            if (!freeAgents || freeAgents.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #aaa; padding: 40px;">No free agents available</div>';
                return;
            }

            const hasOpenSpots = (team.roster_count || 0) < (team.max_roster || 4);

            list.innerHTML = freeAgents.map(fa => {
                const alreadyInvited = fa.invites_received?.includes(currentTeamId);
                return `
                    <div class="free-agent-card ${alreadyInvited ? 'invited' : ''}">
                        ${alreadyInvited ? '<span class="invited-badge">INVITED</span>' : ''}
                        <div class="free-agent-name">${fa.name}</div>
                        ${fa.skill_level ? `<span class="free-agent-level">${fa.skill_level}</span>` : ''}
                        ${fa.note ? `<div class="free-agent-note">"${fa.note}"</div>` : ''}
                        <button class="invite-btn" onclick="inviteFreeAgent('${fa.id}', '${fa.name}')"
                                ${!hasOpenSpots || alreadyInvited ? 'disabled' : ''}>
                            ${alreadyInvited ? 'INVITE SENT' : (hasOpenSpots ? 'INVITE TO TEAM' : 'ROSTER FULL')}
                        </button>
                    </div>
                `;
            }).join('');
        }

        window.inviteFreeAgent = async function(freeAgentId, freeAgentName) {
            if (!confirm(`Send team invite to ${freeAgentName}?`)) return;

            try {
                const result = await callFunction('sendTeamInvite', {
                    league_id: currentLeagueId,
                    team_id: currentTeamId,
                    captain_email: captainEmail,
                    free_agent_id: freeAgentId
                });

                if (result.success) {
                    alert(`Invite sent to ${freeAgentName}!`);
                    // Update UI
                    const fa = dashboardData.free_agents?.find(f => f.id === freeAgentId);
                    if (fa) {
                        fa.invites_received = fa.invites_received || [];
                        fa.invites_received.push(currentTeamId);
                    }
                    renderFreeAgents(dashboardData.free_agents || [], dashboardData.team);
                } else {
                    alert(result.error || 'Failed to send invite');
                }
            } catch (error) {
                console.error('Invite error:', error);
                alert('Failed to send invite');
            }
        };

        // Toggle player attendance for a match
        window.toggleAttendance = async function(playerId, matchId, isAvailable) {
            const statusEl = document.getElementById(`status-${playerId}`);
            const card = statusEl?.closest('.roster-card');

            // Optimistic UI update
            if (statusEl) {
                statusEl.textContent = isAvailable ? 'IN' : 'OUT';
                statusEl.className = `attendance-status ${isAvailable ? 'available' : 'unavailable'}`;
            }
            if (card) {
                card.classList.toggle('unavailable', !isAvailable);
            }

            try {
                const result = await callFunction('setPlayerAvailability', {
                    league_id: currentLeagueId,
                    match_id: matchId,
                    player_id: playerId,
                    available: isAvailable
                });

                if (!result.success) {
                    // Revert on failure
                    const checkbox = card?.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = !isAvailable;
                    if (statusEl) {
                        statusEl.textContent = isAvailable ? 'OUT' : 'IN';
                        statusEl.className = `attendance-status ${isAvailable ? 'unavailable' : 'available'}`;
                    }
                    if (card) card.classList.toggle('unavailable', isAvailable);
                    alert(result.error || 'Failed to update availability');
                } else {
                    // Update local data
                    const match = dashboardData?.matches?.find(m => m.id === matchId);
                    if (match) {
                        match.availability = match.availability || {};
                        match.availability[playerId] = isAvailable ? 'available' : 'unavailable';
                    }
                }
            } catch (error) {
                console.error('Toggle attendance error:', error);
                // Revert on error
                const checkbox = card?.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = !isAvailable;
                alert('Failed to update attendance');
            }
        };

        function renderRoster(team, playerStats) {
            const grid = document.getElementById('rosterGrid');
            const positions = ['1', '2', '3', '4', '5']; // Use numbers to avoid confusion with levels

            // Find next upcoming match
            const nextMatch = dashboardData?.matches?.find(m => m.status === 'scheduled');
            const matchLabel = nextMatch ? `Week ${nextMatch.week}` : 'Next Match';

            grid.innerHTML = (team.players || []).map(player => {
                const stats = playerStats.find(s => s.player_id === player.id) || {};
                const posLabel = positions[player.position - 1] || player.position;

                // Get player level (A/B/C)
                const level = player.level || player.skill_level || player.preferred_level || '?';
                const levelClass = ['A', 'B', 'C'].includes(level) ? `level-${level}` : 'level-unknown';

                // Get availability for next match
                const availability = nextMatch?.availability?.[player.id] || 'unknown';
                const isAvailable = availability === 'available';

                return `
                    <div class="roster-card ${availability === 'unavailable' ? 'unavailable' : ''}">
                        <div class="player-position">POSITION ${posLabel}</div>
                        <div class="player-name-roster">
                            ${player.name}
                            <span class="level-badge ${levelClass}">${level}</span>
                        </div>
                        <div class="player-stats-mini">
                            <div class="stat-mini"><div class="stat-mini-label">501 Avg</div><div class="stat-mini-value">${format3DA(stats)}</div></div>
                            <div class="stat-mini"><div class="stat-mini-label">MPR</div><div class="stat-mini-value">${formatMPR(stats)}</div></div>
                            <div class="stat-mini"><div class="stat-mini-label">180s</div><div class="stat-mini-value">${stats.x01_tons_180 || stats.x01_ton_eighties || 0}</div></div>
                            <div class="stat-mini"><div class="stat-mini-label">High CO</div><div class="stat-mini-value">${stats.x01_high_checkout || '-'}</div></div>
                        </div>
                        ${nextMatch ? `
                        <div class="attendance-toggle">
                            <span class="attendance-toggle-label">${matchLabel} Attendance</span>
                            <div style="display: flex; align-items: center;">
                                <label class="attendance-switch">
                                    <input type="checkbox" ${isAvailable ? 'checked' : ''} onchange="toggleAttendance('${player.id}', '${nextMatch.id}', this.checked)">
                                    <span class="attendance-slider"></span>
                                </label>
                                <span class="attendance-status ${isAvailable ? 'available' : 'unavailable'}" id="status-${player.id}">${isAvailable ? 'IN' : 'OUT'}</span>
                            </div>
                        </div>
                        ` : ''}
                        <div class="player-actions">
                            <button class="action-btn replace" onclick="openReplaceModal('${player.id}', '${player.name}')">REPLACE</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSchedule(matches, team) {
            const tbody = document.getElementById('scheduleBody');
            const positions = ['A', 'B', 'C'];

            tbody.innerHTML = matches.map(match => {
                const opponent = match.is_home ? match.away_team_name : match.home_team_name;
                const location = match.is_home ? 'vs' : '@';
                const availabilityDots = (team.players || []).map(player => {
                    const status = match.availability[player.id] || 'unknown';
                    const label = positions[player.position - 1] || '?';
                    return `<div class="avail-dot ${status}" title="${player.name}: ${status}">${label}</div>`;
                }).join('');

                let score = '-';
                if (match.status === 'completed') {
                    score = match.is_home ? `${match.home_score}-${match.away_score}` : `${match.away_score}-${match.home_score}`;
                }

                return `<tr><td>Week ${match.week}</td><td>${formatDate(match.match_date)}</td><td>${location} ${opponent}</td><td><span class="status-badge ${match.status}">${match.status.replace('_', ' ')}</span></td><td>${score}</td><td><div class="availability-indicator">${availabilityDots}</div></td></tr>`;
            }).join('');
        }

        function renderLineupMatches(matches) {
            const select = document.getElementById('lineupMatchSelect');
            const upcomingMatches = matches.filter(m => m.status !== 'completed');
            select.innerHTML = '<option value="">Select upcoming match...</option>' + upcomingMatches.map(m => {
                const opponent = m.is_home ? m.away_team_name : m.home_team_name;
                return `<option value="${m.id}">Week ${m.week} - ${m.is_home ? 'vs' : '@'} ${opponent}</option>`;
            }).join('');
        }

        window.loadLineupForMatch = function() {
            const matchId = document.getElementById('lineupMatchSelect').value;
            if (!matchId) { document.getElementById('lineupBuilder').style.display = 'none'; return; }

            document.getElementById('lineupBuilder').style.display = 'block';
            const team = dashboardData.team;
            const subs = dashboardData.available_subs;
            const positions = ['A', 'B', 'C', 'D', 'E'];

            const rows = (team.players || []).map(player => {
                const posLabel = positions[player.position - 1] || player.position;
                const options = [`<option value="${player.id}" selected>${player.name} (Roster)</option>`, ...subs.map(sub => `<option value="${sub.id}">${sub.name} (Sub - ${sub.skill_level})</option>`)].join('');
                return `<div class="lineup-row"><div class="lineup-position">${posLabel}</div><select class="lineup-select" data-position="${player.position}">${options}</select></div>`;
            }).join('');

            document.getElementById('lineupRows').innerHTML = rows;
        };

        window.saveLineup = async function() {
            const matchId = document.getElementById('lineupMatchSelect').value;
            if (!matchId) return;

            const selects = document.querySelectorAll('.lineup-select');
            const lineup = [];

            selects.forEach(select => {
                const playerId = select.value;
                const position = parseInt(select.dataset.position);
                const team = dashboardData.team;
                const subs = dashboardData.available_subs;
                let playerName = '', isSub = false;

                const rosterPlayer = (team.players || []).find(p => p.id === playerId);
                if (rosterPlayer) { playerName = rosterPlayer.name; }
                else { const sub = subs.find(s => s.id === playerId); if (sub) { playerName = sub.name; isSub = true; } }

                lineup.push({ position, player_id: playerId, player_name: playerName, is_sub: isSub });
            });

            try {
                const result = await callFunction('setMatchLineup', { league_id: currentLeagueId, match_id: matchId, team_id: currentTeamId, captain_email: captainEmail, lineup });
                if (result.success) { alert('Lineup saved successfully!'); } else { alert(result.error || 'Failed to save lineup'); }
            } catch (error) { console.error('Save lineup error:', error); alert('Failed to save lineup'); }
        };

        let currentSubFilter = 'ALL';

        function renderSubs(subs, filter = 'ALL') {
            const list = document.getElementById('subsList');
            if (!subs || subs.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #aaa; padding: 40px;">No substitutes available</div>';
                return;
            }

            // Filter subs by level if needed
            const filteredSubs = filter === 'ALL' ? subs : subs.filter(sub => {
                const level = sub.skill_level || sub.level || sub.preferred_level || '';
                return level.toUpperCase() === filter;
            });

            if (filteredSubs.length === 0) {
                list.innerHTML = `<div style="text-align: center; color: #aaa; padding: 40px;">No ${filter}-level substitutes available</div>`;
                return;
            }

            list.innerHTML = filteredSubs.map(sub => {
                const level = sub.skill_level || sub.level || sub.preferred_level || '?';
                const levelClass = ['A', 'B', 'C'].includes(level.toUpperCase()) ? `level-${level.toUpperCase()}` : 'level-unknown';
                return `
                    <div class="sub-card" data-level="${level.toUpperCase()}">
                        <div class="sub-name">
                            ${sub.name}
                            <span class="level-badge ${levelClass}">${level}</span>
                        </div>
                        <div style="font-size: 12px; color: #aaa; margin-top: 5px;">${sub.phone || sub.email || 'No contact'}</div>
                    </div>
                `;
            }).join('');
        }

        window.filterSubs = function(level, btn) {
            currentSubFilter = level;
            // Update button states
            document.querySelectorAll('#subFilters .filter-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');
            // Re-render subs with filter
            renderSubs(dashboardData?.available_subs || [], level);
        };

        // ============================================================================
        // FILL-IN REQUEST FUNCTIONS
        // ============================================================================

        let currentFillinFilter = 'ALL';
        let pendingFillinRequests = [];

        window.openFillinModal = function() {
            // Populate upcoming matches
            const matchSelect = document.getElementById('fillinMatch');
            const upcomingMatches = (dashboardData?.matches || []).filter(m => m.status !== 'completed');
            matchSelect.innerHTML = upcomingMatches.map(m => {
                const opponent = m.is_home ? m.away_team_name : m.home_team_name;
                return `<option value="${m.id}">Week ${m.week} - ${m.is_home ? 'vs' : '@'} ${opponent}</option>`;
            }).join('');

            // Populate sub selection list
            renderFillinSubList('ALL');

            document.getElementById('fillinModal').classList.add('active');
        };

        window.closeFillinModal = function() {
            document.getElementById('fillinModal').classList.remove('active');
        };

        function renderFillinSubList(filter) {
            const list = document.getElementById('fillinSubList');
            const subs = dashboardData?.available_subs || [];

            const filteredSubs = filter === 'ALL' ? subs : subs.filter(sub => {
                const level = sub.skill_level || sub.level || sub.preferred_level || '';
                return level.toUpperCase() === filter;
            });

            if (filteredSubs.length === 0) {
                list.innerHTML = `<div style="text-align: center; color: #aaa; padding: 20px;">No ${filter === 'ALL' ? '' : filter + '-level '}substitutes available</div>`;
                return;
            }

            list.innerHTML = filteredSubs.map(sub => {
                const level = sub.skill_level || sub.level || sub.preferred_level || '?';
                return `
                    <label class="sub-select-item">
                        <input type="checkbox" value="${sub.id}" data-name="${sub.name}">
                        <span class="sub-select-name">${sub.name}</span>
                        <span class="sub-select-level">${level}</span>
                    </label>
                `;
            }).join('');
        }

        window.filterFillinSubs = function(level) {
            currentFillinFilter = level;
            // Update button states
            document.querySelectorAll('#fillinSubFilters .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === level);
            });
            renderFillinSubList(level);
        };

        window.sendFillinRequests = async function() {
            const matchId = document.getElementById('fillinMatch').value;
            const customMessage = document.getElementById('fillinMessage').value.trim();

            // Get selected subs
            const checkboxes = document.querySelectorAll('#fillinSubList input[type="checkbox"]:checked');
            const subIds = Array.from(checkboxes).map(cb => cb.value);

            if (!matchId) {
                alert('Please select a match');
                return;
            }

            if (subIds.length === 0) {
                alert('Please select at least one substitute to contact');
                return;
            }

            try {
                const result = await callFunction('sendFillinRequests', {
                    league_id: currentLeagueId,
                    team_id: currentTeamId,
                    match_id: matchId,
                    sub_ids: subIds,
                    message: customMessage || null,
                    captain_id: dashboardData?.team?.captain_id
                });

                if (result.success) {
                    alert(`Fill-in requests sent to ${result.sent_to?.length || 0} subs!`);
                    closeFillinModal();
                    // Reload to show pending requests
                    loadPendingFillinRequests();
                } else {
                    alert(result.error || 'Failed to send fill-in requests');
                }
            } catch (error) {
                console.error('Send fill-in requests error:', error);
                alert('Failed to send fill-in requests: ' + error.message);
            }
        };

        async function loadPendingFillinRequests() {
            try {
                // Get pending fill-in requests for this team
                // Note: This would need a backend function to list requests
                // For now, we'll show the section if there are any
                const section = document.getElementById('pendingRequestsSection');
                if (pendingFillinRequests.length > 0) {
                    section.style.display = 'block';
                    renderPendingRequests();
                }
            } catch (error) {
                console.error('Error loading pending requests:', error);
            }
        }

        function renderPendingRequests() {
            const list = document.getElementById('pendingRequestsList');
            list.innerHTML = pendingFillinRequests.map(req => `
                <div class="request-card">
                    <div class="request-header">
                        <span class="request-match">Week ${req.match_week}</span>
                        <span class="request-status ${req.status}">${req.status.toUpperCase()}</span>
                    </div>
                    <div class="response-grid">
                        <div class="response-column">
                            <div class="response-label">Interested</div>
                            <div class="response-list interested">${(req.interested || []).map(p => p.name).join(', ') || '-'}</div>
                        </div>
                        <div class="response-column">
                            <div class="response-label">Declined</div>
                            <div class="response-list declined">${(req.declined || []).map(p => p.name).join(', ') || '-'}</div>
                        </div>
                        <div class="response-column">
                            <div class="response-label">Pending</div>
                            <div class="response-list">${(req.pending || []).map(p => p.name).join(', ') || '-'}</div>
                        </div>
                    </div>
                    ${req.interested?.length > 0 ? `
                        <div style="margin-top: 10px;">
                            <select class="brdc-select" id="confirm-sub-${req.request_id}" style="width: auto; display: inline-block;">
                                ${req.interested.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                            <button class="brdc-btn" onclick="confirmFillinSub('${req.request_id}')" style="margin-left: 10px;">CONFIRM</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        window.confirmFillinSub = async function(requestId) {
            const subId = document.getElementById(`confirm-sub-${requestId}`).value;
            const request = pendingFillinRequests.find(r => r.request_id === requestId);

            if (!subId || !request) return;

            try {
                const result = await callFunction('confirmFillin', {
                    league_id: currentLeagueId,
                    team_id: currentTeamId,
                    match_id: request.match_id,
                    request_id: requestId,
                    sub_player_id: subId,
                    captain_id: dashboardData?.team?.captain_id
                });

                if (result.success) {
                    alert(`${result.sub?.name || 'Sub'} confirmed as fill-in!`);
                    loadPendingFillinRequests();
                } else {
                    alert(result.error || 'Failed to confirm fill-in');
                }
            } catch (error) {
                console.error('Confirm fill-in error:', error);
                alert('Failed to confirm fill-in');
            }
        };

        // ============================================================================
        // TEAM MESSAGING FUNCTIONS
        // ============================================================================

        window.openMessageModal = function() {
            const list = document.getElementById('messageRecipientList');
            const players = dashboardData?.team?.players || [];

            // Add "All Team" option + individual players
            list.innerHTML = `
                <label class="sub-select-item">
                    <input type="checkbox" id="selectAllTeam" onchange="toggleAllRecipients(this.checked)" checked>
                    <span class="sub-select-name" style="color: var(--yellow);">ALL TEAM MEMBERS</span>
                </label>
                ${players.map(player => `
                    <label class="sub-select-item">
                        <input type="checkbox" class="recipient-checkbox" value="${player.id}" data-name="${player.name}" checked>
                        <span class="sub-select-name">${player.name}</span>
                    </label>
                `).join('')}
            `;

            document.getElementById('teamMessage').value = '';
            document.getElementById('messageModal').classList.add('active');
        };

        window.closeMessageModal = function() {
            document.getElementById('messageModal').classList.remove('active');
        };

        window.toggleAllRecipients = function(checked) {
            document.querySelectorAll('#messageRecipientList .recipient-checkbox').forEach(cb => {
                cb.checked = checked;
            });
        };

        window.sendTeamMessage = async function() {
            const message = document.getElementById('teamMessage').value.trim();

            if (!message) {
                alert('Please enter a message');
                return;
            }

            // Get selected recipients
            const checkboxes = document.querySelectorAll('#messageRecipientList .recipient-checkbox:checked');
            const recipients = Array.from(checkboxes).map(cb => cb.value);

            if (recipients.length === 0) {
                alert('Please select at least one recipient');
                return;
            }

            // Get selected channels
            const channels = [];
            if (document.getElementById('channelSms').checked) channels.push('sms');
            if (document.getElementById('channelEmail').checked) channels.push('email');

            if (channels.length === 0) {
                alert('Please select at least one channel (SMS or Email)');
                return;
            }

            try {
                const result = await callFunction('sendCaptainMessageV2', {
                    league_id: currentLeagueId,
                    team_id: currentTeamId,
                    captain_id: dashboardData?.team?.captain_id,
                    recipients: recipients,
                    channels: channels,
                    message: message
                });

                if (result.success) {
                    const successCount = result.results?.filter(r => r.status === 'queued').length || 0;
                    alert(`Message sent to ${successCount} team member(s)!`);
                    closeMessageModal();
                } else {
                    alert(result.error || 'Failed to send message');
                }
            } catch (error) {
                console.error('Send team message error:', error);
                alert('Failed to send message: ' + error.message);
            }
        };

        function renderNotifications(notifications) {
            const list = document.getElementById('notificationsList');
            const unreadCount = (notifications || []).filter(n => !n.read).length;
            document.getElementById('alertCount').textContent = unreadCount > 0 ? `(${unreadCount})` : '';

            if (!notifications || notifications.length === 0) { list.innerHTML = '<div style="text-align: center; color: #aaa; padding: 40px;">No notifications</div>'; return; }
            list.innerHTML = notifications.map(n => `<div class="notification-item ${n.read ? '' : 'unread'}"><div>${n.message}</div><div class="notification-time">${formatDateTime(n.created_at)}</div></div>`).join('');
        }

        window.openReplaceModal = function(playerId, playerName) {
            replacePlayerId = playerId;
            document.getElementById('replacePlayerName').textContent = playerName;
            const subs = dashboardData.available_subs || [];
            document.getElementById('replacementSelect').innerHTML = '<option value="">Select replacement...</option>' + subs.map(s => `<option value="${s.id}">${s.name} (${s.skill_level})</option>`).join('');
            document.getElementById('replaceModal').classList.add('active');
        };

        window.closeReplaceModal = function() { document.getElementById('replaceModal').classList.remove('active'); replacePlayerId = null; };

        window.confirmReplacement = async function() {
            const newPlayerId = document.getElementById('replacementSelect').value;
            const reason = document.getElementById('replaceReason').value;
            if (!newPlayerId) { alert('Please select a replacement'); return; }
            if (!confirm('This will permanently remove the player from your roster. Are you sure?')) return;

            try {
                const result = await callFunction('permanentReplacement', { league_id: currentLeagueId, team_id: currentTeamId, drop_player_id: replacePlayerId, new_player_id: newPlayerId, captain_email: captainEmail, reason });
                if (result.success) { alert('Player replaced successfully!'); closeReplaceModal(); loadDashboard(); }
                else { alert(result.error || 'Failed to replace player'); }
            } catch (error) { console.error('Replace error:', error); alert('Failed to replace player'); }
        };

        window.showTab = function(tabName, clickEvent) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            // Use passed event or find tab by name
            if (clickEvent && clickEvent.target) {
                clickEvent.target.classList.add('active');
            } else {
                const tab = document.querySelector(`.tab[onclick*="showTab('${tabName}'"]`);
                if (tab) tab.classList.add('active');
            }
            document.getElementById('tab-' + tabName).classList.add('active');
        };

        function formatDate(dateStr) { if (!dateStr) return '-'; return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
        function formatDateTime(timestamp) { if (!timestamp) return '-'; const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp); return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }); }

        document.getElementById('loginEmail').addEventListener('keypress', (e) => { if (e.key === 'Enter') captainLogin(); });
    </script>
<script src="/js/display-helpers.js"></script>
<script src="/js/stats-helpers.js"></script>
<script src="/js/feedback.js"></script>
<script src="/js/nav-menu.js"></script>
</body>
</html>
