<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captain Dashboard - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/brdc-styles.css">
    <style>
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .header-logo {
            width: 40px;
            height: 40px;
            mix-blend-mode: multiply;
            filter: drop-shadow(0 0 8px rgba(255, 70, 154, 0.5));
        }
        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 3px;
            color: var(--pink);
        }
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            color: var(--yellow);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .team-name-text {
            cursor: pointer;
            transition: color 0.2s;
        }
        .team-name-text:hover {
            color: var(--teal);
        }
        .edit-icon {
            font-size: 24px;
            opacity: 0.5;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .edit-icon:hover {
            opacity: 1;
        }
        .team-name-input {
            font-family: 'Bebas Neue', cursive;
            font-size: 40px;
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--yellow);
            color: var(--yellow);
            padding: 5px 15px;
            width: 300px;
        }
        .league-name {
            font-size: 18px;
            color: var(--teal);
        }
        .record {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: white;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 12px 24px;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab:hover { background: rgba(255,255,255,0.1); }
        .tab.active {
            background: var(--yellow);
            color: black;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .roster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .roster-card {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 20px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
        }
        .roster-card.unavailable {
            border-color: #ef4444;
            opacity: 0.7;
        }
        .player-position {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--teal);
            margin-bottom: 5px;
        }
        .player-name-roster {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: white;
            margin-bottom: 10px;
        }
        .player-stats-mini {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 14px;
        }
        .stat-mini {
            background: rgba(0,0,0,0.3);
            padding: 8px;
            text-align: center;
        }
        .stat-mini-label { font-size: 11px; color: #aaa; }
        .stat-mini-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--yellow);
        }
        .player-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .action-btn {
            flex: 1;
            padding: 8px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            border: 2px solid var(--black);
            cursor: pointer;
        }
        .action-btn.replace { background: #ef4444; color: white; }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
        }
        .schedule-table th, .schedule-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        .schedule-table th {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--teal);
            background: rgba(0,0,0,0.3);
        }
        .schedule-table tr:hover { background: rgba(255,255,255,0.05); }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-badge.scheduled { background: #3b82f6; color: white; }
        .status-badge.in_progress { background: var(--yellow); color: black; }
        .status-badge.completed { background: #22c55e; color: white; }

        .availability-indicator { display: flex; gap: 5px; }
        .avail-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .avail-dot.available { background: #22c55e; color: white; }
        .avail-dot.unavailable { background: #ef4444; color: white; }
        .avail-dot.unknown { background: #666; color: white; }

        .lineup-section {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 20px;
            margin-bottom: 20px;
        }
        .lineup-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--yellow);
            margin-bottom: 15px;
        }
        .lineup-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 10px;
            border-radius: 8px;
        }
        .lineup-position {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--teal);
            width: 30px;
        }
        .lineup-select {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 2px solid var(--black);
        }

        .notifications-list { max-height: 300px; overflow-y: auto; }
        .notification-item {
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-left: 4px solid var(--yellow);
            margin-bottom: 10px;
        }
        .notification-item.unread {
            border-left-color: var(--pink);
            background: rgba(255,70,154,0.1);
        }
        .notification-time { font-size: 12px; color: #aaa; }

        .subs-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .sub-card {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 15px;
        }
        .sub-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: white;
        }
        .sub-skill { font-size: 12px; color: var(--teal); text-transform: uppercase; }

        /* Free Agent Cards */
        .free-agent-card {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 15px;
            position: relative;
        }
        .free-agent-card.invited {
            border-color: var(--yellow);
            opacity: 0.7;
        }
        .free-agent-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: white;
        }
        .free-agent-level {
            display: inline-block;
            padding: 2px 8px;
            font-size: 11px;
            background: var(--teal);
            color: black;
            font-weight: bold;
            margin-top: 5px;
        }
        .free-agent-note {
            font-size: 12px;
            color: #aaa;
            margin-top: 8px;
            font-style: italic;
        }
        .invite-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: var(--pink);
            border: 2px solid var(--black);
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
        }
        .invite-btn:hover { background: #d63384; }
        .invite-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .invited-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--yellow);
            color: black;
            padding: 2px 8px;
            font-size: 10px;
            font-weight: bold;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: linear-gradient(180deg, #1F85AF 0%, #001F4D 100%);
            border: 4px solid var(--black);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
        }
        .modal-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--yellow);
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .team-name { font-size: 32px; }
            .record { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <button class="back-btn" onclick="window.location.href='/pages/dashboard.html'">← BACK</button>
        <img src="/images/white_logo.jpg" alt="BRDC" class="header-logo">
        <span class="header-title">CAPTAIN DASHBOARD</span>
    </div>

    <!-- Login Modal -->
    <div class="modal-overlay active" id="loginModal">
        <div class="modal-content">
            <div class="modal-title">Captain Login</div>
            <input type="email" id="loginEmail" placeholder="Email Address" class="brdc-input" style="margin-bottom: 15px;">
            <button class="brdc-btn" onclick="captainLogin()" style="width: 100%;">LOGIN</button>
        </div>
    </div>

    <!-- Replace Player Modal -->
    <div class="modal-overlay" id="replaceModal">
        <div class="modal-content">
            <div class="modal-title">Replace Player</div>
            <p style="margin-bottom: 15px;">Select a replacement for <strong id="replacePlayerName">-</strong></p>
            <select id="replacementSelect" class="brdc-select" style="margin-bottom: 15px;"></select>
            <input type="text" id="replaceReason" placeholder="Reason (optional)" class="brdc-input" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 15px;">
                <button class="brdc-btn brdc-btn-secondary" onclick="closeReplaceModal()" style="flex: 1;">CANCEL</button>
                <button class="brdc-btn" onclick="confirmReplacement()" style="flex: 1;">CONFIRM</button>
            </div>
        </div>
    </div>

    <div class="dashboard-container" id="dashboardContent" style="display: none;">
        <div class="dashboard-header">
            <div>
                <div class="team-name">
                    <span class="team-name-text" id="teamName" onclick="startEditTeamName()">Loading...</span>
                    <span class="edit-icon" onclick="startEditTeamName()">✏️</span>
                    <input type="text" class="team-name-input" id="teamNameInput" style="display: none;"
                           onblur="saveTeamName()" onkeypress="if(event.key==='Enter') saveTeamName()">
                </div>
                <div class="league-name" id="leagueName">-</div>
            </div>
            <div style="text-align: right;">
                <div class="record" id="teamRecord">0-0</div>
                <div style="font-size: 14px; color: #aaa;">Games: <span id="gamesRecord">0-0</span></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('roster')">ROSTER</button>
            <button class="tab" onclick="showTab('schedule')">SCHEDULE</button>
            <button class="tab" onclick="showTab('lineup')">SET LINEUP</button>
            <button class="tab" onclick="showTab('subs')">SUBSTITUTES</button>
            <button class="tab" id="freeAgentsTab" onclick="showTab('freeagents')" style="display: none;">FREE AGENTS</button>
            <button class="tab" onclick="showTab('notifications')">ALERTS <span id="alertCount"></span></button>
        </div>

        <!-- Roster Tab -->
        <div class="tab-content active" id="tab-roster">
            <div class="roster-grid" id="rosterGrid">
                <div style="text-align: center; color: #aaa; padding: 40px;">Loading roster...</div>
            </div>
        </div>

        <!-- Schedule Tab -->
        <div class="tab-content" id="tab-schedule">
            <div style="overflow-x: auto;">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Week</th>
                            <th>Date</th>
                            <th>Opponent</th>
                            <th>Status</th>
                            <th>Score</th>
                            <th>Availability</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Lineup Tab -->
        <div class="tab-content" id="tab-lineup">
            <div class="lineup-section">
                <div class="lineup-title">Select Match</div>
                <select id="lineupMatchSelect" class="brdc-select" onchange="loadLineupForMatch()" style="margin-bottom: 20px;">
                    <option value="">Select upcoming match...</option>
                </select>
                <div id="lineupBuilder" style="display: none;">
                    <div class="lineup-title">Set Your Lineup</div>
                    <div id="lineupRows"></div>
                    <button class="brdc-btn" onclick="saveLineup()" style="margin-top: 20px;">SAVE LINEUP</button>
                </div>
            </div>
        </div>

        <!-- Subs Tab -->
        <div class="tab-content" id="tab-subs">
            <div class="subs-list" id="subsList"></div>
        </div>

        <!-- Free Agents Tab -->
        <div class="tab-content" id="tab-freeagents">
            <div style="margin-bottom: 20px;">
                <div style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--teal); margin-bottom: 10px;">
                    Available Free Agents
                </div>
                <div style="font-size: 14px; color: #aaa;">
                    Invite players to join your team. They'll receive a notification and can accept or decline.
                </div>
            </div>
            <div class="subs-list" id="freeAgentsList"></div>
        </div>

        <!-- Notifications Tab -->
        <div class="tab-content" id="tab-notifications">
            <div class="notifications-list" id="notificationsList"></div>
        </div>

        <div style="margin-top: 30px; text-align: center;">
            <button class="brdc-btn brdc-btn-secondary" onclick="logout()">LOGOUT</button>
        </div>
    </div>

    <script type="module">
        import { callFunction } from '/js/firebase-config.js';

        let dashboardData = null;
        let currentLeagueId = null;
        let currentTeamId = null;
        let captainEmail = null;
        let replacePlayerId = null;

        const params = new URLSearchParams(window.location.search);
        currentLeagueId = params.get('league_id');

        const savedSession = localStorage.getItem('captainSession');
        if (savedSession) {
            const session = JSON.parse(savedSession);
            captainEmail = session.email;
            currentTeamId = session.teamId;
            currentLeagueId = session.leagueId || currentLeagueId;
            loadDashboard();
        }

        window.captainLogin = async function() {
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            if (!email) { alert('Please enter your email'); return; }

            try {
                const result = await callFunction('captainLogin', { league_id: currentLeagueId, email });
                if (result.success) {
                    captainEmail = email;
                    currentTeamId = result.team.id;
                    currentLeagueId = currentLeagueId || result.league_id;
                    localStorage.setItem('captainSession', JSON.stringify({ email: captainEmail, teamId: currentTeamId, leagueId: currentLeagueId }));
                    loadDashboard();
                } else {
                    alert(result.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
            }
        };

        window.logout = function() {
            localStorage.removeItem('captainSession');
            location.reload();
        };

        async function loadDashboard() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('dashboardContent').style.display = 'block';

            try {
                const result = await callFunction('getCaptainDashboard', { league_id: currentLeagueId, team_id: currentTeamId, captain_email: captainEmail });
                if (result.success) {
                    dashboardData = result;
                    renderDashboard();
                } else {
                    alert(result.error || 'Failed to load dashboard');
                }
            } catch (error) {
                console.error('Load dashboard error:', error);
                alert('Failed to load dashboard');
            }
        }

        function renderDashboard() {
            const { team, league, matches, player_stats, available_subs, free_agents, notifications } = dashboardData;

            document.getElementById('teamName').textContent = team.team_name || '(Set Team Name)';
            document.getElementById('leagueName').textContent = league.league_name;
            document.getElementById('teamRecord').textContent = `${team.wins || 0}-${team.losses || 0}${(team.ties || 0) > 0 ? '-' + team.ties : ''}`;
            document.getElementById('gamesRecord').textContent = `${team.games_won || 0}-${team.games_lost || 0}`;

            // Show free agents tab if league allows and team has open spots
            const hasOpenSpots = (team.roster_count || 0) < (team.max_roster || 4);
            if (league.league_mode === 'team' && (league.allow_free_agents || free_agents?.length > 0)) {
                document.getElementById('freeAgentsTab').style.display = 'block';
            }

            renderRoster(team, player_stats);
            renderSchedule(matches, team);
            renderLineupMatches(matches);
            renderSubs(available_subs);
            renderFreeAgents(free_agents || [], team);
            renderNotifications(notifications);
        }

        // Team name editing
        window.startEditTeamName = function() {
            const nameSpan = document.getElementById('teamName');
            const nameInput = document.getElementById('teamNameInput');
            const currentName = dashboardData?.team?.team_name || '';

            nameSpan.style.display = 'none';
            document.querySelector('.edit-icon').style.display = 'none';
            nameInput.style.display = 'block';
            nameInput.value = currentName;
            nameInput.focus();
            nameInput.select();
        };

        window.saveTeamName = async function() {
            const nameSpan = document.getElementById('teamName');
            const nameInput = document.getElementById('teamNameInput');
            const newName = nameInput.value.trim();

            nameSpan.style.display = 'inline';
            document.querySelector('.edit-icon').style.display = 'inline';
            nameInput.style.display = 'none';

            if (!newName || newName === dashboardData?.team?.team_name) return;

            try {
                const result = await callFunction('updateTeamName', {
                    league_id: currentLeagueId,
                    team_id: currentTeamId,
                    captain_email: captainEmail,
                    team_name: newName
                });

                if (result.success) {
                    dashboardData.team.team_name = newName;
                    nameSpan.textContent = newName;
                } else {
                    alert(result.error || 'Failed to update team name');
                }
            } catch (error) {
                console.error('Update team name error:', error);
                alert('Failed to update team name');
            }
        };

        // Free agents rendering
        function renderFreeAgents(freeAgents, team) {
            const list = document.getElementById('freeAgentsList');
            if (!freeAgents || freeAgents.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #aaa; padding: 40px;">No free agents available</div>';
                return;
            }

            const hasOpenSpots = (team.roster_count || 0) < (team.max_roster || 4);

            list.innerHTML = freeAgents.map(fa => {
                const alreadyInvited = fa.invites_received?.includes(currentTeamId);
                return `
                    <div class="free-agent-card ${alreadyInvited ? 'invited' : ''}">
                        ${alreadyInvited ? '<span class="invited-badge">INVITED</span>' : ''}
                        <div class="free-agent-name">${fa.name}</div>
                        ${fa.skill_level ? `<span class="free-agent-level">${fa.skill_level}</span>` : ''}
                        ${fa.note ? `<div class="free-agent-note">"${fa.note}"</div>` : ''}
                        <button class="invite-btn" onclick="inviteFreeAgent('${fa.id}', '${fa.name}')"
                                ${!hasOpenSpots || alreadyInvited ? 'disabled' : ''}>
                            ${alreadyInvited ? 'INVITE SENT' : (hasOpenSpots ? 'INVITE TO TEAM' : 'ROSTER FULL')}
                        </button>
                    </div>
                `;
            }).join('');
        }

        window.inviteFreeAgent = async function(freeAgentId, freeAgentName) {
            if (!confirm(`Send team invite to ${freeAgentName}?`)) return;

            try {
                const result = await callFunction('sendTeamInvite', {
                    league_id: currentLeagueId,
                    team_id: currentTeamId,
                    captain_email: captainEmail,
                    free_agent_id: freeAgentId
                });

                if (result.success) {
                    alert(`Invite sent to ${freeAgentName}!`);
                    // Update UI
                    const fa = dashboardData.free_agents?.find(f => f.id === freeAgentId);
                    if (fa) {
                        fa.invites_received = fa.invites_received || [];
                        fa.invites_received.push(currentTeamId);
                    }
                    renderFreeAgents(dashboardData.free_agents || [], dashboardData.team);
                } else {
                    alert(result.error || 'Failed to send invite');
                }
            } catch (error) {
                console.error('Invite error:', error);
                alert('Failed to send invite');
            }
        };

        function renderRoster(team, playerStats) {
            const grid = document.getElementById('rosterGrid');
            const positions = ['A', 'B', 'C', 'D', 'E'];

            grid.innerHTML = (team.players || []).map(player => {
                const stats = playerStats.find(s => s.player_id === player.id) || {};
                const posLabel = positions[player.position - 1] || player.position;

                return `
                    <div class="roster-card">
                        <div class="player-position">POSITION ${posLabel}</div>
                        <div class="player-name-roster">${player.name}</div>
                        <div class="player-stats-mini">
                            <div class="stat-mini"><div class="stat-mini-label">501 Avg</div><div class="stat-mini-value">${stats.x01_avg || '-'}</div></div>
                            <div class="stat-mini"><div class="stat-mini-label">MPR</div><div class="stat-mini-value">${stats.cricket_mpr || '-'}</div></div>
                            <div class="stat-mini"><div class="stat-mini-label">180s</div><div class="stat-mini-value">${stats.x01_ton_eighties || 0}</div></div>
                            <div class="stat-mini"><div class="stat-mini-label">High CO</div><div class="stat-mini-value">${stats.x01_high_checkout || '-'}</div></div>
                        </div>
                        <div class="player-actions">
                            <button class="action-btn replace" onclick="openReplaceModal('${player.id}', '${player.name}')">REPLACE</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSchedule(matches, team) {
            const tbody = document.getElementById('scheduleBody');
            const positions = ['A', 'B', 'C'];

            tbody.innerHTML = matches.map(match => {
                const opponent = match.is_home ? match.away_team_name : match.home_team_name;
                const location = match.is_home ? 'vs' : '@';
                const availabilityDots = (team.players || []).map(player => {
                    const status = match.availability[player.id] || 'unknown';
                    const label = positions[player.position - 1] || '?';
                    return `<div class="avail-dot ${status}" title="${player.name}: ${status}">${label}</div>`;
                }).join('');

                let score = '-';
                if (match.status === 'completed') {
                    score = match.is_home ? `${match.home_score}-${match.away_score}` : `${match.away_score}-${match.home_score}`;
                }

                return `<tr><td>Week ${match.week}</td><td>${formatDate(match.match_date)}</td><td>${location} ${opponent}</td><td><span class="status-badge ${match.status}">${match.status.replace('_', ' ')}</span></td><td>${score}</td><td><div class="availability-indicator">${availabilityDots}</div></td></tr>`;
            }).join('');
        }

        function renderLineupMatches(matches) {
            const select = document.getElementById('lineupMatchSelect');
            const upcomingMatches = matches.filter(m => m.status !== 'completed');
            select.innerHTML = '<option value="">Select upcoming match...</option>' + upcomingMatches.map(m => {
                const opponent = m.is_home ? m.away_team_name : m.home_team_name;
                return `<option value="${m.id}">Week ${m.week} - ${m.is_home ? 'vs' : '@'} ${opponent}</option>`;
            }).join('');
        }

        window.loadLineupForMatch = function() {
            const matchId = document.getElementById('lineupMatchSelect').value;
            if (!matchId) { document.getElementById('lineupBuilder').style.display = 'none'; return; }

            document.getElementById('lineupBuilder').style.display = 'block';
            const team = dashboardData.team;
            const subs = dashboardData.available_subs;
            const positions = ['A', 'B', 'C', 'D', 'E'];

            const rows = (team.players || []).map(player => {
                const posLabel = positions[player.position - 1] || player.position;
                const options = [`<option value="${player.id}" selected>${player.name} (Roster)</option>`, ...subs.map(sub => `<option value="${sub.id}">${sub.name} (Sub - ${sub.skill_level})</option>`)].join('');
                return `<div class="lineup-row"><div class="lineup-position">${posLabel}</div><select class="lineup-select" data-position="${player.position}">${options}</select></div>`;
            }).join('');

            document.getElementById('lineupRows').innerHTML = rows;
        };

        window.saveLineup = async function() {
            const matchId = document.getElementById('lineupMatchSelect').value;
            if (!matchId) return;

            const selects = document.querySelectorAll('.lineup-select');
            const lineup = [];

            selects.forEach(select => {
                const playerId = select.value;
                const position = parseInt(select.dataset.position);
                const team = dashboardData.team;
                const subs = dashboardData.available_subs;
                let playerName = '', isSub = false;

                const rosterPlayer = (team.players || []).find(p => p.id === playerId);
                if (rosterPlayer) { playerName = rosterPlayer.name; }
                else { const sub = subs.find(s => s.id === playerId); if (sub) { playerName = sub.name; isSub = true; } }

                lineup.push({ position, player_id: playerId, player_name: playerName, is_sub: isSub });
            });

            try {
                const result = await callFunction('setMatchLineup', { league_id: currentLeagueId, match_id: matchId, team_id: currentTeamId, captain_email: captainEmail, lineup });
                if (result.success) { alert('Lineup saved successfully!'); } else { alert(result.error || 'Failed to save lineup'); }
            } catch (error) { console.error('Save lineup error:', error); alert('Failed to save lineup'); }
        };

        function renderSubs(subs) {
            const list = document.getElementById('subsList');
            if (!subs || subs.length === 0) { list.innerHTML = '<div style="text-align: center; color: #aaa; padding: 40px;">No substitutes available</div>'; return; }
            list.innerHTML = subs.map(sub => `<div class="sub-card"><div class="sub-name">${sub.name}</div><div class="sub-skill">${sub.skill_level || 'Unknown'}</div><div style="font-size: 12px; color: #aaa; margin-top: 5px;">${sub.phone || sub.email}</div></div>`).join('');
        }

        function renderNotifications(notifications) {
            const list = document.getElementById('notificationsList');
            const unreadCount = (notifications || []).filter(n => !n.read).length;
            document.getElementById('alertCount').textContent = unreadCount > 0 ? `(${unreadCount})` : '';

            if (!notifications || notifications.length === 0) { list.innerHTML = '<div style="text-align: center; color: #aaa; padding: 40px;">No notifications</div>'; return; }
            list.innerHTML = notifications.map(n => `<div class="notification-item ${n.read ? '' : 'unread'}"><div>${n.message}</div><div class="notification-time">${formatDateTime(n.created_at)}</div></div>`).join('');
        }

        window.openReplaceModal = function(playerId, playerName) {
            replacePlayerId = playerId;
            document.getElementById('replacePlayerName').textContent = playerName;
            const subs = dashboardData.available_subs || [];
            document.getElementById('replacementSelect').innerHTML = '<option value="">Select replacement...</option>' + subs.map(s => `<option value="${s.id}">${s.name} (${s.skill_level})</option>`).join('');
            document.getElementById('replaceModal').classList.add('active');
        };

        window.closeReplaceModal = function() { document.getElementById('replaceModal').classList.remove('active'); replacePlayerId = null; };

        window.confirmReplacement = async function() {
            const newPlayerId = document.getElementById('replacementSelect').value;
            const reason = document.getElementById('replaceReason').value;
            if (!newPlayerId) { alert('Please select a replacement'); return; }
            if (!confirm('This will permanently remove the player from your roster. Are you sure?')) return;

            try {
                const result = await callFunction('permanentReplacement', { league_id: currentLeagueId, team_id: currentTeamId, drop_player_id: replacePlayerId, new_player_id: newPlayerId, captain_email: captainEmail, reason });
                if (result.success) { alert('Player replaced successfully!'); closeReplaceModal(); loadDashboard(); }
                else { alert(result.error || 'Failed to replace player'); }
            } catch (error) { console.error('Replace error:', error); alert('Failed to replace player'); }
        };

        window.showTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        };

        function formatDate(dateStr) { if (!dateStr) return '-'; return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
        function formatDateTime(timestamp) { if (!timestamp) return '-'; const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp); return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }); }

        document.getElementById('loginEmail').addEventListener('keypress', (e) => { if (e.key === 'Enter') captainLogin(); });
    </script>
</body>
</html>
