<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>League Director - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap');

        :root {
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --black: #000000;
            --white: #FFFFFF;
            --bg-dark: #1a1a2e;
            --bg-dark-end: #0f0f23;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --text-light: #f0f0f0;
            --text-dim: #8a8aa3;
            --text-muted: #666;
            --border-color: rgba(255,255,255,0.15);
            --border-strong: #000;
            --glow-pink: rgba(255, 70, 154, 0.3);
            --glow-teal: rgba(145, 215, 235, 0.3);
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { min-height: 100%; }

        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-dark-end) 100%);
            min-height: 100vh;
            color: var(--text-light);
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Header Bar */
        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .back-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 16px;
            font-weight: 700;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--pink);
        }

        .header-logo {
            width: 40px;
            height: 40px;
            
        }

        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 3px;
            color: var(--pink);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 24px;
            margin-top: 20px;
        }

        @media (max-width: 1024px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }

        /* Cards */
        .card, .sidebar-card {
            background: var(--bg-panel);
            border: 4px solid var(--border-strong);
            border-radius: 16px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.5);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 3px solid var(--border-strong);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-header.pink { background: linear-gradient(135deg, var(--pink), #d63384); }
        .card-header.teal { background: linear-gradient(135deg, var(--teal), #5ab8d4); }
        .card-header.yellow { background: linear-gradient(135deg, var(--yellow), #f9a825); }

        .card-icon {
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,0.2);
            border: 2px solid rgba(0,0,0,0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .card-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            letter-spacing: 2px;
            color: white;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        .card-body, .sidebar-card {
            padding: 24px;
        }

        .sidebar-card h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 2px;
            color: var(--teal);
            margin-bottom: 15px;
        }

        /* Stat Rows */
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-weight: 600; color: var(--text-dim); }
        .stat-value { font-weight: 800; font-size: 18px; color: var(--text-light); }

        /* Settings Display */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        .settings-grid > div {
            padding: 10px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }
        .setting-label {
            color: var(--text-dim);
            font-size: 12px;
            display: block;
            margin-bottom: 4px;
        }
        .settings-grid span:not(.setting-label) {
            font-weight: 600;
            color: var(--text-light);
            font-size: 14px;
        }
        .settings-edit {
            padding-top: 15px;
            border-top: 1px solid #333;
            margin-top: 15px;
        }

        /* Week Selector */
        .week-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .week-btn {
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 8px;
            width: 45px;
            height: 45px;
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.5);
            color: var(--text-light);
            transition: all 0.2s;
        }

        .week-btn:hover { transform: translateY(-2px); box-shadow: 5px 5px 0 rgba(0,0,0,0.5); }
        .week-btn.active { background: linear-gradient(135deg, var(--pink), #d63384); color: white; }

        /* Match Cards */
        .match-card {
            background: var(--bg-panel);
            border: 4px solid var(--border-strong);
            border-radius: 16px;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .match-header {
            background: linear-gradient(135deg, var(--bg-card), #243352);
            color: var(--text-light);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
        }

        .match-teams {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            padding: 25px;
            align-items: center;
        }

        .team-info { text-align: center; }

        .team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .team-players { font-size: 13px; color: var(--text-dim); line-height: 1.6; }

        .vs-circle {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--yellow), #f9a825);
            border: 3px solid var(--border-strong);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--black);
            box-shadow: 3px 3px 0 rgba(0,0,0,0.5);
        }

        .match-score {
            display: flex;
            justify-content: center;
            gap: 40px;
            padding: 20px;
            background: var(--bg-card);
            border-top: 2px solid var(--border-color);
        }

        .score-box { text-align: center; }

        .score-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            color: var(--pink);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        .score-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .match-actions {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-top: 2px solid var(--border-color);
            justify-content: center;
            flex-wrap: wrap;
            background: rgba(0,0,0,0.2);
        }

        .pin-display {
            background: linear-gradient(135deg, var(--yellow), #f9a825);
            border: 3px solid var(--border-strong);
            border-radius: 8px;
            padding: 12px 25px;
            text-align: center;
            margin: 15px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
        }

        .pin-code {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            letter-spacing: 6px;
            color: var(--black);
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            border-radius: 20px;
            letter-spacing: 1px;
        }

        .status-scheduled { background: rgba(255,255,255,0.1); color: var(--text-dim); }
        .status-in_progress { background: var(--yellow); color: var(--black); }
        .status-completed { background: var(--success); color: white; }

        /* Tab Navigation */
        .tab-container {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            background: var(--bg-panel);
            padding: 8px;
            border-radius: 12px;
            border: 3px solid var(--border-strong);
            box-shadow: 5px 5px 0 rgba(0, 0, 0, 0.4);
        }

        .tab {
            padding: 14px 20px;
            background: transparent;
            color: var(--text-dim);
            border: none;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            font-family: 'Bebas Neue', cursive;
            border-radius: 8px;
        }

        .tab:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--pink), #d63384);
            color: white;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.4);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Login Overlay - hidden by default, shown only if no valid session */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-dark-end) 100%);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .login-overlay.active {
            display: flex;
        }

        .login-overlay::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .login-card {
            background: var(--bg-panel);
            border: 4px solid var(--border-strong);
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.5);
            padding: 40px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            position: relative;
            border-radius: 16px;
        }

        .login-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            letter-spacing: 3px;
            color: var(--pink);
            text-shadow: 3px 3px 0 rgba(0,0,0,0.5);
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--text-dim);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .pin-input {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .pin-field {
            width: 100%;
            max-width: 280px;
            height: 56px;
            border: 3px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 24px;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            background: rgba(0,0,0,0.3);
            color: var(--yellow);
            transition: all 0.2s;
            letter-spacing: 4px;
        }

        .pin-field:focus {
            outline: none;
            border-color: var(--pink);
            background: rgba(255,70,154,0.1);
            box-shadow: 0 0 15px rgba(255,70,154,0.3);
        }

        .pin-field::placeholder {
            color: rgba(253, 216, 53, 0.4);
        }

        /* Quick Actions */
        .quick-action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .quick-action {
            padding: 12px 8px;
            text-align: center;
            font-weight: 700;
            font-size: 12px;
        }

        /* Buttons */
        .btn, .brdc-btn {
            padding: 12px 24px;
            border: 3px solid var(--border-strong);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.4);
            background: linear-gradient(135deg, var(--pink), #d63384);
            color: white;
        }

        .btn:hover, .brdc-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.4);
        }

        .btn:active, .brdc-btn:active {
            transform: translateY(2px);
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.4);
        }

        .brdc-btn-secondary {
            background: var(--bg-card);
            color: var(--text-light);
        }

        /* Player Management */
        .player-card {
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .player-card.on-team { border-left: 5px solid var(--success); }
        .player-card.is-sub { border-left: 5px solid var(--yellow); }

        .player-info { flex: 1; }
        .player-name-display { font-weight: 700; font-size: 16px; color: var(--text-light); }
        .player-meta { font-size: 12px; color: var(--text-dim); margin-top: 4px; }

        .player-actions { display: flex; gap: 8px; }

        .player-actions button {
            padding: 8px 14px;
            border: 2px solid var(--border-strong);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.4);
        }

        .player-actions .edit-btn { background: var(--teal); color: var(--black); }
        .player-actions .delete-btn { background: var(--danger); color: white; }

        /* Forms */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .form-group label, .brdc-label {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 1px;
            color: var(--teal);
        }

        .form-group input, .form-group select, .form-group textarea,
        .brdc-input, .brdc-select {
            padding: 12px 16px;
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 14px;
            transition: all 0.2s;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3);
        }

        .form-group input:focus, .form-group select:focus,
        .brdc-input:focus, .brdc-select:focus {
            outline: none;
            border-color: var(--teal);
            box-shadow: 0 0 0 3px var(--glow-teal);
        }

        .form-group input::placeholder { color: var(--text-muted); }

        .bulk-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text-light);
            resize: vertical;
        }

        .player-count-badge {
            background: var(--pink);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 8px;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-bar input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 14px;
        }

        .filter-bar select {
            padding: 12px 16px;
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 14px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 12px;
            overflow: hidden;
        }

        thead tr {
            background: linear-gradient(135deg, var(--pink), #d63384);
        }

        th {
            padding: 14px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 1px;
            color: white;
            text-transform: uppercase;
        }

        td {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-light);
        }

        tr:last-child td { border-bottom: none; }

        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-panel);
            border: 4px solid var(--border-strong);
            border-radius: 16px;
            box-shadow: 10px 10px 0 rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 3px solid var(--border-strong);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--pink), #d63384);
        }

        .modal-header.teal {
            background: linear-gradient(135deg, var(--teal), #5ab8d4);
        }

        .modal-header.yellow {
            background: linear-gradient(135deg, var(--yellow), #f9a825);
        }

        .modal-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            letter-spacing: 2px;
            color: white;
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3);
        }

        .modal-close {
            background: rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            color: white;
            font-size: 20px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 2px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Director Tools specific styles */
        .director-card {
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.4);
        }

        .director-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .director-card-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            color: var(--teal);
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .score-display .team-name {
            font-weight: 700;
            color: var(--text-light);
            flex: 1;
            text-align: center;
        }

        .score-display .score {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--yellow);
            padding: 0 16px;
        }

        .score-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .score-input-group input {
            width: 80px;
            text-align: center;
            font-size: 24px;
            font-family: 'Bebas Neue', cursive;
            padding: 12px;
        }

        .level-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
        }

        .level-badge.level-a { background: var(--pink); color: white; }
        .level-badge.level-b { background: var(--teal); color: black; }
        .level-badge.level-c { background: var(--yellow); color: black; }
        .level-badge.level-unassigned { background: #666; color: white; }

        .match-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .match-row:hover {
            background: rgba(0, 0, 0, 0.25);
        }

        .match-teams {
            font-weight: 600;
            color: var(--text-light);
        }

        .match-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--yellow);
        }

        .match-meta {
            font-size: 12px;
            color: var(--text-dim);
        }

        .makeup-badge {
            background: var(--yellow);
            color: black;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header-title { font-size: 20px; }
            .card-body, .sidebar-card { padding: 16px; }
            .match-teams { grid-template-columns: 1fr; gap: 16px; }
            .vs-circle { display: none; }
            .tab { padding: 10px 14px; font-size: 12px; }
            .login-card { padding: 30px 20px; }
            .pin-field { font-size: 20px; height: 48px; }
        }

        /* Accessibility - Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus Indicators */
        :focus-visible {
            outline: 2px solid var(--yellow);
            outline-offset: 2px;
        }

        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--yellow);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Initial Loading Screen (shown while checking session) -->
    <div id="initialLoader" role="status" aria-live="polite" aria-label="Loading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; position: fixed; inset: 0; background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%); z-index: 9999;">
        <img src="/images/gold_logo.png" alt="Burning River Dart Club" style="height: 80px; margin-bottom: 20px;">
        <div style="width: 40px; height: 40px; border: 3px solid rgba(255,70,154,0.3); border-top-color: #FF469A; border-radius: 50%; animation: spin 1s linear infinite;" aria-hidden="true"></div>
        <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
    </div>

    <!-- Login Overlay (hidden initially) -->
    <div id="loginOverlay" class="login-overlay" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
        <div class="login-card">
            <h1 class="login-title" id="loginTitle">üéØ LEAGUE DIRECTOR</h1>
            <p class="login-subtitle" id="loginDesc">Enter your 8-digit PIN to access the dashboard</p>
            <div class="pin-input">
                <label for="pinInput" class="sr-only">Enter your 8-digit PIN</label>
                <input type="password" id="pinInput" maxlength="8" class="pin-field" inputmode="numeric" pattern="[0-9]*" autocomplete="off" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" aria-required="true" aria-describedby="loginDesc loginError">
            </div>
            <button id="loginBtn" class="brdc-btn" style="width: 100%;">ENTER DASHBOARD</button>
            <p id="loginError" role="alert" aria-live="assertive" style="color: var(--pink); margin-top: 20px; display: none; font-weight: 600;"></p>
            <p style="margin-top: 20px; font-size: 12px; color: var(--text-dim);">Use your player PIN or the admin PIN shown when you created the league</p>
        </div>
    </div>

    <!-- Main Dashboard -->
    <main id="dashboard" style="display: none;" role="main">
        <header class="header-bar" role="banner">
            <button class="back-btn" onclick="history.back()" aria-label="Go back to previous page">‚Üê BACK</button>
            <img src="/images/gold_logo.png" alt="Burning River Dart Club" class="header-logo">
            <h2 class="header-title">LEAGUE DIRECTOR</h2>
        </header>
        <div class="brdc-card" style="max-width: 1400px; margin: 20px auto;">
            <div class="brdc-card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h1 class="brdc-title" style="font-size: 32px; color: white;" id="leagueName">Loading...</h1>
                    <p class="brdc-subtitle" style="color: white; margin-top: 5px;" id="leagueSeason"></p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <a href="#" id="standingsLink" class="brdc-btn brdc-btn-secondary" style="text-decoration: none; font-size: 14px;">üìä PUBLIC</a>
                    <button class="brdc-btn brdc-btn-secondary" onclick="logout()" style="font-size: 14px;">üö™ LOGOUT</button>
                </div>
            </div>

            <div style="padding: 25px;">
                <nav class="tab-container" role="tablist" aria-label="League director sections">
                    <button class="tab active" role="tab" aria-selected="true" aria-controls="matchesTab" onclick="switchTab('matches')">üìÖ Matches</button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="playersTab" onclick="switchTab('players')">üéØ Players<span id="playerCountBadge" class="player-count-badge" aria-label="player count">0</span></button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="standingsTab" onclick="switchTab('standings')">üèÜ Standings</button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="teamsTab" onclick="switchTab('teams')">üë• Teams</button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="statsTab" onclick="switchTab('stats')">üìà Stats</button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="contactTab" onclick="switchTab('contact')">üì± Contact</button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="settingsTab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
                    <button class="tab" role="tab" aria-selected="false" aria-controls="toolsTab" onclick="switchTab('tools')">üîß Director Tools</button>
                </nav>

                <!-- Matches Tab -->
                <div id="matchesTab" class="tab-content active">
                    <div class="dashboard-grid">
                        <div>
                            <div class="sidebar-card">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 22px; margin-bottom: 15px;">üìä Status</h3>
                                <div class="stat-row">
                                    <span class="stat-label">Status</span>
                                    <span class="stat-value" id="leagueStatus">-</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Week</span>
                                    <span class="stat-value"><span id="currentWeek">-</span> / <span id="totalWeeks">-</span></span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Teams</span>
                                    <span class="stat-value" id="teamCount">-</span>
                                </div>
                            </div>
                            <div class="sidebar-card">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 22px; margin-bottom: 15px;">‚ö° Actions</h3>
                                <div class="quick-action-grid">
                                    <button class="brdc-btn brdc-btn-secondary quick-action" onclick="advanceWeek()">‚è≠Ô∏è Next Week</button>
                                    <button class="brdc-btn brdc-btn-secondary quick-action" onclick="startAllMatches()">‚ñ∂Ô∏è Start All</button>
                                </div>
                            </div>
                            <div class="sidebar-card">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 22px; margin-bottom: 15px;">üìÖ Week</h3>
                                <div id="weekSelector" class="week-selector"></div>
                            </div>
                        </div>
                        <div id="matchesContainer">
                            <p style="text-align: center; padding: 40px; color: #666;">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Players Tab -->
                <div id="playersTab" class="tab-content">
                    <div class="dashboard-grid">
                        <div>
                            <!-- Add Single Player Form -->
                            <div class="sidebar-card">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 22px; margin-bottom: 15px;">‚ûï Add Player</h3>
                                <div class="form-group" style="margin-bottom: 12px;">
                                    <label>Name *</label>
                                    <input type="text" id="addPlayerName" placeholder="Player name">
                                </div>
                                <div class="form-group" style="margin-bottom: 12px;">
                                    <label>Email</label>
                                    <input type="email" id="addPlayerEmail" placeholder="email@example.com">
                                </div>
                                <div class="form-group" style="margin-bottom: 12px;">
                                    <label>Phone</label>
                                    <input type="tel" id="addPlayerPhone" placeholder="555-123-4567">
                                </div>
                                <div class="form-group" style="margin-bottom: 12px;">
                                    <label>501 Average</label>
                                    <input type="number" id="addPlayerAverage" placeholder="45.0" step="0.1">
                                </div>
                                <div class="form-group" style="margin-bottom: 12px;">
                                    <label>Preferred Level</label>
                                    <select id="addPlayerLevel">
                                        <option value="">-- Select --</option>
                                        <option value="A">A - Advanced</option>
                                        <option value="B">B - Intermediate</option>
                                        <option value="C">C - Beginner</option>
                                    </select>
                                </div>
                                <button class="brdc-btn" onclick="addSinglePlayer()" style="width: 100%;">ADD PLAYER</button>
                            </div>

                            <!-- Bulk Add Section -->
                            <div class="sidebar-card">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 22px; margin-bottom: 15px;">üìã Bulk Add</h3>
                                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Paste names (one per line) or CSV format:<br><code>Name, Email, Phone, Average, Level</code></p>
                                <textarea id="bulkPlayersText" class="bulk-textarea" placeholder="John Smith
Jane Doe
Bob Wilson, bob@email.com
Alice Brown, alice@email.com, 555-1234, 42.5, B"></textarea>
                                <button class="brdc-btn brdc-btn-secondary" onclick="bulkAddPlayers()" style="width: 100%; margin-top: 10px;">IMPORT PLAYERS</button>
                            </div>

                            <!-- Add Bot Section -->
                            <div class="sidebar-card">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 22px; margin-bottom: 15px;">ü§ñ Add Bot</h3>
                                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Add bots for testing. Bots auto-play when it's their turn.</p>
                                <select id="botSelect" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #333; background: #1a1a2e; color: #f0f0f0; margin-bottom: 10px;">
                                    <option value="">-- Select a bot --</option>
                                </select>
                                <button class="brdc-btn" onclick="addBotToLeague()" style="width: 100%; background: var(--teal);">ADD BOT TO LEAGUE</button>
                                <a href="/pages/bot-management.html" target="_blank" style="display: block; text-align: center; margin-top: 10px; font-size: 12px; color: var(--yellow);">Manage Bots ‚Üí</a>
                            </div>

                            <!-- Bulk Remove Section -->
                            <div class="sidebar-card">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 22px; margin-bottom: 15px;">üóëÔ∏è Bulk Remove</h3>
                                <button class="brdc-btn" id="selectModeBtn" onclick="toggleSelectMode()" style="width: 100%; background: #444; margin-bottom: 10px;">SELECT MODE: OFF</button>
                                <div id="selectionBar" style="display: none; background: rgba(239,68,68,0.2); padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 2px solid var(--danger);">
                                    <span id="selectedCount" style="font-weight: 700; color: var(--danger);">0 selected</span>
                                    <button class="brdc-btn" onclick="removeSelectedPlayers()" style="width: 100%; background: var(--danger); margin-top: 8px; font-size: 16px; padding: 10px;">REMOVE SELECTED</button>
                                </div>
                                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Or paste names to remove (one per line):</p>
                                <textarea id="bulkRemoveText" class="bulk-textarea" placeholder="John Smith
Jane Doe
Bob Wilson"></textarea>
                                <button class="brdc-btn" onclick="bulkRemoveByName()" style="width: 100%; background: var(--danger); margin-top: 10px;">REMOVE LISTED</button>
                            </div>
                        </div>

                        <div>
                            <!-- Filter Bar -->
                            <div class="filter-bar">
                                <input type="text" id="playerSearch" placeholder="Search players..." oninput="filterPlayers()">
                                <select id="playerFilter" onchange="filterPlayers()">
                                    <option value="all">All Players</option>
                                    <option value="unassigned">Unassigned</option>
                                    <option value="on_team">On Team</option>
                                    <option value="subs">Subs</option>
                                    <option value="bots">Bots</option>
                                </select>
                            </div>

                            <!-- Players List -->
                            <div id="playersContainer">
                                <p style="text-align: center; padding: 40px; color: #666;">Loading players...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Standings Tab -->
                <div id="standingsTab" class="tab-content">
                    <div id="standingsContainer"><p style="text-align: center; padding: 40px;">Loading...</p></div>
                </div>

                <!-- Teams Tab -->
                <div id="teamsTab" class="tab-content">
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="brdc-btn" onclick="showCreateTeamModal()">+ CREATE TEAM</button>
                        <button class="brdc-btn brdc-btn-secondary" onclick="runAutoDraft()">üé≤ AUTO DRAFT</button>
                        <a href="" id="manageTeamsLink" class="brdc-btn brdc-btn-secondary" style="text-decoration: none;">‚öôÔ∏è FULL MANAGEMENT</a>
                    </div>
                    <div id="teamsContainer"><p style="text-align: center; padding: 40px;">Loading...</p></div>
                </div>

                <!-- Stats Tab -->
                <div id="statsTab" class="tab-content">
                    <div id="statsContainer"><p style="text-align: center; padding: 40px;">Loading...</p></div>
                </div>

                <!-- Contact Tab -->
                <div id="contactTab" class="tab-content">
                    <div class="dashboard-grid">
                        <div>
                            <!-- Recipient Filters -->
                            <div class="sidebar-card">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 22px; margin-bottom: 15px;">üë• Recipients</h3>
                                <div style="margin-bottom: 15px;">
                                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                                        <input type="checkbox" id="filterCaptains" onchange="updateRecipientCount()">
                                        <span>Captains</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                                        <input type="checkbox" id="filterLevelA" onchange="updateRecipientCount()">
                                        <span>Level A Players</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                                        <input type="checkbox" id="filterLevelB" onchange="updateRecipientCount()">
                                        <span>Level B Players</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                                        <input type="checkbox" id="filterLevelC" onchange="updateRecipientCount()">
                                        <span>Level C Players</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                                        <input type="checkbox" id="filterAlternates" onchange="updateRecipientCount()">
                                        <span>Alternates / Subs</span>
                                    </label>
                                </div>
                                <hr style="border: 1px solid #333; margin: 15px 0;">
                                <button class="brdc-btn brdc-btn-secondary" onclick="selectAllRecipients()" style="width: 100%; margin-bottom: 8px;">SELECT ALL</button>
                                <button class="brdc-btn brdc-btn-secondary" onclick="clearAllRecipients()" style="width: 100%;">CLEAR ALL</button>
                            </div>

                            <!-- Individual Player Selection -->
                            <div class="sidebar-card">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 22px; margin-bottom: 15px;">üîç Add Individual</h3>
                                <input type="text" id="contactPlayerSearch" placeholder="Search by name..." oninput="searchContactPlayers()" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #333; background: #1a1a2e; color: #f0f0f0; margin-bottom: 10px;">
                                <div id="contactPlayerResults" style="max-height: 200px; overflow-y: auto;"></div>
                                <div id="selectedPlayersChips" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div>
                            </div>
                        </div>

                        <div>
                            <!-- Message Composer -->
                            <div class="sidebar-card">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 22px; margin-bottom: 15px;">‚úçÔ∏è Compose Message</h3>

                                <!-- Tag Buttons -->
                                <div style="margin-bottom: 15px;">
                                    <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Insert variables (click to add):</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        <button class="brdc-btn brdc-btn-secondary" onclick="insertTag('[first_name]')" style="padding: 6px 10px; font-size: 11px;">[first_name]</button>
                                        <button class="brdc-btn brdc-btn-secondary" onclick="insertTag('[last_name]')" style="padding: 6px 10px; font-size: 11px;">[last_name]</button>
                                        <button class="brdc-btn brdc-btn-secondary" onclick="insertTag('[full_name]')" style="padding: 6px 10px; font-size: 11px;">[full_name]</button>
                                        <button class="brdc-btn brdc-btn-secondary" onclick="insertTag('[pin]')" style="padding: 6px 10px; font-size: 11px;">[pin]</button>
                                        <button class="brdc-btn brdc-btn-secondary" onclick="insertTag('[team_name]')" style="padding: 6px 10px; font-size: 11px;">[team_name]</button>
                                        <button class="brdc-btn brdc-btn-secondary" onclick="insertTag('[dashboard_link]')" style="padding: 6px 10px; font-size: 11px;">[dashboard_link]</button>
                                        <button class="brdc-btn brdc-btn-secondary" onclick="insertTag('[league_name]')" style="padding: 6px 10px; font-size: 11px;">[league_name]</button>
                                        <button class="brdc-btn brdc-btn-secondary" onclick="insertTag('[next_match_date]')" style="padding: 6px 10px; font-size: 11px;">[next_match_date]</button>
                                        <button class="brdc-btn brdc-btn-secondary" onclick="insertTag('[next_match_pin]')" style="padding: 6px 10px; font-size: 11px;">[next_match_pin]</button>
                                    </div>
                                </div>

                                <textarea id="contactMessage" placeholder="Type your message here..." style="width: 100%; min-height: 200px; padding: 15px; border-radius: 8px; border: 2px solid #333; background: #1a1a2e; color: #f0f0f0; font-size: 14px; resize: vertical;"></textarea>

                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                                    <span id="recipientCount" style="color: #666; font-size: 13px;">0 recipients selected</span>
                                    <span id="charCount" style="color: #666; font-size: 13px;">0 / 160 chars</span>
                                </div>

                                <button class="brdc-btn" onclick="sendCustomMessage()" style="width: 100%; margin-top: 15px; font-size: 16px;">üì± SEND MESSAGE</button>
                                <p style="font-size: 11px; color: #666; margin-top: 8px; text-align: center;">Messages sent via SMS to players with phone numbers</p>
                            </div>

                            <!-- Message Preview -->
                            <div class="sidebar-card">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 22px; margin-bottom: 15px;">üëÅÔ∏è Preview</h3>
                                <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Example with sample player data:</p>
                                <div id="messagePreview" style="background: #0a0a15; border-radius: 8px; padding: 15px; font-family: monospace; font-size: 13px; white-space: pre-wrap; min-height: 80px; color: #4ade80;">Your message will appear here...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tab-content">
                    <div style="max-width: 900px; margin: 0 auto;">

                        <!-- League Info Section -->
                        <div class="sidebar-card" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--pink);">üìã League Information</h3>
                                <button class="brdc-btn brdc-btn-secondary" onclick="toggleEditSection('leagueInfo')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è EDIT</button>
                            </div>
                            <div id="leagueInfoDisplay" class="settings-display">
                                <div class="settings-grid">
                                    <div><span class="setting-label">League Name:</span> <span id="displayLeagueName">-</span></div>
                                    <div><span class="setting-label">Season:</span> <span id="displaySeason">-</span></div>
                                    <div><span class="setting-label">League Type:</span> <span id="displayLeagueMode">-</span></div>
                                    <div><span class="setting-label">Max Teams:</span> <span id="displayMaxTeams">Unlimited</span></div>
                                    <div><span class="setting-label">Entry Fee:</span> <span id="displayEntryFee">-</span></div>
                                    <div><span class="setting-label">Format:</span> <span id="displayFormat">-</span></div>
                                    <div><span class="setting-label">Teams:</span> <span id="displayTeamCount">-</span></div>
                                    <div><span class="setting-label">Players/Team:</span> <span id="displayPlayersPerTeam">-</span></div>
                                    <div><span class="setting-label">Weeks:</span> <span id="displayWeeks">-</span></div>
                                </div>
                            </div>
                            <div id="leagueInfoEdit" class="settings-edit" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div class="form-group">
                                        <label class="brdc-label">League Name</label>
                                        <input type="text" id="settingLeagueName" class="brdc-input">
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Season</label>
                                        <input type="text" id="settingSeason" class="brdc-input" placeholder="e.g. Spring 2025">
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">League Type</label>
                                        <select id="settingLeagueMode" class="brdc-select">
                                            <option value="draft">Draft League</option>
                                            <option value="team">Team League</option>
                                        </select>
                                        <span style="font-size: 11px; color: var(--text-dim);">Draft: individuals register, then captains draft. Team: pre-formed teams register.</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Max Teams</label>
                                        <input type="number" id="settingMaxTeams" class="brdc-input" min="2" max="32" placeholder="Unlimited">
                                        <span style="font-size: 11px; color: var(--text-dim);">Leave blank for unlimited</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Entry Fee Per Player ($)</label>
                                        <input type="number" id="settingEntryFee" class="brdc-input" min="0" step="0.01" placeholder="0.00">
                                    </div>
                                </div>
                                <button class="brdc-btn" onclick="saveSection('leagueInfo')" style="margin-top: 15px;">üíæ SAVE</button>
                            </div>
                        </div>

                        <!-- Schedule Section -->
                        <div class="sidebar-card" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--pink);">üìÖ Schedule</h3>
                                <button class="brdc-btn brdc-btn-secondary" onclick="toggleEditSection('schedule')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è EDIT</button>
                            </div>
                            <div id="scheduleDisplay" class="settings-display">
                                <div class="settings-grid">
                                    <div><span class="setting-label">Start Date:</span> <span id="displayStartDate">-</span></div>
                                    <div><span class="setting-label">Registration Closes:</span> <span id="displayRegCloseDate">-</span></div>
                                    <div><span class="setting-label">League Night:</span> <span id="displayLeagueNight">-</span></div>
                                    <div><span class="setting-label">Start Time:</span> <span id="displayStartTime">-</span></div>
                                    <div><span class="setting-label">Blackout Dates:</span> <span id="displayBlackouts">None</span></div>
                                </div>
                            </div>
                            <div id="scheduleEdit" class="settings-edit" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div class="form-group">
                                        <label class="brdc-label">Start Date</label>
                                        <input type="date" id="settingStartDate" class="brdc-input">
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Registration Closes</label>
                                        <input type="date" id="settingRegCloseDate" class="brdc-input">
                                        <span style="font-size: 11px; color: var(--text-dim);">Leave blank to close on start date</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">League Night</label>
                                        <select id="settingLeagueNight" class="brdc-select">
                                            <option value="monday">Monday</option>
                                            <option value="tuesday">Tuesday</option>
                                            <option value="wednesday">Wednesday</option>
                                            <option value="thursday">Thursday</option>
                                            <option value="friday">Friday</option>
                                            <option value="saturday">Saturday</option>
                                            <option value="sunday">Sunday</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Start Time</label>
                                        <input type="time" id="settingStartTime" class="brdc-input">
                                    </div>
                                </div>
                                <div style="margin-top: 15px;">
                                    <label class="brdc-label">Blackout Dates</label>
                                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                                        <input type="date" id="blackoutDateInput" class="brdc-input" style="flex: 1;">
                                        <button class="brdc-btn brdc-btn-secondary" onclick="addBlackoutDate()">ADD</button>
                                    </div>
                                    <div id="blackoutDatesList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div>
                                </div>
                                <button class="brdc-btn" onclick="saveSection('schedule')" style="margin-top: 15px;">üíæ SAVE</button>
                            </div>
                        </div>

                        <!-- Venue Section -->
                        <div class="sidebar-card" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--pink);">üìç Venue</h3>
                                <button class="brdc-btn brdc-btn-secondary" onclick="toggleEditSection('venue')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è EDIT</button>
                            </div>
                            <div id="venueDisplay" class="settings-display">
                                <div class="settings-grid">
                                    <div><span class="setting-label">Venue:</span> <span id="displayVenueName">-</span></div>
                                    <div><span class="setting-label">Address:</span> <span id="displayVenueAddress">-</span></div>
                                </div>
                            </div>
                            <div id="venueEdit" class="settings-edit" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div class="form-group">
                                        <label class="brdc-label">Venue Name</label>
                                        <input type="text" id="settingVenueName" class="brdc-input">
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Address</label>
                                        <input type="text" id="settingVenueAddress" class="brdc-input">
                                    </div>
                                </div>
                                <button class="brdc-btn" onclick="saveSection('venue')" style="margin-top: 15px;">üíæ SAVE</button>
                            </div>
                        </div>

                        <!-- Match Format Section -->
                        <div class="sidebar-card" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--pink);">üéØ Match Format</h3>
                                <button class="brdc-btn brdc-btn-secondary" onclick="toggleEditSection('matchFormat')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è EDIT</button>
                            </div>
                            <div id="matchFormatDisplay" class="settings-display">
                                <div class="settings-grid">
                                    <div><span class="setting-label">Game Format:</span> <span id="displayGameFormat">-</span></div>
                                    <div><span class="setting-label">In Rule:</span> <span id="displayInRule">-</span></div>
                                    <div><span class="setting-label">Checkout:</span> <span id="displayCheckout">-</span></div>
                                    <div><span class="setting-label">Best Of:</span> <span id="displayBestOf">-</span></div>
                                    <div><span class="setting-label">Games/Match:</span> <span id="displayGamesPerMatch">-</span></div>
                                    <div><span class="setting-label">Cork Rule:</span> <span id="displayCorkRule">-</span></div>
                                    <div><span class="setting-label">Point System:</span> <span id="displayPointSystem">-</span></div>
                                </div>
                            </div>
                            <div id="matchFormatEdit" class="settings-edit" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                                    <div class="form-group">
                                        <label class="brdc-label">Format</label>
                                        <select id="settingFormat" class="brdc-select">
                                            <option value="501">501</option>
                                            <option value="301">301</option>
                                            <option value="701">701</option>
                                            <option value="cricket">Cricket</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">In Rule</label>
                                        <select id="settingInRule" class="brdc-select">
                                            <option value="straight">Straight In</option>
                                            <option value="double">Double In</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Checkout</label>
                                        <select id="settingCheckout" class="brdc-select">
                                            <option value="double">Double Out</option>
                                            <option value="master">Master Out</option>
                                            <option value="straight">Straight Out</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Best Of</label>
                                        <select id="settingBestOf" class="brdc-select">
                                            <option value="1">1 Leg</option>
                                            <option value="3">Best of 3</option>
                                            <option value="5">Best of 5</option>
                                            <option value="7">Best of 7</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Games Per Match</label>
                                        <input type="number" id="settingRounds" class="brdc-input" min="1" max="20" value="9">
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Point System</label>
                                        <select id="settingPointSystem" class="brdc-select">
                                            <option value="game_based">Game-Based</option>
                                            <option value="match_based">Match-Based</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Cork Rule</label>
                                        <select id="settingCorkRule" class="brdc-select">
                                            <option value="cork_first_leg">Cork First Leg</option>
                                            <option value="cork_every_leg">Cork Every Leg</option>
                                            <option value="home_first">Home First</option>
                                        </select>
                                    </div>
                                </div>
                                <button class="brdc-btn" onclick="saveSection('matchFormat')" style="margin-top: 15px;">üíæ SAVE</button>
                            </div>
                        </div>

                        <!-- Match Format Builder Section -->
                        <div class="sidebar-card" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--pink);">üéØ Match Format Builder</h3>
                                <button class="brdc-btn brdc-btn-secondary" onclick="toggleEditSection('formatBuilder')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è EDIT</button>
                            </div>
                            <div id="formatBuilderDisplay" class="settings-display">
                                <div id="displayRoundsSummary" style="color: var(--text-dim);">
                                    <p>Configure individual rounds in your match format.</p>
                                    <div id="roundsSummaryList" style="margin-top: 10px;"></div>
                                </div>
                            </div>
                            <div id="formatBuilderEdit" class="settings-edit" style="display: none;">
                                <p style="font-size: 12px; color: var(--text-dim); margin-bottom: 12px;">Define each round in a match. Each round can have different game types and rules.</p>
                                <div id="roundsBuilderList" style="display: flex; flex-direction: column; gap: 12px;">
                                    <!-- Rounds will be populated by JavaScript -->
                                </div>
                                <button class="brdc-btn brdc-btn-secondary" onclick="addRoundToBuilder()" style="margin-top: 12px; width: 100%;">+ ADD ROUND</button>
                                <button class="brdc-btn" onclick="saveSection('formatBuilder')" style="margin-top: 15px;">üíæ SAVE</button>
                            </div>
                        </div>

                        <!-- League Rules Section -->
                        <div class="sidebar-card" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--pink);">üìä League Rules</h3>
                                <button class="brdc-btn brdc-btn-secondary" onclick="toggleEditSection('leagueRules')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è EDIT</button>
                            </div>
                            <div id="leagueRulesDisplay" class="settings-display">
                                <div class="settings-grid">
                                    <div><span class="setting-label">Level Rules:</span> <span id="displayLevelRules">-</span></div>
                                    <div><span class="setting-label">Playoff Format:</span> <span id="displayPlayoffFormat">-</span></div>
                                    <div><span class="setting-label">Bye Points:</span> <span id="displayByePoints">-</span></div>
                                    <div><span class="setting-label">Session Fee:</span> <span id="displaySessionFee">-</span></div>
                                </div>
                            </div>
                            <div id="leagueRulesEdit" class="settings-edit" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div class="form-group">
                                        <label class="brdc-label">Level Rules</label>
                                        <select id="settingLevelRules" class="brdc-select">
                                            <option value="strict">Strict (A vs A only)</option>
                                            <option value="play_up">Play Up Allowed</option>
                                            <option value="flexible">Flexible</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Playoff Format</label>
                                        <select id="settingPlayoffFormat" class="brdc-select">
                                            <option value="none">No Playoffs</option>
                                            <option value="top_4_single">Top 4 Single Elim</option>
                                            <option value="top_4_double">Top 4 Double Elim</option>
                                            <option value="top_6_single">Top 6 Single Elim</option>
                                            <option value="top_8_single">Top 8 Single Elim</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Bye Points</label>
                                        <select id="settingByePoints" class="brdc-select">
                                            <option value="average">Average</option>
                                            <option value="fixed">Fixed</option>
                                            <option value="none">None</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Session Fee ($)</label>
                                        <input type="number" id="settingSessionFee" class="brdc-input" min="0" step="0.01">
                                    </div>
                                </div>
                                <button class="brdc-btn" onclick="saveSection('leagueRules')" style="margin-top: 15px;">üíæ SAVE</button>
                            </div>
                        </div>

                        <!-- Tiebreaker Rules Section -->
                        <div class="sidebar-card" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--pink);">‚öñÔ∏è Tiebreaker Rules</h3>
                                <button class="brdc-btn brdc-btn-secondary" onclick="toggleEditSection('tiebreakers')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è EDIT</button>
                            </div>
                            <div id="tiebreakersDisplay" class="settings-display">
                                <div id="displayTiebreakerOrder" style="color: var(--text-dim);">
                                    <ol style="margin: 0; padding-left: 20px;">
                                        <li>Head-to-Head</li>
                                        <li>Point Differential</li>
                                        <li>Total Points Scored</li>
                                    </ol>
                                </div>
                            </div>
                            <div id="tiebreakersEdit" class="settings-edit" style="display: none;">
                                <p style="font-size: 12px; color: var(--text-dim); margin-bottom: 12px;">Drag to reorder priority. First enabled rule breaks ties.</p>
                                <div id="tiebreakerList" class="tiebreaker-list" style="display: flex; flex-direction: column; gap: 8px;">
                                    <div class="tiebreaker-item" data-value="head_to_head" draggable="true" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-panel); border: 2px solid var(--border-strong); border-radius: 8px; cursor: grab;">
                                        <span class="drag-handle" style="color: var(--text-dim);">‚ò∞</span>
                                        <input type="checkbox" checked style="width: 18px; height: 18px; accent-color: var(--pink);">
                                        <span style="flex: 1; font-size: 13px;">Head-to-Head</span>
                                    </div>
                                    <div class="tiebreaker-item" data-value="point_diff" draggable="true" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-panel); border: 2px solid var(--border-strong); border-radius: 8px; cursor: grab;">
                                        <span class="drag-handle" style="color: var(--text-dim);">‚ò∞</span>
                                        <input type="checkbox" checked style="width: 18px; height: 18px; accent-color: var(--pink);">
                                        <span style="flex: 1; font-size: 13px;">Point Differential</span>
                                    </div>
                                    <div class="tiebreaker-item" data-value="total_points" draggable="true" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-panel); border: 2px solid var(--border-strong); border-radius: 8px; cursor: grab;">
                                        <span class="drag-handle" style="color: var(--text-dim);">‚ò∞</span>
                                        <input type="checkbox" checked style="width: 18px; height: 18px; accent-color: var(--pink);">
                                        <span style="flex: 1; font-size: 13px;">Total Points Scored</span>
                                    </div>
                                    <div class="tiebreaker-item" data-value="cork_off" draggable="true" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-panel); border: 2px solid var(--border-strong); border-radius: 8px; cursor: grab;">
                                        <span class="drag-handle" style="color: var(--text-dim);">‚ò∞</span>
                                        <input type="checkbox" style="width: 18px; height: 18px; accent-color: var(--pink);">
                                        <span style="flex: 1; font-size: 13px;">Cork-Off</span>
                                    </div>
                                </div>
                                <button class="brdc-btn" onclick="saveSection('tiebreakers')" style="margin-top: 15px;">üíæ SAVE</button>
                            </div>
                        </div>

                        <!-- Cork & Start Rules Section -->
                        <div class="sidebar-card" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--pink);">üéØ Cork & Start Rules</h3>
                                <button class="brdc-btn brdc-btn-secondary" onclick="toggleEditSection('corkRules')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è EDIT</button>
                            </div>
                            <div id="corkRulesDisplay" class="settings-display">
                                <div class="settings-grid">
                                    <div><span class="setting-label">Start Rules:</span> <span id="displayStartRules">-</span></div>
                                    <div><span class="setting-label">Cork Option:</span> <span id="displayCorkOption">-</span></div>
                                    <div><span class="setting-label">Cork Winner Gets:</span> <span id="displayCorkWinnerGets">-</span></div>
                                </div>
                            </div>
                            <div id="corkRulesEdit" class="settings-edit" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                                    <div class="form-group">
                                        <label class="brdc-label">Start Rules</label>
                                        <select id="settingStartRules" class="brdc-select">
                                            <option value="cork_every_leg">Cork every leg</option>
                                            <option value="alternate_cork_first_deciding">Alternate, cork first/deciding</option>
                                            <option value="loser_starts_cork_first_deciding">Loser starts, cork first/deciding</option>
                                            <option value="winner_starts_cork_first_deciding">Winner starts, cork first/deciding</option>
                                        </select>
                                        <span style="font-size: 11px; color: var(--text-dim);">Determines who throws first in each leg</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Cork Option Rules (Who Gets Choice)</label>
                                        <select id="settingCorkOption" class="brdc-select">
                                            <option value="alternate_random_first_last">Alternate, randomize first and last</option>
                                            <option value="random_every_leg">Randomize every leg</option>
                                            <option value="away_team_option">Away team option</option>
                                            <option value="home_team_option">Home team option</option>
                                            <option value="loser_option">Loser option</option>
                                            <option value="winner_option">Winner option</option>
                                        </select>
                                        <span style="font-size: 11px; color: var(--text-dim);">Who has the option to throw first or second</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Cork Winner Gets (Corks Choice games)</label>
                                        <select id="settingCorkWinnerGets" class="brdc-select">
                                            <option value="choose-and-start">Choose game AND start</option>
                                            <option value="choose-only">Choose game only (other starts)</option>
                                        </select>
                                        <span style="font-size: 11px; color: var(--text-dim);">Advantage for Corks Choice legs</span>
                                    </div>
                                </div>
                                <button class="brdc-btn" onclick="saveSection('corkRules')" style="margin-top: 15px;">üíæ SAVE</button>
                            </div>
                        </div>

                        <!-- Team Configuration Section -->
                        <div class="sidebar-card" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--pink);">üë• Team Configuration</h3>
                                <button class="brdc-btn brdc-btn-secondary" onclick="toggleEditSection('teamConfig')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è EDIT</button>
                            </div>
                            <div id="teamConfigDisplay" class="settings-display">
                                <div class="settings-grid">
                                    <div><span class="setting-label">Min Players:</span> <span id="displayMinPlayers">-</span></div>
                                    <div><span class="setting-label">Max Roster:</span> <span id="displayMaxRoster">-</span></div>
                                    <div><span class="setting-label">Schedule Format:</span> <span id="displayScheduleFormat">-</span></div>
                                    <div><span class="setting-label">Fill-ins Allowed:</span> <span id="displayFillins">-</span></div>
                                </div>
                            </div>
                            <div id="teamConfigEdit" class="settings-edit" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div class="form-group">
                                        <label class="brdc-label">Min Players Needed</label>
                                        <input type="number" id="settingMinPlayers" class="brdc-input" min="1" max="10" value="3">
                                        <span style="font-size: 11px; color: var(--text-dim);">Minimum roster to avoid forfeit</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Max Roster Spots</label>
                                        <input type="number" id="settingMaxRoster" class="brdc-input" min="1" max="12" value="4">
                                        <span style="font-size: 11px; color: var(--text-dim);">Total allowed on roster</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Schedule Format</label>
                                        <select id="settingScheduleFormat" class="brdc-select">
                                            <option value="round_robin">Round Robin</option>
                                            <option value="double_round_robin">Double Round Robin</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="brdc-label">Allow Fill-ins</label>
                                        <select id="settingAllowFillins" class="brdc-select" onchange="toggleFillinOptions()">
                                            <option value="true">Yes</option>
                                            <option value="false">No</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Fill-in Configuration Panel -->
                                <div id="fillinOptionsPanel" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,70,154,0.1); border: 1px solid rgba(255,70,154,0.3); border-radius: 8px;">
                                    <div style="font-weight: bold; color: var(--pink); margin-bottom: 10px;">Fill-in Signup Form Fields:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                        <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
                                            <input type="checkbox" checked disabled style="accent-color: var(--teal);">
                                            Name & Contact (required)
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
                                            <input type="checkbox" id="settingFillinCollect501" checked style="accent-color: var(--teal);">
                                            501 Average
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
                                            <input type="checkbox" id="settingFillinCollectCricket" checked style="accent-color: var(--teal);">
                                            Cricket Average (MPR)
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary);">
                                            <input type="checkbox" id="settingFillinCollectLevel" checked style="accent-color: var(--teal);">
                                            Preferred Level
                                        </label>
                                    </div>
                                    <span style="font-size: 11px; color: var(--text-dim); margin-top: 10px; display: block;">Fill-ins can substitute for unavailable players at their level or lower</span>
                                </div>
                                <button class="brdc-btn" onclick="saveSection('teamConfig')" style="margin-top: 15px;">üíæ SAVE</button>
                            </div>
                        </div>

                        <!-- Additional Rules Section -->
                        <div class="sidebar-card" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--pink);">üìù Additional Rules</h3>
                                <button class="brdc-btn brdc-btn-secondary" onclick="toggleEditSection('additionalRules')" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è EDIT</button>
                            </div>
                            <div id="additionalRulesDisplay" class="settings-display">
                                <div id="displayLeagueRulesText" style="color: var(--text-dim); white-space: pre-wrap;">No additional rules specified</div>
                            </div>
                            <div id="additionalRulesEdit" class="settings-edit" style="display: none;">
                                <div class="form-group">
                                    <label class="brdc-label">League Rules & Notes</label>
                                    <textarea id="settingLeagueRulesText" class="brdc-input" rows="6" style="resize: vertical;" placeholder="Enter any additional league rules, house rules, or notes here..."></textarea>
                                    <span style="font-size: 11px; color: var(--text-dim);">This will be visible on the public league page</span>
                                </div>
                                <button class="brdc-btn" onclick="saveSection('additionalRules')" style="margin-top: 15px;">üíæ SAVE</button>
                            </div>
                        </div>

                        <!-- Status & Actions Section -->
                        <div class="sidebar-card" style="margin-bottom: 20px;">
                            <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; margin-bottom: 15px; color: var(--pink);">‚öôÔ∏è Status & Actions</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label class="brdc-label">League Status</label>
                                    <select id="statusSelect" class="brdc-select">
                                        <option value="registration">Registration Open</option>
                                        <option value="draft">Draft Phase</option>
                                        <option value="active">Active</option>
                                        <option value="playoffs">Playoffs</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                                <div style="display: flex; align-items: flex-end;">
                                    <button class="brdc-btn" onclick="updateStatus()" style="width: 100%;">UPDATE STATUS</button>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <button class="brdc-btn brdc-btn-secondary" onclick="generateSchedule()" style="width: 100%;">üîÑ REGENERATE SCHEDULE</button>
                                <button class="brdc-btn" onclick="notifyAllPlayers()" style="width: 100%;">üì± TEXT ALL PLAYERS</button>
                            </div>
                        </div>

                        <!-- Draft Controls Section (visible for draft leagues) -->
                        <div class="sidebar-card" style="margin-bottom: 20px; display: none;" id="draftControlsSection">
                            <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; margin-bottom: 15px; color: var(--teal);">üéØ Draft Controls</h3>

                            <!-- Draft Status Display -->
                            <div id="draftStatusDisplay" style="margin-bottom: 15px; padding: 12px; background: rgba(145, 215, 235, 0.1); border: 2px solid var(--teal); border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-dim);">Draft Status:</span>
                                    <span id="draftStatusBadge" style="padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; background: rgba(253, 216, 53, 0.2); color: var(--yellow);">PENDING</span>
                                </div>
                                <div id="draftProgressDisplay" style="margin-top: 10px; display: none;">
                                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-dim); margin-bottom: 4px;">
                                        <span>Pick <span id="draftCurrentPick">0</span> of <span id="draftTotalPicks">0</span></span>
                                        <span id="draftCurrentTeam">-</span>
                                    </div>
                                    <div style="height: 6px; background: var(--bg-card); border-radius: 3px; overflow: hidden;">
                                        <div id="draftProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--teal), var(--pink)); transition: width 0.3s;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Draft Action Buttons -->
                            <div style="display: grid; gap: 12px;">
                                <button class="brdc-btn" id="openDraftRoomBtn" onclick="openDraftRoom()" style="width: 100%; background: linear-gradient(135deg, var(--teal), #5ab8d4); color: #000;">
                                    üéØ OPEN DRAFT ROOM
                                </button>
                                <button class="brdc-btn brdc-btn-secondary" id="viewDraftResultsBtn" onclick="viewDraftResults()" style="width: 100%; display: none;">
                                    üìã VIEW DRAFT RESULTS
                                </button>
                            </div>

                            <!-- Draft Settings Summary -->
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 8px;">Draft Settings:</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                                    <div><span style="color: var(--text-dim);">Order:</span> <span id="draftOrderMethod" style="color: var(--text-light);">Random</span></div>
                                    <div><span style="color: var(--text-dim);">Time:</span> <span id="draftTimePerPick" style="color: var(--text-light);">60s</span></div>
                                    <div><span style="color: var(--text-dim);">Style:</span> <span id="draftStyle" style="color: var(--text-light);">Snake</span></div>
                                    <div><span style="color: var(--text-dim);">Auto-pick:</span> <span id="draftAutoPick" style="color: var(--text-light);">Yes</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- Danger Zone -->
                        <div class="sidebar-card" style="border: 2px solid #ef4444;">
                            <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; margin-bottom: 15px; color: #ef4444;">‚ö†Ô∏è Danger Zone</h3>
                            <p style="color: #666; font-size: 12px; margin-bottom: 15px;">Permanently delete this league and all data. Cannot be undone.</p>
                            <button class="brdc-btn" style="background: #ef4444; width: 100%;" onclick="deleteLeague()">DELETE LEAGUE</button>
                        </div>

                    </div>
                </div>

                <!-- Director Tools Tab -->
                <div id="toolsTab" class="tab-content">
                    <div class="dashboard-grid">
                        <div>
                            <!-- Quick Stats -->
                            <div class="sidebar-card">
                                <h3 style="font-family: 'Bebas Neue', cursive; font-size: 22px; margin-bottom: 15px;">üîß Director Tools</h3>
                                <p style="color: var(--text-dim); font-size: 13px; margin-bottom: 15px;">
                                    Tools for managing match results, player levels, and rescheduling matches.
                                </p>
                                <div class="stat-row">
                                    <span class="stat-label">Corrections Made</span>
                                    <span class="stat-value" id="correctionsCount">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Rescheduled Matches</span>
                                    <span class="stat-value" id="rescheduledCount">0</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <!-- Match Corrections Section -->
                            <div class="card" style="margin-bottom: 20px;">
                                <div class="card-header pink">
                                    <div class="card-icon">üìù</div>
                                    <div class="card-title">Match Corrections</div>
                                </div>
                                <div class="card-body">
                                    <p style="color: var(--text-dim); font-size: 13px; margin-bottom: 16px;">
                                        Correct scores for completed matches. Changes are logged for audit purposes.
                                    </p>
                                    <div class="filter-bar" style="margin-bottom: 16px;">
                                        <select id="correctionWeekFilter" onchange="filterCorrectionMatches()">
                                            <option value="all">All Weeks</option>
                                        </select>
                                        <select id="correctionStatusFilter" onchange="filterCorrectionMatches()">
                                            <option value="completed">Completed Only</option>
                                            <option value="all">All Matches</option>
                                        </select>
                                    </div>
                                    <div id="correctionMatchesList">
                                        <p style="text-align: center; padding: 20px; color: var(--text-dim);">Loading completed matches...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Player Level Management Section -->
                            <div class="card" style="margin-bottom: 20px;">
                                <div class="card-header teal">
                                    <div class="card-icon">üéØ</div>
                                    <div class="card-title">Player Level Management</div>
                                </div>
                                <div class="card-body">
                                    <p style="color: var(--text-dim); font-size: 13px; margin-bottom: 16px;">
                                        Adjust player skill levels (A, B, C). Changes affect match formatting and stats.
                                    </p>
                                    <div class="filter-bar" style="margin-bottom: 16px;">
                                        <input type="text" id="levelPlayerSearch" placeholder="Search players..." oninput="filterLevelPlayers()">
                                        <select id="levelFilter" onchange="filterLevelPlayers()">
                                            <option value="all">All Levels</option>
                                            <option value="A">Level A Only</option>
                                            <option value="B">Level B Only</option>
                                            <option value="C">Level C Only</option>
                                            <option value="unassigned">Unassigned</option>
                                        </select>
                                    </div>
                                    <div id="levelPlayersList">
                                        <p style="text-align: center; padding: 20px; color: var(--text-dim);">Loading players...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Match Rescheduling Section -->
                            <div class="card">
                                <div class="card-header yellow">
                                    <div class="card-icon">üìÖ</div>
                                    <div class="card-title">Match Rescheduling</div>
                                </div>
                                <div class="card-body">
                                    <p style="color: var(--text-dim); font-size: 13px; margin-bottom: 16px;">
                                        Reschedule matches to different dates. Mark as makeup matches if needed.
                                    </p>
                                    <div class="filter-bar" style="margin-bottom: 16px;">
                                        <select id="rescheduleWeekFilter" onchange="filterRescheduleMatches()">
                                            <option value="all">All Weeks</option>
                                        </select>
                                        <select id="rescheduleStatusFilter" onchange="filterRescheduleMatches()">
                                            <option value="scheduled">Scheduled Only</option>
                                            <option value="all">All Matches</option>
                                        </select>
                                    </div>
                                    <div id="rescheduleMatchesList">
                                        <p style="text-align: center; padding: 20px; color: var(--text-dim);">Loading matches...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Match Correction Modal -->
    <div id="correctionModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Correct Match Score</span>
                <button class="modal-close" onclick="closeCorrectionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="correctionMatchId">
                <div class="score-display">
                    <span class="team-name" id="correctionHomeTeam">Home Team</span>
                    <span class="score" id="correctionCurrentScore">0 - 0</span>
                    <span class="team-name" id="correctionAwayTeam">Away Team</span>
                </div>
                <p style="text-align: center; color: var(--text-dim); margin-bottom: 16px;">Enter new scores below:</p>
                <div class="score-input-group">
                    <input type="number" id="correctionNewHomeScore" min="0" max="99" placeholder="0">
                    <span style="font-size: 24px; color: var(--text-dim);">-</span>
                    <input type="number" id="correctionNewAwayScore" min="0" max="99" placeholder="0">
                </div>
                <div class="form-group">
                    <label class="brdc-label">Correction Reason</label>
                    <textarea id="correctionReason" class="bulk-textarea" style="min-height: 80px;" placeholder="Enter reason for correction..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="brdc-btn brdc-btn-secondary" onclick="closeCorrectionModal()">Cancel</button>
                <button class="brdc-btn" onclick="submitCorrection()">Save Correction</button>
            </div>
        </div>
    </div>

    <!-- Reschedule Modal -->
    <div id="rescheduleModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header yellow">
                <span class="modal-title" style="color: #000;">Reschedule Match</span>
                <button class="modal-close" onclick="closeRescheduleModal()" style="color: #000;">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rescheduleMatchId">
                <div style="margin-bottom: 16px;">
                    <p style="font-weight: 700; color: var(--text-light);"><span id="rescheduleMatchTeams">Team A vs Team B</span></p>
                    <p style="color: var(--text-dim); font-size: 13px;">Week <span id="rescheduleMatchWeek">1</span></p>
                </div>
                <div class="form-group">
                    <label class="brdc-label">Current Date</label>
                    <p id="rescheduleCurrentDate" style="color: var(--yellow); font-weight: 700;">-</p>
                </div>
                <div class="form-group">
                    <label class="brdc-label">New Date</label>
                    <input type="datetime-local" id="rescheduleNewDate" class="brdc-input">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="rescheduleIsMakeup" style="width: 20px; height: 20px;">
                        <span class="brdc-label" style="margin: 0;">Mark as Makeup Match</span>
                    </label>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="rescheduleNotify" style="width: 20px; height: 20px;">
                        <span class="brdc-label" style="margin: 0;">Notify Team Captains</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="brdc-btn brdc-btn-secondary" onclick="closeRescheduleModal()">Cancel</button>
                <button class="brdc-btn" style="background: linear-gradient(135deg, var(--yellow), #f9a825); color: #000;" onclick="submitReschedule()">Reschedule</button>
            </div>
        </div>
    </div>

    <!-- Create Team Modal -->
    <div id="createTeamModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-panel); border: 4px solid #000; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 8px 8px 0 rgba(0,0,0,0.5);">
            <h3 style="font-family: 'Bebas Neue', cursive; font-size: 28px; margin-bottom: 20px; color: var(--pink);">CREATE TEAM</h3>
            <div class="form-group" style="margin-bottom: 20px;">
                <label class="brdc-label">Team Name</label>
                <input type="text" id="newTeamName" class="brdc-input" placeholder="Enter team name">
            </div>
            <div style="display: grid; gap: 15px;">
                <div class="form-group">
                    <label class="brdc-label" style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: var(--pink); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: 700;">A</span>
                        Position A Player
                    </label>
                    <input type="text" id="teamPlayerA" class="brdc-input player-search" placeholder="Type to search players..." list="playerListA" autocomplete="off">
                    <datalist id="playerListA"></datalist>
                    <input type="hidden" id="teamPlayerA_id">
                </div>
                <div class="form-group">
                    <label class="brdc-label" style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: var(--yellow); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: 700;">B</span>
                        Position B Player
                    </label>
                    <input type="text" id="teamPlayerB" class="brdc-input player-search" placeholder="Type to search players..." list="playerListB" autocomplete="off">
                    <datalist id="playerListB"></datalist>
                    <input type="hidden" id="teamPlayerB_id">
                </div>
                <div class="form-group">
                    <label class="brdc-label" style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: var(--teal); color: #000; padding: 2px 8px; border-radius: 4px; font-weight: 700;">C</span>
                        Position C Player
                    </label>
                    <input type="text" id="teamPlayerC" class="brdc-input player-search" placeholder="Type to search players..." list="playerListC" autocomplete="off">
                    <datalist id="playerListC"></datalist>
                    <input type="hidden" id="teamPlayerC_id">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button class="brdc-btn brdc-btn-secondary" onclick="closeCreateTeamModal()" style="flex: 1;">CANCEL</button>
                <button class="brdc-btn" onclick="createTeamWithRoster()" style="flex: 1;">CREATE TEAM</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, doc, getDoc, collection, query, where, getDocs, updateDoc, callFunction, showLoading, hideLoading } from '/js/firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        let leagueId = urlParams.get('league_id');
        let leagueData = null;
        let adminPin = null;
        let currentWeek = 1;
        let teamsData = [];
        let matchesData = [];
        let playersData = [];
        let selectMode = false;
        let selectedPlayers = new Set();

        // Check for saved director session
        (async function checkSavedSession() {
            // 1. Check for PIN in URL (from create-league success page)
            const urlPin = urlParams.get('pin');
            if (urlPin && urlPin.length === 8) {
                try {
                    const result = await callFunction('verifyLeaguePin', {
                        league_id: leagueId || null,
                        pin: urlPin
                    });
                    if (result.success) {
                        leagueId = result.league_id;
                        leagueData = { id: leagueId, ...result.league };
                        window.history.replaceState({}, '', `?league_id=${leagueId}`);
                        adminPin = urlPin;
                        document.getElementById('initialLoader').style.display = 'none';
                        document.getElementById('loginOverlay').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'block';
                        initDashboard();
                        return;
                    }
                } catch (e) {
                    console.error('URL PIN verify error:', e);
                }
            }

            // 2. Check for league-specific admin PIN in localStorage
            if (leagueId) {
                const leaguePin = localStorage.getItem('leagueAdminPin_' + leagueId);
                if (leaguePin) {
                    try {
                        const session = JSON.parse(leaguePin);
                        if (session.pin && (Date.now() - session.timestamp) < 7 * 24 * 60 * 60 * 1000) {
                            const result = await callFunction('verifyLeaguePin', {
                                league_id: leagueId,
                                pin: session.pin
                            });
                            if (result.success) {
                                leagueData = { id: leagueId, ...result.league };
                                adminPin = session.pin;
                                document.getElementById('initialLoader').style.display = 'none';
                        document.getElementById('loginOverlay').style.display = 'none';
                                document.getElementById('dashboard').style.display = 'block';
                                initDashboard();
                                return;
                            }
                        }
                    } catch (e) {
                        console.error('League PIN restore error:', e);
                    }
                }
            }

            // 3. Fall back to generic director session
            const saved = localStorage.getItem('directorSession');
            if (saved) {
                try {
                    const session = JSON.parse(saved);
                    // Session valid for 7 days
                    if (session.pin && (Date.now() - session.timestamp) < 7 * 24 * 60 * 60 * 1000) {
                        // Try to auto-login with saved PIN
                        const result = await callFunction('verifyLeaguePin', {
                            league_id: leagueId || null,
                            pin: session.pin
                        });
                        if (result.success) {
                            leagueId = result.league_id;
                            leagueData = { id: leagueId, ...result.league };
                            window.history.replaceState({}, '', `?league_id=${leagueId}`);
                            adminPin = session.pin;
                            document.getElementById('initialLoader').style.display = 'none';
                        document.getElementById('loginOverlay').style.display = 'none';
                            document.getElementById('dashboard').style.display = 'block';
                            initDashboard();
                            return;
                        }
                    }
                } catch (e) {
                    console.error('Session restore error:', e);
                }
            }
            // Show login if no valid session
            document.getElementById('initialLoader').style.display = 'none';
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('loginOverlay').classList.add('active');
            document.getElementById('pinInput').focus();
        })();

        // PIN input handling
        const pinInput = document.getElementById('pinInput');
        pinInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
        pinInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') document.getElementById('loginBtn').click();
        });

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const pin = pinInput.value.trim();
            if (pin.length !== 8) { showLoginError('Enter 8-digit PIN'); return; }

            try {
                // Use Cloud Function to verify PIN (bypasses Firestore security rules)
                const result = await callFunction('verifyLeaguePin', {
                    league_id: leagueId || null,
                    pin: pin
                });

                if (!result.success) {
                    showLoginError(result.error || 'Invalid PIN');
                    return;
                }

                leagueId = result.league_id;
                leagueData = { id: leagueId, ...result.league };
                window.history.replaceState({}, '', `?league_id=${leagueId}`);

                adminPin = pin;

                // Save league-specific PIN (don't overwrite player session used for templates)
                localStorage.setItem('leagueAdminPin_' + leagueId, JSON.stringify({
                    pin: pin,
                    timestamp: Date.now()
                }));

                document.getElementById('initialLoader').style.display = 'none';
                        document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                initDashboard();
            } catch (error) {
                showLoginError('Error: ' + error.message);
            }
        });

        function showLoginError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        async function initDashboard() {
            document.getElementById('leagueName').textContent = leagueData.league_name;
            document.getElementById('leagueSeason').textContent = leagueData.season || '';
            document.getElementById('standingsLink').href = `/pages/league-view.html?league_id=${leagueId}`;
            document.getElementById('manageTeamsLink').href = `/pages/league-view.html?league_id=${leagueId}`;
            document.getElementById('leagueStatus').textContent = leagueData.status.toUpperCase();
            document.getElementById('currentWeek').textContent = leagueData.current_week || 1;
            document.getElementById('totalWeeks').textContent = leagueData.total_weeks || '-';
            document.getElementById('statusSelect').value = leagueData.status;
            currentWeek = leagueData.current_week || 1;

            // Load blackout dates
            blackoutDates = leagueData.blackout_dates || [];
            renderBlackoutDates();

            await loadTeams();
            await loadMatches();
            await loadPlayers();
            await loadBots();
            renderWeekSelector();
            renderMatches();
            populateSettingsForm();

            // Initialize draft controls for draft leagues
            if (leagueData.league_type === 'draft' || leagueData.league_mode === 'draft') {
                initDraftControls();
            }
        }

        async function loadTeams() {
            try {
                const result = await callFunction('getTeams', { league_id: leagueId });
                if (result.success) {
                    teamsData = result.teams;
                    document.getElementById('teamCount').textContent = teamsData.length;
                }
            } catch (e) { console.error(e); }
        }

        async function loadMatches() {
            try {
                const result = await callFunction('getSchedule', { league_id: leagueId });
                if (result.success) matchesData = result.matches;
            } catch (e) { console.error(e); }
        }

        function renderWeekSelector() {
            const container = document.getElementById('weekSelector');
            const total = leagueData.total_weeks || Math.max(...matchesData.map(m => m.week), 1);
            let html = '';
            for (let w = 1; w <= total; w++) {
                html += `<button class="week-btn ${w === currentWeek ? 'active' : ''}" onclick="selectWeek(${w})">${w}</button>`;
            }
            container.innerHTML = html;
        }

        window.selectWeek = function(week) {
            currentWeek = week;
            document.querySelectorAll('.week-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderMatches();
        };

        function renderMatches() {
            const container = document.getElementById('matchesContainer');
            const weekMatches = matchesData.filter(m => m.week === currentWeek);

            if (!weekMatches.length) {
                container.innerHTML = `<div class="sidebar-card" style="text-align: center; padding: 50px;">
                    <p style="font-size: 18px; font-weight: 600;">No matches for Week ${currentWeek}</p>
                    <p style="color: #666; margin-top: 10px;">Generate schedule in Settings.</p>
                </div>`;
                return;
            }

            let html = `<h2 style="font-family: 'Bebas Neue', cursive; font-size: 28px; margin-bottom: 20px;">Week ${currentWeek}</h2>`;

            weekMatches.forEach(match => {
                html += `
                    <div class="match-card">
                        <div class="match-header">
                            <span>${match.match_date}</span>
                            <span class="status-badge status-${match.status}">${match.status.replace('_',' ').toUpperCase()}</span>
                        </div>
                        <div class="match-teams">
                            <div class="team-info">
                                <div class="team-name">${match.home_team_name}</div>
                                <div class="team-players">${getTeamPlayers(match.home_team_id)}</div>
                            </div>
                            <div class="vs-circle">VS</div>
                            <div class="team-info">
                                <div class="team-name">${match.away_team_name}</div>
                                <div class="team-players">${getTeamPlayers(match.away_team_id)}</div>
                            </div>
                        </div>
                        ${match.status !== 'scheduled' ? `
                            <div class="match-score">
                                <div class="score-box"><div class="score-value">${match.home_score}</div><div class="score-label">Home</div></div>
                                <div class="score-box"><div class="score-value">${match.away_score}</div><div class="score-label">Away</div></div>
                            </div>` : ''}
                        ${match.match_pin ? `<div class="pin-display"><div style="font-size: 11px; font-weight: 700;">MATCH PIN</div><div class="pin-code">${match.match_pin}</div></div>` : ''}
                        <div class="match-actions">
                            ${match.status === 'scheduled' ? `<button class="brdc-btn" onclick="startMatch('${match.id}')">‚ñ∂Ô∏è START</button>` :
                              match.status === 'in_progress' ? `<button class="brdc-btn brdc-btn-secondary" onclick="viewMatch('${match.id}')">üëÅÔ∏è VIEW</button><button class="brdc-btn" onclick="finalizeMatch('${match.id}')">‚úÖ FINALIZE</button>` :
                              `<button class="brdc-btn brdc-btn-secondary" onclick="viewMatch('${match.id}')">üìã RESULTS</button>`}
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function getTeamPlayers(teamId) {
            const team = teamsData.find(t => t.id === teamId);
            if (!team?.players) return 'No players';
            const posLabel = (pos) => ['', 'A', 'B', 'C'][pos] || pos;
            return team.players.map(p => `${posLabel(p.position)}: ${p.name}`).join('<br>');
        }

        window.startMatch = async function(matchId) {
            if (!confirm('Start match? This generates a PIN for tablet access.')) return;
            try {
                const result = await callFunction('startMatch', { league_id: leagueId, match_id: matchId, admin_pin: adminPin });
                if (result.success) {
                    alert(`Match started!\n\nPIN: ${result.match_pin}`);
                    await loadMatches();
                    renderMatches();
                } else alert('Error: ' + result.error);
            } catch (e) { alert('Error: ' + e.message); }
        };

        window.viewMatch = function(matchId) {
            window.open(`/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}`, '_blank');
        };

        window.finalizeMatch = async function(matchId) {
            if (!confirm('Finalize match and update standings?')) return;
            try {
                const result = await callFunction('finalizeMatch', { league_id: leagueId, match_id: matchId });
                if (result.success) {
                    alert(`Finalized! ${result.final_score.home} - ${result.final_score.away}`);
                    await loadMatches();
                    renderMatches();
                } else alert('Error: ' + result.error);
            } catch (e) { alert('Error: ' + e.message); }
        };

        window.startAllMatches = async function() {
            const scheduled = matchesData.filter(m => m.week === currentWeek && m.status === 'scheduled');
            if (!scheduled.length) { alert('No scheduled matches.'); return; }
            if (!confirm(`Start all ${scheduled.length} matches?`)) return;

            const pins = [];
            for (const m of scheduled) {
                try {
                    const r = await callFunction('startMatch', { league_id: leagueId, match_id: m.id, admin_pin: adminPin });
                    if (r.success) pins.push(`${m.home_team_name} vs ${m.away_team_name}: ${r.match_pin}`);
                } catch (e) { console.error(e); }
            }
            await loadMatches();
            renderMatches();
            alert(`Started!\n\n${pins.join('\n')}`);
        };

        window.advanceWeek = async function() {
            const newWeek = (leagueData.current_week || 1) + 1;
            if (!confirm(`Advance to Week ${newWeek}?`)) return;
            try {
                await updateDoc(doc(db, 'leagues', leagueId), { current_week: newWeek });
                leagueData.current_week = newWeek;
                currentWeek = newWeek;
                document.getElementById('currentWeek').textContent = newWeek;
                renderWeekSelector();
                renderMatches();
            } catch (e) { alert('Error: ' + e.message); }
        };

        window.generateSchedule = async function() {
            if (!confirm('Generate schedule for entire season?')) return;
            try {
                const result = await callFunction('generateSchedule', { league_id: leagueId, admin_pin: adminPin });
                if (result.success) {
                    alert(`Created ${result.matches_created} matches over ${result.total_weeks} weeks!`);
                    location.reload();
                } else alert('Error: ' + result.error);
            } catch (e) { alert('Error: ' + e.message); }
        };

        window.updateStatus = async function() {
            const status = document.getElementById('statusSelect').value;
            try {
                const result = await callFunction('updateLeagueStatus', { league_id: leagueId, admin_pin: adminPin, status: status });
                if (result.success) {
                    leagueData.status = status;
                    document.getElementById('leagueStatus').textContent = status.toUpperCase();
                    alert('Updated!');
                } else alert('Error: ' + result.error);
            } catch (e) { alert('Error: ' + e.message); }
        };

        window.deleteLeague = async function() {
            const leagueName = leagueData.league_name;
            const confirmName = prompt(`This will permanently delete "${leagueName}" and all its data.\n\nType the league name to confirm:`);
            if (confirmName !== leagueName) {
                if (confirmName !== null) alert('League name did not match. Deletion cancelled.');
                return;
            }

            try {
                const result = await callFunction('deleteLeague', { league_id: leagueId, admin_pin: adminPin });
                if (result.success) {
                    alert('League deleted successfully.');
                    window.location.href = '/pages/dashboard.html';
                } else alert('Error: ' + result.error);
            } catch (e) { alert('Error: ' + e.message); }
        };

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.closest('.tab').classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            if (tabName === 'standings') loadStandings();
            if (tabName === 'teams') renderTeams();
            if (tabName === 'stats') loadStats();
            if (tabName === 'players') renderPlayers();
            if (tabName === 'settings') populateSettingsForm();
            if (tabName === 'tools') loadDirectorTools();
        };

        async function loadStandings() {
            const container = document.getElementById('standingsContainer');
            try {
                const result = await callFunction('getStandings', { league_id: leagueId });
                if (!result.success || !result.standings.length) {
                    container.innerHTML = '<p style="text-align: center; padding: 40px;">No standings yet.</p>';
                    return;
                }
                let html = `<table style="width: 100%; border-collapse: collapse; background: white; border: 3px solid var(--black);">
                    <thead><tr style="background: var(--pink); color: white;">
                        <th style="padding: 12px;">#</th><th style="padding: 12px; text-align: left;">Team</th>
                        <th style="padding: 12px;">W</th><th style="padding: 12px;">L</th><th style="padding: 12px;">T</th>
                        <th style="padding: 12px;">Pts</th><th style="padding: 12px;">GW</th><th style="padding: 12px;">GL</th><th style="padding: 12px;">G%</th>
                    </tr></thead><tbody>`;
                result.standings.forEach(t => {
                    html += `<tr style="border-bottom: 2px solid #eee;">
                        <td style="padding: 12px; text-align: center; font-weight: 700;">${t.rank}</td>
                        <td style="padding: 12px; font-weight: 700;">${t.team_name}</td>
                        <td style="padding: 12px; text-align: center;">${t.wins}</td>
                        <td style="padding: 12px; text-align: center;">${t.losses}</td>
                        <td style="padding: 12px; text-align: center;">${t.ties}</td>
                        <td style="padding: 12px; text-align: center; font-weight: 700; color: var(--pink);">${t.points}</td>
                        <td style="padding: 12px; text-align: center;">${t.games_won}</td>
                        <td style="padding: 12px; text-align: center;">${t.games_lost}</td>
                        <td style="padding: 12px; text-align: center;">${t.game_pct}%</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) { container.innerHTML = `<p style="color: red;">Error: ${e.message}</p>`; }
        }

        function renderTeams() {
            const container = document.getElementById('teamsContainer');
            if (!teamsData.length) {
                container.innerHTML = '<p style="text-align: center; padding: 40px;">No teams yet.</p>';
                return;
            }
            const posLabel = (pos) => ['', 'A', 'B', 'C'][pos] || pos;
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">';
            teamsData.forEach(team => {
                html += `<div class="sidebar-card">
                    <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; margin-bottom: 15px;">${team.team_name}</h3>
                    <div style="line-height: 2;">${team.players ? team.players.map(p => `<div style="display: flex; justify-content: space-between;"><span style="font-weight: 600;">${posLabel(p.position)}</span><span>${p.name}${p.position === 1 ? ' üëë' : ''}</span></div>`).join('') : 'No players'}</div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee; display: flex; justify-content: space-between;">
                        <span>Record:</span><span style="font-weight: 700;">${team.wins}-${team.losses}${team.ties ? `-${team.ties}` : ''}</span>
                    </div>
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        async function loadStats() {
            const container = document.getElementById('statsContainer');
            try {
                const result = await callFunction('getLeaderboards', { league_id: leagueId });
                if (!result.success) { container.innerHTML = '<p style="text-align: center; padding: 40px;">No stats yet.</p>'; return; }
                const lb = result.leaderboards;
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
                html += renderLB('üéØ 501 Average', lb.x01_average, 'x01_three_dart_avg');
                html += renderLB('üíØ 180s', lb.x01_180s, 'x01_ton_eighties');
                html += renderLB('üî• 171s', lb.x01_171s, 'x01_one_seventy_ones');
                html += renderLB('üéØ High Out', lb.x01_high_checkout, 'x01_high_checkout');
                html += renderLB('üí™ 100+ Outs', lb.x01_ton_plus_checkouts, 'x01_ton_plus_checkouts');
                html += renderLB('ü¶ó Cricket MPR', lb.cricket_mpr, 'cricket_mpr');
                html += renderLB('‚≠ê 9-Marks', lb.cricket_9_marks, 'cricket_nine_mark_rounds');
                html += '</div>';
                container.innerHTML = html;
            } catch (e) { container.innerHTML = `<p style="color: red;">Error: ${e.message}</p>`; }
        }

        function renderLB(title, data, field) {
            if (!data?.length) return `<div class="sidebar-card"><h3 style="font-family: 'Bebas Neue', cursive; font-size: 20px; margin-bottom: 15px;">${title}</h3><p style="color: #666;">No data</p></div>`;
            let html = `<div class="sidebar-card"><h3 style="font-family: 'Bebas Neue', cursive; font-size: 20px; margin-bottom: 15px;">${title}</h3>`;
            data.slice(0, 5).forEach((p, i) => {
                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i+1}.`;
                html += `<div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee;"><span>${medal} ${p.player_name}</span><span style="font-weight: 700;">${p[field]}</span></div>`;
            });
            return html + '</div>';
        }

        // ============================================================================
        // PLAYER MANAGEMENT FUNCTIONS
        // ============================================================================

        async function loadPlayers() {
            try {
                const result = await callFunction('getPlayers', { league_id: leagueId });
                if (result.success) {
                    playersData = result.players;
                    document.getElementById('playerCountBadge').textContent = playersData.length;
                }
            } catch (e) { console.error('Error loading players:', e); }
        }

        function renderPlayers() {
            const container = document.getElementById('playersContainer');
            const searchTerm = document.getElementById('playerSearch').value.toLowerCase();
            const filter = document.getElementById('playerFilter').value;

            let filtered = playersData.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchTerm) ||
                    (p.email && p.email.toLowerCase().includes(searchTerm));

                if (!matchesSearch) return false;

                if (filter === 'unassigned') return !p.team_id;
                if (filter === 'on_team') return p.team_id;
                if (filter === 'subs') return p.is_sub;
                if (filter === 'bots') return p.isBot;
                return true;
            });

            if (!filtered.length) {
                container.innerHTML = `<div class="sidebar-card" style="text-align: center; padding: 40px;">
                    <p style="font-size: 16px; font-weight: 600;">${playersData.length ? 'No players match filter' : 'No players yet'}</p>
                    <p style="color: #666; margin-top: 10px;">Add players using the form on the left.</p>
                </div>`;
                return;
            }

            let html = '';
            filtered.forEach(player => {
                const teamName = player.team_id ? getTeamName(player.team_id) : null;
                const statusClass = player.team_id ? 'on-team' : (player.is_sub ? 'is-sub' : '');
                const isSelected = selectedPlayers.has(player.id);
                const canSelect = selectMode && !player.team_id;

                const botBadge = player.isBot ? `<span style="background: var(--teal); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 700; margin-left: 8px;">ü§ñ BOT - ${player.botDifficulty || 'medium'}</span>` : '';
                const checkbox = canSelect ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="togglePlayerSelection('${player.id}')" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">` : '';
                const selectedStyle = isSelected ? 'background: rgba(239,68,68,0.15); border-color: var(--danger);' : '';

                html += `
                    <div class="player-card ${statusClass}" style="${player.isBot ? 'border-left: 3px solid var(--teal);' : ''} ${selectedStyle}">
                        <div class="player-info" style="display: flex; align-items: flex-start;">
                            ${checkbox}
                            <div>
                                <div class="player-name-display">${player.name} ${player.is_captain ? 'üëë' : ''}${botBadge}</div>
                                <div class="player-meta">
                                    ${player.email ? `üìß ${player.email}` : ''}
                                    ${player.phone ? ` ¬∑ üì± ${player.phone}` : ''}
                                    ${player.reported_average ? ` ¬∑ Avg: ${player.reported_average}` : ''}
                                    ${player.preferred_level ? ` ¬∑ Level: ${player.preferred_level}` : ''}
                                </div>
                                <div class="player-meta" style="margin-top: 4px;">
                                    ${teamName ? `<span style="color: #10b981; font-weight: 600;">Team: ${teamName}</span>` : '<span style="color: #f59e0b;">Unassigned</span>'}
                                    ${player.is_sub ? ' ¬∑ <span style="color: var(--yellow);">Sub</span>' : ''}
                                    ${player.pin ? ` ¬∑ PIN: <code>${player.pin}</code>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="player-actions">
                            ${!player.team_id ? `
                                <select id="teamSelect_${player.id}" style="padding: 6px; border-radius: 4px; border: 2px solid #444; background: #1a1a2e; color: #fff; font-size: 12px;">
                                    <option value="">-- Team --</option>
                                    ${teamsData.map(t => `<option value="${t.id}">${t.team_name}</option>`).join('')}
                                </select>
                                <select id="posSelect_${player.id}" style="padding: 6px; border-radius: 4px; border: 2px solid #444; background: #1a1a2e; color: #fff; font-size: 12px; width: 50px;">
                                    <option value="1">A</option>
                                    <option value="2">B</option>
                                    <option value="3">C</option>
                                </select>
                                <button class="edit-btn" style="background: var(--success);" onclick="assignToTeam('${player.id}')">Assign</button>
                            ` : `
                                <button class="edit-btn" style="background: #666;" onclick="removeFromTeam('${player.id}')">Remove</button>
                            `}
                            <button class="edit-btn" onclick="editPlayer('${player.id}')">Edit</button>
                            ${!player.team_id ? `<button class="delete-btn" onclick="deletePlayer('${player.id}', '${player.name}')">Delete</button>` : ''}
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function getTeamName(teamId) {
            const team = teamsData.find(t => t.id === teamId);
            return team ? team.team_name : 'Unknown Team';
        }

        window.filterPlayers = function() {
            renderPlayers();
        };

        window.assignToTeam = async function(playerId) {
            const teamSelect = document.getElementById(`teamSelect_${playerId}`);
            const posSelect = document.getElementById(`posSelect_${playerId}`);
            const teamId = teamSelect?.value;
            const position = posSelect?.value;

            if (!teamId) {
                alert('Please select a team');
                return;
            }

            showLoading('Assigning player to team...');
            try {
                const result = await callFunction('updatePlayer', {
                    league_id: leagueId,
                    admin_pin: adminPin,
                    player_id: playerId,
                    updates: {
                        team_id: teamId,
                        position: parseInt(position)
                    }
                });

                if (result.success) {
                    await loadPlayers();
                    renderPlayers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
            hideLoading();
        };

        window.removeFromTeam = async function(playerId) {
            if (!confirm('Remove this player from their team?')) return;

            showLoading('Removing from team...');
            try {
                const result = await callFunction('updatePlayer', {
                    league_id: leagueId,
                    admin_pin: adminPin,
                    player_id: playerId,
                    updates: {
                        team_id: null,
                        position: null,
                        is_captain: false
                    }
                });

                if (result.success) {
                    await loadPlayers();
                    renderPlayers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
            hideLoading();
        };

        window.addSinglePlayer = async function() {
            const name = document.getElementById('addPlayerName').value.trim();
            const email = document.getElementById('addPlayerEmail').value.trim();
            const phone = document.getElementById('addPlayerPhone').value.trim();
            const average = document.getElementById('addPlayerAverage').value;
            const level = document.getElementById('addPlayerLevel').value;

            if (!name) {
                alert('Please enter a player name');
                return;
            }

            showLoading('Adding player...');
            try {
                const result = await callFunction('addPlayer', {
                    league_id: leagueId,
                    admin_pin: adminPin,
                    name: name,
                    email: email || null,
                    phone: phone || null,
                    average: average || null,
                    preferred_level: level || null
                });

                if (result.success) {
                    alert(`Player added!\nPIN: ${result.player_pin}`);
                    // Clear form
                    document.getElementById('addPlayerName').value = '';
                    document.getElementById('addPlayerEmail').value = '';
                    document.getElementById('addPlayerPhone').value = '';
                    document.getElementById('addPlayerAverage').value = '';
                    document.getElementById('addPlayerLevel').value = '';
                    // Reload players
                    await loadPlayers();
                    renderPlayers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
            hideLoading();
        };

        window.bulkAddPlayers = async function() {
            const text = document.getElementById('bulkPlayersText').value.trim();
            if (!text) {
                alert('Please enter player names');
                return;
            }

            const lines = text.split('\n').filter(l => l.trim());
            const players = [];

            for (const line of lines) {
                const parts = line.split(',').map(p => p.trim());
                const player = {
                    name: parts[0] || ''
                };
                if (parts[1]) player.email = parts[1];
                if (parts[2]) player.phone = parts[2];
                if (parts[3]) player.average = parts[3];
                if (parts[4]) player.preferred_level = parts[4];

                if (player.name) {
                    players.push(player);
                }
            }

            if (!players.length) {
                alert('No valid players found');
                return;
            }

            if (!confirm(`Import ${players.length} players?`)) return;

            showLoading('Importing players...');
            try {
                const result = await callFunction('bulkAddPlayers', {
                    league_id: leagueId,
                    admin_pin: adminPin,
                    players: players
                });

                if (result.success) {
                    let msg = `‚úì Added ${result.added_count} players`;
                    if (result.skipped_count > 0) {
                        msg += `\n\n‚ö† Skipped ${result.skipped_count}:`;
                        if (result.results && result.results.skipped) {
                            result.results.skipped.forEach(s => {
                                msg += `\n  ‚Ä¢ ${s.name}: ${s.reason}`;
                            });
                        }
                    }
                    alert(msg);
                    document.getElementById('bulkPlayersText').value = '';
                    await loadPlayers();
                    renderPlayers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
            hideLoading();
        };

        // ==================== BULK REMOVE FUNCTIONS ====================

        window.toggleSelectMode = function() {
            selectMode = !selectMode;
            selectedPlayers.clear();
            const btn = document.getElementById('selectModeBtn');
            const bar = document.getElementById('selectionBar');

            if (selectMode) {
                btn.textContent = 'SELECT MODE: ON';
                btn.style.background = 'var(--danger)';
                bar.style.display = 'block';
            } else {
                btn.textContent = 'SELECT MODE: OFF';
                btn.style.background = '#444';
                bar.style.display = 'none';
            }
            updateSelectionCount();
            renderPlayers();
        };

        window.togglePlayerSelection = function(playerId) {
            if (selectedPlayers.has(playerId)) {
                selectedPlayers.delete(playerId);
            } else {
                selectedPlayers.add(playerId);
            }
            updateSelectionCount();
            renderPlayers();
        };

        function updateSelectionCount() {
            document.getElementById('selectedCount').textContent = `${selectedPlayers.size} selected`;
        }

        window.removeSelectedPlayers = async function() {
            if (selectedPlayers.size === 0) {
                alert('No players selected');
                return;
            }

            if (!confirm(`Remove ${selectedPlayers.size} players? This cannot be undone.`)) return;

            showLoading('Removing players...');
            try {
                const result = await callFunction('bulkRemovePlayers', {
                    league_id: leagueId,
                    admin_pin: adminPin,
                    player_ids: Array.from(selectedPlayers)
                });

                if (result.success) {
                    let msg = `Removed ${result.deleted_count} players`;
                    if (result.skipped_count > 0) {
                        msg += `\nSkipped ${result.skipped_count} (on teams)`;
                    }
                    alert(msg);
                    selectedPlayers.clear();
                    updateSelectionCount();
                    await loadPlayers();
                    renderPlayers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
            hideLoading();
        };

        window.bulkRemoveByName = async function() {
            const text = document.getElementById('bulkRemoveText').value.trim();
            if (!text) {
                alert('Enter player names to remove (one per line)');
                return;
            }

            const names = text.split('\n').map(n => n.trim()).filter(n => n);
            if (!names.length) {
                alert('No valid names found');
                return;
            }

            if (!confirm(`Remove ${names.length} players by name? This cannot be undone.`)) return;

            showLoading('Removing players...');
            try {
                const result = await callFunction('bulkRemovePlayers', {
                    league_id: leagueId,
                    admin_pin: adminPin,
                    player_names: names
                });

                if (result.success) {
                    let msg = `Removed ${result.deleted_count} players`;
                    if (result.skipped_count > 0) {
                        msg += `\nSkipped ${result.skipped_count} (on teams)`;
                    }
                    if (result.not_found_count > 0) {
                        msg += `\nNot found: ${result.not_found_count}`;
                        if (result.results.notFound.length > 0) {
                            msg += `\n(${result.results.notFound.slice(0, 5).join(', ')}${result.results.notFound.length > 5 ? '...' : ''})`;
                        }
                    }
                    alert(msg);
                    document.getElementById('bulkRemoveText').value = '';
                    await loadPlayers();
                    renderPlayers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
            hideLoading();
        };

        // ==================== END BULK REMOVE ====================

        window.editPlayer = async function(playerId) {
            const player = playersData.find(p => p.id === playerId);
            if (!player) return;

            const newName = prompt('Player name:', player.name);
            if (newName === null) return;

            const newEmail = prompt('Email:', player.email || '');
            if (newEmail === null) return;

            const newPhone = prompt('Phone:', player.phone || '');
            if (newPhone === null) return;

            const newAvg = prompt('501 Average:', player.reported_average || '');
            if (newAvg === null) return;

            const newLevel = prompt('Level (A/B/C):', player.preferred_level || '');
            if (newLevel === null) return;

            try {
                const result = await callFunction('updatePlayer', {
                    league_id: leagueId,
                    admin_pin: adminPin,
                    player_id: playerId,
                    updates: {
                        name: newName.trim() || player.name,
                        email: newEmail.trim() || null,
                        phone: newPhone.trim() || null,
                        reported_average: newAvg || null,
                        preferred_level: newLevel.toUpperCase() || null
                    }
                });

                if (result.success) {
                    alert('Player updated!');
                    await loadPlayers();
                    renderPlayers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        };

        window.deletePlayer = async function(playerId, playerName) {
            if (!confirm(`Delete ${playerName}? This cannot be undone.`)) return;

            showLoading('Deleting player...');
            try {
                const result = await callFunction('deletePlayer', {
                    league_id: leagueId,
                    admin_pin: adminPin,
                    player_id: playerId
                });

                if (result.success) {
                    alert('Player deleted');
                    await loadPlayers();
                    renderPlayers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
            hideLoading();
        };

        // ============================================================================
        // BOT MANAGEMENT FUNCTIONS
        // ============================================================================
        let availableBots = [];

        async function loadBots() {
            try {
                const result = await callFunction('getBots', {});
                availableBots = result.bots || [];
                updateBotSelect();
            } catch (e) {
                console.error('Error loading bots:', e);
            }
        }

        function updateBotSelect() {
            const select = document.getElementById('botSelect');
            if (!select) return;

            // Get IDs of bots already in the league
            const leagueBotIds = playersData
                .filter(p => p.source_bot_id)
                .map(p => p.source_bot_id);

            select.innerHTML = '<option value="">-- Select a bot --</option>';
            availableBots.forEach(bot => {
                const alreadyAdded = leagueBotIds.includes(bot.id);
                select.innerHTML += `<option value="${bot.id}" ${alreadyAdded ? 'disabled' : ''}>${bot.name} (${bot.difficulty})${alreadyAdded ? ' - Already added' : ''}</option>`;
            });

            if (availableBots.length === 0) {
                select.innerHTML = '<option value="">No bots available - Create some first</option>';
            }
        }

        window.addBotToLeague = async function() {
            const botId = document.getElementById('botSelect').value;
            if (!botId) {
                alert('Please select a bot');
                return;
            }

            try {
                const result = await callFunction('addBotToLeague', {
                    league_id: leagueId,
                    admin_pin: adminPin,
                    bot_id: botId
                });

                if (result.success) {
                    alert(`Bot "${result.bot_name}" added to league!`);
                    await loadPlayers();
                    renderPlayers();
                    updateBotSelect();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        };

        // Blackout dates management
        let blackoutDates = [];

        function renderBlackoutDates() {
            const container = document.getElementById('blackoutDatesList');
            if (!blackoutDates || blackoutDates.length === 0) {
                container.innerHTML = '<span style="color: #666; font-size: 14px;">No blackout dates set</span>';
                return;
            }
            container.innerHTML = blackoutDates.map(date => {
                const formatted = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                return `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(239, 68, 68, 0.15); border: 2px solid #ef4444; border-radius: 20px; font-size: 14px; color: #ef4444;">
                        <span>${formatted}</span>
                        <button onclick="removeBlackoutDate('${date}')" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 16px; padding: 0;">&times;</button>
                    </div>
                `;
            }).join('');
        }

        window.addBlackoutDate = async function() {
            const input = document.getElementById('blackoutDateInput');
            const date = input.value;
            if (!date) return;
            if (blackoutDates.includes(date)) {
                alert('This date is already added');
                return;
            }
            blackoutDates.push(date);
            blackoutDates.sort();

            try {
                await updateDoc(doc(db, 'leagues', leagueId), { blackout_dates: blackoutDates });
                renderBlackoutDates();
                input.value = '';
                // Recalculate match dates to skip blackout dates
                await recalculateMatchDates();
            } catch (e) {
                blackoutDates = blackoutDates.filter(d => d !== date);
                alert('Error saving: ' + e.message);
            }
        };

        window.removeBlackoutDate = async function(date) {
            if (!confirm('Remove this blackout date?')) return;
            const oldDates = [...blackoutDates];
            blackoutDates = blackoutDates.filter(d => d !== date);

            try {
                await updateDoc(doc(db, 'leagues', leagueId), { blackout_dates: blackoutDates });
                renderBlackoutDates();
                // Recalculate match dates without the removed blackout date
                await recalculateMatchDates();
            } catch (e) {
                blackoutDates = oldDates;
                alert('Error removing: ' + e.message);
            }
        };

        async function recalculateMatchDates() {
            try {
                const result = await callFunction('updateMatchDates', { league_id: leagueId });
                if (result.success) {
                    console.log('Match dates recalculated:', result);
                    if (result.skipped_weeks > 0) {
                        alert(`Schedule updated! ${result.skipped_weeks} blackout week(s) skipped.`);
                    }
                    // Reload schedule display if it exists
                    if (typeof loadScheduleTab === 'function') {
                        loadScheduleTab();
                    }
                }
            } catch (e) {
                console.error('Error recalculating match dates:', e);
            }
        }

        // ============================================================================
        // SETTINGS TAB FUNCTIONS
        // ============================================================================

        function populateSettingsForm() {
            // Populate form inputs - Basic Info
            document.getElementById('settingLeagueName').value = leagueData.league_name || '';
            document.getElementById('settingSeason').value = leagueData.season || '';
            document.getElementById('settingLeagueMode').value = leagueData.league_mode || 'draft';
            document.getElementById('settingMaxTeams').value = leagueData.max_teams || '';
            document.getElementById('settingEntryFee').value = leagueData.entry_fee || '';
            document.getElementById('settingStartDate').value = leagueData.start_date || '';
            document.getElementById('settingRegCloseDate').value = leagueData.registration_close_date || '';
            document.getElementById('settingLeagueNight').value = leagueData.league_night || 'tuesday';
            document.getElementById('settingStartTime').value = leagueData.start_time || '';
            document.getElementById('settingVenueName').value = leagueData.venue_name || '';
            document.getElementById('settingVenueAddress').value = leagueData.venue_address || '';
            document.getElementById('settingPointSystem').value = leagueData.point_system || 'game_based';
            document.getElementById('settingCorkRule').value = leagueData.cork_rule || 'cork_first_leg';
            document.getElementById('settingLevelRules').value = leagueData.level_rules || 'strict';
            document.getElementById('settingSessionFee').value = leagueData.session_fee || 0;
            document.getElementById('settingPlayoffFormat').value = leagueData.playoff_format || 'none';
            document.getElementById('settingByePoints').value = leagueData.bye_points || 'average';
            document.getElementById('settingFormat').value = leagueData.format || '501';
            document.getElementById('settingInRule').value = leagueData.in_rule || 'straight';
            document.getElementById('settingCheckout').value = leagueData.checkout || 'double';
            document.getElementById('settingBestOf').value = leagueData.best_of || '3';
            document.getElementById('settingRounds').value = leagueData.games_per_match || leagueData.rounds_per_match || 9;

            // Cork & Start Rules
            document.getElementById('settingStartRules').value = leagueData.start_rules || leagueData.cork_rule || 'cork_every_leg';
            document.getElementById('settingCorkOption').value = leagueData.cork_option || 'alternate_random_first_last';
            document.getElementById('settingCorkWinnerGets').value = leagueData.cork_winner_gets || 'choose-and-start';

            // Team Configuration
            document.getElementById('settingMinPlayers').value = leagueData.min_players || 3;
            document.getElementById('settingMaxRoster').value = leagueData.max_roster || 4;
            document.getElementById('settingScheduleFormat').value = leagueData.schedule_format || 'round_robin';
            document.getElementById('settingAllowFillins').value = leagueData.allow_fillins ? 'true' : 'false';

            // Fill-in options
            if (document.getElementById('settingFillinCollect501')) {
                document.getElementById('settingFillinCollect501').checked = leagueData.fillin_collect_501_avg !== false;
                document.getElementById('settingFillinCollectCricket').checked = leagueData.fillin_collect_cricket_avg !== false;
                document.getElementById('settingFillinCollectLevel').checked = leagueData.fillin_collect_level !== false;
            }
            toggleFillinOptions();

            // Additional Rules
            document.getElementById('settingLeagueRulesText').value = leagueData.league_rules || '';

            // Populate tiebreaker list
            populateTiebreakerList();

            // Populate rounds builder
            populateRoundsBuilder();

            // Populate display values
            updateSettingsDisplay();
        }

        function populateTiebreakerList() {
            const tiebreakers = leagueData.tiebreakers || [
                { value: 'head_to_head', enabled: true },
                { value: 'point_diff', enabled: true },
                { value: 'total_points', enabled: true },
                { value: 'cork_off', enabled: false }
            ];
            const list = document.getElementById('tiebreakerList');
            if (!list) return;

            const labels = {
                head_to_head: 'Head-to-Head',
                point_diff: 'Point Differential',
                total_points: 'Total Points Scored',
                cork_off: 'Cork-Off'
            };

            list.innerHTML = tiebreakers.map(tb => `
                <div class="tiebreaker-item" data-value="${tb.value}" draggable="true" style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-panel); border: 2px solid var(--border-strong); border-radius: 8px; cursor: grab;">
                    <span class="drag-handle" style="color: var(--text-dim);">‚ò∞</span>
                    <input type="checkbox" ${tb.enabled ? 'checked' : ''} style="width: 18px; height: 18px; accent-color: var(--pink);">
                    <span style="flex: 1; font-size: 13px;">${labels[tb.value] || tb.value}</span>
                </div>
            `).join('');

            // Re-attach drag handlers
            initTiebreakerDragDrop();
        }

        function initTiebreakerDragDrop() {
            const list = document.getElementById('tiebreakerList');
            if (!list) return;
            let draggedItem = null;

            list.querySelectorAll('.tiebreaker-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = item;
                    item.style.opacity = '0.5';
                });
                item.addEventListener('dragend', () => {
                    item.style.opacity = '1';
                    draggedItem = null;
                });
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (item !== draggedItem) {
                        item.style.borderColor = 'var(--yellow)';
                    }
                });
                item.addEventListener('dragleave', () => {
                    item.style.borderColor = 'var(--border-strong)';
                });
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.style.borderColor = 'var(--border-strong)';
                    if (draggedItem && item !== draggedItem) {
                        const allItems = [...list.querySelectorAll('.tiebreaker-item')];
                        const draggedIdx = allItems.indexOf(draggedItem);
                        const targetIdx = allItems.indexOf(item);
                        if (draggedIdx < targetIdx) {
                            item.after(draggedItem);
                        } else {
                            item.before(draggedItem);
                        }
                    }
                });
            });
        }

        function populateRoundsBuilder() {
            const rounds = Array.isArray(leagueData.match_format) ? leagueData.match_format : [];
            const container = document.getElementById('roundsBuilderList');
            if (!container) return;

            if (rounds.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim); text-align: center;">No rounds configured. Click "Add Round" to define match format.</p>';
                return;
            }

            container.innerHTML = rounds.map((round, idx) => {
                const isX01Custom = round.game_type === 'x01';
                const isCricket = round.game_type === 'cricket';
                const isCorksChoice = round.game_type === 'corks_choice';
                const showInOut = !isCricket && !isCorksChoice;

                return `
                <div class="round-card" style="background: var(--bg-panel); border: 2px solid var(--border-strong); border-radius: 10px; padding: 12px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-family: 'Bebas Neue', cursive; font-size: 18px; color: var(--pink);">ROUND ${idx + 1}</span>
                        <button onclick="removeRoundFromBuilder(${idx})" style="background: rgba(239,68,68,0.2); border: none; color: #ef4444; padding: 4px 8px; border-radius: 4px; cursor: pointer;">‚úï</button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px;">
                        <div class="form-group">
                            <label class="brdc-label" style="font-size: 11px;">Game Type</label>
                            <select class="brdc-select round-game-type" data-round="${idx}" onchange="updateRoundField(${idx}, 'game_type', this.value)" style="padding: 6px; font-size: 12px;">
                                <option value="501" ${round.game_type === '501' ? 'selected' : ''}>501</option>
                                <option value="301" ${round.game_type === '301' ? 'selected' : ''}>301</option>
                                <option value="701" ${round.game_type === '701' ? 'selected' : ''}>701</option>
                                <option value="x01" ${round.game_type === 'x01' ? 'selected' : ''}>X01 (Custom)</option>
                                <option value="cricket" ${round.game_type === 'cricket' ? 'selected' : ''}>Cricket</option>
                                <option value="corks_choice" ${round.game_type === 'corks_choice' ? 'selected' : ''}>Corks Choice</option>
                            </select>
                        </div>
                        ${isX01Custom ? `
                        <div class="form-group">
                            <label class="brdc-label" style="font-size: 11px;">X01 Value</label>
                            <input type="number" class="brdc-input round-x01-value" data-round="${idx}" value="${round.x01_value || 501}" min="101" max="2001" step="100" onchange="updateRoundField(${idx}, 'x01_value', this.value)" style="padding: 6px; font-size: 12px; width: 70px;">
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label class="brdc-label" style="font-size: 11px;">Best Of</label>
                            <select class="brdc-select round-best-of" data-round="${idx}" style="padding: 6px; font-size: 12px;">
                                <option value="1" ${round.best_of == 1 ? 'selected' : ''}>1 leg</option>
                                <option value="3" ${round.best_of == 3 ? 'selected' : ''}>Best of 3</option>
                                <option value="5" ${round.best_of == 5 ? 'selected' : ''}>Best of 5</option>
                                <option value="7" ${round.best_of == 7 ? 'selected' : ''}>Best of 7</option>
                                <option value="9" ${round.best_of == 9 ? 'selected' : ''}>Best of 9</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="brdc-label" style="font-size: 11px;"># Players</label>
                            <input type="number" class="brdc-input round-num-players" data-round="${idx}" value="${round.num_players || 1}" min="1" max="8" style="padding: 6px; font-size: 12px; width: 50px;">
                        </div>
                        <div class="form-group">
                            <label class="brdc-label" style="font-size: 11px;">Level</label>
                            <select class="brdc-select round-level" data-round="${idx}" style="padding: 6px; font-size: 12px;">
                                <option value="A" ${round.player_level === 'A' ? 'selected' : ''}>A Only</option>
                                <option value="B" ${round.player_level === 'B' ? 'selected' : ''}>B Only</option>
                                <option value="C" ${round.player_level === 'C' ? 'selected' : ''}>C Only</option>
                                <option value="AB" ${round.player_level === 'AB' ? 'selected' : ''}>A + B</option>
                                <option value="AC" ${round.player_level === 'AC' ? 'selected' : ''}>A + C</option>
                                <option value="BC" ${round.player_level === 'BC' ? 'selected' : ''}>B + C</option>
                                <option value="ALL" ${round.player_level === 'ALL' || round.player_level === 'any' ? 'selected' : ''}>All / Any</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="brdc-label" style="font-size: 11px;">Points</label>
                            <input type="number" class="brdc-input round-points" data-round="${idx}" value="${round.points || 1}" min="1" max="10" style="padding: 6px; font-size: 12px; width: 50px;">
                        </div>
                        ${showInOut ? `
                        <div class="form-group">
                            <label class="brdc-label" style="font-size: 11px;">In Rule</label>
                            <select class="brdc-select round-in-rule" data-round="${idx}" style="padding: 6px; font-size: 12px;">
                                <option value="straight" ${round.in_rule === 'straight' ? 'selected' : ''}>Straight In</option>
                                <option value="double" ${round.in_rule === 'double' ? 'selected' : ''}>Double In</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="brdc-label" style="font-size: 11px;">Out Rule</label>
                            <select class="brdc-select round-out-rule" data-round="${idx}" style="padding: 6px; font-size: 12px;">
                                <option value="double" ${round.out_rule === 'double' ? 'selected' : ''}>Double Out</option>
                                <option value="master" ${round.out_rule === 'master' ? 'selected' : ''}>Master Out</option>
                                <option value="straight" ${round.out_rule === 'straight' ? 'selected' : ''}>Straight Out</option>
                            </select>
                        </div>
                        ` : ''}
                    </div>
                    ${isCorksChoice ? `<div style="margin-top: 8px; padding: 8px; background: rgba(253,216,53,0.1); border-radius: 6px; font-size: 11px; color: var(--yellow);"><strong>Corks Choice:</strong> Cork winner picks game type. In/Out rules set when game starts.</div>` : ''}
                </div>
                `;
            }).join('');

            // Update rounds summary display
            updateRoundsSummaryDisplay();
        }

        window.updateRoundField = function(idx, field, value) {
            if (!leagueData.match_format || !leagueData.match_format[idx]) return;

            const round = leagueData.match_format[idx];

            if (field === 'game_type') {
                round.game_type = value;
                if (value === 'cricket' || value === 'corks_choice') {
                    round.in_rule = 'n/a';
                    round.out_rule = 'n/a';
                    round.x01_value = null;
                } else if (value === 'x01') {
                    round.x01_value = round.x01_value || '501';
                    if (round.in_rule === 'n/a') {
                        round.in_rule = 'straight';
                        round.out_rule = 'double';
                    }
                } else {
                    if (round.in_rule === 'n/a') {
                        round.in_rule = 'straight';
                        round.out_rule = 'double';
                    }
                    round.x01_value = null;
                }
                populateRoundsBuilder();
            } else if (field === 'x01_value') {
                round.x01_value = value;
            }
        };

        window.addRoundToBuilder = function() {
            if (!Array.isArray(leagueData.match_format)) leagueData.match_format = [];
            leagueData.match_format.push({
                game_type: '501',
                best_of: 3,
                num_players: 1,
                player_level: 'A',
                in_rule: 'straight',
                out_rule: 'double',
                points: 1,
                x01_value: null
            });
            populateRoundsBuilder();
        };

        window.removeRoundFromBuilder = function(idx) {
            if (leagueData.match_format && leagueData.match_format.length > idx) {
                leagueData.match_format.splice(idx, 1);
                populateRoundsBuilder();
            }
        };

        function updateRoundsSummaryDisplay() {
            const rounds = Array.isArray(leagueData.match_format) ? leagueData.match_format : [];
            const container = document.getElementById('roundsSummaryList');
            if (!container) return;

            if (rounds.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim);">No rounds configured.</p>';
                return;
            }

            const totalPoints = rounds.reduce((sum, r) => sum + (r.points || 1), 0);

            function getGameShortName(gameType, x01Value) {
                if (gameType === 'cricket') return 'CRKT';
                if (gameType === 'corks_choice') return 'CHOICE';
                if (gameType === 'x01') return x01Value || 'X01';
                return (gameType || '501').toUpperCase();
            }

            function getRoundLabel(r) {
                const players = r.num_players || 1;
                const type = players === 1 ? 'S' : players === 2 ? 'D' : players === 3 ? 'T' : `${players}P`;
                const level = (r.player_level === 'ALL' || r.player_level === 'any') ? '' : `-${r.player_level || 'A'}`;

                let game;
                if (r.game_type === 'mixed' && r.legs && r.legs.length > 0) {
                    // Show actual games: "501/CRKT/301"
                    const gameList = r.legs.map(leg => getGameShortName(leg.game_type, leg.x01_value));
                    game = gameList.join('/');
                } else {
                    game = getGameShortName(r.game_type, r.x01_value);
                }

                return `${type}${level} ${game} Bo${r.best_of || 3}`;
            }

            container.innerHTML = `
                <p style="margin-bottom: 8px;"><strong>${rounds.length}</strong> rounds, <strong>${totalPoints}</strong> total points</p>
                <ul style="margin: 0; padding-left: 20px; font-size: 12px;">
                    ${rounds.map((r, i) => `<li>Round ${i + 1}: ${getRoundLabel(r)} (${r.points || 1} pt)</li>`).join('')}
                </ul>
            `;
        }

        function getTiebreakerSettings() {
            const list = document.getElementById('tiebreakerList');
            if (!list) return [];
            const items = list.querySelectorAll('.tiebreaker-item');
            return [...items].map(item => ({
                value: item.dataset.value,
                enabled: item.querySelector('input[type="checkbox"]').checked
            }));
        }

        function getRoundsSettings() {
            const container = document.getElementById('roundsBuilderList');
            if (!container) return Array.isArray(leagueData.match_format) ? leagueData.match_format : [];

            const roundCards = container.querySelectorAll('.round-card');
            if (roundCards.length === 0) return Array.isArray(leagueData.match_format) ? leagueData.match_format : [];

            return [...roundCards].map((card, idx) => {
                const gameType = card.querySelector('.round-game-type')?.value || '501';
                const isCricket = gameType === 'cricket';
                const isCorksChoice = gameType === 'corks_choice';
                const isX01 = gameType === 'x01';

                return {
                    game_type: gameType,
                    best_of: parseInt(card.querySelector('.round-best-of')?.value) || 3,
                    num_players: parseInt(card.querySelector('.round-num-players')?.value) || 1,
                    player_level: card.querySelector('.round-level')?.value || 'A',
                    points: parseInt(card.querySelector('.round-points')?.value) || 1,
                    in_rule: (isCricket || isCorksChoice) ? 'n/a' : (card.querySelector('.round-in-rule')?.value || 'straight'),
                    out_rule: (isCricket || isCorksChoice) ? 'n/a' : (card.querySelector('.round-out-rule')?.value || 'double'),
                    x01_value: isX01 ? (card.querySelector('.round-x01-value')?.value || '501') : null
                };
            });
        }

        window.toggleFillinOptions = function() {
            const select = document.getElementById('settingAllowFillins');
            const panel = document.getElementById('fillinOptionsPanel');
            if (panel && select) {
                panel.style.display = select.value === 'true' ? 'block' : 'none';
            }
        }

        function updateSettingsDisplay() {
            const formatLabels = { 'triples_draft': 'Triples Draft', 'doubles_draft': 'Doubles Draft', 'singles': 'Singles' };
            const dayLabels = { monday: 'Monday', tuesday: 'Tuesday', wednesday: 'Wednesday', thursday: 'Thursday', friday: 'Friday', saturday: 'Saturday', sunday: 'Sunday' };
            const checkoutLabels = { double: 'Double Out', master: 'Master Out', straight: 'Straight Out' };
            const pointLabels = { game_based: 'Game-Based', match_based: 'Match-Based' };
            const corkLabels = { cork_first_leg: 'Cork First Leg', cork_every_leg: 'Cork Every Leg', home_first: 'Home First' };
            const levelLabels = { strict: 'Strict', play_up: 'Play Up Allowed', flexible: 'Flexible' };
            const playoffLabels = { none: 'No Playoffs', top_4_single: 'Top 4 Single Elim', top_4_double: 'Top 4 Double Elim', top_6_single: 'Top 6 Single Elim', top_8_single: 'Top 8 Single Elim' };
            const byeLabels = { average: 'Average', fixed: 'Fixed', none: 'None' };

            // League Info
            const leagueModeLabels = { draft: 'Draft League', team: 'Team League' };
            document.getElementById('displayLeagueName').textContent = leagueData.league_name || '-';
            document.getElementById('displaySeason').textContent = leagueData.season || '-';
            document.getElementById('displayLeagueMode').textContent = leagueModeLabels[leagueData.league_mode] || 'Draft League';
            document.getElementById('displayMaxTeams').textContent = leagueData.max_teams || 'Unlimited';
            document.getElementById('displayEntryFee').textContent = leagueData.entry_fee ? `$${leagueData.entry_fee}` : 'Free';
            document.getElementById('displayFormat').textContent = formatLabels[leagueData.league_format] || leagueData.league_format || '-';
            document.getElementById('displayTeamCount').textContent = leagueData.num_teams || '-';
            document.getElementById('displayPlayersPerTeam').textContent = leagueData.players_per_team || '-';
            document.getElementById('displayWeeks').textContent = leagueData.weeks || '-';

            // Schedule
            document.getElementById('displayStartDate').textContent = leagueData.start_date ? new Date(leagueData.start_date).toLocaleDateString() : '-';
            document.getElementById('displayRegCloseDate').textContent = leagueData.registration_close_date ? new Date(leagueData.registration_close_date).toLocaleDateString() : 'Same as start';
            document.getElementById('displayLeagueNight').textContent = dayLabels[leagueData.league_night] || leagueData.league_night || '-';
            document.getElementById('displayStartTime').textContent = leagueData.start_time || '-';
            const blackouts = leagueData.blackout_dates || [];
            document.getElementById('displayBlackouts').textContent = blackouts.length ? blackouts.map(d => new Date(d).toLocaleDateString()).join(', ') : 'None';

            // Tiebreakers display
            const tiebreakerDisplay = document.getElementById('displayTiebreakerOrder');
            if (tiebreakerDisplay) {
                const tiebreakers = leagueData.tiebreakers || [
                    { value: 'head_to_head', enabled: true },
                    { value: 'point_diff', enabled: true },
                    { value: 'total_points', enabled: true }
                ];
                const tbLabels = {
                    head_to_head: 'Head-to-Head',
                    point_diff: 'Point Differential',
                    total_points: 'Total Points Scored',
                    cork_off: 'Cork-Off'
                };
                const enabledTbs = tiebreakers.filter(t => t.enabled);
                tiebreakerDisplay.innerHTML = enabledTbs.length > 0
                    ? `<ol style="margin: 0; padding-left: 20px;">${enabledTbs.map(t => `<li>${tbLabels[t.value] || t.value}</li>`).join('')}</ol>`
                    : '<p>No tiebreakers configured</p>';
            }

            // Rounds summary
            updateRoundsSummaryDisplay();

            // Venue
            document.getElementById('displayVenueName').textContent = leagueData.venue_name || '-';
            document.getElementById('displayVenueAddress').textContent = leagueData.venue_address || '-';

            // Match Format
            const inRuleLabels = { straight: 'Straight In', double: 'Double In' };
            document.getElementById('displayGameFormat').textContent = (leagueData.format || '501').toUpperCase();
            document.getElementById('displayInRule').textContent = inRuleLabels[leagueData.in_rule] || 'Straight In';
            document.getElementById('displayCheckout').textContent = checkoutLabels[leagueData.checkout] || leagueData.checkout || 'Double Out';
            document.getElementById('displayBestOf').textContent = leagueData.best_of ? `Best of ${leagueData.best_of}` : 'Best of 3';
            document.getElementById('displayGamesPerMatch').textContent = leagueData.games_per_match || leagueData.rounds_per_match || 9;
            document.getElementById('displayCorkRule').textContent = corkLabels[leagueData.cork_rule] || leagueData.cork_rule || '-';
            document.getElementById('displayPointSystem').textContent = pointLabels[leagueData.point_system] || leagueData.point_system || 'Game-Based';

            // League Rules
            document.getElementById('displayLevelRules').textContent = levelLabels[leagueData.level_rules] || leagueData.level_rules || 'Strict';
            document.getElementById('displayPlayoffFormat').textContent = playoffLabels[leagueData.playoff_format] || leagueData.playoff_format || 'No Playoffs';
            document.getElementById('displayByePoints').textContent = byeLabels[leagueData.bye_points] || leagueData.bye_points || 'Average';
            document.getElementById('displaySessionFee').textContent = leagueData.session_fee ? `$${leagueData.session_fee}` : 'Free';

            // Cork & Start Rules
            const startRuleLabels = {
                cork_every_leg: 'Cork every leg',
                alternate_cork_first_deciding: 'Alternate, cork first/deciding',
                loser_starts_cork_first_deciding: 'Loser starts, cork first/deciding',
                winner_starts_cork_first_deciding: 'Winner starts, cork first/deciding'
            };
            const corkOptionLabels = {
                alternate_random_first_last: 'Alternate, randomize first/last',
                random_every_leg: 'Randomize every leg',
                away_team_option: 'Away team option',
                home_team_option: 'Home team option',
                loser_option: 'Loser option',
                winner_option: 'Winner option'
            };
            const corkWinnerLabels = {
                'choose-and-start': 'Choose game AND start',
                'choose-only': 'Choose game only'
            };
            document.getElementById('displayStartRules').textContent = startRuleLabels[leagueData.start_rules || leagueData.cork_rule] || 'Cork every leg';
            document.getElementById('displayCorkOption').textContent = corkOptionLabels[leagueData.cork_option] || 'Alternate';
            document.getElementById('displayCorkWinnerGets').textContent = corkWinnerLabels[leagueData.cork_winner_gets] || 'Choose and start';

            // Team Configuration
            const scheduleLabels = { round_robin: 'Round Robin', double_round_robin: 'Double Round Robin' };
            document.getElementById('displayMinPlayers').textContent = leagueData.min_players || 3;
            document.getElementById('displayMaxRoster').textContent = leagueData.max_roster || 4;
            document.getElementById('displayScheduleFormat').textContent = scheduleLabels[leagueData.schedule_format] || 'Round Robin';
            document.getElementById('displayFillins').textContent = leagueData.allow_fillins ? 'Yes' : 'No';

            // Additional Rules
            document.getElementById('displayLeagueRulesText').textContent = leagueData.league_rules || 'No additional rules specified';
        }

        window.toggleEditSection = function(section) {
            const displayEl = document.getElementById(section + 'Display');
            const editEl = document.getElementById(section + 'Edit');

            if (editEl.style.display === 'none') {
                displayEl.style.display = 'none';
                editEl.style.display = 'block';
            } else {
                displayEl.style.display = 'block';
                editEl.style.display = 'none';
            }
        };

        window.saveSection = async function(section) {
            showLoading('Saving...');
            try {
                await saveLeagueSettings();
                document.getElementById(section + 'Display').style.display = 'block';
                document.getElementById(section + 'Edit').style.display = 'none';
                updateSettingsDisplay();
            } catch (e) {
                alert('Error saving: ' + e.message);
            }
            hideLoading();
        };

        window.saveLeagueSettings = async function() {
            const updates = {
                league_name: document.getElementById('settingLeagueName').value.trim(),
                season: document.getElementById('settingSeason').value.trim(),
                // New fields from create-league
                league_mode: document.getElementById('settingLeagueMode').value,
                max_teams: document.getElementById('settingMaxTeams').value ? parseInt(document.getElementById('settingMaxTeams').value) : null,
                entry_fee: document.getElementById('settingEntryFee').value ? parseFloat(document.getElementById('settingEntryFee').value) : null,
                registration_close_date: document.getElementById('settingRegCloseDate').value || null,
                start_date: document.getElementById('settingStartDate').value,
                league_night: document.getElementById('settingLeagueNight').value,
                start_time: document.getElementById('settingStartTime').value,
                venue_name: document.getElementById('settingVenueName').value.trim(),
                venue_address: document.getElementById('settingVenueAddress').value.trim(),
                point_system: document.getElementById('settingPointSystem').value,
                cork_rule: document.getElementById('settingCorkRule').value,
                level_rules: document.getElementById('settingLevelRules').value,
                session_fee: parseFloat(document.getElementById('settingSessionFee').value) || 0,
                playoff_format: document.getElementById('settingPlayoffFormat').value,
                bye_points: document.getElementById('settingByePoints').value,
                // Match format settings
                format: document.getElementById('settingFormat').value,
                in_rule: document.getElementById('settingInRule').value,
                checkout: document.getElementById('settingCheckout').value,
                best_of: parseInt(document.getElementById('settingBestOf').value),
                games_per_match: parseInt(document.getElementById('settingRounds').value) || 9,
                // Cork & Start Rules
                start_rules: document.getElementById('settingStartRules').value,
                cork_option: document.getElementById('settingCorkOption').value,
                cork_winner_gets: document.getElementById('settingCorkWinnerGets').value,
                // Team Configuration
                min_players: parseInt(document.getElementById('settingMinPlayers').value) || 3,
                max_roster: parseInt(document.getElementById('settingMaxRoster').value) || 4,
                schedule_format: document.getElementById('settingScheduleFormat').value,
                allow_fillins: document.getElementById('settingAllowFillins').value === 'true',
                // Fill-in collection options
                fillin_collect_501_avg: document.getElementById('settingFillinCollect501')?.checked !== false,
                fillin_collect_cricket_avg: document.getElementById('settingFillinCollectCricket')?.checked !== false,
                fillin_collect_level: document.getElementById('settingFillinCollectLevel')?.checked !== false,
                // Tiebreakers
                tiebreakers: getTiebreakerSettings(),
                // Match format configuration (rounds)
                match_format: getRoundsSettings(),
                // Additional Rules
                league_rules: document.getElementById('settingLeagueRulesText').value.trim()
            };

            if (!updates.league_name) {
                alert('League name is required');
                return;
            }

            try {
                const result = await callFunction('updateLeagueSettings', {
                    league_id: leagueId,
                    admin_pin: adminPin,
                    settings: updates
                });

                if (result.success) {
                    // Update local data
                    Object.assign(leagueData, updates);
                    document.getElementById('leagueName').textContent = updates.league_name;
                    document.getElementById('leagueSeason').textContent = updates.season;
                    updateSettingsDisplay();
                    alert('Settings saved successfully!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error saving settings: ' + e.message);
            }
        };

        window.logout = function() {
            adminPin = null;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginOverlay').style.display = 'flex';
            pinInput.value = '';
            pinInput.focus();
        };

        // ============================================================================
        // TEAM CREATION FUNCTIONS
        // ============================================================================

        // Track selected players for team creation
        let selectedTeamPlayers = { A: null, B: null, C: null };

        window.showCreateTeamModal = function() {
            document.getElementById('createTeamModal').style.display = 'flex';
            document.getElementById('newTeamName').value = '';
            document.getElementById('teamPlayerA').value = '';
            document.getElementById('teamPlayerB').value = '';
            document.getElementById('teamPlayerC').value = '';
            document.getElementById('teamPlayerA_id').value = '';
            document.getElementById('teamPlayerB_id').value = '';
            document.getElementById('teamPlayerC_id').value = '';
            selectedTeamPlayers = { A: null, B: null, C: null };

            // Populate player datalists with unassigned players
            populatePlayerLists();

            document.getElementById('newTeamName').focus();
        };

        function populatePlayerLists() {
            const unassigned = playersData.filter(p => !p.team_id && !p.isBot);

            ['A', 'B', 'C'].forEach(pos => {
                const datalist = document.getElementById(`playerList${pos}`);
                datalist.innerHTML = unassigned.map(p =>
                    `<option value="${p.name}" data-id="${p.id}">${p.name}${p.preferred_level ? ` (${p.preferred_level})` : ''}${p.reported_average ? ` - Avg: ${p.reported_average}` : ''}</option>`
                ).join('');
            });

            // Add input event listeners to track selections
            ['A', 'B', 'C'].forEach(pos => {
                const input = document.getElementById(`teamPlayer${pos}`);
                input.oninput = function() {
                    const value = this.value;
                    const player = unassigned.find(p => p.name === value);
                    if (player) {
                        document.getElementById(`teamPlayer${pos}_id`).value = player.id;
                        selectedTeamPlayers[pos] = player;
                    } else {
                        document.getElementById(`teamPlayer${pos}_id`).value = '';
                        selectedTeamPlayers[pos] = null;
                    }
                };
            });
        }

        window.closeCreateTeamModal = function() {
            document.getElementById('createTeamModal').style.display = 'none';
        };

        window.createTeamWithRoster = async function() {
            const teamName = document.getElementById('newTeamName').value.trim();
            const playerAId = document.getElementById('teamPlayerA_id').value;
            const playerBId = document.getElementById('teamPlayerB_id').value;
            const playerCId = document.getElementById('teamPlayerC_id').value;

            if (!teamName) {
                alert('Please enter a team name');
                return;
            }

            // At least one player required
            if (!playerAId && !playerBId && !playerCId) {
                alert('Please select at least one player for the team');
                return;
            }

            showLoading('Creating team...');
            try {
                // First create the team
                const result = await callFunction('createTeamWithPlayers', {
                    league_id: leagueId,
                    pin: adminPin,
                    team_name: teamName,
                    player_a_id: playerAId || null,
                    player_b_id: playerBId || null,
                    player_c_id: playerCId || null
                });

                if (result.success) {
                    alert(`Team "${teamName}" created successfully!`);
                    closeCreateTeamModal();
                    await loadTeams();
                    await loadPlayers();
                    renderTeams();
                    renderPlayers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
            hideLoading();
        };

        window.notifyAllPlayers = async function() {
            const playerCount = playersData.filter(p => p.phone && !p.isBot).length;

            if (playerCount === 0) {
                alert('No players with phone numbers to notify.');
                return;
            }

            if (!confirm(`Send SMS to ${playerCount} player(s)?\n\nThis will text each player:\n‚Ä¢ Their PIN\n‚Ä¢ Team assignment\n‚Ä¢ First match info\n‚Ä¢ Dashboard link\n\nTwilio charges apply.`)) {
                return;
            }

            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'üì± SENDING...';

                const result = await callFunction('notifyLeaguePlayers', {
                    league_id: leagueId,
                    admin_pin: adminPin
                });

                btn.disabled = false;
                btn.textContent = 'üì± TEXT ALL PLAYERS';

                if (result.success) {
                    alert(`‚úÖ Notifications sent!\n\nSent: ${result.results.sent}\nFailed: ${result.results.failed}\nSkipped (no phone): ${result.results.skipped}`);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
                event.target.disabled = false;
                event.target.textContent = 'üì± TEXT ALL PLAYERS';
            }
        };

        window.runAutoDraft = async function() {
            // Include bots in draft
            const unassigned = playersData.filter(p => !p.team_id);
            const playersPerTeam = leagueData.min_players || leagueData.players_per_team || 4;
            const possibleTeams = Math.floor(unassigned.length / playersPerTeam);

            const botCount = unassigned.filter(p => p.isBot).length;
            const humanCount = unassigned.length - botCount;

            if (possibleTeams < 2) {
                alert(`Not enough unassigned players for auto-draft.\n\nYou have ${unassigned.length} players (${humanCount} humans, ${botCount} bots).\nNeed at least ${playersPerTeam * 2} for 2 teams (${playersPerTeam} per team).`);
                return;
            }

            if (!confirm(`Auto Draft will:\n\n‚Ä¢ Create ${possibleTeams} teams\n‚Ä¢ Randomly assign ${possibleTeams * playersPerTeam} players\n  (${humanCount} humans + ${botCount} bots available)\n‚Ä¢ ${unassigned.length - (possibleTeams * playersPerTeam)} player(s) will remain unassigned\n\nContinue?`)) {
                return;
            }

            try {
                const result = await callFunction('conductLeagueDraft', {
                    league_id: leagueId,
                    admin_pin: adminPin
                });

                if (result.success) {
                    alert(`Draft complete!\n\n${result.teams_created} teams created.`);
                    await loadTeams();
                    await loadPlayers();
                    renderTeams();
                    renderPlayers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        };

        // ============================================================================
        // DRAFT CONTROLS FUNCTIONS
        // ============================================================================

        // Initialize draft controls section for draft leagues
        async function initDraftControls() {
            const draftSection = document.getElementById('draftControlsSection');
            if (!draftSection) return;

            draftSection.style.display = 'block';

            // Populate draft settings from league data
            const draftSettings = leagueData.draft_settings || {};
            document.getElementById('draftOrderMethod').textContent =
                draftSettings.order_method === 'by_record' ? 'By Record' :
                draftSettings.order_method === 'manual' ? 'Manual' : 'Random';
            document.getElementById('draftTimePerPick').textContent =
                draftSettings.time_per_pick === 0 ? 'Unlimited' : (draftSettings.time_per_pick || 60) + 's';
            document.getElementById('draftStyle').textContent =
                draftSettings.snake === false ? 'Standard' : 'Snake';
            document.getElementById('draftAutoPick').textContent =
                draftSettings.auto_pick === false ? 'No' : 'Yes';

            // Check if draft exists and get its state
            try {
                const result = await callFunction('getDraftState', { league_id: leagueId });
                if (result.success && result.draft) {
                    updateDraftStatusDisplay(result.draft);
                }
            } catch (e) {
                console.log('No draft state yet or error fetching:', e.message);
            }
        }

        // Update draft status display based on draft state
        function updateDraftStatusDisplay(draftState) {
            const statusBadge = document.getElementById('draftStatusBadge');
            const progressDisplay = document.getElementById('draftProgressDisplay');
            const openBtn = document.getElementById('openDraftRoomBtn');
            const viewResultsBtn = document.getElementById('viewDraftResultsBtn');

            if (!draftState) {
                statusBadge.textContent = 'NOT STARTED';
                statusBadge.style.background = 'rgba(107, 114, 128, 0.2)';
                statusBadge.style.color = '#9CA3AF';
                progressDisplay.style.display = 'none';
                openBtn.textContent = 'üéØ START DRAFT';
                viewResultsBtn.style.display = 'none';
                return;
            }

            const { status, current_pick, total_picks, pick_order, teams } = draftState;

            // Update status badge
            switch (status) {
                case 'active':
                    statusBadge.textContent = 'IN PROGRESS';
                    statusBadge.style.background = 'rgba(34, 197, 94, 0.2)';
                    statusBadge.style.color = '#22C55E';
                    openBtn.textContent = 'üéØ OPEN DRAFT ROOM';
                    viewResultsBtn.style.display = 'none';
                    break;
                case 'paused':
                    statusBadge.textContent = 'PAUSED';
                    statusBadge.style.background = 'rgba(253, 216, 53, 0.2)';
                    statusBadge.style.color = '#FDD835';
                    openBtn.textContent = 'üéØ OPEN DRAFT ROOM';
                    viewResultsBtn.style.display = 'none';
                    break;
                case 'completed':
                    statusBadge.textContent = 'COMPLETED';
                    statusBadge.style.background = 'rgba(59, 130, 246, 0.2)';
                    statusBadge.style.color = '#3B82F6';
                    openBtn.style.display = 'none';
                    viewResultsBtn.style.display = 'block';
                    break;
                default:
                    statusBadge.textContent = 'PENDING';
                    statusBadge.style.background = 'rgba(253, 216, 53, 0.2)';
                    statusBadge.style.color = '#FDD835';
                    openBtn.textContent = 'üéØ START DRAFT';
                    viewResultsBtn.style.display = 'none';
            }

            // Update progress display
            if (status === 'active' || status === 'paused') {
                progressDisplay.style.display = 'block';
                document.getElementById('draftCurrentPick').textContent = current_pick || 0;
                document.getElementById('draftTotalPicks').textContent = total_picks || (pick_order ? pick_order.length : 0);

                // Get current team name
                if (pick_order && pick_order.length > 0 && teams) {
                    const currentTeamId = pick_order[(current_pick || 1) - 1];
                    const currentTeam = teams.find(t => t.id === currentTeamId);
                    document.getElementById('draftCurrentTeam').textContent = currentTeam ? currentTeam.name : 'Unknown';
                }

                // Update progress bar
                const progress = total_picks ? ((current_pick || 0) / total_picks * 100) : 0;
                document.getElementById('draftProgressBar').style.width = progress + '%';
            } else if (status === 'completed') {
                progressDisplay.style.display = 'block';
                const totalPicks = total_picks || (pick_order ? pick_order.length : 0);
                document.getElementById('draftCurrentPick').textContent = totalPicks;
                document.getElementById('draftTotalPicks').textContent = totalPicks;
                document.getElementById('draftCurrentTeam').textContent = 'Draft Complete';
                document.getElementById('draftProgressBar').style.width = '100%';
            } else {
                progressDisplay.style.display = 'none';
            }
        }

        // Open draft room in new tab
        window.openDraftRoom = function() {
            window.open(`/pages/draft-room.html?league_id=${leagueId}`, '_blank');
        };

        // View draft results
        window.viewDraftResults = async function() {
            try {
                const result = await callFunction('getDraftState', { league_id: leagueId });
                if (!result.success || !result.draft) {
                    alert('No draft results available.');
                    return;
                }

                const draft = result.draft;
                const teams = draft.teams || [];
                const picks = draft.picks || [];

                // Build results summary
                let summary = 'DRAFT RESULTS\n' + '='.repeat(40) + '\n\n';

                teams.forEach(team => {
                    summary += `${team.name}\n`;
                    summary += '-'.repeat(20) + '\n';
                    const teamPicks = picks.filter(p => p.team_id === team.id);
                    teamPicks.forEach((pick, idx) => {
                        const levelBadge = pick.player_level ? ` [${pick.player_level}]` : '';
                        summary += `  ${idx + 1}. ${pick.player_name}${levelBadge}\n`;
                    });
                    summary += '\n';
                });

                summary += '='.repeat(40) + '\n';
                summary += `Total Picks: ${picks.length}\n`;
                summary += `Draft Status: ${draft.status.toUpperCase()}\n`;
                if (draft.completed_at) {
                    const completedDate = draft.completed_at.toDate ? draft.completed_at.toDate() : new Date(draft.completed_at);
                    summary += `Completed: ${completedDate.toLocaleDateString()} at ${completedDate.toLocaleTimeString()}\n`;
                }

                // Show in a modal or alert (using alert for simplicity)
                alert(summary);

            } catch (e) {
                alert('Error fetching draft results: ' + e.message);
            }
        };

        // ============================================================================
        // CONTACT TAB FUNCTIONS
        // ============================================================================
        let selectedIndividualPlayers = [];

        // Update recipient count based on filters
        window.updateRecipientCount = function() {
            let count = 0;
            const captains = document.getElementById('filterCaptains').checked;
            const levelA = document.getElementById('filterLevelA').checked;
            const levelB = document.getElementById('filterLevelB').checked;
            const levelC = document.getElementById('filterLevelC').checked;
            const alternates = document.getElementById('filterAlternates').checked;

            playersData.forEach(p => {
                if (p.isBot || !p.phone) return; // Skip bots and players without phones

                let matches = false;
                if (captains && p.is_captain) matches = true;
                if (levelA && p.preferred_level === 'A') matches = true;
                if (levelB && p.preferred_level === 'B') matches = true;
                if (levelC && p.preferred_level === 'C') matches = true;
                if (alternates && p.is_sub) matches = true;

                if (matches) count++;
            });

            // Add individually selected players (not already counted)
            selectedIndividualPlayers.forEach(sp => {
                const player = playersData.find(p => p.id === sp.id);
                if (player && player.phone && !player.isBot) {
                    // Check if not already counted by filters
                    let alreadyCounted = false;
                    if (captains && player.is_captain) alreadyCounted = true;
                    if (levelA && player.preferred_level === 'A') alreadyCounted = true;
                    if (levelB && player.preferred_level === 'B') alreadyCounted = true;
                    if (levelC && player.preferred_level === 'C') alreadyCounted = true;
                    if (alternates && player.is_sub) alreadyCounted = true;

                    if (!alreadyCounted) count++;
                }
            });

            document.getElementById('recipientCount').textContent = `${count} recipient${count !== 1 ? 's' : ''} selected`;
            updateMessagePreview();
        };

        window.selectAllRecipients = function() {
            document.getElementById('filterCaptains').checked = true;
            document.getElementById('filterLevelA').checked = true;
            document.getElementById('filterLevelB').checked = true;
            document.getElementById('filterLevelC').checked = true;
            document.getElementById('filterAlternates').checked = true;
            updateRecipientCount();
        };

        window.clearAllRecipients = function() {
            document.getElementById('filterCaptains').checked = false;
            document.getElementById('filterLevelA').checked = false;
            document.getElementById('filterLevelB').checked = false;
            document.getElementById('filterLevelC').checked = false;
            document.getElementById('filterAlternates').checked = false;
            selectedIndividualPlayers = [];
            renderSelectedPlayersChips();
            updateRecipientCount();
        };

        // Search for individual players
        window.searchContactPlayers = function() {
            const searchTerm = document.getElementById('contactPlayerSearch').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('contactPlayerResults');

            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }

            const matches = playersData
                .filter(p => !p.isBot && p.phone && p.name.toLowerCase().includes(searchTerm))
                .slice(0, 10);

            if (matches.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #666; font-size: 12px; padding: 8px;">No players found</p>';
                return;
            }

            resultsDiv.innerHTML = matches.map(p => {
                const isSelected = selectedIndividualPlayers.some(sp => sp.id === p.id);
                return `
                    <div style="padding: 8px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-weight: 600;">${p.name}</span>
                            <span style="color: #666; font-size: 11px; margin-left: 8px;">${p.preferred_level || ''} ${p.is_captain ? 'üëë' : ''}</span>
                        </div>
                        ${isSelected
                            ? '<span style="color: #4ade80; font-size: 12px;">‚úì Added</span>'
                            : `<button class="brdc-btn brdc-btn-secondary" onclick="addIndividualPlayer('${p.id}', '${p.name.replace(/'/g, "\\'")}')" style="padding: 4px 10px; font-size: 11px;">Add</button>`
                        }
                    </div>
                `;
            }).join('');
        };

        window.addIndividualPlayer = function(id, name) {
            if (!selectedIndividualPlayers.some(p => p.id === id)) {
                selectedIndividualPlayers.push({ id, name });
                renderSelectedPlayersChips();
                updateRecipientCount();
                searchContactPlayers(); // Refresh search results
            }
        };

        window.removeIndividualPlayer = function(id) {
            selectedIndividualPlayers = selectedIndividualPlayers.filter(p => p.id !== id);
            renderSelectedPlayersChips();
            updateRecipientCount();
            searchContactPlayers(); // Refresh search results
        };

        function renderSelectedPlayersChips() {
            const container = document.getElementById('selectedPlayersChips');
            if (selectedIndividualPlayers.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = selectedIndividualPlayers.map(p => `
                <div style="display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--pink); border-radius: 20px; font-size: 12px; color: white;">
                    <span>${p.name}</span>
                    <button onclick="removeIndividualPlayer('${p.id}')" style="background: none; border: none; color: white; cursor: pointer; font-size: 14px; padding: 0;">&times;</button>
                </div>
            `).join('');
        }

        // Insert tag into message
        window.insertTag = function(tag) {
            const textarea = document.getElementById('contactMessage');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;

            textarea.value = text.substring(0, start) + tag + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + tag.length;
            textarea.focus();

            updateCharCount();
            updateMessagePreview();
        };

        // Character count
        const contactMessageInput = document.getElementById('contactMessage');
        if (contactMessageInput) {
            contactMessageInput.addEventListener('input', function() {
                updateCharCount();
                updateMessagePreview();
            });
        }

        function updateCharCount() {
            const text = document.getElementById('contactMessage').value;
            const count = text.length;
            const charCountEl = document.getElementById('charCount');
            charCountEl.textContent = `${count} / 160 chars`;
            charCountEl.style.color = count > 160 ? '#ef4444' : '#666';
        }

        // Message preview with sample data
        function updateMessagePreview() {
            const template = document.getElementById('contactMessage').value;
            const previewDiv = document.getElementById('messagePreview');

            if (!template.trim()) {
                previewDiv.textContent = 'Your message will appear here...';
                previewDiv.style.color = '#666';
                return;
            }

            // Sample player data for preview
            const samplePlayer = {
                first_name: 'John',
                last_name: 'Smith',
                full_name: 'John Smith',
                pin: '12345678',
                team_name: 'The Darters',
                dashboard_link: 'brdc.app/dashboard',
                league_name: leagueData?.league_name || 'My League',
                next_match_date: 'Next Tuesday',
                next_match_pin: 'A7X3K'
            };

            let preview = template
                .replace(/\[first_name\]/gi, samplePlayer.first_name)
                .replace(/\[last_name\]/gi, samplePlayer.last_name)
                .replace(/\[full_name\]/gi, samplePlayer.full_name)
                .replace(/\[pin\]/gi, samplePlayer.pin)
                .replace(/\[team_name\]/gi, samplePlayer.team_name)
                .replace(/\[dashboard_link\]/gi, samplePlayer.dashboard_link)
                .replace(/\[league_name\]/gi, samplePlayer.league_name)
                .replace(/\[next_match_date\]/gi, samplePlayer.next_match_date)
                .replace(/\[next_match_pin\]/gi, samplePlayer.next_match_pin);

            previewDiv.textContent = preview;
            previewDiv.style.color = '#4ade80';
        }

        // Send custom message
        window.sendCustomMessage = async function() {
            const message = document.getElementById('contactMessage').value.trim();

            if (!message) {
                alert('Please enter a message');
                return;
            }

            // Get selected filters
            const filters = {
                captains: document.getElementById('filterCaptains').checked,
                levelA: document.getElementById('filterLevelA').checked,
                levelB: document.getElementById('filterLevelB').checked,
                levelC: document.getElementById('filterLevelC').checked,
                alternates: document.getElementById('filterAlternates').checked,
                individual_player_ids: selectedIndividualPlayers.map(p => p.id)
            };

            // Check if any recipients selected
            const hasFilters = filters.captains || filters.levelA || filters.levelB || filters.levelC || filters.alternates;
            const hasIndividuals = filters.individual_player_ids.length > 0;

            if (!hasFilters && !hasIndividuals) {
                alert('Please select at least one recipient filter or add individual players');
                return;
            }

            // Count recipients
            let recipientCount = 0;
            playersData.forEach(p => {
                if (p.isBot || !p.phone) return;
                let matches = false;
                if (filters.captains && p.is_captain) matches = true;
                if (filters.levelA && p.preferred_level === 'A') matches = true;
                if (filters.levelB && p.preferred_level === 'B') matches = true;
                if (filters.levelC && p.preferred_level === 'C') matches = true;
                if (filters.alternates && p.is_sub) matches = true;
                if (filters.individual_player_ids.includes(p.id)) matches = true;
                if (matches) recipientCount++;
            });

            if (recipientCount === 0) {
                alert('No players match the selected filters or have phone numbers');
                return;
            }

            if (!confirm(`Send SMS to ${recipientCount} player(s)?\n\nMessage preview:\n"${message.substring(0, 100)}${message.length > 100 ? '...' : ''}"\n\nTwilio charges apply.`)) {
                return;
            }

            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'üì± SENDING...';

                const result = await callFunction('sendCustomLeagueMessage', {
                    league_id: leagueId,
                    admin_pin: adminPin,
                    message: message,
                    filters: filters
                });

                btn.disabled = false;
                btn.textContent = 'üì± SEND MESSAGE';

                if (result.success) {
                    alert(`‚úÖ Messages sent!\n\nSent: ${result.results.sent}\nFailed: ${result.results.failed}\nSkipped (no phone): ${result.results.skipped}`);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
                event.target.disabled = false;
                event.target.textContent = 'üì± SEND MESSAGE';
            }
        };

        // ============================================================================
        // DIRECTOR TOOLS FUNCTIONS
        // ============================================================================

        // Load Director Tools tab data
        async function loadDirectorTools() {
            populateCorrectionWeekFilter();
            populateRescheduleWeekFilter();
            renderCorrectionMatches();
            renderLevelPlayers();
            renderRescheduleMatches();
            loadToolsStats();
        }

        // Load tools statistics
        async function loadToolsStats() {
            try {
                // Count corrections from corrections_log subcollection
                const correctionsCount = matchesData.filter(m => m.corrected_at).length;
                document.getElementById('correctionsCount').textContent = correctionsCount;

                // Count rescheduled matches
                const rescheduledCount = matchesData.filter(m => m.rescheduled_at || m.is_makeup).length;
                document.getElementById('rescheduledCount').textContent = rescheduledCount;
            } catch (e) {
                console.error('Error loading tools stats:', e);
            }
        }

        // Populate week filter dropdowns
        function populateCorrectionWeekFilter() {
            const select = document.getElementById('correctionWeekFilter');
            const totalWeeks = leagueData?.total_weeks || Math.max(...matchesData.map(m => m.week), 1);
            let html = '<option value="all">All Weeks</option>';
            for (let w = 1; w <= totalWeeks; w++) {
                html += `<option value="${w}">Week ${w}</option>`;
            }
            select.innerHTML = html;
        }

        function populateRescheduleWeekFilter() {
            const select = document.getElementById('rescheduleWeekFilter');
            const totalWeeks = leagueData?.total_weeks || Math.max(...matchesData.map(m => m.week), 1);
            let html = '<option value="all">All Weeks</option>';
            for (let w = 1; w <= totalWeeks; w++) {
                html += `<option value="${w}">Week ${w}</option>`;
            }
            select.innerHTML = html;
        }

        // Filter functions
        window.filterCorrectionMatches = function() {
            renderCorrectionMatches();
        };

        window.filterLevelPlayers = function() {
            renderLevelPlayers();
        };

        window.filterRescheduleMatches = function() {
            renderRescheduleMatches();
        };

        // Render correction matches list
        function renderCorrectionMatches() {
            const container = document.getElementById('correctionMatchesList');
            const weekFilter = document.getElementById('correctionWeekFilter').value;
            const statusFilter = document.getElementById('correctionStatusFilter').value;

            let filtered = matchesData.filter(m => {
                if (weekFilter !== 'all' && m.week !== parseInt(weekFilter)) return false;
                if (statusFilter === 'completed' && m.status !== 'completed') return false;
                return true;
            });

            if (!filtered.length) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-dim);">No matches found matching filters.</p>';
                return;
            }

            let html = '';
            filtered.forEach(match => {
                const homeTeam = teamsData.find(t => t.id === match.home_team_id);
                const awayTeam = teamsData.find(t => t.id === match.away_team_id);
                const homeTeamName = homeTeam?.team_name || 'Unknown';
                const awayTeamName = awayTeam?.team_name || 'Unknown';
                const matchDate = match.match_date ? formatMatchDate(match.match_date) : '-';
                const correctedBadge = match.corrected_at ? '<span class="makeup-badge" style="background: var(--pink);">CORRECTED</span>' : '';

                html += `
                    <div class="match-row">
                        <div>
                            <div class="match-teams">${homeTeamName} vs ${awayTeamName} ${correctedBadge}</div>
                            <div class="match-meta">Week ${match.week} - ${matchDate} - ${(match.status || 'scheduled').toUpperCase()}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="match-score">${match.home_score || 0} - ${match.away_score || 0}</span>
                            <button class="brdc-btn brdc-btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openCorrectionModal('${match.id}')">Edit</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Render player levels list
        function renderLevelPlayers() {
            const container = document.getElementById('levelPlayersList');
            const searchTerm = document.getElementById('levelPlayerSearch').value.toLowerCase();
            const levelFilter = document.getElementById('levelFilter').value;

            let filtered = playersData.filter(p => {
                if (searchTerm && !p.name.toLowerCase().includes(searchTerm)) return false;
                const playerLevel = p.level || '';
                if (levelFilter === 'unassigned' && playerLevel) return false;
                if (levelFilter !== 'all' && levelFilter !== 'unassigned' && playerLevel !== levelFilter) return false;
                return true;
            });

            if (!filtered.length) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-dim);">No players found matching filters.</p>';
                return;
            }

            let html = '';
            filtered.forEach(player => {
                const teamName = player.team_id ? getTeamName(player.team_id) : 'Unassigned';
                const currentLevel = player.level || '';
                const levelClass = currentLevel ? `level-${currentLevel.toLowerCase()}` : 'level-unassigned';
                const levelDisplay = currentLevel || 'Unassigned';

                html += `
                    <div class="director-card" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px;">
                        <div>
                            <div style="font-weight: 700; color: var(--text-light);">${player.name}</div>
                            <div style="font-size: 12px; color: var(--text-dim);">${teamName}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="level-badge ${levelClass}">${levelDisplay}</span>
                            <select onchange="updatePlayerLevel('${player.id}', this.value)" style="padding: 6px 10px; border-radius: 4px; border: 2px solid var(--border-strong); background: var(--bg-card); color: var(--text-light); font-size: 12px;">
                                <option value="" ${!currentLevel ? 'selected' : ''}>Unassigned</option>
                                <option value="A" ${currentLevel === 'A' ? 'selected' : ''}>A - Advanced</option>
                                <option value="B" ${currentLevel === 'B' ? 'selected' : ''}>B - Intermediate</option>
                                <option value="C" ${currentLevel === 'C' ? 'selected' : ''}>C - Beginner</option>
                            </select>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Render reschedule matches list
        function renderRescheduleMatches() {
            const container = document.getElementById('rescheduleMatchesList');
            const weekFilter = document.getElementById('rescheduleWeekFilter').value;
            const statusFilter = document.getElementById('rescheduleStatusFilter').value;

            let filtered = matchesData.filter(m => {
                if (weekFilter !== 'all' && m.week !== parseInt(weekFilter)) return false;
                if (statusFilter === 'scheduled' && m.status === 'completed') return false;
                return true;
            });

            if (!filtered.length) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-dim);">No matches found matching filters.</p>';
                return;
            }

            let html = '';
            filtered.forEach(match => {
                const homeTeam = teamsData.find(t => t.id === match.home_team_id);
                const awayTeam = teamsData.find(t => t.id === match.away_team_id);
                const homeTeamName = homeTeam?.team_name || 'Unknown';
                const awayTeamName = awayTeam?.team_name || 'Unknown';
                const matchDate = match.match_date ? formatMatchDate(match.match_date) : '-';
                const makeupBadge = match.is_makeup ? '<span class="makeup-badge">MAKEUP</span>' : '';
                const rescheduledBadge = match.rescheduled_at ? '<span class="makeup-badge" style="background: var(--teal); color: #000;">RESCHEDULED</span>' : '';

                html += `
                    <div class="match-row">
                        <div>
                            <div class="match-teams">${homeTeamName} vs ${awayTeamName} ${makeupBadge} ${rescheduledBadge}</div>
                            <div class="match-meta">Week ${match.week} - ${matchDate}</div>
                        </div>
                        <button class="brdc-btn brdc-btn-secondary" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, var(--yellow), #f9a825); color: #000;" onclick="openRescheduleModal('${match.id}')">Reschedule</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Helper function to format match date
        function formatMatchDate(dateValue) {
            if (!dateValue) return '-';
            let date;
            if (dateValue.toDate) {
                date = dateValue.toDate();
            } else if (dateValue.seconds) {
                date = new Date(dateValue.seconds * 1000);
            } else {
                date = new Date(dateValue);
            }
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        // Update player level
        window.updatePlayerLevel = async function(playerId, newLevel) {
            try {
                showLoading('Updating player level...');
                const result = await callFunction('setPlayerLevel', {
                    league_id: leagueId,
                    player_id: playerId,
                    level: newLevel,
                    director_pin: adminPin
                });
                hideLoading();

                if (result.success) {
                    // Update local data
                    const player = playersData.find(p => p.id === playerId);
                    if (player) player.level = newLevel || null;
                    renderLevelPlayers();
                    alert(`Player level updated to ${newLevel || 'Unassigned'}`);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                hideLoading();
                alert('Error: ' + e.message);
            }
        };

        // Open correction modal
        window.openCorrectionModal = function(matchId) {
            const match = matchesData.find(m => m.id === matchId);
            if (!match) return alert('Match not found');

            const homeTeam = teamsData.find(t => t.id === match.home_team_id);
            const awayTeam = teamsData.find(t => t.id === match.away_team_id);

            document.getElementById('correctionMatchId').value = matchId;
            document.getElementById('correctionHomeTeam').textContent = homeTeam?.team_name || 'Home';
            document.getElementById('correctionAwayTeam').textContent = awayTeam?.team_name || 'Away';
            document.getElementById('correctionCurrentScore').textContent = `${match.home_score || 0} - ${match.away_score || 0}`;
            document.getElementById('correctionNewHomeScore').value = match.home_score || 0;
            document.getElementById('correctionNewAwayScore').value = match.away_score || 0;
            document.getElementById('correctionReason').value = '';

            document.getElementById('correctionModal').classList.add('active');
        };

        window.closeCorrectionModal = function() {
            document.getElementById('correctionModal').classList.remove('active');
        };

        window.submitCorrection = async function() {
            const matchId = document.getElementById('correctionMatchId').value;
            const homeScore = parseInt(document.getElementById('correctionNewHomeScore').value) || 0;
            const awayScore = parseInt(document.getElementById('correctionNewAwayScore').value) || 0;
            const reason = document.getElementById('correctionReason').value.trim();

            if (!reason) {
                alert('Please provide a reason for the correction');
                return;
            }

            try {
                showLoading('Correcting match result...');
                const result = await callFunction('correctMatchResult', {
                    league_id: leagueId,
                    match_id: matchId,
                    home_score: homeScore,
                    away_score: awayScore,
                    reason: reason,
                    director_pin: adminPin
                });
                hideLoading();

                if (result.success) {
                    // Update local data
                    const match = matchesData.find(m => m.id === matchId);
                    if (match) {
                        match.home_score = homeScore;
                        match.away_score = awayScore;
                        match.corrected_at = new Date();
                    }
                    closeCorrectionModal();
                    renderCorrectionMatches();
                    loadToolsStats();
                    alert(`Match score corrected: ${result.correction.old_score} -> ${result.correction.new_score}`);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                hideLoading();
                alert('Error: ' + e.message);
            }
        };

        // Open reschedule modal
        window.openRescheduleModal = function(matchId) {
            const match = matchesData.find(m => m.id === matchId);
            if (!match) return alert('Match not found');

            const homeTeam = teamsData.find(t => t.id === match.home_team_id);
            const awayTeam = teamsData.find(t => t.id === match.away_team_id);

            document.getElementById('rescheduleMatchId').value = matchId;
            document.getElementById('rescheduleMatchTeams').textContent = `${homeTeam?.team_name || 'Home'} vs ${awayTeam?.team_name || 'Away'}`;
            document.getElementById('rescheduleMatchWeek').textContent = match.week || '-';
            document.getElementById('rescheduleCurrentDate').textContent = match.match_date ? formatMatchDate(match.match_date) : 'Not set';
            document.getElementById('rescheduleIsMakeup').checked = match.is_makeup || false;
            document.getElementById('rescheduleNotify').checked = false;

            // Set default new date to current match date
            if (match.match_date) {
                let date;
                if (match.match_date.toDate) {
                    date = match.match_date.toDate();
                } else if (match.match_date.seconds) {
                    date = new Date(match.match_date.seconds * 1000);
                } else {
                    date = new Date(match.match_date);
                }
                const isoString = date.toISOString().slice(0, 16);
                document.getElementById('rescheduleNewDate').value = isoString;
            } else {
                document.getElementById('rescheduleNewDate').value = '';
            }

            document.getElementById('rescheduleModal').classList.add('active');
        };

        window.closeRescheduleModal = function() {
            document.getElementById('rescheduleModal').classList.remove('active');
        };

        window.submitReschedule = async function() {
            const matchId = document.getElementById('rescheduleMatchId').value;
            const newDate = document.getElementById('rescheduleNewDate').value;
            const isMakeup = document.getElementById('rescheduleIsMakeup').checked;
            const notifyCaptains = document.getElementById('rescheduleNotify').checked;

            if (!newDate) {
                alert('Please select a new date');
                return;
            }

            try {
                showLoading('Rescheduling match...');
                const result = await callFunction('rescheduleMatch', {
                    league_id: leagueId,
                    match_id: matchId,
                    new_date: newDate,
                    is_makeup: isMakeup,
                    notify_captains: notifyCaptains,
                    director_pin: adminPin
                });
                hideLoading();

                if (result.success) {
                    // Update local data
                    const match = matchesData.find(m => m.id === matchId);
                    if (match) {
                        match.match_date = { seconds: new Date(newDate).getTime() / 1000 };
                        match.is_makeup = isMakeup;
                        match.rescheduled_at = new Date();
                    }
                    closeRescheduleModal();
                    renderRescheduleMatches();
                    renderMatches();
                    loadToolsStats();
                    alert(`Match rescheduled to ${new Date(newDate).toLocaleDateString()}`);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                hideLoading();
                alert('Error: ' + e.message);
            }
        };

        pinInput.focus();
    </script>
    <script src="/js/nav-menu.js"></script>
<script src="/js/feedback.js"></script>
</body>
</html>
