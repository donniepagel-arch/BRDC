<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Registration - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/brdc-styles.css">
    
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AUmb0UDs591R2-tgLslzyu5xEfiopDTh0emqBVTXWzvOgQus_iTPpOtqt2JZdf4mk9V3NxeIp2tRv2eR&currency=USD&disable-funding=venmo,paylater"></script>
</head>
<body>
    <div id="appContainer"></div>

    <script type="module">
        import { db, doc, getDoc, callFunction } from '/js/firebase-config.js';
        
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('event_id');
        const tournamentId = urlParams.get('tournament_id');
        
        let eventData = null;
        let currentRegId = null;
        
        window.onload = async function() {
            if (!eventId || !tournamentId) {
                showError('Missing event_id or tournament_id in URL');
                return;
            }
            await loadEventData();
        };
        
        async function loadEventData() {
            try {
                // Load event and tournament data from Firestore
                const eventDoc = await getDoc(doc(db, 'events', eventId));
                const tournamentDoc = await getDoc(doc(db, 'tournaments', tournamentId));
                
                if (!eventDoc.exists() || !tournamentDoc.exists()) {
                    throw new Error('Event or tournament not found');
                }
                
                eventData = {
                    event: { id: eventId, ...eventDoc.data() },
                    tournament: { id: tournamentId, ...tournamentDoc.data() },
                    registrationCount: 0 // TODO: Query registrations count
                };
                
                renderRegistrationForm();
                
            } catch (error) {
                console.error('Error loading event:', error);
                showError('Failed to load event data: ' + error.message);
            }
        }
        
        function renderRegistrationForm() {
            const event = eventData.event;
            const tournament = eventData.tournament;
            const regCount = eventData.registrationCount || 0;
            
            const isFull = event.max_players && regCount >= event.max_players;
            const isClosed = event.status === 'completed' || event.status === 'cancelled';
            const entryFee = parseFloat(event.entry_fee) || 0;
            
            const html = `
                <div class="brdc-card" style="max-width: 600px; margin: 40px auto;">
                    <div class="brdc-card-header">
                        <h1 class="brdc-title" style="font-size: 36px; color: white;">üéØ PLAYER REGISTRATION</h1>
                        <p class="brdc-subtitle" style="color: white; margin-top: 10px;">${tournament.name}</p>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; margin-top: 15px; border: 2px solid white;">
                            üë• ${regCount} player${regCount === 1 ? '' : 's'} registered
                            ${event.max_players ? ` (max ${event.max_players})` : ''}
                        </div>
                    </div>
                    
                    <div style="padding: 30px;">
                        <h2 style="font-family: 'Bebas Neue', cursive; font-size: 28px; margin-bottom: 15px;">${event.name}</h2>
                        <div style="margin-bottom: 20px; line-height: 1.8;">
                            <div>üìÖ ${new Date(tournament.date).toLocaleDateString()}</div>
                            <div>üìç ${tournament.venue_name || 'TBD'}</div>
                            <div>üéÆ ${event.game || '501'} ‚Ä¢ ${formatEventType(event)}</div>
                            <div>üí∞ Entry Fee: $${entryFee.toFixed(2)}</div>
                        </div>
                        
                        ${isFull ? `
                            <div class="brdc-alert brdc-alert-error">
                                <strong>Event is Full</strong><br>
                                This event has reached maximum capacity of ${event.max_players} players.
                            </div>
                        ` : isClosed ? `
                            <div class="brdc-alert brdc-alert-error">
                                <strong>Registration Closed</strong><br>
                                Registration is no longer available.
                            </div>
                        ` : `
                            <form id="registrationForm" onsubmit="submitRegistration(event)">
                                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                                    <div style="flex: 1;">
                                        <label class="brdc-label">First Name *</label>
                                        <input type="text" name="first_name" required class="brdc-input" placeholder="John">
                                    </div>
                                    <div style="flex: 1;">
                                        <label class="brdc-label">Last Name *</label>
                                        <input type="text" name="last_name" required class="brdc-input" placeholder="Smith">
                                    </div>
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label class="brdc-label">Email *</label>
                                    <input type="email" name="email" required class="brdc-input" placeholder="john@example.com">
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label class="brdc-label">Phone Number *</label>
                                    <input type="tel" name="phone" required class="brdc-input" placeholder="555-123-4567" oninput="updatePinPreview()">
                                    <small style="color: #666; font-size: 12px;">Last 4 digits will be part of your login PIN</small>
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label class="brdc-label">Choose Your 4-Digit PIN *</label>
                                    <input type="text" name="chosen_pin" required class="brdc-input" placeholder="1234" maxlength="4" pattern="[0-9]{4}" oninput="updatePinPreview()" style="letter-spacing: 8px; font-size: 24px; text-align: center;">
                                    <small style="color: #666; font-size: 12px;">Choose any 4 digits you'll remember</small>
                                </div>

                                <div id="pinPreview" style="background: var(--teal); border: 3px solid var(--black); padding: 15px; margin-bottom: 20px; text-align: center; display: none;">
                                    <div style="font-weight: 700; margin-bottom: 5px;">Your 8-Digit Login PIN will be:</div>
                                    <div style="font-family: 'Bebas Neue', cursive; font-size: 36px; letter-spacing: 4px;">
                                        <span id="pinPreviewValue">--------</span>
                                    </div>
                                    <small style="color: #333;">(Phone last 4) + (Your chosen PIN)</small>
                                </div>

                                <div style="margin-bottom: 20px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" name="sms_opt_in" checked style="width: 20px; height: 20px;">
                                        <span style="font-weight: 600;">Send me SMS match updates</span>
                                    </label>
                                </div>

                                <button type="submit" class="brdc-btn" style="width: 100%;">
                                    ${entryFee > 0 ? 'CONTINUE TO PAYMENT' : 'REGISTER NOW'}
                                </button>
                            </form>
                        `}
                    </div>
                </div>
            `;
            
            document.getElementById('appContainer').innerHTML = html;
        }
        
        function formatEventType(event) {
            const size = event.team_size === 1 ? 'Singles' :
                        event.team_size === 2 ? 'Doubles' :
                        event.team_size === 3 ? 'Triples' :
                        event.team_size + '-player';

            if (event.entry_type === 'blind_draw') return 'Blind Draw ' + size;
            if (event.entry_type === 'team') return 'Team ' + size;
            return 'Individual ' + size;
        }

        window.updatePinPreview = function() {
            const phoneInput = document.querySelector('input[name="phone"]');
            const pinInput = document.querySelector('input[name="chosen_pin"]');
            const previewDiv = document.getElementById('pinPreview');
            const previewValue = document.getElementById('pinPreviewValue');

            if (!phoneInput || !pinInput || !previewDiv || !previewValue) return;

            // Extract only digits from phone
            const phoneDigits = phoneInput.value.replace(/\D/g, '');
            const phoneLast4 = phoneDigits.slice(-4);
            const chosenPin = pinInput.value.replace(/\D/g, '');

            // Show preview if we have at least some digits
            if (phoneLast4.length > 0 || chosenPin.length > 0) {
                previewDiv.style.display = 'block';
                const displayPhone = phoneLast4.padEnd(4, '-');
                const displayPin = chosenPin.padEnd(4, '-');
                previewValue.textContent = displayPhone + displayPin;
            } else {
                previewDiv.style.display = 'none';
            }
        };
        
        window.submitRegistration = async function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const btn = form.querySelector('button[type="submit"]');

            // Validate chosen PIN is exactly 4 digits
            const chosenPin = formData.get('chosen_pin');
            if (!/^\d{4}$/.test(chosenPin)) {
                alert('Please enter exactly 4 digits for your PIN');
                return;
            }

            // Validate phone has at least 4 digits
            const phone = formData.get('phone') || '';
            const phoneDigits = phone.replace(/\D/g, '');
            if (phoneDigits.length < 4) {
                alert('Please enter a valid phone number with at least 4 digits');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'REGISTERING...';

            const firstName = formData.get('first_name');
            const lastName = formData.get('last_name');

            try {
                const result = await callFunction('registerPlayer', {
                    event_id: eventId,
                    tournament_id: tournamentId,
                    first_name: firstName,
                    last_name: lastName,
                    name: firstName + ' ' + lastName,
                    email: formData.get('email'),
                    phone: phone,
                    chosen_pin: chosenPin,
                    sms_opt_in: formData.get('sms_opt_in') ? true : false
                });

                if (!result.success) {
                    throw new Error(result.error || 'Registration failed');
                }

                currentRegId = result.registration_id;
                const entryFee = parseFloat(eventData.event.entry_fee) || 0;

                if (entryFee > 0) {
                    showPaymentScreen(result);
                } else {
                    showSuccess(result);
                }

            } catch (error) {
                alert('Error: ' + error.message);
                console.error('Registration error:', error);
                btn.disabled = false;
                btn.textContent = eventData.event.entry_fee > 0 ? 'CONTINUE TO PAYMENT' : 'REGISTER NOW';
            }
        };
        
        function showPaymentScreen(registration) {
            const event = eventData.event;
            const tournament = eventData.tournament;
            const entryFee = parseFloat(event.entry_fee);
            
            const html = `
                <div class="brdc-card" style="max-width: 600px; margin: 40px auto;">
                    <div class="brdc-card-header">
                        <h1 class="brdc-title" style="font-size: 36px; color: white;">üí≥ COMPLETE PAYMENT</h1>
                        <p class="brdc-subtitle" style="color: white; margin-top: 10px;">${tournament.name}</p>
                    </div>
                    
                    <div style="padding: 30px;">
                        <div class="brdc-alert brdc-alert-success">
                            <strong>‚úÖ Registration Submitted!</strong><br>
                            Complete payment to secure your spot
                        </div>
                        
                        <div style="background: #f9fafb; border: 3px solid var(--black); padding: 30px; margin: 30px 0; box-shadow: 6px 6px 0 rgba(0,0,0,1);">
                            <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; margin-bottom: 15px;">Payment Details</h3>
                            <div style="margin-bottom: 20px; font-weight: 600;">
                                <strong>${registration.name || (registration.first_name + ' ' + registration.last_name)}</strong><br>
                                ${event.name}<br>
                                Entry Fee
                            </div>
                            <div style="font-family: 'Bebas Neue', cursive; font-size: 64px; color: var(--pink); text-shadow: 3px 3px 0 rgba(0,0,0,0.2);">
                                $${entryFee.toFixed(2)}
                            </div>
                            
                            <div style="background: var(--teal); border: 3px solid var(--black); padding: 20px; margin-top: 20px; font-weight: 700;">
                                üí≥ Pay with Credit/Debit Card<br>
                                <span style="font-size: 14px; font-weight: 600;">Click below to pay securely. No account needed!</span>
                            </div>
                            
                            <div id="paypal-button-container" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('appContainer').innerHTML = html;
            initPayPalButtons(entryFee);
        }
        
        function initPayPalButtons(amount) {
            paypal.Buttons({
                style: {
                    layout: 'vertical',
                    color: 'blue',
                    shape: 'rect',
                    label: 'pay'
                },
                
                createOrder: async function(data, actions) {
                    try {
                        const result = await callFunction('createPayPalOrder', {
                            registration_id: currentRegId,
                            event_id: eventId,
                            amount: amount
                        });
                        
                        if (result.success && result.order_id) {
                            return result.order_id;
                        } else {
                            throw new Error(result.error || 'Failed to create order');
                        }
                    } catch (error) {
                        console.error('Error creating order:', error);
                        alert('Payment failed. Please try again.');
                        throw error;
                    }
                },
                
                onApprove: async function(data, actions) {
                    try {
                        const result = await callFunction('capturePayPalPayment', {
                            order_id: data.orderID,
                            registration_id: currentRegId
                        });
                        
                        if (result.success) {
                            showSuccess(result);
                        } else {
                            alert('Payment capture failed: ' + result.error);
                        }
                    } catch (error) {
                        console.error('Error capturing payment:', error);
                        alert('Payment verification failed. Contact support.');
                    }
                },
                
                onError: function(err) {
                    console.error('PayPal error:', err);
                    alert('Payment failed. Please try again or contact support.');
                }
                
            }).render('#paypal-button-container');
        }
        
        function showSuccess(result) {
            // result could be registration result or payment result
            const pin = result && result.pin ? result.pin : null;

            const html = `
                <div class="brdc-card" style="max-width: 600px; margin: 40px auto;">
                    <div class="brdc-card-header">
                        <h1 class="brdc-title" style="font-size: 36px; color: white;">${result && result.transaction_id ? 'PAYMENT SUCCESSFUL!' : 'REGISTRATION COMPLETE!'}</h1>
                        <p class="brdc-subtitle" style="color: white; margin-top: 10px;">${eventData.tournament.name}</p>
                    </div>

                    <div style="padding: 30px; text-align: center;">
                        <div style="font-size: 80px; margin-bottom: 20px;">üéâ</div>
                        <h2 style="font-family: 'Bebas Neue', cursive; font-size: 36px; margin-bottom: 15px;">You're All Set!</h2>
                        <p style="font-size: 18px; font-weight: 600; margin-bottom: 20px;">
                            ${result && result.transaction_id ? 'Registration and payment complete.' : 'Registered for ' + eventData.event.name}
                        </p>

                        ${pin ? `
                            <div style="background: var(--teal); border: 3px solid var(--black); padding: 20px; margin: 20px 0;">
                                <div style="font-weight: 700; margin-bottom: 10px;">Your 8-Digit Login PIN:</div>
                                <div style="font-family: 'Bebas Neue', cursive; font-size: 48px; letter-spacing: 6px; color: var(--black);">
                                    ${pin}
                                </div>
                                <small style="color: #333;">Save this PIN - you'll need it to log in and check your matches</small>
                            </div>
                        ` : ''}

                        ${result && result.transaction_id ? `
                            <p style="font-size: 11px; font-family: monospace; opacity: 0.7;">
                                Transaction: ${result.transaction_id}
                            </p>
                        ` : ''}
                        <p style="margin-top: 30px; font-weight: 600;">We'll send you updates about the tournament.</p>
                        <p style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--pink); margin-top: 20px;">
                            See you there!
                        </p>
                    </div>
                </div>
            `;

            document.getElementById('appContainer').innerHTML = html;
        }
        
        function showError(message) {
            document.getElementById('appContainer').innerHTML = `
                <div class="brdc-card" style="max-width: 600px; margin: 40px auto;">
                    <div class="brdc-alert brdc-alert-error">
                        <strong>Error</strong><br>
                        ${message}
                    </div>
                </div>
            `;
        }
    </script>
<script src="/js/feedback.js"></script>
</body>
</html>
