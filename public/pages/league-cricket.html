<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cricket Scorer - BRDC League</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800;900&display=swap');
        :root { --pink: #FF469A; --blue-dark: #001F4D; --blue-light: #1F85AF; --teal: #91D7EB; --yellow: #FDD835; --black: #000; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { background: var(--blue-dark); min-height: 100vh; }
        .header { background: var(--pink); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--black); }
        .back-btn { background: white; border: 3px solid var(--black); padding: 8px 15px; font-weight: 800; cursor: pointer; box-shadow: 3px 3px 0 rgba(0,0,0,1); }
        .game-info { color: white; font-family: 'Bebas Neue', cursive; font-size: 20px; }
        .leg-info { background: var(--yellow); border: 3px solid var(--black); padding: 8px 15px; font-family: 'Bebas Neue', cursive; font-size: 18px; }
        
        .scorer-main { padding: 10px; }
        
        .players-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .player-card { background: white; border: 4px solid var(--black); padding: 15px; text-align: center; box-shadow: 5px 5px 0 rgba(0,0,0,1); }
        .player-card.active { background: var(--yellow); }
        .player-name { font-family: 'Bebas Neue', cursive; font-size: 20px; }
        .player-score { font-family: 'Bebas Neue', cursive; font-size: 48px; color: var(--pink); }
        .player-stats { display: flex; justify-content: center; gap: 20px; margin-top: 10px; font-size: 12px; }
        .player-stats span { background: #f3f4f6; padding: 4px 8px; border: 2px solid var(--black); }

        .cricket-board { background: #1a1a1a; border: 4px solid var(--black); margin-bottom: 10px; }
        .cricket-row { display: grid; grid-template-columns: 80px 1fr 1fr; border-bottom: 2px solid #333; }
        .cricket-row:last-child { border-bottom: none; }
        .cricket-number { background: var(--blue-dark); color: white; padding: 12px; text-align: center; font-family: 'Bebas Neue', cursive; font-size: 28px; border-right: 2px solid #333; }
        .cricket-marks { display: flex; align-items: center; justify-content: center; gap: 5px; padding: 10px; background: #111; border-right: 2px solid #333; }
        .cricket-marks:last-child { border-right: none; }
        .cricket-marks.closed { background: #064e3b; }
        .mark { width: 24px; height: 24px; border: 2px solid #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #666; }
        .mark.hit { background: var(--pink); border-color: var(--pink); color: white; }
        .mark.closed { background: #10b981; border-color: #10b981; }

        .input-section { background: white; border: 4px solid var(--black); padding: 15px; box-shadow: 6px 6px 0 rgba(0,0,0,1); }
        .round-info { text-align: center; margin-bottom: 15px; }
        .round-label { font-size: 12px; color: #666; text-transform: uppercase; }
        .round-marks { font-family: 'Bebas Neue', cursive; font-size: 36px; color: var(--pink); }
        
        .mark-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .mark-btn { background: var(--blue-light); color: white; border: 3px solid var(--black); padding: 15px 10px; font-family: 'Bebas Neue', cursive; font-size: 20px; cursor: pointer; box-shadow: 3px 3px 0 rgba(0,0,0,1); }
        .mark-btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 rgba(0,0,0,1); }
        .mark-btn.selected { background: var(--pink); }
        
        .action-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .action-btn { border: 3px solid var(--black); padding: 12px; font-weight: 800; cursor: pointer; box-shadow: 3px 3px 0 rgba(0,0,0,1); text-align: center; }
        .action-btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 rgba(0,0,0,1); }
        .action-btn.miss { background: #ef4444; color: white; }
        .action-btn.undo { background: var(--yellow); }
        .action-btn.end { background: var(--teal); }
        .action-btn.confirm { background: var(--pink); color: white; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border: 5px solid var(--black); box-shadow: 12px 12px 0 rgba(0,0,0,1); padding: 30px; max-width: 450px; width: 100%; text-align: center; }
        .modal-title { font-family: 'Bebas Neue', cursive; font-size: 32px; margin-bottom: 15px; }
        .modal-btn { background: var(--pink); color: white; border: 3px solid var(--black); padding: 12px 24px; font-size: 16px; font-weight: 800; cursor: pointer; box-shadow: 4px 4px 0 rgba(0,0,0,1); margin: 8px; }
        .winner-display { font-family: 'Bebas Neue', cursive; font-size: 36px; color: var(--pink); margin: 15px 0; }
        .final-stats { text-align: left; background: #f3f4f6; padding: 15px; margin: 15px 0; border: 3px solid var(--black); font-size: 14px; }
        .final-stats div { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center; gap: 12px;">
            <button class="back-btn" onclick="goBack()">‚Üê</button>
            <div class="game-info" id="gameTitle">Game 2 ‚Ä¢ Cricket</div>
        </div>
        <div class="leg-info" id="legInfo">LEG 1/3</div>
    </div>

    <div class="scorer-main">
        <div class="players-row">
            <div class="player-card active" id="player1Card" onclick="setActive(0)">
                <div class="player-name" id="player1Name">Home</div>
                <div class="player-score" id="player1Score">0</div>
                <div class="player-stats">
                    <span>MPR: <b id="player1MPR">0.00</b></span>
                    <span>Legs: <b id="player1Legs">0</b></span>
                </div>
            </div>
            <div class="player-card" id="player2Card" onclick="setActive(1)">
                <div class="player-name" id="player2Name">Away</div>
                <div class="player-score" id="player2Score">0</div>
                <div class="player-stats">
                    <span>MPR: <b id="player2MPR">0.00</b></span>
                    <span>Legs: <b id="player2Legs">0</b></span>
                </div>
            </div>
        </div>

        <div class="cricket-board" id="cricketBoard">
            <!-- Generated by JS -->
        </div>

        <div class="input-section">
            <div class="round-info">
                <div class="round-label">Round <span id="roundNum">1</span> - Marks This Round</div>
                <div class="round-marks" id="roundMarks">0</div>
            </div>
            
            <div class="mark-buttons" id="markButtons">
                <!-- Generated by JS -->
            </div>

            <div class="action-row">
                <button class="action-btn miss" onclick="recordMiss()">MISS</button>
                <button class="action-btn undo" onclick="undoMark()">UNDO</button>
                <button class="action-btn end" onclick="endRound()">END RND</button>
                <button class="action-btn confirm" onclick="confirmRound()">CONFIRM</button>
            </div>
        </div>
    </div>

    <div class="modal" id="legModal">
        <div class="modal-content">
            <div class="modal-title">üéØ LEG WINNER!</div>
            <div class="winner-display" id="legWinner">Player</div>
            <div id="legStats" class="final-stats"></div>
            <button class="modal-btn" onclick="nextLeg()">NEXT LEG</button>
        </div>
    </div>

    <div class="modal" id="gameModal">
        <div class="modal-content">
            <div class="modal-title">üèÜ GAME OVER!</div>
            <div class="winner-display" id="gameWinner">Player</div>
            <div id="gameStats" class="final-stats"></div>
            <button class="modal-btn" onclick="saveAndExit()">SAVE & EXIT</button>
        </div>
    </div>

<script type="module">
import { callFunction } from '/js/firebase-config.js';

const params = new URLSearchParams(window.location.search);
const leagueId = params.get('league_id');
const matchId = params.get('match_id');
const gameIndex = parseInt(params.get('game_index') || '0');
const gameNumber = params.get('game_number') || '2';

let homePlayers = [], awayPlayers = [];
try { homePlayers = JSON.parse(params.get('home_players') || '[]'); } catch(e) {}
try { awayPlayers = JSON.parse(params.get('away_players') || '[]'); } catch(e) {}

const NUMBERS = [20, 19, 18, 17, 16, 15, 25]; // 25 = Bull
const LEGS_TO_WIN = 2;

let active = 0, leg = 1, round = 1;
let roundMarks = []; // Marks in current round

let players = [
    { name: homePlayers.map(p => p?.name || 'Home').join(' & '), score: 0, marks: {20:0,19:0,18:0,17:0,16:0,15:0,25:0}, legs: 0,
      totalMarks: 0, totalRounds: 0, nineMarks: 0, eightMarks: 0 },
    { name: awayPlayers.map(p => p?.name || 'Away').join(' & '), score: 0, marks: {20:0,19:0,18:0,17:0,16:0,15:0,25:0}, legs: 0,
      totalMarks: 0, totalRounds: 0, nineMarks: 0, eightMarks: 0 }
];

function init() {
    document.getElementById('gameTitle').textContent = `Game ${gameNumber} ‚Ä¢ Cricket`;
    document.getElementById('player1Name').textContent = players[0].name;
    document.getElementById('player2Name').textContent = players[1].name;
    renderBoard();
    renderMarkButtons();
    updateUI();
}

function renderBoard() {
    let html = '';
    NUMBERS.forEach(num => {
        const label = num === 25 ? 'BULL' : num;
        html += `
            <div class="cricket-row">
                <div class="cricket-number">${label}</div>
                <div class="cricket-marks ${isClosed(0, num) ? 'closed' : ''}" id="marks-0-${num}">
                    ${renderMarks(0, num)}
                </div>
                <div class="cricket-marks ${isClosed(1, num) ? 'closed' : ''}" id="marks-1-${num}">
                    ${renderMarks(1, num)}
                </div>
            </div>
        `;
    });
    document.getElementById('cricketBoard').innerHTML = html;
}

function renderMarks(playerIdx, num) {
    const count = players[playerIdx].marks[num];
    const closed = isClosed(playerIdx, num);
    let html = '';
    for (let i = 0; i < 3; i++) {
        const hit = count > i;
        const cls = closed ? 'closed' : hit ? 'hit' : '';
        const icon = i === 0 ? '/' : i === 1 ? 'X' : '‚äó';
        html += `<div class="mark ${cls}">${hit ? icon : ''}</div>`;
    }
    return html;
}

function isClosed(playerIdx, num) {
    return players[playerIdx].marks[num] >= 3;
}

function isNumberClosed(num) {
    return players[0].marks[num] >= 3 && players[1].marks[num] >= 3;
}

function renderMarkButtons() {
    let html = '';
    NUMBERS.forEach(num => {
        const label = num === 25 ? 'BULL' : num;
        const disabled = isNumberClosed(num);
        html += `<button class="mark-btn ${disabled ? 'disabled' : ''}" onclick="addMark(${num})" ${disabled ? 'disabled' : ''}>${label}</button>`;
    });
    // Add x2 and x3 buttons
    html += `<button class="mark-btn" onclick="addMultiple(2)">x2</button>`;
    html += `<button class="mark-btn" onclick="addMultiple(3)">x3</button>`;
    document.getElementById('markButtons').innerHTML = html;
}

let lastNumber = null;

window.addMark = function(num) {
    if (isNumberClosed(num)) return;
    if (roundMarks.length >= 9) { alert('Max 9 marks per round'); return; }
    
    roundMarks.push(num);
    lastNumber = num;
    applyMarks();
    updateUI();
};

window.addMultiple = function(count) {
    if (!lastNumber) { alert('Select a number first'); return; }
    if (isNumberClosed(lastNumber)) return;
    
    for (let i = 1; i < count && roundMarks.length < 9; i++) {
        if (!isNumberClosed(lastNumber)) {
            roundMarks.push(lastNumber);
        }
    }
    applyMarks();
    updateUI();
};

function applyMarks() {
    // Reset to start of round
    const p = players[active];
    // Recalculate from roundMarks
    const savedMarks = JSON.parse(JSON.stringify(p.marks));
    const savedScore = p.score;
    
    // Reset marks to before this round (we'd need round history for proper undo)
    // For simplicity, just apply all roundMarks fresh
}

window.undoMark = function() {
    if (roundMarks.length === 0) return;
    roundMarks.pop();
    recalculateRound();
    updateUI();
};

function recalculateRound() {
    // This is a simplified recalc - in production you'd track round-start state
}

window.recordMiss = function() {
    // A miss is just ending without marks
    roundMarks.push('miss');
    updateUI();
};

window.endRound = function() {
    confirmRound();
};

window.confirmRound = function() {
    const p = players[active];
    const opponent = players[1 - active];
    
    // Apply marks
    let marksThisRound = 0;
    roundMarks.forEach(m => {
        if (m === 'miss') return;
        const num = m;
        if (isNumberClosed(num)) return;
        
        const currentMarks = p.marks[num];
        if (currentMarks < 3) {
            p.marks[num]++;
            marksThisRound++;
        } else if (!isClosed(1 - active, num)) {
            // Score points
            const points = num === 25 ? 25 : num;
            p.score += points;
            marksThisRound++;
        }
    });
    
    // Track stats
    p.totalMarks += marksThisRound;
    p.totalRounds++;
    if (marksThisRound >= 9) p.nineMarks++;
    else if (marksThisRound >= 8) p.eightMarks++;
    
    // Check for win
    if (checkWin(active)) {
        p.legs++;
        if (p.legs >= LEGS_TO_WIN) {
            showGameWinner(active);
        } else {
            showLegWinner(active);
        }
    } else {
        // Switch player
        active = 1 - active;
        round++;
        roundMarks = [];
        lastNumber = null;
    }
    
    renderBoard();
    renderMarkButtons();
    updateUI();
};

function checkWin(playerIdx) {
    const p = players[playerIdx];
    const opp = players[1 - playerIdx];
    
    // Must have all numbers closed AND have equal or more points
    const allClosed = NUMBERS.every(num => p.marks[num] >= 3);
    return allClosed && p.score >= opp.score;
}

function updateUI() {
    document.getElementById('player1Score').textContent = players[0].score;
    document.getElementById('player2Score').textContent = players[1].score;
    document.getElementById('player1Legs').textContent = players[0].legs;
    document.getElementById('player2Legs').textContent = players[1].legs;
    
    const mpr1 = players[0].totalRounds > 0 ? (players[0].totalMarks / players[0].totalRounds).toFixed(2) : '0.00';
    const mpr2 = players[1].totalRounds > 0 ? (players[1].totalMarks / players[1].totalRounds).toFixed(2) : '0.00';
    document.getElementById('player1MPR').textContent = mpr1;
    document.getElementById('player2MPR').textContent = mpr2;
    
    document.getElementById('player1Card').classList.toggle('active', active === 0);
    document.getElementById('player2Card').classList.toggle('active', active === 1);
    
    document.getElementById('legInfo').textContent = `LEG ${leg}/3`;
    document.getElementById('roundNum').textContent = round;
    
    // Count marks in current round (excluding misses)
    const validMarks = roundMarks.filter(m => m !== 'miss').length;
    document.getElementById('roundMarks').textContent = validMarks;
}

window.setActive = function(idx) {
    if (roundMarks.length > 0) {
        if (!confirm('Switch player? Current round marks will be lost.')) return;
        roundMarks = [];
    }
    active = idx;
    updateUI();
};

function showLegWinner(idx) {
    const p = players[idx];
    document.getElementById('legWinner').textContent = p.name;
    const mpr = p.totalRounds > 0 ? (p.totalMarks / p.totalRounds).toFixed(2) : '0.00';
    document.getElementById('legStats').innerHTML = `
        <div><span>MPR</span><span>${mpr}</span></div>
        <div><span>9-Mark Rounds</span><span>${p.nineMarks}</span></div>
        <div><span>Points</span><span>${p.score}</span></div>
    `;
    document.getElementById('legModal').classList.add('active');
}

window.nextLeg = function() {
    document.getElementById('legModal').classList.remove('active');
    leg++;
    round = 1;
    roundMarks = [];
    
    // Reset for new leg but keep cumulative stats
    players.forEach(p => {
        p.score = 0;
        p.marks = {20:0,19:0,18:0,17:0,16:0,15:0,25:0};
    });
    
    active = leg % 2 === 0 ? 1 : 0;
    renderBoard();
    renderMarkButtons();
    updateUI();
};

function showGameWinner(idx) {
    const p = players[idx];
    document.getElementById('gameWinner').textContent = p.name + ' WINS!';
    
    const mpr1 = players[0].totalRounds > 0 ? (players[0].totalMarks / players[0].totalRounds).toFixed(2) : '0.00';
    const mpr2 = players[1].totalRounds > 0 ? (players[1].totalMarks / players[1].totalRounds).toFixed(2) : '0.00';
    
    document.getElementById('gameStats').innerHTML = `
        <div><span>${players[0].name}</span><span></span></div>
        <div><span>MPR</span><span>${mpr1}</span></div>
        <div><span>9-Marks</span><span>${players[0].nineMarks}</span></div>
        <hr style="border:1px solid #ccc;margin:10px 0">
        <div><span>${players[1].name}</span><span></span></div>
        <div><span>MPR</span><span>${mpr2}</span></div>
        <div><span>9-Marks</span><span>${players[1].nineMarks}</span></div>
    `;
    document.getElementById('gameModal').classList.add('active');
}

window.saveAndExit = async function() {
    const winner = players[0].legs >= LEGS_TO_WIN ? 'home' : 'away';
    
    const legData = {
        leg_number: leg,
        winner: winner,
        home_stats: {
            rounds: players[0].totalRounds,
            marks: players[0].totalMarks,
            mpr: players[0].totalRounds > 0 ? (players[0].totalMarks / players[0].totalRounds).toFixed(2) : 0,
            nine_mark_rounds: players[0].nineMarks,
            eight_mark_rounds: players[0].eightMarks,
            points_scored: players[0].score
        },
        away_stats: {
            rounds: players[1].totalRounds,
            marks: players[1].totalMarks,
            mpr: players[1].totalRounds > 0 ? (players[1].totalMarks / players[1].totalRounds).toFixed(2) : 0,
            nine_mark_rounds: players[1].nineMarks,
            eight_mark_rounds: players[1].eightMarks,
            points_scored: players[1].score
        }
    };

    try {
        if (leagueId && matchId) {
            await callFunction('recordLeg', {
                league_id: leagueId,
                match_id: matchId,
                game_number: parseInt(gameNumber),
                leg_data: legData
            });
        }
    } catch (e) {
        console.error('Error saving:', e);
    }
    
    window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}`;
};

window.goBack = function() {
    if (confirm('Exit without saving?')) {
        window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}`;
    }
};

init();
</script>
</body>
</html>
