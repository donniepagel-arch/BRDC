<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cricket Scorer - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BRDC">
    <link rel="apple-touch-icon" href="/images/gold_logo.png">
    <meta name="theme-color" content="#FF469A">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@500;600;700&family=JetBrains+Mono:wght@600;700&display=swap');

        :root {
            --pink: #FF469A;
            --pink-light: #ff7ab8;
            --pink-dark: #d63a82;
            --pink-glow: rgba(255, 70, 154, 0.5);
            --teal: #91D7EB;
            --teal-light: #b4e5f5;
            --teal-dark: #68c4de;
            --teal-glow: rgba(145, 215, 235, 0.5);
            --yellow: #FDD835;
            --yellow-light: #ffe566;
            --yellow-dark: #d4b62e;
            --yellow-glow: rgba(253, 216, 53, 0.6);
            --green: #10b981;
            --green-glow: rgba(16, 185, 129, 0.5);
            --bg-deep: #050510;
            --bg-dark: #0a0a1a;
            --bg-mid: #12122a;
            --bg-card: #1a1a3a;
            --bg-elevated: #222250;
            --text-bright: #ffffff;
            --text-light: #e8e8f0;
            --text-muted: #8888aa;
            --text-dim: #5555770;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-medium: rgba(255, 255, 255, 0.15);
        }

        /* Offline Banner */
        .offline-banner {
            display: none;
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            color: #000;
            padding: 8px 16px;
            text-align: center;
            font-weight: 700;
            font-size: 13px;
            letter-spacing: 1px;
            animation: pulse-offline 2s ease-in-out infinite;
            position: relative;
            z-index: 1000;
        }
        .offline-banner.visible {
            display: block;
        }
        @keyframes pulse-offline {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            touch-action: manipulation;
        }

        html {
            height: 100%;
            height: 100dvh;
        }

        body {
            height: 100%;
            height: 100dvh;
            overflow: hidden;
            color: var(--text-light);
            font-family: 'Rajdhani', sans-serif;
            padding-bottom: env(safe-area-inset-bottom, 0);
            display: flex;
            flex-direction: column;
            background:
                radial-gradient(ellipse 100% 60% at 50% -10%, rgba(255,70,154,0.12) 0%, transparent 60%),
                radial-gradient(ellipse 80% 50% at 100% 100%, rgba(145,215,235,0.08) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 0% 80%, rgba(253,216,53,0.05) 0%, transparent 50%),
                linear-gradient(175deg, var(--bg-dark) 0%, var(--bg-deep) 40%, #030308 100%);
        }

        /* ========== PREMIUM HEADER SCOREBOARD ========== */
        .scoreboard {
            display: grid;
            grid-template-columns: 1fr 100px 1fr;
            background: linear-gradient(180deg, rgba(20,20,45,0.98) 0%, rgba(10,10,26,0.95) 100%);
            border-bottom: 1px solid var(--border-subtle);
            position: relative;
            flex-shrink: 0;
            box-shadow: 0 8px 40px rgba(0,0,0,0.6);
        }

        .scoreboard::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--pink) 0%, var(--yellow) 50%, var(--teal) 100%);
            opacity: 0.8;
        }

        .team-panel {
            padding: 16px 12px 18px;
            text-align: center;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .team-panel.home {
            background: linear-gradient(135deg, rgba(255,70,154,0.15) 0%, transparent 70%);
        }

        .team-panel.away {
            background: linear-gradient(225deg, rgba(145,215,235,0.15) 0%, transparent 70%);
        }

        .team-panel.active {
            background: linear-gradient(180deg, rgba(253,216,53,0.08) 0%, transparent 80%);
        }

        .team-panel.active::before {
            content: 'THROWING';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--yellow);
            color: #000;
            padding: 3px 12px;
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 2px;
            border-radius: 20px;
            box-shadow: 0 2px 12px var(--yellow-glow);
        }

        .team-panel.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 15%;
            right: 15%;
            height: 3px;
            background: var(--yellow);
            box-shadow: 0 0 20px var(--yellow-glow);
            z-index: 1;
        }

        .team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-top: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 130px;
            margin-left: auto;
            margin-right: auto;
        }

        .team-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 88px;
            line-height: 0.85;
            letter-spacing: -1px;
            margin-top: 2px;
        }

        .team-panel.home .team-score {
            color: var(--pink);
            text-shadow: 0 0 50px var(--pink-glow), 0 4px 0 rgba(0,0,0,0.3);
        }

        .team-panel.away .team-score {
            color: var(--teal);
            text-shadow: 0 0 50px var(--teal-glow), 0 4px 0 rgba(0,0,0,0.3);
        }

        .team-stats {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 8px;
        }

        .stat-item {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 1px;
        }

        .stat-item .val {
            color: var(--yellow);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }

        .round-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            border-left: 1px solid var(--border-subtle);
            border-right: 1px solid var(--border-subtle);
            position: relative;
        }

        .round-display::before {
            content: '';
            position: absolute;
            inset: 8px;
            border: 1px solid rgba(253,216,53,0.15);
            border-radius: 8px;
            pointer-events: none;
        }

        .round-num {
            font-family: 'Bebas Neue', cursive;
            font-size: 52px;
            color: var(--yellow);
            text-shadow: 0 0 30px var(--yellow-glow);
            line-height: 1;
        }

        .round-label {
            font-size: 9px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-top: 2px;
        }

        /* ========== CRICKET BOARD - PREMIUM GRID ========== */
        .cricket-board {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            background: linear-gradient(180deg, var(--bg-mid) 0%, var(--bg-dark) 100%);
            padding: 8px 10px;
            position: relative;
        }

        .cricket-board::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(180deg, var(--bg-mid) 0%, transparent 100%);
            pointer-events: none;
            z-index: 10;
        }

        .cricket-row {
            display: grid;
            grid-template-columns: 42px 1fr 50px 90px 50px 1fr 42px;
            align-items: center;
            gap: 5px;
            padding: 5px 0;
            margin-bottom: 3px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .cricket-row.closed {
            opacity: 0.15;
            transform: scale(0.98);
        }

        /* Points Display */
        .points-cell {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            color: var(--yellow);
            opacity: 0.9;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mark Symbols - Bold & Clear */
        .marks-cell {
            text-align: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 52px;
            line-height: 1;
            min-height: 58px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .marks-cell.home {
            color: var(--pink);
            text-shadow: 0 0 20px var(--pink-glow);
        }

        .marks-cell.away {
            color: var(--teal);
            text-shadow: 0 0 20px var(--teal-glow);
        }

        .marks-cell.done {
            color: var(--green);
            text-shadow: 0 0 15px var(--green-glow);
        }

        .mark-symbol {
            display: inline-block;
            transition: transform 0.15s ease;
        }

        .mark-closed {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .mark-closed::after {
            content: '';
            position: absolute;
            width: 42px;
            height: 42px;
            border: 3px solid currentColor;
            border-radius: 50%;
        }

        /* Modifier Buttons (D/T) */
        .mod-btn {
            width: 100%;
            padding: 16px 0;
            border: 3px solid var(--pink);
            background: linear-gradient(180deg, rgba(255,70,154,0.12) 0%, rgba(255,70,154,0.04) 100%);
            color: var(--pink);
            font-family: 'Bebas Neue', cursive;
            font-size: 26px;
            letter-spacing: 2px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.12s ease;
            position: relative;
            overflow: hidden;
        }

        .mod-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, var(--pink) 0%, var(--pink-dark) 100%);
            opacity: 0;
            transition: opacity 0.12s ease;
        }

        .mod-btn span {
            position: relative;
            z-index: 1;
        }

        .mod-btn:active::before {
            opacity: 1;
        }

        .mod-btn:active {
            color: #fff;
            transform: scale(0.95);
            box-shadow: 0 0 25px var(--pink-glow);
        }

        .mod-btn:disabled {
            opacity: 0.1;
            cursor: not-allowed;
            transform: none;
        }

        .mod-btn.triple {
            border-color: var(--teal);
            background: linear-gradient(180deg, rgba(145,215,235,0.12) 0%, rgba(145,215,235,0.04) 100%);
            color: var(--teal);
        }

        .mod-btn.triple::before {
            background: linear-gradient(180deg, var(--teal) 0%, var(--teal-dark) 100%);
        }

        .mod-btn.triple:active {
            color: #000;
            box-shadow: 0 0 25px var(--teal-glow);
        }

        /* Target Button (Number) */
        .target-btn {
            width: 100%;
            padding: 12px 0;
            background: linear-gradient(180deg, var(--bg-elevated) 0%, var(--bg-card) 100%);
            border: 3px solid rgba(255,255,255,0.25);
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Bebas Neue', cursive;
            font-size: 44px;
            color: #fff;
            box-shadow:
                0 4px 0 rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1);
            transition: all 0.1s ease;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        .target-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.5);
            background: linear-gradient(180deg, var(--yellow) 0%, var(--yellow-dark) 100%);
            border-color: var(--yellow-light);
            color: #000;
            text-shadow: none;
        }

        .target-btn:disabled {
            opacity: 0.12;
            cursor: not-allowed;
            transform: none;
        }

        /* ========== CONTROL BAR ========== */
        .control-bar {
            background: linear-gradient(180deg, rgba(18,18,42,0.98) 0%, var(--bg-deep) 100%);
            border-top: 1px solid var(--border-subtle);
            padding: 10px 12px 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom, 0));
            flex-shrink: 0;
            position: relative;
        }

        .control-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--pink) 0%, var(--yellow) 50%, var(--teal) 100%);
            opacity: 0.6;
        }

        /* Wrong Game Button */
        .wrong-game-row {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
        }

        .wrong-game-btn {
            background: rgba(255,70,154,0.1);
            border: 1px solid var(--pink);
            color: var(--pink);
            padding: 6px 16px;
            font-family: 'Bebas Neue', cursive;
            font-size: 12px;
            letter-spacing: 2px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .wrong-game-btn:active {
            background: var(--pink);
            color: #000;
        }

        /* Dart Display */
        .dart-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 12px 14px;
            background: rgba(0,0,0,0.4);
            border-radius: 14px;
            border: 1px solid var(--border-subtle);
            position: relative;
        }

        .dart-display::before {
            content: '';
            position: absolute;
            inset: 1px;
            border-radius: 13px;
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, transparent 50%);
            pointer-events: none;
        }

        .dart-slot {
            min-width: 70px;
            padding: 10px 12px;
            background: rgba(255,255,255,0.03);
            border: 2px solid var(--border-medium);
            border-radius: 10px;
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            letter-spacing: 1px;
            color: var(--text-muted);
            text-align: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dart-slot.filled {
            background: linear-gradient(180deg, var(--pink) 0%, var(--pink-dark) 100%);
            border-color: var(--pink-light);
            color: #fff;
            box-shadow: 0 0 25px var(--pink-glow), inset 0 1px 0 rgba(255,255,255,0.3);
            transform: scale(1.02);
        }

        .marks-total {
            margin-left: 12px;
            text-align: center;
            padding: 8px 14px;
            background: rgba(253,216,53,0.08);
            border-radius: 12px;
            border: 1px solid rgba(253,216,53,0.2);
        }

        .marks-total .value {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: var(--yellow);
            text-shadow: 0 0 20px var(--yellow-glow);
            line-height: 1;
        }

        .marks-total .label {
            font-size: 9px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 2px;
        }

        /* Action Buttons */
        .action-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .action-btn {
            padding: 18px 8px;
            border: none;
            border-radius: 10px;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 2px;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.4);
            transition: all 0.1s ease;
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, transparent 100%);
            pointer-events: none;
        }

        .action-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.4);
        }

        .action-btn.undo {
            background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);
            color: #fff;
        }

        .action-btn.miss {
            background: linear-gradient(180deg, #ef4444 0%, #b91c1c 100%);
            color: #fff;
        }

        .action-btn.clear {
            background: linear-gradient(180deg, var(--yellow) 0%, var(--yellow-dark) 100%);
            color: #000;
        }

        .action-btn.next {
            background: linear-gradient(180deg, #22c55e 0%, #15803d 100%);
            color: #fff;
            font-size: 20px;
            letter-spacing: 3px;
        }

        /* Exit Button */
        .exit-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 7px 12px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 6px;
            color: rgba(255,255,255,0.6);
            font-family: 'Bebas Neue', cursive;
            font-size: 12px;
            letter-spacing: 2px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.2s ease;
            backdrop-filter: blur(8px);
        }

        .exit-btn:hover, .exit-btn:active {
            background: rgba(255,70,154,0.2);
            border-color: var(--pink);
            color: var(--pink);
        }

        /* ========== MODALS ========== */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(5,5,16,0.95);
            backdrop-filter: blur(12px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-mid) 100%);
            border: 2px solid var(--pink);
            border-radius: 20px;
            padding: 28px;
            max-width: 380px;
            width: 100%;
            text-align: center;
            box-shadow:
                0 0 100px var(--pink-glow),
                0 30px 60px rgba(0,0,0,0.5);
            position: relative;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 15%;
            right: 15%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--pink-light), transparent);
        }

        .modal-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--yellow);
            text-shadow: 0 0 30px var(--yellow-glow);
            letter-spacing: 3px;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-family: 'Rajdhani', sans-serif;
            font-size: 22px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        .modal-stats {
            background: rgba(0,0,0,0.35);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            text-align: left;
            border: 1px solid var(--border-subtle);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 14px;
            font-weight: 600;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-row .val {
            color: var(--yellow);
            font-family: 'JetBrains Mono', monospace;
        }

        .modal-btn {
            padding: 14px 28px;
            margin: 5px;
            border: none;
            border-radius: 10px;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 2px;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.35);
            transition: all 0.1s ease;
            position: relative;
            overflow: hidden;
        }

        .modal-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
            pointer-events: none;
        }

        .modal-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.35);
        }

        .modal-btn.primary {
            background: linear-gradient(180deg, #22c55e 0%, #15803d 100%);
            color: #fff;
        }

        .modal-btn.secondary {
            background: linear-gradient(180deg, #52525b 0%, #3f3f46 100%);
            color: #fff;
        }

        .game-select-btn {
            background: linear-gradient(180deg, var(--bg-card) 0%, var(--bg-mid) 100%);
            border: 2px solid var(--teal);
            border-radius: 10px;
            padding: 14px 20px;
            color: var(--teal);
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .game-select-btn:hover, .game-select-btn:active {
            background: var(--teal);
            color: #000;
        }

        /* Scrollbar */
        .cricket-board::-webkit-scrollbar {
            width: 4px;
        }

        .cricket-board::-webkit-scrollbar-track {
            background: transparent;
        }

        .cricket-board::-webkit-scrollbar-thumb {
            background: var(--pink);
            border-radius: 2px;
        }

        /* Mark Animation */
        @keyframes markPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .marks-cell.done .mark-closed {
            animation: markPop 0.25s ease-out;
        }

        /* Darts Out Selector */
        .darts-select {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
        }

        .dart-count-btn {
            background: rgba(0,0,0,0.4);
            border: 3px solid var(--border-medium);
            color: var(--text-light);
            width: 70px;
            height: 70px;
            border-radius: 12px;
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
        }

        .dart-count-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
        }

        .dart-count-btn:active {
            background: linear-gradient(180deg, var(--yellow) 0%, var(--yellow-dark) 100%);
            border-color: var(--yellow-light);
            color: #000;
            transform: scale(0.95);
        }

        .dart-count-btn:disabled {
            background: rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.15);
            cursor: not-allowed;
            transform: none;
        }

        /* Setup Screen Styles */
        .setup-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-deep) 100%);
            overflow-y: auto;
            z-index: 2000;
            padding: 20px;
        }
        .setup-screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .setup-container {
            background: var(--bg-card);
            border: 2px solid var(--pink);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            margin: 20px auto;
            box-shadow: 0 0 60px rgba(255,70,154,0.2);
        }
        .setup-header {
            text-align: center;
            margin-bottom: 24px;
        }
        .setup-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: var(--pink);
            text-shadow: 0 0 20px var(--pink-glow);
            margin-bottom: 8px;
            letter-spacing: 3px;
        }
        .setup-subtitle {
            font-size: 14px;
            color: var(--text-muted);
            letter-spacing: 1px;
        }
        .setup-section {
            margin-bottom: 20px;
        }
        .setup-section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--yellow);
            letter-spacing: 2px;
            margin-bottom: 10px;
            border-bottom: 2px solid rgba(253,216,53,0.3);
            padding-bottom: 4px;
        }
        .setup-form-group {
            margin-bottom: 14px;
        }
        .setup-label {
            display: block;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .setup-input {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 16px;
            font-weight: 600;
        }
        .setup-input:focus {
            outline: none;
            border-color: var(--pink);
            background: rgba(255,70,154,0.1);
        }
        .setup-input::placeholder {
            color: var(--text-muted);
        }
        .setup-select {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .setup-select:focus {
            outline: none;
            border-color: var(--pink);
        }
        .setup-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .setup-toggle-group {
            display: flex;
            gap: 8px;
        }
        .setup-toggle-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .setup-toggle-btn:hover {
            background: rgba(255,255,255,0.12);
        }
        .setup-toggle-btn.active {
            background: var(--pink);
            border-color: var(--pink);
            color: white;
        }
        .setup-start-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(180deg, var(--yellow) 0%, var(--yellow-dark) 100%);
            color: #000;
            border: none;
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            letter-spacing: 3px;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(253,216,53,0.3);
            transition: all 0.1s;
            margin-top: 10px;
        }
        .setup-start-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 10px rgba(253,216,53,0.3);
        }
        .setup-back-btn {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: var(--text-light);
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 2px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 480px) {
            /* Cricket row - adjust grid for narrow screens */
            .cricket-row {
                grid-template-columns: 32px 1fr 40px 70px 40px 1fr 32px;
                gap: 3px;
            }

            /* Scoreboard header - smaller center column */
            .scoreboard {
                grid-template-columns: 1fr 80px 1fr;
            }

            /* Team panels */
            .team-panel {
                padding: 12px 8px 14px;
            }

            .team-name {
                font-size: 14px;
                letter-spacing: 2px;
            }

            /* Score display */
            .team-score {
                font-size: 36px;
            }

            /* Marks cell - smaller on mobile */
            .marks-cell {
                font-size: 42px;
                min-height: 48px;
            }

            /* Points cell */
            .points-cell {
                font-size: 12px;
            }

            /* Target number */
            .target-number {
                font-size: 18px;
                min-width: 50px;
            }

            /* Modifier buttons */
            .mod-btn {
                padding: 12px;
                font-size: 22px;
            }

            /* Target buttons */
            .target-btn {
                padding: 10px;
                min-height: 44px;
            }

            /* Action buttons */
            .action-btn {
                padding: 14px 8px;
                font-size: 16px;
            }

            /* Exit button */
            .exit-btn {
                padding: 5px 12px;
                font-size: 12px;
            }
        }

        @media (max-width: 360px) {
            /* Very narrow phones */
            .cricket-row {
                grid-template-columns: 28px 1fr 34px 60px 34px 1fr 28px;
                gap: 2px;
            }

            .scoreboard {
                grid-template-columns: 1fr 60px 1fr;
            }

            .team-score {
                font-size: 30px;
            }

            .marks-cell {
                font-size: 36px;
                min-height: 42px;
            }

            .target-number {
                font-size: 16px;
                min-width: 44px;
            }

            .mod-btn {
                padding: 10px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- Offline Banner -->
    <div class="offline-banner" id="offlineBanner">OFFLINE - Game will sync when connected</div>

    <button class="exit-btn" onclick="exitGame()">EXIT</button>

    <!-- Casual Setup Screen -->
    <div class="setup-screen" id="setupScreen">
        <div class="setup-container">
            <div class="setup-header">
                <div class="setup-title">CRICKET SCORER</div>
                <div class="setup-subtitle">CASUAL GAME SETUP</div>
            </div>

            <!-- Players Section -->
            <div class="setup-section">
                <div class="setup-section-title">PLAYERS</div>
                <div class="setup-grid-2">
                    <div class="setup-form-group">
                        <label class="setup-label">Player 1</label>
                        <input type="text" id="setupPlayer1" class="setup-input" placeholder="Player 1">
                    </div>
                    <div class="setup-form-group">
                        <label class="setup-label">Player 2</label>
                        <input type="text" id="setupPlayer2" class="setup-input" placeholder="Player 2">
                    </div>
                </div>
            </div>

            <!-- Match Format Section -->
            <div class="setup-section">
                <div class="setup-section-title">MATCH FORMAT</div>
                <div class="setup-form-group">
                    <label class="setup-label">Best of (Legs)</label>
                    <select id="setupLegs" class="setup-select">
                        <option value="1">1 Leg</option>
                        <option value="3" selected>3 Legs</option>
                        <option value="5">5 Legs</option>
                        <option value="7">7 Legs</option>
                        <option value="9">9 Legs</option>
                    </select>
                </div>
            </div>

            <!-- Starting Rules Section -->
            <div class="setup-section">
                <div class="setup-section-title">WHO STARTS FIRST?</div>
                <div class="setup-toggle-group" style="flex-direction: column; gap: 8px;">
                    <button class="setup-toggle-btn active" onclick="setSetupStarter('cork')">Cork for it</button>
                    <button class="setup-toggle-btn" onclick="setSetupStarter('player1')">Player 1 starts</button>
                    <button class="setup-toggle-btn" onclick="setSetupStarter('player2')">Player 2 starts</button>
                    <button class="setup-toggle-btn" onclick="setSetupStarter('alternate')">Alternate (loser starts)</button>
                </div>
            </div>

            <button class="setup-start-btn" onclick="startCasualGame()">START GAME</button>
            <button class="setup-back-btn" onclick="window.location.href='/pages/game-setup.html'">BACK TO GAME SETUP</button>
        </div>
    </div>

    <!-- Header Scoreboard -->
    <div class="scoreboard">
        <div class="team-panel home active" id="headerHome">
            <div class="team-name" id="homeName">Home</div>
            <div class="team-score" id="homeScore">0</div>
            <div class="team-stats">
                <span class="stat-item" title="This Leg">Leg: <span class="val" id="homeLegMPR">0.00</span></span>
                <span class="stat-item" title="Overall Match">MPR: <span class="val" id="homeMPR">0.00</span></span>
                <span class="stat-item">Legs: <span class="val" id="homeLegs">0</span></span>
            </div>
        </div>
        <div class="round-display">
            <div class="round-num" id="roundNum">1</div>
            <div class="round-label">Round</div>
        </div>
        <div class="team-panel away" id="headerAway">
            <div class="team-name" id="awayName">Away</div>
            <div class="team-score" id="awayScore">0</div>
            <div class="team-stats">
                <span class="stat-item" title="This Leg">Leg: <span class="val" id="awayLegMPR">0.00</span></span>
                <span class="stat-item" title="Overall Match">MPR: <span class="val" id="awayMPR">0.00</span></span>
                <span class="stat-item">Legs: <span class="val" id="awayLegs">0</span></span>
            </div>
        </div>
    </div>

    <!-- Cricket Board -->
    <div class="cricket-board" id="cricketBoard">
        <!-- Rows generated by JS -->
    </div>

    <!-- Control Bar -->
    <div class="control-bar">
        <!-- Wrong Game Button Row -->
        <div class="wrong-game-row" id="wrongGameRow" style="display: none;">
            <button class="wrong-game-btn" onclick="showGameSelector('current')">WRONG GAME?</button>
        </div>
        <!-- Dart Display -->
        <div class="dart-display">
            <div class="dart-slot" id="dart0">-</div>
            <div class="dart-slot" id="dart1">-</div>
            <div class="dart-slot" id="dart2">-</div>
            <div class="marks-total">
                <div class="value" id="turnMarks">0</div>
                <div class="label">Marks</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-row">
            <button class="action-btn undo" onclick="undoDart()">UNDO</button>
            <button class="action-btn miss" onclick="addMiss()">MISS</button>
            <button class="action-btn clear" onclick="clearTurn()">CLEAR</button>
            <button class="action-btn next" onclick="nextPlayer()">NEXT</button>
        </div>
    </div>

    <!-- Leg Complete Modal -->
    <div class="modal" id="legModal">
        <div class="modal-content">
            <div class="modal-title">LEG COMPLETE!</div>
            <div class="modal-subtitle" id="legWinnerText">Player Wins Leg!</div>
            <div class="modal-stats" id="legStats"></div>
            <div id="nextGameInfo" style="display: none; margin: 16px 0; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 6px; letter-spacing: 2px;">NEXT GAME</div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <span id="nextGameLabel" style="font-family: 'Bebas Neue', cursive; font-size: 26px; color: var(--teal);"></span>
                    <button onclick="showGameSelector()" style="background: var(--yellow); color: #000; border: none; padding: 6px 12px; font-family: 'Bebas Neue', cursive; font-size: 12px; letter-spacing: 1px; border-radius: 6px; cursor: pointer;">CHANGE</button>
                </div>
            </div>
            <button class="modal-btn primary" onclick="nextLeg()">NEXT LEG</button>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div class="modal" id="winModal">
        <div class="modal-content">
            <div class="modal-title">GAME OVER!</div>
            <div class="modal-subtitle" id="winnerText">Player Wins!</div>
            <div class="modal-stats" id="winStats"></div>
            <button class="modal-btn primary" onclick="saveAndExit()">SAVE RESULT</button>
            <button class="modal-btn secondary" onclick="newGame()" id="playAgainBtn">PLAY AGAIN</button>
        </div>
    </div>

    <!-- Starter Modal (Cork or Ready) -->
    <div class="modal" id="starterModal">
        <div class="modal-content" style="max-width: 380px;">
            <div id="starterLegInfo" style="margin-bottom: 16px; font-size: 13px; opacity: 0.7; letter-spacing: 3px;">LEG 1</div>

            <!-- Cork Ready Phase -->
            <div id="corkReadyPhase">
                <div class="modal-title" style="font-size: 32px;">READY TO CORK?</div>
                <div style="margin: 24px 0;">
                    <button class="modal-btn primary" onclick="startCorkShuffle()" style="width: 100%; font-size: 22px; padding: 18px;">YES</button>
                </div>
            </div>

            <!-- Cork Shuffle Phase -->
            <div id="corkShufflePhase" style="display: none;">
                <div id="shuffleName" style="font-size: 48px; font-family: 'Bebas Neue', cursive; color: var(--yellow); padding: 30px 0;"></div>
            </div>

            <!-- Throws First Phase (shows who throws at bull first) -->
            <div id="throwsFirstPhase" style="display: none;">
                <div id="throwsFirstName" style="font-size: 44px; font-family: 'Bebas Neue', cursive; margin-bottom: 8px;"></div>
                <div style="font-size: 18px; opacity: 0.7; margin-bottom: 24px; letter-spacing: 1px;">THROWS FIRST</div>
                <button class="modal-btn primary" onclick="showWhoGotIt()" style="width: 100%; font-size: 22px; padding: 18px;">OK</button>
            </div>

            <!-- Who Got It Phase -->
            <div id="whoGotItPhase" style="display: none;">
                <div class="modal-title" style="font-size: 28px; margin-bottom: 20px;">WHO GOT IT?</div>
                <div style="display: flex; gap: 12px;">
                    <button class="modal-btn" onclick="corkWinner(0)" id="corkHomeBtn" style="flex: 1; background: linear-gradient(180deg, var(--pink) 0%, var(--pink-dark) 100%); font-size: 18px; padding: 20px 12px;"></button>
                    <button class="modal-btn" onclick="corkWinner(1)" id="corkAwayBtn" style="flex: 1; background: linear-gradient(180deg, var(--teal) 0%, var(--teal-dark) 100%); color: #000; font-size: 18px; padding: 20px 12px;"></button>
                </div>
            </div>

            <!-- Choose First or Second Phase -->
            <div id="chooseOrderPhase" style="display: none;">
                <div style="font-size: 14px; opacity: 0.7; margin-bottom: 8px; letter-spacing: 2px;">CORK WINNER</div>
                <div id="chooseOrderWinner" style="font-size: 32px; font-family: 'Bebas Neue', cursive; color: var(--yellow); margin-bottom: 16px;"></div>
                <div style="font-size: 18px; margin-bottom: 20px;">CHOOSE YOUR OPTION</div>
                <div style="display: flex; gap: 12px;">
                    <button class="modal-btn primary" onclick="chooseThrowOrder('first')" style="flex: 1; padding: 20px 12px; font-size: 18px;">
                        THROW FIRST
                    </button>
                    <button class="modal-btn" onclick="chooseThrowOrder('second')" style="flex: 1; padding: 20px 12px; font-size: 18px; background: rgba(255,255,255,0.1);">
                        THROW SECOND
                    </button>
                </div>
            </div>

            <!-- Starter Ready Phase -->
            <div id="starterReadyPhase" style="display: none;">
                <div id="starterName" style="font-size: 44px; font-family: 'Bebas Neue', cursive; margin-bottom: 8px;"></div>
                <div style="font-size: 18px; opacity: 0.7; margin-bottom: 24px; letter-spacing: 1px;">TO START, READY?</div>
                <button class="modal-btn primary" onclick="confirmStarter()" style="width: 100%; font-size: 22px; padding: 18px;">OK</button>
            </div>
        </div>
    </div>

    <!-- Darts Out Modal -->
    <div class="modal" id="dartsModal">
        <div class="modal-content">
            <div class="modal-title">CLOSED OUT!</div>
            <div class="modal-subtitle">How many darts used?</div>
            <div class="darts-select">
                <button class="dart-count-btn" id="dartBtn1" onclick="confirmWinDarts(1)">1</button>
                <button class="dart-count-btn" id="dartBtn2" onclick="confirmWinDarts(2)">2</button>
                <button class="dart-count-btn" id="dartBtn3" onclick="confirmWinDarts(3)">3</button>
            </div>
        </div>
    </div>

    <!-- Game Selector Modal -->
    <div class="modal" id="gameSelectorModal">
        <div class="modal-content" style="max-width: 340px;">
            <div class="modal-title" id="gameSelectorTitle">SELECT GAME</div>
            <div style="display: flex; flex-direction: column; gap: 10px; margin: 20px 0;">
                <button class="game-select-btn" onclick="selectNextGame('501')">501</button>
                <button class="game-select-btn" onclick="selectNextGame('301')">301</button>
                <button class="game-select-btn" onclick="selectNextGame('cricket')">CRICKET</button>
                <button class="game-select-btn" onclick="selectNextGame('x01')">CUSTOM X01</button>
            </div>
            <div id="x01Options" style="display: none; margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <label style="font-size: 11px; color: var(--text-muted); letter-spacing: 1px;">SCORE</label>
                        <input type="number" id="x01ScoreInput" value="501" min="101" max="1001" step="100"
                            style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid var(--yellow); border-radius: 8px; padding: 10px; color: white; font-family: 'Bebas Neue', cursive; font-size: 20px; text-align: center;">
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label style="font-size: 11px; color: var(--text-muted); letter-spacing: 1px;">IN</label>
                        <select id="x01InRule" style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; color: white; font-size: 14px;">
                            <option value="open">Open</option>
                            <option value="double">Double</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 11px; color: var(--text-muted); letter-spacing: 1px;">OUT</label>
                        <select id="x01OutRule" style="width: 100%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; color: white; font-size: 14px;">
                            <option value="double">Double</option>
                            <option value="open">Open</option>
                        </select>
                    </div>
                </div>
                <button onclick="confirmX01Selection()" style="width: 100%; margin-top: 15px; background: var(--teal); border: none; border-radius: 8px; padding: 12px; color: #000; font-family: 'Bebas Neue', cursive; font-size: 18px; letter-spacing: 1px; cursor: pointer;">CONFIRM</button>
            </div>
            <button class="modal-btn secondary" onclick="closeGameSelector()">CANCEL</button>
        </div>
    </div>

    <!-- Match Complete Modal -->
    <div class="modal" id="matchCompleteModal">
        <div class="modal-content" style="max-width: 440px; border-color: var(--yellow);">
            <div style="font-size: 64px; margin-bottom: 8px;">üèÜ</div>
            <div class="modal-title" style="font-size: 36px; margin-bottom: 16px;">MATCH COMPLETE!</div>

            <!-- Score Display -->
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin: 24px 0;">
                <div style="text-align: center; flex: 1;">
                    <div id="matchCompleteHomeName" style="font-size: 14px; color: var(--pink); letter-spacing: 1px; margin-bottom: 4px;">HOME</div>
                    <div id="matchCompleteHomeScore" style="font-size: 72px; font-family: 'Bebas Neue', cursive; line-height: 1;">0</div>
                </div>
                <div style="font-size: 28px; color: var(--text-muted);">-</div>
                <div style="text-align: center; flex: 1;">
                    <div id="matchCompleteAwayName" style="font-size: 14px; color: var(--teal); letter-spacing: 1px; margin-bottom: 4px;">AWAY</div>
                    <div id="matchCompleteAwayScore" style="font-size: 72px; font-family: 'Bebas Neue', cursive; line-height: 1;">0</div>
                </div>
            </div>

            <!-- Winner Announcement -->
            <div id="matchCompleteWinner" style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--yellow); letter-spacing: 2px; margin: 16px 0;">WINNER WINS!</div>

            <!-- Key Stats Summary -->
            <div id="matchCompleteStats" class="modal-stats" style="margin: 20px 0;"></div>

            <!-- Buttons -->
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <button class="modal-btn" onclick="viewMatchReport()" style="width: 100%;">VIEW MATCH REPORT</button>
                <button class="modal-btn secondary" onclick="backToHub()" style="width: 100%;">BACK TO HUB</button>
            </div>
        </div>
    </div>

<script type="module">
import { callFunction, showLoading, hideLoading } from '/js/firebase-config.js';
import { callWithQueue, setupOfflineQueue } from '/js/offline-storage.js';

// Setup offline queue for automatic retry
setupOfflineQueue(callFunction);

// Offline detection
function showOfflineBanner() {
    document.getElementById('offlineBanner')?.classList.add('visible');
}
function hideOfflineBanner() {
    document.getElementById('offlineBanner')?.classList.remove('visible');
}
window.addEventListener('online', hideOfflineBanner);
window.addEventListener('offline', showOfflineBanner);
// Check initial state
if (!navigator.onLine) showOfflineBanner();

// URL Parameters
const params = new URLSearchParams(window.location.search);
const leagueId = params.get('league_id');
const matchId = params.get('match_id');
const tournamentId = params.get('tournament_id'); // Tournament support
const tournamentMatchId = params.get('tournament_match_id'); // Tournament match ID
const gameIndex = parseInt(params.get('game_index') || '0'); // Index in games array
const gameNumber = parseInt(params.get('game_number') || '1'); // Display number (1-based)
const adminPin = params.get('admin_pin') || '';
const fromMatch = params.get('from_match') === 'true';
let isCasual = params.get('casual') === 'true';
const totalGames = parseInt(params.get('total_games') || '0');
const homeTeamName = decodeURIComponent(params.get('home_team_name') || 'Home');
const awayTeamName = decodeURIComponent(params.get('away_team_name') || 'Away');

let homePlayers = [], awayPlayers = [];
try { homePlayers = JSON.parse(params.get('home_players') || '[]'); } catch(e) {}
try { awayPlayers = JSON.parse(params.get('away_players') || '[]'); } catch(e) {}

const TARGETS = [20, 19, 18, 17, 16, 15, 'BULL'];
const LEGS_TO_WIN = parseInt(params.get('legs_to_win') || '2');
const practiceMode = params.get('practice_mode') || null;
const isChicago = params.get('chicago') === 'true';
const chicagoGame = parseInt(params.get('chicago_game') || '0');
const isMixedGame = params.get('mixed') === 'true';
const mixedLegIndex = parseInt(params.get('mixed_leg') || '0');
const useCork = params.get('cork') !== 'false';
const corkRule = params.get('cork_rule') || 'alternate_cork_first_deciding';
const corkOrder = params.get('cork_order') || 'random';
const isVerificationMode = params.get('verification_mode') === 'true';

// Cork's Choice fields (when redirected from doubles choice game)
const corkChoice = params.get('cork_choice') || null;
const corkWinnerSide = params.get('cork_winner') || null;
let lastLegWinner = null;
let lastLegStarter = null;

// Fallback bot config for bots without cricket_skills (legacy support)
const BOT_CONFIG_FALLBACK = {
    easy:   { miss_pct: 40, triple_bull_pct: 5, pct_5_mark: 5, pct_7_mark: 1, pct_9_mark: 0 },
    medium: { miss_pct: 25, triple_bull_pct: 15, pct_5_mark: 20, pct_7_mark: 8, pct_9_mark: 2 },
    league: { miss_pct: 20, triple_bull_pct: 20, pct_5_mark: 28, pct_7_mark: 12, pct_9_mark: 4 },
    hard:   { miss_pct: 15, triple_bull_pct: 25, pct_5_mark: 35, pct_7_mark: 18, pct_9_mark: 5 },
    pro:    { miss_pct: 8, triple_bull_pct: 40, pct_5_mark: 55, pct_7_mark: 35, pct_9_mark: 12 }
};

// Check if away player is a bot
function isAwayBot() {
    return (practiceMode && awayPlayers[0]?.is_bot) || awayPlayers[0]?.isBot;
}

// Check if home player is a bot
function isHomeBot() {
    return homePlayers[0]?.isBot;
}

// Check if current active player is a bot
function isCurrentPlayerBot() {
    return activePlayer === 0 ? isHomeBot() : isAwayBot();
}

// Get bot skills for cricket - uses actual cricket_skills if available
function getBotCricketSkills(playerIndex) {
    const playerList = playerIndex === 0 ? homePlayers : awayPlayers;
    const bot = playerList[0];

    // If bot has actual cricket_skills from database, use them
    if (bot?.cricket_skills) {
        const skills = bot.cricket_skills;
        return {
            miss_pct: (skills.miss_pct ?? 25) / 100,
            triple_bull_pct: (skills.triple_bull_pct ?? 15) / 100,
            pct_5_mark: (skills.pct_5_mark_plus ?? 20) / 100,
            pct_7_mark: (skills.pct_7_mark_plus ?? 8) / 100,
            pct_9_mark: (skills.pct_9_mark_plus ?? 2) / 100
        };
    }

    // Fallback to difficulty-based config for legacy bots
    const difficulty = bot?.botDifficulty || bot?.bot_level || 'medium';
    const fallback = BOT_CONFIG_FALLBACK[difficulty] || BOT_CONFIG_FALLBACK.medium;
    return {
        miss_pct: fallback.miss_pct / 100,
        triple_bull_pct: fallback.triple_bull_pct / 100,
        pct_5_mark: fallback.pct_5_mark / 100,
        pct_7_mark: fallback.pct_7_mark / 100,
        pct_9_mark: fallback.pct_9_mark / 100
    };
}

// Bot plays its turn in cricket using actual cricket_skills
let botPlaying = false;

function botPlay() {
    if (!isCurrentPlayerBot()) return;
    if (botPlaying) return;
    botPlaying = true;

    const skills = getBotCricketSkills(activePlayer);
    const isBotVsBot = isHomeBot() && isAwayBot();
    const delay = isBotVsBot ? (300 + Math.random() * 200) : (600 + Math.random() * 400);

    setTimeout(() => {
        const botPlayer = players[activePlayer];
        const opponent = players[1 - activePlayer];

        // Determine total marks this round based on skill probabilities
        let totalMarks;
        const roll = Math.random();

        if (roll < skills.pct_9_mark) {
            totalMarks = 9; // 9-mark round (max)
        } else if (roll < skills.pct_9_mark + skills.pct_7_mark) {
            totalMarks = 7 + Math.floor(Math.random() * 2); // 7-8 marks
        } else if (roll < skills.pct_9_mark + skills.pct_7_mark + skills.pct_5_mark) {
            totalMarks = 5 + Math.floor(Math.random() * 2); // 5-6 marks
        } else {
            // Normal round based on miss rate
            // Less misses = more marks on average
            const avgMarks = 3 * (1 - skills.miss_pct) * (1 + skills.triple_bull_pct);
            totalMarks = Math.round(avgMarks + (Math.random() - 0.5) * 2);
        }

        totalMarks = Math.max(0, Math.min(9, totalMarks));

        let marksToThrow = totalMarks;
        const openTargets = TARGETS.filter(t => botPlayer.marks[t] < 3 || opponent.marks[t] < 3);

        for (let dart = 0; dart < 3 && marksToThrow > 0; dart++) {
            let target = null;
            let mult = 1;

            // Find best target (prioritize closing)
            for (const t of openTargets) {
                if (botPlayer.marks[t] < 3) {
                    target = t;
                    break;
                }
            }

            // If all closed, point on opponent's open targets
            if (!target) {
                for (const t of TARGETS) {
                    if (botPlayer.marks[t] >= 3 && opponent.marks[t] < 3) {
                        target = t;
                        break;
                    }
                }
            }

            if (!target) target = openTargets[0] || 20;

            // Determine marks for this dart (1-3) based on skill
            let marksThisDart;
            if (Math.random() < skills.triple_bull_pct) {
                marksThisDart = 3; // Triple hit
            } else if (Math.random() < 0.4) {
                marksThisDart = 2; // Double
            } else {
                marksThisDart = 1; // Single
            }

            marksThisDart = Math.min(marksToThrow, marksThisDart);
            mult = marksThisDart;
            marksToThrow -= marksThisDart;

            addHit(target, mult);
        }

        botPlaying = false;
        const endDelay = isBotVsBot ? 150 : 300;
        setTimeout(() => {
            nextPlayer();
        }, endDelay);

    }, delay);
}

// Game State
let activePlayer = 0;
let currentDarts = [];
let turnHistory = [];
let leg = 1;
let gameStartTime = Date.now();
let pendingWin = null; // Store pending win state for darts selection

// DartConnect-compatible turn tracking per leg
let legTurnsHistory = []; // Array of all turns for each completed leg
let legFirstThrow = []; // Who threw first in each leg (0=home, 1=away)
let currentLegTurns = []; // All turns in current leg
let currentLegFirstThrow = null; // Who threw first in current leg

let currentLegStats = [
    {
        marks: 0, rounds: 0, score: 0, whiteHorse: 0, threeInBed: 0, finalDarts: 0,
        // DartConnect stats
        darts_thrown: 0, missed_darts: 0, triple_bull_darts: 0,
        five_mark_rounds: 0, six_mark_rounds: 0, seven_mark_rounds: 0, nine_mark_rounds: 0, eight_mark_rounds: 0,
        three_bulls: 0, four_bulls: 0, five_bulls: 0, six_bulls: 0, hat_tricks: 0,
        // NEW: High mark round, With/Against Darts
        high_mark_round: 0,
        threw_first: null
    },
    {
        marks: 0, rounds: 0, score: 0, whiteHorse: 0, threeInBed: 0, finalDarts: 0,
        // DartConnect stats
        darts_thrown: 0, missed_darts: 0, triple_bull_darts: 0,
        five_mark_rounds: 0, six_mark_rounds: 0, seven_mark_rounds: 0, nine_mark_rounds: 0, eight_mark_rounds: 0,
        three_bulls: 0, four_bulls: 0, five_bulls: 0, six_bulls: 0, hat_tricks: 0,
        // NEW: High mark round, With/Against Darts
        high_mark_round: 0,
        threw_first: null
    }
];

// Track per-leg data for comprehensive stats
let legStats = [[], []];

function resetCurrentLegStats() {
    currentLegStats = [
        {
            marks: 0, rounds: 0, score: 0, whiteHorse: 0, threeInBed: 0, finalDarts: 0,
            darts_thrown: 0, missed_darts: 0, triple_bull_darts: 0,
            five_mark_rounds: 0, six_mark_rounds: 0, seven_mark_rounds: 0, nine_mark_rounds: 0, eight_mark_rounds: 0,
            three_bulls: 0, four_bulls: 0, five_bulls: 0, six_bulls: 0, hat_tricks: 0,
            high_mark_round: 0, threw_first: null
        },
        {
            marks: 0, rounds: 0, score: 0, whiteHorse: 0, threeInBed: 0, finalDarts: 0,
            darts_thrown: 0, missed_darts: 0, triple_bull_darts: 0,
            five_mark_rounds: 0, six_mark_rounds: 0, seven_mark_rounds: 0, nine_mark_rounds: 0, eight_mark_rounds: 0,
            three_bulls: 0, four_bulls: 0, five_bulls: 0, six_bulls: 0, hat_tricks: 0,
            high_mark_round: 0, threw_first: null
        }
    ];
}

let allTimeStats = [
    { bestMPR: 0, fewestRounds: 999, whiteHorses: 0, threeInBeds: 0 },
    { bestMPR: 0, fewestRounds: 999, whiteHorses: 0, threeInBeds: 0 }
];

const players = [
    {
        name: homePlayers.map(p => p?.name || 'Home').join(' & ') || 'Home',
        score: 0,
        marks: { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, BULL: 0 },
        legs: 0,
        totalMarks: 0,
        totalRounds: 0,
        totalDarts: 0,
        // DartConnect stats
        missedDarts: 0, tripleBullDarts: 0,
        fiveMarkRounds: 0, sevenMarkRounds: 0, nineMarkRounds: 0, eightMarkRounds: 0,
        threeBulls: 0, fourBulls: 0, fiveBulls: 0, sixBulls: 0, hatTricks: 0
    },
    {
        name: awayPlayers.map(p => p?.name || 'Away').join(' & ') || 'Away',
        score: 0,
        marks: { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, BULL: 0 },
        legs: 0,
        totalMarks: 0,
        totalRounds: 0,
        totalDarts: 0,
        // DartConnect stats
        missedDarts: 0, tripleBullDarts: 0,
        fiveMarkRounds: 0, sevenMarkRounds: 0, nineMarkRounds: 0, eightMarkRounds: 0,
        threeBulls: 0, fourBulls: 0, fiveBulls: 0, sixBulls: 0, hatTricks: 0
    }
];

// Warn user before leaving with game in progress
window.onbeforeunload = function(e) {
    const gameStarted = (players[0].totalDarts > 0 || players[1].totalDarts > 0);
    const matchComplete = (players[0].legs >= LEGS_TO_WIN || players[1].legs >= LEGS_TO_WIN);
    if (gameStarted && !matchComplete && !pendingWin) {
        e.preventDefault();
        return "You have a game in progress. Are you sure you want to leave?";
    }
};

if (isMixedGame) {
    const homeLegsParam = parseInt(params.get('home_legs') || '0');
    const awayLegsParam = parseInt(params.get('away_legs') || '0');
    players[0].legs = homeLegsParam;
    players[1].legs = awayLegsParam;
}

function init() {
    document.getElementById('homeName').textContent = players[0].name;
    document.getElementById('awayName').textContent = players[1].name;
    renderBoard();
    updateDisplay();

    // Start live match tracking for league/tournament games
    if ((leagueId && matchId) || tournamentId) {
        (async () => {
            try {
                const scorerPin = localStorage.getItem('brdc_player_pin') || adminPin || matchPin;
                if (scorerPin) {
                    await callFunction('startLiveMatch', {
                        scorer_pin: scorerPin,
                        match_id: matchId || tournamentMatchId,
                        event_id: leagueId || tournamentId,
                        event_type: tournamentId ? 'tournament' : 'league',
                        match_data: {
                            event_name: homeTeamName + ' vs ' + awayTeamName,
                            game_type: 'cricket',
                            starting_score: 0,
                            race_to: legsToWin,
                            team1_name: homeTeamName,
                            team1_player_ids: homePlayers.map(p => p?.id).filter(Boolean),
                            team1_player_names: homePlayers.map(p => p?.name).filter(Boolean),
                            team2_name: awayTeamName,
                            team2_player_ids: awayPlayers.map(p => p?.id).filter(Boolean),
                            team2_player_names: awayPlayers.map(p => p?.name).filter(Boolean)
                        }
                    });
                }
            } catch (e) {
                console.warn('Failed to start live match tracking:', e);
            }
        })();
    }

    // Hide "Play Again" button for league/tournament games
    const playAgainBtn = document.getElementById('playAgainBtn');
    if (playAgainBtn && !isCasual) {
        playAgainBtn.style.display = 'none';
    }

    const homeIsBot = isHomeBot();
    const awayIsBot = isAwayBot();

    if (homeIsBot || awayIsBot) {
        if (homeIsBot && awayIsBot) {
            activePlayer = Math.random() < 0.5 ? 0 : 1;
        } else if (awayIsBot) {
            activePlayer = 0;
        } else {
            activePlayer = 1;
        }
        updateDisplay();

        if (isCurrentPlayerBot()) {
            setTimeout(() => botPlay(), 500);
        }
    } else {
        // If coming from doubles choice redirect, cork winner is already determined
        if (corkWinnerSide && corkChoice === 'cricket') {
            // Cork winner starts - set pendingStarter and show ready phase directly
            pendingStarter = corkWinnerSide === 'home' ? 0 : 1;
            setTimeout(() => {
                showStarterModal(false); // No cork needed - winner already determined
            }, 300);
        } else {
            const needsCork = useCork && (corkRule === 'cork_every_leg' || corkRule === 'alternate_cork_first_deciding' || corkRule === 'cork_first_leg') && corkRule !== 'home_first' && corkRule !== 'away_first';
            setTimeout(() => showStarterModal(needsCork), 300);
        }
    }
}

// Get mark symbol - Premium rendering
function getMarkSymbol(count) {
    if (count === 0) return '<span class="mark-symbol" style="opacity:0.25;">-</span>';
    if (count === 1) return '<span class="mark-symbol">/</span>';
    if (count === 2) return '<span class="mark-symbol">X</span>';
    return '<span class="mark-closed">X</span>';
}

const targetPoints = [
    { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, BULL: 0 },
    { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, BULL: 0 }
];

function renderBoard() {
    const board = document.getElementById('cricketBoard');
    let html = '';

    TARGETS.forEach(target => {
        const key = target === 'BULL' ? 'BULL' : target;
        const label = target === 'BULL' ? 'B' : target;
        const isBull = target === 'BULL';
        const bothClosed = players[0].marks[key] >= 3 && players[1].marks[key] >= 3;

        const homeMarks = players[0].marks[key];
        const awayMarks = players[1].marks[key];
        const homeClosed = homeMarks >= 3;
        const awayClosed = awayMarks >= 3;

        const homePts = targetPoints[0][key] || '';
        const awayPts = targetPoints[1][key] || '';

        html += `
            <div class="cricket-row ${bothClosed ? 'closed' : ''}" data-target="${key}">
                <div class="points-cell home">${homePts}</div>
                <div class="marks-cell home ${homeClosed ? 'done' : ''}">${getMarkSymbol(homeMarks)}</div>
                <button class="mod-btn" onclick="addHit('${key}', 2)" ${bothClosed ? 'disabled' : ''}><span>D</span></button>
                <button class="target-btn" onclick="addHit('${key}', 1)" ${bothClosed ? 'disabled' : ''}>${label}</button>
                <button class="mod-btn triple" onclick="addHit('${key}', 3)" ${bothClosed || isBull ? 'disabled' : ''} ${isBull ? 'style="visibility:hidden;"' : ''}><span>T</span></button>
                <div class="marks-cell away ${awayClosed ? 'done' : ''}">${getMarkSymbol(awayMarks)}</div>
                <div class="points-cell away">${awayPts}</div>
            </div>
        `;
    });

    board.innerHTML = html;
}

window.addHit = function(target, mult) {
    if (currentDarts.length >= 3) return;

    hideWrongGameBtn();

    const player = players[activePlayer];
    const opponent = players[1 - activePlayer];

    if (player.marks[target] >= 3 && opponent.marks[target] >= 3) return;

    const value = target === 'BULL' ? 25 : parseInt(target);

    let pointsScored = 0;

    const prevMarks = player.marks[target];
    const prevScore = player.score;
    const prevTargetPts = targetPoints[activePlayer][target];

    for (let i = 0; i < mult; i++) {
        if (player.marks[target] < 3) {
            player.marks[target]++;
        } else if (opponent.marks[target] < 3) {
            player.score += value;
            pointsScored += value;
            targetPoints[activePlayer][target] += value;
        }
    }

    let label = target === 'BULL' ? 'B' : target;
    if (mult === 2) label = 'D' + (target === 'BULL' ? 'B' : target);
    if (mult === 3) label = 'T' + target;

    currentDarts.push({
        target,
        mult,
        marksAdded: mult,
        pointsAdded: pointsScored,
        label,
        prevMarks,
        prevScore,
        prevTargetPts
    });

    renderBoard();
    updateDisplay();

    if (checkWin(activePlayer)) {
        // If bot wins, auto-confirm with darts thrown
        if (isCurrentPlayerBot()) {
            pendingWin = {
                player: activePlayer,
                dartsThrown: currentDarts.length
            };
            confirmWinDarts(currentDarts.length);
            return;
        }

        // Show darts modal to ask how many darts used
        pendingWin = {
            player: activePlayer,
            dartsThrown: currentDarts.length // How many darts thrown this turn so far
        };

        // Enable/disable dart buttons based on darts already thrown
        const minDarts = currentDarts.length; // At least this many were thrown
        document.getElementById('dartBtn1').disabled = minDarts > 1;
        document.getElementById('dartBtn2').disabled = minDarts > 2;
        document.getElementById('dartBtn3').disabled = false;

        document.getElementById('dartsModal').classList.add('active');
    }
};

window.confirmWinDarts = function(dartsUsed) {
    document.getElementById('dartsModal').classList.remove('active');

    if (!pendingWin) return;

    const player = players[pendingWin.player];

    // Calculate marks for this partial turn (up to the winning dart)
    const turnMarks = currentDarts.reduce((sum, d) => sum + d.marksAdded, 0);
    const turnPoints = currentDarts.reduce((sum, d) => sum + d.pointsAdded, 0);

    // Track who threw first if this is the first turn
    if (currentLegFirstThrow === null) {
        currentLegFirstThrow = pendingWin.player;
    }

    // Save winning turn to current leg turns
    currentLegTurns.push({
        player: pendingWin.player,
        playerName: player.name,
        darts: currentDarts.slice(0, dartsUsed).map(d => ({
            target: d.target,
            multiplier: d.multiplier,
            marksAdded: d.marksAdded,
            pointsAdded: d.pointsAdded
        })),
        totalMarks: turnMarks,
        totalPoints: turnPoints,
        round: Math.floor(currentLegTurns.filter(t => t.player === pendingWin.player).length) + 1,
        isWinningTurn: true
    });

    // Update stats with actual darts used
    player.totalMarks += turnMarks;
    player.totalRounds++;

    currentLegStats[pendingWin.player].marks += turnMarks;
    currentLegStats[pendingWin.player].rounds++;
    currentLegStats[pendingWin.player].score = player.score;

    // Store extra darts info for stats
    currentLegStats[pendingWin.player].finalDarts = dartsUsed;

    // Save leg stats for comprehensive tracking
    legStats[0].push({...currentLegStats[0]});
    legStats[1].push({...currentLegStats[1]});

    // Save turn history for this leg (DartConnect-compatible throws)
    legTurnsHistory.push([...currentLegTurns]);
    legFirstThrow.push(currentLegFirstThrow);

    player.legs++;
    lastLegWinner = pendingWin.player;
    lastLegStarter = lastLegStarter === null ? pendingWin.player : lastLegStarter;

    pendingWin = null;

    if (player.legs >= LEGS_TO_WIN) {
        showWinModal();
    } else {
        showLegModal();
    }
};

window.addMiss = function() {
    if (currentDarts.length >= 3) return;
    currentDarts.push({
        target: null,
        mult: 0,
        marksAdded: 0,
        pointsAdded: 0,
        label: 'MISS'
    });
    updateDisplay();
};

window.undoDart = function() {
    if (currentDarts.length === 0) {
        if (turnHistory.length === 0) return;

        const prevTurn = turnHistory.pop();
        activePlayer = prevTurn.player;
        currentDarts = prevTurn.darts;

        // Also remove from currentLegTurns (DartConnect tracking)
        if (currentLegTurns.length > 0) {
            currentLegTurns.pop();
        }

        players[activePlayer].totalMarks = prevTurn.totalMarks;
        players[activePlayer].totalRounds = prevTurn.totalRounds;

        // Restore leg stats (for correct MPR calculation)
        if (prevTurn.legStatsMarks !== undefined) {
            currentLegStats[activePlayer].marks = prevTurn.legStatsMarks;
            currentLegStats[activePlayer].rounds = prevTurn.legStatsRounds;
        }

        const player = players[activePlayer];
        const opponent = players[1 - activePlayer];

        const restoredTargets = new Set();
        let scoreRestored = false;

        for (const dart of currentDarts) {
            if (dart.target !== null) {
                if (!scoreRestored) {
                    player.score = dart.prevScore;
                    scoreRestored = true;
                }
                if (!restoredTargets.has(dart.target)) {
                    player.marks[dart.target] = dart.prevMarks;
                    targetPoints[activePlayer][dart.target] = dart.prevTargetPts;
                    restoredTargets.add(dart.target);
                }
            }
        }

        for (const dart of currentDarts) {
            if (dart.target !== null) {
                const value = dart.target === 'BULL' ? 25 : parseInt(dart.target);

                dart.prevMarks = player.marks[dart.target];
                dart.prevScore = player.score;
                dart.prevTargetPts = targetPoints[activePlayer][dart.target];

                let pointsScored = 0;
                for (let i = 0; i < dart.mult; i++) {
                    if (player.marks[dart.target] < 3) {
                        player.marks[dart.target]++;
                    } else if (opponent.marks[dart.target] < 3) {
                        player.score += value;
                        pointsScored += value;
                        targetPoints[activePlayer][dart.target] += value;
                    }
                }
                dart.marksAdded = dart.mult;
                dart.pointsAdded = pointsScored;
            }
        }

        renderBoard();
        updateDisplay();
        return;
    }

    const dart = currentDarts.pop();

    if (dart.target !== null) {
        const player = players[activePlayer];
        player.marks[dart.target] = dart.prevMarks;
        player.score = dart.prevScore;
        targetPoints[activePlayer][dart.target] = dart.prevTargetPts;
    }

    renderBoard();
    updateDisplay();
};

window.clearTurn = function() {
    while (currentDarts.length > 0) {
        undoDart();
    }
};

window.nextPlayer = function() {
    if (currentDarts.length === 0) return;

    // Track who threw first in this leg
    if (currentLegFirstThrow === null) {
        currentLegFirstThrow = activePlayer;
        // Set threw_first for with/against darts tracking
        currentLegStats[activePlayer].threw_first = true;
        currentLegStats[1 - activePlayer].threw_first = false;
    }

    // Calculate marks and points for this turn
    const turnMarks = currentDarts.reduce((sum, d) => sum + d.marksAdded, 0);
    const turnPoints = currentDarts.reduce((sum, d) => sum + d.pointsAdded, 0);

    // Save turn to current leg turns (for DartConnect-compatible throws)
    currentLegTurns.push({
        player: activePlayer,
        playerName: players[activePlayer].name,
        darts: currentDarts.map(d => ({
            target: d.target,
            multiplier: d.multiplier,
            marksAdded: d.marksAdded,
            pointsAdded: d.pointsAdded
        })),
        totalMarks: turnMarks,
        totalPoints: turnPoints,
        round: Math.floor(currentLegTurns.filter(t => t.player === activePlayer).length) + 1
    });

    turnHistory.push({
        player: activePlayer,
        darts: [...currentDarts],
        totalMarks: players[activePlayer].totalMarks,
        totalRounds: players[activePlayer].totalRounds,
        legStatsMarks: currentLegStats[activePlayer].marks,
        legStatsRounds: currentLegStats[activePlayer].rounds
    });
    if (turnHistory.length > 2) {
        turnHistory.shift();
    }

    endRound();
    activePlayer = 1 - activePlayer;
    currentDarts = [];

    renderBoard();
    updateDisplay();

    botPlaying = false;
    if (isCurrentPlayerBot()) {
        botPlay();
    }
};

function endRound() {
    const player = players[activePlayer];
    const turnMarks = currentDarts.reduce((sum, d) => sum + d.marksAdded, 0);
    const turnPoints = currentDarts.reduce((sum, d) => sum + d.pointsAdded, 0);
    player.totalMarks += turnMarks;
    player.totalRounds++;

    // Track darts thrown
    const dartsThrown = currentDarts.length || 3;
    player.totalDarts += dartsThrown;
    currentLegStats[activePlayer].darts_thrown += dartsThrown;

    currentLegStats[activePlayer].marks += turnMarks;
    currentLegStats[activePlayer].rounds++;
    currentLegStats[activePlayer].score = player.score;

    // DartConnect stats tracking
    // Missed darts (darts with no marks and no points)
    const missedDarts = currentDarts.filter(d => !d.marksAdded && !d.pointsAdded).length;
    player.missedDarts += missedDarts;
    currentLegStats[activePlayer].missed_darts += missedDarts;

    // Triple & Bull darts
    const tripleBullDarts = currentDarts.filter(d =>
        d.mult === 3 || (d.target === 'BULL' && d.mult >= 2)
    ).length;
    player.tripleBullDarts += tripleBullDarts;
    currentLegStats[activePlayer].triple_bull_darts += tripleBullDarts;

    // High mark rounds (5M+, 6M, 7M+, 8M, 9M)
    if (turnMarks >= 9) {
        player.nineMarkRounds++;
        currentLegStats[activePlayer].nine_mark_rounds++;
    } else if (turnMarks >= 8) {
        player.eightMarkRounds++;
        currentLegStats[activePlayer].eight_mark_rounds++;
    } else if (turnMarks >= 7) {
        player.sevenMarkRounds++;
        currentLegStats[activePlayer].seven_mark_rounds++;
    } else if (turnMarks >= 6) {
        // NEW: Track 6-mark rounds separately
        player.sixMarkRounds = (player.sixMarkRounds || 0) + 1;
        currentLegStats[activePlayer].six_mark_rounds++;
    } else if (turnMarks >= 5) {
        player.fiveMarkRounds++;
        currentLegStats[activePlayer].five_mark_rounds++;
    }

    // Track high mark round (highest marks in a single round this leg)
    if (turnMarks > currentLegStats[activePlayer].high_mark_round) {
        currentLegStats[activePlayer].high_mark_round = turnMarks;
    }

    // Bull counts this round
    const bullMarks = currentDarts.filter(d => d.target === 'BULL').reduce((sum, d) => sum + d.marksAdded, 0);
    if (bullMarks >= 6) {
        player.sixBulls++;
        currentLegStats[activePlayer].six_bulls++;
    } else if (bullMarks >= 5) {
        player.fiveBulls++;
        currentLegStats[activePlayer].five_bulls++;
    } else if (bullMarks >= 4) {
        player.fourBulls++;
        currentLegStats[activePlayer].four_bulls++;
    } else if (bullMarks >= 3) {
        player.threeBulls++;
        currentLegStats[activePlayer].three_bulls++;
    }

    // White horse (3 different triples in one turn)
    const triplesThisTurn = currentDarts.filter(d => d.mult === 3 && d.target !== 'BULL').map(d => d.target);
    const uniqueTriples = new Set(triplesThisTurn);
    if (uniqueTriples.size >= 3) {
        currentLegStats[activePlayer].whiteHorse++;
        allTimeStats[activePlayer].whiteHorses++;
    }

    // Three in a bed / Hat trick (3 of same number)
    const targetCounts = {};
    currentDarts.forEach(d => {
        if (d.target && d.mult === 3) {
            targetCounts[d.target] = (targetCounts[d.target] || 0) + 1;
        }
    });
    const hasThreeInBed = Object.values(targetCounts).some(count => count >= 3);
    if (hasThreeInBed) {
        currentLegStats[activePlayer].threeInBed++;
        currentLegStats[activePlayer].hat_tricks++;
        player.hatTricks++;
        allTimeStats[activePlayer].threeInBeds++;
    }
}

function checkWin(idx) {
    const player = players[idx];
    const opponent = players[1 - idx];

    const allClosed = TARGETS.every(t => {
        const key = t === 'BULL' ? 'BULL' : t;
        return player.marks[key] >= 3;
    });

    return allClosed && player.score >= opponent.score;
}

function updateDisplay() {
    document.getElementById('homeScore').textContent = players[0].score;
    document.getElementById('awayScore').textContent = players[1].score;

    // Overall MPR (all legs combined)
    const mpr0 = players[0].totalRounds > 0 ? (players[0].totalMarks / players[0].totalRounds).toFixed(2) : '0.00';
    const mpr1 = players[1].totalRounds > 0 ? (players[1].totalMarks / players[1].totalRounds).toFixed(2) : '0.00';
    document.getElementById('homeMPR').textContent = mpr0;
    document.getElementById('awayMPR').textContent = mpr1;

    // Leg MPR (current leg only)
    const legMpr0 = currentLegStats[0].rounds > 0 ? (currentLegStats[0].marks / currentLegStats[0].rounds).toFixed(2) : '0.00';
    const legMpr1 = currentLegStats[1].rounds > 0 ? (currentLegStats[1].marks / currentLegStats[1].rounds).toFixed(2) : '0.00';
    document.getElementById('homeLegMPR').textContent = legMpr0;
    document.getElementById('awayLegMPR').textContent = legMpr1;

    document.getElementById('homeLegs').textContent = players[0].legs;
    document.getElementById('awayLegs').textContent = players[1].legs;

    const round = Math.max(players[0].totalRounds, players[1].totalRounds) + 1;
    document.getElementById('roundNum').textContent = round;

    document.getElementById('headerHome').classList.toggle('active', activePlayer === 0);
    document.getElementById('headerAway').classList.toggle('active', activePlayer === 1);

    for (let i = 0; i < 3; i++) {
        const slot = document.getElementById('dart' + i);
        if (currentDarts[i]) {
            slot.textContent = currentDarts[i].label;
            slot.classList.add('filled');
        } else {
            slot.textContent = '-';
            slot.classList.remove('filled');
        }
    }

    const turnMarks = currentDarts.reduce((sum, d) => sum + d.marksAdded, 0);
    document.getElementById('turnMarks').textContent = turnMarks;
}

function showLegModal() {
    const winner = currentLegStats[activePlayer];
    const loser = currentLegStats[1 - activePlayer];
    const winnerPlayer = players[activePlayer];
    const loserPlayer = players[1 - activePlayer];

    const winnerMPR = winner.rounds > 0 ? (winner.marks / winner.rounds).toFixed(2) : '0.00';
    const loserMPR = loser.rounds > 0 ? (loser.marks / loser.rounds).toFixed(2) : '0.00';

    // Track winner's best leg stats
    if (parseFloat(winnerMPR) > allTimeStats[activePlayer].bestMPR) {
        allTimeStats[activePlayer].bestMPR = parseFloat(winnerMPR);
    }
    if (winner.rounds < allTimeStats[activePlayer].fewestRounds) {
        allTimeStats[activePlayer].fewestRounds = winner.rounds;
    }

    // Track loser's best leg stats too
    if (parseFloat(loserMPR) > allTimeStats[1 - activePlayer].bestMPR) {
        allTimeStats[1 - activePlayer].bestMPR = parseFloat(loserMPR);
    }
    if (loser.rounds < allTimeStats[1 - activePlayer].fewestRounds) {
        allTimeStats[1 - activePlayer].fewestRounds = loser.rounds;
    }

    const winnerColor = activePlayer === 0 ? 'var(--pink)' : 'var(--teal)';
    const loserColor = activePlayer === 0 ? 'var(--teal)' : 'var(--pink)';

    document.getElementById('legWinnerText').textContent = winnerPlayer.name + ' Wins Leg ' + leg + '!';
    document.getElementById('legStats').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 8px; font-size: 13px;">
            <div style="font-weight: 600; color: var(--text-muted);"></div>
            <div style="font-weight: 700; text-align: center; min-width: 55px; color: ${winnerColor}; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">${winnerPlayer.name.split(' ')[0]}</div>
            <div style="font-weight: 700; text-align: center; min-width: 55px; color: ${loserColor}; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">${loserPlayer.name.split(' ')[0]}</div>

            <div style="text-transform: uppercase; letter-spacing: 1px; font-size: 12px;">Score</div>
            <div style="text-align: center; color: var(--yellow); font-weight: 700; font-family: 'JetBrains Mono', monospace;">${winner.score}</div>
            <div style="text-align: center; opacity: 0.5; font-family: 'JetBrains Mono', monospace;">${loser.score}</div>

            <div style="text-transform: uppercase; letter-spacing: 1px; font-size: 12px;">MPR</div>
            <div style="text-align: center; color: var(--yellow); font-weight: 700; font-family: 'JetBrains Mono', monospace;">${winnerMPR}</div>
            <div style="text-align: center; opacity: 0.5; font-family: 'JetBrains Mono', monospace;">${loserMPR}</div>

            <div style="text-transform: uppercase; letter-spacing: 1px; font-size: 12px;">Rounds</div>
            <div style="text-align: center; color: var(--yellow); font-weight: 700; font-family: 'JetBrains Mono', monospace;">${winner.rounds}</div>
            <div style="text-align: center; opacity: 0.5; font-family: 'JetBrains Mono', monospace;">${loser.rounds}</div>

            <div style="text-transform: uppercase; letter-spacing: 1px; font-size: 12px;">Marks</div>
            <div style="text-align: center; font-family: 'JetBrains Mono', monospace;">${winner.marks}</div>
            <div style="text-align: center; opacity: 0.5; font-family: 'JetBrains Mono', monospace;">${loser.marks}</div>
        </div>
        <div style="margin-top: 16px; text-align: center; font-family: 'Bebas Neue', cursive;">
            <span style="color: ${winnerColor}; font-size: 32px;">${winnerPlayer.legs}</span>
            <span style="opacity: 0.3; margin: 0 12px; font-size: 20px;">-</span>
            <span style="color: ${loserColor}; font-size: 32px;">${loserPlayer.legs}</span>
        </div>
    `;

    const nextGameInfo = document.getElementById('nextGameInfo');
    if (isMixedGame) {
        const mixedConfig = JSON.parse(sessionStorage.getItem('mixedGameConfig') || '{}');
        const nextLegIndex = mixedLegIndex + 1;
        if (mixedConfig.legs && mixedConfig.legs[nextLegIndex]) {
            const nextLeg = mixedConfig.legs[nextLegIndex];
            document.getElementById('nextGameLabel').textContent = getGameLabel(nextLeg);
            nextGameInfo.style.display = 'block';
        } else {
            nextGameInfo.style.display = 'none';
        }
    } else {
        nextGameInfo.style.display = 'none';
    }

    document.getElementById('legModal').classList.add('active');
}

window.nextLeg = function() {
    document.getElementById('legModal').classList.remove('active');

    if (isMixedGame) {
        const mixedConfig = JSON.parse(sessionStorage.getItem('mixedGameConfig') || '{}');
        if (mixedConfig.legs && mixedConfig.legs.length > 0) {
            const nextLegIndex = mixedLegIndex + 1;

            mixedConfig.current_leg = nextLegIndex;
            mixedConfig.home_legs = players[0].legs;
            mixedConfig.away_legs = players[1].legs;
            sessionStorage.setItem('mixedGameConfig', JSON.stringify(mixedConfig));

            if (nextLegIndex < mixedConfig.legs.length) {
                const nextLeg = mixedConfig.legs[nextLegIndex];

                const newParams = new URLSearchParams();
                // Preserve league/match context for return navigation
                if (leagueId) newParams.set('league_id', leagueId);
                if (matchId) newParams.set('match_id', matchId);
                if (fromMatch) newParams.set('from_match', 'true');
                newParams.set('home_players', JSON.stringify(homePlayers));
                newParams.set('away_players', JSON.stringify(awayPlayers));
                newParams.set('casual', isCasual ? 'true' : 'false');
                newParams.set('mixed', 'true');
                newParams.set('mixed_leg', nextLegIndex.toString());
                newParams.set('legs_to_win', LEGS_TO_WIN.toString());
                newParams.set('home_legs', players[0].legs.toString());
                newParams.set('away_legs', players[1].legs.toString());

                if (useCork) {
                    newParams.set('cork', 'true');
                }

                if (nextLeg.type === 'cricket') {
                    window.location.href = `/pages/league-cricket.html?${newParams.toString()}`;
                } else {
                    const score = nextLeg.score || (nextLeg.type === '301' ? 301 : (nextLeg.type === '701' ? 701 : 501));
                    newParams.set('starting_score', score.toString());
                    newParams.set('in_rule', nextLeg.inRule || 'straight');
                    newParams.set('out_rule', nextLeg.outRule || 'double');
                    newParams.set('checkout', nextLeg.outRule || 'double');
                    window.location.href = `/pages/league-501.html?${newParams.toString()}`;
                }
                return;
            }
        }
    }

    leg++;
    players.forEach(p => {
        p.score = 0;
        p.marks = { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, BULL: 0 };
    });
    targetPoints[0] = { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, BULL: 0 };
    targetPoints[1] = { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, BULL: 0 };
    resetCurrentLegStats();

    // Reset turn tracking for new leg
    currentLegTurns = [];
    currentLegFirstThrow = null;

    const homeIsBot = isHomeBot();
    const awayIsBot = isAwayBot();

    if (homeIsBot || awayIsBot) {
        if (homeIsBot && awayIsBot) {
            activePlayer = leg % 2 === 0 ? 1 : 0;
        } else {
            activePlayer = awayIsBot ? 0 : 1;
        }
        lastLegStarter = activePlayer;

        currentDarts = [];
        turnHistory = [];
        renderBoard();
        updateDisplay();

        botPlaying = false;
        if (isCurrentPlayerBot()) {
            setTimeout(() => botPlay(), 500);
        }
    } else {
        currentDarts = [];
        turnHistory = [];
        renderBoard();

        const isDecidingLeg = players[0].legs === LEGS_TO_WIN - 1 && players[1].legs === LEGS_TO_WIN - 1;
        const needsCork = useCork && (corkRule === 'cork_every_leg' || ((corkRule === 'alternate_cork_first_deciding' || corkRule === 'cork_first_leg') && isDecidingLeg)) && corkRule !== 'home_first' && corkRule !== 'away_first';
        setTimeout(() => showStarterModal(needsCork), 300);
    }
};

function determineStarterWithoutCork(legNum) {
    // Handle manual starter selection
    if (corkRule === 'home_first') {
        if (legNum === 1) return 0;
        return lastLegStarter !== null ? 1 - lastLegStarter : 0;
    }
    if (corkRule === 'away_first') {
        if (legNum === 1) return 1;
        return lastLegStarter !== null ? 1 - lastLegStarter : 1;
    }

    if (legNum === 1) {
        switch (corkOrder) {
            case 'home': return 0;
            case 'away': return 1;
            default: return Math.random() < 0.5 ? 0 : 1;
        }
    }

    switch (corkRule) {
        case 'loser_starts':
            return lastLegWinner !== null ? 1 - lastLegWinner : 0;

        case 'cork_every_leg':
            switch (corkOrder) {
                case 'home': return 0;
                case 'away': return 1;
                case 'winner': return lastLegWinner !== null ? lastLegWinner : 0;
                case 'loser': return lastLegWinner !== null ? 1 - lastLegWinner : 0;
                default: return Math.random() < 0.5 ? 0 : 1;
            }

        case 'cork_first_leg':
        case 'alternate_cork_first_deciding':
        default:
            if (players[0].legs === players[1].legs && players[0].legs === LEGS_TO_WIN - 1) {
                switch (corkOrder) {
                    case 'home': return 0;
                    case 'away': return 1;
                    case 'winner': return lastLegWinner !== null ? lastLegWinner : 0;
                    case 'loser': return lastLegWinner !== null ? 1 - lastLegWinner : 0;
                    default: return Math.random() < 0.5 ? 0 : 1;
                }
            }
            return lastLegStarter !== null ? 1 - lastLegStarter : 0;
    }
}

function showWinModal() {
    const winner = players[activePlayer];
    const loser = players[1 - activePlayer];
    const mprW = winner.totalRounds > 0 ? (winner.totalMarks / winner.totalRounds).toFixed(2) : '0.00';
    const mprL = loser.totalRounds > 0 ? (loser.totalMarks / loser.totalRounds).toFixed(2) : '0.00';

    const winnerColor = activePlayer === 0 ? 'var(--pink)' : 'var(--teal)';
    const loserColor = activePlayer === 0 ? 'var(--teal)' : 'var(--pink)';

    const winnerBestMPR = allTimeStats[activePlayer].bestMPR > 0 ? allTimeStats[activePlayer].bestMPR.toFixed(2) : '-';
    const loserBestMPR = allTimeStats[1 - activePlayer].bestMPR > 0 ? allTimeStats[1 - activePlayer].bestMPR.toFixed(2) : '-';
    const winnerFastest = allTimeStats[activePlayer].fewestRounds < 999 ? allTimeStats[activePlayer].fewestRounds : '-';
    const loserFastest = allTimeStats[1 - activePlayer].fewestRounds < 999 ? allTimeStats[1 - activePlayer].fewestRounds : '-';

    document.getElementById('winnerText').textContent = winner.name + ' Wins!';
    document.getElementById('winStats').innerHTML = `
        <div style="text-align: center; margin-bottom: 16px;">
            <span style="font-family: 'Bebas Neue', cursive;">
                <span style="color: ${winnerColor}; font-size: 42px;">${winner.legs}</span>
                <span style="opacity: 0.3; margin: 0 14px; font-size: 26px;">-</span>
                <span style="color: ${loserColor}; font-size: 42px;">${loser.legs}</span>
            </span>
        </div>

        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 6px; font-size: 12px;">
            <div style="font-weight: 600; color: var(--text-muted);"></div>
            <div style="font-weight: 700; text-align: center; min-width: 55px; color: ${winnerColor}; font-size: 10px; text-transform: uppercase; letter-spacing: 2px;">${winner.name.split(' ')[0].substring(0, 8)}</div>
            <div style="font-weight: 700; text-align: center; min-width: 55px; color: ${loserColor}; font-size: 10px; text-transform: uppercase; letter-spacing: 2px;">${loser.name.split(' ')[0].substring(0, 8)}</div>

            <div style="text-transform: uppercase; letter-spacing: 1px;">Overall MPR</div>
            <div style="text-align: center; color: var(--yellow); font-weight: 700; font-family: 'JetBrains Mono', monospace;">${mprW}</div>
            <div style="text-align: center; opacity: 0.5; font-family: 'JetBrains Mono', monospace;">${mprL}</div>

            <div style="text-transform: uppercase; letter-spacing: 1px;">Best Leg MPR</div>
            <div style="text-align: center; font-family: 'JetBrains Mono', monospace;">${winnerBestMPR}</div>
            <div style="text-align: center; opacity: 0.5; font-family: 'JetBrains Mono', monospace;">${loserBestMPR}</div>

            <div style="text-transform: uppercase; letter-spacing: 1px;">Total Rounds</div>
            <div style="text-align: center; font-family: 'JetBrains Mono', monospace;">${winner.totalRounds}</div>
            <div style="text-align: center; opacity: 0.5; font-family: 'JetBrains Mono', monospace;">${loser.totalRounds}</div>

            <div style="text-transform: uppercase; letter-spacing: 1px;">Fastest Leg</div>
            <div style="text-align: center; font-family: 'JetBrains Mono', monospace;">${winnerFastest}</div>
            <div style="text-align: center; opacity: 0.5; font-family: 'JetBrains Mono', monospace;">${loserFastest}</div>

            <div style="text-transform: uppercase; letter-spacing: 1px;">Total Marks</div>
            <div style="text-align: center; font-family: 'JetBrains Mono', monospace;">${winner.totalMarks}</div>
            <div style="text-align: center; opacity: 0.5; font-family: 'JetBrains Mono', monospace;">${loser.totalMarks}</div>

            <div style="text-transform: uppercase; letter-spacing: 1px;">Final Score</div>
            <div style="text-align: center; color: var(--yellow); font-family: 'JetBrains Mono', monospace;">${winner.score}</div>
            <div style="text-align: center; opacity: 0.5; font-family: 'JetBrains Mono', monospace;">${loser.score}</div>
        </div>
    `;
    document.getElementById('winModal').classList.add('active');
}

window.newGame = function() {
    document.getElementById('winModal').classList.remove('active');
    leg = 1;
    activePlayer = 0;
    currentDarts = [];
    turnHistory = [];
    // Reset all turn tracking
    legTurnsHistory = [];
    legFirstThrow = [];
    currentLegTurns = [];
    currentLegFirstThrow = null;
    legStats = [[], []]; // Reset leg stats
    players.forEach(p => {
        p.score = 0;
        p.marks = { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, BULL: 0 };
        p.legs = 0;
        p.totalMarks = 0;
        p.totalRounds = 0;
    });
    targetPoints[0] = { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, BULL: 0 };
    targetPoints[1] = { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, BULL: 0 };
    resetCurrentLegStats();
    allTimeStats = [
        { bestMPR: 0, fewestRounds: 999, whiteHorses: 0, threeInBeds: 0 },
        { bestMPR: 0, fewestRounds: 999, whiteHorses: 0, threeInBeds: 0 }
    ];
    gameStartTime = Date.now();
    renderBoard();
    updateDisplay();
};

window.saveAndExit = async function() {
    const winner = players[0].legs >= LEGS_TO_WIN ? 'home' : 'away';
    const duration = Math.floor((Date.now() - gameStartTime) / 1000);

    const mpr0 = players[0].totalRounds > 0 ? parseFloat((players[0].totalMarks / players[0].totalRounds).toFixed(2)) : 0;
    const mpr1 = players[1].totalRounds > 0 ? parseFloat((players[1].totalMarks / players[1].totalRounds).toFixed(2)) : 0;

    // Build comprehensive DartConnect-compatible leg data for cricket with throws
    const buildLegData = () => {
        const legs = [];
        const numLegs = Math.max(legStats[0].length, legStats[1].length);

        // Get player names
        const homePlayerName = players[0]?.name || 'Home';
        const awayPlayerName = players[1]?.name || 'Away';

        for (let i = 0; i < numLegs; i++) {
            const homeLeg = legStats[0][i] || {};
            const awayLeg = legStats[1][i] || {};
            const legWinner = homeLeg.score > (awayLeg.score || 0) ? 'home' : 'away';

            // Build throws array from saved turn history
            const legTurns = legTurnsHistory[i] || [];
            const firstThrow = legFirstThrow[i] !== undefined ? (legFirstThrow[i] === 0 ? 'home' : 'away') : 'home';
            const throws = [];

            // Group turns by round number
            const homeTurns = legTurns.filter(t => t.player === 0);
            const awayTurns = legTurns.filter(t => t.player === 1);
            const maxRounds = Math.max(homeTurns.length, awayTurns.length);

            for (let r = 0; r < maxRounds; r++) {
                const homeT = homeTurns[r];
                const awayT = awayTurns[r];
                const roundData = { round: r + 1 };

                if (homeT) {
                    roundData.home = {
                        player: homePlayerName,
                        marks: homeT.totalMarks,
                        points: homeT.totalPoints,
                        score: homeT.totalMarks + 'M', // Display as "3M" for 3 marks
                        darts: homeT.darts,
                        isWinningTurn: homeT.isWinningTurn || false
                    };
                    // Mark notable rounds (5+ marks)
                    if (homeT.totalMarks >= 9) roundData.home.notable = '9MR';
                    else if (homeT.totalMarks >= 7) roundData.home.notable = '7MR';
                    else if (homeT.totalMarks >= 5) roundData.home.notable = '5MR';
                }

                if (awayT) {
                    roundData.away = {
                        player: awayPlayerName,
                        marks: awayT.totalMarks,
                        points: awayT.totalPoints,
                        score: awayT.totalMarks + 'M', // Display as "3M" for 3 marks
                        darts: awayT.darts,
                        isWinningTurn: awayT.isWinningTurn || false
                    };
                    // Mark notable rounds (5+ marks)
                    if (awayT.totalMarks >= 9) roundData.away.notable = '9MR';
                    else if (awayT.totalMarks >= 7) roundData.away.notable = '7MR';
                    else if (awayT.totalMarks >= 5) roundData.away.notable = '5MR';
                }

                throws.push(roundData);
            }

            // Build player_stats object
            const player_stats = {};
            const homeMpr = homeLeg.rounds > 0 ? parseFloat((homeLeg.marks / homeLeg.rounds).toFixed(2)) : 0;
            const awayMpr = awayLeg.rounds > 0 ? parseFloat((awayLeg.marks / awayLeg.rounds).toFixed(2)) : 0;

            player_stats[homePlayerName] = {
                rounds: homeLeg.rounds || 0,
                marks: homeLeg.marks || 0,
                mpr: homeMpr,
                score: homeLeg.score || 0,
                nine_mark_rounds: homeLeg.nine_mark_rounds || 0
            };
            player_stats[awayPlayerName] = {
                rounds: awayLeg.rounds || 0,
                marks: awayLeg.marks || 0,
                mpr: awayMpr,
                score: awayLeg.score || 0,
                nine_mark_rounds: awayLeg.nine_mark_rounds || 0
            };

            legs.push({
                leg_number: i + 1,
                format: 'cricket',
                winner: legWinner,
                first_throw: firstThrow,
                home_stats: {
                    rounds: homeLeg.rounds || 0,
                    marks: homeLeg.marks || 0,
                    darts_thrown: homeLeg.darts_thrown || 0,
                    missed_darts: homeLeg.missed_darts || 0,
                    triple_bull_darts: homeLeg.triple_bull_darts || 0,
                    five_mark_rounds: homeLeg.five_mark_rounds || 0,
                    six_mark_rounds: homeLeg.six_mark_rounds || 0,
                    seven_mark_rounds: homeLeg.seven_mark_rounds || 0,
                    eight_mark_rounds: homeLeg.eight_mark_rounds || 0,
                    nine_mark_rounds: homeLeg.nine_mark_rounds || 0,
                    three_bulls: homeLeg.three_bulls || 0,
                    four_bulls: homeLeg.four_bulls || 0,
                    five_bulls: homeLeg.five_bulls || 0,
                    six_bulls: homeLeg.six_bulls || 0,
                    hat_tricks: homeLeg.hat_tricks || 0,
                    // NEW: High mark round, With/Against Darts
                    high_mark_round: homeLeg.high_mark_round || 0,
                    threw_first: homeLeg.threw_first
                },
                away_stats: {
                    rounds: awayLeg.rounds || 0,
                    marks: awayLeg.marks || 0,
                    darts_thrown: awayLeg.darts_thrown || 0,
                    missed_darts: awayLeg.missed_darts || 0,
                    triple_bull_darts: awayLeg.triple_bull_darts || 0,
                    five_mark_rounds: awayLeg.five_mark_rounds || 0,
                    six_mark_rounds: awayLeg.six_mark_rounds || 0,
                    seven_mark_rounds: awayLeg.seven_mark_rounds || 0,
                    eight_mark_rounds: awayLeg.eight_mark_rounds || 0,
                    nine_mark_rounds: awayLeg.nine_mark_rounds || 0,
                    three_bulls: awayLeg.three_bulls || 0,
                    four_bulls: awayLeg.four_bulls || 0,
                    five_bulls: awayLeg.five_bulls || 0,
                    six_bulls: awayLeg.six_bulls || 0,
                    hat_tricks: awayLeg.hat_tricks || 0,
                    // NEW: High mark round, With/Against Darts
                    high_mark_round: awayLeg.high_mark_round || 0,
                    threw_first: awayLeg.threw_first
                },
                player_stats: player_stats,
                throws: throws
            });
        }
        return legs;
    };

    // Build comprehensive game stats
    const comprehensiveGameStats = {
        game_type: 'cricket',
        duration_seconds: duration,
        // Cork's choice fields (for doubles choice games)
        cork_choice: corkChoice || null,
        cork_winner: corkWinnerSide || null,
        home: {
            name: players[0].name,
            legs: players[0].legs,
            score: players[0].score,
            mpr: mpr0,
            total_marks: players[0].totalMarks,
            total_rounds: players[0].totalRounds,
            total_darts: players[0].totalDarts,
            missed_darts: players[0].missedDarts,
            triple_bull_darts: players[0].tripleBullDarts,
            five_mark_rounds: players[0].fiveMarkRounds,
            seven_mark_rounds: players[0].sevenMarkRounds,
            eight_mark_rounds: players[0].eightMarkRounds,
            nine_mark_rounds: players[0].nineMarkRounds,
            three_bulls: players[0].threeBulls,
            four_bulls: players[0].fourBulls,
            five_bulls: players[0].fiveBulls,
            six_bulls: players[0].sixBulls,
            hat_tricks: players[0].hatTricks
        },
        away: {
            name: players[1].name,
            legs: players[1].legs,
            score: players[1].score,
            mpr: mpr1,
            total_marks: players[1].totalMarks,
            total_rounds: players[1].totalRounds,
            total_darts: players[1].totalDarts,
            missed_darts: players[1].missedDarts,
            triple_bull_darts: players[1].tripleBullDarts,
            five_mark_rounds: players[1].fiveMarkRounds,
            seven_mark_rounds: players[1].sevenMarkRounds,
            eight_mark_rounds: players[1].eightMarkRounds,
            nine_mark_rounds: players[1].nineMarkRounds,
            three_bulls: players[1].threeBulls,
            four_bulls: players[1].fourBulls,
            five_bulls: players[1].fiveBulls,
            six_bulls: players[1].sixBulls,
            hat_tricks: players[1].hatTricks
        },
        legs: buildLegData()
    };

    if (isChicago && chicagoGame > 0) {
        const chicagoMatch = JSON.parse(sessionStorage.getItem('chicagoMatch') || '{}');

        if (winner === 'home') chicagoMatch.home_wins++;
        else chicagoMatch.away_wins++;

        if (chicagoMatch.home_wins >= 2 || chicagoMatch.away_wins >= 2) {
            const matchWinner = chicagoMatch.home_wins >= 2 ? 'Home' : 'Away';
            alert(`Chicago Match Over! ${matchWinner} wins ${chicagoMatch.home_wins}-${chicagoMatch.away_wins}`);
            sessionStorage.removeItem('chicagoMatch');
            window.location.href = '/pages/scorer-hub.html';
            return;
        }

        chicagoMatch.current_game++;
        sessionStorage.setItem('chicagoMatch', JSON.stringify(chicagoMatch));

        const nextGame = chicagoMatch.games[chicagoMatch.current_game - 1];
        const params = new URLSearchParams();
        params.set('home_players', JSON.stringify(chicagoMatch.home_players));
        params.set('away_players', JSON.stringify(chicagoMatch.away_players));
        params.set('casual', 'true');
        params.set('chicago', 'true');
        params.set('chicago_game', chicagoMatch.current_game.toString());
        params.set('starting_score', nextGame.starting_score.toString());
        params.set('in_rule', nextGame.in_rule);
        params.set('out_rule', nextGame.out_rule);
        params.set('checkout', nextGame.out_rule);
        params.set('legs_to_win', '1');
        params.set('cork_rule', chicagoMatch.cork_rule);
        if (chicagoMatch.practice_mode && chicagoMatch.practice_mode !== 'off') {
            params.set('practice_mode', chicagoMatch.practice_mode);
        }

        window.location.href = `/pages/league-501.html?${params.toString()}`;
        return;
    }

    const gameResult = {
        game_number: gameNumber,
        game_type: 'cricket',
        winner,
        home_legs: players[0].legs,
        away_legs: players[1].legs,
        stats: { home_mpr: mpr0, away_mpr: mpr1 }
    };

    if (fromMatch) {
        const matchState = JSON.parse(sessionStorage.getItem('activeMatch') || '{}');
        if (!matchState.games_completed) matchState.games_completed = [];
        matchState.games_completed.push(gameResult);
        matchState[winner + '_score'] = (matchState[winner + '_score'] || 0) + 1;
        sessionStorage.setItem('activeMatch', JSON.stringify(matchState));

        try {
            if (leagueId && matchId) {
                showLoading('Saving game...');
                await callWithQueue(callFunction, 'submitGameResult', {
                    league_id: leagueId, match_id: matchId, game_number: gameNumber,
                    winner, home_legs_won: players[0].legs, away_legs_won: players[1].legs,
                    admin_pin: adminPin,
                    game_stats: comprehensiveGameStats
                });
                hideLoading();
            }
        } catch (e) {
            hideLoading();
            if (e.message !== 'QUEUED_OFFLINE') console.error('Save error:', e);
        }

        // Check if this is the final game of the match
        const isFinalGame = totalGames > 0 && gameNumber >= totalGames;

        if (isFinalGame) {
            // Show match complete modal instead of returning to hub
            showMatchCompleteModal(matchState, comprehensiveGameStats);
            return;
        }

        // Not the final game - return to match-hub with league and match context
        window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}`;
        return;
    }

    showLoading('Saving game...');
    try {
        if (leagueId && matchId) {
            // League game submission with offline queue fallback
            await callWithQueue(callFunction, 'submitGameResult', {
                league_id: leagueId, match_id: matchId, game_number: gameNumber,
                winner, home_legs_won: players[0].legs, away_legs_won: players[1].legs,
                admin_pin: adminPin,
                game_stats: comprehensiveGameStats
            });
            hideLoading();
            alert('Game saved!');
        } else if (tournamentId && tournamentMatchId) {
            // Tournament game submission with offline queue fallback
            await callWithQueue(callFunction, 'submitMatchResult', {
                tournament_id: tournamentId,
                match_id: tournamentMatchId,
                player1_score: players[0].legs,
                player2_score: players[1].legs,
                game_stats: comprehensiveGameStats
            });
            hideLoading();
            alert('Tournament match saved!');
        } else if (isVerificationMode) {
            // Stats verification mode - save results and submit
            hideLoading();
            await handleCricketVerificationComplete(comprehensiveGameStats);
            return; // handleCricketVerificationComplete handles navigation
        } else if (isCasual) {
            // Casual/Pickup game - save to pickup_games collection
            hideLoading();
            await saveCasualCricketGame(comprehensiveGameStats);
            return; // saveCasualCricketGame handles navigation
        } else {
            hideLoading();
        }
    } catch (e) {
        hideLoading();
        if (e.message === 'QUEUED_OFFLINE') {
            alert('You appear to be offline. Game has been queued and will sync when connection is restored.');
        } else {
            console.error('Save error:', e);
            alert('Error: ' + e.message);
        }
    }

    navigateAway();
};

// Handle cricket verification mode completion
async function handleCricketVerificationComplete(gameStats) {
    // Get verification session from sessionStorage
    const sessionData = sessionStorage.getItem('verificationSession');
    if (!sessionData) {
        alert('Verification session not found. Results cannot be saved.');
        navigateAway();
        return;
    }

    const session = JSON.parse(sessionData);

    // Build leg data for verification - player is always home team (position 0)
    const cricketLegs = gameStats.legs.map((leg, idx) => {
        const playerStats = leg.home_stats || {};
        const rounds = playerStats.rounds || 0;
        const marks = playerStats.marks || 0;
        const mpr = rounds > 0 ? marks / rounds : 0;
        const won = leg.winner === 'home';

        return {
            leg: idx + 1,
            rounds: rounds,
            marks: marks,
            mpr: mpr,
            won: won
        };
    });

    // Calculate player's wins
    const playerWins = cricketLegs.filter(l => l.won).length;

    // Calculate verified MPR (best 3 of 5)
    const sortedByMpr = [...cricketLegs].sort((a, b) => b.mpr - a.mpr);
    const top3 = sortedByMpr.slice(0, 3);
    const droppedLegs = sortedByMpr.slice(3).map(l => l.leg);
    const verifiedMPR = top3.reduce((sum, l) => sum + l.mpr, 0) / 3;

    // Check if player won at least 2 of top 3 legs
    const top3Wins = top3.filter(l => l.won).length;
    const isValidVerification = top3Wins >= 2;

    // Show verification results modal
    const modal = document.getElementById('gameModal');
    const statsDiv = document.getElementById('gameStats');
    const winnerName = document.getElementById('gameWinnerName');

    winnerName.textContent = isValidVerification ? 'CRICKET VERIFICATION COMPLETE!' : 'CRICKET VERIFICATION';
    winnerName.style.color = isValidVerification ? '#22c55e' : '#FDD835';

    let legsHtml = cricketLegs.map(l => {
        const dropped = droppedLegs.includes(l.leg);
        return `
            <div style="display: flex; justify-content: space-between; padding: 6px 0; ${dropped ? 'opacity: 0.4; text-decoration: line-through;' : ''}">
                <span>Leg ${l.leg}</span>
                <span style="color: ${l.won ? '#22c55e' : '#ef4444'};">${l.won ? 'WIN' : 'LOSS'}</span>
                <span style="color: var(--yellow);">${l.mpr.toFixed(2)} MPR</span>
                <span>${l.rounds} rnds</span>
            </div>
        `;
    }).join('');

    statsDiv.innerHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-size: 14px; opacity: 0.7; margin-bottom: 4px;">YOUR RECORD</div>
            <div style="font-size: 28px; color: var(--yellow);">${playerWins} - ${5 - playerWins}</div>
        </div>
        <div style="margin-bottom: 15px;">
            ${legsHtml}
        </div>
        <div style="background: rgba(145,215,235,0.15); border: 2px solid var(--teal); border-radius: 8px; padding: 12px; text-align: center;">
            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 4px;">VERIFIED MPR (Best 3 of 5)</div>
            <div style="font-size: 36px; font-family: 'Rowdies', cursive; color: var(--yellow);">${verifiedMPR.toFixed(2)}</div>
            <div style="font-size: 12px; color: ${isValidVerification ? '#22c55e' : '#ef4444'}; margin-top: 8px;">
                ${isValidVerification ?
                    `Won ${top3Wins} of 3 counting legs - Valid verification` :
                    `Won only ${top3Wins} of 3 counting legs - Must win at least 2`}
            </div>
        </div>
    `;

    // Replace buttons
    const modalContent = modal.querySelector('.modal-content');
    const existingBtns = modalContent.querySelectorAll('.modal-btn');
    existingBtns.forEach(btn => btn.style.display = 'none');

    // Remove existing verification buttons if present
    const existingVerBtns = modalContent.querySelectorAll('.verification-btn');
    existingVerBtns.forEach(btn => btn.remove());

    if (isValidVerification) {
        // Save button
        const saveBtn = document.createElement('button');
        saveBtn.className = 'modal-btn verification-btn';
        saveBtn.textContent = 'SAVE VERIFIED STATS';
        saveBtn.style.marginTop = '15px';
        saveBtn.style.background = '#22c55e';
        saveBtn.onclick = async () => {
            saveBtn.textContent = 'SAVING...';
            saveBtn.disabled = true;

            try {
                // Submit to Cloud Function
                const result = await callFunction('submitVerification', {
                    player_id: session.player_id,
                    player_pin: session.player_pin,
                    x01_legs: [], // Empty for cricket-only verification
                    cricket_legs: cricketLegs
                });

                if (result.success) {
                    // Store results for return page
                    sessionStorage.setItem('verificationResults', JSON.stringify({
                        game_type: 'cricket',
                        verified_mpr: result.verified_mpr || verifiedMPR,
                        legs: cricketLegs
                    }));

                    // Clear session
                    sessionStorage.removeItem('verificationSession');

                    alert(`Cricket Stats Verified!\n\nVerified MPR: ${(result.verified_mpr || verifiedMPR).toFixed(2)}`);
                    navigateAway();
                } else {
                    throw new Error(result.error || 'Failed to save verification');
                }
            } catch (err) {
                console.error('Verification save error:', err);
                alert('Error saving verification: ' + err.message);
                saveBtn.textContent = 'SAVE VERIFIED STATS';
                saveBtn.disabled = false;
            }
        };
        modalContent.appendChild(saveBtn);
    } else {
        // Retry button
        const retryBtn = document.createElement('button');
        retryBtn.className = 'modal-btn verification-btn';
        retryBtn.textContent = 'TRY AGAIN';
        retryBtn.style.marginTop = '15px';
        retryBtn.onclick = () => {
            // Restart verification
            window.location.reload();
        };
        modalContent.appendChild(retryBtn);
    }

    // Cancel button
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'modal-btn verification-btn';
    cancelBtn.textContent = 'BACK TO VERIFICATION';
    cancelBtn.style.marginTop = '10px';
    cancelBtn.style.background = 'rgba(255,255,255,0.1)';
    cancelBtn.onclick = () => {
        sessionStorage.removeItem('verificationSession');
        navigateAway();
    };
    modalContent.appendChild(cancelBtn);

    modal.classList.add('active');
}

// Save casual/pickup cricket game with stats
async function saveCasualCricketGame(gameStats) {
    const statPlayerId = params.get('stat_player_id');
    const statPlayerName = params.get('stat_player_name');

    // Check if players are bots
    const player1IsBot = isHomeBot();
    const player2IsBot = isAwayBot();

    let player1Pin = statPlayerId ? null : (localStorage.getItem('brdc_player_pin') || null);
    let player2Pin = null;

    const player1Name = players[0]?.name || 'Player 1';
    const player2Name = players[1]?.name || 'Player 2';

    // Build confirmation message
    let confirmMsg = `Save this game to track stats?\n\n${player1Name}${player1IsBot ? ' (Bot)' : ''}: ${players[0].legs} legs\n${player2Name}${player2IsBot ? ' (Bot)' : ''}: ${players[1].legs} legs\n\n${player1Name} MPR: ${gameStats.home.mpr}\n${player2Name} MPR: ${gameStats.away.mpr}`;

    const wantToSave = confirm(confirmMsg);

    if (!wantToSave) {
        showCasualCricketSummary(gameStats);
        return;
    }

    // Get PINs for human players who want to track stats
    if (!statPlayerId && !player1IsBot) {
        player1Pin = prompt(`Enter PIN for ${player1Name} to track stats (or leave blank for guest):`);
        if (player1Pin) localStorage.setItem('brdc_player_pin', player1Pin.toUpperCase());
    }

    if (!player2IsBot) {
        player2Pin = prompt(`Enter PIN for ${player2Name} to track stats (or leave blank for guest):`);
    }

    showLoading('Saving game...');

    try {
        const winnerIndex = players[0].legs >= LEGS_TO_WIN ? 0 : 1;

        // Build legs data for pickup game format (cricket)
        const pickupLegs = gameStats.legs.map((leg, idx) => ({
            winner: leg.winner === 'home' ? 'player1' : 'player2',
            player1_stats: {
                rounds: leg.home_stats?.rounds || 0,
                marks: leg.home_stats?.marks || 0,
                darts_thrown: leg.home_stats?.darts_thrown || 0,
                missed_darts: leg.home_stats?.missed_darts || 0,
                triple_bull_darts: leg.home_stats?.triple_bull_darts || 0,
                five_mark_rounds: leg.home_stats?.five_mark_rounds || 0,
                six_mark_rounds: leg.home_stats?.six_mark_rounds || 0,
                seven_mark_rounds: leg.home_stats?.seven_mark_rounds || 0,
                eight_mark_rounds: leg.home_stats?.eight_mark_rounds || 0,
                nine_mark_rounds: leg.home_stats?.nine_mark_rounds || 0,
                three_bulls: leg.home_stats?.three_bulls || 0,
                four_bulls: leg.home_stats?.four_bulls || 0,
                five_bulls: leg.home_stats?.five_bulls || 0,
                six_bulls: leg.home_stats?.six_bulls || 0,
                hat_tricks: leg.home_stats?.hat_tricks || 0,
                // NEW: High mark round, With/Against Darts
                high_mark_round: leg.home_stats?.high_mark_round || 0,
                threw_first: leg.home_stats?.threw_first
            },
            player2_stats: {
                rounds: leg.away_stats?.rounds || 0,
                marks: leg.away_stats?.marks || 0,
                darts_thrown: leg.away_stats?.darts_thrown || 0,
                missed_darts: leg.away_stats?.missed_darts || 0,
                triple_bull_darts: leg.away_stats?.triple_bull_darts || 0,
                five_mark_rounds: leg.away_stats?.five_mark_rounds || 0,
                six_mark_rounds: leg.away_stats?.six_mark_rounds || 0,
                seven_mark_rounds: leg.away_stats?.seven_mark_rounds || 0,
                eight_mark_rounds: leg.away_stats?.eight_mark_rounds || 0,
                nine_mark_rounds: leg.away_stats?.nine_mark_rounds || 0,
                three_bulls: leg.away_stats?.three_bulls || 0,
                four_bulls: leg.away_stats?.four_bulls || 0,
                five_bulls: leg.away_stats?.five_bulls || 0,
                six_bulls: leg.away_stats?.six_bulls || 0,
                hat_tricks: leg.away_stats?.hat_tricks || 0,
                // NEW: High mark round, With/Against Darts
                high_mark_round: leg.away_stats?.high_mark_round || 0,
                threw_first: leg.away_stats?.threw_first
            }
        }));

        // Get bot IDs if applicable
        const player1BotId = player1IsBot ? (homePlayers[0]?.registeredBotId || null) : null;
        const player2BotId = player2IsBot ? (awayPlayers[0]?.registeredBotId || null) : null;

        const payload = {
            game_type: 'cricket',
            players: [
                {
                    id: statPlayerId || player1BotId || null,
                    pin: player1Pin?.toUpperCase() || null,
                    name: player1Name,
                    is_bot: player1IsBot
                },
                {
                    id: player2BotId || null,
                    pin: player2Pin?.toUpperCase() || null,
                    name: player2Name,
                    is_bot: player2IsBot
                }
            ],
            winner_index: winnerIndex,
            legs: pickupLegs,
            match_config: {
                bestOfLegs: LEGS_TO_WIN * 2 - 1,
                bestOfSets: 1
            }
        };

        const result = await callFunction('savePickupGame', payload);
        hideLoading();

        if (result.success) {
            showCasualCricketSummary(gameStats, 'Game saved! Stats updated.');
        } else {
            showCasualCricketSummary(gameStats, 'Could not save: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        hideLoading();
        console.error('Error saving casual cricket game:', error);
        showCasualCricketSummary(gameStats, 'Error saving: ' + error.message);
    }
}

// Show casual cricket game summary with stats
function showCasualCricketSummary(gameStats, saveMessage = null) {
    const modal = document.getElementById('winModal');
    const statsDiv = document.getElementById('winStats');
    const winnerText = document.getElementById('winnerText');

    const winner = players[0].legs >= LEGS_TO_WIN ? players[0] : players[1];
    winnerText.textContent = winner.name + ' WINS!';

    statsDiv.innerHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-size: 24px; color: var(--yellow);">${players[0].legs} - ${players[1].legs}</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
            <div>
                <div style="font-weight: 700; color: var(--pink); margin-bottom: 8px;">${players[0].name}</div>
                <div style="font-size: 28px; font-family: 'Rowdies', cursive;">${gameStats.home.mpr}</div>
                <div style="font-size: 11px; opacity: 0.7;">MPR</div>
                <div style="margin-top: 8px;">
                    <span style="color: var(--yellow);">${gameStats.home.nine_mark_rounds || 0}</span> 9MRs
                    <span style="margin-left: 10px; color: var(--teal);">${gameStats.home.total_marks}</span> Marks
                </div>
            </div>
            <div>
                <div style="font-weight: 700; color: var(--teal); margin-bottom: 8px;">${players[1].name}</div>
                <div style="font-size: 28px; font-family: 'Rowdies', cursive;">${gameStats.away.mpr}</div>
                <div style="font-size: 11px; opacity: 0.7;">MPR</div>
                <div style="margin-top: 8px;">
                    <span style="color: var(--yellow);">${gameStats.away.nine_mark_rounds || 0}</span> 9MRs
                    <span style="margin-left: 10px; color: var(--teal);">${gameStats.away.total_marks}</span> Marks
                </div>
            </div>
        </div>
        ${saveMessage ? `<div style="margin-top: 15px; font-size: 13px; color: ${saveMessage.includes('saved') ? '#4CAF50' : '#ff6b6b'};">${saveMessage}</div>` : ''}
    `;

    // Replace buttons with just a DONE button
    const modalContent = modal.querySelector('.modal-content');
    const existingBtns = modalContent.querySelectorAll('.modal-btn');
    existingBtns.forEach(btn => btn.style.display = 'none');

    if (!document.getElementById('casualDoneBtn')) {
        const doneBtn = document.createElement('button');
        doneBtn.id = 'casualDoneBtn';
        doneBtn.className = 'modal-btn';
        doneBtn.textContent = 'DONE';
        doneBtn.onclick = () => navigateAway();
        doneBtn.style.marginTop = '15px';
        modalContent.appendChild(doneBtn);
    }

    modal.classList.add('active');
}

// ========== MATCH COMPLETE MODAL ==========

function showMatchCompleteModal(matchState, gameStats) {
    const homeScore = matchState.home_score || 0;
    const awayScore = matchState.away_score || 0;

    // Populate team names
    document.getElementById('matchCompleteHomeName').textContent = homeTeamName;
    document.getElementById('matchCompleteAwayName').textContent = awayTeamName;

    // Populate scores
    const homeScoreEl = document.getElementById('matchCompleteHomeScore');
    const awayScoreEl = document.getElementById('matchCompleteAwayScore');
    homeScoreEl.textContent = homeScore;
    awayScoreEl.textContent = awayScore;

    // Style winner score with yellow
    if (homeScore > awayScore) {
        homeScoreEl.style.color = 'var(--yellow)';
        awayScoreEl.style.color = 'var(--text-muted)';
    } else if (awayScore > homeScore) {
        awayScoreEl.style.color = 'var(--yellow)';
        homeScoreEl.style.color = 'var(--text-muted)';
    } else {
        homeScoreEl.style.color = 'var(--text-light)';
        awayScoreEl.style.color = 'var(--text-light)';
    }

    // Winner announcement
    const winnerEl = document.getElementById('matchCompleteWinner');
    if (homeScore > awayScore) {
        winnerEl.textContent = `${homeTeamName} WINS!`;
        winnerEl.style.color = 'var(--pink)';
    } else if (awayScore > homeScore) {
        winnerEl.textContent = `${awayTeamName} WINS!`;
        winnerEl.style.color = 'var(--teal)';
    } else {
        winnerEl.textContent = 'MATCH TIED!';
        winnerEl.style.color = 'var(--yellow)';
    }

    // Build stats summary from accumulated game results
    const gamesCompleted = matchState.games_completed || [];
    let totalHomeLegs = 0;
    let totalAwayLegs = 0;
    let homeMprSum = 0;
    let awayMprSum = 0;
    let homeMprCount = 0;
    let awayMprCount = 0;

    gamesCompleted.forEach(g => {
        totalHomeLegs += g.home_legs || 0;
        totalAwayLegs += g.away_legs || 0;
        if (g.stats) {
            if (g.stats.home_mpr) { homeMprSum += g.stats.home_mpr; homeMprCount++; }
            if (g.stats.away_mpr) { awayMprSum += g.stats.away_mpr; awayMprCount++; }
            if (g.stats.home_avg) { homeMprSum += g.stats.home_avg; homeMprCount++; }
            if (g.stats.away_avg) { awayMprSum += g.stats.away_avg; awayMprCount++; }
        }
    });

    const homeMpr = homeMprCount > 0 ? (homeMprSum / homeMprCount).toFixed(2) : '-';
    const awayMpr = awayMprCount > 0 ? (awayMprSum / awayMprCount).toFixed(2) : '-';

    const statsHtml = `
        <div class="row"><span>Total Legs</span><span class="val">${totalHomeLegs} - ${totalAwayLegs}</span></div>
        <div class="row"><span>Match Avg</span><span class="val">${homeMpr} - ${awayMpr}</span></div>
    `;

    document.getElementById('matchCompleteStats').innerHTML = statsHtml;

    // End live match tracking
    if ((leagueId && matchId) || tournamentId) {
        try {
            const scorerPin = localStorage.getItem('brdc_player_pin') || adminPin || matchPin;
            if (scorerPin) {
                callFunction('endLiveMatch', {
                    scorer_pin: scorerPin,
                    match_id: matchId || tournamentMatchId,
                    result: {
                        winner: homeScore > awayScore ? 'team1' : (awayScore > homeScore ? 'team2' : 'tie'),
                        team1_score: homeScore,
                        team2_score: awayScore,
                        total_legs: totalHomeLegs + totalAwayLegs
                    }
                }).catch(e => console.warn('Failed to end live match tracking:', e));
            }
        } catch (e) {
            console.warn('Failed to end live match tracking:', e);
        }
    }

    // Show modal
    document.getElementById('matchCompleteModal').classList.add('active');
}

window.viewMatchReport = function() {
    if (leagueId && matchId) {
        window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}&tab=games`;
    } else {
        window.location.href = '/pages/scorer-hub.html';
    }
};

window.backToHub = function() {
    if (leagueId && matchId) {
        window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}`;
    } else {
        window.location.href = '/pages/scorer-hub.html';
    }
};

function navigateAway() {
    // Simple return logic: league games go to match-hub, everything else to scorer-hub
    if (leagueId && matchId) {
        window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}`;
    } else {
        window.location.href = '/pages/scorer-hub.html';
    }
}

window.exitGame = function() {
    if (isCasual) {
        const hasProgress = players[0].totalRounds > 0 || players[1].totalRounds > 0 || players[0].legs > 0 || players[1].legs > 0;
        if (hasProgress) {
            const resumeState = {
                timestamp: Date.now(),
                gameType: 'cricket',
                teams: players.map(p => ({
                    name: p.name,
                    score: p.score,
                    legs: p.legs,
                    totalRounds: p.totalRounds,
                    totalMarks: p.totalMarks
                })),
                activeTeam: activePlayer,
                currentLeg: leg,
                legsToWin: LEGS_TO_WIN,
                isMixedGame: isMixedGame,
                mixedLegIndex: mixedLegIndex,
                homePlayers: homePlayers,
                awayPlayers: awayPlayers
            };
            sessionStorage.setItem('matchResumeState', JSON.stringify(resumeState));
            window.location.href = '/pages/game-setup.html?resume=true';
            return;
        }
    }

    if (players[0].totalRounds > 0 || players[1].totalRounds > 0) {
        if (!confirm('Exit? Progress will be lost.')) return;
    }
    navigateAway();
};

let pendingStarter = null;

function showStarterModal(needsCork) {
    document.getElementById('starterLegInfo').textContent = `LEG ${leg}`;
    document.getElementById('corkHomeBtn').textContent = players[0].name;
    document.getElementById('corkAwayBtn').textContent = players[1].name;

    document.getElementById('corkReadyPhase').style.display = 'none';
    document.getElementById('corkShufflePhase').style.display = 'none';
    document.getElementById('throwsFirstPhase').style.display = 'none';
    document.getElementById('whoGotItPhase').style.display = 'none';
    document.getElementById('chooseOrderPhase').style.display = 'none';
    document.getElementById('starterReadyPhase').style.display = 'none';

    if (needsCork) {
        document.getElementById('corkReadyPhase').style.display = 'block';
    } else {
        // Only determine starter if not already set (e.g., from doubles choice redirect)
        if (pendingStarter === null) {
            pendingStarter = determineStarterWithoutCork(leg);
        }
        showStarterReadyPhase();
    }
    document.getElementById('starterModal').classList.add('active');
}

function showStarterReadyPhase() {
    document.getElementById('corkReadyPhase').style.display = 'none';
    document.getElementById('corkShufflePhase').style.display = 'none';
    document.getElementById('throwsFirstPhase').style.display = 'none';
    document.getElementById('whoGotItPhase').style.display = 'none';
    document.getElementById('chooseOrderPhase').style.display = 'none';
    document.getElementById('starterReadyPhase').style.display = 'block';

    const name = players[pendingStarter].name;
    const color = pendingStarter === 0 ? 'var(--pink)' : 'var(--teal)';
    document.getElementById('starterName').textContent = name;
    document.getElementById('starterName').style.color = color;
}

let corkFirstThrow = null; // Who throws first at the bull

window.startCorkShuffle = function() {
    document.getElementById('corkReadyPhase').style.display = 'none';
    document.getElementById('corkShufflePhase').style.display = 'block';

    const spinner = document.getElementById('shuffleName');
    let count = 0;
    const names = [players[0].name, players[1].name];

    const interval = setInterval(() => {
        spinner.textContent = names[count % 2];
        spinner.style.color = count % 2 === 0 ? 'var(--pink)' : 'var(--teal)';
        count++;
    }, 100);

    const duration = 1500 + Math.random() * 1000;
    setTimeout(() => {
        clearInterval(interval);
        // Randomly pick who throws first at the bull
        const throwsFirst = Math.random() < 0.5 ? 0 : 1;
        corkFirstThrow = throwsFirst;

        // Show "Throws First" phase
        document.getElementById('corkShufflePhase').style.display = 'none';
        document.getElementById('throwsFirstPhase').style.display = 'block';
        document.getElementById('throwsFirstName').textContent = players[throwsFirst].name;
        document.getElementById('throwsFirstName').style.color = throwsFirst === 0 ? 'var(--pink)' : 'var(--teal)';
    }, duration);
};

window.showWhoGotIt = function() {
    document.getElementById('throwsFirstPhase').style.display = 'none';
    document.getElementById('whoGotItPhase').style.display = 'block';
};

let corkOptionHolder = null; // Who has the option this leg

window.corkWinner = function(winner) {
    corkOptionHolder = winner;
    showChooseOrderPhase(winner);
};

function showChooseOrderPhase(winner) {
    document.getElementById('whoGotItPhase').style.display = 'none';
    document.getElementById('chooseOrderPhase').style.display = 'block';

    const winnerName = players[winner].name;
    const winnerColor = winner === 0 ? 'var(--pink)' : 'var(--teal)';
    document.getElementById('chooseOrderWinner').textContent = winnerName;
    document.getElementById('chooseOrderWinner').style.color = winnerColor;
}

window.chooseThrowOrder = function(choice) {
    if (choice === 'first') {
        pendingStarter = corkOptionHolder;
    } else {
        pendingStarter = 1 - corkOptionHolder;
    }

    document.getElementById('chooseOrderPhase').style.display = 'none';
    showStarterReadyPhase();
};

window.confirmStarter = function() {
    activePlayer = pendingStarter;
    lastLegStarter = pendingStarter;
    document.getElementById('starterModal').classList.remove('active');
    updateDisplay();

    if (isCurrentPlayerBot()) {
        setTimeout(() => botPlay(), 500);
    }
};

function getGameLabel(leg) {
    if (!leg) return 'CRICKET';
    if (leg.type === 'cricket') return 'CRICKET';
    const score = leg.score || (leg.type === '301' ? 301 : 501);
    let label = score.toString();
    if (leg.inRule === 'double') label += ' DI';
    if (leg.outRule === 'double') label += ' DO';
    return label;
}

let gameSelectorMode = 'next';

window.showGameSelector = function(mode = 'next') {
    gameSelectorMode = mode;
    document.getElementById('gameSelectorTitle').textContent = mode === 'current' ? 'CHANGE GAME' : 'SELECT NEXT GAME';
    document.getElementById('x01Options').style.display = 'none';
    document.getElementById('gameSelectorModal').classList.add('active');
};

window.selectNextGame = function(type) {
    if (type === 'x01') {
        document.getElementById('x01Options').style.display = 'block';
        return;
    }
    document.getElementById('x01Options').style.display = 'none';

    if (type === 'cricket') {
        applyGameSelection('cricket', null, null, null);
    } else {
        const score = type === '301' ? 301 : 501;
        applyGameSelection('x01', score, 'open', 'double');
    }
};

window.confirmX01Selection = function() {
    const score = parseInt(document.getElementById('x01ScoreInput').value) || 501;
    const inRule = document.getElementById('x01InRule').value;
    const outRule = document.getElementById('x01OutRule').value;
    applyGameSelection('x01', score, inRule, outRule);
};

function applyGameSelection(type, score, inRule, outRule) {
    document.getElementById('gameSelectorModal').classList.remove('active');

    if (gameSelectorMode === 'current') {
        navigateToGame(type, score, inRule, outRule, mixedLegIndex);
    } else {
        const mixedConfig = JSON.parse(sessionStorage.getItem('mixedGameConfig') || '{}');
        const nextLegIndex = mixedLegIndex + 1;
        if (mixedConfig.legs && mixedConfig.legs[nextLegIndex]) {
            mixedConfig.legs[nextLegIndex] = {
                type: type === 'cricket' ? 'cricket' : 'x01',
                score: score,
                inRule: inRule,
                outRule: outRule
            };
            sessionStorage.setItem('mixedGameConfig', JSON.stringify(mixedConfig));

            document.getElementById('nextGameLabel').textContent = getGameLabel(mixedConfig.legs[nextLegIndex]);
        }
    }
}

function navigateToGame(type, score, inRule, outRule, legIndex) {
    const params = new URLSearchParams();
    params.set('home_players', JSON.stringify(homePlayers));
    params.set('away_players', JSON.stringify(awayPlayers));
    params.set('casual', 'true');
    params.set('legs_to_win', LEGS_TO_WIN);
    params.set('home_legs', players[0].legs);
    params.set('away_legs', players[1].legs);

    if (isMixedGame) {
        params.set('mixed', 'true');
        params.set('mixed_leg', legIndex);
    }

    if (type === 'cricket') {
        window.location.href = `/pages/league-cricket.html?${params.toString()}`;
    } else {
        params.set('starting_score', score);
        params.set('in_rule', inRule);
        params.set('out_rule', outRule);
        params.set('checkout', outRule);
        window.location.href = `/pages/league-501.html?${params.toString()}`;
    }
}

window.closeGameSelector = function() {
    document.getElementById('gameSelectorModal').classList.remove('active');
    document.getElementById('x01Options').style.display = 'none';
};

function hideWrongGameBtn() {
    const row = document.getElementById('wrongGameRow');
    if (row) row.style.display = 'none';
}

function showWrongGameBtn() {
    const row = document.getElementById('wrongGameRow');
    if (row) row.style.display = 'flex';
}

// ===== CASUAL SETUP SCREEN FUNCTIONS =====
let setupState = {
    player1Name: 'Player 1',
    player2Name: 'Player 2',
    legs: 3,
    starterRule: 'cork' // 'cork', 'player1', 'player2', 'alternate'
};

function showSetupScreen() {
    document.getElementById('setupScreen').classList.add('active');
}

function hideSetupScreen() {
    document.getElementById('setupScreen').classList.remove('active');
}

window.setSetupStarter = function(rule) {
    setupState.starterRule = rule;
    const btns = document.querySelectorAll('#setupScreen .setup-section:nth-child(4) .setup-toggle-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    const index = ['cork', 'player1', 'player2', 'alternate'].indexOf(rule);
    if (index >= 0) btns[index].classList.add('active');
};

window.startCasualGame = function() {
    // Get values from setup form
    setupState.player1Name = document.getElementById('setupPlayer1').value.trim() || 'Player 1';
    setupState.player2Name = document.getElementById('setupPlayer2').value.trim() || 'Player 2';
    setupState.legs = parseInt(document.getElementById('setupLegs').value) || 3;

    // Set up players
    homePlayers = [{ id: 'casual_p1', name: setupState.player1Name }];
    awayPlayers = [{ id: 'casual_p2', name: setupState.player2Name }];

    // Update player data
    players[0].name = setupState.player1Name;
    players[1].name = setupState.player2Name;

    // Set casual mode
    isCasual = true;

    // Update cork settings based on starter rule
    switch (setupState.starterRule) {
        case 'cork':
            // Cork will be handled by starter modal
            break;
        case 'player1':
            activePlayer = 0;
            lastLegStarter = 0;
            break;
        case 'player2':
            activePlayer = 1;
            lastLegStarter = 1;
            break;
        case 'alternate':
            activePlayer = 0;
            lastLegStarter = 0;
            break;
    }

    // Hide setup screen and start game
    hideSetupScreen();
    init();
};

// Startup: Check if we have match data or show setup screen
if (homePlayers.length > 0 && homePlayers[0]?.name) {
    // Have player data - initialize directly
    init();
} else {
    // No match data - show casual setup screen
    showSetupScreen();
}

if (isMixedGame && players[0].totalRounds === 0 && players[1].totalRounds === 0) {
    showWrongGameBtn();
}

// Register service worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
        .then(() => {})
        .catch(err => console.error('[SW] Registration failed:', err));
}
</script>
<script src="/js/nav-menu.js"></script>
<script src="/js/feedback.js"></script>
</body>
</html>