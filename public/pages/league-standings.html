<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>League Standings - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/brdc-styles.css">
    <style>
        .standings-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .standings-table th {
            background: var(--pink);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 1px;
            border: 3px solid var(--black);
        }

        .standings-table td {
            padding: 15px;
            border: 2px solid #e5e7eb;
            font-weight: 600;
        }

        .standings-table tr:hover {
            background: #f9fafb;
        }

        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: var(--teal);
            border: 2px solid var(--black);
            border-radius: 50%;
            text-align: center;
            line-height: 26px;
            font-weight: 700;
        }

        .rank-badge.gold { background: #ffd700; }
        .rank-badge.silver { background: #c0c0c0; }
        .rank-badge.bronze { background: #cd7f32; }

        .team-card {
            background: white;
            border: 3px solid var(--black);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 6px 6px 0 rgba(0,0,0,1);
        }

        .team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .player-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .player-badge {
            background: var(--teal);
            border: 2px solid var(--black);
            padding: 5px 12px;
            font-size: 13px;
            font-weight: 700;
        }

        .player-badge.captain { background: var(--yellow); }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            background: white;
            border: 3px solid var(--black);
            padding: 12px 24px;
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0,0,0,1);
            transition: all 0.2s;
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,1);
        }

        .tab.active {
            background: var(--pink);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .match-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            gap: 20px;
        }

        .match-team {
            flex: 1;
            font-weight: 700;
        }

        .match-team.home { text-align: right; }
        .match-team.away { text-align: left; }

        .match-score {
            background: var(--teal);
            padding: 8px 16px;
            border: 2px solid var(--black);
            font-weight: 700;
            font-size: 18px;
            min-width: 80px;
            text-align: center;
        }

        .match-score.pending {
            background: #eee;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="brdc-card" style="max-width: 1200px; margin: 40px auto;">
            <div class="brdc-card-header">
                <h1 class="brdc-title" style="font-size: 48px; color: white;" id="leagueName">Loading...</h1>
                <p class="brdc-subtitle" style="color: white; margin-top: 10px;" id="leagueInfo"></p>
            </div>

            <div style="padding: 40px;">
                <div class="tab-container">
                    <div class="tab active" onclick="switchTab('standings')">Standings</div>
                    <div class="tab" onclick="switchTab('teams')">Teams</div>
                    <div class="tab" onclick="switchTab('schedule')">Schedule</div>
                </div>

                <div id="standingsTab" class="tab-content active">
                    <table class="standings-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Team</th>
                                <th>W</th>
                                <th>L</th>
                                <th>Pts</th>
                                <th>Games</th>
                                <th>Game %</th>
                            </tr>
                        </thead>
                        <tbody id="standingsBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px;">
                                    <div class="brdc-spinner"></div>
                                    <p style="margin-top: 20px;">Loading standings...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="teamsTab" class="tab-content">
                    <div id="teamsContainer">
                        <div style="text-align: center; padding: 40px;">
                            <div class="brdc-spinner"></div>
                            <p style="margin-top: 20px;">Loading teams...</p>
                        </div>
                    </div>
                </div>

                <div id="scheduleTab" class="tab-content">
                    <div id="scheduleContainer">
                        <div style="text-align: center; padding: 40px;">
                            <div class="brdc-spinner"></div>
                            <p style="margin-top: 20px;">Loading schedule...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, collection, query, orderBy, onSnapshot, doc, getDoc } from '/js/firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        const leagueId = urlParams.get('league_id') || urlParams.get('league');

        let leagueData = null;
        let teamsData = [];
        let matchesData = [];

        window.onload = async function() {
            if (!leagueId) {
                document.getElementById('leagueName').textContent = 'Error';
                document.getElementById('leagueInfo').textContent = 'Missing league_id in URL';
                return;
            }
            await loadLeagueData();
        };

        async function loadLeagueData() {
            try {
                // Load league document
                const leagueDoc = await getDoc(doc(db, 'leagues', leagueId));
                if (!leagueDoc.exists()) {
                    throw new Error('League not found');
                }

                leagueData = { id: leagueId, ...leagueDoc.data() };

                // Update header
                document.getElementById('leagueName').textContent = leagueData.league_name || 'League';
                document.getElementById('leagueInfo').textContent =
                    `${leagueData.venue_name || ''} ${leagueData.league_night ? 'â€¢ ' + leagueData.league_night + 's' : ''}`;

                // Set up realtime listeners for subcollections
                setupRealtimeListeners();

            } catch (error) {
                console.error('Error loading league:', error);
                document.getElementById('leagueName').textContent = 'Error';
                document.getElementById('leagueInfo').textContent = error.message;
            }
        }

        function setupRealtimeListeners() {
            // Listen for teams in subcollection: leagues/{leagueId}/teams
            const teamsRef = collection(db, 'leagues', leagueId, 'teams');

            onSnapshot(teamsRef, (snapshot) => {
                teamsData = [];
                snapshot.forEach((doc) => {
                    teamsData.push({ id: doc.id, ...doc.data() });
                });
                renderTeams();
                renderStandings();
            });

            // Listen for matches in subcollection: leagues/{leagueId}/matches
            const matchesRef = collection(db, 'leagues', leagueId, 'matches');
            const matchesQuery = query(matchesRef, orderBy('week', 'asc'));

            onSnapshot(matchesQuery, (snapshot) => {
                matchesData = [];
                snapshot.forEach((doc) => {
                    matchesData.push({ id: doc.id, ...doc.data() });
                });
                renderSchedule();
            });
        }

        function renderStandings() {
            if (!teamsData || teamsData.length === 0) {
                document.getElementById('standingsBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            No teams yet. Teams will appear after draft.
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort teams by points, then wins, then game percentage
            const sorted = [...teamsData].sort((a, b) => {
                const aPoints = a.points || 0;
                const bPoints = b.points || 0;
                if (bPoints !== aPoints) return bPoints - aPoints;

                const aWins = a.wins || 0;
                const bWins = b.wins || 0;
                if (bWins !== aWins) return bWins - aWins;

                const aGamesWon = a.games_won || 0;
                const aGamesLost = a.games_lost || 0;
                const bGamesWon = b.games_won || 0;
                const bGamesLost = b.games_lost || 0;
                const aTotal = aGamesWon + aGamesLost;
                const bTotal = bGamesWon + bGamesLost;
                const aPct = aTotal > 0 ? aGamesWon / aTotal : 0;
                const bPct = bTotal > 0 ? bGamesWon / bTotal : 0;
                return bPct - aPct;
            });

            // Render table
            let html = '';
            sorted.forEach((team, index) => {
                const wins = team.wins || 0;
                const losses = team.losses || 0;
                const points = team.points || 0;
                const gamesWon = team.games_won || 0;
                const gamesLost = team.games_lost || 0;
                const totalGames = gamesWon + gamesLost;
                const gamePct = totalGames > 0 ? (gamesWon / totalGames * 100).toFixed(1) : '0.0';

                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';

                html += `
                    <tr>
                        <td><span class="rank-badge ${rankClass}">${index + 1}</span></td>
                        <td style="font-weight: 700;">${team.team_name}</td>
                        <td>${wins}</td>
                        <td>${losses}</td>
                        <td style="font-weight: 800;">${points}</td>
                        <td>${gamesWon}-${gamesLost}</td>
                        <td>${gamePct}%</td>
                    </tr>
                `;
            });

            document.getElementById('standingsBody').innerHTML = html;
        }

        function renderTeams() {
            if (!teamsData || teamsData.length === 0) {
                document.getElementById('teamsContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="font-size: 18px; font-weight: 600;">No teams yet</p>
                        <p style="margin-top: 10px;">Teams will be created after draft</p>
                    </div>
                `;
                return;
            }

            // Sort alphabetically
            const sorted = [...teamsData].sort((a, b) =>
                (a.team_name || '').localeCompare(b.team_name || '')
            );

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
            sorted.forEach(team => {
                const players = team.players || [];
                html += `
                    <div class="team-card">
                        <div class="team-name">${team.team_name}</div>
                        <div class="player-list">
                            ${players.length > 0 ? players.map(p => `
                                <span class="player-badge ${p.position === 1 ? 'captain' : ''}">
                                    P${p.position}: ${p.name}
                                </span>
                            `).join('') : '<span style="opacity: 0.6;">No players assigned</span>'}
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('teamsContainer').innerHTML = html;
        }

        function renderSchedule() {
            if (!matchesData || matchesData.length === 0) {
                document.getElementById('scheduleContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="font-size: 18px; font-weight: 600;">No schedule yet</p>
                        <p style="margin-top: 10px;">Schedule will be generated after teams are set</p>
                    </div>
                `;
                return;
            }

            // Group by week
            const byWeek = {};
            matchesData.forEach(match => {
                const week = match.week || 1;
                if (!byWeek[week]) byWeek[week] = [];
                byWeek[week].push(match);
            });

            let html = '';
            Object.keys(byWeek).sort((a, b) => a - b).forEach(week => {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="font-family: 'Bebas Neue', cursive; font-size: 28px; margin-bottom: 15px; border-bottom: 3px solid var(--pink); padding-bottom: 10px;">
                            Week ${week}
                        </h3>
                        ${byWeek[week].map(match => {
                            const isCompleted = match.status === 'completed';
                            const isInProgress = match.status === 'in_progress';
                            return `
                                <div class="team-card" style="padding: 0; overflow: hidden;">
                                    <div class="match-result">
                                        <div class="match-team home">${match.home_team_name}</div>
                                        <div class="match-score ${!isCompleted && !isInProgress ? 'pending' : ''}">
                                            ${isCompleted || isInProgress ?
                                                `${match.home_score} - ${match.away_score}` :
                                                match.match_date || 'TBD'}
                                        </div>
                                        <div class="match-team away">${match.away_team_name}</div>
                                    </div>
                                    ${isInProgress ? '<div style="background: var(--yellow); padding: 5px; text-align: center; font-weight: 700; font-size: 12px;">IN PROGRESS</div>' : ''}
                                    ${isCompleted ? '<div style="background: var(--teal); padding: 5px; text-align: center; font-weight: 700; font-size: 12px;">FINAL</div>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            });

            document.getElementById('scheduleContainer').innerHTML = html;
        }

        window.switchTab = function(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Show selected tab
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        };
    </script>
</body>
</html>
