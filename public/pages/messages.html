<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Darts Hub - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FF469A">
    <link rel="stylesheet" href="/css/brdc-styles.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { min-height: 100%; }
        body {
            background: linear-gradient(135deg, var(--bg-dark, #1a1a2e) 0%, #0f0f23 100%);
            color: var(--text-primary, #f0f0f0);
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .header-bar {
            background: var(--bg-panel, #16213e);
            border-bottom: 3px solid var(--pink, #FF469A);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .back-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--pink, #FF469A);
        }

        .header-logo {
            width: 40px;
            height: 40px;
        }

        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 3px;
            color: var(--pink, #FF469A);
            flex: 1;
        }

        .login-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: var(--bg-panel, #16213e);
            border: 3px solid #000;
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: 380px;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.4);
            text-align: center;
        }

        .login-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--pink, #FF469A);
            margin-bottom: 20px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 24px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--yellow, #FDD835);
            text-align: center;
            letter-spacing: 4px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--pink, #FF469A);
            background: rgba(255,70,154,0.1);
            box-shadow: 0 0 20px rgba(255,70,154,0.3);
        }

        .form-input::placeholder {
            color: rgba(253, 216, 53, 0.4);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(180deg, var(--pink, #FF469A) 0%, #d63384 100%);
            border: 3px solid #000;
            border-radius: 10px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 2px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
        }

        .main-content {
            display: none;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Main Tabs */
        .main-tabs {
            display: flex;
            background: var(--bg-panel, #16213e);
            border-bottom: 2px solid var(--border, rgba(255, 255, 255, 0.1));
        }

        .main-tab {
            flex: 1;
            padding: 14px 16px;
            text-align: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--text-dim, #8a8aa3);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }

        .main-tab:hover {
            color: var(--text-primary, #f0f0f0);
        }

        .main-tab.active {
            color: var(--pink, #FF469A);
            border-bottom-color: var(--pink, #FF469A);
        }

        .tab-badge {
            position: absolute;
            top: 8px;
            right: calc(50% - 40px);
            background: var(--pink, #FF469A);
            color: white;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* =========== LOBBY TAB =========== */
        .lobby-container {
            padding: 16px;
        }

        .lobby-section {
            margin-bottom: 24px;
        }

        .lobby-section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--teal, #91D7EB);
            letter-spacing: 2px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-count {
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .online-players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 12px;
        }

        .online-player {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: var(--bg-card, #1e2a47);
            border: 2px solid var(--border, rgba(255, 255, 255, 0.1));
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .online-player:hover {
            border-color: var(--pink, #FF469A);
            transform: translateY(-2px);
        }

        .online-player.self {
            border-color: var(--teal, #91D7EB);
            background: rgba(145, 215, 235, 0.1);
        }

        .player-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pink, #FF469A), var(--teal, #91D7EB));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: white;
            position: relative;
            margin-bottom: 6px;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .online-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            background: #4CAF50;
            border: 2px solid var(--bg-card, #1e2a47);
            border-radius: 50%;
        }

        .player-name {
            font-size: 11px;
            color: var(--text-primary, #f0f0f0);
            text-align: center;
            max-width: 70px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Challenges */
        .challenges-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .challenge-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-card, #1e2a47);
            border: 2px solid rgba(255, 70, 154, 0.5);
            border-radius: 12px;
            animation: challengePulse 2s ease-in-out infinite;
        }

        @keyframes challengePulse {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 70, 154, 0.3); }
            50% { box-shadow: 0 0 15px rgba(255, 70, 154, 0.6); }
        }

        .challenge-info {
            flex: 1;
        }

        .challenge-from {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--pink, #FF469A);
        }

        .challenge-type {
            font-size: 12px;
            color: var(--text-dim, #8a8aa3);
        }

        .challenge-actions {
            display: flex;
            gap: 8px;
        }

        .challenge-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid #000;
            transition: transform 0.15s;
        }

        .challenge-btn:hover {
            transform: scale(1.05);
        }

        .challenge-btn.accept {
            background: linear-gradient(180deg, #4CAF50, #2E7D32);
            color: white;
        }

        .challenge-btn.decline {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        /* Active Games */
        .active-games-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .active-game {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-card, #1e2a47);
            border: 2px solid var(--border, rgba(255, 255, 255, 0.1));
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .active-game:hover {
            border-color: var(--teal, #91D7EB);
        }

        .game-players {
            flex: 1;
        }

        .game-vs {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--text-primary, #f0f0f0);
        }

        .game-type-badge {
            padding: 4px 10px;
            background: rgba(145, 215, 235, 0.2);
            color: var(--teal, #91D7EB);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .watch-btn {
            padding: 8px 14px;
            background: var(--teal, #91D7EB);
            color: #000;
            border: 2px solid #000;
            border-radius: 6px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            cursor: pointer;
        }

        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-dim, #8a8aa3);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* =========== CHANNELS TAB =========== */
        .channels-container {
            padding: 16px;
        }

        .channel-group {
            margin-bottom: 24px;
        }

        .channel-group-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 12px;
            color: var(--text-dim, #8a8aa3);
            text-transform: uppercase;
            letter-spacing: 2px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border, rgba(255, 255, 255, 0.1));
            margin-bottom: 10px;
        }

        .channel-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-card, #1e2a47);
            border: 2px solid var(--border, rgba(255, 255, 255, 0.1));
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .channel-item:hover {
            border-color: var(--teal, #91D7EB);
        }

        .channel-item.unread {
            border-color: var(--teal, #91D7EB);
            background: rgba(145, 215, 235, 0.05);
        }

        .channel-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .channel-icon.league { background: rgba(255, 70, 154, 0.2); }
        .channel-icon.team { background: rgba(145, 215, 235, 0.2); }
        .channel-icon.match { background: rgba(253, 216, 53, 0.2); }

        .channel-info {
            flex: 1;
            min-width: 0;
        }

        .channel-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--text-primary, #f0f0f0);
        }

        .channel-preview {
            font-size: 12px;
            color: var(--text-dim, #8a8aa3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            background: var(--pink, #FF469A);
            color: white;
            min-width: 22px;
            height: 22px;
            border-radius: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            padding: 0 6px;
        }

        /* =========== DIRECT TAB =========== */
        .direct-container {
            padding: 16px;
        }

        .dm-bubbles-section {
            margin-bottom: 20px;
        }

        .dm-bubbles-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 8px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .dm-bubbles-scroll::-webkit-scrollbar {
            display: none;
        }

        .dm-bubble {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .dm-bubble-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pink, #FF469A), var(--teal, #91D7EB));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: white;
            position: relative;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .dm-bubble-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .dm-bubble:hover .dm-bubble-avatar {
            border-color: var(--pink, #FF469A);
            transform: scale(1.1);
        }

        .dm-bubble.unread .dm-bubble-avatar {
            border-color: var(--pink, #FF469A);
        }

        .dm-bubble.unread .dm-bubble-avatar::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            background: var(--pink, #FF469A);
            border-radius: 50%;
            border: 2px solid var(--bg-dark, #1a1a2e);
        }

        .dm-bubble-name {
            font-size: 11px;
            color: var(--text-dim, #8a8aa3);
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }

        .dm-bubble.unread .dm-bubble-name {
            color: var(--text-primary, #f0f0f0);
            font-weight: 600;
        }

        .add-dm-bubble {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 2px dashed rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--text-dim, #8a8aa3);
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .add-dm-bubble:hover {
            background: rgba(255, 70, 154, 0.2);
            border-color: var(--pink, #FF469A);
            color: var(--pink, #FF469A);
        }

        /* DM Conversation List */
        .dm-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dm-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-card, #1e2a47);
            border: 2px solid var(--border, rgba(255, 255, 255, 0.1));
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dm-item:hover {
            border-color: var(--pink, #FF469A);
            transform: translateX(4px);
        }

        .dm-item.unread {
            border-color: var(--pink, #FF469A);
            background: rgba(255, 70, 154, 0.05);
        }

        .dm-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pink, #FF469A), var(--teal, #91D7EB));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .dm-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .dm-content {
            flex: 1;
            min-width: 0;
        }

        .dm-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--text-primary, #f0f0f0);
            margin-bottom: 4px;
        }

        .dm-preview {
            font-size: 13px;
            color: var(--text-dim, #8a8aa3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dm-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .dm-time {
            font-size: 11px;
            color: var(--text-dim, #8a8aa3);
        }

        /* Player Action Modal */
        .player-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .player-modal.active {
            display: flex;
        }

        .player-modal-content {
            width: 100%;
            max-width: 340px;
            background: var(--bg-panel, #16213e);
            border: 3px solid #000;
            border-radius: 16px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.5);
            text-align: center;
            padding: 24px;
        }

        .modal-player-avatar {
            width: 80px;
            height: 80px;
            margin: 0 auto 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pink, #FF469A), var(--teal, #91D7EB));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: white;
        }

        .modal-player-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--text-primary, #f0f0f0);
            margin-bottom: 8px;
        }

        .modal-player-status {
            font-size: 13px;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-action-btn {
            padding: 14px;
            border: 2px solid #000;
            border-radius: 10px;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.15s;
        }

        .modal-action-btn:hover {
            transform: scale(1.02);
        }

        .modal-action-btn.challenge {
            background: linear-gradient(180deg, var(--pink, #FF469A), #d63384);
            color: white;
        }

        .modal-action-btn.message {
            background: linear-gradient(180deg, var(--teal, #91D7EB), #5cb8cc);
            color: #000;
        }

        .modal-action-btn.profile {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .modal-action-btn.cancel {
            background: transparent;
            border-color: rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.7);
        }

        /* Search Modal */
        .search-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            padding-top: 60px;
        }

        .search-modal.active {
            display: flex;
        }

        .search-modal-content {
            width: 100%;
            max-width: 500px;
            background: var(--bg-panel, #16213e);
            border: 3px solid #000;
            border-radius: 16px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.5);
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .search-header {
            padding: 16px;
            border-bottom: 2px solid var(--border, rgba(255, 255, 255, 0.1));
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-header .close-btn {
            font-size: 24px;
            color: var(--text-primary, #f0f0f0);
            background: none;
            border: none;
            cursor: pointer;
        }

        .search-input-wrapper {
            flex: 1;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border, rgba(255, 255, 255, 0.1));
            border-radius: 8px;
            color: var(--text-primary, #f0f0f0);
            font-size: 16px;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--pink, #FF469A);
        }

        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .search-result-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pink, #FF469A), var(--teal, #91D7EB));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: white;
        }

        .search-result-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--text-primary, #f0f0f0);
        }

        .search-result-team {
            font-size: 12px;
            color: var(--text-dim, #8a8aa3);
        }

        /* Challenge Modal */
        .challenge-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .challenge-modal.active {
            display: flex;
        }

        .challenge-modal-content {
            width: 100%;
            max-width: 340px;
            background: var(--bg-panel, #16213e);
            border: 3px solid #000;
            border-radius: 16px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.5);
            padding: 24px;
        }

        .challenge-modal-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--pink, #FF469A);
            text-align: center;
            margin-bottom: 20px;
        }

        .game-type-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .game-type-option {
            padding: 16px;
            background: var(--bg-card, #1e2a47);
            border: 2px solid var(--border, rgba(255, 255, 255, 0.1));
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .game-type-option:hover,
        .game-type-option.selected {
            border-color: var(--pink, #FF469A);
            background: rgba(255, 70, 154, 0.1);
        }

        .game-type-icon {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .game-type-label {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--text-primary, #f0f0f0);
        }

        .send-challenge-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(180deg, var(--pink, #FF469A), #d63384);
            border: 3px solid #000;
            border-radius: 10px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .cancel-challenge-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: rgba(255,255,255,0.7);
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Login Screen (visible by default, hidden by JS if already logged in) -->
    <div id="loginPage" class="login-page">
        <img src="/images/gold_logo.png" alt="BRDC" style="width: 80px; margin-bottom: 20px;">
        <div class="login-box">
            <div class="login-tabs" style="display: flex; margin-bottom: 20px;">
                <button class="login-tab active" id="loginTab" onclick="showLoginTab('login')" style="flex: 1; padding: 12px; background: var(--pink, #FF469A); border: 2px solid #000; color: white; font-family: 'Bebas Neue', cursive; font-size: 16px; letter-spacing: 1px; cursor: pointer;">LOGIN</button>
                <button class="login-tab" id="registerTab" onclick="showLoginTab('register')" style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 2px solid #000; color: white; font-family: 'Bebas Neue', cursive; font-size: 16px; letter-spacing: 1px; cursor: pointer;">REGISTER</button>
            </div>

            <div id="loginForm">
                <div class="login-title">DARTS HUB</div>
                <p style="color: var(--text-dim, #8a8aa3); margin-bottom: 20px; font-size: 14px;">Enter your PIN to join the lobby</p>
                <input type="password" id="pinInput" class="form-input" placeholder="........" maxlength="8" inputmode="numeric">
                <button id="loginBtn" class="login-btn" onclick="login()">LOGIN</button>
            </div>

            <div id="registerForm" style="display: none;">
                <div class="login-title">CREATE ACCOUNT</div>
                <p style="color: var(--text-dim, #8a8aa3); margin-bottom: 20px; font-size: 14px;">Register to join the lobby</p>
                <input type="text" id="regFirstName" class="form-input" placeholder="First Name" style="letter-spacing: 0; text-align: left; margin-bottom: 12px;">
                <input type="text" id="regLastName" class="form-input" placeholder="Last Name" style="letter-spacing: 0; text-align: left; margin-bottom: 12px;">
                <input type="tel" id="regPhone" class="form-input" placeholder="Phone (required)" style="letter-spacing: 0; text-align: left; margin-bottom: 12px;">
                <input type="email" id="regEmail" class="form-input" placeholder="Email (optional)" style="letter-spacing: 0; text-align: left; margin-bottom: 12px;">
                <button class="login-btn" onclick="registerPlayer()">REGISTER</button>
            </div>

            <button onclick="window.location.href='/pages/dashboard.html'" style="width: 100%; margin-top: 15px; padding: 12px; background: transparent; border: 2px solid rgba(255,255,255,0.3); color: rgba(255,255,255,0.7); font-family: 'Bebas Neue', cursive; font-size: 16px; letter-spacing: 1px; cursor: pointer; border-radius: 8px;">CANCEL</button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="main-content">
        <div class="header-bar">
            <button class="back-btn" onclick="window.location.href='/pages/dashboard.html'">< BACK</button>
            <img src="/images/gold_logo.png" alt="BRDC" class="header-logo">
            <span class="header-title">DARTS HUB</span>
        </div>

        <!-- Main Tabs -->
        <div class="main-tabs">
            <div class="main-tab active" data-tab="lobby" onclick="switchTab('lobby')">
                LOBBY
                <span id="lobbyBadge" class="tab-badge" style="display: none;">0</span>
            </div>
            <div class="main-tab" data-tab="channels" onclick="switchTab('channels')">
                CHANNELS
                <span id="channelsBadge" class="tab-badge" style="display: none;">0</span>
            </div>
            <div class="main-tab" data-tab="direct" onclick="switchTab('direct')">
                DIRECT
                <span id="directBadge" class="tab-badge" style="display: none;">0</span>
            </div>
        </div>

        <!-- LOBBY TAB -->
        <div id="lobbyTab" class="tab-content active">
            <div class="lobby-container">
                <!-- Pending Challenges -->
                <div id="challengesSection" class="lobby-section" style="display: none;">
                    <div class="lobby-section-title">
                        INCOMING CHALLENGES
                    </div>
                    <div id="challengesList" class="challenges-list"></div>
                </div>

                <!-- Active Games -->
                <div id="activeGamesSection" class="lobby-section" style="display: none;">
                    <div class="lobby-section-title">
                        LIVE GAMES
                    </div>
                    <div id="activeGamesList" class="active-games-list"></div>
                </div>

                <!-- Online Players -->
                <div class="lobby-section">
                    <div class="lobby-section-title">
                        ONLINE NOW
                        <span id="onlineCount" class="online-count">0</span>
                    </div>
                    <div id="onlinePlayersList" class="online-players-grid">
                        <div class="empty-state">
                            <div class="empty-icon">...</div>
                            <p>Loading players...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CHANNELS TAB -->
        <div id="channelsTab" class="tab-content">
            <div class="channels-container">
                <div id="leagueChannels" class="channel-group" style="display: none;">
                    <div class="channel-group-title">LEAGUE CHANNELS</div>
                    <div id="leagueChannelsList"></div>
                </div>
                <div id="teamChannels" class="channel-group" style="display: none;">
                    <div class="channel-group-title">TEAM CHANNELS</div>
                    <div id="teamChannelsList"></div>
                </div>
                <div id="matchChannels" class="channel-group" style="display: none;">
                    <div class="channel-group-title">MATCH CHANNELS</div>
                    <div id="matchChannelsList"></div>
                </div>
                <div id="noChannels" class="empty-state">
                    <div class="empty-icon">...</div>
                    <p>Loading channels...</p>
                </div>
            </div>
        </div>

        <!-- DIRECT TAB -->
        <div id="directTab" class="tab-content">
            <div class="direct-container">
                <!-- Horizontal Bubbles -->
                <div class="dm-bubbles-section">
                    <div class="dm-bubbles-scroll" id="dmBubblesScroll">
                        <div class="add-dm-bubble" onclick="openSearchModal()">+</div>
                        <!-- Bubbles will be inserted here -->
                    </div>
                </div>

                <!-- Full Conversation List -->
                <div id="dmList" class="dm-list">
                    <div class="empty-state">
                        <div class="empty-icon">...</div>
                        <p>Loading conversations...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Player Action Modal -->
    <div id="playerModal" class="player-modal">
        <div class="player-modal-content">
            <div id="modalPlayerAvatar" class="modal-player-avatar">JD</div>
            <div id="modalPlayerName" class="modal-player-name">John Doe</div>
            <div id="modalPlayerStatus" class="modal-player-status">Online</div>
            <div class="modal-actions">
                <button class="modal-action-btn challenge" onclick="openChallengeModal()">CHALLENGE TO GAME</button>
                <button class="modal-action-btn message" onclick="startDM()">SEND MESSAGE</button>
                <button class="modal-action-btn profile" onclick="viewProfile()">VIEW PROFILE</button>
                <button class="modal-action-btn cancel" onclick="closePlayerModal()">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="searchModal" class="search-modal">
        <div class="search-modal-content">
            <div class="search-header">
                <button class="close-btn" onclick="closeSearchModal()">x</button>
                <div class="search-input-wrapper">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search players..." oninput="searchPlayers()">
                </div>
            </div>
            <div id="searchResults" class="search-results">
                <div class="empty-state">
                    <div class="empty-icon">...</div>
                    <p>Type a name to search</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Challenge Modal -->
    <div id="challengeModal" class="challenge-modal">
        <div class="challenge-modal-content">
            <div class="challenge-modal-title">CHALLENGE <span id="challengeTargetName">PLAYER</span></div>
            <div class="game-type-options">
                <div class="game-type-option selected" data-type="501" onclick="selectGameType('501')">
                    <div class="game-type-icon">501</div>
                    <div class="game-type-label">501</div>
                </div>
                <div class="game-type-option" data-type="301" onclick="selectGameType('301')">
                    <div class="game-type-icon">301</div>
                    <div class="game-type-label">301</div>
                </div>
                <div class="game-type-option" data-type="cricket" onclick="selectGameType('cricket')">
                    <div class="game-type-icon">C</div>
                    <div class="game-type-label">CRICKET</div>
                </div>
                <div class="game-type-option" data-type="around" onclick="selectGameType('around')">
                    <div class="game-type-icon">A</div>
                    <div class="game-type-label">AROUND</div>
                </div>
            </div>
            <button class="send-challenge-btn" onclick="sendChallenge()">SEND CHALLENGE</button>
            <button class="cancel-challenge-btn" onclick="closeChallengeModal()">CANCEL</button>
        </div>
    </div>

    <!-- Fallback for when module fails to load -->
    <script>
        window.login = function() { alert('Still loading... please wait a moment and try again.'); };
        window.register = function() { alert('Still loading... please wait a moment and try again.'); };
        window.showLoginTab = function() {};
        setTimeout(function() {
            if (!window._moduleLoaded) {
                alert('Page failed to fully load. Try refreshing or use a non-private browser window.');
            }
        }, 5000);
    </script>

    <script type="module">
        import { db, collection, query, where, orderBy, onSnapshot, doc, setDoc, deleteDoc, callFunction, serverTimestamp } from '/js/firebase-config.js';
        window._moduleLoaded = true;

        // Push notification functions (loaded dynamically later)
        let initializePushNotifications = async () => false;
        let areNotificationsEnabled = () => false;

        // Safe localStorage wrapper for private browsing
        const safeStorage = {
            getItem: (key) => {
                try { return localStorage.getItem(key); } catch (e) { return null; }
            },
            setItem: (key, value) => {
                try { localStorage.setItem(key, value); } catch (e) { console.warn('Storage unavailable'); }
            },
            removeItem: (key) => {
                try { localStorage.removeItem(key); } catch (e) { }
            }
        };

        let currentPlayer = null;
        let playerPin = null;
        let selectedPlayer = null;
        let selectedGameType = '501';
        let unsubscribePresence = null;
        let unsubscribeChallenges = null;
        let unsubscribeConversations = null;
        let unsubscribeChatRooms = null;
        let searchTimeout = null;
        let presenceInterval = null;

        // Check for stored PIN
        window.addEventListener('DOMContentLoaded', async () => {
            // Load push notifications module (fail-safe)
            try {
                const pushModule = await import('/js/push-notifications.js');
                initializePushNotifications = pushModule.initializePushNotifications;
                areNotificationsEnabled = pushModule.areNotificationsEnabled;
            } catch (e) {
                console.warn('Push notifications not available:', e.message);
            }
            const storedPin = safeStorage.getItem('brdc_player_pin');
            if (storedPin) {
                try {
                    const result = await callFunction('getConversations', { player_pin: storedPin });
                    if (result.success) {
                        playerPin = storedPin;
                        currentPlayer = {
                            id: result.player_id,
                            name: result.player_name || 'Player'
                        };
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('mainContent').style.display = 'block';
                        initializeLobby();
                        return;
                    }
                } catch (error) {
                    console.error('Session check failed:', error);
                }
                safeStorage.removeItem('brdc_player_pin');
            }

            // Show login page (already visible by default, but ensure it's shown)
            document.getElementById('pinInput').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') login();
            });
        });

        // Tab switching
        window.showLoginTab = function(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (tab === 'login') {
                loginTab.style.background = 'var(--pink, #FF469A)';
                registerTab.style.background = 'rgba(255,255,255,0.1)';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                loginTab.style.background = 'rgba(255,255,255,0.1)';
                registerTab.style.background = 'var(--pink, #FF469A)';
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }
        };

        window.registerPlayer = async function() {
            const firstName = document.getElementById('regFirstName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const email = document.getElementById('regEmail').value.trim();

            if (!firstName || !lastName) {
                alert('Please enter your first and last name');
                return;
            }
            if (!phone || phone.length < 10) {
                alert('Please enter a valid phone number');
                return;
            }

            try {
                const result = await callFunction('registerPlayerSimple', {
                    first_name: firstName,
                    last_name: lastName,
                    phone: phone,
                    email: email || null
                });

                if (result.success) {
                    alert(`Registration successful!\n\nYour PIN: ${result.pin}\n\nSave this PIN to log in!`);
                    document.getElementById('pinInput').value = result.pin;
                    showLoginTab('login');
                    login();
                } else {
                    alert(result.error || 'Registration failed');
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed. Please try again.');
            }
        };

        window.login = async function() {
            const pin = document.getElementById('pinInput').value.trim();
            if (!pin) return;

            try {
                const result = await callFunction('getConversations', { player_pin: pin });

                if (result.success) {
                    playerPin = pin;
                    currentPlayer = {
                        id: result.player_id,
                        name: result.player_name || 'Player'
                    };
                    safeStorage.setItem('brdc_player_pin', pin);

                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';

                    initializeLobby();
                } else {
                    alert('Invalid PIN');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        };

        function initializeLobby() {
            // Set up presence
            updatePresence();
            presenceInterval = setInterval(updatePresence, 30000); // Update every 30s

            // Initialize push notifications (prompt if not enabled)
            if (currentPlayer?.id) {
                initializePushNotifications(currentPlayer.id).then(enabled => {
                    console.log('Push notifications:', enabled ? 'enabled' : 'not enabled');
                });
            }

            // Load all data
            loadOnlinePlayers();
            loadChallenges();
            loadChannels();
            loadConversations();
            setupRealtimeListeners();
        }

        async function updatePresence() {
            if (!currentPlayer?.id) return;
            try {
                const presenceRef = doc(db, 'presence', currentPlayer.id);
                await setDoc(presenceRef, {
                    player_id: currentPlayer.id,
                    player_name: currentPlayer.name,
                    last_seen: new Date(),
                    status: 'online'
                }, { merge: true });
            } catch (error) {
                console.error('Error updating presence:', error);
            }
        }

        async function loadOnlinePlayers() {
            // Listen for online players (active in last 5 minutes)
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
            const presenceRef = collection(db, 'presence');
            const q = query(presenceRef, where('last_seen', '>=', fiveMinutesAgo));

            unsubscribePresence = onSnapshot(q, (snapshot) => {
                const players = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    players.push({
                        id: doc.id,
                        name: data.player_name || 'Unknown',
                        photo: data.photo || null,
                        isSelf: doc.id === currentPlayer?.id
                    });
                });

                renderOnlinePlayers(players);
                document.getElementById('onlineCount').textContent = players.length;
            });
        }

        function renderOnlinePlayers(players) {
            const container = document.getElementById('onlinePlayersList');

            if (players.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">...</div>
                        <p>No players online</p>
                    </div>
                `;
                return;
            }

            // Sort: self first, then alphabetically
            players.sort((a, b) => {
                if (a.isSelf) return -1;
                if (b.isSelf) return 1;
                return a.name.localeCompare(b.name);
            });

            container.innerHTML = players.map(player => {
                const initials = getInitials(player.name);
                return `
                    <div class="online-player ${player.isSelf ? 'self' : ''}"
                         onclick="${player.isSelf ? '' : `openPlayerModal('${player.id}', '${escapeHtml(player.name)}')`}">
                        <div class="player-avatar">
                            ${player.photo ? `<img src="${player.photo}" alt="">` : initials}
                            <div class="online-dot"></div>
                        </div>
                        <div class="player-name">${player.isSelf ? 'YOU' : player.name.split(' ')[0]}</div>
                    </div>
                `;
            }).join('');
        }

        function loadChallenges() {
            if (!currentPlayer?.id) return;

            const challengesRef = collection(db, 'challenges');
            const q = query(challengesRef, where('target_id', '==', currentPlayer.id), where('status', '==', 'pending'));

            unsubscribeChallenges = onSnapshot(q, (snapshot) => {
                const challenges = [];
                snapshot.forEach(doc => {
                    challenges.push({ id: doc.id, ...doc.data() });
                });

                const section = document.getElementById('challengesSection');
                const badge = document.getElementById('lobbyBadge');

                if (challenges.length > 0) {
                    section.style.display = 'block';
                    badge.textContent = challenges.length;
                    badge.style.display = 'flex';
                    renderChallenges(challenges);
                } else {
                    section.style.display = 'none';
                    badge.style.display = 'none';
                }
            });
        }

        function renderChallenges(challenges) {
            const container = document.getElementById('challengesList');
            container.innerHTML = challenges.map(c => `
                <div class="challenge-card">
                    <div class="challenge-info">
                        <div class="challenge-from">${c.challenger_name}</div>
                        <div class="challenge-type">${c.game_type || '501'} Challenge</div>
                    </div>
                    <div class="challenge-actions">
                        <button class="challenge-btn accept" onclick="acceptChallenge('${c.id}')">ACCEPT</button>
                        <button class="challenge-btn decline" onclick="declineChallenge('${c.id}')">DECLINE</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadChannels() {
            try {
                const result = await callFunction('getPlayerChatRooms', { player_pin: playerPin });
                if (result.success) {
                    renderChannels(result.rooms);
                }
            } catch (error) {
                console.error('Error loading channels:', error);
            }
        }

        function renderChannels(rooms) {
            const noChannels = document.getElementById('noChannels');
            let hasAny = false;

            // League channels
            if (rooms.league && rooms.league.length > 0) {
                hasAny = true;
                document.getElementById('leagueChannels').style.display = 'block';
                document.getElementById('leagueChannelsList').innerHTML = rooms.league.map(r => renderChannelItem(r, 'league')).join('');
            }

            // Team channels
            if (rooms.team && rooms.team.length > 0) {
                hasAny = true;
                document.getElementById('teamChannels').style.display = 'block';
                document.getElementById('teamChannelsList').innerHTML = rooms.team.map(r => renderChannelItem(r, 'team')).join('');
            }

            // Match channels
            if (rooms.match && rooms.match.length > 0) {
                hasAny = true;
                document.getElementById('matchChannels').style.display = 'block';
                document.getElementById('matchChannelsList').innerHTML = rooms.match.map(r => renderChannelItem(r, 'match')).join('');
            }

            noChannels.style.display = hasAny ? 'none' : 'block';
            if (!hasAny) {
                noChannels.innerHTML = `
                    <div class="empty-icon">C</div>
                    <p>No channels yet. Join a league or team to access channels.</p>
                `;
            }

            // Update badge
            const totalUnread = [...(rooms.league || []), ...(rooms.team || []), ...(rooms.match || [])]
                .reduce((sum, r) => sum + (r.unread_count || 0), 0);
            const badge = document.getElementById('channelsBadge');
            if (totalUnread > 0) {
                badge.textContent = totalUnread;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function renderChannelItem(room, type) {
            const icons = { league: '!', team: '#', match: '@' };
            const preview = room.last_message?.text || 'No messages yet';
            return `
                <div class="channel-item ${room.unread_count > 0 ? 'unread' : ''}" onclick="openChannel('${room.id}')">
                    <div class="channel-icon ${type}">${icons[type]}</div>
                    <div class="channel-info">
                        <div class="channel-name">${room.name}</div>
                        <div class="channel-preview">${escapeHtml(preview.substring(0, 40))}${preview.length > 40 ? '...' : ''}</div>
                    </div>
                    ${room.unread_count > 0 ? `<div class="unread-badge">${room.unread_count}</div>` : ''}
                </div>
            `;
        }

        async function loadConversations() {
            try {
                const result = await callFunction('getConversations', { player_pin: playerPin });
                if (result.success) {
                    renderConversations(result.conversations);
                }
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        function renderConversations(conversations) {
            // Render bubbles
            const bubblesContainer = document.getElementById('dmBubblesScroll');
            const addButton = bubblesContainer.querySelector('.add-dm-bubble');

            // Clear existing bubbles except add button
            bubblesContainer.innerHTML = '';
            bubblesContainer.appendChild(addButton);

            // Render list
            const listContainer = document.getElementById('dmList');

            if (!conversations || conversations.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">M</div>
                        <p>No messages yet. Tap + to start a conversation.</p>
                    </div>
                `;
                return;
            }

            // Add bubbles (limited to first 10)
            conversations.slice(0, 10).forEach(conv => {
                const initials = getInitials(conv.other_participant.name);
                const bubble = document.createElement('div');
                bubble.className = `dm-bubble ${conv.unread_count > 0 ? 'unread' : ''}`;
                bubble.onclick = () => openConversation(conv.id);
                bubble.innerHTML = `
                    <div class="dm-bubble-avatar">
                        ${conv.other_participant.photo ? `<img src="${conv.other_participant.photo}" alt="">` : initials}
                    </div>
                    <div class="dm-bubble-name">${conv.other_participant.name.split(' ')[0]}</div>
                `;
                bubblesContainer.appendChild(bubble);
            });

            // Render full list
            listContainer.innerHTML = conversations.map(conv => {
                const initials = getInitials(conv.other_participant.name);
                const preview = conv.last_message?.text || 'No messages yet';
                const time = conv.updated_at ? formatTime(conv.updated_at) : '';
                return `
                    <div class="dm-item ${conv.unread_count > 0 ? 'unread' : ''}" onclick="openConversation('${conv.id}')">
                        <div class="dm-avatar">
                            ${conv.other_participant.photo ? `<img src="${conv.other_participant.photo}" alt="">` : initials}
                        </div>
                        <div class="dm-content">
                            <div class="dm-name">${conv.other_participant.name}</div>
                            <div class="dm-preview">${escapeHtml(preview)}</div>
                        </div>
                        <div class="dm-meta">
                            <div class="dm-time">${time}</div>
                            ${conv.unread_count > 0 ? `<div class="unread-badge">${conv.unread_count}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Update badge
            const totalUnread = conversations.reduce((sum, c) => sum + (c.unread_count || 0), 0);
            const badge = document.getElementById('directBadge');
            if (totalUnread > 0) {
                badge.textContent = totalUnread;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function setupRealtimeListeners() {
            if (!currentPlayer?.id) return;

            // Listen for conversation updates
            const conversationsRef = collection(db, 'conversations');
            const convQuery = query(conversationsRef, where('participants', 'array-contains', currentPlayer.id));

            unsubscribeConversations = onSnapshot(convQuery, (snapshot) => {
                const conversations = [];
                let totalUnread = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const otherParticipantId = data.participants.find(p => p !== currentPlayer.id);
                    const unread = data.unread_count?.[currentPlayer.id] || 0;
                    totalUnread += unread;

                    conversations.push({
                        id: doc.id,
                        other_participant: {
                            id: otherParticipantId,
                            name: data.participant_names?.[otherParticipantId] || 'Unknown',
                            photo: data.participant_photos?.[otherParticipantId] || null
                        },
                        last_message: data.last_message,
                        unread_count: unread,
                        updated_at: data.updated_at?.toDate?.()?.toISOString() || null
                    });
                });

                conversations.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                renderConversations(conversations);
            });

            // Listen for chat room updates
            const roomsRef = collection(db, 'chat_rooms');
            const roomsQuery = query(roomsRef, where('participants', 'array-contains', currentPlayer.id));

            unsubscribeChatRooms = onSnapshot(roomsQuery, (snapshot) => {
                const rooms = { league: [], team: [], match: [] };

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const roomData = {
                        id: doc.id,
                        name: data.name,
                        type: data.type,
                        unread_count: data.unread_count?.[currentPlayer.id] || 0,
                        last_message: data.last_message,
                        status: data.status
                    };

                    if (data.type === 'league') rooms.league.push(roomData);
                    else if (data.type === 'team') rooms.team.push(roomData);
                    else if (data.type === 'match' && data.status === 'active') rooms.match.push(roomData);
                });

                renderChannels(rooms);
            });
        }

        // Tab switching
        window.switchTab = function(tab) {
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`.main-tab[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(`${tab}Tab`).classList.add('active');
        };

        // Player modal
        window.openPlayerModal = function(playerId, playerName) {
            selectedPlayer = { id: playerId, name: playerName };
            document.getElementById('modalPlayerName').textContent = playerName;
            document.getElementById('modalPlayerAvatar').textContent = getInitials(playerName);
            document.getElementById('playerModal').classList.add('active');
        };

        window.closePlayerModal = function() {
            document.getElementById('playerModal').classList.remove('active');
            selectedPlayer = null;
        };

        window.openChallengeModal = function() {
            if (!selectedPlayer) return;
            document.getElementById('challengeTargetName').textContent = selectedPlayer.name;
            document.getElementById('challengeModal').classList.add('active');
            closePlayerModal();
        };

        window.closeChallengeModal = function() {
            document.getElementById('challengeModal').classList.remove('active');
        };

        window.selectGameType = function(type) {
            selectedGameType = type;
            document.querySelectorAll('.game-type-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`.game-type-option[data-type="${type}"]`).classList.add('selected');
        };

        window.sendChallenge = async function() {
            if (!selectedPlayer || !currentPlayer) return;

            try {
                await setDoc(doc(collection(db, 'challenges')), {
                    challenger_id: currentPlayer.id,
                    challenger_name: currentPlayer.name,
                    target_id: selectedPlayer.id,
                    target_name: selectedPlayer.name,
                    game_type: selectedGameType,
                    status: 'pending',
                    created_at: new Date()
                });

                closeChallengeModal();
                alert(`Challenge sent to ${selectedPlayer.name}!`);
            } catch (error) {
                console.error('Error sending challenge:', error);
                alert('Failed to send challenge');
            }
        };

        window.acceptChallenge = async function(challengeId) {
            try {
                const challengeRef = doc(db, 'challenges', challengeId);
                const challengeSnap = await challengeRef.get ? await challengeRef.get() : null;

                // Update challenge status
                await setDoc(challengeRef, { status: 'accepted' }, { merge: true });

                // Navigate to game setup
                alert('Challenge accepted! Redirecting to game...');
                // Could redirect to game setup page here
            } catch (error) {
                console.error('Error accepting challenge:', error);
            }
        };

        window.declineChallenge = async function(challengeId) {
            try {
                await deleteDoc(doc(db, 'challenges', challengeId));
            } catch (error) {
                console.error('Error declining challenge:', error);
            }
        };

        window.startDM = async function() {
            if (!selectedPlayer) return;

            try {
                const result = await callFunction('startConversation', {
                    initiator_pin: playerPin,
                    recipient_id: selectedPlayer.id
                });

                if (result.success) {
                    closePlayerModal();
                    window.location.href = `/pages/conversation.html?id=${result.conversation_id}`;
                }
            } catch (error) {
                console.error('Error starting conversation:', error);
            }
        };

        window.viewProfile = function() {
            if (!selectedPlayer) return;
            closePlayerModal();
            window.location.href = `/pages/player-public.html?id=${selectedPlayer.id}`;
        };

        window.openConversation = function(conversationId) {
            window.location.href = `/pages/conversation.html?id=${conversationId}`;
        };

        window.openChannel = function(roomId) {
            window.location.href = `/pages/chat-room.html?id=${roomId}`;
        };

        // Search
        window.openSearchModal = function() {
            document.getElementById('searchModal').classList.add('active');
            document.getElementById('searchInput').focus();
        };

        window.closeSearchModal = function() {
            document.getElementById('searchModal').classList.remove('active');
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">...</div>
                    <p>Type a name to search</p>
                </div>
            `;
        };

        window.searchPlayers = function() {
            clearTimeout(searchTimeout);
            const queryText = document.getElementById('searchInput').value.trim();

            if (queryText.length < 2) {
                document.getElementById('searchResults').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">...</div>
                        <p>Type at least 2 characters</p>
                    </div>
                `;
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const result = await callFunction('searchPlayersForChat', {
                        player_pin: playerPin,
                        search_query: queryText
                    });

                    if (result.success && result.players.length > 0) {
                        document.getElementById('searchResults').innerHTML = result.players.map(player => {
                            const initials = getInitials(player.name);
                            return `
                                <div class="search-result-item" onclick="startConversationWith('${player.id}', '${escapeHtml(player.name)}')">
                                    <div class="search-result-avatar">
                                        ${player.photo ? `<img src="${player.photo}" alt="" style="width:100%;height:100%;border-radius:50%;">` : initials}
                                    </div>
                                    <div>
                                        <div class="search-result-name">${player.name}</div>
                                        ${player.team_name ? `<div class="search-result-team">${player.team_name}</div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        document.getElementById('searchResults').innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">?</div>
                                <p>No players found matching "${escapeHtml(queryText)}"</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        };

        window.startConversationWith = async function(recipientId, recipientName) {
            try {
                const result = await callFunction('startConversation', {
                    initiator_pin: playerPin,
                    recipient_id: recipientId
                });

                if (result.success) {
                    closeSearchModal();
                    window.location.href = `/pages/conversation.html?id=${result.conversation_id}`;
                }
            } catch (error) {
                console.error('Error starting conversation:', error);
                alert('Failed to start conversation');
            }
        };

        // Helpers
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd';

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', async () => {
            if (presenceInterval) clearInterval(presenceInterval);
            if (unsubscribePresence) unsubscribePresence();
            if (unsubscribeChallenges) unsubscribeChallenges();
            if (unsubscribeConversations) unsubscribeConversations();
            if (unsubscribeChatRooms) unsubscribeChatRooms();

            // Mark as offline
            if (currentPlayer?.id) {
                try {
                    await deleteDoc(doc(db, 'presence', currentPlayer.id));
                } catch (e) {}
            }
        });
    </script>
<script src="/js/feedback.js"></script>
</body>
</html>
