<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Hub - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BRDC">
    <link rel="apple-touch-icon" href="/images/white_logo.jpg">
    <meta name="theme-color" content="#FF469A">
    <style>
        :root {
            --bg-dark: #0a0a1a;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --text-light: #f0f0f0;
            --text-dim: #8a8aa3;
            --black: #000000;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            min-height: 100vh;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            color: var(--text-light);
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .header-logo {
            width: 40px;
            height: 40px;
            mix-blend-mode: multiply;
            filter: drop-shadow(0 0 8px rgba(255, 70, 154, 0.5));
        }
        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 3px;
            color: var(--pink);
        }
        .back-btn {
            background: var(--bg-card);
            border: 2px solid var(--text-dim);
            border-radius: 8px;
            padding: 10px 16px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .back-btn:hover {
            border-color: var(--pink);
            color: var(--pink);
        }

        .pin-entry {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .pin-card {
            background: var(--bg-panel);
            border: 3px solid var(--pink);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(255, 70, 154, 0.2);
            padding: 50px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        .pin-input-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 30px 0;
        }
        .pin-char {
            width: 50px;
            height: 60px;
            border: 3px solid var(--text-dim);
            border-radius: 8px;
            font-size: 28px;
            text-align: center;
            font-family: 'Bebas Neue', cursive;
            text-transform: uppercase;
            background: var(--bg-card);
            color: var(--text-light);
        }
        .pin-char:focus {
            outline: none;
            border-color: var(--pink);
            background: var(--bg-card);
            box-shadow: 0 0 12px rgba(255, 70, 154, 0.4);
        }
        .match-header {
            background: linear-gradient(135deg, var(--pink) 0%, #d63384 100%);
            padding: 25px;
            text-align: center;
            border-radius: 16px 16px 0 0;
        }
        .team-vs-team {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            padding: 30px;
            align-items: center;
            background: var(--bg-card);
        }
        .team-block {
            text-align: center;
        }
        .team-block.home { border-right: 2px solid var(--text-dim); padding-right: 30px; }
        .team-block.away { border-left: 2px solid var(--text-dim); padding-left: 30px; }
        .team-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            margin-bottom: 15px;
            color: var(--text-light);
        }
        .team-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 72px;
            color: var(--pink);
            text-shadow: 0 0 20px rgba(255, 70, 154, 0.4);
        }
        .team-players {
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-dim);
        }
        .vs-badge {
            width: 70px;
            height: 70px;
            background: var(--yellow);
            border: 3px solid var(--black);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--black);
        }
        .games-grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
            background: var(--bg-dark);
            max-width: 600px;
            margin: 0 auto;
        }
        @media (max-width: 600px) {
            .team-vs-team { grid-template-columns: 1fr; gap: 20px; }
            .team-block.home, .team-block.away { border: none; padding: 0; }
        }
        .game-card {
            background: var(--bg-card);
            border: 3px solid var(--text-dim);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }
        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            border-color: var(--teal);
        }
        .game-card.pending { border-color: var(--text-dim); }
        .game-card.in_progress { border-color: var(--yellow); background: rgba(253, 216, 53, 0.1); }
        .game-card.completed { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .game-header {
            padding: 12px 15px;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }
        .game-header.pending { background: var(--bg-panel); color: var(--text-dim); }
        .game-header.in_progress { background: var(--yellow); color: var(--black); }
        .game-header.completed { background: #10b981; color: white; }
        .game-body {
            padding: 15px;
        }
        .game-format {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 4px 8px;
            background: var(--teal);
            border-radius: 4px;
            color: var(--black);
            display: inline-block;
        }
        .game-players {
            margin-top: 12px;
            font-size: 13px;
            line-height: 1.6;
        }
        .game-players .home { color: var(--pink); font-weight: 700; }
        .game-players .away { color: var(--teal); font-weight: 700; }
        .game-result {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .legs-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--text-light);
        }
        .winner-badge {
            background: #10b981;
            color: white;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            border-radius: 4px;
        }
        .match-actions {
            padding: 20px 30px;
            background: var(--bg-panel);
            border-top: 2px solid rgba(255,255,255,0.1);
            border-radius: 0 0 16px 16px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Button styles */
        .brdc-btn {
            background: linear-gradient(135deg, var(--pink) 0%, #d63384 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 28px;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(255, 70, 154, 0.3);
        }
        .brdc-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 70, 154, 0.4);
        }
        .brdc-btn-secondary {
            background: var(--bg-card);
            border: 2px solid var(--text-dim);
            box-shadow: none;
        }
        .brdc-btn-secondary:hover {
            border-color: var(--teal);
            box-shadow: 0 4px 12px rgba(145, 215, 235, 0.2);
        }

        /* Card styles */
        .brdc-card {
            background: var(--bg-panel);
            border-radius: 16px;
            border: 2px solid rgba(255,255,255,0.1);
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .brdc-title {
            font-family: 'Bebas Neue', cursive;
            margin: 0;
        }

        /* Choice Modal */
        .choice-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .choice-modal-overlay.show {
            display: flex;
        }
        .choice-modal {
            background: var(--bg-panel);
            border: 3px solid var(--pink);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(255, 70, 154, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .choice-modal-header {
            background: linear-gradient(135deg, var(--pink) 0%, #d63384 100%);
            padding: 20px;
            border-radius: 12px 12px 0 0;
        }
        .choice-modal-header h2 {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: white;
            margin: 0;
        }
        .choice-modal-body {
            padding: 25px;
        }
        .choice-modal-body p {
            margin-bottom: 20px;
            color: var(--text-dim);
        }
        .choice-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .choice-option {
            padding: 18px 24px;
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            border: 3px solid var(--text-dim);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .choice-option:hover {
            background: var(--teal);
            color: var(--black);
            border-color: var(--teal);
            transform: translateY(-2px);
        }
        .choice-option.x01 { background: rgba(253, 216, 53, 0.2); border-color: var(--yellow); }
        .choice-option.cricket { background: rgba(16, 185, 129, 0.2); border-color: #10b981; }
        .choice-cancel {
            margin-top: 20px;
            padding: 12px 24px;
            background: var(--bg-card);
            border: 2px solid var(--text-dim);
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.2s;
        }
        .choice-cancel:hover {
            border-color: var(--pink);
            color: var(--pink);
        }
    </style>
</head>
<body>
    <!-- PIN Entry Screen -->
    <div id="pinEntry" class="pin-entry">
        <div class="pin-card">
            <img src="/images/white_logo.jpg" alt="BRDC" style="width: 80px; margin-bottom: 20px; mix-blend-mode: screen;">
            <h1 style="font-family: 'Bebas Neue', cursive; font-size: 36px;">MATCH HUB</h1>
            <p style="color: var(--text-dim); margin-top: 10px;">Enter your match PIN to begin scoring</p>
            
            <div class="pin-input-group">
                <input type="text" maxlength="1" class="pin-char" inputmode="text">
                <input type="text" maxlength="1" class="pin-char" inputmode="text">
                <input type="text" maxlength="1" class="pin-char" inputmode="text">
                <input type="text" maxlength="1" class="pin-char" inputmode="text">
                <input type="text" maxlength="1" class="pin-char" inputmode="text">
                <input type="text" maxlength="1" class="pin-char" inputmode="text">
            </div>
            
            <button id="loadMatchBtn" class="brdc-btn" style="width: 100%;">LOAD MATCH</button>
            <p id="pinError" style="color: #ef4444; margin-top: 20px; display: none;"></p>
        </div>
    </div>

    <!-- Match Hub Screen -->
    <div id="matchHub" style="display: none;">
        <div class="header-bar">
            <button class="back-btn" onclick="exitMatch()">‚Üê EXIT</button>
            <img src="/images/white_logo.jpg" alt="BRDC" class="header-logo">
            <span class="header-title">MATCH HUB</span>
        </div>
        <div class="brdc-card" style="max-width: 1200px; margin: 20px auto;">
            <div class="match-header">
                <h1 class="brdc-title" style="font-size: 28px; color: white; margin: 0;">üéØ MATCH IN PROGRESS</h1>
                <p style="color: white; opacity: 0.9; margin-top: 8px;" id="matchInfo">Week 1 ‚Ä¢ Wednesday Night League</p>
            </div>

            <div class="team-vs-team">
                <div class="team-block home">
                    <div class="team-title" id="homeTeamName">Home Team</div>
                    <div class="team-score" id="homeTeamScore">0</div>
                    <div class="team-players" id="homeTeamPlayers"></div>
                </div>
                
                <div class="vs-badge">VS</div>
                
                <div class="team-block away">
                    <div class="team-title" id="awayTeamName">Away Team</div>
                    <div class="team-score" id="awayTeamScore">0</div>
                    <div class="team-players" id="awayTeamPlayers"></div>
                </div>
            </div>

            <div class="games-grid" id="gamesGrid">
                <!-- Games populated dynamically -->
            </div>

            <div class="match-actions">
                <button class="brdc-btn brdc-btn-secondary" onclick="refreshMatch()">üîÑ REFRESH</button>
                <button class="brdc-btn" onclick="exitMatch()">üö™ EXIT MATCH</button>
            </div>
        </div>
    </div>

    <!-- Corks Choice Modal -->
    <div id="choiceModal" class="choice-modal-overlay">
        <div class="choice-modal">
            <div class="choice-modal-header">
                <h2>üéØ CORKS CHOICE</h2>
            </div>
            <div class="choice-modal-body">
                <p id="choicePrompt">Cork winner picks the game:</p>

                <!-- Simple options for mixed-leg choice (shows other round games) -->
                <div id="simpleChoiceOptions" class="choice-options">
                    <!-- Options populated dynamically for mixed rounds -->
                </div>

                <!-- Full options for round-level choice (all games + config) -->
                <div id="fullChoiceOptions" style="display: none;">
                    <div class="choice-options" style="margin-bottom: 15px;">
                        <button type="button" class="choice-option" data-game="301" onclick="selectGameType('301')">301</button>
                        <button type="button" class="choice-option" data-game="501" onclick="selectGameType('501')">501</button>
                        <button type="button" class="choice-option" data-game="701" onclick="selectGameType('701')">701</button>
                        <button type="button" class="choice-option cricket" data-game="cricket" onclick="selectGameType('cricket')">CRICKET</button>
                    </div>

                    <!-- X01 Config (shown for 301/501/701) -->
                    <div id="x01Config" style="display: none; background: var(--bg-card); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 4px;">Double In</label>
                                <select id="choiceInRule" style="width: 100%; padding: 10px; border-radius: 6px; border: 2px solid var(--text-dim); background: var(--bg-dark); color: var(--text-light);">
                                    <option value="straight">Straight In</option>
                                    <option value="double">Double In</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 4px;">Double Out</label>
                                <select id="choiceOutRule" style="width: 100%; padding: 10px; border-radius: 6px; border: 2px solid var(--text-dim); background: var(--bg-dark); color: var(--text-light);">
                                    <option value="double">Double Out</option>
                                    <option value="master">Master Out</option>
                                    <option value="straight">Straight Out</option>
                                </select>
                            </div>
                        </div>
                        <button class="brdc-btn" style="width: 100%; margin-top: 12px;" onclick="confirmCorksChoice()">START GAME</button>
                    </div>
                </div>

                <button class="choice-cancel" onclick="closeChoiceModal()">CANCEL</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, doc, getDoc, updateDoc, onSnapshot, callFunction } from '/js/firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        let leagueId = urlParams.get('league_id');
        let matchId = urlParams.get('match_id');

        let matchData = null;
        let leagueSettings = null;
        let homeTeam = null;
        let awayTeam = null;
        let unsubscribe = null;

        // PIN input handling
        const pinInputs = document.querySelectorAll('.pin-char');
        pinInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
                if (e.target.value.length === 1 && index < 5) {
                    pinInputs[index + 1].focus();
                }
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    pinInputs[index - 1].focus();
                }
            });
        });

        // Load match button
        document.getElementById('loadMatchBtn').addEventListener('click', loadMatchByPin);

        async function loadMatchByPin() {
            const pin = Array.from(pinInputs).map(i => i.value).join('').toUpperCase();
            
            if (pin.length !== 6) {
                showPinError('Enter all 6 characters');
                return;
            }

            try {
                const result = await callFunction('getMatchByPin', { pin: pin });

                if (!result.success) {
                    showPinError(result.error || 'Match not found');
                    return;
                }

                leagueId = result.match.league_id;
                matchId = result.match.match_id;
                matchData = result.match;
                // For singles leagues, team data comes from match, not separate objects
                homeTeam = result.home_team || {
                    team_name: result.match.home_team_name,
                    players: result.match.home_players || []
                };
                awayTeam = result.away_team || {
                    team_name: result.match.away_team_name,
                    players: result.match.away_players || []
                };

                // Update URL
                window.history.replaceState({}, '', `?league_id=${leagueId}&match_id=${matchId}`);

                // Switch to match view
                document.getElementById('pinEntry').style.display = 'none';
                document.getElementById('matchHub').style.display = 'block';

                renderMatch();
                setupRealtimeListener();

            } catch (error) {
                showPinError('Error: ' + error.message);
            }
        }

        // If league_id and match_id provided in URL, load directly
        if (leagueId && matchId) {
            loadMatchDirect();
        }

        async function loadMatchDirect() {
            try {
                // Load match and league in parallel
                const [matchDoc, leagueDoc] = await Promise.all([
                    getDoc(doc(db, 'leagues', leagueId, 'matches', matchId)),
                    getDoc(doc(db, 'leagues', leagueId))
                ]);

                if (!matchDoc.exists()) {
                    showPinError('Match not found');
                    return;
                }

                matchData = { id: matchId, ...matchDoc.data() };

                // Store league settings for cork rules
                if (leagueDoc.exists()) {
                    const leagueData = leagueDoc.data();
                    leagueSettings = {
                        cork_rule: leagueData.cork_rule || 'alternate_cork_first_deciding',
                        cork_order: leagueData.cork_order || 'random'
                    };
                }

                // Try to load teams (may not exist for singles leagues)
                try {
                    const homeDoc = await getDoc(doc(db, 'leagues', leagueId, 'teams', matchData.home_team_id));
                    const awayDoc = await getDoc(doc(db, 'leagues', leagueId, 'teams', matchData.away_team_id));

                    if (homeDoc.exists() && awayDoc.exists()) {
                        homeTeam = { id: homeDoc.id, ...homeDoc.data() };
                        awayTeam = { id: awayDoc.id, ...awayDoc.data() };
                    } else {
                        // Singles league - use data from match
                        const firstGame = matchData.games && matchData.games[0];
                        homeTeam = {
                            team_name: matchData.home_team_name,
                            players: firstGame?.home_players || []
                        };
                        awayTeam = {
                            team_name: matchData.away_team_name,
                            players: firstGame?.away_players || []
                        };
                    }
                } catch (e) {
                    // Team fetch failed - use match data
                    const firstGame = matchData.games && matchData.games[0];
                    homeTeam = {
                        team_name: matchData.home_team_name,
                        players: firstGame?.home_players || []
                    };
                    awayTeam = {
                        team_name: matchData.away_team_name,
                        players: firstGame?.away_players || []
                    };
                }

                document.getElementById('pinEntry').style.display = 'none';
                document.getElementById('matchHub').style.display = 'block';

                renderMatch();
                setupRealtimeListener();

            } catch (error) {
                showPinError('Error loading match: ' + error.message);
            }
        }

        function showPinError(msg) {
            const el = document.getElementById('pinError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();

            unsubscribe = onSnapshot(
                doc(db, 'leagues', leagueId, 'matches', matchId),
                (docSnap) => {
                    if (docSnap.exists()) {
                        matchData = { id: matchId, ...docSnap.data() };
                        renderMatch();
                    }
                },
                (error) => {
                    console.error('Realtime listener error:', error);
                }
            );
        }

        function renderMatch() {
            // Header info
            document.getElementById('matchInfo').textContent = `Week ${matchData.week} ‚Ä¢ ${matchData.match_date}`;

            // Team names and scores
            document.getElementById('homeTeamName').textContent = homeTeam.team_name;
            document.getElementById('awayTeamName').textContent = awayTeam.team_name;
            document.getElementById('homeTeamScore').textContent = matchData.home_score || 0;
            document.getElementById('awayTeamScore').textContent = matchData.away_score || 0;

            // Team players
            if (homeTeam.players) {
                document.getElementById('homeTeamPlayers').innerHTML = homeTeam.players
                    .map(p => `<div>P${p.position}: ${p.name}</div>`)
                    .join('');
            }
            if (awayTeam.players) {
                document.getElementById('awayTeamPlayers').innerHTML = awayTeam.players
                    .map(p => `<div>P${p.position}: ${p.name}</div>`)
                    .join('');
            }

            // Games grid
            renderGames();
        }

        function renderGames() {
            const container = document.getElementById('gamesGrid');
            const games = matchData.games || [];

            if (games.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px;">No games loaded yet.</p>';
                return;
            }

            let html = '';
            let currentRound = null;

            games.forEach((game, index) => {
                // Check if we need a round header
                const roundNum = game.round || Math.ceil((index + 1) / 3);
                if (roundNum !== currentRound) {
                    currentRound = roundNum;
                    html += `
                        <div style="background: var(--bg-panel); padding: 12px 16px; border-radius: 8px; margin-top: ${index > 0 ? '16px' : '0'};">
                            <span style="font-family: 'Bebas Neue', cursive; font-size: 20px; color: var(--yellow); letter-spacing: 2px;">
                                ROUND ${roundNum}
                            </span>
                        </div>
                    `;
                }

                const statusClass = game.status;
                let formatLabel;
                if (game.format === 'corks_choice') {
                    formatLabel = 'CORKS CHOICE';
                } else if (game.format === 'cricket') {
                    formatLabel = 'CRICKET';
                } else {
                    // X01 games (501, 301, 701, etc.)
                    const inLabel = game.in_rule === 'double' ? 'DI' : 'SI';
                    const outLabel = game.checkout === 'double' ? 'DO' : (game.checkout === 'master' ? 'MO' : 'SO');
                    formatLabel = `${game.format} ${inLabel}/${outLabel}`;
                }

                // Build player display with levels
                const homePlayerDisplay = game.home_players?.map(p => {
                    const level = p?.level || p?.skill_level || '';
                    return `<span style="color: var(--pink); font-weight: 700;">${p?.name || 'TBD'}${level ? ` <span style="background: rgba(255,255,255,0.15); padding: 1px 6px; border-radius: 4px; font-size: 10px;">${level}</span>` : ''}</span>`;
                }).join(' & ') || '<span style="color: var(--pink);">TBD</span>';

                const awayPlayerDisplay = game.away_players?.map(p => {
                    const level = p?.level || p?.skill_level || '';
                    return `<span style="color: var(--teal); font-weight: 700;">${p?.name || 'TBD'}${level ? ` <span style="background: rgba(255,255,255,0.15); padding: 1px 6px; border-radius: 4px; font-size: 10px;">${level}</span>` : ''}</span>`;
                }).join(' & ') || '<span style="color: var(--teal);">TBD</span>';

                const gameType = game.type === 'doubles' ? 'DOUBLES' : game.type === 'triples' ? 'TRIPLES' : 'SINGLES';

                html += `
                    <div class="game-card ${statusClass}" onclick="openGame(${index})">
                        <div class="game-header ${statusClass}">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 22px;">#${game.game_number}</span>
                                <span style="font-size: 11px; opacity: 0.8; text-transform: uppercase;">${gameType}</span>
                            </div>
                            <span class="game-format">${formatLabel}</span>
                        </div>
                        <div class="game-body">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="flex: 1;">${homePlayerDisplay}</div>
                                <div style="padding: 0 12px; color: var(--text-dim); font-size: 12px;">vs</div>
                                <div style="flex: 1; text-align: right;">${awayPlayerDisplay}</div>
                            </div>
                            ${game.status === 'completed' ? `
                                <div class="game-result">
                                    <span class="legs-score">${game.home_legs_won} - ${game.away_legs_won}</span>
                                    <span class="winner-badge">${game.winner === 'home' ? 'HOME' : 'AWAY'} WINS</span>
                                </div>
                            ` : game.status === 'in_progress' ? `
                                <div class="game-result">
                                    <span class="legs-score">${game.home_legs_won || 0} - ${game.away_legs_won || 0}</span>
                                    <span style="color: var(--yellow); font-weight: 700;">IN PROGRESS</span>
                                </div>
                            ` : `
                                <div style="margin-top: 8px; text-align: center; color: var(--teal); font-weight: 600; font-size: 13px;">
                                    TAP TO START
                                </div>
                            `}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        let pendingChoiceGameIndex = null;
        let pendingChoiceMode = null; // 'full' or 'simple'
        let selectedGameType = null;

        window.openGame = function(gameIndex) {
            const game = matchData.games[gameIndex];

            // If format is "corks_choice", show the selection modal
            if (game.format === 'corks_choice') {
                showChoiceModal(gameIndex);
                return;
            }

            openScorerForGame(gameIndex, game.format);
        };

        function showChoiceModal(gameIndex) {
            pendingChoiceGameIndex = gameIndex;
            selectedGameType = null;

            const game = matchData.games[gameIndex];

            // Check if this is a mixed-leg corks_choice (has other games in same round to choose from)
            // or a round-level corks_choice (needs full game config)
            const roundGames = getAvailableRoundGames(gameIndex);

            if (roundGames.length > 0) {
                // Mixed-leg mode: show only games from this round
                pendingChoiceMode = 'simple';
                document.getElementById('choicePrompt').textContent = 'Cork winner picks from round games:';
                document.getElementById('simpleChoiceOptions').style.display = 'flex';
                document.getElementById('fullChoiceOptions').style.display = 'none';

                const optionsContainer = document.getElementById('simpleChoiceOptions');
                optionsContainer.innerHTML = roundGames.map(g => {
                    const isCricket = g.format === 'cricket';
                    const className = isCricket ? 'cricket' : 'x01';
                    const inOut = !isCricket ? ` ${g.in_rule === 'double' ? 'DI' : 'SI'}/${g.checkout === 'double' ? 'DO' : (g.checkout === 'master' ? 'MO' : 'SO')}` : '';
                    return `<button class="choice-option ${className}" onclick="selectSimpleChoice('${g.format}', '${g.in_rule || 'straight'}', '${g.checkout || 'double'}')">${g.format.toUpperCase()}${inOut}</button>`;
                }).join('');
            } else {
                // Full mode: show all game options with config
                pendingChoiceMode = 'full';
                document.getElementById('choicePrompt').textContent = 'Cork winner picks game and rules:';
                document.getElementById('simpleChoiceOptions').style.display = 'none';
                document.getElementById('fullChoiceOptions').style.display = 'block';
                document.getElementById('x01Config').style.display = 'none';

                // Reset button highlights
                document.querySelectorAll('#fullChoiceOptions .choice-option').forEach(btn => {
                    btn.style.border = '2px solid transparent';
                });
            }

            document.getElementById('choiceModal').classList.add('show');
        }

        function getAvailableRoundGames(gameIndex) {
            // For mixed-leg corks_choice, find other games in the same round
            // Games are grouped by type/round, so look for adjacent games with same type
            const games = matchData.games || [];
            const currentGame = games[gameIndex];
            const roundGames = [];

            // Look at all games and find ones that aren't corks_choice or mixed
            games.forEach((game, idx) => {
                if (idx !== gameIndex && game.format && game.format !== 'corks_choice' && game.format !== 'mixed') {
                    // Only include if it seems to be from the same round (same type = singles/doubles/triples)
                    if (game.type === currentGame.type) {
                        // Avoid duplicates
                        if (!roundGames.find(g => g.format === game.format && g.in_rule === game.in_rule && g.checkout === game.checkout)) {
                            roundGames.push({
                                format: game.format,
                                in_rule: game.in_rule || 'straight',
                                checkout: game.checkout || 'double'
                            });
                        }
                    }
                }
            });

            return roundGames;
        }

        // For simple mode (mixed-leg choice) - inherits rules from round game
        window.selectSimpleChoice = async function(format, inRule, outRule) {
            document.getElementById('choiceModal').classList.remove('show');

            if (pendingChoiceGameIndex !== null) {
                const gameIdx = pendingChoiceGameIndex;
                pendingChoiceGameIndex = null;

                try {
                    const matchRef = doc(db, 'leagues', leagueId, 'matches', matchId);
                    const updatedGames = [...matchData.games];
                    updatedGames[gameIdx] = {
                        ...updatedGames[gameIdx],
                        format: format,
                        in_rule: inRule,
                        checkout: outRule,
                        corks_choice_selected: true,
                        corks_choice_selected_at: new Date().toISOString()
                    };
                    await updateDoc(matchRef, { games: updatedGames });
                    matchData.games = updatedGames;
                } catch (err) {
                    console.error('Failed to persist corks choice:', err);
                }

                openScorerForGame(gameIdx, format);
            }
        };

        // For full mode (round-level choice) - select game type
        window.selectGameType = function(gameType) {
            selectedGameType = gameType;

            // Highlight selected button
            document.querySelectorAll('#fullChoiceOptions .choice-option').forEach(btn => {
                btn.style.border = btn.dataset.game === gameType ? '3px solid #fbbf24' : '2px solid transparent';
            });

            if (gameType === 'cricket') {
                // Cricket doesn't need config, go directly
                confirmCorksChoice();
            } else {
                // Show X01 config
                document.getElementById('x01Config').style.display = 'block';
            }
        };

        // Confirm full corks choice with config
        window.confirmCorksChoice = async function() {
            if (!selectedGameType || pendingChoiceGameIndex === null) return;

            const gameIdx = pendingChoiceGameIndex;
            const format = selectedGameType;
            const inRule = format === 'cricket' ? 'n/a' : document.getElementById('choiceInRule').value;
            const outRule = format === 'cricket' ? 'n/a' : document.getElementById('choiceOutRule').value;

            document.getElementById('choiceModal').classList.remove('show');
            pendingChoiceGameIndex = null;
            selectedGameType = null;

            try {
                const matchRef = doc(db, 'leagues', leagueId, 'matches', matchId);
                const updatedGames = [...matchData.games];
                updatedGames[gameIdx] = {
                    ...updatedGames[gameIdx],
                    format: format,
                    in_rule: inRule,
                    checkout: outRule,
                    corks_choice_selected: true,
                    corks_choice_selected_at: new Date().toISOString()
                };
                await updateDoc(matchRef, { games: updatedGames });
                matchData.games = updatedGames;
            } catch (err) {
                console.error('Failed to persist corks choice:', err);
            }

            openScorerForGame(gameIdx, format);
        };

        window.closeChoiceModal = function() {
            document.getElementById('choiceModal').classList.remove('show');
            pendingChoiceGameIndex = null;
        };

        function openScorerForGame(gameIndex, format) {
            const game = matchData.games[gameIndex];

            // Determine which scorer to open
            const scorerPage = format === 'cricket' ? 'league-cricket.html' : 'league-501.html';

            // Build URL with all needed params
            const params = new URLSearchParams({
                league_id: leagueId,
                match_id: matchId,
                game_index: gameIndex,
                game_number: game.game_number,
                format: format,
                type: game.type,
                in_rule: game.in_rule || 'straight',
                checkout: game.checkout || 'double'
            });

            // Add cork settings from league
            if (leagueSettings) {
                params.set('cork_rule', leagueSettings.cork_rule);
                params.set('cork_order', leagueSettings.cork_order);
            }

            // Add player info
            if (game.home_players) {
                params.set('home_players', JSON.stringify(game.home_players));
            }
            if (game.away_players) {
                params.set('away_players', JSON.stringify(game.away_players));
            }

            window.location.href = `/pages/${scorerPage}?${params.toString()}`;
        }

        window.refreshMatch = async function() {
            try {
                const matchDoc = await getDoc(doc(db, 'leagues', leagueId, 'matches', matchId));
                if (matchDoc.exists()) {
                    matchData = { id: matchId, ...matchDoc.data() };
                    renderMatch();
                }
            } catch (error) {
                alert('Error refreshing: ' + error.message);
            }
        };

        window.exitMatch = function() {
            if (unsubscribe) unsubscribe();
            if (confirm('Exit match hub? You can re-enter with the match PIN.')) {
                window.location.href = '/';
            }
        };

        // Focus first PIN input
        pinInputs[0].focus();
    </script>
</body>
</html>
