<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Hub - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BRDC">
    <link rel="apple-touch-icon" href="/images/gold_logo.png">
    <meta name="theme-color" content="#FF469A">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --green: #10b981;
            --text-light: #f0f0f0;
            --text-primary: #f0f0f0;
            --text-dim: #8a8aa3;
            --text-secondary: #a0a0a0;
            --text-muted: #666;
            --black: #000000;
            --border: rgba(255, 255, 255, 0.1);
            --border-strong: #000;
            --glow-pink: rgba(255, 70, 154, 0.3);
            --glow-teal: rgba(145, 215, 235, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-light);
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .header-logo {
            width: 40px;
            height: 40px;
            
        }
        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 3px;
            color: var(--pink);
        }
        .back-btn {
            background: var(--bg-card);
            border: 2px solid var(--text-dim);
            border-radius: 8px;
            padding: 10px 16px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .back-btn:hover {
            border-color: var(--pink);
            color: var(--pink);
        }

        .pin-entry {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .pin-card {
            background: var(--bg-panel);
            border: 3px solid var(--pink);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(255, 70, 154, 0.2);
            padding: 50px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        .pin-input-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 30px 0;
        }
        .pin-input {
            width: 100%;
            max-width: 280px;
            height: 60px;
            border: 3px solid var(--text-dim);
            border-radius: 12px;
            font-size: 32px;
            text-align: center;
            font-family: 'Bebas Neue', cursive;
            letter-spacing: 8px;
            background: var(--bg-card);
            color: var(--text-light);
            padding: 0 20px;
        }
        .pin-input:focus {
            outline: none;
            border-color: var(--pink);
            background: var(--bg-card);
            box-shadow: 0 0 12px rgba(255, 70, 154, 0.4);
        }
        .pin-input::placeholder {
            color: var(--text-dim);
            letter-spacing: 4px;
        }
        /* Compact Scoreboard */
        .score-bar {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-panel) 100%);
            border-bottom: 3px solid var(--border-strong);
            padding: 12px 16px;
        }
        .score-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            color: var(--text-light);
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .team-name.home { text-align: right; color: var(--pink); }
        .team-name.away { text-align: left; color: var(--teal); }
        .score-box {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-dark);
            padding: 8px 14px;
            border-radius: 8px;
            border: 2px solid var(--border-strong);
        }
        .score-num {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            min-width: 28px;
            text-align: center;
        }
        .score-num.home { color: var(--pink); }
        .score-num.away { color: var(--teal); }
        .score-dash {
            color: var(--text-dim);
            font-size: 20px;
        }
        .match-meta-bar {
            display: flex;
            justify-content: center;
            gap: 16px;
            padding: 8px 16px;
            background: var(--bg-panel);
            font-size: 11px;
            color: var(--text-dim);
            border-bottom: 2px solid var(--border-strong);
            flex-wrap: wrap;
        }
        .match-meta-bar span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .games-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background: var(--bg-dark);
            max-width: 500px;
            margin: 0 auto;
        }

        /* Desktop: Expand scoreboard */
        @media (min-width: 600px) {
            .score-bar { padding: 16px 24px; }
            .team-name { font-size: 24px; max-width: 180px; }
            .score-num { font-size: 36px; min-width: 36px; }
            .score-box { padding: 10px 20px; gap: 10px; }
            .games-grid { padding: 16px; gap: 10px; }
        }
        .game-card {
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 10px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
        }
        .game-card:hover {
            transform: translate(-1px, -1px);
            box-shadow: 5px 5px 0 rgba(0,0,0,0.4);
        }
        .game-card:active {
            transform: translate(0, 0);
            box-shadow: 2px 2px 0 rgba(0,0,0,0.4);
        }
        .game-card.pending { border-color: var(--text-dim); }
        .game-card.in_progress { border-color: var(--yellow); background: rgba(253, 216, 53, 0.08); }
        .game-card.completed { border-color: var(--green); background: rgba(16, 185, 129, 0.08); }
        .game-header {
            padding: 8px 12px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .game-header.pending { background: var(--bg-panel); color: var(--text-dim); }
        .game-header.in_progress { background: var(--yellow); color: var(--black); }
        .game-header.completed { background: var(--green); color: white; }
        .game-body {
            padding: 10px 12px;
        }
        .game-format {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 3px 6px;
            background: var(--teal);
            border-radius: 4px;
            color: var(--black);
        }
        .game-players-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            gap: 8px;
        }
        .game-players-row .home { color: var(--pink); font-weight: 600; }
        .game-players-row .away { color: var(--teal); font-weight: 600; text-align: right; }
        .game-players-row .vs { color: var(--text-dim); font-size: 10px; }
        .game-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .legs-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--text-light);
        }
        .winner-badge {
            background: var(--green);
            color: white;
            padding: 2px 8px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            border-radius: 4px;
        }

        /* Mobile optimizations */
        @media (max-width: 400px) {
            .game-header { padding: 6px 10px; font-size: 13px; }
            .game-body { padding: 8px 10px; }
            .game-format { font-size: 9px; padding: 2px 5px; }
            .legs-score { font-size: 18px; }
        }
        .match-actions {
            padding: 20px 30px;
            background: var(--bg-panel);
            border-top: 2px solid rgba(255,255,255,0.1);
            border-radius: 0 0 16px 16px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Button styles */
        .brdc-btn {
            background: linear-gradient(135deg, var(--pink) 0%, #d63384 100%);
            color: white;
            border: 3px solid var(--border-strong);
            border-radius: 10px;
            padding: 14px 28px;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
        }
        .brdc-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,0.5);
        }
        .brdc-btn:active {
            transform: translate(0, 0);
            box-shadow: 2px 2px 0 rgba(0,0,0,0.5);
        }
        .brdc-btn-secondary {
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }
        .brdc-btn-secondary:hover {
            border-color: var(--teal);
            background: var(--bg-panel);
        }

        /* Card styles */
        .brdc-card {
            background: var(--bg-panel);
            border-radius: 16px;
            border: 4px solid var(--border-strong);
            overflow: hidden;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
        }
        .brdc-title {
            font-family: 'Bebas Neue', cursive;
            margin: 0;
        }

        /* Choice Modal */
        .choice-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .choice-modal-overlay.show {
            display: flex;
        }
        .choice-modal {
            background: var(--bg-panel);
            border: 3px solid var(--pink);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(255, 70, 154, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .choice-modal-header {
            background: linear-gradient(135deg, var(--pink) 0%, #d63384 100%);
            padding: 20px;
            border-radius: 12px 12px 0 0;
        }
        .choice-modal-header h2 {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: white;
            margin: 0;
        }
        .choice-modal-body {
            padding: 25px;
        }
        .choice-modal-body p {
            margin-bottom: 20px;
            color: var(--text-dim);
        }
        .choice-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .choice-option {
            padding: 18px 24px;
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            border: 3px solid var(--text-dim);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .choice-option:hover {
            background: var(--teal);
            color: var(--black);
            border-color: var(--teal);
            transform: translateY(-2px);
        }
        .choice-option.x01 { background: rgba(253, 216, 53, 0.2); border-color: var(--yellow); }
        .choice-option.cricket { background: rgba(16, 185, 129, 0.2); border-color: #10b981; }
        .choice-cancel {
            margin-top: 20px;
            padding: 12px 24px;
            background: var(--bg-card);
            border: 2px solid var(--text-dim);
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            color: var(--text-dim);
            transition: all 0.2s;
        }
        .choice-cancel:hover {
            border-color: var(--pink);
            color: var(--pink);
        }
        /* Clickable Player Names */
        .player-link {
            cursor: pointer;
            transition: all 0.15s;
        }
        .player-link:hover {
            text-decoration: underline;
            filter: brightness(1.2);
        }
    </style>
</head>
<body>
    <!-- PIN Entry Screen -->
    <div id="pinEntry" class="pin-entry">
        <div class="pin-card">
            <img src="/images/gold_logo.png" alt="BRDC" style="width: 80px; margin-bottom: 20px; ">
            <h1 style="font-family: 'Bebas Neue', cursive; font-size: 36px;">MATCH HUB</h1>
            <p style="color: var(--text-dim); margin-top: 10px;">Enter your match PIN to begin scoring</p>
            
            <div class="pin-input-group">
                <input type="tel" id="pinInput" class="pin-input" maxlength="6" inputmode="numeric" pattern="[0-9]*" placeholder="000000" autocomplete="off">
            </div>
            
            <button id="loadMatchBtn" class="brdc-btn" style="width: 100%;">LOAD MATCH</button>
            <p id="pinError" style="color: #ef4444; margin-top: 20px; display: none;"></p>
        </div>
    </div>

    <!-- Match Hub Screen -->
    <div id="matchHub" style="display: none;">
        <div class="header-bar">
            <button class="back-btn" onclick="exitMatch()">‚Üê EXIT</button>
            <img src="/images/gold_logo.png" alt="BRDC" class="header-logo">
            <span class="header-title">MATCH HUB</span>
        </div>
        <div class="brdc-card" style="max-width: 500px; margin: 12px auto; border-radius: 12px;">
            <!-- Compact Score Bar -->
            <div class="score-bar">
                <div class="score-display">
                    <span class="team-name home" id="homeTeamName">Home</span>
                    <div class="score-box">
                        <span class="score-num home" id="homeTeamScore">0</span>
                        <span class="score-dash">-</span>
                        <span class="score-num away" id="awayTeamScore">0</span>
                    </div>
                    <span class="team-name away" id="awayTeamName">Away</span>
                </div>
            </div>

            <!-- Match Meta -->
            <div class="match-meta-bar" id="matchInfo">
                <span>Week 1</span>
                <span id="matchStatus">In Progress</span>
            </div>

            <!-- Sets Grid -->
            <div class="games-grid" id="gamesGrid">
                <!-- Sets populated dynamically -->
            </div>

            <!-- Compact Actions -->
            <div style="display: flex; gap: 8px; padding: 12px; background: var(--bg-panel); border-top: 2px solid var(--border-strong);">
                <button class="brdc-btn brdc-btn-secondary" onclick="refreshMatch()" style="flex: 1; padding: 10px; font-size: 14px;">REFRESH</button>
                <button class="brdc-btn brdc-btn-secondary" onclick="viewMatchReport()" id="reportBtn" style="flex: 1; padding: 10px; font-size: 14px; display: none;">REPORT</button>
                <button class="brdc-btn" onclick="exitMatch()" style="flex: 1; padding: 10px; font-size: 14px;">EXIT</button>
            </div>
        </div>
    </div>

    <!-- Corks Choice Modal -->
    <div id="choiceModal" class="choice-modal-overlay">
        <div class="choice-modal">
            <div class="choice-modal-header">
                <h2>üéØ CORKS CHOICE</h2>
            </div>
            <div class="choice-modal-body">
                <p id="choicePrompt">Cork winner picks the game:</p>

                <!-- Simple options for mixed-leg choice (shows other round games) -->
                <div id="simpleChoiceOptions" class="choice-options">
                    <!-- Options populated dynamically for mixed rounds -->
                </div>

                <!-- Full options for round-level choice (all games + config) -->
                <div id="fullChoiceOptions" style="display: none;">
                    <div class="choice-options" style="margin-bottom: 15px;">
                        <button type="button" class="choice-option" data-game="301" onclick="selectGameType('301')">301</button>
                        <button type="button" class="choice-option" data-game="501" onclick="selectGameType('501')">501</button>
                        <button type="button" class="choice-option" data-game="701" onclick="selectGameType('701')">701</button>
                        <button type="button" class="choice-option cricket" data-game="cricket" onclick="selectGameType('cricket')">CRICKET</button>
                    </div>

                    <!-- X01 Config (shown for 301/501/701) -->
                    <div id="x01Config" style="display: none; background: var(--bg-card); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <label style="display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 4px;">Double In</label>
                                <select id="choiceInRule" style="width: 100%; padding: 10px; border-radius: 6px; border: 2px solid var(--text-dim); background: var(--bg-dark); color: var(--text-light);">
                                    <option value="straight">Straight In</option>
                                    <option value="double">Double In</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 4px;">Double Out</label>
                                <select id="choiceOutRule" style="width: 100%; padding: 10px; border-radius: 6px; border: 2px solid var(--text-dim); background: var(--bg-dark); color: var(--text-light);">
                                    <option value="double">Double Out</option>
                                    <option value="master">Master Out</option>
                                    <option value="straight">Straight Out</option>
                                </select>
                            </div>
                        </div>
                        <button class="brdc-btn" style="width: 100%; margin-top: 12px;" onclick="confirmCorksChoice()">START SET</button>
                    </div>
                </div>

                <button class="choice-cancel" onclick="closeChoiceModal()">CANCEL</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, doc, getDoc, updateDoc, onSnapshot, callFunction } from '/js/firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        let leagueId = urlParams.get('league_id');
        let matchId = urlParams.get('match_id');

        let matchData = null;
        let leagueSettings = null;
        let homeTeam = null;
        let awayTeam = null;
        let unsubscribe = null;

        // PIN input handling
        const pinInput = document.getElementById('pinInput');
        pinInput.addEventListener('input', (e) => {
            // Only allow numbers
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
        pinInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                loadMatchByPin();
            }
        });

        // Load match button
        document.getElementById('loadMatchBtn').addEventListener('click', loadMatchByPin);

        async function loadMatchByPin() {
            const pin = pinInput.value.trim();
            
            if (pin.length !== 6) {
                showPinError('Enter all 6 digits');
                return;
            }

            try {
                const result = await callFunction('getMatchByPin', { pin: pin });

                if (!result.success) {
                    showPinError(result.error || 'Match not found');
                    return;
                }

                leagueId = result.match.league_id;
                matchId = result.match.match_id;
                matchData = result.match;
                // For singles leagues, team data comes from match, not separate objects
                homeTeam = result.home_team || {
                    team_name: result.match.home_team_name,
                    players: result.match.home_players || []
                };
                awayTeam = result.away_team || {
                    team_name: result.match.away_team_name,
                    players: result.match.away_players || []
                };

                // Update URL
                window.history.replaceState({}, '', `?league_id=${leagueId}&match_id=${matchId}`);

                // Switch to match view
                document.getElementById('pinEntry').style.display = 'none';
                document.getElementById('matchHub').style.display = 'block';

                renderMatch();
                setupRealtimeListener();

            } catch (error) {
                showPinError('Error: ' + error.message);
            }
        }

        // If league_id and match_id provided in URL, load directly
        if (leagueId && matchId) {
            loadMatchDirect();
        }

        async function loadMatchDirect() {
            try {
                // Load match and league in parallel
                const [matchDoc, leagueDoc] = await Promise.all([
                    getDoc(doc(db, 'leagues', leagueId, 'matches', matchId)),
                    getDoc(doc(db, 'leagues', leagueId))
                ]);

                if (!matchDoc.exists()) {
                    showPinError('Match not found');
                    return;
                }

                matchData = { id: matchId, ...matchDoc.data() };

                // Store league settings for cork rules
                if (leagueDoc.exists()) {
                    const leagueData = leagueDoc.data();
                    leagueSettings = {
                        cork_rule: leagueData.cork_rule || 'alternate_cork_first_deciding',
                        cork_order: leagueData.cork_order || 'random'
                    };
                }

                // Try to load teams (may not exist for singles leagues)
                try {
                    const homeDoc = await getDoc(doc(db, 'leagues', leagueId, 'teams', matchData.home_team_id));
                    const awayDoc = await getDoc(doc(db, 'leagues', leagueId, 'teams', matchData.away_team_id));

                    if (homeDoc.exists() && awayDoc.exists()) {
                        homeTeam = { id: homeDoc.id, ...homeDoc.data() };
                        awayTeam = { id: awayDoc.id, ...awayDoc.data() };
                    } else {
                        // Singles league - use data from match
                        const firstGame = matchData.games && matchData.games[0];
                        homeTeam = {
                            team_name: matchData.home_team_name,
                            players: firstGame?.home_players || []
                        };
                        awayTeam = {
                            team_name: matchData.away_team_name,
                            players: firstGame?.away_players || []
                        };
                    }
                } catch (e) {
                    // Team fetch failed - use match data
                    const firstGame = matchData.games && matchData.games[0];
                    homeTeam = {
                        team_name: matchData.home_team_name,
                        players: firstGame?.home_players || []
                    };
                    awayTeam = {
                        team_name: matchData.away_team_name,
                        players: firstGame?.away_players || []
                    };
                }

                document.getElementById('pinEntry').style.display = 'none';
                document.getElementById('matchHub').style.display = 'block';

                renderMatch();
                setupRealtimeListener();

            } catch (error) {
                showPinError('Error loading match: ' + error.message);
            }
        }

        function showPinError(msg) {
            const el = document.getElementById('pinError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();

            unsubscribe = onSnapshot(
                doc(db, 'leagues', leagueId, 'matches', matchId),
                (docSnap) => {
                    if (docSnap.exists()) {
                        matchData = { id: matchId, ...docSnap.data() };
                        renderMatch();
                    }
                },
                (error) => {
                    console.error('Realtime listener error:', error);
                }
            );
        }

        function renderMatch() {
            // Check if match is complete
            const games = matchData.games || [];
            const allGamesComplete = games.length > 0 && games.every(g => g.status === 'completed');
            const reportBtn = document.getElementById('reportBtn');
            const matchStatus = document.getElementById('matchStatus');
            const scoreBar = document.querySelector('.score-bar');

            if (allGamesComplete || matchData.status === 'completed') {
                matchStatus.textContent = '‚úì Complete';
                matchStatus.style.color = 'var(--green)';
                scoreBar.style.borderBottom = '3px solid var(--green)';
                if (reportBtn) reportBtn.style.display = 'flex';
            } else {
                matchStatus.textContent = 'In Progress';
                matchStatus.style.color = 'var(--yellow)';
                scoreBar.style.borderBottom = '3px solid var(--pink)';
                if (reportBtn) reportBtn.style.display = 'none';
            }

            // Update match meta
            const matchInfo = document.getElementById('matchInfo');
            matchInfo.innerHTML = `<span>Week ${matchData.week || '-'}</span><span id="matchStatus" style="color: ${allGamesComplete ? 'var(--green)' : 'var(--yellow)'};">${allGamesComplete ? '‚úì Complete' : 'In Progress'}</span>`;

            // Team names and scores
            document.getElementById('homeTeamName').textContent = homeTeam.team_name;
            document.getElementById('awayTeamName').textContent = awayTeam.team_name;
            document.getElementById('homeTeamScore').textContent = matchData.home_score || 0;
            document.getElementById('awayTeamScore').textContent = matchData.away_score || 0;

            // Get first game players for reference (no longer displayed in header)
            const posLabel = (pos) => ['', 'A', 'B', 'C'][pos] || pos;
            // Players now shown in individual set cards (not in header)

            // Sets grid
            renderGames();
        }

        function renderGames() {
            const container = document.getElementById('gamesGrid');
            const games = matchData.games || [];

            if (games.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px;">No sets loaded yet.</p>';
                return;
            }

            let html = '';

            // Check if any games have legs data - if so, show master toggle
            const hasCompletedGamesWithLegs = games.some(g => g.status === 'completed' && g.legs && g.legs.length > 0);
            if (hasCompletedGamesWithLegs) {
                html += `
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">
                        <button id="master-legs-toggle" data-expanded="false" onclick="toggleAllLegs(this.dataset.expanded !== 'true')" style="background: var(--bg-panel); border: 2px solid var(--yellow); color: var(--yellow); padding: 8px 16px; border-radius: 8px; font-family: 'Bebas Neue', cursive; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--yellow)';this.style.color='var(--black)'" onmouseout="this.style.background='var(--bg-panel)';this.style.color='var(--yellow)'">
                            ‚ñº EXPAND ALL
                        </button>
                    </div>
                `;
            }

            games.forEach((game, index) => {
                // Each game is its own round
                const roundNum = game.game_number || (index + 1);

                const statusClass = game.status || 'pending';
                let formatLabel;
                if (game.format === 'corks_choice') {
                    formatLabel = 'CORKS CHOICE';
                } else if (game.format === 'cricket') {
                    formatLabel = 'CRICKET';
                } else {
                    // X01 games (501, 301, 701, etc.)
                    const inLabel = game.in_rule === 'double' ? 'DI' : 'SI';
                    const outLabel = game.checkout === 'double' ? 'DO' : (game.checkout === 'master' ? 'MO' : 'SO');
                    formatLabel = `${game.format} ${inLabel}/${outLabel}`;
                }

                // Build player display with levels (clickable)
                const homePlayerDisplay = game.home_players?.map(p => {
                    const level = p?.level || p?.skill_level || '';
                    const name = p?.name || 'TBD';
                    const escapedName = name.replace(/'/g, "\\'");
                    const clickable = name !== 'TBD' ? ` class="player-link" onclick="viewPlayer('${escapedName}')"` : '';
                    return `<span style="color: var(--pink); font-weight: 700;"${clickable}>${name}${level ? ` <span style="background: rgba(255,255,255,0.15); padding: 1px 6px; border-radius: 4px; font-size: 10px;">${level}</span>` : ''}</span>`;
                }).join(' & ') || '<span style="color: var(--pink);">TBD</span>';

                const awayPlayerDisplay = game.away_players?.map(p => {
                    const level = p?.level || p?.skill_level || '';
                    const name = p?.name || 'TBD';
                    const escapedName = name.replace(/'/g, "\\'");
                    const clickable = name !== 'TBD' ? ` class="player-link" onclick="viewPlayer('${escapedName}')"` : '';
                    return `<span style="color: var(--teal); font-weight: 700;"${clickable}>${name}${level ? ` <span style="background: rgba(255,255,255,0.15); padding: 1px 6px; border-radius: 4px; font-size: 10px;">${level}</span>` : ''}</span>`;
                }).join(' & ') || '<span style="color: var(--teal);">TBD</span>';

                const gameType = game.type === 'doubles' ? 'DOUBLES' : game.type === 'triples' ? 'TRIPLES' : 'SINGLES';
                const isCompleted = statusClass === 'completed';

                // Build legs detail HTML for completed games
                let legsDetailHtml = '';
                if (isCompleted && game.legs && game.legs.length > 0) {
                    legsDetailHtml = '<div class="legs-detail" id="legs-' + index + '" style="display: none; border-top: 2px solid rgba(255,255,255,0.1); margin-top: 12px; padding-top: 12px;">';

                    game.legs.forEach((leg, legIdx) => {
                        const legFormat = leg.format || game.format;
                        const isCricket = legFormat === 'cricket';
                        const homeStats = leg.home_stats || {};
                        const awayStats = leg.away_stats || {};
                        const playerStats = leg.player_stats || {};
                        const legWinnerHome = leg.winner === 'home';

                        // Format label with DI/DO for x01
                        let formatLabel = (legFormat || '').toUpperCase();
                        if (!isCricket && legFormat) {
                            const inRule = leg.in_rule || game.in_rule || 'straight';
                            const outRule = leg.out_rule || game.checkout || 'double';
                            const inLabel = inRule === 'double' ? 'DI' : 'SI';
                            const outLabel = outRule === 'double' ? 'DO' : (outRule === 'master' ? 'MO' : 'SO');
                            formatLabel = legFormat + ' ' + inLabel + '/' + outLabel;
                        }

                        const winnerBorder = legWinnerHome ? 'var(--pink)' : 'var(--teal)';

                        legsDetailHtml += '<div class="leg-card" data-game="' + index + '" data-leg="' + legIdx + '" onclick="toggleLegThrows(' + index + ',' + legIdx + ',event)" style="background: var(--bg-dark); border-radius: 8px; margin-bottom: 10px; border: 2px solid ' + winnerBorder + '; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.transform=\'none\'">';

                        // Main leg card - 3 column layout
                        legsDetailHtml += '<div style="display: grid; grid-template-columns: 1fr auto 1fr; padding: 12px; align-items: start;">';

                        // Left - Home players (each on own line with position, name, avg)
                        legsDetailHtml += '<div style="text-align: left;">';
                        (game.home_players || []).forEach(p => {
                            const pStats = playerStats[p.name] || {};
                            // Use canonical field names with legacy fallbacks
                            const mprVal = pStats.cricket_mpr || pStats.mpr;
                            const tdaVal = pStats.x01_three_dart_avg || pStats.three_dart_avg;
                            const pAvg = isCricket
                                ? (mprVal ? Number(mprVal).toFixed(2) : '-') + ' MPR'
                                : (tdaVal ? Number(tdaVal).toFixed(2) : '-') + ' 3DA';
                            const isBig = isCricket ? (mprVal >= 3.0) : (tdaVal >= 60);
                            const pos = p.position || '';
                            const escapedName = p.name.replace(/'/g, "\\'");
                            legsDetailHtml += '<div style="margin-bottom: 4px;">';
                            legsDetailHtml += '<span style="color: var(--text-dim); font-size: 11px;">(' + pos + ')</span> ';
                            legsDetailHtml += '<span class="player-link" style="color: var(--pink); font-weight: 600;" onclick="event.stopPropagation(); viewPlayer(\'' + escapedName + '\')">' + p.name + '</span>';
                            legsDetailHtml += '<div style="font-family: \'Bebas Neue\', cursive; font-size: 16px; color: ' + (isBig ? 'var(--yellow)' : 'var(--text-dim)') + ';">' + (isBig ? '<b>BIG</b> ' : '') + pAvg + '</div>';
                            legsDetailHtml += '</div>';
                        });
                        legsDetailHtml += '</div>';

                        // Center - Leg info
                        legsDetailHtml += '<div style="text-align: center; padding: 0 15px;">';
                        legsDetailHtml += '<div style="font-family: \'Bebas Neue\', cursive; font-size: 18px; color: var(--yellow);">LEG ' + leg.leg_number + '</div>';
                        legsDetailHtml += '<div style="font-size: 12px; color: var(--text-light); background: var(--bg-panel); padding: 4px 10px; border-radius: 4px; margin-top: 6px;">' + formatLabel + '</div>';
                        legsDetailHtml += '<div style="font-size: 10px; color: var(--text-dim); margin-top: 8px;">‚ñº LEG DETAILS</div>';
                        legsDetailHtml += '</div>';

                        // Right - Away players (each on own line with position, name, avg)
                        legsDetailHtml += '<div style="text-align: right;">';
                        (game.away_players || []).forEach(p => {
                            const pStats = playerStats[p.name] || {};
                            // Use canonical field names with legacy fallbacks
                            const mprVal = pStats.cricket_mpr || pStats.mpr;
                            const tdaVal = pStats.x01_three_dart_avg || pStats.three_dart_avg;
                            const pAvg = isCricket
                                ? (mprVal ? Number(mprVal).toFixed(2) : '-') + ' MPR'
                                : (tdaVal ? Number(tdaVal).toFixed(2) : '-') + ' 3DA';
                            const isBig = isCricket ? (mprVal >= 3.0) : (tdaVal >= 60);
                            const pos = p.position || '';
                            const escapedName = p.name.replace(/'/g, "\\'");
                            legsDetailHtml += '<div style="margin-bottom: 4px;">';
                            legsDetailHtml += '<span style="color: var(--text-dim); font-size: 11px;">(' + pos + ')</span> ';
                            legsDetailHtml += '<span class="player-link" style="color: var(--teal); font-weight: 600;" onclick="event.stopPropagation(); viewPlayer(\'' + escapedName + '\')">' + p.name + '</span>';
                            legsDetailHtml += '<div style="font-family: \'Bebas Neue\', cursive; font-size: 16px; color: ' + (isBig ? 'var(--yellow)' : 'var(--text-dim)') + ';">' + pAvg + (isBig ? ' <b>BIG</b>' : '') + '</div>';
                            legsDetailHtml += '</div>';
                        });
                        legsDetailHtml += '</div>';

                        legsDetailHtml += '</div>'; // end grid

                        // Throws detail (hidden by default) - DartConnect style
                        legsDetailHtml += '<div id="throws-' + index + '-' + legIdx + '" class="throws-detail" style="display: none; background: var(--bg-panel); border-top: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 0 0 6px 6px;">';

                        if (leg.throws && leg.throws.length > 0) {
                            // Header row
                            legsDetailHtml += '<div style="display: grid; grid-template-columns: 30px 1fr 50px 30px 50px 1fr 30px; gap: 4px; font-size: 10px; color: var(--text-dim); padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 8px; text-align: center;">';
                            legsDetailHtml += '<div>!</div><div style="text-align: left;">Player</div><div>Score</div><div>Rnd</div><div>Score</div><div style="text-align: right;">Player</div><div>!</div>';
                            legsDetailHtml += '</div>';

                            // Throw rows
                            leg.throws.forEach(t => {
                                const homeT = t.home || {};
                                const awayT = t.away || {};
                                const homeNotable = homeT.notable || homeT.checkout;
                                const awayNotable = awayT.notable || awayT.checkout;
                                const isFirstThrow = (leg.first_throw === 'home' && t.round === 1);
                                const isAwayFirst = (leg.first_throw === 'away' && t.round === 1);

                                legsDetailHtml += '<div style="display: grid; grid-template-columns: 30px 1fr 50px 30px 50px 1fr 30px; gap: 4px; font-size: 11px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center;">';

                                // Home notable
                                legsDetailHtml += '<div style="color: var(--yellow); font-size: 9px; font-weight: 700;">' + (homeNotable === true ? (homeT.score >= 100 ? homeT.score : '') : (homeNotable || '')) + '</div>';

                                // Home player & score
                                if (homeT.player) {
                                    const bgStyle = isFirstThrow ? 'background: rgba(16, 185, 129, 0.2); padding: 2px 4px; border-radius: 3px;' : '';
                                    legsDetailHtml += '<div style="color: var(--pink); ' + bgStyle + '">' + homeT.player + '</div>';
                                    legsDetailHtml += '<div style="text-align: center; color: var(--pink);">' + (homeT.hit || homeT.score || '-') + '</div>';
                                } else {
                                    legsDetailHtml += '<div></div><div></div>';
                                }

                                // Round number
                                legsDetailHtml += '<div style="text-align: center; color: var(--yellow); font-weight: 700;">' + t.round + '</div>';

                                // Away score & player
                                if (awayT.player) {
                                    const bgStyle = isAwayFirst ? 'background: rgba(16, 185, 129, 0.2); padding: 2px 4px; border-radius: 3px;' : '';
                                    legsDetailHtml += '<div style="text-align: center; color: var(--teal);">' + (awayT.hit || awayT.score || '-') + '</div>';
                                    legsDetailHtml += '<div style="text-align: right; color: var(--teal); ' + bgStyle + '">' + awayT.player + '</div>';
                                } else {
                                    legsDetailHtml += '<div></div><div></div>';
                                }

                                // Away notable
                                legsDetailHtml += '<div style="color: var(--yellow); font-size: 9px; font-weight: 700; text-align: right;">' + (awayNotable === true ? (awayT.score >= 100 ? awayT.score : '') : (awayNotable || '')) + '</div>';

                                legsDetailHtml += '</div>';
                            });

                            // Footer with leg stats
                            legsDetailHtml += '<div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; margin-top: 12px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px;">';
                            // Use canonical field names with legacy fallbacks
                            const homeMpr = homeStats.cricket_mpr || homeStats.mpr || '-';
                            const homeTda = homeStats.x01_three_dart_avg || homeStats.three_dart_avg || '-';
                            const awayMpr = awayStats.cricket_mpr || awayStats.mpr || '-';
                            const awayTda = awayStats.x01_three_dart_avg || awayStats.three_dart_avg || '-';
                            legsDetailHtml += '<div style="color: var(--pink);"><b>' + (isCricket ? homeMpr + ' MPR' : homeTda + ' 3DA') + '</b> &bull; Darts: ' + (homeStats.darts || '-') + '</div>';
                            legsDetailHtml += '<div style="text-align: center; color: var(--text-dim);">' + (isCricket ? 'MPR' : '3 Dart Avg') + '</div>';
                            legsDetailHtml += '<div style="text-align: right; color: var(--teal);">Darts: ' + (awayStats.darts || '-') + ' &bull; <b>' + (isCricket ? awayMpr + ' MPR' : awayTda + ' 3DA') + '</b></div>';
                            legsDetailHtml += '</div>';

                            // Checkout info if available
                            if (leg.checkout) {
                                legsDetailHtml += '<div style="text-align: center; margin-top: 8px; color: var(--yellow); font-size: 11px;">';
                                legsDetailHtml += '<b>Checkout:</b> ' + leg.checkout.player + ' - ' + leg.checkout.out + ' in ' + leg.checkout.darts + ' dart' + (leg.checkout.darts > 1 ? 's' : '');
                                legsDetailHtml += '</div>';
                            }
                        } else {
                            // Show summary stats if no throw data
                            legsDetailHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 11px;">';
                            // Use canonical field names with legacy fallbacks
                            const sumHomeMpr = homeStats.cricket_mpr || homeStats.mpr || '-';
                            const sumHomeTda = homeStats.x01_three_dart_avg || homeStats.three_dart_avg || '-';
                            const sumAwayMpr = awayStats.cricket_mpr || awayStats.mpr || '-';
                            const sumAwayTda = awayStats.x01_three_dart_avg || awayStats.three_dart_avg || '-';
                            legsDetailHtml += '<div style="color: var(--pink);">';
                            legsDetailHtml += '<div><b>Darts:</b> ' + (homeStats.darts || '-') + '</div>';
                            if (isCricket) {
                                legsDetailHtml += '<div><b>MPR:</b> ' + sumHomeMpr + '</div>';
                                legsDetailHtml += '<div><b>Points:</b> ' + (homeStats.score || 0) + '</div>';
                            } else {
                                legsDetailHtml += '<div><b>3DA:</b> ' + sumHomeTda + '</div>';
                            }
                            if (legWinnerHome) legsDetailHtml += '<div style="color: var(--yellow); font-weight: 700; margin-top: 4px;">WINNER</div>';
                            legsDetailHtml += '</div>';
                            legsDetailHtml += '<div style="color: var(--teal); text-align: right;">';
                            legsDetailHtml += '<div><b>Darts:</b> ' + (awayStats.darts || '-') + '</div>';
                            if (isCricket) {
                                legsDetailHtml += '<div><b>MPR:</b> ' + sumAwayMpr + '</div>';
                                legsDetailHtml += '<div><b>Points:</b> ' + (awayStats.score || 0) + '</div>';
                            } else {
                                legsDetailHtml += '<div><b>3DA:</b> ' + sumAwayTda + '</div>';
                                if (awayStats.remaining) legsDetailHtml += '<div><b>Left:</b> ' + awayStats.remaining + '</div>';
                            }
                            if (!legWinnerHome) legsDetailHtml += '<div style="color: var(--yellow); font-weight: 700; margin-top: 4px;">WINNER</div>';
                            legsDetailHtml += '</div>';
                            legsDetailHtml += '</div>';
                        }

                        legsDetailHtml += '</div>'; // end throws detail
                        legsDetailHtml += '</div>'; // end leg card
                    });
                    legsDetailHtml += '</div>';
                }

                // Compact player names (first name + initial for doubles)
                const homeNames = game.home_players?.map(p => p?.name?.split(' ')[0] || 'TBD').join(' & ') || 'TBD';
                const awayNames = game.away_players?.map(p => p?.name?.split(' ')[0] || 'TBD').join(' & ') || 'TBD';

                html += `
                    <div class="game-card ${statusClass}" onclick="openGame(${index}, event)" data-game-index="${index}">
                        <div class="game-header ${statusClass}">
                            <span>SET ${roundNum} ‚Ä¢ ${gameType}</span>
                            <span class="game-format">${formatLabel}</span>
                        </div>
                        <div class="game-body">
                            <div class="game-players-row">
                                <span class="home">${homeNames}</span>
                                <span class="vs">vs</span>
                                <span class="away">${awayNames}</span>
                            </div>
                            ${isCompleted ? `
                                <div class="game-result">
                                    <span class="legs-score">${game.home_legs_won} - ${game.away_legs_won}</span>
                                    <span class="winner-badge">${game.winner === 'home' ? 'HOME' : 'AWAY'}</span>
                                </div>
                                ${game.legs && game.legs.length > 0 ? `
                                    <div style="margin-top: 8px; text-align: center;">
                                        <button onclick="toggleLegs(${index}, event)" style="background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim); padding: 4px 12px; border-radius: 4px; font-size: 10px; cursor: pointer;">
                                            <span id="legs-toggle-${index}">‚ñº LEGS</span>
                                        </button>
                                    </div>
                                ` : ''}
                                ${legsDetailHtml}
                            ` : statusClass === 'in_progress' ? `
                                <div class="game-result">
                                    <span class="legs-score">${game.home_legs_won || 0} - ${game.away_legs_won || 0}</span>
                                    <span style="color: var(--yellow); font-size: 10px; font-weight: 700;">LIVE</span>
                                </div>
                            ` : `
                                <div style="margin-top: 6px; text-align: center; color: var(--teal); font-size: 11px; font-weight: 600;">
                                    TAP TO START
                                </div>
                            `}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        window.toggleLegs = function(index, event) {
            event.stopPropagation();
            const legsEl = document.getElementById(`legs-${index}`);
            const toggleEl = document.getElementById(`legs-toggle-${index}`);
            if (legsEl.style.display === 'none') {
                legsEl.style.display = 'block';
                toggleEl.textContent = '‚ñ≤ HIDE LEGS';
            } else {
                legsEl.style.display = 'none';
                toggleEl.textContent = '‚ñº SHOW LEGS';
            }
        };

        window.toggleLegThrows = function(gameIdx, legIdx, event) {
            event.stopPropagation();
            const throwsEl = document.getElementById(`throws-${gameIdx}-${legIdx}`);
            if (throwsEl) {
                throwsEl.style.display = throwsEl.style.display === 'none' ? 'block' : 'none';
            }
        };

        window.toggleAllLegs = function(expand) {
            const games = matchData.games || [];
            games.forEach((game, idx) => {
                if (game.status === 'completed' && game.legs && game.legs.length > 0) {
                    const legsEl = document.getElementById(`legs-${idx}`);
                    const toggleEl = document.getElementById(`legs-toggle-${idx}`);
                    if (legsEl) {
                        legsEl.style.display = expand ? 'block' : 'none';
                        if (toggleEl) toggleEl.textContent = expand ? '‚ñ≤ HIDE LEGS' : '‚ñº SHOW LEGS';
                    }
                }
            });
            // Update the master toggle button
            const masterToggle = document.getElementById('master-legs-toggle');
            if (masterToggle) {
                masterToggle.dataset.expanded = expand ? 'true' : 'false';
                masterToggle.textContent = expand ? '‚ñ≤ COLLAPSE ALL' : '‚ñº EXPAND ALL';
            }
        };

        let pendingChoiceGameIndex = null;
        let pendingChoiceMode = null; // 'full' or 'simple'
        let selectedGameType = null;

        window.openGame = function(gameIndex, event) {
            const game = matchData.games[gameIndex];

            // Don't open scorer for completed games - just toggle legs if available
            if (game.status === 'completed') {
                if (game.legs && game.legs.length > 0) {
                    toggleLegs(gameIndex, event);
                }
                return;
            }

            // If format is "corks_choice", show the selection modal
            if (game.format === 'corks_choice') {
                showChoiceModal(gameIndex);
                return;
            }

            openScorerForGame(gameIndex, game.format);
        };

        function showChoiceModal(gameIndex) {
            pendingChoiceGameIndex = gameIndex;
            selectedGameType = null;

            const game = matchData.games[gameIndex];

            // Check if this is a mixed-leg corks_choice (has other games in same round to choose from)
            // or a round-level corks_choice (needs full game config)
            const roundGames = getAvailableRoundGames(gameIndex);

            if (roundGames.length > 0) {
                // Mixed-leg mode: show only games from this round
                pendingChoiceMode = 'simple';
                document.getElementById('choicePrompt').textContent = 'Cork winner picks from round games:';
                document.getElementById('simpleChoiceOptions').style.display = 'flex';
                document.getElementById('fullChoiceOptions').style.display = 'none';

                const optionsContainer = document.getElementById('simpleChoiceOptions');
                optionsContainer.innerHTML = roundGames.map(g => {
                    const isCricket = g.format === 'cricket';
                    const className = isCricket ? 'cricket' : 'x01';
                    const inOut = !isCricket ? ` ${g.in_rule === 'double' ? 'DI' : 'SI'}/${g.checkout === 'double' ? 'DO' : (g.checkout === 'master' ? 'MO' : 'SO')}` : '';
                    return `<button class="choice-option ${className}" onclick="selectSimpleChoice('${g.format}', '${g.in_rule || 'straight'}', '${g.checkout || 'double'}')">${g.format.toUpperCase()}${inOut}</button>`;
                }).join('');
            } else {
                // Full mode: show all game options with config
                pendingChoiceMode = 'full';
                document.getElementById('choicePrompt').textContent = 'Cork winner picks game and rules:';
                document.getElementById('simpleChoiceOptions').style.display = 'none';
                document.getElementById('fullChoiceOptions').style.display = 'block';
                document.getElementById('x01Config').style.display = 'none';

                // Reset button highlights
                document.querySelectorAll('#fullChoiceOptions .choice-option').forEach(btn => {
                    btn.style.border = '2px solid transparent';
                });
            }

            document.getElementById('choiceModal').classList.add('show');
        }

        function getAvailableRoundGames(gameIndex) {
            // For mixed-leg corks_choice, find other games in the same round
            // Games are grouped by type/round, so look for adjacent games with same type
            const games = matchData.games || [];
            const currentGame = games[gameIndex];
            const roundGames = [];

            // Look at all games and find ones that aren't corks_choice or mixed
            games.forEach((game, idx) => {
                if (idx !== gameIndex && game.format && game.format !== 'corks_choice' && game.format !== 'mixed') {
                    // Only include if it seems to be from the same round (same type = singles/doubles/triples)
                    if (game.type === currentGame.type) {
                        // Avoid duplicates
                        if (!roundGames.find(g => g.format === game.format && g.in_rule === game.in_rule && g.checkout === game.checkout)) {
                            roundGames.push({
                                format: game.format,
                                in_rule: game.in_rule || 'straight',
                                checkout: game.checkout || 'double'
                            });
                        }
                    }
                }
            });

            return roundGames;
        }

        // For simple mode (mixed-leg choice) - inherits rules from round game
        window.selectSimpleChoice = async function(format, inRule, outRule) {
            document.getElementById('choiceModal').classList.remove('show');

            if (pendingChoiceGameIndex !== null) {
                const gameIdx = pendingChoiceGameIndex;
                pendingChoiceGameIndex = null;

                try {
                    const matchRef = doc(db, 'leagues', leagueId, 'matches', matchId);
                    const updatedGames = [...matchData.games];
                    updatedGames[gameIdx] = {
                        ...updatedGames[gameIdx],
                        format: format,
                        in_rule: inRule,
                        checkout: outRule,
                        corks_choice_selected: true,
                        corks_choice_selected_at: new Date().toISOString()
                    };
                    await updateDoc(matchRef, { games: updatedGames });
                    matchData.games = updatedGames;
                } catch (err) {
                    console.error('Failed to persist corks choice:', err);
                }

                openScorerForGame(gameIdx, format);
            }
        };

        // For full mode (round-level choice) - select game type
        window.selectGameType = function(gameType) {
            selectedGameType = gameType;

            // Highlight selected button
            document.querySelectorAll('#fullChoiceOptions .choice-option').forEach(btn => {
                btn.style.border = btn.dataset.game === gameType ? '3px solid #fbbf24' : '2px solid transparent';
            });

            if (gameType === 'cricket') {
                // Cricket doesn't need config, go directly
                confirmCorksChoice();
            } else {
                // Show X01 config
                document.getElementById('x01Config').style.display = 'block';
            }
        };

        // Confirm full corks choice with config
        window.confirmCorksChoice = async function() {
            if (!selectedGameType || pendingChoiceGameIndex === null) return;

            const gameIdx = pendingChoiceGameIndex;
            const format = selectedGameType;
            const inRule = format === 'cricket' ? 'n/a' : document.getElementById('choiceInRule').value;
            const outRule = format === 'cricket' ? 'n/a' : document.getElementById('choiceOutRule').value;

            document.getElementById('choiceModal').classList.remove('show');
            pendingChoiceGameIndex = null;
            selectedGameType = null;

            try {
                const matchRef = doc(db, 'leagues', leagueId, 'matches', matchId);
                const updatedGames = [...matchData.games];
                updatedGames[gameIdx] = {
                    ...updatedGames[gameIdx],
                    format: format,
                    in_rule: inRule,
                    checkout: outRule,
                    corks_choice_selected: true,
                    corks_choice_selected_at: new Date().toISOString()
                };
                await updateDoc(matchRef, { games: updatedGames });
                matchData.games = updatedGames;
            } catch (err) {
                console.error('Failed to persist corks choice:', err);
            }

            openScorerForGame(gameIdx, format);
        };

        window.closeChoiceModal = function() {
            document.getElementById('choiceModal').classList.remove('show');
            pendingChoiceGameIndex = null;
        };

        function openScorerForGame(gameIndex, format) {
            const game = matchData.games[gameIndex];

            // Determine which scorer to open
            const scorerPage = format === 'cricket' ? 'league-cricket.html' : 'league-501.html';

            // Build URL with all needed params
            const params = new URLSearchParams({
                league_id: leagueId,
                match_id: matchId,
                game_index: gameIndex,
                game_number: game.game_number,
                format: format,
                type: game.type,
                in_rule: game.in_rule || 'straight',
                checkout: game.checkout || 'double'
            });

            // Add cork settings from league
            if (leagueSettings) {
                params.set('cork_rule', leagueSettings.cork_rule);
                params.set('cork_order', leagueSettings.cork_order);
            }

            // Add player info
            if (game.home_players) {
                params.set('home_players', JSON.stringify(game.home_players));
            }
            if (game.away_players) {
                params.set('away_players', JSON.stringify(game.away_players));
            }

            window.location.href = `/pages/${scorerPage}?${params.toString()}`;
        }

        window.refreshMatch = async function() {
            try {
                const matchDoc = await getDoc(doc(db, 'leagues', leagueId, 'matches', matchId));
                if (matchDoc.exists()) {
                    matchData = { id: matchId, ...matchDoc.data() };
                    renderMatch();
                }
            } catch (error) {
                alert('Error refreshing: ' + error.message);
            }
        };

        window.exitMatch = function() {
            if (unsubscribe) unsubscribe();
            if (confirm('Exit match hub? You can re-enter with the match PIN.')) {
                // Go back to league page if we have a league_id, otherwise home
                if (leagueId) {
                    window.location.href = `/pages/league-view.html?league_id=${leagueId}`;
                } else {
                    window.location.href = '/';
                }
            }
        };

        window.viewMatchReport = function() {
            if (leagueId && matchId) {
                window.location.href = `/pages/match-report.html?league_id=${leagueId}&match_id=${matchId}`;
            }
        };

        window.viewPlayer = function(playerName) {
            const encodedName = encodeURIComponent(playerName);
            window.location.href = `/pages/player-public.html?name=${encodedName}&league_id=${leagueId}`;
        };

        // Focus first PIN input
        pinInput.focus();
    </script>
<script src="/js/stats-helpers.js"></script>
<script src="/js/feedback.js"></script>
</body>
</html>
