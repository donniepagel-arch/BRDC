<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Report - BRDC</title>

    <!-- Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com">
    <link rel="preconnect" href="https://us-central1-brdc-35f92.cloudfunctions.net">
    <link rel="dns-prefetch" href="https://www.gstatic.com">

    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BRDC">
    <link rel="apple-touch-icon" href="/images/gold_logo.png">
    <meta name="theme-color" content="#FF469A">

    <!-- Fonts - non-blocking with display=swap -->
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --green: #10b981;
            --text-light: #f0f0f0;
            --text-primary: #f0f0f0;
            --text-dim: #8a8aa3;
            --text-secondary: #a0a0a0;
            --text-muted: #666;
            --black: #000000;
            --border: rgba(255, 255, 255, 0.1);
            --border-strong: #000;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-light);
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Header Bar */
        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .header-logo { width: 36px; height: 36px; }
        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            letter-spacing: 2px;
            color: var(--pink);
            flex: 1;
        }
        .back-btn {
            background: var(--bg-card);
            border: 2px solid var(--text-dim);
            border-radius: 8px;
            padding: 8px 14px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .back-btn:hover { border-color: var(--pink); color: var(--pink); }

        /* Breadcrumbs */
        .breadcrumbs {
            padding: 8px 16px;
            font-size: 12px;
            color: var(--text-dim);
            max-width: 1100px;
            margin: 0 auto;
        }
        .breadcrumbs ol {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin: 0;
            padding: 0;
        }
        .breadcrumbs li::after {
            content: '>';
            margin-left: 8px;
            color: var(--text-dim);
        }
        .breadcrumbs li:last-child::after {
            content: '';
        }
        .breadcrumbs a {
            color: var(--teal);
            text-decoration: none;
        }
        .breadcrumbs a:hover {
            text-decoration: underline;
        }

        /* Match Header Card */
        .match-header-card {
            background: var(--bg-panel);
            border: 3px solid var(--border-strong);
            border-radius: 16px;
            margin: 16px;
            overflow: hidden;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        .match-teams-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            gap: 16px;
        }

        .team-side {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .team-side.home { align-items: flex-end; text-align: right; }
        .team-side.away { align-items: flex-start; text-align: left; }

        .team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 1px;
        }
        .team-side.home .team-name { color: var(--pink); }
        .team-side.away .team-name { color: var(--teal); }
        .team-side.winner .team-name { color: var(--yellow); }

        .team-record {
            font-size: 11px;
            color: var(--text-dim);
        }

        .score-center {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-dark);
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid var(--border-strong);
        }
        .score-block {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .score-legs {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            color: var(--text-dim);
            opacity: 0.7;
        }
        .score-legs.home { color: var(--pink); }
        .score-legs.away { color: var(--teal); }
        .score-num {
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            min-width: 40px;
            text-align: center;
        }
        .score-num.home { color: var(--pink); }
        .score-num.away { color: var(--teal); }
        .score-num.winner { color: var(--yellow); }
        .score-dash { color: var(--text-dim); font-size: 32px; }

        .winner-star {
            color: #FFD700;
            font-size: 24px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }

        /* Match Metadata Grid */
        .match-meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1px;
            background: rgba(255,255,255,0.1);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .meta-item {
            background: var(--bg-panel);
            padding: 12px;
            text-align: center;
        }
        .meta-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .meta-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--yellow);
            margin-top: 2px;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: var(--bg-panel);
            border-bottom: 3px solid var(--border-strong);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tab-btn {
            flex: 1;
            min-width: 100px;
            padding: 14px 16px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            color: var(--text-dim);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
        }
        .tab-btn:hover { color: var(--text-light); background: rgba(255,255,255,0.05); }
        .tab-btn.active {
            color: var(--pink);
            border-bottom-color: var(--pink);
            background: rgba(255, 70, 154, 0.1);
        }

        /* Tab Content */
        .tab-content { display: none; padding: 16px; }
        .tab-content.active { display: block; }

        /* Game Cards (from league-view) */
        .games-container { max-width: 600px; margin: 0 auto; }

        .expand-all-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 12px;
        }
        .expand-all-btn {
            background: var(--bg-panel);
            border: 2px solid var(--yellow);
            color: var(--yellow);
            padding: 8px 16px;
            border-radius: 8px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .expand-all-btn:hover {
            background: var(--yellow);
            color: var(--black);
        }

        .game-card {
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 12px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
            margin-bottom: 12px;
            overflow: hidden;
        }

        .game-card-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 14px 16px;
            background: rgba(0,0,0,0.4);
            border-bottom: 2px solid rgba(0,0,0,0.5);
            gap: 8px;
        }

        .game-team-side {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .game-team-side.left { align-items: flex-end; text-align: right; }
        .game-team-side.right { align-items: flex-start; text-align: left; }

        .game-player-name {
            font-weight: 600;
            font-size: 14px;
        }
        .game-team-side.left .game-player-name { color: var(--pink); }
        .game-team-side.right .game-player-name { color: var(--teal); }
        .game-team-side.winner .game-player-name { color: var(--yellow); }

        .game-player-stats {
            font-size: 11px;
            color: var(--text-dim);
        }
        .game-player-stats .big { color: var(--yellow); font-weight: 700; }

        .game-score-center {
            text-align: center;
        }
        .game-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: var(--text-light);
        }
        .game-format-badge {
            display: inline-block;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            background: var(--teal);
            color: var(--black);
            border-radius: 4px;
            margin-top: 4px;
        }

        .game-card-body {
            padding: 12px 16px;
        }

        .game-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-dim);
        }
        .game-type-label {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--text-dim);
        }

        .toggle-detail-btn {
            background: transparent;
            border: 1px solid var(--text-dim);
            color: var(--text-dim);
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .toggle-detail-btn:hover {
            border-color: var(--yellow);
            color: var(--yellow);
        }
        .toggle-detail-btn.expanded {
            border-color: var(--yellow);
            color: var(--yellow);
            background: rgba(253, 216, 53, 0.1);
        }

        /* Leg Detail Cards */
        .legs-detail {
            display: none;
            border-top: 2px solid rgba(255,255,255,0.1);
            padding: 12px;
            background: rgba(0,0,0,0.2);
        }
        .legs-detail.expanded { display: block; }

        .leg-card {
            background: var(--bg-dark);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid var(--text-dim);
            overflow: hidden;
        }
        .leg-card.home-won { border-color: var(--pink); }
        .leg-card.away-won { border-color: var(--teal); }

        .leg-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            padding: 12px;
            gap: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .leg-header:hover { background: rgba(255,255,255,0.05); }

        .leg-player-side {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .leg-player-side.left { align-items: flex-start; }
        .leg-player-side.right { align-items: flex-end; text-align: right; }

        .leg-player-name {
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
        }
        .leg-player-name:hover { text-decoration: underline; }
        .leg-player-side.left .leg-player-name { color: var(--pink); }
        .leg-player-side.right .leg-player-name { color: var(--teal); }

        .cork-badge {
            display: inline-block;
            background: var(--yellow);
            color: var(--bg-dark);
            font-size: 9px;
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 3px;
            vertical-align: middle;
        }

        .leg-player-stat {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--text-dim);
        }
        .leg-player-stat.big { color: var(--yellow); }

        .leg-center {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .leg-number {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--yellow);
        }
        .leg-format {
            font-size: 10px;
            color: var(--text-dim);
            background: var(--bg-panel);
            padding: 2px 8px;
            border-radius: 4px;
        }
        .leg-expand-hint {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Throws Detail */
        .throws-detail {
            display: none;
            background: var(--bg-panel);
            padding: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .throws-detail.expanded { display: block; }

        .throws-header {
            display: grid;
            grid-template-columns: 1fr 50px 30px 50px 1fr;
            gap: 4px;
            font-size: 10px;
            color: var(--text-dim);
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 8px;
            text-align: center;
        }
        .throws-header > div:first-child { text-align: left; }
        .throws-header > div:last-child { text-align: right; }

        .throw-row {
            display: grid;
            grid-template-columns: 1fr 50px 30px 50px 1fr;
            gap: 4px;
            font-size: 11px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            align-items: center;
        }
        .throw-row .home { color: var(--pink); }
        .throw-row .away { color: var(--teal); text-align: right; }
        .throw-row .round { text-align: center; color: var(--yellow); font-weight: 700; }
        .throw-row .score { text-align: center; }
        .throw-row .notable { color: var(--yellow); font-weight: 700; font-size: 10px; }
        .throw-row .score.notable-score {
            color: var(--yellow);
            font-weight: 700;
            background: rgba(253, 216, 53, 0.15);
            border-radius: 4px;
            padding: 2px 4px;
        }
        .throw-row .score.checkout-score {
            color: var(--green);
            font-weight: 700;
            background: rgba(16, 185, 129, 0.15);
            border-radius: 4px;
            padding: 2px 4px;
        }
        .checkout-badge {
            font-size: 9px;
            color: var(--green);
            font-weight: 600;
            margin-left: 4px;
        }
        .throw-row .notable {
            display: inline-block;
            background: rgba(253, 216, 53, 0.2);
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 4px;
            font-size: 9px;
        }
        .throw-row .away .notable {
            margin-left: 0;
            margin-right: 4px;
        }

        .leg-summary {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 8px;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 11px;
        }
        .leg-summary .home { color: var(--pink); }
        .leg-summary .away { color: var(--teal); text-align: right; }
        .leg-summary .center { text-align: center; color: var(--text-dim); }

        /* Placeholder tabs */
        .tab-placeholder {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }
        .tab-placeholder h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--yellow);
            margin-bottom: 10px;
        }

        /* Performance Tab - DC Style */
        .performance-container { max-width: 700px; margin: 0 auto; }

        /* Leaders Section */
        .perf-leaders-section {
            background: var(--bg-card);
            border: 2px solid var(--border-strong);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .perf-leaders-header {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            padding: 10px 14px;
            background: rgba(0,0,0,0.3);
            color: var(--yellow);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .perf-leaders-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
            background: rgba(255,255,255,0.1);
        }
        .perf-leader-item {
            background: var(--bg-card);
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .perf-leader-label {
            font-size: 11px;
            color: var(--text-dim);
        }
        .perf-leader-value {
            text-align: right;
        }
        .perf-leader-stat {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 16px;
            color: var(--yellow);
        }
        .perf-leader-name {
            font-size: 10px;
            color: var(--text-dim);
        }
        .perf-leader-name.home { color: var(--pink); }
        .perf-leader-name.away { color: var(--teal); }

        /* Player Summary Table */
        .perf-summary-section {
            background: var(--bg-card);
            border: 2px solid var(--border-strong);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .perf-summary-header {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            padding: 10px 14px;
            background: rgba(0,0,0,0.3);
            color: var(--yellow);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .perf-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .perf-table th {
            background: rgba(0,0,0,0.2);
            padding: 8px 6px;
            text-align: center;
            color: var(--text-dim);
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .perf-table th.section-header {
            background: rgba(255,255,255,0.05);
            color: var(--yellow);
            font-family: 'Bebas Neue', cursive;
            font-size: 12px;
            letter-spacing: 1px;
        }
        .perf-table th:first-child { text-align: left; padding-left: 12px; }
        .perf-table td {
            padding: 8px 6px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .perf-table td:first-child { text-align: left; padding-left: 12px; }
        .perf-table tr:hover { background: rgba(255,255,255,0.03); }
        .perf-table .player-name {
            font-weight: 600;
            font-size: 12px;
        }
        .perf-table .player-name.home { color: var(--pink); }
        .perf-table .player-name.away { color: var(--teal); }
        .perf-table .highlight { color: var(--yellow); font-weight: 700; }
        .perf-table .best { color: var(--green); font-weight: 700; }
        .perf-table .dim { color: var(--text-muted); }

        /* Game Detail Table */
        .perf-detail-section {
            background: var(--bg-card);
            border: 2px solid var(--border-strong);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .perf-detail-header {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            padding: 10px 14px;
            background: rgba(0,0,0,0.3);
            color: var(--yellow);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .perf-detail-toggle {
            background: transparent;
            border: 1px solid var(--text-dim);
            color: var(--text-dim);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .perf-detail-toggle:hover { border-color: var(--yellow); color: var(--yellow); }
        .perf-detail-toggle.active { border-color: var(--yellow); color: var(--yellow); background: rgba(253,216,53,0.1); }
        .perf-detail-body {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .detail-table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
            font-size: 10px;
        }
        .detail-table th {
            background: rgba(0,0,0,0.2);
            padding: 6px 4px;
            text-align: center;
            color: var(--text-dim);
            font-weight: 600;
            font-size: 9px;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap;
        }
        .detail-table td {
            padding: 5px 4px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            white-space: nowrap;
        }
        .detail-table .game-cell {
            font-weight: 700;
            color: var(--yellow);
            text-align: left;
            padding-left: 8px;
        }
        .detail-table .format-cell {
            font-size: 9px;
            color: var(--teal);
        }
        .detail-table .player-cell {
            text-align: left;
            font-weight: 500;
        }
        .detail-table .player-cell.home { color: var(--pink); }
        .detail-table .player-cell.away { color: var(--teal); }
        .detail-table .cork-cell { color: var(--green); }
        .detail-table .win-cell { color: var(--green); font-weight: 700; }
        .detail-table .stat-highlight { color: var(--yellow); font-weight: 600; }
        .detail-table tr.set-divider td {
            border-top: 2px solid var(--yellow);
        }

        /* Checkout Range Table */
        .checkout-range-section {
            background: var(--bg-card);
            border: 2px solid var(--border-strong);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .checkout-range-header {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            padding: 10px 14px;
            background: rgba(0,0,0,0.3);
            color: var(--yellow);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .checkout-range-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .checkout-range-table th {
            background: rgba(0,0,0,0.2);
            padding: 8px 6px;
            text-align: center;
            color: var(--text-dim);
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .checkout-range-table th:first-child { text-align: left; padding-left: 12px; }
        .checkout-range-table td {
            padding: 8px 6px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .checkout-range-table td:first-child { text-align: left; padding-left: 12px; }
        .checkout-range-table tr:hover { background: rgba(255,255,255,0.03); }
        .checkout-range-table .range-label {
            font-weight: 600;
            color: var(--yellow);
        }
        .checkout-range-table .pct { font-weight: 600; }
        .checkout-range-table .pct.good { color: var(--green); }
        .checkout-range-table .pct.avg { color: var(--yellow); }
        .checkout-range-table .no-data { color: var(--text-muted); }

        /* Counts Tab */
        .counts-container { max-width: 600px; margin: 0 auto; }
        .counts-section {
            background: var(--bg-card);
            border: 2px solid var(--border-strong);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .counts-section-header {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            padding: 10px 14px;
            background: rgba(0,0,0,0.3);
            color: var(--yellow);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .counts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
            background: rgba(255,255,255,0.1);
        }
        .count-item {
            background: var(--bg-card);
            padding: 12px;
            text-align: center;
        }
        .count-label {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 4px;
        }
        .count-values {
            display: flex;
            justify-content: center;
            gap: 8px;
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
        }
        .count-values .home { color: var(--pink); }
        .count-values .away { color: var(--teal); }
        .count-values .vs { color: var(--text-dim); font-size: 16px; }

        /* Leaders Tab */
        .leaders-container { max-width: 600px; margin: 0 auto; }
        .leader-card {
            background: var(--bg-card);
            border: 2px solid var(--border-strong);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .leader-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: rgba(0,0,0,0.3);
        }
        .leader-category {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--yellow);
        }
        .leader-card-body { padding: 10px 14px; }
        .leader-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .leader-row:last-child { border-bottom: none; }
        .leader-rank {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            margin-right: 10px;
        }
        .leader-rank.gold { background: #FFD700; color: var(--black); }
        .leader-rank.silver { background: #C0C0C0; color: var(--black); }
        .leader-rank.bronze { background: #CD7F32; color: var(--black); }
        .leader-player {
            flex: 1;
            font-size: 13px;
        }
        .leader-player.home { color: var(--pink); }
        .leader-player.away { color: var(--teal); }
        .leader-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 14px;
            color: var(--yellow);
        }
        .leader-info { display: flex; align-items: center; }

        /* Player link */
        .player-link { cursor: pointer; transition: all 0.15s; }
        .player-link:hover { text-decoration: underline; filter: brightness(1.2); }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-dim);
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-card);
            border-top-color: var(--pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ============================================
           PRE-MATCH VIEW STYLES
           ============================================ */
        .pre-match-header {
            background: var(--bg-panel);
            border: 3px solid var(--border-strong);
            border-radius: 16px;
            margin: 16px;
            overflow: hidden;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        .pre-match-teams-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            gap: 16px;
        }

        .pre-match-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .pre-match-week {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        .pre-match-vs {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: var(--yellow);
            letter-spacing: 2px;
        }

        .pre-match-team-side {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .pre-match-team-side.home { align-items: flex-end; text-align: right; }
        .pre-match-team-side.away { align-items: flex-start; text-align: left; }

        .pre-match-team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 26px;
            letter-spacing: 1px;
        }
        .pre-match-team-side.home .pre-match-team-name { color: var(--pink); }
        .pre-match-team-side.away .pre-match-team-name { color: var(--teal); }

        .pre-match-team-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .pre-match-team-side.home .pre-match-team-info { flex-direction: row-reverse; }

        .pre-match-standing {
            color: var(--yellow);
            font-weight: 700;
        }

        .pre-match-record {
            color: var(--text-dim);
        }

        .pre-match-avg {
            color: var(--text-secondary);
            font-size: 11px;
        }

        /* Match Details Section */
        .pre-match-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: rgba(255,255,255,0.1);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .pre-match-detail-item {
            background: var(--bg-panel);
            padding: 12px;
            text-align: center;
        }

        .pre-match-detail-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .pre-match-detail-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--text-light);
        }

        /* Roster Section */
        .pre-match-roster-section {
            background: var(--bg-panel);
            border: 3px solid var(--border-strong);
            border-radius: 16px;
            margin: 16px;
            overflow: hidden;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        .pre-match-roster-header {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            padding: 12px 16px;
            background: rgba(0,0,0,0.3);
            color: var(--yellow);
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .pre-match-roster {
            padding: 0;
        }

        .pre-match-roster-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .pre-match-roster-row:last-child {
            border-bottom: none;
        }

        .pre-match-player-cell {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
        }

        .pre-match-player-cell.home {
            border-right: 1px solid rgba(255,255,255,0.1);
            flex-direction: row-reverse;
        }

        .pre-match-player-name {
            font-size: 13px;
            font-weight: 500;
        }

        .pre-match-player-cell.home .pre-match-player-name {
            color: var(--pink);
            text-align: right;
        }

        .pre-match-player-cell.away .pre-match-player-name {
            color: var(--teal);
        }

        .pre-match-player-name.captain::before {
            content: '★ ';
            color: var(--yellow);
        }

        .pre-match-player-cell.away .pre-match-player-name.captain::before {
            content: none;
        }

        .pre-match-player-cell.away .pre-match-player-name.captain::after {
            content: ' ★';
            color: var(--yellow);
        }

        .pre-match-player-stats {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-dim);
        }

        .pre-match-player-stats .better {
            color: var(--green);
        }

        .pre-match-player-stats .worse {
            color: var(--text-muted);
        }

        /* Attendance Section */
        .pre-match-attendance-section {
            background: var(--bg-panel);
            border: 3px solid var(--border-strong);
            border-radius: 16px;
            margin: 16px;
            padding: 16px;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        .pre-match-attendance-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--yellow);
            margin-bottom: 12px;
            text-align: center;
        }

        .pre-match-attendance-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .attendance-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 16px;
            border-radius: 8px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid;
        }

        .attendance-btn.confirm {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--green);
            color: var(--green);
        }

        .attendance-btn.confirm:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .attendance-btn.confirm.active {
            background: var(--green);
            color: #000;
        }

        .attendance-btn.decline {
            background: rgba(239, 68, 68, 0.15);
            border-color: #ef4444;
            color: #ef4444;
        }

        .attendance-btn.decline:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .attendance-btn.decline.active {
            background: #ef4444;
            color: #fff;
        }

        .attendance-status {
            text-align: center;
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-dim);
        }

        .attendance-status.confirmed {
            color: var(--green);
        }

        .attendance-status.declined {
            color: #ef4444;
        }

        /* Action Buttons */
        .pre-match-actions {
            display: flex;
            gap: 12px;
            margin: 16px;
        }

        .action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 16px;
            border-radius: 8px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            border: 2px solid;
        }

        .action-btn.primary {
            background: var(--pink);
            border-color: var(--pink);
            color: #fff;
        }

        .action-btn.primary:hover {
            background: #ff5ca8;
            transform: translateY(-2px);
        }

        .action-btn.secondary {
            background: transparent;
            border-color: var(--teal);
            color: var(--teal);
        }

        .action-btn.secondary:hover {
            background: rgba(145, 215, 235, 0.15);
        }

        /* Pre-Match Game Cards */
        .pre-match-games-section {
            background: var(--bg-panel);
            border: 3px solid var(--border-strong);
            border-radius: 16px;
            margin: 16px;
            overflow: hidden;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        .pre-match-games-header {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            padding: 12px 16px;
            background: rgba(0,0,0,0.3);
            color: var(--yellow);
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .pre-match-games-list {
            padding: 0;
        }

        .pre-match-game-card {
            border-bottom: 1px solid rgba(255,255,255,0.08);
            padding: 14px 16px;
        }

        .pre-match-game-card:last-child {
            border-bottom: none;
        }

        .game-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .game-number {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        .game-type-badge {
            font-family: 'Bebas Neue', cursive;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 4px;
            letter-spacing: 0.5px;
        }

        .game-type-badge.x01 {
            background: var(--pink);
            color: #fff;
        }

        .game-type-badge.cricket {
            background: var(--teal);
            color: #000;
        }

        .game-type-badge.singles {
            background: rgba(255,255,255,0.1);
            color: var(--text-dim);
        }

        .game-type-badge.doubles {
            background: rgba(253, 216, 53, 0.2);
            color: var(--yellow);
        }

        .game-card-matchup {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
        }

        .game-player {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .game-player.home {
            text-align: right;
        }

        .game-player.away {
            text-align: left;
        }

        .game-player .player-name {
            font-size: 14px;
            font-weight: 600;
        }

        .game-player.home .player-name {
            color: var(--pink);
        }

        .game-player.away .player-name {
            color: var(--teal);
        }

        .game-player .player-name.tbd {
            color: var(--text-muted);
            font-style: italic;
        }

        .vs-badge {
            font-family: 'Bebas Neue', cursive;
            font-size: 12px;
            color: var(--text-muted);
            padding: 0 8px;
        }

        .game-card-rules {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .game-card-rules span {
            background: rgba(255,255,255,0.05);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .game-type-badge.choice {
            background: var(--yellow);
            color: #000;
        }

        .start-set-btn {
            display: block;
            text-align: center;
            text-decoration: none;
            width: 100%;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--pink), #d63384);
            border: 2px solid var(--border-strong);
            border-radius: 8px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
        }

        .start-set-btn:hover {
            transform: translateY(-2px);
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
        }

        .start-set-btn.completed {
            background: var(--bg-card);
            color: var(--text-dim);
            cursor: default;
            box-shadow: none;
        }

        .start-set-btn.completed:hover {
            transform: none;
        }

        .start-set-btn.in-progress {
            background: linear-gradient(135deg, var(--yellow), #f9a825);
            color: #000;
        }

        .no-format-message {
            padding: 30px 20px;
            text-align: center;
            color: var(--text-dim);
        }

        .no-format-message p {
            margin-bottom: 12px;
        }

        /* Responsive - Tablet */
        @media (max-width: 768px) {
            /* Performance leaders: stack on smaller screens */
            .perf-leaders-grid {
                grid-template-columns: 1fr;
            }

            /* Toggle buttons: ensure 44px touch target */
            .toggle-detail-btn {
                min-height: 44px;
                padding: 10px 16px;
                font-size: 12px;
            }

            /* Throws grid: allow horizontal scroll */
            .throws-detail {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .throws-header,
            .throw-row {
                min-width: 320px;
            }
        }

        /* Responsive - Mobile */
        @media (max-width: 500px) {
            .team-name { font-size: 22px; }
            .score-num { font-size: 36px; }
            .match-teams-row { padding: 16px 12px; gap: 10px; }
            .tab-btn { font-size: 13px; padding: 12px 10px; }
            .pre-match-team-name { font-size: 22px; }
            .pre-match-vs { font-size: 28px; }
            .pre-match-teams-row { padding: 16px 12px; gap: 10px; }
            .pre-match-attendance-buttons { grid-template-columns: 1fr; }
            .pre-match-actions { flex-direction: column; }

            /* Throws grid: use minmax for flexible columns */
            .throws-header,
            .throw-row {
                grid-template-columns: minmax(60px, 1fr) minmax(40px, 50px) 28px minmax(40px, 50px) minmax(60px, 1fr);
                font-size: 10px;
            }

            /* Performance leaders items */
            .perf-leader-item {
                padding: 8px 10px;
            }
            .perf-leader-stat {
                font-size: 14px;
            }
        }

        /* Responsive - Small Mobile */
        @media (max-width: 380px) {
            .throws-header,
            .throw-row {
                grid-template-columns: minmax(50px, 1fr) 38px 24px 38px minmax(50px, 1fr);
                gap: 2px;
                font-size: 9px;
            }
            .throw-row .score.notable-score {
                padding: 1px 2px;
            }

            /* Celebration overlay adjustments */
            .celebration-title {
                font-size: 36px;
            }
            .celebration-score .score-num {
                font-size: 48px;
            }
            .celebration-team-name {
                font-size: 18px;
            }
        }

        /* Print Button */
        .print-btn {
            background: var(--bg-card);
            border: 2px solid var(--yellow);
            border-radius: 8px;
            padding: 8px 14px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--yellow);
            cursor: pointer;
            margin-left: auto;
            transition: all 0.2s;
        }
        .print-btn:hover {
            background: var(--yellow);
            color: var(--bg-dark);
        }

        /* Player Filter */
        .player-filter {
            background: var(--bg-panel);
            border: 2px solid var(--text-dim);
            border-radius: 12px;
            padding: 12px 15px;
            margin: 0 16px 16px 16px;
        }
        .filter-label {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--yellow);
            margin-bottom: 8px;
        }
        .filter-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .filter-chip {
            background: var(--bg-card);
            border: 2px solid var(--text-dim);
            border-radius: 20px;
            padding: 8px 14px;
            min-height: 40px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .filter-chip:hover { border-color: var(--teal); }
        .filter-chip.active { background: var(--pink); border-color: var(--pink); color: white; }
        .filter-chip.home { border-color: var(--pink); }
        .filter-chip.away { border-color: var(--teal); }

        /* H2H Section */
        .h2h-section {
            background: var(--bg-panel);
            border: 2px solid var(--yellow);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }
        .h2h-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        @media (min-width: 600px) {
            .h2h-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        .h2h-selectors {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .h2h-selector {
            background: var(--bg-card);
            border: 2px solid var(--text-dim);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-light);
            font-size: 13px;
            cursor: pointer;
        }
        .h2h-selector:focus { outline: none; border-color: var(--yellow); }
        .h2h-vs {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--yellow);
        }
        .h2h-results {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            align-items: center;
        }
        @media (min-width: 600px) {
            .h2h-results {
                grid-template-columns: 1fr auto 1fr;
                gap: 20px;
            }
        }
        .h2h-player {
            text-align: center;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 8px;
        }
        .h2h-player.player1 { border-left: 4px solid var(--pink); }
        .h2h-player.player2 { border-right: 4px solid var(--teal); }
        .h2h-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            margin-bottom: 8px;
        }
        .h2h-player.player1 .h2h-name { color: var(--pink); }
        .h2h-player.player2 .h2h-name { color: var(--teal); }
        .h2h-score-block { text-align: center; }
        .h2h-legs-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 42px;
            color: var(--yellow);
        }
        .h2h-label { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
        .h2h-leg-list {
            margin-top: 20px;
        }
        .h2h-leg-item {
            padding: 8px;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        /* Print Styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            body::before { display: none; }
            .header-bar {
                background: white !important;
                border-bottom: 2px solid #333 !important;
                position: relative;
                box-shadow: none;
            }
            .back-btn, .print-btn, .player-filter, .tab-nav, .expand-all-bar {
                display: none !important;
            }
            .tab-content { display: block !important; padding: 10px; }
            .match-header-card {
                box-shadow: none;
                border: 2px solid #333;
            }
            .match-teams-row { background: #f0f0f0 !important; }
            .team-name { color: black !important; }
            .team-side.home .team-name { color: #d63384 !important; }
            .team-side.away .team-name { color: #0d6efd !important; }
            .game-card, .perf-summary-section, .counts-card {
                box-shadow: none;
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
            .meta-item, .stat-cell, .leg-row {
                background: white !important;
            }
            .meta-label, .meta-value, .section-title {
                color: #333 !important;
            }
            .legs-detail { display: block !important; }
            #preMatchContent, .celebration-overlay { display: none !important; }
        }

        /* Skeleton Loading States */
        .skeleton {
            background: linear-gradient(90deg, #1e2a47 25%, #2a3a57 50%, #1e2a47 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-set-card {
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 12px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
            margin-bottom: 12px;
            overflow: hidden;
        }
        .skeleton-set-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 14px 16px;
            background: rgba(0,0,0,0.4);
            gap: 12px;
        }
        .skeleton-player-side {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .skeleton-player-side.left { align-items: flex-end; }
        .skeleton-player-side.right { align-items: flex-start; }
        .skeleton-player-name {
            height: 16px;
            width: 100px;
        }
        .skeleton-player-stats {
            height: 12px;
            width: 70px;
        }
        .skeleton-score-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .skeleton-score {
            height: 32px;
            width: 60px;
        }
        .skeleton-format {
            height: 18px;
            width: 50px;
            border-radius: 4px;
        }
        .skeleton-set-body {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .skeleton-type {
            height: 14px;
            width: 80px;
        }
        .skeleton-btn {
            height: 28px;
            width: 90px;
            border-radius: 6px;
        }

        /* Match Complete Celebration Overlay */
        .celebration-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.92);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        .celebration-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .celebration-content {
            text-align: center;
            padding: 40px 30px;
            max-width: 420px;
            width: 90%;
            animation: celebrationPop 0.5s ease-out;
        }
        @keyframes celebrationPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        .celebration-trophy {
            font-size: 72px;
            margin-bottom: 10px;
            animation: trophyBounce 1s ease-in-out infinite;
        }
        @keyframes trophyBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .celebration-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            letter-spacing: 4px;
            color: var(--yellow);
            text-shadow: 0 0 30px rgba(253, 216, 53, 0.5);
            margin-bottom: 20px;
        }
        .celebration-score-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .celebration-team {
            text-align: center;
            flex: 1;
            max-width: 140px;
        }
        .celebration-team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 1px;
            color: var(--text-light);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .celebration-team.winner .celebration-team-name {
            color: var(--yellow);
            text-shadow: 0 0 15px rgba(253, 216, 53, 0.4);
        }
        .celebration-team.winner::before {
            content: '⭐';
            display: block;
            font-size: 28px;
            margin-bottom: 6px;
            animation: starPulse 1.5s ease-in-out infinite;
        }
        @keyframes starPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        .celebration-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 64px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .celebration-score .score-num {
            min-width: 50px;
        }
        .celebration-score .score-num.winner {
            color: var(--yellow);
            text-shadow: 0 0 20px rgba(253, 216, 53, 0.5);
        }
        .celebration-score .score-dash {
            color: var(--text-dim);
            font-size: 48px;
        }
        .celebration-legs {
            font-size: 14px;
            color: var(--text-dim);
            margin-top: 5px;
        }
        .celebration-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 30px;
        }
        .celebration-btn {
            padding: 14px 28px;
            border-radius: 10px;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            text-decoration: none;
            display: block;
        }
        .celebration-btn.primary {
            background: linear-gradient(135deg, var(--pink) 0%, #d63384 100%);
            color: white;
            border-color: #000;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
        }
        .celebration-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }
        .celebration-btn.secondary {
            background: var(--bg-card);
            color: var(--text-light);
            border-color: var(--text-dim);
        }
        .celebration-btn.secondary:hover {
            border-color: var(--teal);
            color: var(--teal);
        }
        .celebration-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 28px;
            cursor: pointer;
            padding: 10px;
            transition: color 0.2s;
        }
        .celebration-close:hover {
            color: var(--text-light);
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }
        .celebration-overlay.active .confetti {
            animation: confettiFall 3s ease-out forwards;
        }
        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Tooltip hints for stats jargon */
        [data-tooltip] {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted var(--text-dim);
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-dark);
            border: 1px solid var(--teal);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            color: var(--text-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            pointer-events: none;
        }
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: calc(100% - 5px);
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--teal);
            z-index: 1001;
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <button class="back-btn" onclick="goBack()">← BACK</button>
        <img src="/images/gold_logo.png" alt="BRDC" class="header-logo">
        <span class="header-title">MATCH REPORT</span>
        <button class="print-btn" onclick="window.print()">PRINT / SHARE</button>
    </div>

    <nav class="breadcrumbs" aria-label="Breadcrumb" id="breadcrumbs">
        <ol>
            <li><a href="/pages/dashboard.html">Dashboard</a></li>
            <li><a href="#" id="breadcrumbLeague">League</a></li>
            <li aria-current="page">Match Report</li>
        </ol>
    </nav>

    <div id="loadingState">
        <!-- Skeleton loading state for match header -->
        <div class="match-header-card" style="margin: 16px;">
            <div class="match-teams-row">
                <div class="skeleton-player-side left">
                    <div class="skeleton skeleton-player-name" style="width: 120px; height: 28px;"></div>
                    <div class="skeleton skeleton-player-stats" style="width: 80px;"></div>
                </div>
                <div class="skeleton-score-center">
                    <div class="skeleton skeleton-score" style="height: 48px; width: 100px;"></div>
                </div>
                <div class="skeleton-player-side right">
                    <div class="skeleton skeleton-player-name" style="width: 120px; height: 28px;"></div>
                    <div class="skeleton skeleton-player-stats" style="width: 80px;"></div>
                </div>
            </div>
            <div class="match-meta-grid">
                <div class="meta-item"><div class="skeleton" style="height: 14px; width: 40px; margin: 0 auto 4px;"></div><div class="skeleton" style="height: 20px; width: 60px; margin: 0 auto;"></div></div>
                <div class="meta-item"><div class="skeleton" style="height: 14px; width: 40px; margin: 0 auto 4px;"></div><div class="skeleton" style="height: 20px; width: 60px; margin: 0 auto;"></div></div>
                <div class="meta-item"><div class="skeleton" style="height: 14px; width: 40px; margin: 0 auto 4px;"></div><div class="skeleton" style="height: 20px; width: 60px; margin: 0 auto;"></div></div>
                <div class="meta-item"><div class="skeleton" style="height: 14px; width: 40px; margin: 0 auto 4px;"></div><div class="skeleton" style="height: 20px; width: 60px; margin: 0 auto;"></div></div>
            </div>
        </div>
        <!-- Skeleton tabs -->
        <div style="display: flex; background: var(--bg-panel); border-bottom: 3px solid var(--border-strong); padding: 0 16px;">
            <div class="skeleton" style="height: 44px; width: 80px; margin: 0 4px; border-radius: 0;"></div>
            <div class="skeleton" style="height: 44px; width: 110px; margin: 0 4px; border-radius: 0;"></div>
            <div class="skeleton" style="height: 44px; width: 80px; margin: 0 4px; border-radius: 0;"></div>
            <div class="skeleton" style="height: 44px; width: 80px; margin: 0 4px; border-radius: 0;"></div>
        </div>
        <!-- Skeleton games list -->
        <div style="padding: 16px; max-width: 600px; margin: 0 auto;">
            <div class="skeleton-set-card">
                <div class="skeleton-set-header">
                    <div class="skeleton-player-side left"><div class="skeleton skeleton-player-name"></div><div class="skeleton skeleton-player-stats"></div></div>
                    <div class="skeleton-score-center"><div class="skeleton skeleton-score"></div><div class="skeleton skeleton-format"></div></div>
                    <div class="skeleton-player-side right"><div class="skeleton skeleton-player-name"></div><div class="skeleton skeleton-player-stats"></div></div>
                </div>
                <div class="skeleton-set-body"><div class="skeleton skeleton-type"></div><div class="skeleton skeleton-btn"></div></div>
            </div>
            <div class="skeleton-set-card">
                <div class="skeleton-set-header">
                    <div class="skeleton-player-side left"><div class="skeleton skeleton-player-name"></div><div class="skeleton skeleton-player-stats"></div></div>
                    <div class="skeleton-score-center"><div class="skeleton skeleton-score"></div><div class="skeleton skeleton-format"></div></div>
                    <div class="skeleton-player-side right"><div class="skeleton skeleton-player-name"></div><div class="skeleton skeleton-player-stats"></div></div>
                </div>
                <div class="skeleton-set-body"><div class="skeleton skeleton-type"></div><div class="skeleton skeleton-btn"></div></div>
            </div>
            <div class="skeleton-set-card">
                <div class="skeleton-set-header">
                    <div class="skeleton-player-side left"><div class="skeleton skeleton-player-name"></div><div class="skeleton skeleton-player-stats"></div></div>
                    <div class="skeleton-score-center"><div class="skeleton skeleton-score"></div><div class="skeleton skeleton-format"></div></div>
                    <div class="skeleton-player-side right"><div class="skeleton skeleton-player-name"></div><div class="skeleton skeleton-player-stats"></div></div>
                </div>
                <div class="skeleton-set-body"><div class="skeleton skeleton-type"></div><div class="skeleton skeleton-btn"></div></div>
            </div>
        </div>
    </div>

    <div id="matchContent" style="display: none;">
        <!-- Match Header Card -->
        <div class="match-header-card">
            <div class="match-teams-row">
                <div class="team-side home" id="homeTeamSide">
                    <div class="team-name" id="homeTeamName">Home Team</div>
                    <div class="team-record" id="homeTeamRecord"></div>
                </div>
                <div class="score-center">
                    <div class="score-block">
                        <span class="score-legs home" id="homeLegs"></span>
                        <span class="score-num home" id="homeScore">0</span>
                    </div>
                    <span class="score-dash">-</span>
                    <div class="score-block">
                        <span class="score-num away" id="awayScore">0</span>
                        <span class="score-legs away" id="awayLegs"></span>
                    </div>
                </div>
                <div class="team-side away" id="awayTeamSide">
                    <div class="team-name" id="awayTeamName">Away Team</div>
                    <div class="team-record" id="awayTeamRecord"></div>
                </div>
            </div>
            <div class="match-meta-grid" id="matchMetaGrid">
                <div class="meta-item">
                    <div class="meta-label">Date</div>
                    <div class="meta-value" id="metaDate">-</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Start</div>
                    <div class="meta-value" id="metaStart">-</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">End</div>
                    <div class="meta-value" id="metaEnd">-</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Duration</div>
                    <div class="meta-value" id="metaDuration">-</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Sets</div>
                    <div class="meta-value" id="metaSets">-</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Darts</div>
                    <div class="meta-value" id="metaDarts">-</div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="games">GAMES</button>
            <button class="tab-btn" data-tab="performance">PERFORMANCE</button>
            <button class="tab-btn" data-tab="counts">COUNTS</button>
            <button class="tab-btn" data-tab="h2h">H2H</button>
            <button class="tab-btn" data-tab="leaders">LEADERS</button>
        </div>

        <!-- Player Filter -->
        <div class="player-filter" id="playerFilter" style="display: none;">
            <div class="filter-label">FILTER BY PLAYER</div>
            <div class="filter-chips" id="filterChips">
                <div class="filter-chip active" data-player="all">All Players</div>
            </div>
        </div>

        <!-- Tab: Games -->
        <div id="tab-games" class="tab-content active">
            <div class="games-container">
                <div class="expand-all-bar">
                    <button class="expand-all-btn" id="expandAllBtn" onclick="toggleAllGames()">
                        ▼ EXPAND ALL
                    </button>
                </div>
                <div id="gamesContainer"></div>
            </div>
        </div>

        <!-- Tab: Player Performance -->
        <div id="tab-performance" class="tab-content">
            <div class="performance-container" id="performanceContainer"></div>
        </div>

        <!-- Tab: Match Counts -->
        <div id="tab-counts" class="tab-content">
            <div class="counts-container" id="countsContainer"></div>
        </div>

        <!-- Tab: H2H Comparison -->
        <div id="tab-h2h" class="tab-content">
            <div class="h2h-section">
                <div class="h2h-header">
                    <div class="section-title" style="font-family: 'Bebas Neue', cursive; font-size: 20px; color: var(--yellow); margin: 0;">HEAD TO HEAD</div>
                    <div class="h2h-selectors">
                        <select class="h2h-selector" id="h2hPlayer1"></select>
                        <span class="h2h-vs">VS</span>
                        <select class="h2h-selector" id="h2hPlayer2"></select>
                    </div>
                </div>
                <div id="h2hContent">
                    <div style="text-align: center; color: var(--text-dim);">Select two players to compare</div>
                </div>
            </div>
        </div>

        <!-- Tab: Leaderboards -->
        <div id="tab-leaders" class="tab-content">
            <div class="leaders-container" id="leadersContainer"></div>
        </div>
    </div>

    <!-- PRE-MATCH VIEW (shown when match is scheduled) -->
    <div id="preMatchContent" style="display: none;">
        <!-- Match Header -->
        <div class="pre-match-header">
            <div class="pre-match-teams-row">
                <div class="pre-match-team-side home">
                    <div class="pre-match-team-name" id="preHomeTeamName">Home Team</div>
                    <div class="pre-match-team-info">
                        <span class="pre-match-standing" id="preHomeStanding"></span>
                        <span class="pre-match-record" id="preHomeRecord"></span>
                    </div>
                    <div class="pre-match-avg" id="preHomeAvg"></div>
                </div>
                <div class="pre-match-center">
                    <div class="pre-match-week" id="preMatchWeek">WEEK ?</div>
                    <div class="pre-match-vs">VS</div>
                </div>
                <div class="pre-match-team-side away">
                    <div class="pre-match-team-name" id="preAwayTeamName">Away Team</div>
                    <div class="pre-match-team-info">
                        <span class="pre-match-standing" id="preAwayStanding"></span>
                        <span class="pre-match-record" id="preAwayRecord"></span>
                    </div>
                    <div class="pre-match-avg" id="preAwayAvg"></div>
                </div>
            </div>
            <div class="pre-match-details">
                <div class="pre-match-detail-item">
                    <div class="pre-match-detail-label">Date</div>
                    <div class="pre-match-detail-value" id="preMatchDate">-</div>
                </div>
                <div class="pre-match-detail-item">
                    <div class="pre-match-detail-label">Time</div>
                    <div class="pre-match-detail-value" id="preMatchTime">-</div>
                </div>
                <div class="pre-match-detail-item">
                    <div class="pre-match-detail-label">Venue</div>
                    <div class="pre-match-detail-value" id="preMatchVenue">-</div>
                </div>
            </div>
        </div>

        <!-- Games Section -->
        <div class="pre-match-games-section">
            <div class="pre-match-games-header">MATCH FORMAT</div>
            <div class="pre-match-games-list" id="preMatchGames">
                <!-- Game cards populated by JS -->
            </div>
        </div>

        <!-- Attendance Section -->
        <div class="pre-match-attendance-section" id="preMatchAttendance">
            <div class="pre-match-attendance-title">CONFIRM YOUR ATTENDANCE</div>
            <div class="pre-match-attendance-buttons">
                <button class="attendance-btn confirm" id="confirmBtn" onclick="setAttendance('confirmed')">
                    ✓ I'LL BE THERE
                </button>
                <button class="attendance-btn decline" id="declineBtn" onclick="setAttendance('unavailable')">
                    ✕ CAN'T MAKE IT
                </button>
            </div>
            <div class="attendance-status" id="attendanceStatus"></div>
        </div>

        <!-- Action Buttons -->
        <div class="pre-match-actions">
            <a href="#" class="action-btn secondary" id="leagueHubBtn">LEAGUE HUB</a>
            <a href="#" class="action-btn primary" id="startScoringBtn">START SCORING</a>
        </div>
    </div>

    <!-- Match Complete Celebration Overlay -->
    <div class="celebration-overlay" id="celebrationOverlay">
        <button class="celebration-close" onclick="closeCelebration()">&times;</button>
        <div class="celebration-content">
            <div class="celebration-trophy">🏆</div>
            <div class="celebration-title">MATCH COMPLETE!</div>
            <div class="celebration-score-row">
                <div class="celebration-team" id="celebHomeTeam">
                    <div class="celebration-team-name" id="celebHomeName">Home</div>
                </div>
                <div class="celebration-score">
                    <span class="score-num" id="celebHomeScore">0</span>
                    <span class="score-dash">-</span>
                    <span class="score-num" id="celebAwayScore">0</span>
                </div>
                <div class="celebration-team" id="celebAwayTeam">
                    <div class="celebration-team-name" id="celebAwayName">Away</div>
                </div>
            </div>
            <div class="celebration-legs" id="celebLegs"></div>
            <div class="celebration-buttons">
                <button class="celebration-btn primary" onclick="closeCelebration()">VIEW FULL STATS</button>
                <a href="/pages/dashboard.html" class="celebration-btn secondary">BACK TO DASHBOARD</a>
            </div>
        </div>
        <!-- Confetti elements -->
        <div class="confetti" style="left: 10%; background: var(--pink); animation-delay: 0s;"></div>
        <div class="confetti" style="left: 20%; background: var(--yellow); animation-delay: 0.2s;"></div>
        <div class="confetti" style="left: 30%; background: var(--teal); animation-delay: 0.4s;"></div>
        <div class="confetti" style="left: 40%; background: var(--pink); animation-delay: 0.1s;"></div>
        <div class="confetti" style="left: 50%; background: var(--yellow); animation-delay: 0.3s;"></div>
        <div class="confetti" style="left: 60%; background: var(--teal); animation-delay: 0.5s;"></div>
        <div class="confetti" style="left: 70%; background: var(--pink); animation-delay: 0.15s;"></div>
        <div class="confetti" style="left: 80%; background: var(--yellow); animation-delay: 0.35s;"></div>
        <div class="confetti" style="left: 90%; background: var(--teal); animation-delay: 0.25s;"></div>
    </div>

    <script type="module">
        import { db, doc, getDoc, collection, query, where, getDocs, updateDoc } from '/js/firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        const leagueId = urlParams.get('league_id') || urlParams.get('league');
        const matchId = urlParams.get('match_id') || urlParams.get('match');

        let matchData = null;
        let homeTeam = null;
        let awayTeam = null;
        let homeRoster = [];
        let awayRoster = [];
        let allExpanded = false;

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
            });
        });

        let leagueData = null;
        let currentPlayerId = null;

        async function loadMatch() {
            if (!leagueId || !matchId) {
                document.getElementById('loadingState').innerHTML = '<p style="color: var(--pink);">Missing league_id or match_id</p>';
                return;
            }

            // Get current player from localStorage
            const savedPlayer = localStorage.getItem('brdc_player');
            if (savedPlayer) {
                try {
                    const player = JSON.parse(savedPlayer);
                    currentPlayerId = player.id;
                } catch (e) {}
            }

            try {
                const matchDoc = await getDoc(doc(db, 'leagues', leagueId, 'matches', matchId));

                if (!matchDoc.exists()) {
                    document.getElementById('loadingState').innerHTML = '<p style="color: var(--pink);">Match not found</p>';
                    return;
                }

                matchData = { id: matchId, ...matchDoc.data() };

                // Load team data and league data
                const [homeDoc, awayDoc, leagueDoc] = await Promise.all([
                    getDoc(doc(db, 'leagues', leagueId, 'teams', matchData.home_team_id)),
                    getDoc(doc(db, 'leagues', leagueId, 'teams', matchData.away_team_id)),
                    getDoc(doc(db, 'leagues', leagueId))
                ]);

                if (homeDoc.exists()) homeTeam = { id: homeDoc.id, ...homeDoc.data() };
                if (awayDoc.exists()) awayTeam = { id: awayDoc.id, ...awayDoc.data() };
                if (leagueDoc.exists()) leagueData = { id: leagueDoc.id, ...leagueDoc.data() };

                // Update breadcrumb with league name and link
                const breadcrumbLeagueEl = document.getElementById('breadcrumbLeague');
                if (breadcrumbLeagueEl && leagueData) {
                    breadcrumbLeagueEl.textContent = leagueData.name || 'League';
                    breadcrumbLeagueEl.href = `/pages/league-view.html?league_id=${leagueId}`;
                }

                // Load rosters for both teams (players are stored separately with team_id)
                const playersRef = collection(db, 'leagues', leagueId, 'players');
                const [homePlayersSnap, awayPlayersSnap] = await Promise.all([
                    getDocs(query(playersRef, where('team_id', '==', matchData.home_team_id))),
                    getDocs(query(playersRef, where('team_id', '==', matchData.away_team_id)))
                ]);

                homeRoster = homePlayersSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (a.position || 99) - (b.position || 99));
                awayRoster = awayPlayersSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (a.position || 99) - (b.position || 99));

                // Determine if match is completed or not
                const isCompleted = matchData.status === 'completed' ||
                    (matchData.games && matchData.games.length > 0) ||
                    (matchData.home_score !== undefined && matchData.away_score !== undefined &&
                     (matchData.home_score > 0 || matchData.away_score > 0));

                document.getElementById('loadingState').style.display = 'none';

                if (isCompleted) {
                    // Show post-match report view
                    document.querySelector('.header-title').textContent = 'MATCH REPORT';
                    document.getElementById('matchContent').style.display = 'block';
                    renderMatch();
                    // Check if match is fully complete (all 9 games) and show celebration
                    checkMatchCompletion();
                } else {
                    // Show pre-match view
                    document.querySelector('.header-title').textContent = 'MATCH HUB';
                    document.getElementById('preMatchContent').style.display = 'block';
                    renderPreMatch();
                }

            } catch (error) {
                console.error('Error loading match:', error);
                document.getElementById('loadingState').innerHTML = `<p style="color: var(--pink);">Error: ${error.message}</p>`;
            }
        }

        function renderMatch() {
            // Calculate set wins and leg wins from games data
            const games = matchData.games || [];
            let homeSetsWon = 0;
            let awaySetsWon = 0;
            let homeLegsWon = 0;
            let awayLegsWon = 0;

            games.forEach(game => {
                // Count legs won in each game
                homeLegsWon += game.home_legs_won || 0;
                awayLegsWon += game.away_legs_won || 0;
                // Count sets (games) won
                if (game.winner === 'home') homeSetsWon++;
                else if (game.winner === 'away') awaySetsWon++;
            });

            // Use calculated sets, or fall back to stored score
            const homeSets = homeSetsWon || matchData.home_score || 0;
            const awaySets = awaySetsWon || matchData.away_score || 0;

            const homeWon = homeSets > awaySets;
            const awayWon = awaySets > homeSets;

            // Team names and scores (sets as main score, legs as smaller)
            document.getElementById('homeTeamName').textContent = homeTeam?.team_name || matchData.home_team_name || 'Home';
            document.getElementById('awayTeamName').textContent = awayTeam?.team_name || matchData.away_team_name || 'Away';
            document.getElementById('homeScore').textContent = homeSets;
            document.getElementById('awayScore').textContent = awaySets;

            // Show leg counts (smaller, next to set score)
            document.getElementById('homeLegs').textContent = homeLegsWon > 0 ? `(${homeLegsWon})` : '';
            document.getElementById('awayLegs').textContent = awayLegsWon > 0 ? `(${awayLegsWon})` : '';

            // Winner styling
            if (homeWon) {
                document.getElementById('homeTeamSide').classList.add('winner');
                document.getElementById('homeScore').classList.add('winner');
            } else if (awayWon) {
                document.getElementById('awayTeamSide').classList.add('winner');
                document.getElementById('awayScore').classList.add('winner');
            }

            // Team records
            if (homeTeam) {
                document.getElementById('homeTeamRecord').textContent = `${homeTeam.wins || 0}-${homeTeam.losses || 0}`;
            }
            if (awayTeam) {
                document.getElementById('awayTeamRecord').textContent = `${awayTeam.wins || 0}-${awayTeam.losses || 0}`;
            }

            // Match metadata
            renderMetadata();

            // Games
            renderGames();

            // Other tabs
            renderPerformance();
            renderCounts();
            renderLeaders();
            initH2HAndFilter();
        }

        // Check if match is fully complete and show celebration
        function checkMatchCompletion() {
            const games = matchData.games || [];
            const expectedGames = leagueData?.match_format?.length || 9;

            // Check if all games are complete (have a winner) or match status is completed
            const allGamesComplete = games.length >= expectedGames &&
                games.every(g => g.winner === 'home' || g.winner === 'away');
            const matchComplete = matchData.status === 'completed' || allGamesComplete;

            // Only show celebration once per session for this match
            const celebrationKey = `celebration_shown_${matchId}`;
            const alreadyShown = sessionStorage.getItem(celebrationKey);

            if (matchComplete && !alreadyShown) {
                // Small delay to let the page render first
                setTimeout(() => showCelebration(), 500);
                sessionStorage.setItem(celebrationKey, 'true');
            }
        }

        function showCelebration() {
            const games = matchData.games || [];
            let homeSetsWon = 0;
            let awaySetsWon = 0;
            let homeLegsWon = 0;
            let awayLegsWon = 0;

            games.forEach(game => {
                homeLegsWon += game.home_legs_won || 0;
                awayLegsWon += game.away_legs_won || 0;
                if (game.winner === 'home') homeSetsWon++;
                else if (game.winner === 'away') awaySetsWon++;
            });

            const homeSets = homeSetsWon || matchData.home_score || 0;
            const awaySets = awaySetsWon || matchData.away_score || 0;
            const homeWon = homeSets > awaySets;
            const awayWon = awaySets > homeSets;

            // Populate celebration data
            document.getElementById('celebHomeName').textContent = homeTeam?.team_name || matchData.home_team_name || 'Home';
            document.getElementById('celebAwayName').textContent = awayTeam?.team_name || matchData.away_team_name || 'Away';
            document.getElementById('celebHomeScore').textContent = homeSets;
            document.getElementById('celebAwayScore').textContent = awaySets;

            // Winner styling
            const celebHomeTeam = document.getElementById('celebHomeTeam');
            const celebAwayTeam = document.getElementById('celebAwayTeam');
            const celebHomeScore = document.getElementById('celebHomeScore');
            const celebAwayScore = document.getElementById('celebAwayScore');

            celebHomeTeam.classList.remove('winner');
            celebAwayTeam.classList.remove('winner');
            celebHomeScore.classList.remove('winner');
            celebAwayScore.classList.remove('winner');

            if (homeWon) {
                celebHomeTeam.classList.add('winner');
                celebHomeScore.classList.add('winner');
            } else if (awayWon) {
                celebAwayTeam.classList.add('winner');
                celebAwayScore.classList.add('winner');
            }

            // Show leg totals
            if (homeLegsWon > 0 || awayLegsWon > 0) {
                document.getElementById('celebLegs').textContent = `Total Legs: ${homeLegsWon} - ${awayLegsWon}`;
            }

            // Show the overlay
            document.getElementById('celebrationOverlay').classList.add('active');
        }

        window.closeCelebration = function() {
            document.getElementById('celebrationOverlay').classList.remove('active');
        };

        function renderMetadata() {
            // Date
            if (matchData.match_date) {
                const date = matchData.match_date.toDate ? matchData.match_date.toDate() : new Date(matchData.match_date);
                document.getElementById('metaDate').textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } else if (matchData.created_at) {
                const date = matchData.created_at.toDate ? matchData.created_at.toDate() : new Date(matchData.created_at._seconds * 1000);
                document.getElementById('metaDate').textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            // Start/End times (if tracked)
            if (matchData.start_time) {
                const start = matchData.start_time.toDate ? matchData.start_time.toDate() : new Date(matchData.start_time);
                document.getElementById('metaStart').textContent = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            }
            if (matchData.end_time) {
                const end = matchData.end_time.toDate ? matchData.end_time.toDate() : new Date(matchData.end_time);
                document.getElementById('metaEnd').textContent = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            }

            // Duration
            if (matchData.start_time && matchData.end_time) {
                const start = matchData.start_time.toDate ? matchData.start_time.toDate() : new Date(matchData.start_time);
                const end = matchData.end_time.toDate ? matchData.end_time.toDate() : new Date(matchData.end_time);
                const mins = Math.round((end - start) / 60000);
                const hrs = Math.floor(mins / 60);
                const remainMins = mins % 60;
                document.getElementById('metaDuration').textContent = hrs > 0 ? `${hrs}h ${remainMins}m` : `${mins}m`;
            }

            // Sets count (total games/sets played)
            const games = matchData.games || [];
            document.getElementById('metaSets').textContent = games.length;

            // Total darts
            if (matchData.total_darts) {
                document.getElementById('metaDarts').textContent = matchData.total_darts.toLocaleString();
            } else {
                // Calculate from games
                let totalDarts = 0;
                games.forEach(g => {
                    (g.legs || []).forEach(leg => {
                        totalDarts += (leg.home_stats?.darts_thrown || leg.home_stats?.darts || 0);
                        totalDarts += (leg.away_stats?.darts_thrown || leg.away_stats?.darts || 0);
                    });
                });
                document.getElementById('metaDarts').textContent = totalDarts > 0 ? totalDarts.toLocaleString() : '-';
            }
        }

        function renderGames() {
            const container = document.getElementById('gamesContainer');
            const games = matchData.games || [];

            if (games.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--text-dim);">No games recorded</p>';
                return;
            }

            // Group games by SET number
            const setGroups = {};
            games.forEach((game, idx) => {
                const setNum = game.set || 1;
                if (!setGroups[setNum]) {
                    setGroups[setNum] = [];
                }
                setGroups[setNum].push({ ...game, originalIdx: idx });
            });

            let html = '';
            const setNumbers = Object.keys(setGroups).map(Number).sort((a, b) => a - b);

            setNumbers.forEach((setNum, setIdx) => {
                const setGames = setGroups[setNum];

                // Calculate set totals (wins within this set)
                let homeWins = 0;
                let awayWins = 0;
                setGames.forEach(g => {
                    if (g.winner === 'home') homeWins++;
                    else if (g.winner === 'away') awayWins++;
                });

                const setHomeWon = homeWins > awayWins;
                const setAwayWon = awayWins > homeWins;

                // Get players from first game in set (they should be same throughout set)
                const firstGame = setGames[0];
                const homePlayers = (firstGame.home_players || []).map(p => typeof p === 'string' ? p : (p?.name || 'TBD'));
                const awayPlayers = (firstGame.away_players || []).map(p => typeof p === 'string' ? p : (p?.name || 'TBD'));

                // Game type (singles/doubles/triples)
                const playerCount = homePlayers.length;
                const gameType = playerCount === 1 ? 'SINGLES' : playerCount === 2 ? 'DOUBLES' : 'TRIPLES';

                // Calculate aggregate stats for the set
                const setStats = calculateSetStats(setGames);

                // Build format labels for legs in this set
                const formatLabels = setGames.map(g => {
                    if (g.format === 'cricket') return 'CRICKET';
                    const inLabel = g.in_rule === 'double' ? 'DI' : 'SI';
                    const outLabel = g.checkout === 'double' ? 'DO' : (g.checkout === 'master' ? 'MO' : 'SO');
                    return `${g.format || '501'} ${inLabel}/${outLabel}`;
                });
                const uniqueFormats = [...new Set(formatLabels)];
                const formatBadge = uniqueFormats.length <= 2 ? uniqueFormats.join(' / ') : `${setGames.length} LEGS`;

                html += `
                    <div class="game-card" data-set-idx="${setIdx}" data-set-num="${setNum}">
                        <div class="game-card-header">
                            <div class="game-team-side left ${setHomeWon ? 'winner' : ''}">
                                ${homePlayers.map((name, i) => `
                                    <div>
                                        <span class="game-player-name player-link" onclick="viewPlayer('${name.replace(/'/g, "\\'")}')">${name}</span>
                                        ${setStats.home[i] ? `<div class="game-player-stats ${setStats.home[i].isBig ? 'big' : ''}">${setStats.home[i].stat}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="game-score-center">
                                ${setHomeWon ? '<span class="winner-star">★</span>' : ''}
                                <div class="game-score">${homeWins} - ${awayWins}</div>
                                ${setAwayWon ? '<span class="winner-star">★</span>' : ''}
                                <div class="game-format-badge">${formatBadge}</div>
                            </div>
                            <div class="game-team-side right ${setAwayWon ? 'winner' : ''}">
                                ${awayPlayers.map((name, i) => `
                                    <div>
                                        <span class="game-player-name player-link" onclick="viewPlayer('${name.replace(/'/g, "\\'")}')">${name}</span>
                                        ${setStats.away[i] ? `<div class="game-player-stats ${setStats.away[i].isBig ? 'big' : ''}">${setStats.away[i].stat}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="game-card-body">
                            <div class="game-info-row">
                                <span class="game-type-label">SET ${setNum} • ${gameType}</span>
                                ${setGames.length > 0 ? `
                                    <button class="toggle-detail-btn" onclick="toggleSetDetail(${setIdx})">
                                        <span id="toggle-text-${setIdx}">▼ ${setGames.length} LEGS</span>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        ${renderSetLegsDetail(setGames, setIdx)}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function calculateSetStats(setGames) {
            // Aggregate stats across all games in this set
            const playerTotals = {};
            let hasX01 = false;
            let hasCricket = false;

            setGames.forEach(game => {
                if (game.format === 'cricket') hasCricket = true;
                else hasX01 = true;

                (game.legs || []).forEach(leg => {
                    Object.entries(leg.player_stats || {}).forEach(([name, stats]) => {
                        if (!playerTotals[name]) {
                            playerTotals[name] = { darts: 0, points: 0, marks: 0 };
                        }
                        playerTotals[name].darts += stats.darts || 0;
                        playerTotals[name].points += stats.points || 0;
                        playerTotals[name].marks += stats.marks || 0;
                    });
                });
            });

            const homePlayers = (setGames[0]?.home_players || []).map(p => typeof p === 'string' ? p : (p?.name || 'TBD'));
            const awayPlayers = (setGames[0]?.away_players || []).map(p => typeof p === 'string' ? p : (p?.name || 'TBD'));

            // Use dominant format for stat display (or show both if mixed)
            const getStatDisplay = (name) => {
                const totals = playerTotals[name];
                if (!totals || totals.darts === 0) return null;

                // If mixed formats, show 3DA (more universal)
                if (hasX01) {
                    const avg = ((totals.points / totals.darts) * 3).toFixed(1);
                    return { stat: `${avg} 3DA`, isBig: parseFloat(avg) >= 60 };
                } else {
                    const mpr = (totals.marks / (totals.darts / 3)).toFixed(2);
                    return { stat: `${mpr} MPR`, isBig: parseFloat(mpr) >= 3.0 };
                }
            };

            return {
                home: homePlayers.map(getStatDisplay),
                away: awayPlayers.map(getStatDisplay)
            };
        }

        function renderSetLegsDetail(setGames, setIdx) {
            if (setGames.length === 0) return '';

            let html = `<div class="legs-detail" id="legs-detail-${setIdx}">`;

            setGames.forEach((game, legIdx) => {
                const homeWon = game.winner === 'home';
                const awayWon = game.winner === 'away';
                const legFormat = game.format || '501';
                const legIsCricket = legFormat === 'cricket';

                // Format label
                let formatLabel = (legFormat || '').toUpperCase();
                if (!legIsCricket && legFormat) {
                    const inLabel = (game.in_rule || 'straight') === 'double' ? 'DI' : 'SI';
                    const outLabel = (game.checkout || 'double') === 'double' ? 'DO' : (game.checkout === 'master' ? 'MO' : 'SO');
                    formatLabel = `${legFormat} ${inLabel}/${outLabel}`;
                }

                // Get player stats for this leg from the game's legs array (first leg)
                const leg = (game.legs || [])[0] || {};
                const playerStats = leg.player_stats || {};
                const homePlayers = (game.home_players || []).map(p => typeof p === 'string' ? p : (p?.name || 'TBD'));
                const awayPlayers = (game.away_players || []).map(p => typeof p === 'string' ? p : (p?.name || 'TBD'));

                // Determine who had cork (threw first) - check first throw
                const firstThrow = (leg.throws || [])[0];
                const homeCork = firstThrow && firstThrow.home && firstThrow.home.player;
                const awayCork = !homeCork && firstThrow && firstThrow.away && firstThrow.away.player;

                // Get checkout/closeout info from the winning throw
                const lastThrow = (leg.throws || []).slice(-1)[0];
                let checkoutInfo = null;
                let closeoutInfo = null;
                let loserRemaining = null;

                if (homeWon && lastThrow) {
                    if (!legIsCricket) {
                        checkoutInfo = { side: 'home', value: lastThrow.home?.score || leg.checkout };
                        // Find loser's remaining from last throw or leg stats
                        loserRemaining = lastThrow.away?.remaining || leg.away_stats?.remaining;
                    } else if (lastThrow.home?.closed_out) {
                        closeoutInfo = { side: 'home', marks: lastThrow.home.marks, darts: lastThrow.home.closeout_darts };
                    }
                } else if (awayWon && lastThrow) {
                    if (!legIsCricket) {
                        checkoutInfo = { side: 'away', value: lastThrow.away?.score || leg.checkout };
                        loserRemaining = lastThrow.home?.remaining || leg.home_stats?.remaining;
                    } else if (lastThrow.away?.closed_out) {
                        closeoutInfo = { side: 'away', marks: lastThrow.away.marks, darts: lastThrow.away.closeout_darts };
                    }
                }

                html += `
                    <div class="leg-card ${homeWon ? 'home-won' : awayWon ? 'away-won' : ''}">
                        <div class="leg-header" onclick="toggleLegThrows(${setIdx}, ${legIdx})">
                            <div class="leg-player-side left">
                                ${homePlayers.map(name => {
                                    const stats = playerStats[name] || {};
                                    const statVal = legIsCricket
                                        ? (stats.mpr ? stats.mpr.toFixed(2) + ' MPR' : '-')
                                        : (stats.points && stats.darts ? ((stats.points / stats.darts) * 3).toFixed(1) + ' 3DA' : '-');
                                    const isBig = legIsCricket ? (stats.mpr >= 3.0) : ((stats.points / stats.darts) * 3 >= 60);
                                    const hasCork = homeCork === name;
                                    return `
                                        <div>
                                            <span class="leg-player-name player-link" onclick="event.stopPropagation(); viewPlayer('${name.replace(/'/g, "\\'")}')">${hasCork ? '<span class="cork-badge">C</span> ' : ''}${name}</span>
                                            <div class="leg-player-stat ${isBig ? 'big' : ''}">${statVal}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div class="leg-center">
                                <div class="leg-number">LEG ${game.game_in_set || legIdx + 1}</div>
                                <div class="leg-format">${formatLabel}</div>
                                <div class="leg-expand-hint">▼ details</div>
                            </div>
                            <div class="leg-player-side right">
                                ${awayPlayers.map(name => {
                                    const stats = playerStats[name] || {};
                                    const statVal = legIsCricket
                                        ? (stats.mpr ? stats.mpr.toFixed(2) + ' MPR' : '-')
                                        : (stats.points && stats.darts ? ((stats.points / stats.darts) * 3).toFixed(1) + ' 3DA' : '-');
                                    const isBig = legIsCricket ? (stats.mpr >= 3.0) : ((stats.points / stats.darts) * 3 >= 60);
                                    const hasCork = awayCork === name;
                                    return `
                                        <div>
                                            <span class="leg-player-name player-link" onclick="event.stopPropagation(); viewPlayer('${name.replace(/'/g, "\\'")}')">${name}${hasCork ? ' <span class="cork-badge">C</span>' : ''}</span>
                                            <div class="leg-player-stat ${isBig ? 'big' : ''}">${statVal}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        <div class="throws-detail" id="throws-${setIdx}-${legIdx}">
                            ${renderLegThrowsDetail(leg, game, legIsCricket, checkoutInfo, closeoutInfo, loserRemaining)}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        function renderLegThrowsDetail(leg, game, isCricket, checkoutInfo, closeoutInfo, loserRemaining) {
            const homeStats = leg.home_stats || {};
            const awayStats = leg.away_stats || {};

            // If we have throw data, show it
            if (leg.throws && leg.throws.length > 0) {
                let html = `
                    <div class="throws-header">
                        <div>Home</div>
                        <div>Score</div>
                        <div>Rnd</div>
                        <div>Score</div>
                        <div>Away</div>
                    </div>
                `;

                leg.throws.forEach(t => {
                    const homeT = t.home || {};
                    const awayT = t.away || {};

                    // Determine if score is notable
                    const homeNotable = homeT.notable || (homeT.score >= 100 && !isCricket);
                    const awayNotable = awayT.notable || (awayT.score >= 100 && !isCricket);
                    const homeCheckout = homeT.checkout || homeT.remaining === 0;
                    const awayCheckout = awayT.checkout || awayT.remaining === 0;

                    // Build score display with notable badge
                    const homeScoreDisplay = homeT.score || homeT.hit || '-';
                    const awayScoreDisplay = awayT.score || awayT.hit || '-';

                    // Checkout badge
                    const homeCheckoutBadge = homeCheckout && homeT.checkout_darts
                        ? `<span class="checkout-badge">DO(${homeT.checkout_darts})</span>` : '';
                    const awayCheckoutBadge = awayCheckout && awayT.checkout_darts
                        ? `<span class="checkout-badge">DO(${awayT.checkout_darts})</span>` : '';

                    // Notable badge (for cricket marks or high scores)
                    const homeNotableBadge = homeT.notable && !homeCheckout ? `<span class="notable">${homeT.notable}</span>` : '';
                    const awayNotableBadge = awayT.notable && !awayCheckout ? `<span class="notable">${awayT.notable}</span>` : '';

                    html += `
                        <div class="throw-row">
                            <div class="home">${homeT.player || ''}${homeNotableBadge}</div>
                            <div class="score home ${homeCheckout ? 'checkout-score' : homeNotable ? 'notable-score' : ''}">${homeScoreDisplay}${homeCheckoutBadge}</div>
                            <div class="round">${t.round}</div>
                            <div class="score away ${awayCheckout ? 'checkout-score' : awayNotable ? 'notable-score' : ''}">${awayScoreDisplay}${awayCheckoutBadge}</div>
                            <div class="away">${awayNotableBadge}${awayT.player || ''}</div>
                        </div>
                    `;
                });

                html += renderLegSummary(homeStats, awayStats, isCricket, leg.winner, checkoutInfo, closeoutInfo, loserRemaining);
                return html;
            }

            // No throws, show summary only
            return renderLegSummary(homeStats, awayStats, isCricket, leg.winner, checkoutInfo, closeoutInfo, loserRemaining);
        }


        function renderLegSummary(homeStats, awayStats, isCricket, winner, checkoutInfo, closeoutInfo, loserRemaining) {
            const homeStat = isCricket
                ? `${homeStats.mpr || '-'} MPR`
                : `${homeStats.three_dart_avg || '-'} 3DA`;
            const awayStat = isCricket
                ? `${awayStats.mpr || '-'} MPR`
                : `${awayStats.three_dart_avg || '-'} 3DA`;

            // Build winner display with checkout/closeout info
            let homeWinnerInfo = '';
            let awayWinnerInfo = '';

            if (winner === 'home') {
                if (checkoutInfo && checkoutInfo.value) {
                    homeWinnerInfo = `<div style="color: var(--yellow); font-weight: 700; margin-top: 4px;">★ OUT: ${checkoutInfo.value}</div>`;
                } else if (closeoutInfo) {
                    homeWinnerInfo = `<div style="color: var(--yellow); font-weight: 700; margin-top: 4px;">★ CLOSED (${closeoutInfo.marks}M)</div>`;
                } else {
                    homeWinnerInfo = '<div style="color: var(--yellow); font-weight: 700; margin-top: 4px;">★ WINNER</div>';
                }
                if (loserRemaining && !isCricket) {
                    awayWinnerInfo = `<div style="color: var(--text-dim); font-size: 11px; margin-top: 4px;">Left: ${loserRemaining}</div>`;
                }
            } else if (winner === 'away') {
                if (checkoutInfo && checkoutInfo.value) {
                    awayWinnerInfo = `<div style="color: var(--yellow); font-weight: 700; margin-top: 4px;">OUT: ${checkoutInfo.value} ★</div>`;
                } else if (closeoutInfo) {
                    awayWinnerInfo = `<div style="color: var(--yellow); font-weight: 700; margin-top: 4px;">CLOSED (${closeoutInfo.marks}M) ★</div>`;
                } else {
                    awayWinnerInfo = '<div style="color: var(--yellow); font-weight: 700; margin-top: 4px;">WINNER ★</div>';
                }
                if (loserRemaining && !isCricket) {
                    homeWinnerInfo = `<div style="color: var(--text-dim); font-size: 11px; margin-top: 4px;">Left: ${loserRemaining}</div>`;
                }
            }

            return `
                <div class="leg-summary">
                    <div class="home">
                        <b>${homeStat}</b> • ${homeStats.darts_thrown || homeStats.darts || '-'} darts
                        ${homeWinnerInfo}
                    </div>
                    <div class="center">${isCricket ? 'MPR' : '3DA'}</div>
                    <div class="away">
                        ${awayStats.darts_thrown || awayStats.darts || '-'} darts • <b>${awayStat}</b>
                        ${awayWinnerInfo}
                    </div>
                </div>
            `;
        }

        // Helper: Get checkout range category
        function getCheckoutRange(score) {
            if (score >= 161) return '161_plus';
            if (score >= 140) return '140_160';
            if (score >= 100) return '100_139';
            if (score >= 60) return '60_99';
            return null; // Below 60, not tracked in ranges
        }

        function formatCheckoutRange(rangeKey) {
            const labels = { '60_99': '60-99', '100_139': '100-139', '140_160': '140-160', '161_plus': '161+' };
            return labels[rangeKey] || rangeKey;
        }

        // ========== PERFORMANCE TAB (DC-Style) ==========
        function renderPerformance() {
            const container = document.getElementById('performanceContainer');
            const games = matchData.games || [];

            // Aggregate stats for all players in this match
            const playerStats = {};
            const homePlayerNames = new Set();
            const awayPlayerNames = new Set();
            const gameDetails = []; // For game-by-game detail table

            // Track checkout ranges per player
            const playerCheckouts = {}; // { playerName: { '60_99': { count: 0, attempts: 0 }, ... } }

            // Track cricket closeouts per player
            const playerCricketCloseouts = {}; // { playerName: { '5m': 0, '6m': 0, ... } }

            // Track leaders
            const leaders = {
                highTurn: { value: 0, player: null, side: null },
                highDO: { value: 0, player: null, side: null },
                high3DA_S: { value: 0, player: null, side: null }, // Singles
                high3DA_D: { value: 0, player: null, side: null }, // Doubles
                highMPR_S: { value: 0, player: null, side: null }, // Singles
                highMPR_D: { value: 0, player: null, side: null }, // Doubles
                cricketHighTurn: { value: 0, player: null, side: null },
                bulls: { value: 0, player: null, side: null },
                triples: { value: 0, player: null, side: null }
            };

            games.forEach(game => {
                const isCricket = game.format === 'cricket';
                const homePlayers = (game.home_players || []).map(p => typeof p === 'string' ? p : p.name);
                const awayPlayers = (game.away_players || []).map(p => typeof p === 'string' ? p : p.name);
                homePlayers.forEach(p => homePlayerNames.add(p));
                awayPlayers.forEach(p => awayPlayerNames.add(p));

                const gameType = homePlayers.length === 1 ? 'S' : 'D'; // Singles or Doubles

                (game.legs || []).forEach(leg => {
                    Object.entries(leg.player_stats || {}).forEach(([name, stats]) => {
                        const side = homePlayerNames.has(name) ? 'home' : 'away';

                        if (!playerStats[name]) {
                            playerStats[name] = {
                                name, side,
                                x01: { darts: 0, points: 0, legs: 0, wins: 0, first9Points: 0, first9Darts: 0 },
                                cricket: { darts: 0, marks: 0, legs: 0, wins: 0, bulls: 0, triples: 0 },
                                totalGames: 0, totalWins: 0
                            };
                        }

                        const isWinner = (leg.winner === 'home' && homePlayerNames.has(name)) ||
                                         (leg.winner === 'away' && awayPlayerNames.has(name));

                        if (isCricket || leg.format === 'cricket') {
                            playerStats[name].cricket.darts += stats.darts || 0;
                            playerStats[name].cricket.marks += stats.marks || 0;
                            playerStats[name].cricket.legs++;
                            playerStats[name].cricket.bulls += stats.bulls || 0;
                            playerStats[name].cricket.triples += stats.triples || 0;
                            if (isWinner) playerStats[name].cricket.wins++;

                            // Track MPR leader
                            const mpr = stats.mpr || (stats.marks && stats.darts ? stats.marks / (stats.darts / 3) : 0);
                            if (gameType === 'S' && mpr > leaders.highMPR_S.value) {
                                leaders.highMPR_S = { value: mpr, player: name, side };
                            } else if (gameType === 'D' && mpr > leaders.highMPR_D.value) {
                                leaders.highMPR_D = { value: mpr, player: name, side };
                            }
                        } else {
                            playerStats[name].x01.darts += stats.darts || 0;
                            playerStats[name].x01.points += stats.points || 0;
                            playerStats[name].x01.legs++;
                            if (isWinner) playerStats[name].x01.wins++;

                            // Track 3DA leader
                            const avg = stats.points && stats.darts ? (stats.points / stats.darts) * 3 : 0;
                            if (gameType === 'S' && avg > leaders.high3DA_S.value) {
                                leaders.high3DA_S = { value: avg, player: name, side };
                            } else if (gameType === 'D' && avg > leaders.high3DA_D.value) {
                                leaders.high3DA_D = { value: avg, player: name, side };
                            }

                            // Track high checkout
                            if (stats.checkout && stats.checkout > leaders.highDO.value) {
                                leaders.highDO = { value: stats.checkout, player: name, side };
                            }
                        }

                        playerStats[name].totalGames++;
                        if (isWinner) playerStats[name].totalWins++;
                    });

                    // Track First 9 average (first 3 rounds = 9 darts) for X01 games
                    if (!isCricket && leg.format !== 'cricket') {
                        const throws = leg.throws || [];
                        const playerRoundCounts = {};
                        throws.forEach(t => {
                            ['home', 'away'].forEach(side => {
                                const throwData = t[side];
                                if (throwData && throwData.player && throwData.score !== undefined) {
                                    const name = throwData.player;
                                    if (!playerRoundCounts[name]) playerRoundCounts[name] = 0;
                                    playerRoundCounts[name]++;
                                    // First 3 rounds = First 9 darts
                                    if (playerRoundCounts[name] <= 3 && playerStats[name]) {
                                        playerStats[name].x01.first9Points += throwData.score || 0;
                                        playerStats[name].x01.first9Darts += 3;
                                    }
                                }
                            });
                        });
                    }

                    // Track high turns from throws AND checkout range attempts
                    (leg.throws || []).forEach((t, throwIdx) => {
                        // Get previous remaining to know what checkout opportunity existed
                        const prevThrow = throwIdx > 0 ? leg.throws[throwIdx - 1] : null;

                        if (t.home && t.home.score !== undefined) {
                            const score = t.home.score;
                            const playerName = t.home.player || homePlayers[0];
                            if (!isCricket && score > leaders.highTurn.value) {
                                leaders.highTurn = { value: score, player: playerName, side: 'home' };
                            }
                            // Track checkout from throws
                            if (t.home.checkout && score > leaders.highDO.value) {
                                leaders.highDO = { value: score, player: playerName, side: 'home' };
                            }

                            // Track checkout range attempts/successes (X01 only)
                            if (!isCricket && leg.format !== 'cricket') {
                                // Calculate what the remaining was BEFORE this throw
                                const remainingBefore = t.home.remaining + score;
                                const range = getCheckoutRange(remainingBefore);
                                if (range) {
                                    // Initialize player checkout tracking
                                    if (!playerCheckouts[playerName]) {
                                        playerCheckouts[playerName] = {
                                            '60_99': { count: 0, attempts: 0 },
                                            '100_139': { count: 0, attempts: 0 },
                                            '140_160': { count: 0, attempts: 0 },
                                            '161_plus': { count: 0, attempts: 0 }
                                        };
                                    }
                                    // Count attempt for this range
                                    playerCheckouts[playerName][range].attempts++;
                                    // If checkout, count success
                                    if (t.home.checkout || t.home.remaining === 0) {
                                        playerCheckouts[playerName][range].count++;
                                    }
                                }
                            }
                        }
                        if (t.away && t.away.score !== undefined) {
                            const score = t.away.score;
                            const playerName = t.away.player || awayPlayers[0];
                            if (!isCricket && score > leaders.highTurn.value) {
                                leaders.highTurn = { value: score, player: playerName, side: 'away' };
                            }
                            if (t.away.checkout && score > leaders.highDO.value) {
                                leaders.highDO = { value: score, player: playerName, side: 'away' };
                            }

                            // Track checkout range attempts/successes (X01 only)
                            if (!isCricket && leg.format !== 'cricket') {
                                const remainingBefore = t.away.remaining + score;
                                const range = getCheckoutRange(remainingBefore);
                                if (range) {
                                    if (!playerCheckouts[playerName]) {
                                        playerCheckouts[playerName] = {
                                            '60_99': { count: 0, attempts: 0 },
                                            '100_139': { count: 0, attempts: 0 },
                                            '140_160': { count: 0, attempts: 0 },
                                            '161_plus': { count: 0, attempts: 0 }
                                        };
                                    }
                                    playerCheckouts[playerName][range].attempts++;
                                    if (t.away.checkout || t.away.remaining === 0) {
                                        playerCheckouts[playerName][range].count++;
                                    }
                                }
                            }
                        }

                        // Cricket high marks and closeout tracking
                        if (isCricket) {
                            if (t.home && t.home.marks && t.home.marks > leaders.cricketHighTurn.value) {
                                leaders.cricketHighTurn = { value: t.home.marks, player: t.home.player || homePlayers[0], side: 'home' };
                            }
                            if (t.away && t.away.marks && t.away.marks > leaders.cricketHighTurn.value) {
                                leaders.cricketHighTurn = { value: t.away.marks, player: t.away.player || awayPlayers[0], side: 'away' };
                            }

                            // Cricket closeout tracking - check if this is the final throw
                            const throwsArray = leg.throws || [];
                            const currentIdx = throwsArray.indexOf(t);
                            const isLastThrow = currentIdx === throwsArray.length - 1;

                            if (isLastThrow) {
                                // Track closeout for the winner
                                if (t.home && (t.home.closed_out || leg.winner === 'home')) {
                                    const marks = t.home.marks || 0;
                                    const playerName = t.home.player || homePlayers[0];
                                    if (marks >= 5 && marks <= 9) {
                                        if (!playerCricketCloseouts[playerName]) {
                                            playerCricketCloseouts[playerName] = { '5m': 0, '6m': 0, '7m': 0, '8m': 0, '9m': 0 };
                                        }
                                        playerCricketCloseouts[playerName][`${marks}m`]++;
                                    }
                                }
                                if (t.away && (t.away.closed_out || leg.winner === 'away')) {
                                    const marks = t.away.marks || 0;
                                    const playerName = t.away.player || awayPlayers[0];
                                    if (marks >= 5 && marks <= 9) {
                                        if (!playerCricketCloseouts[playerName]) {
                                            playerCricketCloseouts[playerName] = { '5m': 0, '6m': 0, '7m': 0, '8m': 0, '9m': 0 };
                                        }
                                        playerCricketCloseouts[playerName][`${marks}m`]++;
                                    }
                                }
                            }
                        }
                    });

                    // Build game detail for this leg
                    const legNum = `${game.set}.${game.game_in_set}`;
                    const formatLabel = isCricket ? 'Cricket' : `${game.format || '501'} ${(game.in_rule || 'straight')[0].toUpperCase()}I${(game.checkout || 'double')[0].toUpperCase()}O`;

                    // Add detail row for each player
                    [...homePlayers, ...awayPlayers].forEach(name => {
                        const stats = (leg.player_stats || {})[name] || {};
                        const side = homePlayerNames.has(name) ? 'home' : 'away';
                        const isWinner = (leg.winner === 'home' && side === 'home') || (leg.winner === 'away' && side === 'away');
                        const hadCork = stats.cork || stats.started;

                        gameDetails.push({
                            game: legNum,
                            set: game.set,
                            format: formatLabel,
                            isCricket,
                            player: name,
                            side,
                            cork: hadCork,
                            avg: !isCricket && stats.darts ? ((stats.points || 0) / stats.darts) * 3 : null,
                            mpr: isCricket && stats.darts ? (stats.marks || 0) / (stats.darts / 3) : null,
                            darts: stats.darts || 0,
                            points: stats.points || 0,
                            marks: stats.marks || 0,
                            checkout: stats.checkout || null,
                            remaining: stats.remaining || 0,
                            won: isWinner,
                            turn: stats.turn_order || null
                        });
                    });
                });
            });

            // Track bulls and triples leaders
            Object.values(playerStats).forEach(p => {
                if (p.cricket.bulls > leaders.bulls.value) {
                    leaders.bulls = { value: p.cricket.bulls, player: p.name, side: p.side };
                }
                if (p.cricket.triples > leaders.triples.value) {
                    leaders.triples = { value: p.cricket.triples, player: p.name, side: p.side };
                }
            });

            // Build HTML
            let html = '';

            // === X01 LEADERS ===
            html += `
                <div class="perf-leaders-section">
                    <div class="perf-leaders-header">'01 LEADERS</div>
                    <div class="perf-leaders-grid">
                        <div class="perf-leader-item">
                            <span class="perf-leader-label">High Turn</span>
                            <div class="perf-leader-value">
                                <div class="perf-leader-stat">${leaders.highTurn.value || '-'}</div>
                                <div class="perf-leader-name ${leaders.highTurn.side || ''}">${leaders.highTurn.player || '-'}</div>
                            </div>
                        </div>
                        <div class="perf-leader-item">
                            <span class="perf-leader-label">High DO</span>
                            <div class="perf-leader-value">
                                <div class="perf-leader-stat">${leaders.highDO.value || '-'}</div>
                                <div class="perf-leader-name ${leaders.highDO.side || ''}">${leaders.highDO.player || '-'}</div>
                            </div>
                        </div>
                        <div class="perf-leader-item">
                            <span class="perf-leader-label">High 3DA (S)</span>
                            <div class="perf-leader-value">
                                <div class="perf-leader-stat">${leaders.high3DA_S.value ? leaders.high3DA_S.value.toFixed(1) : '-'}</div>
                                <div class="perf-leader-name ${leaders.high3DA_S.side || ''}">${leaders.high3DA_S.player || '-'}</div>
                            </div>
                        </div>
                        <div class="perf-leader-item">
                            <span class="perf-leader-label">High 3DA (D)</span>
                            <div class="perf-leader-value">
                                <div class="perf-leader-stat">${leaders.high3DA_D.value ? leaders.high3DA_D.value.toFixed(1) : '-'}</div>
                                <div class="perf-leader-name ${leaders.high3DA_D.side || ''}">${leaders.high3DA_D.player || '-'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // === CRICKET LEADERS ===
            html += `
                <div class="perf-leaders-section">
                    <div class="perf-leaders-header">CRICKET LEADERS</div>
                    <div class="perf-leaders-grid">
                        <div class="perf-leader-item">
                            <span class="perf-leader-label">High Turn</span>
                            <div class="perf-leader-value">
                                <div class="perf-leader-stat">${leaders.cricketHighTurn.value ? leaders.cricketHighTurn.value + 'M' : '-'}</div>
                                <div class="perf-leader-name ${leaders.cricketHighTurn.side || ''}">${leaders.cricketHighTurn.player || '-'}</div>
                            </div>
                        </div>
                        <div class="perf-leader-item">
                            <span class="perf-leader-label">Bulls</span>
                            <div class="perf-leader-value">
                                <div class="perf-leader-stat">${leaders.bulls.value || '-'}</div>
                                <div class="perf-leader-name ${leaders.bulls.side || ''}">${leaders.bulls.player || '-'}</div>
                            </div>
                        </div>
                        <div class="perf-leader-item">
                            <span class="perf-leader-label">High MPR (S)</span>
                            <div class="perf-leader-value">
                                <div class="perf-leader-stat">${leaders.highMPR_S.value ? leaders.highMPR_S.value.toFixed(2) : '-'}</div>
                                <div class="perf-leader-name ${leaders.highMPR_S.side || ''}">${leaders.highMPR_S.player || '-'}</div>
                            </div>
                        </div>
                        <div class="perf-leader-item">
                            <span class="perf-leader-label">High MPR (D)</span>
                            <div class="perf-leader-value">
                                <div class="perf-leader-stat">${leaders.highMPR_D.value ? leaders.highMPR_D.value.toFixed(2) : '-'}</div>
                                <div class="perf-leader-name ${leaders.highMPR_D.side || ''}">${leaders.highMPR_D.player || '-'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // === CHECKOUT RANGE BREAKDOWN ===
            const checkoutRanges = ['60_99', '100_139', '140_160', '161_plus'];
            const hasCheckoutData = Object.keys(playerCheckouts).length > 0;

            if (hasCheckoutData) {
                html += `
                    <div class="checkout-range-section">
                        <div class="checkout-range-header">CHECKOUT PERFORMANCE BY RANGE</div>
                        <table class="checkout-range-table">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>60-99</th>
                                    <th>100-139</th>
                                    <th>140-160</th>
                                    <th>161+</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(playerCheckouts).map(([name, ranges]) => {
                                    const side = homePlayerNames.has(name) ? 'home' : 'away';
                                    let totalCount = 0, totalAttempts = 0;

                                    const rangeCells = checkoutRanges.map(range => {
                                        const data = ranges[range] || { count: 0, attempts: 0 };
                                        totalCount += data.count;
                                        totalAttempts += data.attempts;
                                        if (data.attempts === 0) return '<td class="no-data">-</td>';
                                        const pct = Math.round((data.count / data.attempts) * 100);
                                        const pctClass = pct >= 50 ? 'good' : pct >= 25 ? 'avg' : '';
                                        return `<td><span class="pct ${pctClass}">${data.count}/${data.attempts}</span> <span style="color:var(--text-dim);">(${pct}%)</span></td>`;
                                    }).join('');

                                    const totalPct = totalAttempts > 0 ? Math.round((totalCount / totalAttempts) * 100) : 0;
                                    const totalPctClass = totalPct >= 50 ? 'good' : totalPct >= 25 ? 'avg' : '';

                                    return `
                                        <tr>
                                            <td><span class="player-name ${side} player-link" onclick="viewPlayer('${name.replace(/'/g, "\\'")}')">${name}</span></td>
                                            ${rangeCells}
                                            <td><span class="pct ${totalPctClass}">${totalCount}/${totalAttempts}</span> <span style="color:var(--text-dim);">(${totalPct}%)</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // === CRICKET CLOSEOUT BREAKDOWN ===
            const hasCricketCloseoutData = Object.keys(playerCricketCloseouts).length > 0;
            const closeoutRanges = ['9m', '8m', '7m', '6m', '5m'];

            if (hasCricketCloseoutData) {
                html += `
                    <div class="checkout-range-section">
                        <div class="checkout-range-header">CRICKET CLOSEOUT PERFORMANCE</div>
                        <table class="checkout-range-table">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th>9M</th>
                                    <th>8M</th>
                                    <th>7M</th>
                                    <th>6M</th>
                                    <th>5M</th>
                                    <th>Total 5M+</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(playerCricketCloseouts).map(([name, ranges]) => {
                                    const side = homePlayerNames.has(name) ? 'home' : 'away';
                                    let total = 0;

                                    const rangeCells = closeoutRanges.map(range => {
                                        const count = ranges[range] || 0;
                                        total += count;
                                        if (count === 0) return '<td class="no-data">-</td>';
                                        return `<td class="highlight">${count}</td>`;
                                    }).join('');

                                    return `
                                        <tr>
                                            <td><span class="player-name ${side} player-link" onclick="viewPlayer('${name.replace(/'/g, "\\'")}')">${name}</span></td>
                                            ${rangeCells}
                                            <td class="highlight">${total}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            // === PLAYER SUMMARY TABLE ===
            const allPlayers = Object.values(playerStats).sort((a, b) => {
                // Sort by total wins descending, then by name
                if (b.totalWins !== a.totalWins) return b.totalWins - a.totalWins;
                return a.name.localeCompare(b.name);
            });

            // Find best values for highlighting
            const best3DA = Math.max(...allPlayers.map(p => p.x01.darts > 0 ? (p.x01.points / p.x01.darts) * 3 : 0));
            const bestFirst9 = Math.max(...allPlayers.map(p => p.x01.first9Darts > 0 ? (p.x01.first9Points / p.x01.first9Darts) * 3 : 0));
            const bestMPR = Math.max(...allPlayers.map(p => p.cricket.darts > 0 ? p.cricket.marks / (p.cricket.darts / 3) : 0));

            html += `
                <div class="perf-summary-section">
                    <div class="perf-summary-header">PLAYER SUMMARY</div>
                    <table class="perf-table">
                        <thead>
                            <tr>
                                <th rowspan="2">Player</th>
                                <th colspan="3" class="section-header">MATCH</th>
                                <th colspan="4" class="section-header">ALL '01 GAMES</th>
                                <th colspan="3" class="section-header">ALL CRICKET</th>
                            </tr>
                            <tr>
                                <th>Games</th>
                                <th>Wins</th>
                                <th>Win%</th>
                                <th>Pts</th>
                                <th>Dts</th>
                                <th>3DA</th>
                                <th>1st9</th>
                                <th>Mks</th>
                                <th>Dts</th>
                                <th>MPR</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allPlayers.map(p => {
                                const x01Avg = p.x01.darts > 0 ? (p.x01.points / p.x01.darts) * 3 : 0;
                                const first9Avg = p.x01.first9Darts > 0 ? (p.x01.first9Points / p.x01.first9Darts) * 3 : 0;
                                const mpr = p.cricket.darts > 0 ? p.cricket.marks / (p.cricket.darts / 3) : 0;
                                const winPct = p.totalGames > 0 ? Math.round((p.totalWins / p.totalGames) * 100) : 0;
                                const isBest3DA = x01Avg > 0 && x01Avg === best3DA;
                                const isBestFirst9 = first9Avg > 0 && first9Avg === bestFirst9;
                                const isBestMPR = mpr > 0 && mpr === bestMPR;

                                return `
                                    <tr>
                                        <td><span class="player-name ${p.side} player-link" onclick="viewPlayer('${p.name.replace(/'/g, "\\'")}')">${p.name}</span></td>
                                        <td>${p.totalGames}</td>
                                        <td class="highlight">${p.totalWins}</td>
                                        <td>${winPct}%</td>
                                        <td class="dim">${p.x01.points || '-'}</td>
                                        <td class="dim">${p.x01.darts || '-'}</td>
                                        <td class="${isBest3DA ? 'best' : x01Avg >= 50 ? 'highlight' : ''}">${x01Avg ? x01Avg.toFixed(1) : '-'}</td>
                                        <td class="${isBestFirst9 ? 'best' : first9Avg >= 60 ? 'highlight' : ''}">${first9Avg ? first9Avg.toFixed(1) : '-'}</td>
                                        <td class="dim">${p.cricket.marks || '-'}</td>
                                        <td class="dim">${p.cricket.darts || '-'}</td>
                                        <td class="${isBestMPR ? 'best' : mpr >= 2.5 ? 'highlight' : ''}">${mpr ? mpr.toFixed(2) : '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // === GAME DETAIL TABLE ===
            html += `
                <div class="perf-detail-section">
                    <div class="perf-detail-header">
                        <span>GAME DETAIL</span>
                        <button class="perf-detail-toggle" onclick="toggleGameDetail()" id="gameDetailToggle">▼ SHOW</button>
                    </div>
                    <div class="perf-detail-body" id="gameDetailBody" style="display: none;">
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th>Game</th>
                                    <th>Format</th>
                                    <th>Player</th>
                                    <th>C</th>
                                    <th>3DA/MPR</th>
                                    <th>T</th>
                                    <th>W</th>
                                    <th>DT</th>
                                    <th>PTS/MKS</th>
                                    <th>CO/REM</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${renderGameDetailRows(gameDetails)}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            container.innerHTML = html || '<p style="text-align:center;padding:40px;color:var(--text-dim);">No player data</p>';
        }

        function renderGameDetailRows(details) {
            let html = '';
            let lastGame = '';
            let lastSet = 0;

            details.forEach(d => {
                const isNewSet = d.set !== lastSet;
                const isNewGame = d.game !== lastGame;
                const setClass = isNewSet && lastSet !== 0 ? 'set-divider' : '';

                html += `
                    <tr class="${setClass}">
                        <td class="game-cell">${isNewGame ? d.game : ''}</td>
                        <td class="format-cell">${isNewGame ? d.format : ''}</td>
                        <td class="player-cell ${d.side}">${d.player}</td>
                        <td class="cork-cell">${d.cork ? 'S' : ''}</td>
                        <td class="${d.won ? 'stat-highlight' : ''}">${d.isCricket ? (d.mpr ? d.mpr.toFixed(2) : '-') : (d.avg ? d.avg.toFixed(1) : '-')}</td>
                        <td>${d.turn || '-'}</td>
                        <td class="win-cell">${d.won ? 'W' : ''}</td>
                        <td>${d.darts || '-'}</td>
                        <td>${d.isCricket ? (d.marks || '-') : (d.points || '-')}</td>
                        <td>${d.checkout ? d.checkout : (d.remaining ? d.remaining : '-')}</td>
                    </tr>
                `;

                lastGame = d.game;
                lastSet = d.set;
            });

            return html;
        }

        window.toggleGameDetail = function() {
            const body = document.getElementById('gameDetailBody');
            const btn = document.getElementById('gameDetailToggle');
            if (body.style.display === 'none') {
                body.style.display = 'block';
                btn.textContent = '▲ HIDE';
                btn.classList.add('active');
            } else {
                body.style.display = 'none';
                btn.textContent = '▼ SHOW';
                btn.classList.remove('active');
            }
        };

        // ========== COUNTS TAB ==========
        function renderCounts() {
            const container = document.getElementById('countsContainer');
            const games = matchData.games || [];

            // Count notable events for each team
            const counts = {
                home: { tons: 0, ton40: 0, ton80: 0, max180: 0, highOut: 0, marks5: 0, marks6plus: 0, bulls3: 0 },
                away: { tons: 0, ton40: 0, ton80: 0, max180: 0, highOut: 0, marks5: 0, marks6plus: 0, bulls3: 0 }
            };

            // Track checkout ranges by team
            const checkoutRanges = {
                home: { '60_99': { count: 0, attempts: 0 }, '100_139': { count: 0, attempts: 0 }, '140_160': { count: 0, attempts: 0 }, '161_plus': { count: 0, attempts: 0 } },
                away: { '60_99': { count: 0, attempts: 0 }, '100_139': { count: 0, attempts: 0 }, '140_160': { count: 0, attempts: 0 }, '161_plus': { count: 0, attempts: 0 } }
            };

            // Track cricket closeout marks (5M, 6M, 7M, 8M, 9M finishes)
            const cricketCloseouts = {
                home: { '5m': 0, '6m': 0, '7m': 0, '8m': 0, '9m': 0 },
                away: { '5m': 0, '6m': 0, '7m': 0, '8m': 0, '9m': 0 }
            };

            // Track highest checkouts
            let homeHighOut = 0, awayHighOut = 0;

            games.forEach(game => {
                const isCricket = game.format === 'cricket';
                const homePlayerSet = new Set((game.home_players || []).map(p => typeof p === 'string' ? p : p.name));

                (game.legs || []).forEach(leg => {
                    (leg.throws || []).forEach(t => {
                        // Home throw
                        if (t.home) {
                            const side = 'home';

                            if (!isCricket && leg.format !== 'cricket') {
                                // X01 counts
                                const score = t.home.score || 0;
                                if (score >= 180) counts[side].max180++;
                                else if (score >= 140) counts[side].ton80++;
                                else if (score >= 100) counts[side].tons++;

                                // Checkout range tracking
                                const remainingBefore = t.home.remaining + score;
                                const range = getCheckoutRange(remainingBefore);
                                if (range) {
                                    checkoutRanges[side][range].attempts++;
                                    if (t.home.checkout || t.home.remaining === 0) {
                                        checkoutRanges[side][range].count++;
                                        if (score > homeHighOut) homeHighOut = score;
                                    }
                                }
                            } else {
                                // Cricket counts
                                const marks = t.home.marks || 0;
                                if (marks >= 6) counts[side].marks6plus++;
                                else if (marks === 5) counts[side].marks5++;

                                const notable = t.home.notable || '';
                                if (notable.includes('B')) counts[side].bulls3++;

                                // Cricket closeout tracking
                                if (t.home.closed_out || (leg.winner === 'home' && !leg.throws[leg.throws.indexOf(t) + 1]?.home)) {
                                    // This might be a closeout throw
                                    if (marks >= 5 && marks <= 9) {
                                        cricketCloseouts[side][`${marks}m`]++;
                                    }
                                }
                            }
                        }

                        // Away throw
                        if (t.away) {
                            const side = 'away';

                            if (!isCricket && leg.format !== 'cricket') {
                                const score = t.away.score || 0;
                                if (score >= 180) counts[side].max180++;
                                else if (score >= 140) counts[side].ton80++;
                                else if (score >= 100) counts[side].tons++;

                                // Checkout range tracking
                                const remainingBefore = t.away.remaining + score;
                                const range = getCheckoutRange(remainingBefore);
                                if (range) {
                                    checkoutRanges[side][range].attempts++;
                                    if (t.away.checkout || t.away.remaining === 0) {
                                        checkoutRanges[side][range].count++;
                                        if (score > awayHighOut) awayHighOut = score;
                                    }
                                }
                            } else {
                                const marks = t.away.marks || 0;
                                if (marks >= 6) counts[side].marks6plus++;
                                else if (marks === 5) counts[side].marks5++;

                                const notable = t.away.notable || '';
                                if (notable.includes('B')) counts[side].bulls3++;

                                // Cricket closeout tracking
                                if (t.away.closed_out || (leg.winner === 'away' && !leg.throws[leg.throws.indexOf(t) + 1]?.away)) {
                                    if (marks >= 5 && marks <= 9) {
                                        cricketCloseouts[side][`${marks}m`]++;
                                    }
                                }
                            }
                        }
                    });
                });
            });

            let html = `
                <div class="counts-section">
                    <div class="counts-section-header">X01 COUNTS</div>
                    <div class="counts-grid">
                        <div class="count-item">
                            <div class="count-label">180s</div>
                            <div class="count-values">
                                <span class="home">${counts.home.max180}</span>
                                <span class="vs">-</span>
                                <span class="away">${counts.away.max180}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">140+ (Ton-80)</div>
                            <div class="count-values">
                                <span class="home">${counts.home.ton80}</span>
                                <span class="vs">-</span>
                                <span class="away">${counts.away.ton80}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">100+ (Tons)</div>
                            <div class="count-values">
                                <span class="home">${counts.home.tons}</span>
                                <span class="vs">-</span>
                                <span class="away">${counts.away.tons}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">High Checkout</div>
                            <div class="count-values">
                                <span class="home">${homeHighOut || '-'}</span>
                                <span class="vs">-</span>
                                <span class="away">${awayHighOut || '-'}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="counts-section">
                    <div class="counts-section-header">CRICKET COUNTS</div>
                    <div class="counts-grid">
                        <div class="count-item">
                            <div class="count-label">6+ Mark Rounds</div>
                            <div class="count-values">
                                <span class="home">${counts.home.marks6plus}</span>
                                <span class="vs">-</span>
                                <span class="away">${counts.away.marks6plus}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">5 Mark Rounds</div>
                            <div class="count-values">
                                <span class="home">${counts.home.marks5}</span>
                                <span class="vs">-</span>
                                <span class="away">${counts.away.marks5}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">3+ Bull Rounds</div>
                            <div class="count-values">
                                <span class="home">${counts.home.bulls3}</span>
                                <span class="vs">-</span>
                                <span class="away">${counts.away.bulls3}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">Total 5+ Marks</div>
                            <div class="count-values">
                                <span class="home">${counts.home.marks5 + counts.home.marks6plus}</span>
                                <span class="vs">-</span>
                                <span class="away">${counts.away.marks5 + counts.away.marks6plus}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="counts-section">
                    <div class="counts-section-header">CHECKOUT BY RANGE</div>
                    <div class="counts-grid">
                        <div class="count-item">
                            <div class="count-label">60-99 Checkouts</div>
                            <div class="count-values">
                                <span class="home">${checkoutRanges.home['60_99'].count}/${checkoutRanges.home['60_99'].attempts}</span>
                                <span class="vs">-</span>
                                <span class="away">${checkoutRanges.away['60_99'].count}/${checkoutRanges.away['60_99'].attempts}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">100-139 Checkouts</div>
                            <div class="count-values">
                                <span class="home">${checkoutRanges.home['100_139'].count}/${checkoutRanges.home['100_139'].attempts}</span>
                                <span class="vs">-</span>
                                <span class="away">${checkoutRanges.away['100_139'].count}/${checkoutRanges.away['100_139'].attempts}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">140-160 Checkouts</div>
                            <div class="count-values">
                                <span class="home">${checkoutRanges.home['140_160'].count}/${checkoutRanges.home['140_160'].attempts}</span>
                                <span class="vs">-</span>
                                <span class="away">${checkoutRanges.away['140_160'].count}/${checkoutRanges.away['140_160'].attempts}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">161+ Checkouts (Bull)</div>
                            <div class="count-values">
                                <span class="home">${checkoutRanges.home['161_plus'].count}/${checkoutRanges.home['161_plus'].attempts}</span>
                                <span class="vs">-</span>
                                <span class="away">${checkoutRanges.away['161_plus'].count}/${checkoutRanges.away['161_plus'].attempts}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="counts-section">
                    <div class="counts-section-header">CRICKET CLOSEOUTS</div>
                    <div class="counts-grid">
                        <div class="count-item">
                            <div class="count-label">9M Closeouts</div>
                            <div class="count-values">
                                <span class="home">${cricketCloseouts.home['9m']}</span>
                                <span class="vs">-</span>
                                <span class="away">${cricketCloseouts.away['9m']}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">8M Closeouts</div>
                            <div class="count-values">
                                <span class="home">${cricketCloseouts.home['8m']}</span>
                                <span class="vs">-</span>
                                <span class="away">${cricketCloseouts.away['8m']}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">7M Closeouts</div>
                            <div class="count-values">
                                <span class="home">${cricketCloseouts.home['7m']}</span>
                                <span class="vs">-</span>
                                <span class="away">${cricketCloseouts.away['7m']}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">6M Closeouts</div>
                            <div class="count-values">
                                <span class="home">${cricketCloseouts.home['6m']}</span>
                                <span class="vs">-</span>
                                <span class="away">${cricketCloseouts.away['6m']}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">5M Closeouts</div>
                            <div class="count-values">
                                <span class="home">${cricketCloseouts.home['5m']}</span>
                                <span class="vs">-</span>
                                <span class="away">${cricketCloseouts.away['5m']}</span>
                            </div>
                        </div>
                        <div class="count-item">
                            <div class="count-label">Total 5M+ Closeouts</div>
                            <div class="count-values">
                                <span class="home">${cricketCloseouts.home['5m'] + cricketCloseouts.home['6m'] + cricketCloseouts.home['7m'] + cricketCloseouts.home['8m'] + cricketCloseouts.home['9m']}</span>
                                <span class="vs">-</span>
                                <span class="away">${cricketCloseouts.away['5m'] + cricketCloseouts.away['6m'] + cricketCloseouts.away['7m'] + cricketCloseouts.away['8m'] + cricketCloseouts.away['9m']}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // ========== LEADERS TAB ==========
        function renderLeaders() {
            const container = document.getElementById('leadersContainer');
            const games = matchData.games || [];

            // Aggregate stats for all players
            const playerStats = {};
            const homePlayerNames = new Set();
            const awayPlayerNames = new Set();

            // Track checkout ranges for leaderboards
            const playerCheckouts = {};

            // Track cricket closeouts for leaderboards
            const playerCricketCloseouts = {};

            games.forEach(game => {
                const isCricket = game.format === 'cricket';
                const homePlayers = (game.home_players || []).map(p => typeof p === 'string' ? p : p.name);
                const awayPlayers = (game.away_players || []).map(p => typeof p === 'string' ? p : p.name);
                homePlayers.forEach(p => homePlayerNames.add(p));
                awayPlayers.forEach(p => awayPlayerNames.add(p));

                (game.legs || []).forEach(leg => {
                    Object.entries(leg.player_stats || {}).forEach(([name, stats]) => {
                        if (!playerStats[name]) {
                            playerStats[name] = {
                                name,
                                x01Darts: 0, x01Points: 0, x01Legs: 0,
                                cricketDarts: 0, cricketMarks: 0, cricketLegs: 0,
                                totalWins: 0, totalLegs: 0
                            };
                        }

                        const isWinner = (leg.winner === 'home' && homePlayerNames.has(name)) ||
                                         (leg.winner === 'away' && awayPlayerNames.has(name));

                        if (isCricket || leg.format === 'cricket') {
                            playerStats[name].cricketDarts += stats.darts || 0;
                            playerStats[name].cricketMarks += stats.marks || 0;
                            playerStats[name].cricketLegs++;
                        } else {
                            playerStats[name].x01Darts += stats.darts || 0;
                            playerStats[name].x01Points += stats.points || 0;
                            playerStats[name].x01Legs++;
                        }

                        playerStats[name].totalLegs++;
                        if (isWinner) playerStats[name].totalWins++;
                    });

                    // Track checkout ranges from throws (X01 only)
                    if (!isCricket && leg.format !== 'cricket') {
                        (leg.throws || []).forEach(t => {
                            ['home', 'away'].forEach(side => {
                                const throwData = t[side];
                                if (throwData && throwData.score !== undefined) {
                                    const playerName = throwData.player || (side === 'home' ? (homePlayers[0] || 'Unknown') : (awayPlayers[0] || 'Unknown'));
                                    if (typeof playerName === 'object') return; // skip malformed
                                    const actualName = typeof playerName === 'string' ? playerName : playerName.name;

                                    const remainingBefore = throwData.remaining + throwData.score;
                                    const range = getCheckoutRange(remainingBefore);
                                    if (range) {
                                        if (!playerCheckouts[actualName]) {
                                            playerCheckouts[actualName] = {
                                                '60_99': { count: 0, attempts: 0 },
                                                '100_139': { count: 0, attempts: 0 },
                                                '140_160': { count: 0, attempts: 0 },
                                                '161_plus': { count: 0, attempts: 0 }
                                            };
                                        }
                                        playerCheckouts[actualName][range].attempts++;
                                        if (throwData.checkout || throwData.remaining === 0) {
                                            playerCheckouts[actualName][range].count++;
                                        }
                                    }
                                }
                            });
                        });
                    }

                    // Track cricket closeouts from throws
                    if (isCricket || leg.format === 'cricket') {
                        const throwsArray = leg.throws || [];
                        if (throwsArray.length > 0) {
                            const lastThrow = throwsArray[throwsArray.length - 1];
                            // Track closeout for the winner
                            ['home', 'away'].forEach(side => {
                                if (lastThrow[side] && leg.winner === side) {
                                    const marks = lastThrow[side].marks || 0;
                                    const playerName = lastThrow[side].player || (side === 'home' ? homePlayers[0] : awayPlayers[0]);
                                    if (marks >= 5 && marks <= 9) {
                                        if (!playerCricketCloseouts[playerName]) {
                                            playerCricketCloseouts[playerName] = { '5m': 0, '6m': 0, '7m': 0, '8m': 0, '9m': 0, total: 0 };
                                        }
                                        playerCricketCloseouts[playerName][`${marks}m`]++;
                                        playerCricketCloseouts[playerName].total++;
                                    }
                                }
                            });
                        }
                    }
                });
            });

            // Calculate derived stats
            const players = Object.values(playerStats).map(p => ({
                ...p,
                x01Avg: p.x01Darts > 0 ? (p.x01Points / p.x01Darts) * 3 : 0,
                mpr: p.cricketDarts > 0 ? p.cricketMarks / (p.cricketDarts / 3) : 0,
                winRate: p.totalLegs > 0 ? (p.totalWins / p.totalLegs) * 100 : 0,
                side: homePlayerNames.has(p.name) ? 'home' : 'away'
            }));

            // Build leaderboard sections
            let html = '';

            // Best 501 Average (minimum 1 leg)
            const x01Players = players.filter(p => p.x01Legs >= 1).sort((a, b) => b.x01Avg - a.x01Avg);
            if (x01Players.length > 0) {
                html += renderLeaderCard('BEST 501 AVERAGE', x01Players.slice(0, 5), p => `${p.x01Avg.toFixed(1)}`);
            }

            // Best Cricket MPR (minimum 1 leg)
            const cricketPlayers = players.filter(p => p.cricketLegs >= 1).sort((a, b) => b.mpr - a.mpr);
            if (cricketPlayers.length > 0) {
                html += renderLeaderCard('BEST CRICKET MPR', cricketPlayers.slice(0, 5), p => `${p.mpr.toFixed(2)}`);
            }

            // Most Legs Won
            const byWins = [...players].sort((a, b) => b.totalWins - a.totalWins);
            html += renderLeaderCard('MOST LEGS WON', byWins.slice(0, 5), p => `${p.totalWins}`);

            // Best Win Rate (minimum 2 legs)
            const byWinRate = players.filter(p => p.totalLegs >= 2).sort((a, b) => b.winRate - a.winRate);
            if (byWinRate.length > 0) {
                html += renderLeaderCard('BEST WIN RATE', byWinRate.slice(0, 5), p => `${p.winRate.toFixed(0)}%`);
            }

            // === CHECKOUT RANGE LEADERBOARDS ===
            const checkoutRanges = [
                { key: '60_99', label: '60-99 CHECKOUT %' },
                { key: '100_139', label: '100-139 CHECKOUT %' },
                { key: '140_160', label: '140-160 CHECKOUT %' },
                { key: '161_plus', label: '161+ CHECKOUT %' }
            ];

            checkoutRanges.forEach(({ key, label }) => {
                // Build players with checkout data for this range
                const playersWithData = Object.entries(playerCheckouts)
                    .filter(([name, ranges]) => ranges[key].attempts > 0)
                    .map(([name, ranges]) => ({
                        name,
                        count: ranges[key].count,
                        attempts: ranges[key].attempts,
                        pct: (ranges[key].count / ranges[key].attempts) * 100,
                        side: homePlayerNames.has(name) ? 'home' : 'away'
                    }))
                    .sort((a, b) => {
                        // Sort by percentage descending, then by count
                        if (b.pct !== a.pct) return b.pct - a.pct;
                        return b.count - a.count;
                    });

                if (playersWithData.length > 0) {
                    html += renderCheckoutLeaderCard(label, playersWithData.slice(0, 5));
                }
            });

            // === CRICKET CLOSEOUT LEADERBOARDS ===
            const cricketCloseoutPlayers = Object.entries(playerCricketCloseouts)
                .filter(([name, data]) => data.total > 0)
                .map(([name, data]) => ({
                    name,
                    total: data.total,
                    '9m': data['9m'],
                    '8m': data['8m'],
                    '7m': data['7m'],
                    '6m': data['6m'],
                    '5m': data['5m'],
                    side: homePlayerNames.has(name) ? 'home' : 'away'
                }))
                .sort((a, b) => b.total - a.total);

            if (cricketCloseoutPlayers.length > 0) {
                html += renderCricketCloseoutLeaderCard('MOST 5M+ CLOSEOUTS', cricketCloseoutPlayers.slice(0, 5));
            }

            container.innerHTML = html || '<p style="text-align:center;padding:40px;color:var(--text-dim);">No leader data</p>';
        }

        function renderCricketCloseoutLeaderCard(title, players) {
            let rowsHtml = '';
            players.forEach((p, idx) => {
                const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
                const breakdown = [];
                if (p['9m'] > 0) breakdown.push(`9M:${p['9m']}`);
                if (p['8m'] > 0) breakdown.push(`8M:${p['8m']}`);
                if (p['7m'] > 0) breakdown.push(`7M:${p['7m']}`);
                if (p['6m'] > 0) breakdown.push(`6M:${p['6m']}`);
                if (p['5m'] > 0) breakdown.push(`5M:${p['5m']}`);
                const breakdownStr = breakdown.length > 0 ? breakdown.join(', ') : '';

                rowsHtml += `
                    <div class="leader-row">
                        <div class="leader-info">
                            <span class="leader-rank ${rankClass}">${idx + 1}</span>
                            <span class="leader-player ${p.side} player-link" onclick="viewPlayer('${p.name.replace(/'/g, "\\'")}')">${p.name}</span>
                        </div>
                        <span class="leader-value">${p.total} <span style="font-size:10px;color:var(--text-dim);">${breakdownStr}</span></span>
                    </div>
                `;
            });

            return `
                <div class="leader-card">
                    <div class="leader-card-header">
                        <span class="leader-category">${title}</span>
                    </div>
                    <div class="leader-card-body">
                        ${rowsHtml}
                    </div>
                </div>
            `;
        }

        function renderCheckoutLeaderCard(title, players) {
            let rowsHtml = '';
            players.forEach((p, idx) => {
                const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
                rowsHtml += `
                    <div class="leader-row">
                        <div class="leader-info">
                            <span class="leader-rank ${rankClass}">${idx + 1}</span>
                            <span class="leader-player ${p.side} player-link" onclick="viewPlayer('${p.name.replace(/'/g, "\\'")}')">${p.name}</span>
                        </div>
                        <span class="leader-value">${p.pct.toFixed(0)}% <span style="font-size:11px;color:var(--text-dim);">(${p.count}/${p.attempts})</span></span>
                    </div>
                `;
            });

            return `
                <div class="leader-card">
                    <div class="leader-card-header">
                        <span class="leader-category">${title}</span>
                    </div>
                    <div class="leader-card-body">
                        ${rowsHtml}
                    </div>
                </div>
            `;
        }

        function renderLeaderCard(title, players, valueFn) {
            let rowsHtml = '';
            players.forEach((p, idx) => {
                const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : '';
                rowsHtml += `
                    <div class="leader-row">
                        <div class="leader-info">
                            <span class="leader-rank ${rankClass}">${idx + 1}</span>
                            <span class="leader-player ${p.side}" onclick="viewPlayer('${p.name.replace(/'/g, "\\'")}')">${p.name}</span>
                        </div>
                        <span class="leader-value">${valueFn(p)}</span>
                    </div>
                `;
            });

            return `
                <div class="leader-card">
                    <div class="leader-card-header">
                        <span class="leader-category">${title}</span>
                    </div>
                    <div class="leader-card-body">
                        ${rowsHtml}
                    </div>
                </div>
            `;
        }

        // Global functions
        window.toggleSetDetail = function(setIdx) {
            const detail = document.getElementById(`legs-detail-${setIdx}`);
            const btn = document.querySelector(`[data-set-idx="${setIdx}"] .toggle-detail-btn`);
            const text = document.getElementById(`toggle-text-${setIdx}`);
            const card = document.querySelector(`[data-set-idx="${setIdx}"]`);
            const legCount = card?.querySelectorAll('.leg-card').length || 0;

            if (detail.classList.contains('expanded')) {
                detail.classList.remove('expanded');
                btn.classList.remove('expanded');
                text.textContent = `▼ ${legCount} LEGS`;
            } else {
                detail.classList.add('expanded');
                btn.classList.add('expanded');
                text.textContent = '▲ HIDE';
            }
        };

        window.toggleLegThrows = function(setIdx, legIdx) {
            const throws = document.getElementById(`throws-${setIdx}-${legIdx}`);
            throws.classList.toggle('expanded');
        };

        window.toggleAllGames = function() {
            allExpanded = !allExpanded;
            const btn = document.getElementById('expandAllBtn');
            btn.textContent = allExpanded ? '▲ COLLAPSE ALL' : '▼ EXPAND ALL';

            // Get all set cards
            const setCards = document.querySelectorAll('[data-set-idx]');
            setCards.forEach(card => {
                const setIdx = card.dataset.setIdx;
                const detail = document.getElementById(`legs-detail-${setIdx}`);
                const toggleBtn = card.querySelector('.toggle-detail-btn');
                const text = document.getElementById(`toggle-text-${setIdx}`);
                const legCount = card.querySelectorAll('.leg-card').length || 0;

                if (detail) {
                    if (allExpanded) {
                        detail.classList.add('expanded');
                        if (toggleBtn) toggleBtn.classList.add('expanded');
                        if (text) text.textContent = '▲ HIDE';
                    } else {
                        detail.classList.remove('expanded');
                        if (toggleBtn) toggleBtn.classList.remove('expanded');
                        if (text) text.textContent = `▼ ${legCount} LEGS`;
                    }
                }
            });
        };

        window.viewPlayer = function(name) {
            window.location.href = `/pages/player-profile.html?name=${encodeURIComponent(name)}&league_id=${leagueId}`;
        };

        // ========== H2H TAB ==========
        let allMatchPlayers = [];
        let selectedFilterPlayer = 'all';
        let matchPlayerStats = {};

        function initH2HAndFilter() {
            const games = matchData.games || [];
            const homePlayerNames = new Set();
            const awayPlayerNames = new Set();

            // Build player list and calculate stats with First 9 Average
            matchPlayerStats = {};

            games.forEach(game => {
                const isCricket = game.format === 'cricket';
                const homePlayers = (game.home_players || []).map(p => typeof p === 'string' ? p : p.name);
                const awayPlayers = (game.away_players || []).map(p => typeof p === 'string' ? p : p.name);
                homePlayers.forEach(p => homePlayerNames.add(p));
                awayPlayers.forEach(p => awayPlayerNames.add(p));

                (game.legs || []).forEach((leg, legIdx) => {
                    const legFormat = leg.format || game.format || '501';
                    const legIsCricket = legFormat === 'cricket' || legFormat.toLowerCase().includes('cricket');

                    Object.entries(leg.player_stats || {}).forEach(([name, stats]) => {
                        if (!matchPlayerStats[name]) {
                            matchPlayerStats[name] = {
                                name,
                                side: homePlayerNames.has(name) ? 'home' : 'away',
                                x01Darts: 0, x01Points: 0, x01Legs: 0, x01Wins: 0,
                                first9Points: 0, first9Darts: 0,
                                cricketDarts: 0, cricketMarks: 0, cricketLegs: 0, cricketWins: 0,
                                totalLegs: 0, totalWins: 0,
                                legResults: []
                            };
                        }

                        const isWinner = (leg.winner === 'home' && homePlayerNames.has(name)) ||
                                         (leg.winner === 'away' && awayPlayerNames.has(name));

                        if (legIsCricket) {
                            matchPlayerStats[name].cricketDarts += stats.darts || 0;
                            matchPlayerStats[name].cricketMarks += stats.marks || 0;
                            matchPlayerStats[name].cricketLegs++;
                            if (isWinner) matchPlayerStats[name].cricketWins++;
                        } else {
                            matchPlayerStats[name].x01Darts += stats.darts || 0;
                            matchPlayerStats[name].x01Points += stats.points || 0;
                            matchPlayerStats[name].x01Legs++;
                            if (isWinner) matchPlayerStats[name].x01Wins++;

                            // First 9 calculation: sum of first 3 rounds (9 darts)
                            const throws = leg.throws || [];
                            let roundCount = 0;
                            const side = homePlayerNames.has(name) ? 'home' : 'away';
                            throws.forEach(t => {
                                if (t[side]?.player === name && roundCount < 3) {
                                    matchPlayerStats[name].first9Points += t[side].score || 0;
                                    matchPlayerStats[name].first9Darts += 3;
                                    roundCount++;
                                }
                            });
                        }

                        matchPlayerStats[name].totalLegs++;
                        if (isWinner) matchPlayerStats[name].totalWins++;

                        // Track leg result for H2H
                        const opponents = homePlayerNames.has(name) ?
                            awayPlayers : homePlayers;
                        matchPlayerStats[name].legResults.push({
                            gameNum: game.game_number || 1,
                            legNum: leg.leg_number || legIdx + 1,
                            format: legFormat,
                            won: isWinner,
                            opponents
                        });
                    });
                });
            });

            // Build player list
            allMatchPlayers = [];
            homePlayerNames.forEach(name => allMatchPlayers.push({ name, side: 'home' }));
            awayPlayerNames.forEach(name => allMatchPlayers.push({ name, side: 'away' }));

            // Populate H2H selectors
            const select1 = document.getElementById('h2hPlayer1');
            const select2 = document.getElementById('h2hPlayer2');

            if (select1 && select2) {
                let html = '';
                allMatchPlayers.forEach(p => {
                    html += `<option value="${p.name}">${p.name}</option>`;
                });
                select1.innerHTML = html;
                select2.innerHTML = html;

                // Set defaults to first home vs first away
                const homePlayers = allMatchPlayers.filter(p => p.side === 'home');
                const awayPlayers = allMatchPlayers.filter(p => p.side === 'away');
                if (homePlayers.length > 0) select1.value = homePlayers[0].name;
                if (awayPlayers.length > 0) select2.value = awayPlayers[0].name;

                select1.addEventListener('change', updateH2H);
                select2.addEventListener('change', updateH2H);

                updateH2H();
            }

            // Populate player filter
            renderPlayerFilter();
        }

        function renderPlayerFilter() {
            const container = document.getElementById('filterChips');
            const filterSection = document.getElementById('playerFilter');

            if (!container || !filterSection || allMatchPlayers.length === 0) return;

            filterSection.style.display = 'block';

            let html = '<div class="filter-chip active" data-player="all" onclick="filterByPlayer(\'all\')">All Players</div>';
            allMatchPlayers.forEach(p => {
                const sideClass = p.side;
                html += `<div class="filter-chip ${sideClass}" data-player="${p.name}" onclick="filterByPlayer('${p.name.replace(/'/g, "\\'")}')">${p.name}</div>`;
            });
            container.innerHTML = html;
        }

        window.filterByPlayer = function(player) {
            selectedFilterPlayer = player;
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.player === player);
            });
            // Refresh tabs that use filtering
            renderGames();
        };

        function updateH2H() {
            const player1 = document.getElementById('h2hPlayer1')?.value;
            const player2 = document.getElementById('h2hPlayer2')?.value;
            const container = document.getElementById('h2hContent');

            if (!container || !player1 || !player2) return;

            const stats1 = matchPlayerStats[player1];
            const stats2 = matchPlayerStats[player2];

            if (!stats1 || !stats2) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-dim);">Select two players</div>';
                return;
            }

            // Find shared legs (legs where both players participated)
            const games = matchData.games || [];
            const h2hLegs = [];

            games.forEach((game, gameIdx) => {
                const homePlayers = (game.home_players || []).map(p => typeof p === 'string' ? p : p.name);
                const awayPlayers = (game.away_players || []).map(p => typeof p === 'string' ? p : p.name);

                const p1InGame = homePlayers.includes(player1) || awayPlayers.includes(player1);
                const p2InGame = homePlayers.includes(player2) || awayPlayers.includes(player2);

                if (p1InGame && p2InGame) {
                    (game.legs || []).forEach((leg, legIdx) => {
                        h2hLegs.push({
                            game,
                            gameNum: game.game_number || gameIdx + 1,
                            leg,
                            legNum: leg.leg_number || legIdx + 1,
                            p1Side: homePlayers.includes(player1) ? 'home' : 'away',
                            p2Side: homePlayers.includes(player2) ? 'home' : 'away'
                        });
                    });
                }
            });

            let p1Wins = 0, p2Wins = 0;
            let p1TotalPoints = 0, p1TotalDarts = 0, p1Marks = 0, p1Rounds = 0;
            let p2TotalPoints = 0, p2TotalDarts = 0, p2Marks = 0, p2Rounds = 0;

            h2hLegs.forEach(h => {
                if (h.leg.winner === h.p1Side) p1Wins++;
                if (h.leg.winner === h.p2Side) p2Wins++;

                // Calculate H2H specific stats from throws
                const throws = h.leg.throws || [];
                throws.forEach(t => {
                    if (t[h.p1Side]?.player === player1) {
                        p1TotalPoints += t[h.p1Side].score || 0;
                        p1TotalDarts += 3;
                        if (t[h.p1Side].marks) p1Marks += t[h.p1Side].marks;
                        p1Rounds++;
                    }
                    if (t[h.p2Side]?.player === player2) {
                        p2TotalPoints += t[h.p2Side].score || 0;
                        p2TotalDarts += 3;
                        if (t[h.p2Side].marks) p2Marks += t[h.p2Side].marks;
                        p2Rounds++;
                    }
                });
            });

            const p1Avg = p1TotalDarts > 0 ? (p1TotalPoints / p1TotalDarts * 3).toFixed(2) : '-';
            const p2Avg = p2TotalDarts > 0 ? (p2TotalPoints / p2TotalDarts * 3).toFixed(2) : '-';
            const p1MPR = p1Rounds > 0 ? (p1Marks / p1Rounds).toFixed(2) : '-';
            const p2MPR = p2Rounds > 0 ? (p2Marks / p2Rounds).toFixed(2) : '-';

            // Also show First 9 from overall stats
            const p1First9 = stats1.first9Darts > 0 ? (stats1.first9Points / stats1.first9Darts * 3).toFixed(2) : '-';
            const p2First9 = stats2.first9Darts > 0 ? (stats2.first9Points / stats2.first9Darts * 3).toFixed(2) : '-';

            const escapedP1 = player1.replace(/'/g, "\\'");
            const escapedP2 = player2.replace(/'/g, "\\'");

            container.innerHTML = `
                <div class="h2h-results">
                    <div class="h2h-player player1">
                        <div class="h2h-name player-link" onclick="viewPlayer('${escapedP1}')">${player1}</div>
                        <div style="font-size: 13px; margin-top: 8px;">
                            <div>501 Avg: <b>${p1Avg}</b></div>
                            <div>First 9: <b>${p1First9}</b></div>
                            <div>Cricket MPR: <b>${p1MPR}</b></div>
                        </div>
                    </div>
                    <div class="h2h-score-block">
                        <div class="h2h-legs-score">${p1Wins} - ${p2Wins}</div>
                        <div class="h2h-label">Legs Won (${h2hLegs.length} shared legs)</div>
                    </div>
                    <div class="h2h-player player2">
                        <div class="h2h-name player-link" onclick="viewPlayer('${escapedP2}')">${player2}</div>
                        <div style="font-size: 13px; margin-top: 8px;">
                            <div>501 Avg: <b>${p2Avg}</b></div>
                            <div>First 9: <b>${p2First9}</b></div>
                            <div>Cricket MPR: <b>${p2MPR}</b></div>
                        </div>
                    </div>
                </div>
                <div class="h2h-leg-list">
                    <div style="font-family: 'Bebas Neue', cursive; color: var(--yellow); margin-bottom: 10px; font-size: 16px;">SHARED LEGS</div>
                    ${h2hLegs.map(h => {
                        const format = h.leg.format || h.game.format || '501';
                        const winner = h.leg.winner === h.p1Side ? player1 : player2;
                        const winnerColor = h.leg.winner === h.p1Side ? 'var(--pink)' : 'var(--teal)';
                        return `<div class="h2h-leg-item">
                            Set ${h.gameNum} Leg ${h.legNum} - ${format} - <b style="color: ${winnerColor}">${winner} wins</b>
                        </div>`;
                    }).join('')}
                </div>
            `;
        }

        // ============================================
        // PRE-MATCH VIEW FUNCTIONS
        // ============================================

        function renderPreMatch() {
            // Team names
            document.getElementById('preHomeTeamName').textContent = homeTeam?.team_name || matchData.home_team_name || 'Home';
            document.getElementById('preAwayTeamName').textContent = awayTeam?.team_name || matchData.away_team_name || 'Away';

            // Team standings
            if (homeTeam?.standing) {
                document.getElementById('preHomeStanding').textContent = getOrdinal(homeTeam.standing);
            }
            if (awayTeam?.standing) {
                document.getElementById('preAwayStanding').textContent = getOrdinal(awayTeam.standing);
            }

            // Team records
            document.getElementById('preHomeRecord').textContent = `(${homeTeam?.wins || 0}-${homeTeam?.losses || 0})`;
            document.getElementById('preAwayRecord').textContent = `(${awayTeam?.wins || 0}-${awayTeam?.losses || 0})`;

            // Team averages
            const homeAvg = homeTeam?.team_avg_3da?.toFixed(1) || '-';
            const homeMPR = homeTeam?.team_avg_mpr?.toFixed(2) || '-';
            const awayAvg = awayTeam?.team_avg_3da?.toFixed(1) || '-';
            const awayMPR = awayTeam?.team_avg_mpr?.toFixed(2) || '-';
            document.getElementById('preHomeAvg').textContent = `${homeAvg} / ${homeMPR}`;
            document.getElementById('preAwayAvg').textContent = `${awayAvg} / ${awayMPR}`;

            // Week
            const week = matchData.week || matchData.week_number || '?';
            const totalWeeks = leagueData?.total_weeks || '';
            document.getElementById('preMatchWeek').textContent = `WEEK ${week}${totalWeeks ? '/' + totalWeeks : ''}`;

            // Date
            if (matchData.match_date) {
                const date = matchData.match_date.toDate ? matchData.match_date.toDate() : new Date(matchData.match_date);
                document.getElementById('preMatchDate').textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            // Time
            if (matchData.match_time) {
                document.getElementById('preMatchTime').textContent = formatTime(matchData.match_time);
            } else if (leagueData?.default_start_time) {
                document.getElementById('preMatchTime').textContent = formatTime(leagueData.default_start_time);
            }

            // Venue (use home team's venue or league default)
            const venue = matchData.venue || homeTeam?.home_venue || leagueData?.default_venue || 'TBD';
            document.getElementById('preMatchVenue').textContent = venue;

            // Render game cards
            renderPreMatchGames();

            // Setup action buttons
            document.getElementById('leagueHubBtn').href = `/pages/league-view.html?league_id=${leagueId}`;
            document.getElementById('startScoringBtn').href = `/pages/game-setup.html?league_id=${leagueId}&match_id=${matchId}`;

            // Load attendance status
            loadAttendanceStatus();
        }

        function renderPreMatchGames() {
            const gamesContainer = document.getElementById('preMatchGames');
            const matchFormat = leagueData?.match_format || [];

            if (!matchFormat.length) {
                gamesContainer.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No match format configured</div>';
                return;
            }

            // Map player_level to roster positions (0-indexed arrays)
            // A=position 1 (index 0), B=position 2 (index 1), C=position 3 (index 2)
            function getPlayersForLevel(roster, level) {
                const levelMap = {
                    'A': [0],
                    'B': [1],
                    'C': [2],
                    'AB': [0, 1],
                    'AC': [0, 2],
                    'BC': [1, 2],
                    'ALL': [0, 1, 2]
                };
                const indices = levelMap[level] || [0];
                return indices.map(i => roster[i]).filter(p => p);
            }

            // Get game type display name
            function getGameTypeDisplay(round) {
                if (round.game_type === '501' || round.game_type === '301' || round.game_type === '701') {
                    return round.game_type;
                } else if (round.game_type === 'x01' && round.x01_value) {
                    return round.x01_value;
                } else if (round.game_type === 'cricket') {
                    return 'Cricket';
                } else if (round.game_type === 'corks_choice') {
                    return "Cork's Choice";
                } else if (round.game_type === 'mixed' && round.legs && round.legs.length > 0) {
                    // Show actual leg formats instead of "Mixed"
                    const legLabels = round.legs.map(leg => {
                        if (leg.game_type === 'cricket') return 'Crkt';
                        if (leg.game_type === 'corks_choice') return 'Choice';
                        if (leg.game_type === 'x01') return leg.x01_value || 'X01';
                        return leg.game_type || '501';
                    });
                    return legLabels.join('/');
                } else if (round.game_type === 'mixed') {
                    return 'Mixed';
                }
                return round.game_type || '501';
            }

            // Get scorer page based on game type (use league scorers, not casual)
            function getScorerPage(round) {
                if (round.game_type === 'cricket') {
                    return 'league-cricket.html';
                }
                return 'x01-scorer.html';
            }

            // Build scorer URL with parameters - passes ALL league settings for zero-setup scoring
            function buildScorerUrl(round, roundIndex, homePlayers, awayPlayers) {
                const scorerPage = getScorerPage(round);
                const totalGames = matchFormat.length;
                const params = new URLSearchParams({
                    league_id: leagueId,
                    match_id: matchId,
                    game_index: roundIndex,
                    game_number: roundIndex + 1,
                    from_match: 'true',
                    total_games: totalGames,
                    home_team_name: homeTeam?.team_name || matchData.home_team_name || 'Home',
                    away_team_name: awayTeam?.team_name || matchData.away_team_name || 'Away'
                });

                // Pass players as JSON arrays
                if (homePlayers && homePlayers.length > 0) {
                    params.set('home_players', JSON.stringify(homePlayers.map(p => ({
                        id: p.id,
                        name: p.name || p.player_name || 'TBD',
                        level: p.level || p.position
                    }))));
                }
                if (awayPlayers && awayPlayers.length > 0) {
                    params.set('away_players', JSON.stringify(awayPlayers.map(p => ({
                        id: p.id,
                        name: p.name || p.player_name || 'TBD',
                        level: p.level || p.position
                    }))));
                }

                // Check if this is a doubles game (2 players per team)
                const isDoubles = round.num_players === 2;

                // Game format params
                if (round.game_type === 'cricket') {
                    // Cricket-specific params (none needed for basic cricket)
                } else {
                    // X01 params
                    const startScore = round.game_type === 'x01' ? round.x01_value :
                                       (parseInt(round.game_type) || 501);
                    params.set('starting_score', startScore);

                    // For doubles games, enable Cork's Choice (501 vs Cricket selector)
                    // Cork winner gets to choose the game type
                    if (isDoubles) {
                        params.set('format', 'choice');
                    } else {
                        params.set('format', startScore);
                    }

                    params.set('in_rule', round.in_rule || 'straight');
                    params.set('checkout', round.out_rule || 'double');
                }

                // Best of legs
                params.set('legs_to_win', Math.ceil((round.best_of || 3) / 2));

                // Cork and start rules from league settings
                const corkRule = leagueData?.cork_rule || 'cork_every_leg';
                const corkOption = leagueData?.cork_option || 'alternate_random';
                const corkWinnerGets = leagueData?.cork_winner_gets || 'choose_and_start';

                params.set('cork', 'true');
                params.set('cork_rule', corkRule);
                params.set('cork_option', corkOption);

                // Handle corks choice / mixed games
                if (round.game_type === 'corks_choice' || round.game_type === 'mixed') {
                    params.set('corks_choice', 'true');
                    params.set('cork_winner_gets', corkWinnerGets);
                }

                // If mixed game, pass the legs array
                if (round.game_type === 'mixed' && round.legs) {
                    params.set('mixed', 'true');
                    params.set('mixed_legs', JSON.stringify(round.legs));
                }

                return `/pages/${scorerPage}?${params.toString()}`;
            }

            let html = '';
            matchFormat.forEach((round, index) => {
                const homePlayers = getPlayersForLevel(homeRoster, round.player_level);
                const awayPlayers = getPlayersForLevel(awayRoster, round.player_level);
                const isDoubles = round.num_players === 2;
                const gameType = getGameTypeDisplay(round);
                const scorerUrl = buildScorerUrl(round, index, homePlayers, awayPlayers);

                // Determine badge class
                let badgeClass = 'x01';
                if (round.game_type === 'cricket') badgeClass = 'cricket';
                else if (round.game_type === 'corks_choice') badgeClass = 'choice';

                html += `<div class="pre-match-game-card">`;
                html += `<div class="game-card-header">`;
                html += `<span class="game-number">Set ${index + 1}</span>`;
                html += `<span class="game-type-badge ${badgeClass}">${gameType}</span>`;
                if (isDoubles) {
                    html += `<span class="game-type-badge doubles">Doubles</span>`;
                }
                html += `</div>`;

                html += `<div class="game-card-matchup">`;

                // Home players
                html += `<div class="game-player home">`;
                if (homePlayers.length > 0) {
                    homePlayers.forEach((p, i) => {
                        const name = p.name || p.player_name || 'TBD';
                        html += `<span class="player-name">${name}</span>`;
                    });
                } else {
                    html += `<span class="player-name tbd">${round.player_level} Player TBD</span>`;
                }
                html += `</div>`;

                html += `<span class="vs-badge">VS</span>`;

                // Away players
                html += `<div class="game-player away">`;
                if (awayPlayers.length > 0) {
                    awayPlayers.forEach((p, i) => {
                        const name = p.name || p.player_name || 'TBD';
                        html += `<span class="player-name">${name}</span>`;
                    });
                } else {
                    html += `<span class="player-name tbd">${round.player_level} Player TBD</span>`;
                }
                html += `</div>`;

                html += `</div>`;

                // Game rules
                html += `<div class="game-card-rules">`;
                html += `<span>Best of ${round.best_of || 3}</span>`;
                if (round.game_type !== 'cricket') {
                    html += `<span>${(round.in_rule || 'straight').charAt(0).toUpperCase() + (round.in_rule || 'straight').slice(1)} In</span>`;
                    html += `<span>${(round.out_rule || 'double').charAt(0).toUpperCase() + (round.out_rule || 'double').slice(1)} Out</span>`;
                }
                html += `<span>${round.points || 1} pt${(round.points || 1) > 1 ? 's' : ''}</span>`;
                html += `</div>`;

                // Start Set button
                html += `<a href="${scorerUrl}" class="start-set-btn">Start Set</a>`;

                html += `</div>`;
            });

            gamesContainer.innerHTML = html;
        }

        function getOrdinal(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

        function formatTime(timeStr) {
            if (!timeStr) return '-';
            // Handle HH:MM format
            const [hours, minutes] = timeStr.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes} ${ampm}`;
        }

        async function loadAttendanceStatus() {
            if (!currentPlayerId) {
                // Hide attendance section if not logged in
                document.getElementById('preMatchAttendance').style.display = 'none';
                return;
            }

            // Check if current player is on one of the teams (using loaded rosters)
            const isOnHomeTeam = homeRoster.some(p => p.id === currentPlayerId);
            const isOnAwayTeam = awayRoster.some(p => p.id === currentPlayerId);

            if (!isOnHomeTeam && !isOnAwayTeam) {
                // Not on either team, hide attendance
                document.getElementById('preMatchAttendance').style.display = 'none';
                return;
            }

            // Check current attendance status
            const attendance = matchData.attendance || {};
            const status = attendance[currentPlayerId];

            updateAttendanceUI(status);
        }

        function updateAttendanceUI(status) {
            const confirmBtn = document.getElementById('confirmBtn');
            const declineBtn = document.getElementById('declineBtn');
            const statusEl = document.getElementById('attendanceStatus');

            confirmBtn.classList.remove('active');
            declineBtn.classList.remove('active');
            statusEl.className = 'attendance-status';

            if (status === 'confirmed') {
                confirmBtn.classList.add('active');
                statusEl.textContent = "You're marked as attending";
                statusEl.classList.add('confirmed');
            } else if (status === 'unavailable') {
                declineBtn.classList.add('active');
                statusEl.textContent = "You're marked as unavailable";
                statusEl.classList.add('declined');
            } else {
                statusEl.textContent = '';
            }
        }

        window.setAttendance = async function(status) {
            if (!currentPlayerId) {
                alert('Please log in to set attendance');
                return;
            }

            try {
                const matchRef = doc(db, 'leagues', leagueId, 'matches', matchId);
                await updateDoc(matchRef, {
                    [`attendance.${currentPlayerId}`]: status
                });

                // Update local data and UI
                if (!matchData.attendance) matchData.attendance = {};
                matchData.attendance[currentPlayerId] = status;
                updateAttendanceUI(status);

            } catch (error) {
                console.error('Error setting attendance:', error);
                alert('Failed to update attendance');
            }
        };

        window.goBack = function() {
            if (leagueId) {
                window.location.href = `/pages/league-view.html?league_id=${leagueId}`;
            } else {
                window.history.back();
            }
        };

        // Refresh data when returning to this page (from scorer or other tab)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                console.log('Page visible again, refreshing match data...');
                loadMatch();
            }
        });

        // Also refresh on pageshow (handles back/forward navigation)
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                console.log('Page restored from cache, refreshing match data...');
                loadMatch();
            }
        });

        // Initialize
        loadMatch();
    </script>
<script src="/js/nav-menu.js"></script>
</body>
</html>
