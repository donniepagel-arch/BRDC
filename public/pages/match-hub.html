<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Hub - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/brdc-styles.css">
    <style>
        body {
            background: linear-gradient(180deg, #1F85AF 0%, #001F4D 100%);
            min-height: 100vh;
        }
        .pin-entry {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .pin-card {
            background: white;
            border: 5px solid var(--black);
            box-shadow: 12px 12px 0 rgba(0,0,0,1);
            padding: 50px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        .pin-input-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 30px 0;
        }
        .pin-char {
            width: 50px;
            height: 60px;
            border: 4px solid var(--black);
            font-size: 28px;
            text-align: center;
            font-family: 'Bebas Neue', cursive;
            text-transform: uppercase;
        }
        .pin-char:focus {
            outline: none;
            border-color: var(--pink);
            background: #fff5f9;
        }
        .match-header {
            background: var(--pink);
            padding: 25px;
            text-align: center;
            border-bottom: 5px solid var(--black);
        }
        .team-vs-team {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            padding: 30px;
            align-items: center;
            background: white;
        }
        .team-block {
            text-align: center;
        }
        .team-block.home { border-right: 3px solid #eee; padding-right: 30px; }
        .team-block.away { border-left: 3px solid #eee; padding-left: 30px; }
        .team-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            margin-bottom: 15px;
        }
        .team-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 72px;
            color: var(--pink);
            text-shadow: 3px 3px 0 rgba(0,0,0,0.1);
        }
        .team-players {
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.8;
        }
        .vs-badge {
            width: 70px;
            height: 70px;
            background: var(--yellow);
            border: 4px solid var(--black);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
        }
        .games-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 30px;
            background: #f8f9fa;
        }
        @media (max-width: 900px) {
            .games-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 600px) {
            .games-grid { grid-template-columns: 1fr; }
            .team-vs-team { grid-template-columns: 1fr; gap: 20px; }
            .team-block.home, .team-block.away { border: none; padding: 0; }
        }
        .game-card {
            background: white;
            border: 4px solid var(--black);
            box-shadow: 6px 6px 0 rgba(0,0,0,1);
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }
        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 8px 8px 0 rgba(0,0,0,1);
        }
        .game-card.pending { border-color: #9ca3af; }
        .game-card.in_progress { border-color: var(--yellow); background: #fffbeb; }
        .game-card.completed { border-color: #10b981; background: #f0fdf4; }
        .game-header {
            padding: 12px 15px;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--black);
        }
        .game-header.pending { background: #e5e7eb; }
        .game-header.in_progress { background: var(--yellow); }
        .game-header.completed { background: #10b981; color: white; }
        .game-body {
            padding: 15px;
        }
        .game-format {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 4px 8px;
            background: var(--teal);
            border: 2px solid var(--black);
            display: inline-block;
        }
        .game-players {
            margin-top: 12px;
            font-size: 13px;
            line-height: 1.6;
        }
        .game-players .home { color: var(--pink); font-weight: 700; }
        .game-players .away { color: var(--blue-dark); font-weight: 700; }
        .game-result {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 2px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .legs-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
        }
        .winner-badge {
            background: #10b981;
            color: white;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
        }
        .match-actions {
            padding: 20px 30px;
            background: white;
            border-top: 3px solid var(--black);
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <!-- PIN Entry Screen -->
    <div id="pinEntry" class="pin-entry">
        <div class="pin-card">
            <img src="/images/skull-logo.png" alt="BRDC" style="width: 80px; margin-bottom: 20px;">
            <h1 style="font-family: 'Bebas Neue', cursive; font-size: 36px;">MATCH HUB</h1>
            <p style="color: #666; margin-top: 10px;">Enter your match PIN to begin scoring</p>
            
            <div class="pin-input-group">
                <input type="text" maxlength="1" class="pin-char" inputmode="text">
                <input type="text" maxlength="1" class="pin-char" inputmode="text">
                <input type="text" maxlength="1" class="pin-char" inputmode="text">
                <input type="text" maxlength="1" class="pin-char" inputmode="text">
                <input type="text" maxlength="1" class="pin-char" inputmode="text">
                <input type="text" maxlength="1" class="pin-char" inputmode="text">
            </div>
            
            <button id="loadMatchBtn" class="brdc-btn" style="width: 100%;">LOAD MATCH</button>
            <p id="pinError" style="color: #ef4444; margin-top: 20px; display: none;"></p>
        </div>
    </div>

    <!-- Match Hub Screen -->
    <div id="matchHub" style="display: none;">
        <div class="brdc-card" style="max-width: 1200px; margin: 20px auto;">
            <div class="match-header">
                <h1 class="brdc-title" style="font-size: 28px; color: white; margin: 0;">üéØ MATCH IN PROGRESS</h1>
                <p style="color: white; opacity: 0.9; margin-top: 8px;" id="matchInfo">Week 1 ‚Ä¢ Wednesday Night League</p>
            </div>

            <div class="team-vs-team">
                <div class="team-block home">
                    <div class="team-title" id="homeTeamName">Home Team</div>
                    <div class="team-score" id="homeTeamScore">0</div>
                    <div class="team-players" id="homeTeamPlayers"></div>
                </div>
                
                <div class="vs-badge">VS</div>
                
                <div class="team-block away">
                    <div class="team-title" id="awayTeamName">Away Team</div>
                    <div class="team-score" id="awayTeamScore">0</div>
                    <div class="team-players" id="awayTeamPlayers"></div>
                </div>
            </div>

            <div class="games-grid" id="gamesGrid">
                <!-- Games populated dynamically -->
            </div>

            <div class="match-actions">
                <button class="brdc-btn brdc-btn-secondary" onclick="refreshMatch()">üîÑ REFRESH</button>
                <button class="brdc-btn" onclick="exitMatch()">üö™ EXIT MATCH</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, doc, getDoc, onSnapshot, callFunction } from '/js/firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        let leagueId = urlParams.get('league_id');
        let matchId = urlParams.get('match_id');

        let matchData = null;
        let homeTeam = null;
        let awayTeam = null;
        let unsubscribe = null;

        // PIN input handling
        const pinInputs = document.querySelectorAll('.pin-char');
        pinInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
                if (e.target.value.length === 1 && index < 5) {
                    pinInputs[index + 1].focus();
                }
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    pinInputs[index - 1].focus();
                }
            });
        });

        // Load match button
        document.getElementById('loadMatchBtn').addEventListener('click', loadMatchByPin);

        async function loadMatchByPin() {
            const pin = Array.from(pinInputs).map(i => i.value).join('').toUpperCase();
            
            if (pin.length !== 6) {
                showPinError('Enter all 6 characters');
                return;
            }

            try {
                const result = await callFunction('getMatchByPin', { pin: pin });

                if (!result.success) {
                    showPinError(result.error || 'Match not found');
                    return;
                }

                leagueId = result.league_id;
                matchId = result.match.id;
                matchData = result.match;
                homeTeam = result.home_team;
                awayTeam = result.away_team;

                // Update URL
                window.history.replaceState({}, '', `?league_id=${leagueId}&match_id=${matchId}`);

                // Switch to match view
                document.getElementById('pinEntry').style.display = 'none';
                document.getElementById('matchHub').style.display = 'block';

                renderMatch();
                setupRealtimeListener();

            } catch (error) {
                showPinError('Error: ' + error.message);
            }
        }

        // If league_id and match_id provided in URL, load directly
        if (leagueId && matchId) {
            loadMatchDirect();
        }

        async function loadMatchDirect() {
            try {
                const matchDoc = await getDoc(doc(db, 'leagues', leagueId, 'matches', matchId));
                if (!matchDoc.exists()) {
                    showPinError('Match not found');
                    return;
                }

                matchData = { id: matchId, ...matchDoc.data() };

                // Load teams
                const homeDoc = await getDoc(doc(db, 'leagues', leagueId, 'teams', matchData.home_team_id));
                const awayDoc = await getDoc(doc(db, 'leagues', leagueId, 'teams', matchData.away_team_id));

                homeTeam = { id: homeDoc.id, ...homeDoc.data() };
                awayTeam = { id: awayDoc.id, ...awayDoc.data() };

                document.getElementById('pinEntry').style.display = 'none';
                document.getElementById('matchHub').style.display = 'block';

                renderMatch();
                setupRealtimeListener();

            } catch (error) {
                showPinError('Error loading match: ' + error.message);
            }
        }

        function showPinError(msg) {
            const el = document.getElementById('pinError');
            el.textContent = msg;
            el.style.display = 'block';
        }

        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();

            unsubscribe = onSnapshot(
                doc(db, 'leagues', leagueId, 'matches', matchId),
                (docSnap) => {
                    if (docSnap.exists()) {
                        matchData = { id: matchId, ...docSnap.data() };
                        renderMatch();
                    }
                },
                (error) => {
                    console.error('Realtime listener error:', error);
                }
            );
        }

        function renderMatch() {
            // Header info
            document.getElementById('matchInfo').textContent = `Week ${matchData.week} ‚Ä¢ ${matchData.match_date}`;

            // Team names and scores
            document.getElementById('homeTeamName').textContent = homeTeam.team_name;
            document.getElementById('awayTeamName').textContent = awayTeam.team_name;
            document.getElementById('homeTeamScore').textContent = matchData.home_score || 0;
            document.getElementById('awayTeamScore').textContent = matchData.away_score || 0;

            // Team players
            if (homeTeam.players) {
                document.getElementById('homeTeamPlayers').innerHTML = homeTeam.players
                    .map(p => `<div>P${p.position}: ${p.name}</div>`)
                    .join('');
            }
            if (awayTeam.players) {
                document.getElementById('awayTeamPlayers').innerHTML = awayTeam.players
                    .map(p => `<div>P${p.position}: ${p.name}</div>`)
                    .join('');
            }

            // Games grid
            renderGames();
        }

        function renderGames() {
            const container = document.getElementById('gamesGrid');
            const games = matchData.games || [];

            if (games.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px;">No games loaded yet.</p>';
                return;
            }

            let html = '';

            games.forEach((game, index) => {
                const statusClass = game.status;
                const formatLabel = game.format === '501' 
                    ? (game.checkout === 'choice' ? '501 C/CH' : '501 DO') 
                    : 'CRICKET';

                const homePlayers = game.home_players?.map(p => p?.name || 'TBD').join(' & ') || 'TBD';
                const awayPlayers = game.away_players?.map(p => p?.name || 'TBD').join(' & ') || 'TBD';

                html += `
                    <div class="game-card ${statusClass}" onclick="openGame(${index})">
                        <div class="game-header ${statusClass}">
                            <span>Game ${game.game_number}</span>
                            <span class="game-format">${formatLabel}</span>
                        </div>
                        <div class="game-body">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 8px;">
                                ${game.type === 'doubles' ? 'DOUBLES' : 'SINGLES'}
                            </div>
                            <div class="game-players">
                                <div class="home">üè† ${homePlayers}</div>
                                <div class="away">üöó ${awayPlayers}</div>
                            </div>
                            ${game.status === 'completed' ? `
                                <div class="game-result">
                                    <span class="legs-score">${game.home_legs_won} - ${game.away_legs_won}</span>
                                    <span class="winner-badge">${game.winner === 'home' ? 'HOME' : 'AWAY'} WINS</span>
                                </div>
                            ` : game.status === 'in_progress' ? `
                                <div class="game-result">
                                    <span class="legs-score">${game.home_legs_won || 0} - ${game.away_legs_won || 0}</span>
                                    <span style="color: var(--yellow); font-weight: 700;">IN PROGRESS</span>
                                </div>
                            ` : `
                                <div style="margin-top: 12px; text-align: center; color: #9ca3af; font-weight: 600;">
                                    TAP TO START
                                </div>
                            `}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        window.openGame = function(gameIndex) {
            const game = matchData.games[gameIndex];
            
            // Determine which scorer to open
            const scorerPage = game.format === '501' ? 'league-501.html' : 'league-cricket.html';
            
            // Build URL with all needed params
            const params = new URLSearchParams({
                league_id: leagueId,
                match_id: matchId,
                game_index: gameIndex,
                game_number: game.game_number,
                format: game.format,
                type: game.type,
                checkout: game.checkout || 'double'
            });

            // Add player info
            if (game.home_players) {
                params.set('home_players', JSON.stringify(game.home_players));
            }
            if (game.away_players) {
                params.set('away_players', JSON.stringify(game.away_players));
            }

            window.location.href = `/pages/${scorerPage}?${params.toString()}`;
        };

        window.refreshMatch = async function() {
            try {
                const matchDoc = await getDoc(doc(db, 'leagues', leagueId, 'matches', matchId));
                if (matchDoc.exists()) {
                    matchData = { id: matchId, ...matchDoc.data() };
                    renderMatch();
                }
            } catch (error) {
                alert('Error refreshing: ' + error.message);
            }
        };

        window.exitMatch = function() {
            if (unsubscribe) unsubscribe();
            if (confirm('Exit match hub? You can re-enter with the match PIN.')) {
                window.location.href = '/';
            }
        };

        // Focus first PIN input
        pinInputs[0].focus();
    </script>
</body>
</html>
