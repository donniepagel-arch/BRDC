<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Bracket - BRDC</title>
    <link rel="stylesheet" href="/css/brdc-styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .header-logo {
            width: 40px;
            height: 40px;
            
        }
        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 3px;
            color: var(--pink);
        }
        .back-btn {
            background: transparent;
            border: 2px solid var(--pink);
            color: var(--pink);
            padding: 8px 16px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .back-btn:hover {
            background: var(--pink);
            color: var(--black);
        }

        .bracket-container {
            display: flex;
            gap: 40px;
            overflow-x: auto;
            padding: 40px 20px;
        }
        
        .round-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 280px;
        }
        
        .round-title {
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-align: center;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .match-card {
            background: var(--bg-card);
            border: 3px solid var(--black);
            border-radius: 8px;
            padding: 16px;
            box-shadow: 6px 6px 0 rgba(0,0,0,1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .match-card:hover {
            transform: translateY(-2px);
            box-shadow: 8px 8px 0 rgba(0,0,0,1);
        }
        
        .match-card.completed {
            background: rgba(34,197,94,0.1);
            border-color: #16a34a;
        }
        
        .match-card.in-progress {
            background: var(--yellow);
            border-color: var(--black);
        }
        
        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: var(--bg-panel);
            transition: background 0.2s;
        }
        
        .player-row.winner {
            background: rgba(34,197,94,0.2);
            font-weight: 700;
        }
        
        .player-name {
            flex: 1;
            font-size: 14px;
            color: var(--text-light);
        }
        
        .player-name.tbd {
            color: var(--text-dim);
            font-style: italic;
        }
        
        .player-score {
            font-size: 16px;
            font-weight: bold;
            color: #059669;
            margin-left: 12px;
        }
        
        .match-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .match-number {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
        }
        
        .board-badge {
            background: var(--teal);
            color: var(--black);
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 700;
            border: 2px solid var(--black);
        }
        
    </style>
</head>
<body>
    <div class="header-bar">
        <button class="back-btn" onclick="history.back()">← BACK</button>
        <img src="/images/gold_logo.png" alt="BRDC" class="header-logo">
        <span class="header-title">BRACKET</span>
    </div>

    <div class="container">
        <div class="tournament-info" style="text-align: center; padding: 20px; margin-bottom: 20px;">
            <h1 class="brdc-title" style="font-size: 36px; color: var(--pink);" id="tournamentName">Loading...</h1>
            <p class="brdc-subtitle" style="color: var(--text-light); margin-top: 10px;" id="eventName"></p>
        </div>

        <div id="bracketContainer" class="bracket-container">
            <div style="text-align: center; width: 100%; padding: 40px; color: white;">
                <div class="brdc-spinner"></div>
                <p style="margin-top: 20px; font-size: 18px;">Loading bracket...</p>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { db, collection, query, where, onSnapshot, doc, getDoc } from '/js/firebase-config.js';
        
        // Get tournament ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const tournamentId = urlParams.get('tournament_id');
        
        if (!tournamentId) {
            document.getElementById('bracketContainer').innerHTML = `
                <div style="text-align: center; width: 100%; color: white; padding: 40px;">
                    <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 16px;">No Tournament Specified</h2>
                    <p>Please provide a tournament_id in the URL</p>
                    <p style="font-size: 14px; margin-top: 8px; opacity: 0.75;">Example: ?tournament_id=your_tournament_id</p>
                </div>
            `;
        } else {
            loadBracket();
        }
        
        async function loadBracket() {
            try {
                // Load tournament data
                const tournamentDoc = await getDoc(doc(db, 'tournaments', tournamentId));
                if (!tournamentDoc.exists()) {
                    throw new Error('Tournament not found');
                }
                const tournament = tournamentDoc.data();
                
                // Update header
                document.getElementById('tournamentName').textContent = tournament.name;
                document.getElementById('eventName').textContent = 
                    `${tournament.date} • ${formatFormat(tournament.format)}`;
                
                // Real-time listener for matches
                const matchesQuery = query(
                    collection(db, 'matches'),
                    where('tournament_id', '==', tournamentId)
                );
                
                onSnapshot(matchesQuery, (snapshot) => {
                    const matches = [];
                    snapshot.forEach((doc) => {
                        matches.push({ id: doc.id, ...doc.data() });
                    });
                    renderBracket(matches);
                });
                
            } catch (error) {
                console.error('Error loading bracket:', error);
                document.getElementById('bracketContainer').innerHTML = `
                    <div style="text-align: center; width: 100%; color: white; padding: 40px;">
                        <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 16px;">Error Loading Bracket</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function renderBracket(matches) {
            if (!matches || matches.length === 0) {
                document.getElementById('bracketContainer').innerHTML = `
                    <div style="text-align: center; width: 100%; color: white; padding: 40px;">
                        <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 16px;">No Matches Yet</h2>
                        <p>Bracket will appear once matches are created</p>
                    </div>
                `;
                return;
            }
            
            // Group matches by round
            const rounds = {};
            matches.forEach(match => {
                const roundNum = match.round || 1;
                if (!rounds[roundNum]) rounds[roundNum] = [];
                rounds[roundNum].push(match);
            });
            
            // Sort rounds
            const sortedRounds = Object.keys(rounds).sort((a, b) => a - b);
            
            // Render bracket
            let html = '';
            sortedRounds.forEach(roundNum => {
                html += `
                    <div class="round-column">
                        <div class="round-title">${getRoundName(roundNum, sortedRounds.length)}</div>
                        ${rounds[roundNum].map(match => createMatchCard(match)).join('')}
                    </div>
                `;
            });
            
            document.getElementById('bracketContainer').innerHTML = html;
        }
        
        function createMatchCard(match) {
            const completedClass = match.winner_id ? 'completed' : '';
            const inProgressClass = match.status === 'in_progress' ? 'in-progress' : '';
            
            return `
                <div class="match-card ${completedClass} ${inProgressClass}">
                    <div class="match-info">
                        <span class="match-number">Match ${match.match_number || ''}</span>
                        ${match.board_number ? `<span class="board-badge">Board ${match.board_number}</span>` : ''}
                    </div>
                    <div class="player-row ${match.winner_id === match.player1_id ? 'winner' : ''}">
                        <span class="player-name ${match.player1_name ? '' : 'tbd'}">
                            ${match.player1_name || 'TBD'}
                        </span>
                        ${match.player1_score !== null && match.player1_score !== undefined ? 
                            `<span class="player-score">${match.player1_score}</span>` : ''}
                    </div>
                    <div class="player-row ${match.winner_id === match.player2_id ? 'winner' : ''}">
                        <span class="player-name ${match.player2_name ? '' : 'tbd'}">
                            ${match.player2_name || 'TBD'}
                        </span>
                        ${match.player2_score !== null && match.player2_score !== undefined ? 
                            `<span class="player-score">${match.player2_score}</span>` : ''}
                    </div>
                </div>
            `;
        }
        
        function getRoundName(roundNum, totalRounds) {
            const round = parseInt(roundNum);
            if (totalRounds === 1) return 'Finals';
            if (round === totalRounds) return 'Finals';
            if (round === totalRounds - 1) return 'Semi-Finals';
            if (round === totalRounds - 2) return 'Quarter-Finals';
            return `Round ${round}`;
        }
        
        function formatFormat(format) {
            const formats = {
                'single_elimination': 'Single Elimination',
                'double_elimination': 'Double Elimination',
                'round_robin': 'Round Robin',
                'swiss': 'Swiss System'
            };
            return formats[format] || format;
        }
    </script>
<script src="/js/feedback.js"></script>
</body>
</html>
