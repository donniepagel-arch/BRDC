<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>League - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FF469A">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap');

        :root {
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --text-light: #f0f0f0;
            --text-dim: #8a8aa3;
            --text-primary: #ffffff;
            --border-color: rgba(255,255,255,0.15);
            --success: #22c55e;
            --danger: #ef4444;
            --black: #000000;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { min-height: 100%; overflow-x: hidden; width: 100%; }
        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            color: var(--text-light);
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Header Bar */
        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .back-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--pink);
        }

        .header-logo { width: 40px; height: 40px; }
        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 3px;
            color: var(--pink);
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }

        /* League Header Card */
        .league-header-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.3);
        }

        .league-header-top {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .league-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--pink), var(--teal));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border: 3px solid #000;
            flex-shrink: 0;
        }

        .league-info { flex: 1; }

        .league-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 1px;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .league-season {
            font-size: 13px;
            color: var(--text-dim);
        }

        .league-status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .league-status-badge.active { background: var(--success); color: #000; }
        .league-status-badge.registration { background: var(--teal); color: #000; }
        .league-status-badge.draft { background: var(--yellow); color: #000; }
        .league-status-badge.completed { background: #666; color: #fff; }

        .league-stats-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .league-stat {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .league-stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--yellow);
        }

        .league-stat-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        /* Sub signup card in league header */
        .sub-signup-card {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 15px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(95, 200, 220, 0.15) 0%, rgba(95, 200, 220, 0.08) 100%);
            border: 2px solid var(--teal);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .sub-signup-card:hover {
            background: linear-gradient(135deg, rgba(95, 200, 220, 0.25) 0%, rgba(95, 200, 220, 0.15) 100%);
            transform: translateY(-1px);
        }
        .sub-signup-icon {
            font-size: 28px;
            flex-shrink: 0;
        }
        .sub-signup-content {
            flex: 1;
        }
        .sub-signup-title {
            font-family: 'Archivo Black', sans-serif;
            font-size: 14px;
            color: var(--teal);
            margin-bottom: 2px;
        }
        .sub-signup-desc {
            font-size: 12px;
            color: var(--text-dim);
            line-height: 1.3;
        }
        .sub-signup-arrow {
            font-size: 20px;
            color: var(--teal);
            font-weight: bold;
        }

        /* Sub signup modal styles */
        .sub-signup-intro {
            background: rgba(95, 200, 220, 0.1);
            border-left: 3px solid var(--teal);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        .sub-signup-intro p {
            margin: 0 0 10px 0;
            color: var(--text-color);
        }
        .sub-signup-intro ul {
            margin: 0;
            padding-left: 20px;
            color: var(--text-dim);
        }
        .sub-signup-intro li {
            margin-bottom: 4px;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }

        /* Rules tab styles */
        .rules-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .rules-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }
        .rules-card-header {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px 16px;
            font-family: 'Archivo Black', sans-serif;
            font-size: 12px;
            color: var(--teal);
            border-bottom: 1px solid var(--border-color);
        }
        .rules-card-body {
            padding: 12px 16px;
        }
        .rules-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .rules-item:last-child {
            border-bottom: none;
        }
        .rules-label {
            font-size: 13px;
            color: var(--text-dim);
            flex-shrink: 0;
        }
        .rules-value {
            font-size: 13px;
            color: var(--text-color);
            text-align: right;
            max-width: 60%;
        }

        /* Legacy league card styles for registration view */
        .league-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 16px;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.3);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .league-header {
            background: linear-gradient(135deg, var(--pink) 0%, #cc3879 100%);
            padding: 25px;
            position: relative;
        }
        .league-header .league-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .league-header .league-season {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 2px;
            opacity: 0.9;
            color: white;
        }
        .league-body { padding: 25px; }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .info-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-left: 3px solid var(--teal);
            border-radius: 0 8px 8px 0;
        }
        .info-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 4px;
        }
        .info-value {
            font-weight: 700;
            font-size: 16px;
        }
        .spots-display {
            background: linear-gradient(135deg, var(--yellow), #e6c200);
            color: #000;
            padding: 18px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .spots-count {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
        }
        .spots-label { font-weight: 700; font-size: 12px; }

        .register-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(180deg, var(--pink) 0%, #d63384 100%);
            border: 3px solid #000;
            border-radius: 10px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 2px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
            transition: all 0.15s;
        }
        .register-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }
        .register-btn:disabled { background: #666; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Sign-ups Section */
        .signups-section {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 16px;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .signups-header {
            background: rgba(0,0,0,0.3);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .signups-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 1px;
        }
        .signups-count {
            background: var(--pink);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        .signups-body { padding: 15px; }
        .signup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .signup-item:last-child { margin-bottom: 0; }
        .signup-name { font-weight: 600; font-size: 14px; }
        .signup-level {
            background: var(--teal);
            color: #000;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
        }
        .signup-status {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 10px;
            font-weight: 600;
        }
        .signup-status.confirmed { background: var(--success); color: #000; }
        .signup-status.pending { background: var(--yellow); color: #000; }
        .login-prompt {
            text-align: center;
            padding: 30px;
            color: var(--text-dim);
        }

        /* Registration Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: linear-gradient(180deg, var(--blue-light) 0%, var(--blue-dark) 100%);
            border: 4px solid var(--pink);
            box-shadow: 0 0 50px rgba(255, 70, 154, 0.3);
            max-width: min(500px, 95vw);
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            background: var(--pink);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 2px;
        }
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
        }
        .modal-body { padding: 25px; }

        /* PIN Lookup Section */
        .pin-section {
            background: linear-gradient(135deg, var(--yellow), #e6c200);
            color: var(--black);
            padding: 20px;
            margin-bottom: 25px;
            border: 3px solid var(--black);
        }
        .pin-section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        .pin-row {
            display: flex;
            gap: 10px;
        }
        .pin-input {
            flex: 1;
            padding: 12px;
            border: 3px solid var(--black);
            font-size: 18px;
            font-family: monospace;
            letter-spacing: 3px;
            text-align: center;
        }
        .pin-btn {
            padding: 12px 20px;
            background: var(--black);
            color: white;
            border: none;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            cursor: pointer;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }
        .divider::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 2px;
            background: rgba(255,255,255,0.2);
        }
        .divider span {
            background: var(--blue-light);
            padding: 0 15px;
            position: relative;
            color: var(--text-dim);
            font-weight: 600;
        }

        .form-group { margin-bottom: 20px; }
        .form-label {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            color: var(--text-dim);
        }
        .form-label span { color: var(--pink); }
        .form-input {
            width: 100%;
            padding: 14px;
            border: 3px solid var(--black);
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 16px;
        }
        .form-input:focus { outline: none; border-color: var(--pink); background: rgba(255,255,255,0.1); }
        .form-select {
            width: 100%;
            padding: 14px;
            border: 3px solid var(--black);
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 16px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .checkbox-group input {
            width: 22px;
            height: 22px;
            accent-color: var(--pink);
        }

        /* Payment Options */
        .payment-section { margin: 25px 0; }
        .payment-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
        .payment-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .payment-option:hover { background: rgba(255,255,255,0.1); }
        .payment-option.selected { border-color: var(--pink); background: rgba(255, 70, 154, 0.1); }
        .payment-option input { width: 20px; height: 20px; accent-color: var(--pink); }
        .payment-label { font-weight: 600; }
        .payment-desc { font-size: 12px; color: var(--text-dim); }

        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--pink), #cc3879);
            border: 4px solid var(--black);
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 2px;
            cursor: pointer;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.5);
            transition: all 0.2s;
        }
        .submit-btn:hover { transform: translate(-2px, -2px); }
        .submit-btn:disabled { background: #666; cursor: not-allowed; transform: none; }

        .fee-display {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid var(--teal);
        }
        .fee-amount {
            font-family: 'Archivo Black', sans-serif;
            font-size: 28px;
            color: var(--teal);
        }

        /* Success State */
        .success-content {
            text-align: center;
            padding: 40px 20px;
        }
        .success-icon { font-size: 80px; margin-bottom: 20px; }
        .success-title {
            font-family: 'Archivo Black', sans-serif;
            font-size: 32px;
            margin-bottom: 15px;
        }
        .success-message {
            color: var(--text-dim);
            margin-bottom: 25px;
            line-height: 1.6;
        }
        .pin-display-box {
            background: var(--yellow);
            color: var(--black);
            padding: 20px;
            margin: 20px 0;
            border: 4px solid var(--black);
        }
        .pin-display-label { font-weight: 700; font-size: 14px; margin-bottom: 5px; }
        .pin-display-value {
            font-family: 'Archivo Black', sans-serif;
            font-size: 36px;
            letter-spacing: 8px;
        }

        .loading { text-align: center; padding: 60px; color: var(--text-dim); }
        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            padding: 20px;
            text-align: center;
            color: #ef4444;
        }

        /* Tabs */
        .tab-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            border-bottom: 3px solid var(--border-color);
            padding-bottom: 5px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            border-bottom: 3px solid var(--border-color);
            padding-bottom: 5px;
        }

        .tab {
            background: rgba(0,0,0,0.3);
            border: 2px solid transparent;
            padding: 12px 20px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px 8px 0 0;
        }

        .tab:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        .tab.active {
            background: var(--pink);
            color: white;
            border-color: var(--pink);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Schedule Filters */
        .schedule-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-family: 'Bebas Neue', cursive;
            font-size: 11px;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        .filter-select {
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            min-width: 140px;
        }

        .filter-select:hover {
            border-color: var(--pink);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--pink);
        }

        /* Schedule / Week Cards */
        .week-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .week-header {
            background: rgba(0,0,0,0.4);
            padding: 12px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .week-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            color: var(--teal);
        }
        .week-date { color: var(--text-dim); font-size: 12px; }
        .week-matches { padding: 12px; }
        .schedule-match {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-bottom: 8px;
            gap: 12px;
        }
        .schedule-match:last-child { margin-bottom: 0; }
        .schedule-match.clickable:hover {
            background: rgba(255, 70, 154, 0.15);
            transform: translateX(2px);
            transition: all 0.2s;
        }
        .match-details-hint {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 11px;
            color: var(--pink);
            margin-top: 6px;
            opacity: 0.7;
        }
        .schedule-match.clickable:hover .match-details-hint {
            opacity: 1;
        }
        .schedule-team { font-weight: 600; font-size: 14px; }
        .schedule-team.home { text-align: right; }
        .schedule-team.away { text-align: left; }
        .schedule-vs {
            font-family: 'Bebas Neue', cursive;
            color: var(--text-dim);
        }
        .schedule-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--yellow);
        }

        /* Standings Table */
        .standings-section {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 12px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .standings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .standings-table th {
            background: rgba(0,0,0,0.4);
            padding: 12px 10px;
            text-align: left;
            font-family: 'Bebas Neue', cursive;
            font-size: 13px;
            letter-spacing: 1px;
            color: var(--text-dim);
            border-bottom: 2px solid rgba(255,255,255,0.1);
            white-space: nowrap;
        }
        .standings-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .standings-table tbody tr {
            transition: background 0.15s;
        }
        .standings-table tbody tr.standings-team-row.row-odd {
            background: rgba(0,0,0,0.15);
        }
        .standings-table tbody tr.standings-team-row.row-even {
            background: rgba(0,0,0,0.05);
        }
        .standings-table tbody tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .standings-rank {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--yellow);
            text-align: center;
        }
        .standings-rank.first { color: var(--yellow); }
        .standings-rank.second { color: #c0c0c0; }
        .standings-rank.third { color: #cd7f32; }
        .standings-team {
            font-weight: 700;
            font-size: 15px;
        }
        .standings-record {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .stats-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 12px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .stats-card-header {
            background: rgba(0,0,0,0.4);
            padding: 14px 18px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            color: var(--teal);
            border-bottom: 1px solid var(--border-color);
        }
        .stats-card-body { padding: 15px; }
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            transition: background 0.15s;
        }
        .leaderboard-item:hover { background: rgba(255,255,255,0.05); }
        .leaderboard-item:last-child { margin-bottom: 0; }
        .leaderboard-rank {
            width: 28px;
            height: 28px;
            background: var(--bg-panel);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            border: 2px solid var(--border-color);
        }
        .leaderboard-rank.gold { background: rgba(253, 216, 53, 0.3); color: var(--yellow); border-color: var(--yellow); }
        .leaderboard-rank.silver { background: rgba(192, 192, 192, 0.3); color: #e0e0e0; border-color: #c0c0c0; }
        .leaderboard-rank.bronze { background: rgba(205, 127, 50, 0.3); color: #cd9f6d; border-color: #cd7f32; }
        .leaderboard-name { flex: 1; font-weight: 600; font-size: 14px; }
        .leaderboard-stat {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--teal);
        }

        /* Expandable Standings */
        .standings-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .standings-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
        }

        .standings-toggle:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        .standings-toggle.active {
            background: rgba(145, 215, 235, 0.15);
            border-color: var(--teal);
            color: var(--teal);
        }

        .standings-toggle-icon {
            font-size: 14px;
            transition: transform 0.2s;
        }

        .standings-toggle.active .standings-toggle-icon {
            transform: rotate(180deg);
        }

        /* Level filter buttons */
        .level-filter-group {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .level-filter-btn {
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            color: rgba(255,255,255,0.6);
            transition: all 0.2s;
            font-family: 'JetBrains Mono', monospace;
        }

        .level-filter-btn:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        .level-filter-btn.active {
            background: rgba(145, 215, 235, 0.2);
            border-color: var(--teal);
            color: var(--teal);
        }

        .level-filter-btn.level-a.active {
            background: rgba(255, 0, 0, 0.2);
            border-color: #ff4444;
            color: #ff4444;
        }

        .level-filter-btn.level-b.active {
            background: rgba(255, 165, 0, 0.2);
            border-color: #ffa500;
            color: #ffa500;
        }

        .level-filter-btn.level-c.active {
            background: rgba(0, 128, 0, 0.2);
            border-color: #22c55e;
            color: #22c55e;
        }

        /* Sortable headers */
        .standings-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .standings-table th.sortable:hover {
            color: var(--teal);
        }

        .standings-table th.sorted {
            color: var(--yellow);
        }

        .standings-table th .sort-icon {
            margin-left: 4px;
            font-size: 10px;
            opacity: 0.5;
        }

        .standings-table th.sorted .sort-icon {
            opacity: 1;
        }

        /* Team row with expand toggle */
        .standings-team-row {
            cursor: pointer;
        }

        .standings-team-row:hover {
            background: rgba(255,255,255,0.05);
        }

        .standings-team-row.expanded {
            background: rgba(145, 215, 235, 0.1);
        }

        .team-name-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .team-expand-icon {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            transition: transform 0.2s;
            width: 16px;
        }

        .standings-team-row.expanded .team-expand-icon {
            transform: rotate(90deg);
            color: var(--teal);
        }

        .team-name-link {
            color: inherit;
            text-decoration: none;
            font-weight: 700;
        }

        .team-name-link:hover {
            color: var(--teal);
            text-decoration: underline;
        }

        /* Player rows (nested under team) */
        .standings-player-rows {
            display: none;
        }

        .standings-player-rows.expanded {
            display: table-row-group;
        }

        .standings-player-row {
            background: rgba(0,0,0,0.2);
        }

        .standings-player-row td {
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        .standings-player-row td:first-child {
            padding-left: 44px;
        }

        .player-name-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-name-link {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-weight: 500;
            font-size: 13px;
        }

        .player-name-link:hover {
            color: var(--pink);
            text-decoration: underline;
        }

        .player-level-badge {
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.6);
        }

        .player-level-badge.level-a { background: rgba(255, 70, 154, 0.3); color: var(--pink); }
        .player-level-badge.level-b { background: rgba(253, 216, 53, 0.3); color: var(--yellow); }
        .player-level-badge.level-c { background: rgba(145, 215, 235, 0.3); color: var(--teal); }
        .player-level-badge.level-d { background: rgba(34, 197, 94, 0.3); color: #22c55e; }
        .player-level-badge.level-e { background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.7); }

        .captain-star {
            color: var(--yellow);
            font-size: 12px;
        }

        /* Level grouping view */
        .level-header {
            background: rgba(0,0,0,0.5);
            padding: 12px 16px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 2px;
            border-top: 2px solid rgba(255,255,255,0.1);
        }

        .level-header.level-a { color: var(--pink); border-color: var(--pink); }
        .level-header.level-b { color: var(--yellow); border-color: var(--yellow); }
        .level-header.level-c { color: var(--teal); border-color: var(--teal); }
        .level-header.level-d { color: #22c55e; border-color: #22c55e; }
        .level-header.level-e { color: rgba(255,255,255,0.7); }

        .level-player-row td:first-child {
            padding-left: 16px;
        }

        /* Stats values styling */
        .stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
        }

        .stat-value.wins { color: var(--success); }
        .stat-value.losses { color: var(--danger); }
        .stat-value.mpr { color: var(--teal); }
        .stat-value.avg { color: var(--yellow); }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-dim);
        }
        .empty-state-icon { font-size: 50px; margin-bottom: 12px; }

        /* ===== STATS TAB STYLES ===== */
        .stats-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
            align-items: center;
        }

        .stats-view-toggle {
            display: flex;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            overflow: hidden;
        }

        .stats-view-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .stats-view-btn:hover {
            color: var(--teal);
            background: rgba(145, 215, 235, 0.1);
        }

        .stats-view-btn.active {
            background: rgba(145, 215, 235, 0.2);
            color: var(--teal);
        }

        .stats-level-filter {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .stats-level-btn {
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 700;
            color: rgba(255,255,255,0.6);
            transition: all 0.2s;
            font-family: 'JetBrains Mono', monospace;
        }

        .stats-level-btn:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        .stats-level-btn.active {
            background: rgba(145, 215, 235, 0.2);
            border-color: var(--teal);
            color: var(--teal);
        }

        .stats-level-btn.level-a.active {
            background: rgba(255, 70, 154, 0.2);
            border-color: var(--pink);
            color: var(--pink);
        }

        .stats-level-btn.level-b.active {
            background: rgba(253, 216, 53, 0.2);
            border-color: var(--yellow);
            color: var(--yellow);
        }

        .stats-level-btn.level-c.active {
            background: rgba(145, 215, 235, 0.2);
            border-color: var(--teal);
            color: var(--teal);
        }

        /* Category tabs - 3 main buttons */
        .stats-category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .stats-category-btn {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Bebas Neue', cursive;
            letter-spacing: 1px;
            text-align: center;
        }

        .stats-category-btn:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        .stats-category-btn.active {
            background: rgba(145, 215, 235, 0.15);
            border-color: var(--teal);
            color: var(--teal);
        }

        /* Page navigation - compact with prominent title */
        .stats-page-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .stats-page-arrow {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            padding: 0;
        }

        .stats-page-arrow:hover:not(:disabled) {
            color: var(--teal);
        }

        .stats-page-arrow:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }

        .stats-page-title-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.3);
            padding: 8px 16px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .stats-page-label {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            color: #fff;
            text-transform: uppercase;
        }

        .stats-page-indicator {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .stats-page-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transition: all 0.2s;
            cursor: pointer;
        }

        .stats-page-dot:hover {
            background: rgba(255,255,255,0.4);
        }

        .stats-page-dot.active {
            background: var(--yellow);
        }

        /* Responsive columns - hide secondary columns on portrait */
        @media (max-width: 600px) and (orientation: portrait) {
            .stats-table .stat-col.hide-portrait {
                display: none;
            }
        }

        /* Show all columns on landscape or wider screens */
        @media (min-width: 601px), (orientation: landscape) {
            .stats-table .stat-col.hide-portrait {
                display: table-cell;
            }
        }

        /* Stats table */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .stats-table th {
            background: rgba(0,0,0,0.4);
            padding: 12px 8px;
            text-align: left;
            font-family: 'Bebas Neue', cursive;
            font-size: 13px;
            letter-spacing: 1px;
            color: #fff;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            white-space: nowrap;
        }

        .stats-table th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .stats-table th.sortable:hover {
            color: var(--teal);
        }

        .stats-table th.sorted {
            color: var(--yellow);
        }

        .stats-table td {
            padding: 10px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .stats-table tbody tr:nth-child(odd) {
            background: rgba(0,0,0,0.15);
        }

        .stats-table tbody tr:nth-child(even) {
            background: rgba(0,0,0,0.05);
        }

        .stats-table tbody tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .stats-table .rank-col {
            width: 40px;
            text-align: center;
            color: var(--text-dim);
            font-weight: 600;
        }

        .stats-table .name-col {
            min-width: 140px;
        }

        .stats-table .stat-col {
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .stats-table .primary-stat {
            color: var(--yellow);
            font-weight: 700;
            font-size: 15px;
        }

        .stats-table .secondary-stat {
            color: rgba(255,255,255,0.7);
        }

        .stats-table .highlight-stat {
            color: var(--teal);
        }

        .stats-table .team-header-row {
            background: rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .stats-table .team-header-row:hover {
            background: rgba(0,0,0,0.4);
        }

        .stats-table .team-header-row td {
            padding: 12px 8px;
            font-weight: 600;
        }

        .stats-table .team-expand-icon {
            display: inline-block;
            width: 20px;
            transition: transform 0.2s;
        }

        .stats-table .team-header-row.expanded .team-expand-icon {
            transform: rotate(90deg);
        }

        .stats-table .player-row {
            background: rgba(0,0,0,0.15);
        }

        .stats-table .player-row.hidden {
            display: none;
        }

        .stats-table .player-row td:first-child {
            padding-left: 32px;
        }

        .stats-player-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats-player-link {
            color: rgba(255,255,255,0.85);
            text-decoration: none;
        }

        .stats-player-link:hover {
            color: var(--pink);
            text-decoration: underline;
        }

        .stats-team-link {
            color: #fff;
            text-decoration: none;
            font-weight: 600;
        }

        .stats-team-link:hover {
            color: var(--teal);
        }

        .stats-team-badge {
            font-size: 10px;
            color: var(--text-dim);
            margin-left: 6px;
        }

        .stats-section-header {
            background: rgba(0,0,0,0.5);
            padding: 10px 12px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 2px;
            border-left: 3px solid var(--teal);
            margin-top: 12px;
        }

        .stats-section-header.level-a { border-color: var(--pink); color: var(--pink); }
        .stats-section-header.level-b { border-color: var(--yellow); color: var(--yellow); }
        .stats-section-header.level-c { border-color: var(--teal); color: var(--teal); }

        /* Match Card Styles (from dashboard) */
        .match-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 12px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
            margin-bottom: 12px;
            overflow: hidden;
        }

        .match-card-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 14px 12px;
            background: rgba(0,0,0,0.4);
            border-bottom: 2px solid rgba(0,0,0,0.5);
            gap: 6px;
        }

        .match-card-header.completed {
            grid-template-columns: 1fr auto 1fr;
            background: rgba(0,0,0,0.5);
        }

        .match-team-side {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .match-team-side.left {
            align-items: flex-end;
            text-align: right;
            padding-right: 8px;
        }

        .match-team-side.right {
            align-items: flex-start;
            text-align: left;
            padding-left: 8px;
        }

        .match-team-info-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .match-team-side.left .match-team-info-row {
            justify-content: flex-end;
        }

        .match-team-side.right .match-team-info-row {
            justify-content: flex-start;
        }

        .match-team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 1px;
            color: var(--teal);
        }

        .match-team-record {
            display: inline-block;
            font-size: 8px;
            color: #555;
            font-weight: 500;
            background: transparent;
            padding: 0;
            vertical-align: middle;
        }

        .match-team-standing {
            font-size: 11px;
            color: var(--yellow);
            font-weight: 700;
            margin: 0 2px;
        }

        .match-team-avg {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .match-team-side.left .match-team-avg {
            text-align: right;
        }

        .match-team-side.right .match-team-avg {
            text-align: left;
        }

        .match-team-avg .better { color: #4ade80; }
        .match-team-avg .worse { color: #f87171; }

        .match-header-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 42px;
            color: var(--text-primary);
            line-height: 1;
            min-width: 30px;
            text-align: center;
        }

        .match-header-score.winner {
            color: var(--yellow);
        }

        .match-team-side.winner .match-team-name {
            color: var(--yellow);
        }

        .winner-star-slot {
            display: grid;
            place-items: center;
            height: 100%;
            width: 100%;
        }

        .winner-star {
            color: #FFD700;
            font-size: 20px;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
            line-height: 1;
        }

        @keyframes star-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.9; }
        }

        .match-center {
            text-align: center;
            padding: 0 15px;
        }

        .match-week {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        .match-vs {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--pink);
            line-height: 1;
        }

        .match-card-body {
            display: block;
            padding: 8px 10px;
        }

        .match-roster {
            padding: 8px;
        }

        .match-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .match-row:last-child {
            border-bottom: none;
        }

        .match-player-cell {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            font-size: 12px;
            width: 100%;
            gap: 8px;
        }

        /* Left cell: Stats on outer (left) edge, name toward center (right) */
        .match-player-cell.left {
            flex-direction: row;
            justify-content: space-between;
            border-right: 1px solid rgba(255,255,255,0.08);
        }

        .match-player-cell.left .match-player-stats {
            flex-shrink: 0;
            min-width: 60px;
            text-align: left;
        }

        .match-player-cell.left .match-player-name {
            text-align: right;
        }

        /* Right cell: Name toward center (left), stats on outer (right) edge */
        .match-player-cell.right {
            flex-direction: row;
            justify-content: space-between;
        }

        .match-player-cell.right .match-player-name {
            text-align: left;
        }

        .match-player-cell.right .match-player-stats {
            flex-shrink: 0;
            min-width: 60px;
            text-align: right;
        }

        .match-player-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .match-player-name.captain::before {
            content: ' ';
            color: var(--yellow);
        }

        .match-player-stats {
            color: var(--text-dim);
            font-size: 10px;
            text-align: right;
        }

        .match-player-stats .better { color: #4ade80; }
        .match-player-stats .worse { color: #f87171; }

        .fill-in-badge {
            display: inline-block;
            background: var(--teal);
            color: var(--black);
            font-size: 8px;
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 3px;
            vertical-align: middle;
            margin: 0 2px;
        }

        .out-badge {
            display: inline-block;
            background: #666;
            color: #fff;
            font-size: 8px;
            font-weight: 700;
            padding: 1px 4px;
            border-radius: 3px;
            vertical-align: middle;
            margin: 0 2px;
        }

        .match-row.out-row {
            opacity: 0.5;
        }

        .out-stats { color: #666; }
        .match-player-name.out { color: #666; }

        .match-card-footer {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 10px 14px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .match-card-footer > *:first-child {
            justify-self: start;
        }

        .match-card-footer > *:last-child {
            justify-self: end;
        }

        .match-card-link {
            display: inline-block;
            padding: 8px 20px;
            background: var(--teal);
            color: #000;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 6px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.15s;
        }

        .match-card-link:hover {
            background: var(--yellow);
            transform: translateY(-1px);
        }

        .matches-loading {
            text-align: center;
            padding: 30px;
            color: var(--text-dim);
            font-size: 13px;
        }

        /* Skeleton Loading States */
        .skeleton {
            background: linear-gradient(90deg, #1e2a47 25%, #2a3a57 50%, #1e2a47 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }
        .skeleton-header-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.3);
        }
        .skeleton-league-top {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .skeleton-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .skeleton-league-info {
            flex: 1;
        }
        .skeleton-league-name {
            height: 28px;
            width: 70%;
            margin-bottom: 8px;
        }
        .skeleton-league-season {
            height: 14px;
            width: 50%;
        }
        .skeleton-stats-row {
            display: flex;
            gap: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .skeleton-stat {
            height: 22px;
            width: 60px;
        }
        .skeleton-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .skeleton-title {
            height: 24px;
            width: 60%;
        }
        .skeleton-badge {
            height: 20px;
            width: 60px;
            border-radius: 10px;
        }
        .skeleton-score {
            height: 40px;
            width: 80px;
            margin: 0 auto;
        }
        .skeleton-roster {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .skeleton-player {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .skeleton-level {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        .skeleton-name {
            height: 14px;
            width: 120px;
        }
        .skeleton-stats {
            height: 12px;
            width: 60px;
            margin-left: auto;
        }
        .skeleton-table {
            width: 100%;
        }
        .skeleton-table-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .skeleton-rank {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }
        .skeleton-team-name {
            height: 18px;
            width: 150px;
        }
        .skeleton-record {
            height: 14px;
            width: 50px;
            margin-left: auto;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .info-grid { grid-template-columns: 1fr; }
            .modal-content { max-width: 95vw; margin: 10px; }
            .tab-btn { padding: 10px 12px; font-size: 12px; }
            .match-card-header { gap: 8px; }
            .match-team-name { font-size: 18px; }
            .match-header-score { font-size: 32px; }
            .standings-table th, .standings-table td { padding: 8px 6px; font-size: 12px; }
        }

        @media (max-width: 480px) {
            .container { padding: 0 10px; }
            .match-card { padding: 12px; }
            .league-body { padding: 15px; }
            .info-item { padding: 10px; }
            .info-value { font-size: 14px; }
            .tab-btn { padding: 8px 10px; font-size: 11px; letter-spacing: 0.5px; }
            .match-team-name { font-size: 16px; }
            .match-header-score { font-size: 28px; }
            .match-team-standing, .match-team-record { font-size: 8px; padding: 2px 4px; }
            .match-center-info { font-size: 10px; }
            .match-player-name { font-size: 11px; }
            .match-player-stats { font-size: 9px; min-width: 50px; }
            .match-player-cell { padding: 6px 8px; gap: 6px; }
            .match-team-avg { font-size: 10px; }
            /* League header adjustments */
            .league-header-card { padding: 12px; margin-bottom: 12px; }
            .league-header-top { gap: 10px; }
            .league-name { font-size: 22px; }
            .league-icon { width: 44px; height: 44px; font-size: 20px; }
            .league-status-badge { padding: 4px 10px; font-size: 10px; }
            .league-stats-row { gap: 10px; flex-wrap: wrap; }
            .league-stat-value { font-size: 18px; }
            .league-stat-label { font-size: 10px; }
            /* Schedule filters */
            .schedule-filters { flex-direction: column; gap: 8px; }
            .filter-select { width: 100%; }
            /* Modal body */
            .modal-body { padding: 15px; }
            .modal-header { padding: 15px; }
            .modal-title { font-size: 22px; }
        }

        @media (max-width: 360px) {
            .league-name { font-size: 18px; }
            .league-icon { width: 38px; height: 38px; font-size: 18px; }
            .match-team-name { font-size: 14px; }
            .match-header-score { font-size: 24px; min-width: 20px; }
            .info-grid { grid-template-columns: 1fr; }
            .tab-btn { padding: 6px 8px; font-size: 10px; }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <button class="back-btn" onclick="history.back()">BACK</button>
        <img src="/images/gold_logo.png" alt="BRDC" class="header-logo">
        <span class="header-title">LEAGUE</span>
        <div style="margin-left: auto;">
            <button class="back-btn" onclick="showDirectorLogin()" style="border-color: var(--yellow); color: var(--yellow);">DIRECTOR LOGIN</button>
        </div>
    </div>

    <div class="container" id="mainContent">
        <!-- Skeleton loading state -->
        <div id="leagueSkeletonLoader">
            <!-- League Header Skeleton -->
            <div class="skeleton-header-card">
                <div class="skeleton-league-top">
                    <div class="skeleton skeleton-icon"></div>
                    <div class="skeleton-league-info">
                        <div class="skeleton skeleton-league-name"></div>
                        <div class="skeleton skeleton-league-season"></div>
                    </div>
                    <div class="skeleton skeleton-badge" style="width: 80px;"></div>
                </div>
                <div class="skeleton-stats-row">
                    <div class="skeleton skeleton-stat"></div>
                    <div class="skeleton skeleton-stat"></div>
                    <div class="skeleton skeleton-stat"></div>
                    <div class="skeleton skeleton-stat"></div>
                </div>
            </div>
            <!-- Tabs Skeleton -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <div class="skeleton" style="height: 36px; width: 90px;"></div>
                <div class="skeleton" style="height: 36px; width: 90px;"></div>
                <div class="skeleton" style="height: 36px; width: 70px;"></div>
                <div class="skeleton" style="height: 36px; width: 70px;"></div>
            </div>
            <!-- Match Cards Skeleton -->
            <div class="skeleton-card">
                <div class="skeleton-header">
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-badge"></div>
                </div>
                <div class="skeleton skeleton-score" style="margin-bottom: 12px;"></div>
                <div class="skeleton-roster">
                    <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                    <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                    <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                </div>
            </div>
            <div class="skeleton-card">
                <div class="skeleton-header">
                    <div class="skeleton skeleton-title"></div>
                    <div class="skeleton skeleton-badge"></div>
                </div>
                <div class="skeleton skeleton-score" style="margin-bottom: 12px;"></div>
                <div class="skeleton-roster">
                    <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                    <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                    <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">REGISTER</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Form will be rendered here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { db, doc, getDoc, collection, getDocs, query, where, orderBy, callFunction, uploadImage, showLoading, hideLoading } from '/js/firebase-config.js';

        let selectedFillinPhoto = null;
        let selectedRegPhoto = null;

        const urlParams = new URLSearchParams(window.location.search);
        const leagueId = urlParams.get('league_id') || urlParams.get('id');

        let leagueData = null;
        let registrations = [];
        let teams = [];
        let matches = [];
        let fillins = [];
        let isLoggedIn = !!localStorage.getItem('brdc_session'); // Check if user is logged in
        let memberData = null;

        window.onload = async function() {
            if (!leagueId) {
                showError('Missing league_id in URL');
                return;
            }
            await loadLeagueData();
        };

        function isRegistrationClosed() {
            // Check if registration is closed based on status or date
            if (leagueData.status === 'active' || leagueData.status === 'completed' || leagueData.status === 'playoffs') {
                return true;
            }
            if (leagueData.registration_close_date) {
                const closeDate = new Date(leagueData.registration_close_date);
                return new Date() > closeDate;
            }
            return false;
        }

        async function loadLeagueData() {
            try {
                const leagueDoc = await getDoc(doc(db, 'leagues', leagueId));

                if (!leagueDoc.exists()) {
                    throw new Error('League not found');
                }

                leagueData = { id: leagueId, ...leagueDoc.data() };

                // Load registrations
                try {
                    const regsSnap = await getDocs(collection(db, 'leagues', leagueId, 'registrations'));
                    registrations = regsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                } catch (e) {
                    registrations = [];
                }

                // Load fill-ins (available in all phases)
                try {
                    const fillinsSnap = await getDocs(collection(db, 'leagues', leagueId, 'fillins'));
                    fillins = fillinsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                } catch (e) {
                    fillins = [];
                }

                // If registration is closed, load teams and matches
                if (isRegistrationClosed()) {
                    try {
                        const teamsSnap = await getDocs(collection(db, 'leagues', leagueId, 'teams'));
                        teams = teamsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    } catch (e) {
                        teams = [];
                    }

                    try {
                        const matchesSnap = await getDocs(collection(db, 'leagues', leagueId, 'matches'));
                        matches = matchesSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                    } catch (e) {
                        matches = [];
                    }
                }

                renderPage();

            } catch (error) {
                console.error('Error loading league:', error);
                showError('Failed to load league: ' + error.message);
            }
        }

        function renderPage() {
            const totalSpots = (leagueData.num_teams || 8) * (leagueData.team_size || 3);
            const confirmedCount = registrations.filter(r => r.status === 'confirmed' || r.payment_status === 'paid').length;
            const totalCount = registrations.length;
            const spotsRemaining = totalSpots - totalCount;
            const isFull = spotsRemaining <= 0;
            const isClosed = isRegistrationClosed();

            // Calculate completed matches and current week
            const completedMatches = matches.filter(m => m.status === 'completed').length;
            const totalMatches = matches.length;
            const currentWeek = leagueData.current_week || Math.max(...matches.map(m => m.week || 1).filter(w => matches.some(m => m.week === w && m.status === 'completed')), 1) || 1;

            // Determine status badge
            let statusClass = 'active';
            let statusText = 'ACTIVE';
            if (leagueData.status === 'registration') {
                statusClass = 'registration';
                statusText = 'REGISTRATION';
            } else if (leagueData.status === 'draft') {
                statusClass = 'draft';
                statusText = 'DRAFT';
            } else if (leagueData.status === 'completed') {
                statusClass = 'completed';
                statusText = 'COMPLETED';
            }

            // New league header card for active leagues
            const leagueHeaderCard = `
                <div class="league-header-card">
                    <div class="league-header-top">
                        <div class="league-icon"></div>
                        <div class="league-info">
                            <div class="league-name">${leagueData.league_name || leagueData.name}</div>
                            <div class="league-season">${leagueData.season || ''}  ${leagueData.venue_name || 'TBD'}</div>
                        </div>
                        <span class="league-status-badge ${statusClass}">${statusText}</span>
                    </div>
                    <div class="league-stats-row">
                        <div class="league-stat">
                            <span class="league-stat-value">${currentWeek}</span>
                            <span class="league-stat-label">/ ${leagueData.total_weeks || '18'} WEEKS</span>
                        </div>
                        <div class="league-stat">
                            <span class="league-stat-value">${teams.length}</span>
                            <span class="league-stat-label">TEAMS</span>
                        </div>
                        <div class="league-stat">
                            <span class="league-stat-value">${completedMatches}</span>
                            <span class="league-stat-label">/ ${totalMatches} MATCHES</span>
                        </div>
                    </div>
                    <div class="sub-signup-card" onclick="openSubSignupModal()">
                        <div class="sub-signup-icon"></div>
                        <div class="sub-signup-content">
                            <div class="sub-signup-title">BE A SUB</div>
                            <div class="sub-signup-desc">Get called when teams need a player. No commitment - play when you're available.</div>
                        </div>
                        <div class="sub-signup-arrow"></div>
                    </div>
                </div>
            `;

            // Legacy league header for registration view
            const leagueHeader = `
                <div class="league-card">
                    <div class="league-header">
                        <div class="league-name">${leagueData.league_name || leagueData.name}</div>
                        <div class="league-season">${leagueData.season || ''}</div>
                    </div>
                    <div class="league-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Start Date</div>
                                <div class="info-value">${leagueData.start_date ? new Date(leagueData.start_date).toLocaleDateString() : 'TBD'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Venue</div>
                                <div class="info-value">${leagueData.venue_name || 'TBD'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Format</div>
                                <div class="info-value">${formatGameType(leagueData.game_format)} ${leagueData.team_size || 3}s</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Entry Fee</div>
                                <div class="info-value">${leagueData.entry_fee ? '$' + parseFloat(leagueData.entry_fee).toFixed(2) : 'Free'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (isClosed) {
                // Show active league view with tabs
                const html = `
                    ${leagueHeaderCard}

                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('schedule')">SCHEDULE</div>
                        <div class="tab" onclick="switchTab('standings')">STANDINGS</div>
                        <div class="tab" onclick="switchTab('stats')">STATS</div>
                        <div class="tab" onclick="switchTab('rules')">RULES</div>
                        <div class="tab" onclick="goToMembers()">MEMBERS</div>
                    </div>

                    <div id="scheduleTab" class="tab-content active">
                        ${renderSchedule()}
                    </div>

                    <div id="standingsTab" class="tab-content">
                        <div id="standingsContainer"></div>
                    </div>

                    <div id="statsTab" class="tab-content">
                        <div id="statsContainer"></div>
                    </div>

                    <div id="rulesTab" class="tab-content">
                        ${renderRules()}
                    </div>
                `;
                document.getElementById('mainContent').innerHTML = html;

                // Load match cards after schedule tab is rendered
                loadAllMatchCards();
            } else {
                // Show registration view
                const html = `
                    ${leagueHeader}
                    <div class="league-card" style="margin-top: -10px; border-top: none;">
                        <div class="league-body" style="padding-top: 0;">
                            <div class="spots-display">
                                <div class="spots-count">${totalCount} / ${totalSpots}</div>
                                <div class="spots-label">${isFull ? 'WAITLIST OPEN' : `${spotsRemaining} SPOTS REMAINING`}</div>
                            </div>

                            <button class="register-btn" onclick="openModal()">
                                ${isFull ? 'JOIN WAITLIST' : 'REGISTER NOW'}
                            </button>
                        </div>
                    </div>

                    <div class="signups-section">
                        <div class="signups-header">
                            <span class="signups-title">CURRENT SIGN-UPS</span>
                            <span class="signups-count">${totalCount}</span>
                        </div>
                        <div class="signups-body">
                            ${isLoggedIn ? renderSignupsList() : `
                                <div class="login-prompt">
                                    <p style="margin-bottom: 15px;">Sign in to view registered players</p>
                                    <p style="font-size: 24px; font-weight: 700;">${totalCount} players registered</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                document.getElementById('mainContent').innerHTML = html;
            }
        }

        // Schedule state
        let selectedWeek = null; // null means "auto-select on first render"
        let selectedTeamFilter = 'all';

        function renderSchedule() {
            if (matches.length === 0) {
                return `<div class="empty-state">
                    <div class="empty-state-icon"></div>
                    <div>Schedule not generated yet</div>
                </div>`;
            }

            // Group matches by week
            const weeks = {};
            matches.forEach(m => {
                const week = m.week || 1;
                if (!weeks[week]) weeks[week] = [];
                weeks[week].push(m);
            });

            // Calculate total weeks and find current/most recent week
            const totalWeeks = Math.max(...Object.keys(weeks).map(Number));

            // Find first upcoming week (has scheduled matches) or most recent completed
            let upcomingWeek = null;
            let lastCompletedWeek = 1;
            Object.keys(weeks).sort((a, b) => a - b).forEach(w => {
                const weekMatches = weeks[w];
                const hasScheduled = weekMatches.some(m => m.status === 'scheduled');
                const hasCompleted = weekMatches.some(m => m.status === 'completed');

                if (hasCompleted) {
                    lastCompletedWeek = parseInt(w);
                }
                if (hasScheduled && upcomingWeek === null) {
                    upcomingWeek = parseInt(w);
                }
            });

            // Default to upcoming week, or last completed if no upcoming
            const currentWeek = upcomingWeek || lastCompletedWeek;

            // Set initial selected week only on first render (when null)
            if (selectedWeek === null) {
                selectedWeek = currentWeek;
            }

            // Build week selector with dates
            const weekOptions = Object.keys(weeks).sort((a, b) => a - b).map(w => {
                const firstMatch = weeks[w][0];
                const rawDate = firstMatch?.match_date || firstMatch?.date || '';
                // Format date without year (e.g., "Jan 14" from "2026-01-14")
                let dateStr = '';
                if (rawDate) {
                    const d = new Date(rawDate + 'T00:00:00'); // Add time to avoid timezone issues
                    if (!isNaN(d.getTime())) {
                        dateStr = ` - ${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                    }
                }
                return `<option value="${w}" ${parseInt(w) === selectedWeek ? 'selected' : ''}>Week ${w}${dateStr}</option>`;
            }).join('');

            // Build team selector
            const teamOptions = teams.map(t =>
                `<option value="${t.id}" ${t.id === selectedTeamFilter ? 'selected' : ''}>${getTeamName(t)}</option>`
            ).join('');

            // Get week date
            const weekMatches = weeks[selectedWeek] || [];
            const weekDate = weekMatches[0]?.match_date || '';

            const filtersHtml = `
                <div class="schedule-filters">
                    <div class="filter-group">
                        <label class="filter-label">WEEK</label>
                        <select class="filter-select" id="weekSelector" onchange="changeWeek(this.value)">
                            ${weekOptions}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">TEAM</label>
                        <select class="filter-select" id="teamSelector" onchange="changeTeamFilter(this.value)">
                            <option value="all" ${selectedTeamFilter === 'all' ? 'selected' : ''}>All Teams</option>
                            ${teamOptions}
                        </select>
                    </div>
                </div>
            `;

            // Filter by team if selected
            const filteredMatches = selectedTeamFilter === 'all'
                ? weekMatches
                : weekMatches.filter(m => m.home_team_id === selectedTeamFilter || m.away_team_id === selectedTeamFilter);

            const weekHtml = `
                <div class="week-card" id="weekCard${selectedWeek}">
                    <div class="week-header">
                        <span class="week-title">WEEK ${selectedWeek} OF ${totalWeeks}</span>
                        <span class="week-date">${weekDate}</span>
                    </div>
                    <div class="week-matches" id="weekMatches">
                        ${filteredMatches.length === 0
                            ? `<div style="padding: 20px; text-align: center; color: var(--text-dim);">No matches for selected filter</div>`
                            : filteredMatches.map((m, idx) => {
                                return `<div class="match-card" id="matchCard${idx}" data-match-id="${m.id}" data-week="${selectedWeek}" data-total-weeks="${totalWeeks}">
                                    <div class="skeleton-header" style="padding: 14px;">
                                        <div class="skeleton skeleton-title" style="width: 40%;"></div>
                                        <div class="skeleton skeleton-badge"></div>
                                        <div class="skeleton skeleton-title" style="width: 40%;"></div>
                                    </div>
                                    <div class="skeleton skeleton-score" style="margin: 12px auto;"></div>
                                    <div class="skeleton-roster" style="padding: 0 14px 14px;">
                                        <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                                        <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                                        <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                                    </div>
                                </div>`;
                            }).join('')}
                    </div>
                </div>
            `;

            return filtersHtml + weekHtml;
        }

        window.changeWeek = function(week) {
            selectedWeek = parseInt(week);
            reloadScheduleView();
        };

        window.changeTeamFilter = function(teamId) {
            selectedTeamFilter = teamId;
            reloadScheduleView();
        };

        function reloadScheduleView() {
            const scheduleTab = document.getElementById('scheduleTab');
            if (scheduleTab) {
                scheduleTab.innerHTML = renderSchedule();
                loadAllMatchCards();
            }
        }

        // Load match cards for current week view
        async function loadAllMatchCards() {
            // Group matches by week
            const weeks = {};
            matches.forEach(m => {
                const week = m.week || 1;
                if (!weeks[week]) weeks[week] = [];
                weeks[week].push(m);
            });

            // Get matches for selected week
            const weekMatches = weeks[selectedWeek] || [];

            // Filter by team if selected
            const filteredMatches = selectedTeamFilter === 'all'
                ? weekMatches
                : weekMatches.filter(m => m.home_team_id === selectedTeamFilter || m.away_team_id === selectedTeamFilter);

            // Load each match card
            for (let idx = 0; idx < filteredMatches.length; idx++) {
                await loadLeagueMatchCard(idx, filteredMatches[idx]);
            }
        }

        // Load a single match card for the league schedule view
        async function loadLeagueMatchCard(idx, match) {
            const cardEl = document.getElementById(`matchCard${idx}`);
            if (!cardEl) return;

            const matchId = match.id;
            const week = match.week || 1;
            const totalWeeks = parseInt(cardEl.dataset.totalWeeks) || 18;

            try {
                const homeTeamId = match.home_team_id;
                const awayTeamId = match.away_team_id;
                const matchStatus = match.status || 'scheduled';
                const homeScore = match.home_score || 0;
                const awayScore = match.away_score || 0;
                const homeLineup = match.home_lineup || [];
                const awayLineup = match.away_lineup || [];

                if (!homeTeamId || !awayTeamId) {
                    cardEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim);">Match info not available</div>';
                    return;
                }

                // Find teams from loaded teams array
                const homeTeam = teams.find(t => t.id === homeTeamId) || {};
                const awayTeam = teams.find(t => t.id === awayTeamId) || {};

                // Calculate team records from all matches
                const teamRecords = {};
                teams.forEach(t => {
                    teamRecords[t.id] = { wins: 0, losses: 0, ties: 0, gamesWon: 0, gamesLost: 0 };
                });

                matches.forEach(m => {
                    if (m.status !== 'completed') return;
                    if (!teamRecords[m.home_team_id]) teamRecords[m.home_team_id] = { wins: 0, losses: 0, ties: 0, gamesWon: 0, gamesLost: 0 };
                    if (!teamRecords[m.away_team_id]) teamRecords[m.away_team_id] = { wins: 0, losses: 0, ties: 0, gamesWon: 0, gamesLost: 0 };

                    if (m.home_score > m.away_score) {
                        teamRecords[m.home_team_id].wins++;
                        teamRecords[m.away_team_id].losses++;
                    } else if (m.away_score > m.home_score) {
                        teamRecords[m.away_team_id].wins++;
                        teamRecords[m.home_team_id].losses++;
                    } else {
                        teamRecords[m.home_team_id].ties++;
                        teamRecords[m.away_team_id].ties++;
                    }

                    teamRecords[m.home_team_id].gamesWon += m.home_score || 0;
                    teamRecords[m.home_team_id].gamesLost += m.away_score || 0;
                    teamRecords[m.away_team_id].gamesWon += m.away_score || 0;
                    teamRecords[m.away_team_id].gamesLost += m.home_score || 0;
                });

                const homeRec = teamRecords[homeTeamId] || { wins: 0, losses: 0, ties: 0 };
                const awayRec = teamRecords[awayTeamId] || { wins: 0, losses: 0, ties: 0 };
                const homeRecord = getTeamRecord(homeRec);
                const awayRecord = getTeamRecord(awayRec);

                // Calculate standings
                const teamsWithRecords = Object.entries(teamRecords).map(([id, rec]) => {
                    const totalGames = rec.gamesWon + rec.gamesLost;
                    const gamePct = totalGames > 0 ? rec.gamesWon / totalGames : 0;
                    return { id, wins: rec.wins, losses: rec.losses, gamePct };
                }).sort((a, b) => {
                    if (b.wins !== a.wins) return b.wins - a.wins;
                    if (a.losses !== b.losses) return a.losses - b.losses;
                    return b.gamePct - a.gamePct;
                });
                const homeStanding = teamsWithRecords.findIndex(t => t.id === homeTeamId) + 1;
                const awayStanding = teamsWithRecords.findIndex(t => t.id === awayTeamId) + 1;

                // Get players for each team
                const allPlayersSnap = await getDocs(collection(db, 'leagues', leagueId, 'players'));
                const allPlayersById = {};
                const homeRoster = [];
                const awayRoster = [];

                allPlayersSnap.forEach(d => {
                    const player = { id: d.id, ...d.data() };
                    allPlayersById[d.id] = player;
                    if (player.team_id === homeTeamId) homeRoster.push(player);
                    else if (player.team_id === awayTeamId) awayRoster.push(player);
                });

                homeRoster.sort((a, b) => (a.position || 99) - (b.position || 99));
                awayRoster.sort((a, b) => (a.position || 99) - (b.position || 99));

                // Build display roster with fill-ins
                const homeDisplayRoster = [...homeRoster];
                const awayDisplayRoster = [...awayRoster];
                const homeOutPlayers = [];
                const awayOutPlayers = [];

                if (matchStatus === 'completed') {
                    // Process home lineup for fill-ins
                    homeLineup.forEach(lineupEntry => {
                        if (lineupEntry.is_sub && lineupEntry.player_id && lineupEntry.replacing_player_id) {
                            const fillInPlayer = allPlayersById[lineupEntry.player_id];
                            if (fillInPlayer) {
                                const replacingIdx = homeDisplayRoster.findIndex(p => p.id === lineupEntry.replacing_player_id);
                                if (replacingIdx !== -1) {
                                    const outPlayer = homeDisplayRoster[replacingIdx];
                                    homeOutPlayers.push({ ...outPlayer, isOut: true });
                                    homeDisplayRoster[replacingIdx] = {
                                        ...fillInPlayer,
                                        isFillIn: true,
                                        position: outPlayer.position
                                    };
                                }
                            }
                        }
                    });

                    // Process away lineup for fill-ins
                    awayLineup.forEach(lineupEntry => {
                        if (lineupEntry.is_sub && lineupEntry.player_id && lineupEntry.replacing_player_id) {
                            const fillInPlayer = allPlayersById[lineupEntry.player_id];
                            if (fillInPlayer) {
                                const replacingIdx = awayDisplayRoster.findIndex(p => p.id === lineupEntry.replacing_player_id);
                                if (replacingIdx !== -1) {
                                    const outPlayer = awayDisplayRoster[replacingIdx];
                                    awayOutPlayers.push({ ...outPlayer, isOut: true });
                                    awayDisplayRoster[replacingIdx] = {
                                        ...fillInPlayer,
                                        isFillIn: true,
                                        position: outPlayer.position
                                    };
                                }
                            }
                        }
                    });

                    homeDisplayRoster.sort((a, b) => (a.position || 99) - (b.position || 99));
                    awayDisplayRoster.sort((a, b) => (a.position || 99) - (b.position || 99));
                }

                // Fetch player stats
                const playerStats = {};
                const playerIds = [...homeDisplayRoster.map(p => p.id), ...awayDisplayRoster.map(p => p.id)].filter(Boolean);

                await Promise.all(playerIds.map(async (playerId) => {
                    try {
                        const statsDoc = await getDoc(doc(db, 'leagues', leagueId, 'stats', playerId));
                        if (statsDoc.exists()) {
                            playerStats[playerId] = statsDoc.data();
                        }
                    } catch (e) {
                        console.log('Error fetching stats for', playerId, e);
                    }
                }));

                // Calculate team averages
                const calcTeam3DA = (roster) => {
                    const avgs = roster.map(p => get3DA(playerStats[p.id] || {}) || 0).filter(v => v > 0);
                    if (avgs.length === 0) return null;
                    return avgs.reduce((a, b) => a + b, 0) / avgs.length;
                };
                const calcTeamMPR = (roster) => {
                    const mprs = roster.map(p => getMPR(playerStats[p.id] || {}) || 0).filter(v => v > 0);
                    if (mprs.length === 0) return null;
                    return mprs.reduce((a, b) => a + b, 0) / mprs.length;
                };

                const homeTeam3DA = calcTeam3DA(homeDisplayRoster);
                const awayTeam3DA = calcTeam3DA(awayDisplayRoster);
                const homeTeamMPR = calcTeamMPR(homeDisplayRoster);
                const awayTeamMPR = calcTeamMPR(awayDisplayRoster);

                // Determine winner for completed matches
                const isCompleted = matchStatus === 'completed';
                const homeWon = isCompleted && homeScore > awayScore;
                const awayWon = isCompleted && awayScore > homeScore;

                // Compare stat values
                const compareValues = (leftVal, rightVal) => {
                    if (!leftVal || !rightVal) return { left: '', right: '' };
                    if (Math.abs(leftVal - rightVal) < 0.1) return { left: '', right: '' };
                    return leftVal > rightVal ? { left: 'better', right: 'worse' } : { left: 'worse', right: 'better' };
                };

                const team3DACompare = compareValues(homeTeam3DA, awayTeam3DA);
                const teamMPRCompare = compareValues(homeTeamMPR, awayTeamMPR);

                // Format team averages
                const home3DADisplay = homeTeam3DA ? homeTeam3DA.toFixed(1) : '-';
                const away3DADisplay = awayTeam3DA ? awayTeam3DA.toFixed(1) : '-';
                const homeMPRDisplay = homeTeamMPR ? homeTeamMPR.toFixed(2) : '-';
                const awayMPRDisplay = awayTeamMPR ? awayTeamMPR.toFixed(2) : '-';

                const buildTeamAvgHtml = (da, mpr, daClass, mprClass) => {
                    if (!da || da === '-') return '';
                    return `<div class="match-team-avg"><span class="${daClass}">${da}</span> / <span class="${mprClass}">${mpr}</span></div>`;
                };

                // Build roster rows
                const maxPlayers = Math.max(homeDisplayRoster.length, awayDisplayRoster.length, 3);
                let rosterRows = '';

                for (let i = 0; i < maxPlayers; i++) {
                    const homePlayer = homeDisplayRoster[i];
                    const awayPlayer = awayDisplayRoster[i];

                    const homeName = homePlayer ? getPlayerName(homePlayer) : '';
                    const awayName = awayPlayer ? getPlayerName(awayPlayer) : '';
                    const homePlayerStats = homePlayer ? playerStats[homePlayer.id] || {} : {};
                    const awayPlayerStats = awayPlayer ? playerStats[awayPlayer.id] || {} : {};
                    const homeCaptain = homePlayer && (homePlayer.is_captain || homePlayer.position === 1);
                    const awayCaptain = awayPlayer && (awayPlayer.is_captain || awayPlayer.position === 1);
                    const homeFillIn = homePlayer && homePlayer.isFillIn;
                    const awayFillIn = awayPlayer && awayPlayer.isFillIn;

                    const home3DA = get3DA(homePlayerStats);
                    const away3DA = get3DA(awayPlayerStats);
                    const homeMPR = getMPR(homePlayerStats);
                    const awayMPR = getMPR(awayPlayerStats);

                    const daCompare = (homePlayer && awayPlayer) ? compareValues(home3DA, away3DA) : { left: '', right: '' };
                    const mprCompare = (homePlayer && awayPlayer) ? compareValues(homeMPR, awayMPR) : { left: '', right: '' };

                    const home3DAStr = home3DA != null ? home3DA.toFixed(1) : '-';
                    const homeMPRStr = homeMPR != null ? homeMPR.toFixed(2) : '-';
                    const away3DAStr = away3DA != null ? away3DA.toFixed(1) : '-';
                    const awayMPRStr = awayMPR != null ? awayMPR.toFixed(2) : '-';

                    const homeNameClass = `match-player-name${homeCaptain ? ' captain' : ''}${homeFillIn ? ' fill-in' : ''}`;
                    const awayNameClass = `match-player-name${awayCaptain ? ' captain' : ''}${awayFillIn ? ' fill-in' : ''}`;

                    rosterRows += `
                        <div class="match-row">
                            <div class="match-player-cell left">
                                <span class="match-player-stats"><span class="${daCompare.left}">${home3DAStr}</span> / <span class="${mprCompare.left}">${homeMPRStr}</span></span>
                                <span class="${homeNameClass}">${homeFillIn ? '<span class="fill-in-badge">SUB</span> ' : ''}${homeName}</span>
                            </div>
                            <div class="match-player-cell right">
                                <span class="${awayNameClass}">${awayName}${awayFillIn ? ' <span class="fill-in-badge">SUB</span>' : ''}</span>
                                <span class="match-player-stats"><span class="${daCompare.right}">${away3DAStr}</span> / <span class="${mprCompare.right}">${awayMPRStr}</span></span>
                            </div>
                        </div>`;
                }

                // Add OUT player rows
                const maxOutPlayers = Math.max(homeOutPlayers.length, awayOutPlayers.length);
                for (let i = 0; i < maxOutPlayers; i++) {
                    const homeOutPlayer = homeOutPlayers[i];
                    const awayOutPlayer = awayOutPlayers[i];

                    const homeOutName = homeOutPlayer ? getPlayerName(homeOutPlayer) : '';
                    const awayOutName = awayOutPlayer ? getPlayerName(awayOutPlayer) : '';
                    const homeOutStats = homeOutPlayer ? playerStats[homeOutPlayer.id] || {} : {};
                    const awayOutStats = awayOutPlayer ? playerStats[awayOutPlayer.id] || {} : {};

                    const homeOut3DA = homeOutPlayer ? get3DA(homeOutStats) : null;
                    const homeOutMPR = homeOutPlayer ? getMPR(homeOutStats) : null;
                    const awayOut3DA = awayOutPlayer ? get3DA(awayOutStats) : null;
                    const awayOutMPR = awayOutPlayer ? getMPR(awayOutStats) : null;

                    const homeOut3DAStr = homeOut3DA != null ? homeOut3DA.toFixed(1) : '-.-';
                    const homeOutMPRStr = homeOutMPR != null ? homeOutMPR.toFixed(2) : '-.--';
                    const awayOut3DAStr = awayOutPlayer ? (awayOut3DA != null ? awayOut3DA.toFixed(1) : '-.-') : '-.-';
                    const awayOutMPRStr = awayOutPlayer ? (awayOutMPR != null ? awayOutMPR.toFixed(2) : '-.--') : '-.--';

                    rosterRows += `
                        <div class="match-row out-row">
                            <div class="match-player-cell left">
                                <span class="match-player-stats out-stats">${homeOutPlayer ? homeOut3DAStr : '-.-'} / ${homeOutPlayer ? homeOutMPRStr : '-.--'}</span>
                                <span class="match-player-name out">${homeOutPlayer ? '<span class="out-badge">OUT</span> ' : ''}${homeOutName}</span>
                            </div>
                            <div class="match-player-cell right">
                                <span class="match-player-name out">${awayOutName}${awayOutPlayer ? ' <span class="out-badge">OUT</span>' : ''}</span>
                                <span class="match-player-stats out-stats">${awayOutPlayer ? awayOut3DAStr : '-.-'} / ${awayOutPlayer ? awayOutMPRStr : '-.--'}</span>
                            </div>
                        </div>`;
                }

                // Winner star
                const winnerStar = '<span class="winner-star"></span>';

                // Render the card - home team always on left for league view (no user context)
                cardEl.innerHTML = `
                    <div class="match-card-header${isCompleted ? ' completed' : ''}">
                        <div class="match-team-side left${homeWon ? ' winner' : ''}">
                            ${isCompleted && homeWon ? `<span class="winner-star"></span>` : ''}
                            <div class="match-team-info-row"><span class="match-team-name">${getTeamName(homeTeam)}</span>${homeStanding ? `<span class="match-team-standing">${getOrdinal(homeStanding)}</span>` : ''}<span class="match-team-record">${homeRecord}</span></div>
                            ${buildTeamAvgHtml(home3DADisplay, homeMPRDisplay, team3DACompare.left, teamMPRCompare.left)}
                            ${isCompleted ? `<div class="match-header-score${homeWon ? ' winner' : ''}">${homeScore}</div>` : ''}
                        </div>
                        <div class="match-center">
                            <div class="match-week">WEEK ${week}/${totalWeeks}</div>
                            <div class="match-vs">${isCompleted ? 'FINAL' : 'VS'}</div>
                        </div>
                        <div class="match-team-side right${awayWon ? ' winner' : ''}">
                            ${isCompleted ? `<div class="match-header-score${awayWon ? ' winner' : ''}">${awayScore}</div>` : ''}
                            <div class="match-team-info-row"><span class="match-team-record">${awayRecord}</span>${awayStanding ? `<span class="match-team-standing">${getOrdinal(awayStanding)}</span>` : ''}<span class="match-team-name">${getTeamName(awayTeam)}</span></div>
                            ${buildTeamAvgHtml(away3DADisplay, awayMPRDisplay, team3DACompare.right, teamMPRCompare.right)}
                            ${isCompleted && awayWon ? `<span class="winner-star"></span>` : ''}
                        </div>
                    </div>
                    <div class="match-card-body">
                        ${rosterRows}
                    </div>
                    <div class="match-card-footer">
                        <a href="/pages/team-profile.html?league_id=${leagueId}&team_id=${homeTeamId}" class="match-card-link" style="background: rgba(255,255,255,0.1); color: var(--teal);">Team Info</a>
                        ${isCompleted
                            ? `<a href="/pages/match-report.html?league_id=${leagueId}&match_id=${matchId}" class="match-card-link">View Report</a>`
                            : `<a href="/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}" class="match-card-link">Match Hub</a>`
                        }
                        <a href="/pages/team-profile.html?league_id=${leagueId}&team_id=${awayTeamId}" class="match-card-link" style="background: rgba(255,255,255,0.1); color: var(--teal);">Team Info</a>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading match card:', error);
                cardEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">Error loading match</div>';
            }
        }

        // Standings state
        let standingsData = {
            sortColumn: 'rank',
            sortDirection: 'asc',
            expandedTeams: new Set(),
            expandAll: false,
            teamStats: {},
            playerStats: {},
            leaguePlayers: {}  // playerId -> player data with team_id
        };

        // Initialize standings when tab is shown
        async function initStandings() {
            const container = document.getElementById('standingsContainer');
            if (!container) return;

            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><div>Loading standings...</div></div>';

            // Calculate team records
            const teamRecords = {};
            teams.forEach(t => {
                teamRecords[t.id] = { wins: 0, losses: 0, gamesWon: 0, gamesLost: 0 };
            });

            matches.forEach(m => {
                if (m.status !== 'completed') return;
                if (!teamRecords[m.home_team_id]) teamRecords[m.home_team_id] = { wins: 0, losses: 0, gamesWon: 0, gamesLost: 0 };
                if (!teamRecords[m.away_team_id]) teamRecords[m.away_team_id] = { wins: 0, losses: 0, gamesWon: 0, gamesLost: 0 };

                if (m.home_score > m.away_score) {
                    teamRecords[m.home_team_id].wins++;
                    teamRecords[m.away_team_id].losses++;
                } else if (m.away_score > m.home_score) {
                    teamRecords[m.away_team_id].wins++;
                    teamRecords[m.home_team_id].losses++;
                }

                teamRecords[m.home_team_id].gamesWon += m.home_score || 0;
                teamRecords[m.home_team_id].gamesLost += m.away_score || 0;
                teamRecords[m.away_team_id].gamesWon += m.away_score || 0;
                teamRecords[m.away_team_id].gamesLost += m.home_score || 0;
            });

            standingsData.teamStats = teamRecords;

            // Load all league players (for rosters)
            try {
                const playersSnapshot = await getDocs(collection(db, 'leagues', leagueId, 'players'));
                playersSnapshot.forEach(doc => {
                    standingsData.leaguePlayers[doc.id] = { id: doc.id, ...doc.data() };
                });
            } catch (err) {
                console.error('Error loading league players:', err);
            }

            // Load all player stats
            try {
                const statsSnapshot = await getDocs(collection(db, 'leagues', leagueId, 'stats'));
                statsSnapshot.forEach(doc => {
                    standingsData.playerStats[doc.id] = doc.data();
                });
            } catch (err) {
                console.error('Error loading player stats:', err);
            }

            renderStandingsTable();
        }

        function renderStandingsTable() {
            const container = document.getElementById('standingsContainer');
            if (!container) return;

            if (teams.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon"></div>
                    <div>No standings available yet</div>
                </div>`;
                return;
            }

            // Build team data with stats
            const teamsWithStats = teams.map(t => {
                const rec = standingsData.teamStats[t.id] || { wins: 0, losses: 0, gamesWon: 0, gamesLost: 0 };
                const players = getTeamPlayers(t);

                // Calculate team averages from player stats
                let totalMPR = 0, totalAvg = 0, playerCount = 0;
                players.forEach(p => {
                    const stats = standingsData.playerStats[p.id];
                    if (stats) {
                        const mpr = getMPR(stats);
                        const avg = get3DA(stats);
                        if (mpr > 0) totalMPR += mpr;
                        if (avg > 0) totalAvg += avg;
                        if (mpr > 0 || avg > 0) playerCount++;
                    }
                });

                const teamMPR = playerCount > 0 ? totalMPR / playerCount : 0;
                const teamAvg = playerCount > 0 ? totalAvg / playerCount : 0;

                return {
                    ...t,
                    ...rec,
                    mpr: teamMPR,
                    avg: teamAvg,
                    players: players
                };
            });

            // Sort teams
            const sorted = sortTeams(teamsWithStats);

            // Assign ranks
            sorted.forEach((t, i) => t.rank = i + 1);

            // Render team standings
            renderByTeamView(container, sorted);
        }

        function sortTeams(teamsArray) {
            const col = standingsData.sortColumn;
            const dir = standingsData.sortDirection === 'asc' ? 1 : -1;

            return [...teamsArray].sort((a, b) => {
                let aVal, bVal;

                switch (col) {
                    case 'rank':
                    case 'wins':
                        // Default sort: wins desc, losses asc
                        if (b.wins !== a.wins) return (b.wins - a.wins);
                        if (a.losses !== b.losses) return (a.losses - b.losses);
                        return (b.gamesWon - a.gamesWon);
                    case 'losses':
                        aVal = a.losses; bVal = b.losses;
                        break;
                    case 'sets':
                        aVal = a.gamesWon || 0; bVal = b.gamesWon || 0;
                        break;
                    case 'mpr':
                        aVal = a.mpr; bVal = b.mpr;
                        break;
                    case 'avg':
                        aVal = a.avg; bVal = b.avg;
                        break;
                    case 'team':
                        aVal = a.team_name?.toLowerCase() || '';
                        bVal = b.team_name?.toLowerCase() || '';
                        return dir * aVal.localeCompare(bVal);
                    default:
                        return 0;
                }

                return dir * (bVal - aVal);
            });
        }

        function getTeamPlayers(team) {
            // First, try to get players from standingsData.leaguePlayers by team_id
            const playersFromLeague = Object.values(standingsData.leaguePlayers)
                .filter(p => p.team_id === team.id)
                .sort((a, b) => (a.position || 99) - (b.position || 99))
                .map(p => ({
                    id: p.id,
                    name: p.name || 'Unknown',
                    level: p.level || '',
                    isCaptain: team.captain_id === p.id
                }));

            if (playersFromLeague.length > 0) {
                return playersFromLeague;
            }

            // Fallback: check if team has embedded players array
            if (team.players?.length) {
                return team.players.map(p => ({
                    id: p.id,
                    name: p.name || 'Unknown',
                    level: p.level || '',
                    isCaptain: team.captain_id === p.id
                }));
            }

            // Fallback: use player_ids and player_names arrays
            const playerIds = team.player_ids || [];
            const playerNames = team.player_names || [];
            return playerIds.map((id, i) => ({
                id,
                name: playerNames[i] || 'Unknown',
                level: '',
                isCaptain: team.captain_id === id || i === 0
            }));
        }

        function renderByTeamView(container, sortedTeams) {
            const expandAllActive = standingsData.expandAll;

            const headerHtml = `
                <div class="standings-controls">
                    <div class="standings-toggle ${expandAllActive ? 'active' : ''}" onclick="toggleExpandAll()">
                        <span class="standings-toggle-icon">${expandAllActive ? '' : ''}</span>
                        <span>${expandAllActive ? 'Collapse All' : 'Expand All'}</span>
                    </div>
                </div>
            `;

            const getSortIcon = (col) => {
                if (standingsData.sortColumn === col) {
                    return `<span class="sort-icon">${standingsData.sortDirection === 'asc' ? '' : ''}</span>`;
                }
                return '<span class="sort-icon"></span>';
            };

            const tableHtml = `
                <div class="standings-section">
                    <table class="standings-table" id="standingsTable">
                        <thead>
                            <tr>
                                <th style="width: 50px; text-align: center;" class="sortable ${standingsData.sortColumn === 'rank' ? 'sorted' : ''}" onclick="sortStandings('rank')"># ${getSortIcon('rank')}</th>
                                <th class="sortable ${standingsData.sortColumn === 'team' ? 'sorted' : ''}" onclick="sortStandings('team')">Team ${getSortIcon('team')}</th>
                                <th style="width: 50px; text-align: center;" class="sortable ${standingsData.sortColumn === 'wins' ? 'sorted' : ''}" onclick="sortStandings('wins')">W ${getSortIcon('wins')}</th>
                                <th style="width: 50px; text-align: center;" class="sortable ${standingsData.sortColumn === 'losses' ? 'sorted' : ''}" onclick="sortStandings('losses')">L ${getSortIcon('losses')}</th>
                                <th style="width: 60px; text-align: center;" class="sortable ${standingsData.sortColumn === 'sets' ? 'sorted' : ''}" onclick="sortStandings('sets')" title="Total Sets Won (1st Tiebreaker)">Sets ${getSortIcon('sets')}</th>
                                <th style="width: 70px; text-align: center;" class="sortable ${standingsData.sortColumn === 'mpr' ? 'sorted' : ''}" onclick="sortStandings('mpr')">MPR ${getSortIcon('mpr')}</th>
                                <th style="width: 70px; text-align: center;" class="sortable ${standingsData.sortColumn === 'avg' ? 'sorted' : ''}" onclick="sortStandings('avg')">3DA ${getSortIcon('avg')}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedTeams.map((t, idx) => renderTeamRow(t, idx)).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = headerHtml + tableHtml;
        }

        function renderTeamRow(team, idx = 0) {
            const isExpanded = standingsData.expandAll || standingsData.expandedTeams.has(team.id);
            const rankClass = team.rank === 1 ? 'first' : team.rank === 2 ? 'second' : team.rank === 3 ? 'third' : '';
            const rowClass = idx % 2 === 0 ? 'row-even' : 'row-odd';

            const teamRowHtml = `
                <tr class="standings-team-row ${isExpanded ? 'expanded' : ''} ${rowClass}" data-team-id="${team.id}" onclick="toggleTeamExpand('${team.id}', event)">
                    <td class="standings-rank ${rankClass}">${team.rank}</td>
                    <td>
                        <div class="team-name-cell">
                            <span class="team-expand-icon"></span>
                            <a href="/pages/team-profile.html?team_id=${team.id}&league_id=${leagueId}" class="team-name-link" onclick="event.stopPropagation()">${team.team_name}</a>
                        </div>
                    </td>
                    <td class="stat-value wins" style="text-align: center;">${team.wins}</td>
                    <td class="stat-value losses" style="text-align: center;">${team.losses}</td>
                    <td class="stat-value sets" style="text-align: center;">${team.gamesWon || 0}</td>
                    <td class="stat-value mpr" style="text-align: center;">${team.mpr > 0 ? team.mpr.toFixed(2) : '-'}</td>
                    <td class="stat-value avg" style="text-align: center;">${team.avg > 0 ? team.avg.toFixed(1) : '-'}</td>
                </tr>
            `;

            // Player rows
            const playerRowsHtml = `
                <tbody class="standings-player-rows ${isExpanded ? 'expanded' : ''}" data-team-players="${team.id}">
                    ${team.players.map(p => {
                        const stats = standingsData.playerStats[p.id] || {};
                        const mpr = getMPR(stats);
                        const avg = get3DA(stats);
                        const wins = stats.league_wins || stats.wins || 0;
                        const losses = stats.league_losses || stats.losses || 0;
                        const levelClass = p.level ? `level-${p.level.toLowerCase()}` : '';

                        return `
                            <tr class="standings-player-row">
                                <td></td>
                                <td>
                                    <div class="player-name-cell">
                                        ${p.isCaptain ? '<span class="captain-star"></span>' : ''}
                                        <a href="/pages/player-profile.html?id=${p.id}" class="player-name-link" onclick="event.stopPropagation()">${p.name}</a>
                                        ${p.level ? `<span class="player-level-badge ${levelClass}">${p.level}</span>` : ''}
                                    </div>
                                </td>
                                <td class="stat-value wins" style="text-align: center; font-size: 14px;">${wins}</td>
                                <td class="stat-value losses" style="text-align: center; font-size: 14px;">${losses}</td>
                                <td class="stat-value sets" style="text-align: center; font-size: 14px;">-</td>
                                <td class="stat-value mpr" style="text-align: center; font-size: 14px;">${mpr > 0 ? mpr.toFixed(2) : '-'}</td>
                                <td class="stat-value avg" style="text-align: center; font-size: 14px;">${avg > 0 ? avg.toFixed(1) : '-'}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;

            return teamRowHtml + playerRowsHtml;
        }

        window.toggleTeamExpand = function(teamId, event) {
            // Don't toggle if clicking on a link
            if (event.target.tagName === 'A') return;

            if (standingsData.expandedTeams.has(teamId)) {
                standingsData.expandedTeams.delete(teamId);
            } else {
                standingsData.expandedTeams.add(teamId);
            }

            // Update just the affected row without full re-render
            const row = document.querySelector(`tr[data-team-id="${teamId}"]`);
            const playerRows = document.querySelector(`tbody[data-team-players="${teamId}"]`);

            if (row && playerRows) {
                const isExpanded = standingsData.expandedTeams.has(teamId);
                row.classList.toggle('expanded', isExpanded);
                playerRows.classList.toggle('expanded', isExpanded);
            }
        };

        window.toggleExpandAll = function() {
            standingsData.expandAll = !standingsData.expandAll;

            if (standingsData.expandAll) {
                teams.forEach(t => standingsData.expandedTeams.add(t.id));
            } else {
                standingsData.expandedTeams.clear();
            }

            renderStandingsTable();
        };

        window.sortStandings = function(column) {
            if (standingsData.sortColumn === column) {
                standingsData.sortDirection = standingsData.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                standingsData.sortColumn = column;
                standingsData.sortDirection = 'desc'; // Default to descending for stats
            }
            renderStandingsTable();
        };

        window.viewTeam = function(teamId) {
            window.location.href = `/pages/team-profile.html?league_id=${leagueId}&team_id=${teamId}`;
        };

        window.viewPlayer = function(playerId) {
            if (playerId) {
                window.location.href = `/pages/player-profile.html?id=${playerId}`;
            }
        };

        window.viewMatch = function(matchId) {
            window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}`;
        };

        window.goToMembers = function() {
            window.location.href = `/pages/members.html?league_id=${leagueId}`;
        };

        // ===== STATS TAB =====
        let statsData = {
            viewMode: 'players',  // 'teams' or 'players'
            category: 'x01',      // 'x01', 'cricket', 'record'
            pageIndex: 0,         // current page within category
            levelFilter: null,    // null = all, or 'A', 'B', 'C'
            sortColumn: 'primary',
            sortDirection: 'desc',
            expandedTeams: new Set(),
            loaded: false,
            playerStats: {},
            leaguePlayers: {}
        };

        // New structure: 3 categories, each with multiple pages of columns
        const STATS_CATEGORIES = {
            'x01': {
                name: 'X01',
                pages: [
                    {
                        name: 'Averages',
                        columns: [
                            { key: '3da', label: '3DA', primary: true },
                            { key: 'first9', label: 'First 9' },
                            { key: 'legs', label: 'Legs', hidePortrait: true },
                            { key: 'legPct', label: 'Win %', hidePortrait: true }
                        ],
                        sortKey: '3da'
                    },
                    {
                        name: 'Tons',
                        columns: [
                            { key: 'tons', label: 'Tons', primary: true },
                            { key: 't80', label: '180' },
                            { key: 't60', label: '160+', hidePortrait: true },
                            { key: 't40', label: '140+', hidePortrait: true },
                            { key: 'highScore', label: 'High' }
                        ],
                        sortKey: 'tons'
                    },
                    {
                        name: 'Checkouts',
                        columns: [
                            { key: 'coPct', label: 'CO %', primary: true },
                            { key: 'highCo', label: 'High' },
                            { key: 'avgCo', label: 'Avg', hidePortrait: true },
                            { key: 'coHits', label: 'Made', hidePortrait: true },
                            { key: 'coAttempts', label: 'Att', hidePortrait: true }
                        ],
                        sortKey: 'coPct'
                    },
                    {
                        name: 'Adv CO %',
                        columns: [
                            { key: 'co80Pct', label: '80+', primary: true },
                            { key: 'co120Pct', label: '120+' },
                            { key: 'co140Pct', label: '140+' },
                            { key: 'co161Pct', label: '161+', hidePortrait: true }
                        ],
                        sortKey: 'co80Pct'
                    }
                ]
            },
            'cricket': {
                name: 'CRICKET',
                pages: [
                    {
                        name: 'MPR',
                        columns: [
                            { key: 'mpr', label: 'MPR', primary: true },
                            { key: 'highMark', label: 'High Rd' },
                            { key: 'cLegs', label: 'Legs', hidePortrait: true },
                            { key: 'cLegPct', label: 'Win %', hidePortrait: true }
                        ],
                        sortKey: 'mpr'
                    },
                    {
                        name: 'High Marks',
                        columns: [
                            { key: 'mark9', label: '9 Mrk', primary: true },
                            { key: 'mark8', label: '8 Mrk' },
                            { key: 'mark7', label: '7 Mrk', hidePortrait: true },
                            { key: 'mark6', label: '6 Mrk', hidePortrait: true },
                            { key: 'hatTricks', label: 'Hats' }
                        ],
                        sortKey: 'mark9'
                    }
                ]
            },
            'record': {
                name: 'RECORD',
                pages: [
                    {
                        name: 'Overall',
                        columns: [
                            { key: 'totalWins', label: 'Won', primary: true },
                            { key: 'totalLegs', label: 'Played' },
                            { key: 'totalPct', label: 'Win %' },
                            { key: 'withDarts', label: 'w/ Darts', hidePortrait: true },
                            { key: 'againstDarts', label: 'vs Darts', hidePortrait: true }
                        ],
                        sortKey: 'totalWins'
                    },
                    {
                        name: 'X01 Record',
                        columns: [
                            { key: 'legWins', label: 'Won', primary: true },
                            { key: 'legs', label: 'Played' },
                            { key: 'legPct', label: 'Win %' },
                            { key: 'bestLeg', label: 'Best', hidePortrait: true }
                        ],
                        sortKey: 'legWins'
                    },
                    {
                        name: 'Cricket Record',
                        columns: [
                            { key: 'cLegWins', label: 'Won', primary: true },
                            { key: 'cLegs', label: 'Played' },
                            { key: 'cLegPct', label: 'Win %' }
                        ],
                        sortKey: 'cLegWins'
                    }
                ]
            }
        };

        async function initStats() {
            const container = document.getElementById('statsContainer');
            if (!container) return;

            if (!statsData.loaded) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><div>Loading stats...</div></div>';

                // Load players and stats if not already loaded
                try {
                    const playersSnapshot = await getDocs(collection(db, 'leagues', leagueId, 'players'));
                    playersSnapshot.forEach(doc => {
                        statsData.leaguePlayers[doc.id] = { id: doc.id, ...doc.data() };
                    });

                    const statsSnapshot = await getDocs(collection(db, 'leagues', leagueId, 'stats'));
                    statsSnapshot.forEach(doc => {
                        statsData.playerStats[doc.id] = doc.data();
                    });

                    statsData.loaded = true;
                } catch (err) {
                    console.error('Error loading stats:', err);
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><div>Failed to load stats</div></div>';
                    return;
                }
            }

            renderStatsTab();
        }

        function renderStatsTab() {
            const container = document.getElementById('statsContainer');
            if (!container) return;

            const cat = STATS_CATEGORIES[statsData.category];
            const pages = cat.pages;
            const currentPage = pages[statsData.pageIndex] || pages[0];

            // Controls: View toggle + Level filter
            const controlsHtml = `
                <div class="stats-controls">
                    <div class="stats-view-toggle">
                        <button class="stats-view-btn ${statsData.viewMode === 'teams' ? 'active' : ''}" onclick="setStatsView('teams')">TEAMS</button>
                        <button class="stats-view-btn ${statsData.viewMode === 'players' ? 'active' : ''}" onclick="setStatsView('players')">PLAYERS</button>
                    </div>
                    <div class="stats-level-filter">
                        <button class="stats-level-btn ${!statsData.levelFilter ? 'active' : ''}" onclick="setStatsLevel(null)">ALL</button>
                        <button class="stats-level-btn level-a ${statsData.levelFilter === 'A' ? 'active' : ''}" onclick="setStatsLevel('A')">A</button>
                        <button class="stats-level-btn level-b ${statsData.levelFilter === 'B' ? 'active' : ''}" onclick="setStatsLevel('B')">B</button>
                        <button class="stats-level-btn level-c ${statsData.levelFilter === 'C' ? 'active' : ''}" onclick="setStatsLevel('C')">C</button>
                    </div>
                </div>
            `;

            // Category tabs (3 main buttons)
            const categoryHtml = `
                <div class="stats-category-tabs">
                    ${Object.entries(STATS_CATEGORIES).map(([key, c]) => `
                        <button class="stats-category-btn ${statsData.category === key ? 'active' : ''}" onclick="setStatsCategory('${key}')">${c.name}</button>
                    `).join('')}
                </div>
            `;

            // Page navigation (arrows + title box + dots)
            const pageNavHtml = pages.length > 1 ? `
                <div class="stats-page-nav">
                    <button class="stats-page-arrow" onclick="changeStatsPage(-1)" ${statsData.pageIndex === 0 ? 'disabled' : ''}></button>
                    <div class="stats-page-title-box">
                        <span class="stats-page-label">${currentPage.name}</span>
                        <div class="stats-page-indicator">
                            ${pages.map((p, i) => `<div class="stats-page-dot ${i === statsData.pageIndex ? 'active' : ''}" onclick="setStatsPage(${i})"></div>`).join('')}
                        </div>
                    </div>
                    <button class="stats-page-arrow" onclick="changeStatsPage(1)" ${statsData.pageIndex === pages.length - 1 ? 'disabled' : ''}></button>
                </div>
            ` : '';

            // Render appropriate view
            let tableHtml = '';
            if (statsData.viewMode === 'teams') {
                tableHtml = renderStatsTeamView();
            } else {
                tableHtml = renderStatsPlayerView();
            }

            container.innerHTML = controlsHtml + categoryHtml + pageNavHtml + tableHtml;
        }

        function getPlayerStatValues(playerId) {
            const s = statsData.playerStats[playerId] || {};
            const p = statsData.leaguePlayers[playerId] || {};

            // Calculate all possible stat values
            const x01Legs = s.x01_legs_played || 0;
            const x01Darts = s.x01_total_darts || 0;
            const x01Points = s.x01_total_points || 0;
            const cricketLegs = s.cricket_legs_played || 0;
            const cricketRounds = s.cricket_total_rounds || 0;
            const cricketMarks = s.cricket_total_marks || 0;

            // Use pre-calculated values first, then fall back to calculation
            const calc3DA = x01Darts > 0 ? (x01Points / x01Darts) * 3 : 0;
            const calcMPR = cricketRounds > 0 ? cricketMarks / cricketRounds : 0;

            return {
                // Player info
                id: playerId,
                name: p.name || 'Unknown',
                level: p.level || '',
                teamId: p.team_id,

                // X01 stats - use pre-calculated x01_three_dart_avg if available
                '3da': get3DA(s) || calc3DA,
                'first9': s.x01_first9_darts > 0 ? (s.x01_first9_points / s.x01_first9_darts) * 3 : 0,
                'legs': x01Legs,
                'legWins': s.x01_legs_won || 0,
                'legPct': x01Legs > 0 ? ((s.x01_legs_won || 0) / x01Legs) * 100 : 0,
                'tons': s.x01_tons || 0,
                'tonPct': x01Legs > 0 ? ((s.x01_tons || 0) / x01Legs) * 100 : 0,
                't80': s.x01_ton_80 || 0,
                't60': s.x01_ton_60 || 0,
                't40': s.x01_ton_40 || 0,
                't20': s.x01_ton_20 || 0,
                't00': s.x01_ton_00 || 0,
                'highScore': s.x01_high_score || 0,
                'highStraight': s.x01_high_straight_in || 0,
                'bestLeg': s.x01_best_leg && s.x01_best_leg < 900 ? s.x01_best_leg : 0,

                // Checkout stats
                'coPct': s.x01_checkout_attempts > 0 ? ((s.x01_checkouts_hit || 0) / s.x01_checkout_attempts) * 100 : 0,
                'highCo': s.x01_high_checkout || 0,
                'avgCo': s.x01_checkouts_hit > 0 ? (s.x01_total_checkout_points || 0) / s.x01_checkouts_hit : 0,
                'coHits': s.x01_checkouts_hit || 0,
                'coAttempts': s.x01_checkout_attempts || 0,
                // Checkout % by level (80-119, 120-139, 140-160, 161-170)
                'co80Pct': s.x01_co_80_attempts > 0 ? ((s.x01_co_80_hits || 0) / s.x01_co_80_attempts) * 100 : 0,
                'co80Att': s.x01_co_80_attempts || 0,
                'co120Pct': s.x01_co_120_attempts > 0 ? ((s.x01_co_120_hits || 0) / s.x01_co_120_attempts) * 100 : 0,
                'co120Att': s.x01_co_120_attempts || 0,
                'co140Pct': s.x01_co_140_attempts > 0 ? ((s.x01_co_140_hits || 0) / s.x01_co_140_attempts) * 100 : 0,
                'co140Att': s.x01_co_140_attempts || 0,
                'co161Pct': s.x01_co_161_attempts > 0 ? ((s.x01_co_161_hits || 0) / s.x01_co_161_attempts) * 100 : 0,
                'co161Att': s.x01_co_161_attempts || 0,

                // Cricket stats - use pre-calculated cricket_mpr if available
                'mpr': getMPR(s) || calcMPR,
                'cLegs': cricketLegs,
                'cLegWins': s.cricket_legs_won || 0,
                'cLegPct': cricketLegs > 0 ? ((s.cricket_legs_won || 0) / cricketLegs) * 100 : 0,
                'highMark': s.cricket_high_mark_round || 0,
                'mark9': s.cricket_nine_mark_rounds || 0,
                'mark8': s.cricket_eight_mark_rounds || 0,
                'mark7': s.cricket_seven_mark_rounds || 0,
                'mark6': s.cricket_six_mark_rounds || 0,
                'mark5': s.cricket_five_mark_rounds || 0,
                'hatTricks': s.cricket_hat_tricks || 0,

                // Combined leg record
                'totalLegs': x01Legs + cricketLegs,
                'totalWins': (s.x01_legs_won || 0) + (s.cricket_legs_won || 0),
                'totalPct': (x01Legs + cricketLegs) > 0 ? (((s.x01_legs_won || 0) + (s.cricket_legs_won || 0)) / (x01Legs + cricketLegs)) * 100 : 0,
                'withDarts': (s.x01_legs_with_darts || 0) + (s.cricket_legs_with_darts || 0) > 0 ?
                    (((s.x01_legs_with_darts_won || 0) + (s.cricket_legs_with_darts_won || 0)) /
                    ((s.x01_legs_with_darts || 0) + (s.cricket_legs_with_darts || 0))) * 100 : 0,
                'againstDarts': (s.x01_legs_against_darts || 0) + (s.cricket_legs_against_darts || 0) > 0 ?
                    (((s.x01_legs_against_darts_won || 0) + (s.cricket_legs_against_darts_won || 0)) /
                    ((s.x01_legs_against_darts || 0) + (s.cricket_legs_against_darts || 0))) * 100 : 0
            };
        }

        function formatStatValue(key, value) {
            if (value === 0 || value === null || value === undefined) return '-';

            // Percentages
            if (key.includes('Pct') || key === 'withDarts' || key === 'againstDarts') {
                return value.toFixed(1) + '%';
            }

            // Averages (3da, first9, mpr, avgCo)
            if (key === '3da' || key === 'first9' || key === 'avgCo') {
                return value.toFixed(1);
            }
            if (key === 'mpr') {
                return value.toFixed(2);
            }

            // Integers
            return Math.round(value).toString();
        }

        function renderStatsPlayerView() {
            const cat = STATS_CATEGORIES[statsData.category];
            const currentPage = cat.pages[statsData.pageIndex] || cat.pages[0];
            const columns = currentPage.columns;

            // Get all players with stats
            let players = Object.keys(statsData.leaguePlayers).map(id => getPlayerStatValues(id));

            // Filter by level if set
            if (statsData.levelFilter) {
                players = players.filter(p => (p.level || '').toUpperCase() === statsData.levelFilter);
            }

            // Sort players by the page's sort key
            const sortKey = currentPage.sortKey || columns[0].key;
            players.sort((a, b) => {
                const aVal = a[sortKey] || 0;
                const bVal = b[sortKey] || 0;
                return statsData.sortDirection === 'desc' ? bVal - aVal : aVal - bVal;
            });

            // Get team names lookup
            const teamNames = {};
            teams.forEach(t => { teamNames[t.id] = t.team_name; });

            // Group by level if no filter
            const levels = statsData.levelFilter ? [statsData.levelFilter] : ['A', 'B', 'C', 'D', 'E', ''];
            const levelNames = { 'A': 'A LEVEL', 'B': 'B LEVEL', 'C': 'C LEVEL', 'D': 'D LEVEL', 'E': 'E LEVEL', '': 'UNRATED' };

            let html = '<div class="standings-section"><table class="stats-table"><thead><tr>';
            html += '<th class="rank-col">#</th>';
            html += '<th class="name-col">Player</th>';

            columns.forEach(col => {
                const hideClass = col.hidePortrait ? 'hide-portrait' : '';
                html += `<th class="stat-col sortable ${hideClass}" onclick="sortStats('${col.key}')">${col.label}</th>`;
            });

            html += '</tr></thead><tbody>';

            levels.forEach(level => {
                const levelPlayers = players.filter(p => (p.level || '').toUpperCase() === level);
                if (levelPlayers.length === 0) return;

                // Level header (only if showing all levels)
                if (!statsData.levelFilter) {
                    const levelClass = level ? `level-${level.toLowerCase()}` : '';
                    html += `<tr><td colspan="${columns.length + 2}" class="stats-section-header ${levelClass}">${levelNames[level]} (${levelPlayers.length})</td></tr>`;
                }

                levelPlayers.forEach((p, idx) => {
                    const levelBadge = p.level ? `<span class="player-level-badge level-${p.level.toLowerCase()}">${p.level}</span>` : '';
                    const teamBadge = teamNames[p.teamId] ? `<span class="stats-team-badge">${teamNames[p.teamId]}</span>` : '';

                    html += '<tr class="standings-player-row level-player-row">';
                    html += `<td class="rank-col">${idx + 1}</td>`;
                    html += `<td class="name-col"><div class="stats-player-name">
                        <a href="/pages/player-profile.html?id=${p.id}" class="stats-player-link">${p.name}</a>
                        ${levelBadge}${teamBadge}
                    </div></td>`;

                    columns.forEach(col => {
                        const isPrimary = col.primary ? 'primary-stat' : 'secondary-stat';
                        const hideClass = col.hidePortrait ? 'hide-portrait' : '';
                        html += `<td class="stat-col ${isPrimary} ${hideClass}">${formatStatValue(col.key, p[col.key])}</td>`;
                    });

                    html += '</tr>';
                });
            });

            html += '</tbody></table></div>';
            return html;
        }

        function renderStatsTeamView() {
            const cat = STATS_CATEGORIES[statsData.category];
            const currentPage = cat.pages[statsData.pageIndex] || cat.pages[0];
            const columns = currentPage.columns;

            // Calculate team averages
            const teamStats = teams.map(team => {
                const teamPlayers = Object.keys(statsData.leaguePlayers)
                    .filter(id => statsData.leaguePlayers[id].team_id === team.id)
                    .map(id => getPlayerStatValues(id));

                // Filter by level if set
                let filteredPlayers = teamPlayers;
                if (statsData.levelFilter) {
                    filteredPlayers = teamPlayers.filter(p => (p.level || '').toUpperCase() === statsData.levelFilter);
                }

                // Calculate team averages for each column
                const teamAvg = { id: team.id, name: team.team_name, players: filteredPlayers };

                columns.forEach(col => {
                    const values = filteredPlayers.map(p => p[col.key]).filter(v => v > 0);
                    teamAvg[col.key] = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                });

                return teamAvg;
            });

            // Sort teams by the page's sort key
            const sortKey = currentPage.sortKey || columns[0].key;
            teamStats.sort((a, b) => {
                const aVal = a[sortKey] || 0;
                const bVal = b[sortKey] || 0;
                return statsData.sortDirection === 'desc' ? bVal - aVal : aVal - bVal;
            });

            let html = '<div class="standings-section"><table class="stats-table"><thead><tr>';
            html += '<th class="rank-col">#</th>';
            html += '<th class="name-col">Team</th>';

            columns.forEach(col => {
                const hideClass = col.hidePortrait ? 'hide-portrait' : '';
                html += `<th class="stat-col sortable ${hideClass}" onclick="sortStats('${col.key}')">${col.label}</th>`;
            });

            html += '</tr></thead><tbody>';

            teamStats.forEach((team, idx) => {
                const isExpanded = statsData.expandedTeams.has(team.id);

                // Team row
                html += `<tr class="team-header-row ${isExpanded ? 'expanded' : ''}" onclick="toggleStatsTeam('${team.id}')">`;
                html += `<td class="rank-col">${idx + 1}</td>`;
                html += `<td class="name-col"><span class="team-expand-icon"></span>
                    <a href="/pages/team-profile.html?team_id=${team.id}&league_id=${leagueId}" class="stats-team-link" onclick="event.stopPropagation()">${team.name}</a>
                </td>`;

                columns.forEach(col => {
                    const isPrimary = col.primary ? 'primary-stat' : 'secondary-stat';
                    const hideClass = col.hidePortrait ? 'hide-portrait' : '';
                    html += `<td class="stat-col ${isPrimary} ${hideClass}">${formatStatValue(col.key, team[col.key])}</td>`;
                });

                html += '</tr>';

                // Player rows (hidden unless expanded)
                team.players.forEach(p => {
                    const levelBadge = p.level ? `<span class="player-level-badge level-${p.level.toLowerCase()}">${p.level}</span>` : '';

                    html += `<tr class="player-row ${isExpanded ? '' : 'hidden'}">`;
                    html += '<td></td>';
                    html += `<td class="name-col"><div class="stats-player-name">
                        <a href="/pages/player-profile.html?id=${p.id}" class="stats-player-link">${p.name}</a>
                        ${levelBadge}
                    </div></td>`;

                    columns.forEach(col => {
                        const hideClass = col.hidePortrait ? 'hide-portrait' : '';
                        html += `<td class="stat-col secondary-stat ${hideClass}">${formatStatValue(col.key, p[col.key])}</td>`;
                    });

                    html += '</tr>';
                });
            });

            html += '</tbody></table></div>';
            return html;
        }

        window.setStatsView = function(mode) {
            statsData.viewMode = mode;
            statsData.expandedTeams.clear();
            renderStatsTab();
        };

        window.setStatsLevel = function(level) {
            statsData.levelFilter = level;
            renderStatsTab();
        };

        window.setStatsCategory = function(category) {
            statsData.category = category;
            statsData.pageIndex = 0;  // Reset to first page when changing category
            statsData.sortColumn = 'primary';
            statsData.sortDirection = 'desc';
            renderStatsTab();
        };

        window.setStatsPage = function(index) {
            const cat = STATS_CATEGORIES[statsData.category];
            if (index >= 0 && index < cat.pages.length) {
                statsData.pageIndex = index;
                statsData.sortDirection = 'desc';
                renderStatsTab();
            }
        };

        window.changeStatsPage = function(delta) {
            const cat = STATS_CATEGORIES[statsData.category];
            const newIndex = statsData.pageIndex + delta;
            if (newIndex >= 0 && newIndex < cat.pages.length) {
                statsData.pageIndex = newIndex;
                statsData.sortDirection = 'desc';
                renderStatsTab();
            }
        };

        window.sortStats = function(column) {
            if (statsData.sortColumn === column) {
                statsData.sortDirection = statsData.sortDirection === 'desc' ? 'asc' : 'desc';
            } else {
                statsData.sortColumn = column;
                statsData.sortDirection = 'desc';
            }
            renderStatsTab();
        };

        window.toggleStatsTeam = function(teamId) {
            if (statsData.expandedTeams.has(teamId)) {
                statsData.expandedTeams.delete(teamId);
            } else {
                statsData.expandedTeams.add(teamId);
            }
            renderStatsTab();
        };

        function renderRules() {
            const rules = leagueData.rules || {};
            const teamSize = leagueData.team_size || leagueData.min_players || 3;
            const rounds = Array.isArray(leagueData.match_format) ? leagueData.match_format : [];

            // Label mappings
            const inRuleLabels = { straight: 'Straight In', double: 'Double In', free: 'Straight In' };
            const outRuleLabels = { straight: 'Straight Out', double: 'Double Out', master: 'Master Out', free: 'Straight Out' };
            const pointSystemLabels = { game_based: 'Game-Based (1 point per game won)', match_based: 'Match-Based (2 points for win, 1 for draw)' };
            const playoffLabels = { none: 'No Playoffs', top_4_single: 'Top 4 Single Elimination', top_4_double: 'Top 4 Double Elimination', top_6_single: 'Top 6 Single Elimination', top_8_single: 'Top 8 Single Elimination' };
            const scheduleLabels = { round_robin: 'Round Robin', double_round_robin: 'Double Round Robin (Home & Away)' };
            const startRuleLabels = {
                cork_every_leg: 'Cork every leg',
                alternate_cork_first_deciding: 'Alternate, cork first & deciding',
                loser_starts_cork_first_deciding: 'Loser starts, cork first & deciding',
                winner_starts_cork_first_deciding: 'Winner starts, cork first & deciding'
            };
            const corkOptionLabels = {
                alternate_random_first_last: 'Alternate, randomize first & last',
                random_every_leg: 'Randomize every leg',
                away_team_option: 'Away team option',
                home_team_option: 'Home team option',
                loser_option: 'Loser option',
                winner_option: 'Winner option'
            };

            // Calculate total points from rounds
            const totalPoints = rounds.length > 0 ? rounds.reduce((sum, r) => sum + (r.points || 1), 0) : (leagueData.games_per_match || 9);

            // Render rounds detail
            function renderRoundsDetail() {
                if (rounds.length === 0) {
                    // Fallback to basic format display
                    const format = leagueData.format || '501';
                    const bestOf = leagueData.best_of || 3;
                    const inRule = inRuleLabels[leagueData.in_rule] || 'Straight In';
                    const outRule = outRuleLabels[leagueData.checkout || leagueData.out_rule] || 'Double Out';
                    return `
                        <div class="rules-item">
                            <span class="rules-label">Default Format</span>
                            <span class="rules-value">${format.toUpperCase()} - Best of ${bestOf} - ${inRule} / ${outRule}</span>
                        </div>
                    `;
                }

                // Helper for game short names
                function getGameShortName(gameType, x01Value, short = false) {
                    if (gameType === 'cricket') return short ? 'CRKT' : 'CRICKET';
                    if (gameType === 'corks_choice') return short ? 'CHOICE' : "CORK'S CHOICE";
                    if (gameType === 'x01') return x01Value || 'X01';
                    return (gameType || '501').toUpperCase();
                }

                return rounds.map((r, idx) => {
                    let gameType;
                    if (r.game_type === 'mixed' && r.legs && r.legs.length > 0) {
                        // Show actual games: "501/CRKT/CHOICE" (short names for mixed)
                        const gameList = r.legs.map(leg => getGameShortName(leg.game_type, leg.x01_value, true));
                        gameType = gameList.join(' / ');
                    } else {
                        gameType = getGameShortName(r.game_type, r.x01_value);
                    }

                    const bestOf = r.best_of || 3;
                    const level = r.player_level || 'A';
                    const players = r.num_players === 2 ? 'Doubles' : 'Singles';
                    const points = r.points || 1;
                    const isMixed = r.game_type === 'mixed';
                    const inRule = (r.game_type === 'cricket' || isMixed) ? '' : (inRuleLabels[r.in_rule] || 'Straight In');
                    const outRule = (r.game_type === 'cricket' || isMixed) ? '' : (outRuleLabels[r.out_rule] || 'Double Out');
                    const rulesStr = (r.game_type === 'cricket' || isMixed) ? '' : ` (${inRule} / ${outRule})`;

                    return `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 8px;">
                            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--pink), #d63384); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-family: 'Bebas Neue', cursive; font-size: 16px; font-weight: bold; flex-shrink: 0;">${idx + 1}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-light);">${gameType} - Best of ${bestOf}${rulesStr}</div>
                                <div style="font-size: 12px; color: var(--text-dim);">${players}  ${level} Level  ${points} pt${points > 1 ? 's' : ''}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Render tiebreakers
            function renderTiebreakers() {
                const tiebreakers = leagueData.tiebreakers || [
                    { value: 'head_to_head', enabled: true },
                    { value: 'point_diff', enabled: true },
                    { value: 'total_points', enabled: true }
                ];
                const tbLabels = {
                    head_to_head: 'Head-to-Head',
                    point_diff: 'Point Differential',
                    total_points: 'Total Points Scored',
                    cork_off: 'Cork-Off'
                };
                const enabled = tiebreakers.filter(t => t.enabled);
                if (enabled.length === 0) return 'Standard tiebreaker rules';
                return enabled.map((t, i) => `${i + 1}. ${tbLabels[t.value] || t.value}`).join(', ');
            }

            return `
                <div class="rules-container">
                    <!-- League Overview -->
                    <div class="rules-card">
                        <div class="rules-card-header">LEAGUE OVERVIEW</div>
                        <div class="rules-card-body">
                            <div class="rules-item">
                                <span class="rules-label">League Type</span>
                                <span class="rules-value">${leagueData.league_mode === 'team' ? 'Team League' : 'Draft League'}</span>
                            </div>
                            <div class="rules-item">
                                <span class="rules-label">Team Size</span>
                                <span class="rules-value">${teamSize} players per team${leagueData.max_roster ? ` (max ${leagueData.max_roster} on roster)` : ''}</span>
                            </div>
                            <div class="rules-item">
                                <span class="rules-label">Schedule</span>
                                <span class="rules-value">${scheduleLabels[leagueData.schedule_format] || 'Round Robin'}</span>
                            </div>
                            ${leagueData.entry_fee ? `
                            <div class="rules-item">
                                <span class="rules-label">Entry Fee</span>
                                <span class="rules-value">$${leagueData.entry_fee} per player</span>
                            </div>
                            ` : ''}
                            ${leagueData.allow_fillins ? `
                            <div class="rules-item">
                                <span class="rules-label">Fill-ins</span>
                                <span class="rules-value">Allowed during active season</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Match Format -->
                    <div class="rules-card">
                        <div class="rules-card-header">MATCH FORMAT (${rounds.length || leagueData.games_per_match || 9} ROUNDS  ${totalPoints} POINTS)</div>
                        <div class="rules-card-body">
                            ${renderRoundsDetail()}
                        </div>
                    </div>

                    <!-- Cork & Start Rules -->
                    <div class="rules-card">
                        <div class="rules-card-header">CORK & START RULES</div>
                        <div class="rules-card-body">
                            <div class="rules-item">
                                <span class="rules-label">Start Rules</span>
                                <span class="rules-value">${startRuleLabels[leagueData.start_rules || leagueData.cork_rule] || 'Cork every leg'}</span>
                            </div>
                            <div class="rules-item">
                                <span class="rules-label">Cork Option</span>
                                <span class="rules-value">${corkOptionLabels[leagueData.cork_option] || 'Alternate'}</span>
                            </div>
                            ${leagueData.cork_winner_gets ? `
                            <div class="rules-item">
                                <span class="rules-label">Cork Winner Gets</span>
                                <span class="rules-value">${leagueData.cork_winner_gets === 'choose-and-start' ? 'Choose game AND start' : 'Choose game only'}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Standings & Playoffs -->
                    <div class="rules-card">
                        <div class="rules-card-header">STANDINGS & PLAYOFFS</div>
                        <div class="rules-card-body">
                            <div class="rules-item">
                                <span class="rules-label">Point System</span>
                                <span class="rules-value">${pointSystemLabels[leagueData.point_system] || 'Game-Based'}</span>
                            </div>
                            <div class="rules-item">
                                <span class="rules-label">Tiebreakers</span>
                                <span class="rules-value">${renderTiebreakers()}</span>
                            </div>
                            <div class="rules-item">
                                <span class="rules-label">Playoffs</span>
                                <span class="rules-value">${playoffLabels[leagueData.playoff_format] || 'No Playoffs'}</span>
                            </div>
                            ${leagueData.level_rules ? `
                            <div class="rules-item">
                                <span class="rules-label">Level Rules</span>
                                <span class="rules-value">${leagueData.level_rules === 'strict' ? 'Strict (must match level)' : leagueData.level_rules === 'play_up' ? 'Can play up, not down' : 'Flexible'}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Additional Rules -->
                    ${leagueData.league_rules ? `
                    <div class="rules-card">
                        <div class="rules-card-header">ADDITIONAL RULES</div>
                        <div class="rules-card-body">
                            <p style="color: var(--text-dim); white-space: pre-wrap; line-height: 1.6;">${leagueData.league_rules}</p>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function renderLive() {
            // Get matches currently in progress
            const liveMatches = matches.filter(m => m.status === 'in_progress');

            if (liveMatches.length === 0) {
                return `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div>No live matches right now</div>
                        <p style="color: var(--text-dim); margin-top: 10px;">Check back during match nights!</p>
                    </div>
                `;
            }

            return `
                <div style="display: grid; gap: 15px;">
                    ${liveMatches.map(m => `
                        <div class="stats-card live-match-card" data-match-id="${m.id}">
                            <div class="stats-card-header" style="background: linear-gradient(135deg, #10b981, #059669); display: flex; justify-content: space-between; align-items: center;">
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    <span style="width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: pulse 1.5s infinite;"></span>
                                    LIVE
                                </span>
                                <span style="font-size: 14px; opacity: 0.9;">Round ${m.current_round || 1}</span>
                            </div>
                            <div class="stats-card-body" style="padding: 15px;">
                                <div style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; text-align: center; gap: 10px;">
                                    <div>
                                        <div style="font-weight: 700; font-size: 16px;">${m.home_team_name || 'Home'}</div>
                                        <div style="font-family: 'Archivo Black', sans-serif; font-size: 36px; color: var(--teal);">${m.home_score || 0}</div>
                                    </div>
                                    <div style="font-family: 'Bebas Neue', cursive; font-size: 20px; color: var(--text-dim);">VS</div>
                                    <div>
                                        <div style="font-weight: 700; font-size: 16px;">${m.away_team_name || 'Away'}</div>
                                        <div style="font-family: 'Archivo Black', sans-serif; font-size: 36px; color: var(--pink);">${m.away_score || 0}</div>
                                    </div>
                                </div>
                                ${m.current_game ? `
                                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                                        <div style="text-align: center; font-size: 12px; color: var(--text-dim); margin-bottom: 8px;">CURRENT GAME</div>
                                        <div style="display: flex; justify-content: space-around; align-items: center;">
                                            <div style="text-align: center;">
                                                <div style="font-size: 12px; color: var(--text-dim);">${m.current_game.home_player || '-'}</div>
                                                <div style="font-family: 'Bebas Neue', cursive; font-size: 28px; color: var(--yellow);">${m.current_game.home_score || 501}</div>
                                            </div>
                                            <div style="font-family: 'Bebas Neue', cursive; color: var(--text-dim);">${m.current_game.game_type || '501'}</div>
                                            <div style="text-align: center;">
                                                <div style="font-size: 12px; color: var(--text-dim);">${m.current_game.away_player || '-'}</div>
                                                <div style="font-family: 'Bebas Neue', cursive; font-size: 28px; color: var(--yellow);">${m.current_game.away_score || 501}</div>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                <button onclick="expandMatch('${m.id}')" style="width: 100%; margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border: 2px solid var(--teal); color: var(--teal); font-family: 'Bebas Neue', cursive; font-size: 16px; letter-spacing: 1px; cursor: pointer; transition: all 0.2s;">
                                    EXPAND SCORER
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <style>
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.4; }
                    }
                </style>
            `;
        }

        window.expandMatch = function(matchId) {
            // Open match in expanded scorer view
            window.open(`/pages/league-scoreboard.html?match_id=${matchId}&league_id=${leagueId}`, '_blank');
        };

        function renderFillins() {
            const fillinSettings = leagueData.fillin_settings || {};

            return `
                <div class="stats-card" style="margin-bottom: 20px;">
                    <div class="stats-card-header" style="background: linear-gradient(135deg, var(--teal), #5ab8d4);">
                        <span style="color: var(--black);"> SIGN UP AS A FILL-IN</span>
                    </div>
                    <div class="stats-card-body" style="padding: 20px;">
                        <p style="margin-bottom: 15px; color: var(--text-dim);">Fill-ins substitute for unavailable players. Captains will contact you when needed.</p>
                        <button class="register-btn" style="font-size: 18px; padding: 15px;" onclick="openFillinModal()">SIGN UP AS FILL-IN</button>
                    </div>
                </div>

                <div class="stats-card">
                    <div class="stats-card-header">
                        AVAILABLE FILL-INS <span style="background: var(--teal); color: var(--black); padding: 2px 10px; border-radius: 10px; margin-left: 10px; font-size: 14px;">${fillins.length}</span>
                    </div>
                    <div class="stats-card-body">
                        ${fillins.length === 0 ? `
                            <div class="empty-state" style="padding: 30px;">
                                <div class="empty-state-icon"></div>
                                <div>No fill-ins registered yet. Be the first!</div>
                            </div>
                        ` : fillins.map(f => `
                            <div class="leaderboard-item">
                                <div class="leaderboard-name">
                                    ${f.full_name}
                                    ${f.preferred_level ? `<span class="signup-level" style="margin-left: 8px;">${f.preferred_level}</span>` : ''}
                                </div>
                                <div style="text-align: right; font-size: 12px; color: var(--text-dim);">
                                    ${fillinSettings.collect_501_avg && f.avg_501 ? `<div>501: ${f.avg_501}</div>` : ''}
                                    ${fillinSettings.collect_cricket_avg && f.avg_cricket ? `<div>MPR: ${f.avg_cricket}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Combined Registration Tab (shows both regular registration and fill-in)
        function renderRegistrationTab() {
            const fillinSettings = leagueData.fillin_settings || {};
            const isDraftLeague = leagueData.league_type === 'triples_draft' || leagueData.league_type === 'doubles_draft' || leagueData.draft_enabled;
            const totalSpots = (leagueData.num_teams || leagueData.max_teams || 8) * (leagueData.team_size || leagueData.players_per_team || 3);
            const currentPlayers = registrations.length;
            const spotsRemaining = totalSpots - currentPlayers;

            return `
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <!-- General Registration Card -->
                    <div class="stats-card">
                        <div class="stats-card-header" style="background: linear-gradient(135deg, var(--pink), #cc3879);">
                            JOIN THE LEAGUE
                        </div>
                        <div class="stats-card-body" style="padding: 20px;">
                            <p style="margin-bottom: 15px; color: var(--text-dim);">
                                ${isDraftLeague ?
                                    'Register to be drafted onto a team. Teams are formed through a draft process.' :
                                    'Register to join the league. You\'ll be assigned to a team or can form your own.'}
                            </p>
                            <div class="spots-display" style="margin-bottom: 15px;">
                                <div class="spots-count">${currentPlayers} / ${totalSpots}</div>
                                <div class="spots-label">${spotsRemaining <= 0 ? 'WAITLIST OPEN' : `${spotsRemaining} SPOTS REMAINING`}</div>
                            </div>
                            <button class="register-btn" style="font-size: 18px; padding: 15px;" onclick="openModal()">
                                ${spotsRemaining <= 0 ? 'JOIN WAITLIST' : 'REGISTER NOW'}
                            </button>
                        </div>
                    </div>

                    <!-- Fill-in Registration Card -->
                    <div class="stats-card">
                        <div class="stats-card-header" style="background: linear-gradient(135deg, var(--teal), #5ab8d4);">
                            <span style="color: var(--black);">SIGN UP AS FILL-IN</span>
                        </div>
                        <div class="stats-card-body" style="padding: 20px;">
                            <p style="margin-bottom: 15px; color: var(--text-dim);">
                                Fill-ins substitute for unavailable players. Captains will contact you when needed.
                            </p>
                            <div style="background: rgba(145, 215, 235, 0.2); padding: 15px; margin-bottom: 15px; border: 2px solid var(--teal); text-align: center;">
                                <div style="font-family: 'Archivo Black', sans-serif; font-size: 24px; color: var(--teal);">${fillins.length}</div>
                                <div style="font-size: 12px; color: var(--text-dim);">FILL-INS AVAILABLE</div>
                            </div>
                            <button class="register-btn" style="font-size: 18px; padding: 15px; background: linear-gradient(135deg, var(--teal), #5ab8d4); color: var(--black);" onclick="openFillinModal()">
                                SIGN UP AS FILL-IN
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Current Registrations List -->
                <div class="stats-card">
                    <div class="stats-card-header">
                        REGISTERED PLAYERS <span style="background: var(--pink); padding: 2px 10px; border-radius: 10px; margin-left: 10px; font-size: 14px;">${registrations.length}</span>
                    </div>
                    <div class="stats-card-body">
                        ${registrations.length === 0 ? `
                            <div class="empty-state" style="padding: 30px;">
                                <div class="empty-state-icon"></div>
                                <div>No players registered yet. Be the first!</div>
                            </div>
                        ` : registrations.slice(0, 20).map(r => `
                            <div class="leaderboard-item">
                                <div class="leaderboard-name">
                                    ${r.full_name || r.name}
                                    ${r.skill_level || r.preferred_level ? `<span class="signup-level" style="margin-left: 8px;">${r.skill_level || r.preferred_level}</span>` : ''}
                                </div>
                                <span class="signup-status ${r.payment_status === 'paid' ? 'confirmed' : 'pending'}">
                                    ${r.payment_status === 'paid' ? 'Confirmed' : 'Pending'}
                                </span>
                            </div>
                        `).join('')}
                        ${registrations.length > 20 ? `<div style="text-align: center; padding: 10px; color: var(--text-dim);">+ ${registrations.length - 20} more</div>` : ''}
                    </div>
                </div>

                <!-- Fill-ins List -->
                ${fillins.length > 0 ? `
                <div class="stats-card" style="margin-top: 20px;">
                    <div class="stats-card-header">
                        AVAILABLE FILL-INS <span style="background: var(--teal); color: var(--black); padding: 2px 10px; border-radius: 10px; margin-left: 10px; font-size: 14px;">${fillins.length}</span>
                    </div>
                    <div class="stats-card-body">
                        ${fillins.map(f => `
                            <div class="leaderboard-item">
                                <div class="leaderboard-name">
                                    ${f.full_name}
                                    ${f.preferred_level ? `<span class="signup-level" style="margin-left: 8px;">${f.preferred_level}</span>` : ''}
                                </div>
                                <div style="text-align: right; font-size: 12px; color: var(--text-dim);">
                                    ${fillinSettings.collect_501_avg && f.avg_501 ? `<div>501: ${f.avg_501}</div>` : ''}
                                    ${fillinSettings.collect_cricket_avg && f.avg_cricket ? `<div>MPR: ${f.avg_cricket}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;
        }

        // Director Login
        window.showDirectorLogin = function() {
            const html = `
                <div style="text-align: center;">
                    <p style="margin-bottom: 25px; color: var(--text-dim);">Enter your 8-digit PIN to access the league management dashboard.</p>
                    <div style="display: flex; justify-content: center; margin: 30px 0;">
                        <input type="password" id="directorPinInput" maxlength="8"
                            style="width: 100%; max-width: 280px; height: 56px; border: 3px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 24px; text-align: center; font-family: 'JetBrains Mono', monospace; background: rgba(0,0,0,0.3); color: #FDD835; letter-spacing: 4px; transition: all 0.2s;"
                            inputmode="numeric" pattern="[0-9]*" autocomplete="off" placeholder=""
                            onfocus="this.style.borderColor='#FF469A'; this.style.background='rgba(255,70,154,0.1)'; this.style.boxShadow='0 0 15px rgba(255,70,154,0.3)';"
                            onblur="this.style.borderColor='rgba(255,255,255,0.2)'; this.style.background='rgba(0,0,0,0.3)'; this.style.boxShadow='none';"
                            onkeydown="if(event.key==='Enter') verifyDirectorPin();">
                    </div>
                    <button class="submit-btn" onclick="verifyDirectorPin()" style="width: 100%; max-width: 280px;">ENTER DASHBOARD</button>
                    <p style="margin-top: 20px; font-size: 12px; color: var(--text-dim);">Use your player PIN or the admin PIN from league creation</p>
                </div>
            `;
            document.getElementById('modalBody').innerHTML = html;
            document.querySelector('.modal-title').textContent = ' DIRECTOR LOGIN';
            document.getElementById('registerModal').classList.add('active');
            setTimeout(() => document.getElementById('directorPinInput').focus(), 100);
        };

        window.verifyDirectorPin = async function() {
            const pin = document.getElementById('directorPinInput').value.trim();
            if (!pin || pin.length !== 8) {
                alert('Please enter your 8-digit PIN');
                return;
            }

            try {
                // Verify PIN via backend API
                const result = await callFunction('verifyLeaguePin', {
                    league_id: leagueId,
                    pin: pin
                });

                if (result.success) {
                    // Save session and redirect to director dashboard
                    localStorage.setItem('leagueAdminPin_' + leagueId, JSON.stringify({
                        pin: pin,
                        timestamp: Date.now()
                    }));
                    window.location.href = `/pages/league-director.html?league_id=${leagueId}`;
                } else {
                    alert('Invalid PIN. Please try again.');
                }
            } catch (e) {
                alert('Error verifying PIN: ' + e.message);
            }
        };

        window.openFillinModal = function() {
            renderFillinForm();
            document.getElementById('registerModal').classList.add('active');
        };

        // New simplified sub signup modal - works for anyone
        window.openSubSignupModal = function() {
            renderSubSignupForm();
            document.getElementById('registerModal').classList.add('active');
        };

        async function getLevelRanges() {
            // Calculate live level ranges from current league stats
            const levelStats = { A: [], B: [], C: [] };

            try {
                // Get all players with their levels
                const playersSnap = await getDocs(collection(db, 'leagues', leagueId, 'players'));
                const playerLevels = {};
                playersSnap.forEach(d => {
                    const p = d.data();
                    if (p.level && ['A', 'B', 'C'].includes(p.level)) {
                        playerLevels[d.id] = p.level;
                    }
                });

                // Get stats for each player
                const statsSnap = await getDocs(collection(db, 'leagues', leagueId, 'stats'));
                statsSnap.forEach(d => {
                    const s = d.data();
                    const level = playerLevels[d.id];
                    if (level && levelStats[level]) {
                        const avg = get3DA(s);
                        const mpr = getMPR(s);
                        if (avg != null) levelStats[level].push({ avg, mpr });
                    }
                });

                // Calculate ranges
                const ranges = {};
                for (const level of ['A', 'B', 'C']) {
                    const stats = levelStats[level];
                    if (stats.length > 0) {
                        const avgs = stats.map(s => s.avg).filter(v => v != null);
                        const mprs = stats.map(s => s.mpr).filter(v => v != null);
                        ranges[level] = {
                            avgMin: avgs.length > 0 ? Math.min(...avgs).toFixed(1) : null,
                            avgMax: avgs.length > 0 ? Math.max(...avgs).toFixed(1) : null,
                            mprMin: mprs.length > 0 ? Math.min(...mprs).toFixed(2) : null,
                            mprMax: mprs.length > 0 ? Math.max(...mprs).toFixed(2) : null
                        };
                    }
                }
                return ranges;
            } catch (e) {
                console.error('Error getting level ranges:', e);
                return {};
            }
        }

        async function renderSubSignupForm() {
            // Show loading
            document.getElementById('modalBody').innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>Loading...</p></div>';
            document.querySelector('.modal-title').textContent = 'BE A SUB';

            // Get level ranges
            const ranges = await getLevelRanges();

            const levelOptionsHtml = ['A', 'B', 'C'].map(level => {
                const r = ranges[level];
                let rangeText = '';
                if (r && r.avgMin && r.avgMax) {
                    rangeText = ` (${r.avgMin}-${r.avgMax} 3DA`;
                    if (r.mprMin && r.mprMax) {
                        rangeText += ` / ${r.mprMin}-${r.mprMax} MPR`;
                    }
                    rangeText += ')';
                }
                const levelName = level === 'A' ? 'Advanced' : level === 'B' ? 'Intermediate' : 'Beginner';
                return `<option value="${level}">${level} - ${levelName}${rangeText}</option>`;
            }).join('');

            const html = `
                <div class="sub-signup-intro">
                    <p>Teams sometimes need substitute players. Sign up to get called when there's a spot available.</p>
                    <ul>
                        <li>No commitment required</li>
                        <li>Play only when you're available</li>
                        <li>Great way to meet players and get league experience</li>
                    </ul>
                </div>

                <!-- PIN Lookup Section -->
                <div class="pin-section">
                    <div class="pin-section-title">ALREADY A MEMBER? ENTER YOUR PIN</div>
                    <div class="pin-row">
                        <input type="password" id="subPin" class="pin-input" maxlength="8" placeholder="" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
                        <button class="pin-btn" onclick="lookupSubPin()">GO</button>
                    </div>
                </div>

                <div class="divider"><span>OR REGISTER NEW</span></div>

                <form id="subSignupForm" onsubmit="submitSubSignup(event)">
                    <div class="form-group">
                        <label class="form-label">Full Name <span>*</span></label>
                        <input type="text" id="subName" name="full_name" class="form-input" required placeholder="John Smith">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email <span>*</span></label>
                        <input type="email" id="subEmail" name="email" class="form-input" required placeholder="john@example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Phone <span>*</span></label>
                        <input type="tel" id="subPhone" name="phone" class="form-input" required placeholder="555-123-4567">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Your Level</label>
                        <select id="subLevel" name="preferred_level" class="form-select">
                            <option value="">-- Select based on your stats --</option>
                            ${levelOptionsHtml}
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">501 Average</label>
                            <input type="number" id="sub501" name="avg_501" class="form-input" step="0.01" placeholder="e.g., 45.5">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Cricket MPR</label>
                            <input type="number" id="subMPR" name="avg_cricket" class="form-input" step="0.01" placeholder="e.g., 2.5">
                        </div>
                    </div>

                    <button type="submit" class="submit-btn" id="subSubmitBtn">SIGN UP AS SUB</button>
                </form>
            `;

            document.getElementById('modalBody').innerHTML = html;
        }

        window.lookupSubPin = async function() {
            const pin = document.getElementById('subPin').value.trim();
            if (pin.length !== 8) {
                alert('Please enter an 8-digit PIN');
                return;
            }

            try {
                const result = await callFunction('playerLogin', { pin: pin });
                if (result.success && result.player) {
                    memberData = result.player;
                    document.getElementById('subName').value = memberData.name || '';
                    document.getElementById('subEmail').value = memberData.email || '';
                    document.getElementById('subPhone').value = memberData.phone || '';
                    if (memberData.preferred_level && document.getElementById('subLevel')) {
                        document.getElementById('subLevel').value = memberData.preferred_level;
                    }
                    if (memberData.avg_501 && document.getElementById('sub501')) {
                        document.getElementById('sub501').value = memberData.avg_501;
                    }
                    if (memberData.avg_cricket && document.getElementById('subMPR')) {
                        document.getElementById('subMPR').value = memberData.avg_cricket;
                    }
                    alert('Welcome back, ' + memberData.name + '! Your info has been filled in.');
                } else {
                    alert('PIN not found. Please fill in your information below.');
                }
            } catch (e) {
                alert('Error looking up PIN: ' + e.message);
            }
        };

        window.submitSubSignup = async function(e) {
            e.preventDefault();
            const form = document.getElementById('subSignupForm');
            const formData = new FormData(form);
            const btn = document.getElementById('subSubmitBtn');

            btn.disabled = true;
            btn.textContent = 'SIGNING UP...';

            try {
                const result = await callFunction('registerFillin', {
                    league_id: leagueId,
                    full_name: formData.get('full_name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    preferred_level: formData.get('preferred_level') || null,
                    avg_501: formData.get('avg_501') ? parseFloat(formData.get('avg_501')) : null,
                    avg_cricket: formData.get('avg_cricket') ? parseFloat(formData.get('avg_cricket')) : null,
                    send_welcome_sms: true, // Flag to trigger welcome SMS
                    create_member: true // Also create as BRDC member
                });

                if (result.success) {
                    const pinDisplay = result.player_pin ? `
                        <div style="background: rgba(253,216,53,0.2); border: 2px solid var(--yellow); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 5px;">YOUR BRDC PIN</div>
                            <div style="font-family: 'Bebas Neue', cursive; font-size: 36px; color: var(--yellow); letter-spacing: 4px;">${result.player_pin}</div>
                            <div style="font-size: 11px; color: var(--text-dim); margin-top: 5px;">Save this - use it to log in anywhere on BRDC</div>
                        </div>
                    ` : '';

                    document.getElementById('modalBody').innerHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 64px; margin-bottom: 15px;"></div>
                            <div style="font-family: 'Archivo Black', sans-serif; font-size: 20px; color: var(--teal); margin-bottom: 15px;">YOU'RE ON THE LIST!</div>
                            ${pinDisplay}
                            <p style="color: var(--text-dim); margin-bottom: 20px;">
                                Captains will contact you when they need a substitute.
                            </p>
                            <button class="register-btn" onclick="closeModal()">DONE</button>
                        </div>
                    `;
                    // Reload fillins list
                    const fillinsSnap = await getDocs(collection(db, 'leagues', leagueId, 'fillins'));
                    fillins = fillinsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                } else {
                    throw new Error(result.error || 'Signup failed');
                }
            } catch (error) {
                console.error('Sub signup error:', error);
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'SIGN UP AS SUB';
            }
        };

        function renderFillinForm() {
            const fillinSettings = leagueData.fillin_settings || {};

            const html = `
                <!-- PIN Lookup Section -->
                <div class="pin-section">
                    <div class="pin-section-title">ALREADY A MEMBER? ENTER YOUR PIN</div>
                    <div class="pin-row">
                        <input type="password" id="fillinPin" class="pin-input" maxlength="8" placeholder="" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
                        <button class="pin-btn" onclick="lookupFillinPin()">GO</button>
                    </div>
                </div>

                <div class="divider"><span>OR REGISTER NEW</span></div>

                <form id="fillinForm" onsubmit="submitFillin(event)">
                    <div class="form-group" style="text-align: center; margin-bottom: 20px;">
                        <label class="form-label">Profile Photo (Optional)</label>
                        <div class="image-uploader" id="fillinPhotoUploader" style="max-width: 120px; margin: 10px auto; border-radius: 50%; min-height: 120px;">
                            <input type="file" id="fillinPhotoInput" accept="image/*" onchange="handleFillinPhotoChange(this)">
                            <div id="fillinPhotoPlaceholder">
                                <div class="image-uploader-icon"></div>
                                <div class="image-uploader-text" style="font-size: 11px;">Add photo</div>
                            </div>
                            <div id="fillinPhotoPreviewContainer" class="image-preview-container" style="display: none;">
                                <img id="fillinPhotoPreview" class="image-preview" style="border-radius: 50%; width: 100px; height: 100px;" alt="Preview">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Full Name <span>*</span></label>
                        <input type="text" id="fillinName" name="full_name" class="form-input" required placeholder="John Smith">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email <span>*</span></label>
                        <input type="email" id="fillinEmail" name="email" class="form-input" required placeholder="john@example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Phone <span>*</span></label>
                        <input type="tel" id="fillinPhone" name="phone" class="form-input" required placeholder="555-123-4567">
                    </div>

                    ${fillinSettings.collect_level !== false ? `
                    <div class="form-group">
                        <label class="form-label">Preferred Level</label>
                        <select id="fillinLevel" name="preferred_level" class="form-select">
                            <option value="">-- Select --</option>
                            <option value="A">A - Advanced</option>
                            <option value="B">B - Intermediate</option>
                            <option value="C">C - Beginner</option>
                        </select>
                    </div>
                    ` : ''}

                    ${fillinSettings.collect_501_avg !== false ? `
                    <div class="form-group">
                        <label class="form-label">501 Average (if known)</label>
                        <input type="number" id="fillin501" name="avg_501" class="form-input" step="0.01" placeholder="e.g., 45.5">
                    </div>
                    ` : ''}

                    ${fillinSettings.collect_cricket_avg !== false ? `
                    <div class="form-group">
                        <label class="form-label">Cricket MPR (if known)</label>
                        <input type="number" id="fillinCricket" name="avg_cricket" class="form-input" step="0.01" placeholder="e.g., 2.5">
                    </div>
                    ` : ''}

                    <div class="form-group">
                        <label class="checkbox-group">
                            <input type="checkbox" name="sms_opt_in" checked>
                            <span>Contact me via SMS when fill-in needed</span>
                        </label>
                    </div>

                    <button type="submit" class="submit-btn" id="fillinSubmitBtn">SIGN UP AS FILL-IN</button>
                </form>
            `;

            document.getElementById('modalBody').innerHTML = html;
            document.querySelector('.modal-title').textContent = 'FILL-IN SIGNUP';
        }

        window.lookupFillinPin = async function() {
            const pin = document.getElementById('fillinPin').value.trim();
            if (pin.length !== 8) {
                alert('Please enter an 8-digit PIN');
                return;
            }

            try {
                const result = await callFunction('playerLogin', { pin: pin });
                if (result.success && result.player) {
                    memberData = result.player;
                    document.getElementById('fillinName').value = memberData.name || '';
                    document.getElementById('fillinEmail').value = memberData.email || '';
                    document.getElementById('fillinPhone').value = memberData.phone || '';
                    if (memberData.preferred_level && document.getElementById('fillinLevel')) {
                        document.getElementById('fillinLevel').value = memberData.preferred_level;
                    }
                    alert('Welcome back, ' + memberData.name + '! Your info has been filled in.');
                } else {
                    alert('PIN not found. Please register as a new player.');
                }
            } catch (e) {
                alert('Error looking up PIN: ' + e.message);
            }
        };

        window.handleFillinPhotoChange = function(input) {
            const file = input.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image must be less than 5MB');
                    input.value = '';
                    return;
                }
                selectedFillinPhoto = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('fillinPhotoPreview').src = e.target.result;
                    document.getElementById('fillinPhotoPreviewContainer').style.display = 'block';
                    document.getElementById('fillinPhotoPlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        };

        window.handleRegPhotoChange = function(input) {
            const file = input.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image must be less than 5MB');
                    input.value = '';
                    return;
                }
                selectedRegPhoto = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('regPhotoPreview').src = e.target.result;
                    document.getElementById('regPhotoPreviewContainer').style.display = 'block';
                    document.getElementById('regPhotoPlaceholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        };

        window.submitFillin = async function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const btn = document.getElementById('fillinSubmitBtn');

            btn.disabled = true;
            btn.textContent = 'SIGNING UP...';

            try {
                // Upload photo if selected
                let photoUrl = '';
                if (selectedFillinPhoto) {
                    showLoading('Uploading photo...');
                    try {
                        photoUrl = await uploadImage(selectedFillinPhoto, 'players');
                    } catch (uploadError) {
                        console.error('Photo upload failed:', uploadError);
                    }
                    hideLoading();
                }

                showLoading('Signing up...');
                const result = await callFunction('registerFillin', {
                    league_id: leagueId,
                    full_name: formData.get('full_name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    preferred_level: formData.get('preferred_level') || null,
                    avg_501: formData.get('avg_501') ? parseFloat(formData.get('avg_501')) : null,
                    avg_cricket: formData.get('avg_cricket') ? parseFloat(formData.get('avg_cricket')) : null,
                    sms_opt_in: formData.get('sms_opt_in') ? true : false,
                    member_pin: memberData?.pin || null,
                    photo_url: photoUrl
                });
                hideLoading();

                if (!result.success) {
                    throw new Error(result.error || 'Fill-in signup failed');
                }

                // Show success
                document.getElementById('modalBody').innerHTML = `
                    <div class="success-content">
                        <div class="success-icon"></div>
                        <div class="success-title">YOU'RE SIGNED UP!</div>
                        <div class="success-message">
                            You've been added to the fill-in list. Captains will contact you when they need a substitute.
                        </div>
                        ${result.player_pin ? `
                            <div class="pin-display-box">
                                <div class="pin-display-label">YOUR PIN (SAVE THIS!)</div>
                                <div class="pin-display-value">${result.player_pin}</div>
                            </div>
                        ` : ''}
                        <button class="submit-btn" onclick="closeModal(); location.reload();">DONE</button>
                    </div>
                `;

            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'SIGN UP AS FILL-IN';
            }
        };

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Initialize standings on first view
            if (tabName === 'standings') {
                initStandings();
            }
            // Initialize stats on first view
            if (tabName === 'stats') {
                initStats();
            }
        };

        function renderSignupsList() {
            if (registrations.length === 0) {
                return '<div class="login-prompt">No registrations yet. Be the first!</div>';
            }

            return registrations.map(reg => `
                <div class="signup-item">
                    <div>
                        <span class="signup-name">${reg.full_name || reg.name}</span>
                        ${reg.preferred_level ? `<span class="signup-level">${reg.preferred_level}</span>` : ''}
                    </div>
                    <span class="signup-status ${reg.payment_status === 'paid' ? 'confirmed' : 'pending'}">
                        ${reg.payment_status === 'paid' ? 'Confirmed' : 'Pending'}
                    </span>
                </div>
            `).join('');
        }

        function formatGameType(type) {
            const types = { '501': '501', 'cricket': 'Cricket', 'mixed': 'Mixed' };
            return types[type] || type || '501';
        }

        window.openModal = function() {
            renderRegistrationForm();
            document.getElementById('registerModal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('registerModal').classList.remove('active');
        };

        function renderRegistrationForm() {
            const entryFee = parseFloat(leagueData.entry_fee) || 0;

            const html = `
                <!-- PIN Lookup Section -->
                <div class="pin-section">
                    <div class="pin-section-title">ALREADY A MEMBER? ENTER YOUR PIN</div>
                    <div class="pin-row">
                        <input type="password" id="memberPin" class="pin-input" maxlength="8" placeholder="" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
                        <button class="pin-btn" onclick="lookupPin()">GO</button>
                    </div>
                </div>

                <div class="divider"><span>OR REGISTER NEW</span></div>

                <form id="registrationForm" onsubmit="submitRegistration(event)">
                    <div class="form-group" style="text-align: center; margin-bottom: 20px;">
                        <label class="form-label">Profile Photo (Optional)</label>
                        <div class="image-uploader" id="regPhotoUploader" style="max-width: 120px; margin: 10px auto; border-radius: 50%; min-height: 120px; background: linear-gradient(135deg, var(--pink), var(--teal)); display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; border: 3px solid rgba(255,255,255,0.2);">
                            <input type="file" id="regPhotoInput" accept="image/*" onchange="handleRegPhotoChange(this)" style="position: absolute; inset: 0; opacity: 0; cursor: pointer;">
                            <div id="regPhotoPlaceholder" style="text-align: center; color: white;">
                                <div style="font-size: 32px;"></div>
                                <div style="font-size: 11px;">Add photo</div>
                            </div>
                            <div id="regPhotoPreviewContainer" style="display: none; width: 100%; height: 100%;">
                                <img id="regPhotoPreview" style="border-radius: 50%; width: 100px; height: 100px; object-fit: cover;" alt="Preview">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Full Name <span>*</span></label>
                        <input type="text" id="regName" name="full_name" class="form-input" required placeholder="John Smith">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email <span>*</span></label>
                        <input type="email" id="regEmail" name="email" class="form-input" required placeholder="john@example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Phone <span>*</span></label>
                        <input type="tel" id="regPhone" name="phone" class="form-input" required placeholder="555-123-4567">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Skill Level</label>
                        <select id="regLevel" name="skill_level" class="form-select">
                            <option value="">-- Select --</option>
                            <option value="A">A - Advanced</option>
                            <option value="B">B - Intermediate</option>
                            <option value="C">C - Beginner</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-group">
                            <input type="checkbox" name="sms_opt_in" checked>
                            <span>Send me SMS match reminders</span>
                        </label>
                    </div>

                    ${entryFee > 0 ? `
                        <div class="fee-display">
                            <div style="color: var(--text-dim); font-size: 12px; margin-bottom: 5px;">ENTRY FEE</div>
                            <div class="fee-amount">$${entryFee.toFixed(2)}</div>
                        </div>

                        <div class="payment-section">
                            <div class="payment-title">PAYMENT METHOD</div>
                            <label class="payment-option selected" onclick="selectPayment(this, 'paypal')">
                                <input type="radio" name="payment_method" value="paypal" checked>
                                <div>
                                    <div class="payment-label">Pay Now (PayPal)</div>
                                    <div class="payment-desc">Secure payment, instant confirmation</div>
                                </div>
                            </label>
                            <label class="payment-option" onclick="selectPayment(this, 'later')">
                                <input type="radio" name="payment_method" value="later">
                                <div>
                                    <div class="payment-label">Pay Later</div>
                                    <div class="payment-desc">Reserve your spot, pay before deadline</div>
                                </div>
                            </label>
                            <label class="payment-option" onclick="selectPayment(this, 'event')">
                                <input type="radio" name="payment_method" value="event">
                                <div>
                                    <div class="payment-label">Pay at Event</div>
                                    <div class="payment-desc">Cash or card at check-in</div>
                                </div>
                            </label>
                        </div>
                    ` : ''}

                    <button type="submit" class="submit-btn" id="submitBtn">REGISTER</button>
                </form>
            `;

            document.getElementById('modalBody').innerHTML = html;
        }

        window.selectPayment = function(el, method) {
            document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            el.querySelector('input').checked = true;
        };

        window.lookupPin = async function() {
            const pin = document.getElementById('memberPin').value.trim();
            if (pin.length !== 8) {
                alert('Please enter an 8-digit PIN');
                return;
            }

            try {
                const result = await callFunction('playerLogin', { pin: pin });
                if (result.success && result.player) {
                    memberData = result.player;
                    document.getElementById('regName').value = memberData.name || '';
                    document.getElementById('regEmail').value = memberData.email || '';
                    document.getElementById('regPhone').value = memberData.phone || '';
                    if (memberData.preferred_level) {
                        document.getElementById('regLevel').value = memberData.preferred_level;
                    }
                    alert('Welcome back, ' + memberData.name + '! Your info has been filled in.');
                } else {
                    alert('PIN not found. Please register as a new player.');
                }
            } catch (e) {
                alert('Error looking up PIN: ' + e.message);
            }
        };

        window.submitRegistration = async function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const btn = document.getElementById('submitBtn');
            const paymentMethod = formData.get('payment_method') || 'free';

            btn.disabled = true;
            btn.textContent = 'REGISTERING...';

            try {
                // Upload photo if selected
                let photoUrl = '';
                if (selectedRegPhoto) {
                    showLoading('Uploading photo...');
                    try {
                        photoUrl = await uploadImage(selectedRegPhoto, 'players');
                    } catch (uploadError) {
                        console.error('Photo upload failed:', uploadError);
                    }
                    hideLoading();
                }

                showLoading('Registering...');
                const result = await callFunction('registerForLeague', {
                    league_id: leagueId,
                    full_name: formData.get('full_name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    skill_level: formData.get('skill_level') || null,
                    sms_opt_in: formData.get('sms_opt_in') ? true : false,
                    payment_method: paymentMethod,
                    member_pin: memberData?.pin || null,
                    photo_url: photoUrl
                });
                hideLoading();

                if (!result.success) {
                    throw new Error(result.error || 'Registration failed');
                }

                // If PayPal selected, redirect to payment
                if (paymentMethod === 'paypal' && result.paypal_url) {
                    window.location.href = result.paypal_url;
                    return;
                }

                showSuccess(result);

            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'REGISTER';
            }
        };

        function showSuccess(result) {
            const html = `
                <div class="success-content">
                    <div class="success-icon"></div>
                    <div class="success-title">YOU'RE REGISTERED!</div>
                    <div class="success-message">
                        ${result.waitlist ? 'You\'ve been added to the waitlist. We\'ll notify you if a spot opens.' :
                          result.payment_status === 'pending' ? 'Your spot is reserved! Please complete payment before the deadline.' :
                          'Welcome to the league! Check your email for confirmation details.'}
                    </div>
                    ${result.player_pin ? `
                        <div class="pin-display-box">
                            <div class="pin-display-label">YOUR PIN (SAVE THIS!)</div>
                            <div class="pin-display-value">${result.player_pin}</div>
                        </div>
                    ` : ''}
                    <button class="submit-btn" onclick="closeModal(); location.reload();">DONE</button>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = html;
        }

        function showError(message) {
            document.getElementById('mainContent').innerHTML = `
                <div class="error-message">
                    <strong>Error</strong><br>${message}
                </div>
            `;
        }
    </script>
    <script src="/js/stats-helpers.js"></script>
    <script src="/js/nav-menu.js"></script>
    <script src="/js/feedback.js"></script>
</body>
</html>
