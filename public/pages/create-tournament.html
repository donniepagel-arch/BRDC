<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Create Tournament - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FF469A">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap');

        :root {
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --text-light: #f0f0f0;
            --text-dim: #8a8aa3;
            --text-muted: #666;
            --border-color: rgba(255,255,255,0.15);
            --border-strong: #000;
            --glow-pink: rgba(255, 70, 154, 0.3);
            --glow-teal: rgba(145, 215, 235, 0.3);
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { min-height: 100%; }
        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            color: var(--text-light);
            line-height: 1.6;
        }

        /* Background Pattern */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            padding-bottom: 120px;
        }

        /* Header Bar */
        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .back-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 16px;
            font-weight: 700;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--pink);
        }

        .header-logo {
            width: 40px;
            height: 40px;
            
        }

        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 3px;
            color: var(--pink);
        }

        /* Inline PIN Sign In */
        .pin-signin-container {
            background: rgba(253, 216, 53, 0.1);
            border: 2px solid var(--yellow);
            border-radius: 10px;
            padding: 12px 16px;
        }
        .pin-signin-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .pin-signin-label {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            color: var(--yellow);
        }
        .pin-signin-input-group {
            display: flex;
            flex: 1;
            min-width: 200px;
            gap: 8px;
        }
        .pin-signin-input {
            flex: 1;
            padding: 10px 14px;
            background: var(--bg-card);
            border: 2px solid var(--border-strong);
            border-radius: 6px;
            color: var(--text-light);
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 3px;
            text-align: center;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }
        .pin-signin-input:focus {
            outline: none;
            border-color: var(--yellow);
        }
        .pin-signin-input::placeholder {
            font-size: 14px;
            letter-spacing: 0;
            color: var(--text-muted);
        }
        .pin-signin-btn {
            padding: 10px 20px;
            background: var(--yellow);
            border: 2px solid var(--border-strong);
            border-radius: 6px;
            color: #000;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            transition: all 0.15s;
        }
        .pin-signin-btn:hover {
            transform: translateY(-1px);
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
        }
        .pin-signin-btn:active {
            transform: translateY(1px);
            box-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }
        .pin-signin-status {
            margin-top: 10px;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
        }
        .pin-signin-status.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        .pin-signin-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .pin-signin-status.loading {
            background: rgba(145, 215, 235, 0.2);
            color: var(--teal);
        }

        /* Modal (for templates) */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-card {
            background: var(--bg-panel);
            border: 3px solid var(--border-strong);
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--yellow), #f9a825);
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            letter-spacing: 2px;
            color: #000;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: #000;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-body .form-group {
            margin-bottom: 16px;
        }

        .modal-body .btn-submit {
            width: 100%;
            margin-top: 8px;
        }

        /* Form Card */
        .form-card {
            background: var(--bg-panel);
            border: 4px solid var(--border-strong);
            border-radius: 16px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        /* Section */
        .section {
            padding: 30px;
            border-bottom: 3px solid var(--border-strong);
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
        }

        .section-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--pink), #d63384);
            border: 3px solid var(--border-strong);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.5);
        }

        .section-icon.teal {
            background: linear-gradient(135deg, var(--teal), #5ab8d4);
        }

        .section-icon.yellow {
            background: linear-gradient(135deg, var(--yellow), #f9a825);
        }

        .section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 26px;
            letter-spacing: 2px;
            color: var(--pink);
        }

        .section-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label, .form-label {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            color: var(--teal);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        label .required, .form-label .required {
            color: var(--pink);
        }

        .form-label.required::after {
            content: ' *';
            color: var(--pink);
        }

        input, select, textarea, .input-field {
            padding: 12px 16px;
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 8px;
            color: var(--text-light);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3);
        }

        input:focus, select:focus, textarea:focus, .input-field:focus {
            outline: none;
            border-color: var(--teal);
            box-shadow: 0 0 0 3px var(--glow-teal);
        }

        input::placeholder, .input-field::placeholder {
            color: var(--text-muted);
        }

        select {
            cursor: pointer;
        }

        textarea, textarea.input-field {
            resize: vertical;
            min-height: 80px;
            line-height: 1.5;
        }

        .helper-text {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Event Card */
        .event-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.4);
            position: relative;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .event-number {
            font-family: 'Bebas Neue', cursive;
            font-size: 26px;
            color: var(--yellow);
            letter-spacing: 2px;
        }

        .btn-remove {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 8px 16px;
            border: 2px solid #000;
            border-radius: 6px;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.4);
        }

        .btn-remove:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* Config Row (from game-setup) */
        .config-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .config-row:last-child {
            border-bottom: none;
        }

        .config-label {
            color: rgba(255,255,255,0.8);
            font-weight: 600;
            font-size: 14px;
        }

        .config-select {
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 14px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            min-width: 150px;
            cursor: pointer;
        }

        .config-select:focus {
            outline: none;
            border-color: var(--pink);
        }

        .config-select option {
            background: var(--bg-dark);
        }

        .config-select.mini {
            min-width: 60px;
            padding: 10px 8px;
        }

        .config-input {
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 14px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            width: 80px;
            text-align: center;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--pink);
        }

        /* Toggle Group (from game-setup) */
        .toggle-group {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            padding: 3px;
        }

        .toggle-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.5);
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .toggle-btn.active {
            background: var(--pink);
            color: white;
        }

        /* Subsection */
        .subsection {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 14px;
            margin-top: 12px;
        }

        .subsection-title {
            font-weight: 700;
            font-size: 13px;
            color: var(--yellow);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        /* Mixed Config */
        .mixed-config {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .mixed-leg-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(0,0,0,0.25);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .leg-label {
            font-weight: 700;
            color: var(--yellow);
            min-width: 45px;
            font-size: 13px;
        }

        .mixed-leg-row .config-select.game-type-select {
            width: 100px;
            min-width: 100px;
            flex-shrink: 0;
        }

        .x01-inline {
            display: flex;
            gap: 6px;
            flex: 1;
        }

        .x01-inline .config-input {
            width: 70px;
            min-width: 70px;
        }

        /* Starter Row */
        .starter-row {
            margin-top: 12px;
            padding: 12px;
            background: rgba(253,216,53,0.1);
            border-radius: 8px;
            border: 1px solid rgba(253,216,53,0.3);
        }

        .starter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .starter-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .starter-btn.active {
            border-color: var(--yellow);
            background: rgba(253,216,53,0.2);
            color: var(--yellow);
        }

        /* In/Out Grid */
        .in-out-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Number Spinner/Scroll Picker */
        .number-spinner {
            display: inline-flex;
            align-items: center;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            height: 38px;
        }
        .number-spinner .spin-btn {
            width: 30px;
            height: 100%;
            background: rgba(255,255,255,0.08);
            border: none;
            color: var(--text-light);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            user-select: none;
        }
        .number-spinner .spin-btn:hover {
            background: var(--pink);
            color: white;
        }
        .number-spinner .spin-btn:active {
            background: #d63384;
        }
        .number-spinner .spin-value {
            min-width: 45px;
            padding: 6px 10px;
            text-align: center;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-light);
            background: transparent;
            border: none;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        .number-spinner.odd-only .spin-value {
            color: var(--yellow);
        }

        /* Disabled toggle group */
        .toggle-group.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .toggle-group.disabled .toggle-btn {
            cursor: not-allowed;
        }

        /* Buttons */
        .btn-add-event {
            background: linear-gradient(180deg, var(--teal) 0%, #6bc0d4 100%);
            color: #000;
            padding: 14px 24px;
            border: 3px solid #000;
            border-radius: 8px;
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 2px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
            transition: all 0.2s;
        }

        .btn-add-event:hover {
            transform: translateY(-2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        .btn-add-event:active {
            transform: translateY(2px);
            box-shadow: 2px 2px 0 rgba(0,0,0,0.4);
        }

        /* Footer */
        .footer-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to top, var(--bg-dark) 80%, transparent);
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .btn-cancel {
            padding: 18px 30px;
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 10px;
            color: var(--text-light);
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
            transition: all 0.2s;
        }

        .btn-cancel:hover {
            border-color: var(--teal);
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,0.5);
        }

        .btn-submit {
            padding: 18px 40px;
            background: linear-gradient(135deg, var(--pink), #d63384);
            border: 4px solid var(--border-strong);
            border-radius: 12px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.5);
        }

        .btn-submit:hover {
            transform: translate(-3px, -3px);
            box-shadow: 9px 9px 0 rgba(0, 0, 0, 0.5);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Template & Draft Buttons */
        .template-draft-section {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .secondary-btn {
            padding: 12px 20px;
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.4);
        }

        .secondary-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.4);
        }

        .secondary-btn.template-btn {
            border-color: var(--teal);
            color: var(--teal);
        }

        .secondary-btn.draft-btn {
            border-color: var(--yellow);
            color: var(--yellow);
        }

        /* Template Modal */
        .template-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 16px 0;
        }

        .template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-item:hover {
            border-color: var(--teal);
            background: rgba(145, 215, 235, 0.1);
        }

        .template-item .template-name {
            font-weight: 700;
            color: var(--text-primary);
        }

        .template-item .template-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .template-item .template-delete {
            background: rgba(239, 68, 68, 0.2);
            border: none;
            color: #ef4444;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .no-templates {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .config-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .config-select, .toggle-group {
                width: 100%;
            }

            .mixed-leg-row {
                flex-wrap: wrap;
            }

            .footer-actions {
                flex-direction: column;
            }

            .btn-cancel, .btn-submit {
                width: 100%;
                max-width: 400px;
                margin: 0 auto;
            }
        }

        @media (max-width: 480px) {
            .form-card { padding: 16px; margin: 10px; }
            .form-section { padding: 16px; margin-bottom: 16px; }
            .form-section-title { font-size: 18px; }
            .form-label { font-size: 13px; }
            .config-select, .form-input, .toggle-btn { min-height: 44px; }
            .toggle-btn { padding: 10px 12px; font-size: 12px; }
            .back-btn { min-height: 44px; padding: 10px 16px; }
            .header-bar { padding: 12px 15px; }
            .header-title { font-size: 22px; }
        }

        /* Success Page */
        .success-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .success-card {
            background: var(--bg-panel);
            border: 4px solid var(--pink);
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            text-align: center;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.5);
        }

        .success-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .success-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 42px;
            color: var(--pink);
            letter-spacing: 3px;
            margin-bottom: 20px;
        }

        .pin-display {
            background: var(--yellow);
            border: 4px solid #000;
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        .pin-label {
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            color: #000;
            margin-bottom: 8px;
        }

        .pin-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 64px;
            color: #000;
        }

        .pin-hint {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        .success-link {
            display: inline-block;
            background: linear-gradient(180deg, var(--success) 0%, #16a34a 100%);
            color: white;
            padding: 18px 36px;
            border: 3px solid #000;
            border-radius: 10px;
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            letter-spacing: 2px;
            text-decoration: none;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.4);
            margin-top: 20px;
        }

        /* Form Validation Styles */
        input.invalid, select.invalid, textarea.invalid {
            border-color: var(--danger) !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
        }

        input.valid, select.valid {
            border-color: var(--success) !important;
        }

        .error-message {
            color: var(--danger);
            font-size: 12px;
            font-weight: 600;
            margin-top: 4px;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        .form-group.has-error .error-message {
            display: block;
        }

        .form-group.has-error input,
        .form-group.has-error select,
        .form-group.has-error textarea {
            border-color: var(--danger) !important;
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <button class="back-btn" onclick="window.location.href='/'">BACK</button>
        <img src="/images/gold_logo.png" alt="BRDC" class="header-logo">
        <h1 class="header-title">CREATE TOURNAMENT</h1>
    </div>

    <div class="container">
        <form id="tournamentForm" class="form-card">
            <!-- Director Information (FIRST) -->
            <div class="section">
                <div class="section-header">
                    <div class="section-icon">&#128100;</div>
                    <div>
                        <div class="section-title">TOURNAMENT DIRECTOR</div>
                        <div class="section-subtitle">Your info for managing the tournament</div>
                    </div>
                </div>
                <div class="form-grid">
                    <!-- PIN Input FIRST -->
                    <div class="form-group full-width" style="margin-bottom: 8px;">
                        <div class="pin-signin-container" id="pinSigninContainer">
                            <div class="pin-signin-row" id="pinSigninRow">
                                <div class="pin-signin-label">Already a member?</div>
                                <div class="pin-signin-input-group">
                                    <input type="password" id="signInPin" class="pin-signin-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="8" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
                                    <button type="button" class="pin-signin-btn" onclick="lookupDirector()">GO</button>
                                </div>
                            </div>
                            <div id="signInStatus" class="pin-signin-status" style="display: none;"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>First Name <span class="required">*</span></label>
                        <input type="text" name="director_first" id="directorFirstName" required placeholder="First Name">
                    </div>
                    <div class="form-group">
                        <label>Last Name <span class="required">*</span></label>
                        <input type="text" name="director_last" id="directorLastName" required placeholder="Last Name">
                    </div>
                    <div class="form-group">
                        <label>Director Email <span class="required">*</span></label>
                        <input type="email" name="director_email" id="directorEmail" required placeholder="you@email.com">
                        <span class="helper-text">Used for PIN recovery & notifications</span>
                    </div>
                    <div class="form-group">
                        <label>Director Phone <span class="required">*</span></label>
                        <input type="tel" name="director_phone" id="directorPhone" required placeholder="(555) 123-4567">
                    </div>
                </div>
                <input type="hidden" name="director_player_id" id="directorPlayerId" value="">
            </div>

            <!-- Tournament Details -->
            <div class="section">
                <div class="section-header">
                    <div class="section-icon teal">&#127919;</div>
                    <div>
                        <div class="section-title">TOURNAMENT INFORMATION</div>
                        <div class="section-subtitle">Basic details about your tournament</div>
                    </div>
                </div>
                <div class="form-grid">
                    <!-- Tournament Format Preset Selector -->
                    <div class="form-group full-width">
                        <label>Tournament Format Preset</label>
                        <select id="tournamentPreset" onchange="applyTournamentPreset()" style="background: var(--bg-card); border: 2px solid var(--border-color); color: var(--text-light); padding: 12px; border-radius: 8px; font-size: 14px; cursor: pointer;">
                            <option value="">-- Custom / Standard --</option>
                            <option value="heartbreaker">ðŸ’” Heartbreaker (Mixed Doubles Matchmaker)</option>
                        </select>
                        <span class="helper-text" id="presetDescription" style="display: none; color: var(--yellow); margin-top: 8px;"></span>
                    </div>

                    <div class="form-group full-width">
                        <label>Tournament Name <span class="required">*</span></label>
                        <input type="text" name="tournament_name" required placeholder="Weekly Tournament">
                    </div>
                    <div class="form-group full-width">
                        <label>Tournament Image</label>
                        <div class="image-uploader" id="tournamentImageUploader">
                            <input type="file" id="tournamentImageInput" accept="image/*">
                            <div id="tournamentImagePlaceholder">
                                <div class="image-uploader-icon">ðŸ“·</div>
                                <div class="image-uploader-text">Click or drag to upload image</div>
                                <div class="image-uploader-hint">PNG, JPG up to 5MB</div>
                            </div>
                            <div id="tournamentImagePreviewContainer" class="image-preview-container" style="display: none;">
                                <img id="tournamentImagePreview" class="image-preview" alt="Preview">
                                <button type="button" class="image-remove-btn" onclick="removeTournamentImage()">&times;</button>
                            </div>
                        </div>
                        <span class="helper-text">Optional banner image displayed on the tournament card</span>
                    </div>
                    <div class="form-group">
                        <label>Venue / Location <span class="required">*</span></label>
                        <input type="text" name="venue_name" required placeholder="Rookies Sports Bar">
                    </div>
                    <div class="form-group">
                        <label>Venue Address</label>
                        <input type="text" name="venue_address" placeholder="123 Main St, City, State">
                    </div>
                    <div class="form-group">
                        <label>Date <span class="required">*</span></label>
                        <input type="date" name="tournament_date" required>
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <input type="time" name="tournament_time">
                    </div>
                    <div class="form-group full-width">
                        <label>Tournament Details / Special Info</label>
                        <textarea name="tournament_details" rows="3" placeholder="Any special rules or info..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Events Section -->
            <div class="section">
                <div class="section-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="section-icon yellow">&#127942;</div>
                        <div>
                            <div class="section-title">EVENTS</div>
                            <div class="section-subtitle">Configure tournament events</div>
                        </div>
                    </div>
                </div>
                <div id="eventsContainer"></div>
                <div id="permissionLimitsMsg" style="display: none; background: rgba(253, 216, 53, 0.1); border: 2px solid var(--yellow); padding: 12px; border-radius: 8px; margin-top: 16px; font-size: 13px; color: #aaa;">
                    <span style="color: var(--yellow); font-weight: bold;">LIMIT:</span> <span id="limitsText"></span>
                </div>
                <button type="button" class="btn-add-event" id="addEventBtn" onclick="addEvent()" style="margin-top: 16px; width: 100%;">+ ADD EVENT</button>
            </div>
        </form>
    </div>

    <div class="footer-actions">
        <!-- Template & Draft Options (only visible when signed in) -->
        <div id="templateDraftSection" class="template-draft-section">
            <button type="button" class="secondary-btn template-btn" onclick="saveAsTemplate()">
                ðŸ“‹ SAVE AS TEMPLATE
            </button>
            <button type="button" class="secondary-btn template-btn" onclick="openTemplateModal()">
                ðŸ“‚ LOAD TEMPLATE
            </button>
            <button type="button" class="secondary-btn draft-btn" onclick="saveAsDraft()">
                ðŸ’¾ SAVE AS DRAFT
            </button>
        </div>
        <button type="button" class="btn-cancel" onclick="window.location.href='/'">CANCEL</button>
        <button type="button" class="btn-submit" id="submitBtn" onclick="submitTournament()">CREATE TOURNAMENT</button>
    </div>

    <!-- Template Modal -->
    <div id="templateModal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <div class="modal-header">
                <h3>MY TEMPLATES</h3>
                <button type="button" class="modal-close" onclick="closeTemplateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-dim);">Select a template to load its settings</p>
                <div id="templateList" class="template-list">
                    <div class="no-templates">Loading templates...</div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
import { callFunction, showLoading, hideLoading, uploadImage } from '/js/firebase-config.js';

let eventCounter = 0;
let tournamentImageFile = null;
const eventImageFiles = {}; // Map of eventId -> File

// State for each event's leg configuration
const eventConfigs = {};

// ===== FORM VALIDATION =====

// Set minimum date to today
document.addEventListener('DOMContentLoaded', () => {
    const dateInput = document.querySelector('[name="tournament_date"]');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.min = today;
    }
    setupValidation();
});

// Setup real-time validation
function setupValidation() {
    // Tournament name validation (min 3 chars)
    const nameInput = document.querySelector('[name="tournament_name"]');
    if (nameInput) {
        nameInput.addEventListener('input', () => validateField(nameInput, validateTournamentName));
        nameInput.addEventListener('blur', () => validateField(nameInput, validateTournamentName));
    }

    // Date validation (must be in future)
    const dateInput = document.querySelector('[name="tournament_date"]');
    if (dateInput) {
        dateInput.addEventListener('change', () => validateField(dateInput, validateFutureDate));
    }

    // Email validation
    const emailInput = document.querySelector('[name="director_email"]');
    if (emailInput) {
        emailInput.addEventListener('blur', () => validateField(emailInput, validateEmail));
    }

    // Entry fee validation (added to each event dynamically)
}

function validateTournamentName(value) {
    if (!value || value.trim().length < 3) {
        return 'Tournament name must be at least 3 characters';
    }
    return null;
}

function validateFutureDate(value) {
    if (!value) {
        return 'Please select a date';
    }
    const selected = new Date(value + 'T00:00:00');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    if (selected < today) {
        return 'Date must be today or in the future';
    }
    return null;
}

function validateEmail(value) {
    if (!value) return null; // Required handled by HTML
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(value)) {
        return 'Please enter a valid email address';
    }
    return null;
}

function validateField(input, validatorFn) {
    const value = input.value;
    const error = validatorFn(value);
    const formGroup = input.closest('.form-group');

    // Find or create error message element
    let errorEl = formGroup?.querySelector('.error-message');
    if (!errorEl && formGroup) {
        errorEl = document.createElement('div');
        errorEl.className = 'error-message';
        formGroup.appendChild(errorEl);
    }

    if (error) {
        input.classList.add('invalid');
        input.classList.remove('valid');
        if (errorEl) {
            errorEl.textContent = error;
            errorEl.classList.add('visible');
        }
        return false;
    } else {
        input.classList.remove('invalid');
        if (value) input.classList.add('valid');
        if (errorEl) {
            errorEl.textContent = '';
            errorEl.classList.remove('visible');
        }
        return true;
    }
}

// Validate entire form before submit
window.validateForm = function() {
    let isValid = true;

    // Validate tournament name
    const nameInput = document.querySelector('[name="tournament_name"]');
    if (nameInput && !validateField(nameInput, validateTournamentName)) {
        isValid = false;
    }

    // Validate date
    const dateInput = document.querySelector('[name="tournament_date"]');
    if (dateInput && !validateField(dateInput, validateFutureDate)) {
        isValid = false;
    }

    // Validate email
    const emailInput = document.querySelector('[name="director_email"]');
    if (emailInput && !validateField(emailInput, validateEmail)) {
        isValid = false;
    }

    // Validate entry fees for all events are non-negative
    document.querySelectorAll('[id^="entryFee_"]').forEach(input => {
        const value = parseFloat(input.value);
        if (isNaN(value) || value < 0) {
            input.classList.add('invalid');
            isValid = false;
        }
    });

    return isValid;
};

// Tournament image handling
const tournamentImageInput = document.getElementById('tournamentImageInput');
tournamentImageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            alert('Image must be less than 5MB');
            return;
        }
        tournamentImageFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('tournamentImagePreview').src = e.target.result;
            document.getElementById('tournamentImagePreviewContainer').style.display = 'inline-block';
            document.getElementById('tournamentImagePlaceholder').style.display = 'none';
            document.getElementById('tournamentImageUploader').classList.add('has-image');
        };
        reader.readAsDataURL(file);
    }
});

window.removeTournamentImage = function() {
    tournamentImageFile = null;
    document.getElementById('tournamentImageInput').value = '';
    document.getElementById('tournamentImagePreview').src = '';
    document.getElementById('tournamentImagePreviewContainer').style.display = 'none';
    document.getElementById('tournamentImagePlaceholder').style.display = 'flex';
    document.getElementById('tournamentImageUploader').classList.remove('has-image');
};

// Event image handling
window.handleEventImageChange = function(eventId, input) {
    const file = input.files[0];
    if (file) {
        if (file.size > 5 * 1024 * 1024) {
            alert('Image must be less than 5MB');
            return;
        }
        eventImageFiles[eventId] = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById(`eventImagePreview_${eventId}`).src = e.target.result;
            document.getElementById(`eventImagePreviewContainer_${eventId}`).style.display = 'inline-block';
            document.getElementById(`eventImagePlaceholder_${eventId}`).style.display = 'none';
            document.getElementById(`eventImageUploader_${eventId}`).classList.add('has-image');
        };
        reader.readAsDataURL(file);
    }
};

window.removeEventImage = function(eventId) {
    delete eventImageFiles[eventId];
    document.getElementById(`eventImageInput_${eventId}`).value = '';
    document.getElementById(`eventImagePreview_${eventId}`).src = '';
    document.getElementById(`eventImagePreviewContainer_${eventId}`).style.display = 'none';
    document.getElementById(`eventImagePlaceholder_${eventId}`).style.display = 'flex';
    document.getElementById(`eventImageUploader_${eventId}`).classList.remove('has-image');
};

// Check for saved director session on page load
(function restoreSession() {
    const saved = localStorage.getItem('directorSession');
    if (saved) {
        try {
            const session = JSON.parse(saved);
            // Session valid for 7 days
            if (session.pin && session.player && (Date.now() - session.timestamp) < 7 * 24 * 60 * 60 * 1000) {
                window.directorPin = session.pin;
                const player = session.player;

                // Restore permissions
                window.userPermissions = session.permissions || {
                    can_create_leagues: false,
                    can_create_tournaments: true,
                    max_tournament_players: 8,
                    max_tournament_events: 2
                };
                window.isAdmin = session.isAdmin || false;

                // Auto-fill director info
                if (player.first_name) {
                    document.getElementById('directorFirstName').value = player.first_name;
                }
                if (player.last_name) {
                    document.getElementById('directorLastName').value = player.last_name;
                } else if (player.name) {
                    const nameParts = player.name.trim().split(/\s+/);
                    document.getElementById('directorFirstName').value = nameParts[0] || '';
                    document.getElementById('directorLastName').value = nameParts.slice(1).join(' ') || '';
                }
                document.getElementById('directorEmail').value = player.email || '';
                document.getElementById('directorPhone').value = player.phone || '';
                document.getElementById('directorPlayerId').value = player.player_id || '';

                // Apply permission limits after DOM is ready
                setTimeout(() => applyPermissionLimits(), 100);
            } else {
                // Session expired, clear it
                localStorage.removeItem('directorSession');
            }
        } catch (e) {
            console.error('Error restoring session:', e);
            localStorage.removeItem('directorSession');
        }
    }
})();

// Handle Enter key on PIN input
document.getElementById('signInPin').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        lookupDirector();
    }
});

// Director PIN lookup
window.lookupDirector = async function() {
    const pin = document.getElementById('signInPin').value;
    const statusEl = document.getElementById('signInStatus');

    if (!pin || pin.length !== 8) {
        statusEl.textContent = 'Please enter an 8-digit PIN';
        statusEl.className = 'pin-signin-status error';
        statusEl.style.display = 'block';
        return;
    }

    try {
        statusEl.textContent = 'Looking up...';
        statusEl.className = 'pin-signin-status loading';
        statusEl.style.display = 'block';

        const result = await callFunction('playerLogin', { pin: pin });

        if (result.success && result.player) {
            const player = result.player;

            // Handle first/last name - split if only name is available
            if (player.first_name && player.last_name) {
                document.getElementById('directorFirstName').value = player.first_name;
                document.getElementById('directorLastName').value = player.last_name;
            } else if (player.name) {
                const nameParts = player.name.trim().split(/\s+/);
                if (nameParts.length >= 2) {
                    document.getElementById('directorFirstName').value = nameParts[0];
                    document.getElementById('directorLastName').value = nameParts.slice(1).join(' ');
                } else {
                    document.getElementById('directorFirstName').value = player.name;
                    document.getElementById('directorLastName').value = '';
                }
            }

            document.getElementById('directorEmail').value = player.email || '';
            document.getElementById('directorPhone').value = player.phone || '';
            document.getElementById('directorPlayerId').value = player.player_id || '';

            statusEl.textContent = `Welcome back, ${player.first_name || player.name}!`;
            statusEl.className = 'pin-signin-status success';

            // Store director PIN for template/draft functions
            window.directorPin = pin;

            // Fetch and store permissions
            try {
                const permResult = await callFunction('getMemberPermissions', { player_pin: pin });
                if (permResult.success) {
                    window.userPermissions = permResult.permissions;
                    window.isAdmin = permResult.isAdmin;
                    applyPermissionLimits();
                }
            } catch (e) {
                // Default permissions if fetch fails
                window.userPermissions = {
                    can_create_leagues: false,
                    can_create_tournaments: true,
                    max_tournament_players: 8,
                    max_tournament_events: 2
                };
                window.isAdmin = false;
                applyPermissionLimits();
            }

            // Save session to localStorage for persistence
            localStorage.setItem('directorSession', JSON.stringify({
                pin: pin,
                player: player,
                permissions: window.userPermissions,
                isAdmin: window.isAdmin,
                timestamp: Date.now()
            }));

            // Show template/draft section
            document.getElementById('templateDraftSection').style.display = 'flex';

            // Check for existing draft
            checkForDraft();

            // Hide status after a delay
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        } else {
            statusEl.textContent = 'PIN not found. Please check and try again.';
            statusEl.className = 'pin-signin-status error';
        }
    } catch (error) {
        statusEl.textContent = 'Lookup failed. Please try again.';
        statusEl.className = 'pin-signin-status error';
    }
};

// Apply Tournament Preset
window.applyTournamentPreset = function() {
    const presetSelect = document.getElementById('tournamentPreset');
    const preset = presetSelect.value;
    const descriptionEl = document.getElementById('presetDescription');

    if (preset === 'heartbreaker') {
        // Show description
        descriptionEl.textContent = 'ðŸ’” Heartbreaker: Mixed doubles matchmaker tournament with partner matching, breakup mechanics after Winners Round 1, cricket (best of 3) in winners bracket, 501 (best of 1) in losers bracket. Perfect for social darts with a competitive edge!';
        descriptionEl.style.display = 'block';

        // Auto-populate venue (default)
        const venueNameField = document.querySelector('[name="venue_name"]');
        if (venueNameField && !venueNameField.value) {
            venueNameField.value = 'Rookies';
        }

        // Auto-populate tournament details
        const detailsField = document.querySelector('[name="tournament_details"]');
        if (detailsField && !detailsField.value) {
            detailsField.value = 'Heartbreaker Format:\n\n' +
                'â€¢ Mixed Doubles (register as team or single - singles get matched)\n' +
                'â€¢ Double Elimination bracket\n' +
                'â€¢ Winners Bracket: Cricket (best of 3)\n' +
                'â€¢ Losers Bracket: 501 (best of 1)\n' +
                'â€¢ Breakup mechanic: After losing in Winners Round 1, players can opt to switch partners during the mingle period\n' +
                'â€¢ Savage loss summaries enabled\n' +
                'â€¢ 12 boards available';
        }

        // Note: The actual matchmaker settings (partner_matching, breakup_enabled, etc.)
        // will be handled by the backend createHeartbreakerTournament function
        // This frontend preset just provides helpful context for the tournament director

    } else {
        // Clear description
        descriptionEl.textContent = '';
        descriptionEl.style.display = 'none';
    }
};

window.onload = function() {
    window.addEvent();
};

// Apply permission-based limits to the tournament creator
window.applyPermissionLimits = function() {
    const perms = window.userPermissions || {
        can_create_tournaments: true,
        max_tournament_players: 8,
        max_tournament_events: 2
    };
    const isAdmin = window.isAdmin || false;

    // Show limits message for non-admin users
    if (!isAdmin && (perms.max_tournament_events < 99 || perms.max_tournament_players < 999)) {
        const limitsMsg = document.getElementById('permissionLimitsMsg');
        const limitsText = document.getElementById('limitsText');
        if (limitsMsg && limitsText) {
            limitsText.textContent = `Max ${perms.max_tournament_events} events, ${perms.max_tournament_players} players per event. Contact admin for higher limits.`;
            limitsMsg.style.display = 'block';
        }
    }

    // Update Add Event button state
    updateAddEventButton();
};

// Get current event count from DOM
window.getCurrentEventCount = function() {
    const container = document.getElementById('eventsContainer');
    return container ? container.querySelectorAll('.event-card').length : 0;
};

// Update Add Event button based on current event count and permissions
window.updateAddEventButton = function() {
    const addEventBtn = document.getElementById('addEventBtn');
    if (!addEventBtn) return;

    const perms = window.userPermissions || { max_tournament_events: 2 };
    const isAdmin = window.isAdmin || false;
    const maxEvents = isAdmin ? 99 : perms.max_tournament_events;
    const currentCount = getCurrentEventCount();

    if (currentCount >= maxEvents) {
        addEventBtn.disabled = true;
        addEventBtn.style.opacity = '0.5';
        addEventBtn.style.cursor = 'not-allowed';
        addEventBtn.textContent = `EVENT LIMIT REACHED (${maxEvents})`;
    } else {
        addEventBtn.disabled = false;
        addEventBtn.style.opacity = '1';
        addEventBtn.style.cursor = 'pointer';
        addEventBtn.textContent = '+ ADD EVENT';
    }
};

window.addEvent = function() {
    // Check permission limit
    const perms = window.userPermissions || { max_tournament_events: 2 };
    const isAdmin = window.isAdmin || false;
    const maxEvents = isAdmin ? 99 : perms.max_tournament_events;
    const currentCount = getCurrentEventCount();

    if (currentCount >= maxEvents) {
        alert(`You can only create up to ${maxEvents} events. Contact admin for higher limits.`);
        return;
    }

    eventCounter++;
    const eventId = eventCounter;
    const container = document.getElementById('eventsContainer');

    // Initialize config for this event
    eventConfigs[eventId] = {
        legMode: 'best-of',
        numLegs: 3,
        mixedLegs: [],
        selectedStarter: 'home'
    };

    const html = `
        <div class="event-card" id="event-${eventId}">
            <div class="event-header">
                <h3 class="event-number">EVENT ${eventId}</h3>
                ${eventId > 1 ? `<button type="button" class="btn-remove" onclick="removeEvent(${eventId})">REMOVE</button>` : ''}
            </div>

            <!-- Event Basics -->
            <div class="grid-2">
                <div class="form-group full-width">
                    <label class="form-label required">Event Name</label>
                    <input type="text" name="events[${eventId}][event_name]" id="eventName_${eventId}" required class="input-field" placeholder="Open Singles">
                </div>
                <div class="form-group">
                    <label class="form-label">Start Time</label>
                    <input type="time" name="events[${eventId}][start_time]" id="startTime_${eventId}" class="input-field">
                </div>
                <div class="form-group">
                    <label class="form-label required">Entry Fee ($)</label>
                    <input type="number" name="events[${eventId}][entry_fee]" id="entryFee_${eventId}" required min="0" value="10" step="0.01" class="input-field">
                </div>
            </div>

            <!-- Event Type & Format -->
            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label required">Event Type</label>
                    <select name="events[${eventId}][event_type]" id="eventType_${eventId}" required class="input-field">
                        <option value="">Select type...</option>
                        <option value="individual">Singles (1v1)</option>
                        <option value="doubles">Doubles (2v2)</option>
                        <option value="triples">Triples (3v3)</option>
                        <option value="blind_draw">Blind Draw</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required">Bracket Format</label>
                    <select name="events[${eventId}][format]" id="bracketFormat_${eventId}" required class="input-field">
                        <option value="single_elim">Single Elimination</option>
                        <option value="double_elim">Double Elimination</option>
                        <option value="round_robin">Round Robin</option>
                        <option value="swiss">Swiss System</option>
                    </select>
                </div>
            </div>

            <!-- Game Configuration (from game-setup) -->
            <div class="subsection">
                <div class="subsection-title">Game Configuration</div>

                <div class="config-row">
                    <span class="config-label">Number of Legs</span>
                    <div class="number-spinner" data-min="1" data-max="15" data-event="${eventId}" data-field="numLegs">
                        <button type="button" class="spin-btn" onclick="spinDown(${eventId}, 'numLegs')">âˆ’</button>
                        <span class="spin-value" id="numLegs_${eventId}">3</span>
                        <button type="button" class="spin-btn" onclick="spinUp(${eventId}, 'numLegs')">+</button>
                    </div>
                    <input type="hidden" name="events[${eventId}][num_legs]" id="numLegsInput_${eventId}" value="3">
                </div>

                <div class="config-row">
                    <span class="config-label">Leg Mode</span>
                    <div class="toggle-group" id="legModeToggle_${eventId}">
                        <button type="button" class="toggle-btn active" data-value="best-of" onclick="setLegMode(${eventId}, 'best-of')">Best Of</button>
                        <button type="button" class="toggle-btn" data-value="play-all" onclick="setLegMode(${eventId}, 'play-all')">Play All</button>
                    </div>
                </div>

                <div class="config-row" id="setsRow_${eventId}">
                    <span class="config-label">Number of Sets</span>
                    <div class="number-spinner" data-min="1" data-max="9" data-event="${eventId}" data-field="numSets">
                        <button type="button" class="spin-btn" onclick="spinDown(${eventId}, 'numSets')">âˆ’</button>
                        <span class="spin-value" id="numSets_${eventId}">1</span>
                        <button type="button" class="spin-btn" onclick="spinUp(${eventId}, 'numSets')">+</button>
                    </div>
                    <input type="hidden" name="events[${eventId}][num_sets]" id="numSetsInput_${eventId}" value="1">
                </div>

                <div class="config-row" id="setModeRow_${eventId}">
                    <span class="config-label">Set Mode</span>
                    <div class="toggle-group disabled" id="setModeToggle_${eventId}">
                        <button type="button" class="toggle-btn active" data-value="best-of" onclick="setSetMode(${eventId}, 'best-of')">Best Of</button>
                        <button type="button" class="toggle-btn" data-value="play-all" onclick="setSetMode(${eventId}, 'play-all')">Play All</button>
                    </div>
                </div>

                <div class="config-row" id="startRulesRow_${eventId}">
                    <span class="config-label">Start Rules</span>
                    <select class="config-select" id="startRules_${eventId}" onchange="handleStartRulesChange(${eventId})">
                        <option value="cork-every">Cork every leg</option>
                        <option value="alternate-cork">Alternate, cork first/deciding</option>
                        <option value="loser-cork">Loser starts, cork first/deciding</option>
                        <option value="winner-cork">Winner starts, cork first/deciding</option>
                        <option value="select-starter">Select starter</option>
                    </select>
                </div>

                <div class="starter-row" id="starterRow_${eventId}" style="display: none;">
                    <span class="config-label">Who starts first?</span>
                    <div class="starter-buttons">
                        <button type="button" class="starter-btn active" data-team="home" onclick="setStarter(${eventId}, 'home')">Home / Higher Seed</button>
                        <button type="button" class="starter-btn" data-team="away" onclick="setStarter(${eventId}, 'away')">Away / Lower Seed</button>
                    </div>
                </div>

                <!-- Cork Order (for Corks Choice games) -->
                <div class="config-row" id="corkOrderRow_${eventId}" style="display: none;">
                    <span class="config-label">Cork Order</span>
                    <select class="config-select" id="corkOrder_${eventId}">
                        <option value="alternate-random">Alternate, random first/deciding</option>
                        <option value="random-every">Random every leg</option>
                        <option value="loser-random">Loser throws first, random first/deciding</option>
                        <option value="winner-random">Winner throws first, random first/deciding</option>
                    </select>
                </div>

                <!-- Cork Winner Gets (for Corks Choice games) -->
                <div class="config-row" id="corkWinnerRow_${eventId}" style="display: none;">
                    <span class="config-label">Cork Winner Gets</span>
                    <select class="config-select" id="corkWinnerGets_${eventId}">
                        <option value="choose-and-start">Choose game AND start</option>
                        <option value="choose-only">Choose game only (other starts)</option>
                    </select>
                </div>

                <div class="config-row">
                    <span class="config-label">Game Type</span>
                    <select class="config-select" id="gameType_${eventId}" onchange="handleGameTypeChange(${eventId})">
                        <option value="501" selected>All 501</option>
                        <option value="301">All 301</option>
                        <option value="701">All 701</option>
                        <option value="cricket">All Cricket</option>
                        <option value="x01">All X01 (Custom)</option>
                        <option value="corks_choice">All Corks Choice</option>
                        <option value="mixed">Mixed</option>
                    </select>
                </div>

                <!-- X01 Options -->
                <div class="config-row" id="x01Options_${eventId}" style="display: none;">
                    <span class="config-label">X01 Settings</span>
                    <div class="in-out-row">
                        <input type="number" class="config-input" id="x01Score_${eventId}" value="501" min="101" max="1001" step="100">
                        <select class="config-select mini" id="inRule_${eventId}">
                            <option value="straight">SI</option>
                            <option value="double">DI</option>
                        </select>
                        <select class="config-select mini" id="outRule_${eventId}">
                            <option value="double" selected>DO</option>
                            <option value="straight">SO</option>
                            <option value="master">MO</option>
                        </select>
                    </div>
                </div>

                <!-- Standard X01 DI/DO -->
                <div class="config-row" id="standardX01Options_${eventId}">
                    <span class="config-label">In/Out Rules</span>
                    <div class="in-out-row">
                        <select class="config-select mini" id="standardInRule_${eventId}">
                            <option value="straight" selected>SI</option>
                            <option value="double">DI</option>
                        </select>
                        <select class="config-select mini" id="standardOutRule_${eventId}">
                            <option value="double" selected>DO</option>
                            <option value="straight">SO</option>
                            <option value="master">MO</option>
                        </select>
                    </div>
                </div>

                <!-- Mixed Config (per-leg) -->
                <div class="mixed-config" id="mixedConfig_${eventId}" style="display: none;"></div>
            </div>

            <!-- Playoff Round Settings -->
            <div class="subsection">
                <div class="subsection-title">Playoff Round Settings (Optional)</div>
                <p style="font-size: 12px; color: var(--text-dim); margin-bottom: 12px;">Configure different formats for semi-finals and finals</p>

                <div class="config-row">
                    <label class="checkbox-label">
                        <input type="checkbox" id="enablePlayoffSettings_${eventId}" onchange="togglePlayoffSettings(${eventId})">
                        <span>Use different settings for playoff rounds</span>
                    </label>
                </div>

                <div id="playoffSettings_${eventId}" style="display: none; margin-top: 12px;">
                    <!-- Semi-Finals Settings -->
                    <div style="background: rgba(145, 215, 235, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-family: 'Bebas Neue', cursive; color: var(--teal); margin-bottom: 12px; font-size: 18px;">SEMI-FINALS</div>

                        <div class="config-row">
                            <span class="config-label">Format</span>
                            <div class="toggle-group" id="semisFormatToggle_${eventId}">
                                <button type="button" class="toggle-btn active" data-value="legs" onclick="setPlayoffFormat(${eventId}, 'semis', 'legs')">Best of Legs</button>
                                <button type="button" class="toggle-btn" data-value="sets" onclick="setPlayoffFormat(${eventId}, 'semis', 'sets')">Best of Sets</button>
                            </div>
                        </div>

                        <div class="config-row" id="semisLegsRow_${eventId}">
                            <span class="config-label">Best of (Legs)</span>
                            <div class="number-spinner odd-only" data-min="1" data-max="15" data-odd="true">
                                <button type="button" class="spin-btn" onclick="spinOddDown(${eventId}, 'semisLegs')">âˆ’</button>
                                <span class="spin-value" id="semisLegs_${eventId}">3</span>
                                <button type="button" class="spin-btn" onclick="spinOddUp(${eventId}, 'semisLegs')">+</button>
                            </div>
                            <input type="hidden" name="events[${eventId}][semis_num_legs]" id="semisLegsInput_${eventId}" value="3">
                        </div>

                        <div class="config-row" id="semisSetsRow_${eventId}" style="display: none;">
                            <span class="config-label">Best of (Sets)</span>
                            <div class="number-spinner odd-only" data-min="1" data-max="9" data-odd="true">
                                <button type="button" class="spin-btn" onclick="spinOddDown(${eventId}, 'semisSets')">âˆ’</button>
                                <span class="spin-value" id="semisSets_${eventId}">3</span>
                                <button type="button" class="spin-btn" onclick="spinOddUp(${eventId}, 'semisSets')">+</button>
                            </div>
                            <input type="hidden" name="events[${eventId}][semis_num_sets]" id="semisSetsInput_${eventId}" value="3">
                        </div>

                        <div class="config-row" id="semisLegsPerSetRow_${eventId}" style="display: none;">
                            <span class="config-label">Legs per Set</span>
                            <div class="number-spinner odd-only" data-min="1" data-max="9" data-odd="true">
                                <button type="button" class="spin-btn" onclick="spinOddDown(${eventId}, 'semisLegsPerSet')">âˆ’</button>
                                <span class="spin-value" id="semisLegsPerSet_${eventId}">3</span>
                                <button type="button" class="spin-btn" onclick="spinOddUp(${eventId}, 'semisLegsPerSet')">+</button>
                            </div>
                            <input type="hidden" name="events[${eventId}][semis_legs_per_set]" id="semisLegsPerSetInput_${eventId}" value="3">
                        </div>
                    </div>

                    <!-- Finals Settings -->
                    <div style="background: rgba(255, 70, 154, 0.1); padding: 12px; border-radius: 8px;">
                        <div style="font-family: 'Bebas Neue', cursive; color: var(--pink); margin-bottom: 12px; font-size: 18px;">FINALS</div>

                        <div class="config-row">
                            <span class="config-label">Format</span>
                            <div class="toggle-group" id="finalsFormatToggle_${eventId}">
                                <button type="button" class="toggle-btn active" data-value="legs" onclick="setPlayoffFormat(${eventId}, 'finals', 'legs')">Best of Legs</button>
                                <button type="button" class="toggle-btn" data-value="sets" onclick="setPlayoffFormat(${eventId}, 'finals', 'sets')">Best of Sets</button>
                            </div>
                        </div>

                        <div class="config-row" id="finalsLegsRow_${eventId}">
                            <span class="config-label">Best of (Legs)</span>
                            <div class="number-spinner odd-only" data-min="1" data-max="15" data-odd="true">
                                <button type="button" class="spin-btn" onclick="spinOddDown(${eventId}, 'finalsLegs')">âˆ’</button>
                                <span class="spin-value" id="finalsLegs_${eventId}">5</span>
                                <button type="button" class="spin-btn" onclick="spinOddUp(${eventId}, 'finalsLegs')">+</button>
                            </div>
                            <input type="hidden" name="events[${eventId}][finals_num_legs]" id="finalsLegsInput_${eventId}" value="5">
                        </div>

                        <div class="config-row" id="finalsSetsRow_${eventId}" style="display: none;">
                            <span class="config-label">Best of (Sets)</span>
                            <div class="number-spinner odd-only" data-min="1" data-max="9" data-odd="true">
                                <button type="button" class="spin-btn" onclick="spinOddDown(${eventId}, 'finalsSets')">âˆ’</button>
                                <span class="spin-value" id="finalsSets_${eventId}">5</span>
                                <button type="button" class="spin-btn" onclick="spinOddUp(${eventId}, 'finalsSets')">+</button>
                            </div>
                            <input type="hidden" name="events[${eventId}][finals_num_sets]" id="finalsSetsInput_${eventId}" value="5">
                        </div>

                        <div class="config-row" id="finalsLegsPerSetRow_${eventId}" style="display: none;">
                            <span class="config-label">Legs per Set</span>
                            <div class="number-spinner odd-only" data-min="1" data-max="9" data-odd="true">
                                <button type="button" class="spin-btn" onclick="spinOddDown(${eventId}, 'finalsLegsPerSet')">âˆ’</button>
                                <span class="spin-value" id="finalsLegsPerSet_${eventId}">3</span>
                                <button type="button" class="spin-btn" onclick="spinOddUp(${eventId}, 'finalsLegsPerSet')">+</button>
                            </div>
                            <input type="hidden" name="events[${eventId}][finals_legs_per_set]" id="finalsLegsPerSetInput_${eventId}" value="3">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Event Details -->
            <div class="form-group" style="margin-top: 16px;">
                <label class="form-label">Event Details / Special Rules</label>
                <textarea name="events[${eventId}][event_details]" class="input-field" placeholder="Any special rules or handicaps..."></textarea>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', html);

    // Clone settings from previous event if this isn't the first event
    if (eventId > 1) {
        const prevId = eventId - 1;

        // Clone basic settings
        const prevEventType = document.getElementById(`eventType_${prevId}`);
        const prevBracketFormat = document.getElementById(`bracketFormat_${prevId}`);
        const prevEntryFee = document.getElementById(`entryFee_${prevId}`);
        const prevStartTime = document.getElementById(`startTime_${prevId}`);

        if (prevEventType) document.getElementById(`eventType_${eventId}`).value = prevEventType.value;
        if (prevBracketFormat) document.getElementById(`bracketFormat_${eventId}`).value = prevBracketFormat.value;
        if (prevEntryFee) document.getElementById(`entryFee_${eventId}`).value = prevEntryFee.value;
        if (prevStartTime && prevStartTime.value) document.getElementById(`startTime_${eventId}`).value = prevStartTime.value;

        // Clone game type selection
        const prevGameType = document.getElementById(`gameType_${prevId}`);
        if (prevGameType) document.getElementById(`gameType_${eventId}`).value = prevGameType.value;

        // Clone start rule
        const prevStartRule = document.getElementById(`startRule_${prevId}`);
        if (prevStartRule) document.getElementById(`startRule_${eventId}`).value = prevStartRule.value;

        // Clone in/out rules
        const prevInRule = document.getElementById(`inRule_${prevId}`);
        const prevOutRule = document.getElementById(`outRule_${prevId}`);
        if (prevInRule) document.getElementById(`inRule_${eventId}`).value = prevInRule.value;
        if (prevOutRule) document.getElementById(`outRule_${eventId}`).value = prevOutRule.value;

        // Clone number of legs
        const prevNumLegs = document.getElementById(`numLegs_${prevId}`);
        if (prevNumLegs) {
            const legsValue = parseInt(prevNumLegs.textContent) || 3;
            document.getElementById(`numLegs_${eventId}`).textContent = legsValue;
            document.getElementById(`numLegsInput_${eventId}`).value = legsValue;
            eventConfigs[eventId].numLegs = legsValue;
            // Update leg mode toggle disabled state
            const legModeToggle = document.getElementById(`legModeToggle_${eventId}`);
            if (legModeToggle) legModeToggle.classList.toggle('disabled', legsValue === 1);
        }

        // Clone leg mode
        const prevLegModeToggle = document.getElementById(`legModeToggle_${prevId}`);
        if (prevLegModeToggle) {
            const activeBtn = prevLegModeToggle.querySelector('.toggle-btn.active');
            if (activeBtn) {
                const legMode = activeBtn.dataset.value;
                eventConfigs[eventId].legMode = legMode;
                const newToggle = document.getElementById(`legModeToggle_${eventId}`);
                newToggle.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === legMode);
                });
            }
        }

        // Clone number of sets
        const prevNumSets = document.getElementById(`numSets_${prevId}`);
        if (prevNumSets) {
            const setsValue = parseInt(prevNumSets.textContent) || 1;
            document.getElementById(`numSets_${eventId}`).textContent = setsValue;
            document.getElementById(`numSetsInput_${eventId}`).value = setsValue;
            // Update set mode toggle disabled state
            const setModeToggle = document.getElementById(`setModeToggle_${eventId}`);
            if (setModeToggle) setModeToggle.classList.toggle('disabled', setsValue === 1);
        }

        // Clone set mode
        const prevSetModeToggle = document.getElementById(`setModeToggle_${prevId}`);
        if (prevSetModeToggle) {
            const activeBtn = prevSetModeToggle.querySelector('.toggle-btn.active');
            if (activeBtn) {
                const setMode = activeBtn.dataset.value;
                const newToggle = document.getElementById(`setModeToggle_${eventId}`);
                newToggle.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === setMode);
                });
            }
        }

        // Clone playoff settings checkbox
        const prevPlayoffCheckbox = document.getElementById(`enablePlayoffSettings_${prevId}`);
        if (prevPlayoffCheckbox && prevPlayoffCheckbox.checked) {
            const newCheckbox = document.getElementById(`enablePlayoffSettings_${eventId}`);
            newCheckbox.checked = true;
            document.getElementById(`playoffSettings_${eventId}`).style.display = 'block';

            // Clone semi-finals format
            const prevSemiFormat = document.getElementById(`semiFormatToggle_${prevId}`);
            if (prevSemiFormat) {
                const activeBtn = prevSemiFormat.querySelector('.toggle-btn.active');
                if (activeBtn) {
                    setPlayoffFormat(eventId, 'semi', activeBtn.dataset.value);
                }
            }

            // Clone semi-finals values
            ['semiLegs', 'semiSets', 'semiLegsPerSet'].forEach(field => {
                const prevEl = document.getElementById(`${field}_${prevId}`);
                if (prevEl) {
                    const value = parseInt(prevEl.textContent) || 3;
                    document.getElementById(`${field}_${eventId}`).textContent = value;
                    document.getElementById(`${field}Input_${eventId}`).value = value;
                }
            });

            // Clone finals format
            const prevFinalsFormat = document.getElementById(`finalsFormatToggle_${prevId}`);
            if (prevFinalsFormat) {
                const activeBtn = prevFinalsFormat.querySelector('.toggle-btn.active');
                if (activeBtn) {
                    setPlayoffFormat(eventId, 'finals', activeBtn.dataset.value);
                }
            }

            // Clone finals values
            ['finalsLegs', 'finalsSets', 'finalsLegsPerSet'].forEach(field => {
                const prevEl = document.getElementById(`${field}_${prevId}`);
                if (prevEl) {
                    const value = parseInt(prevEl.textContent) || 3;
                    document.getElementById(`${field}_${eventId}`).textContent = value;
                    document.getElementById(`${field}Input_${eventId}`).value = value;
                }
            });
        }
    }

    // Initialize game type change handler
    handleGameTypeChange(eventId);

    // Update Add Event button state
    updateAddEventButton();
};

window.removeEvent = function(id) {
    document.getElementById(`event-${id}`).remove();
    delete eventConfigs[id];
    // Update Add Event button state
    updateAddEventButton();
};

// Toggle playoff settings visibility
window.togglePlayoffSettings = function(eventId) {
    const checkbox = document.getElementById(`enablePlayoffSettings_${eventId}`);
    const settings = document.getElementById(`playoffSettings_${eventId}`);
    settings.style.display = checkbox.checked ? 'block' : 'none';
};

// Number spinner functions (any number, min 1)
window.spinUp = function(eventId, field) {
    const valueEl = document.getElementById(`${field}_${eventId}`);
    const inputEl = document.getElementById(`${field}Input_${eventId}`);
    let value = parseInt(valueEl.textContent) || 1;
    const max = field === 'numSets' ? 9 : 15;
    value = Math.min(value + 1, max);
    valueEl.textContent = value;
    if (inputEl) inputEl.value = value;

    if (field === 'numLegs') {
        eventConfigs[eventId].numLegs = value;
        // Enable leg mode when legs > 1
        const legModeToggle = document.getElementById(`legModeToggle_${eventId}`);
        if (legModeToggle) {
            legModeToggle.classList.toggle('disabled', value === 1);
        }
    }

    // Enable/disable set mode based on numSets
    if (field === 'numSets') {
        const setModeToggle = document.getElementById(`setModeToggle_${eventId}`);
        if (setModeToggle) {
            setModeToggle.classList.toggle('disabled', value === 1);
        }
    }
};

window.spinDown = function(eventId, field) {
    const valueEl = document.getElementById(`${field}_${eventId}`);
    const inputEl = document.getElementById(`${field}Input_${eventId}`);
    let value = parseInt(valueEl.textContent) || 1;
    value = Math.max(value - 1, 1); // Min is always 1
    valueEl.textContent = value;
    if (inputEl) inputEl.value = value;

    if (field === 'numLegs') {
        eventConfigs[eventId].numLegs = value;
        // Disable leg mode when legs = 1
        const legModeToggle = document.getElementById(`legModeToggle_${eventId}`);
        if (legModeToggle) {
            legModeToggle.classList.toggle('disabled', value === 1);
        }
    }

    // Enable/disable set mode based on numSets
    if (field === 'numSets') {
        const setModeToggle = document.getElementById(`setModeToggle_${eventId}`);
        if (setModeToggle) {
            setModeToggle.classList.toggle('disabled', value === 1);
        }
    }
};

// Odd-only spinner functions (for playoff rounds)
window.spinOddUp = function(eventId, field) {
    const valueEl = document.getElementById(`${field}_${eventId}`);
    const inputEl = document.getElementById(`${field}Input_${eventId}`);
    let value = parseInt(valueEl.textContent) || 1;
    value = value + 2; // Jump by 2 for odd numbers
    value = Math.min(value, 15);
    valueEl.textContent = value;
    if (inputEl) inputEl.value = value;
};

window.spinOddDown = function(eventId, field) {
    const valueEl = document.getElementById(`${field}_${eventId}`);
    const inputEl = document.getElementById(`${field}Input_${eventId}`);
    let value = parseInt(valueEl.textContent) || 1;
    value = value - 2; // Jump by 2 for odd numbers
    value = Math.max(value, 1);
    valueEl.textContent = value;
    if (inputEl) inputEl.value = value;
};

// Set playoff format (legs vs sets)
window.setPlayoffFormat = function(eventId, round, format) {
    const toggleGroup = document.getElementById(`${round}FormatToggle_${eventId}`);
    toggleGroup.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === format);
    });

    const legsRow = document.getElementById(`${round}LegsRow_${eventId}`);
    const setsRow = document.getElementById(`${round}SetsRow_${eventId}`);
    const legsPerSetRow = document.getElementById(`${round}LegsPerSetRow_${eventId}`);

    if (format === 'legs') {
        legsRow.style.display = 'flex';
        setsRow.style.display = 'none';
        legsPerSetRow.style.display = 'none';
    } else {
        legsRow.style.display = 'none';
        setsRow.style.display = 'flex';
        legsPerSetRow.style.display = 'flex';
    }
};

// Set set mode for regular game config
window.setSetMode = function(eventId, mode) {
    const toggleGroup = document.getElementById(`setModeToggle_${eventId}`);
    toggleGroup.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === mode);
    });
};

// Set leg mode
window.setLegMode = function(eventId, mode) {
    eventConfigs[eventId].legMode = mode;
    const toggleGroup = document.getElementById(`legModeToggle_${eventId}`);
    toggleGroup.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === mode);
    });
};

// Set starter
window.setStarter = function(eventId, team) {
    eventConfigs[eventId].selectedStarter = team;
    const starterRow = document.getElementById(`starterRow_${eventId}`);
    starterRow.querySelectorAll('.starter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.team === team);
    });
};

// Handle start rules change
window.handleStartRulesChange = function(eventId) {
    const startRules = document.getElementById(`startRules_${eventId}`).value;
    const starterRow = document.getElementById(`starterRow_${eventId}`);
    starterRow.style.display = startRules === 'select-starter' ? 'block' : 'none';
};

// Handle game type change
window.handleGameTypeChange = function(eventId) {
    const gameType = document.getElementById(`gameType_${eventId}`).value;
    const x01Options = document.getElementById(`x01Options_${eventId}`);
    const standardX01Options = document.getElementById(`standardX01Options_${eventId}`);
    const mixedConfig = document.getElementById(`mixedConfig_${eventId}`);
    const startRulesRow = document.getElementById(`startRulesRow_${eventId}`);
    const corkOrderRow = document.getElementById(`corkOrderRow_${eventId}`);
    const corkWinnerRow = document.getElementById(`corkWinnerRow_${eventId}`);

    // Hide all first
    x01Options.style.display = 'none';
    standardX01Options.style.display = 'none';
    mixedConfig.style.display = 'none';

    // Show appropriate options
    if (gameType === 'x01') {
        x01Options.style.display = 'flex';
    } else if (['501', '301', '701'].includes(gameType)) {
        standardX01Options.style.display = 'flex';
    } else if (gameType === 'mixed') {
        mixedConfig.style.display = 'block';
        renderMixedConfig(eventId);
    }

    // Toggle between Start Rules (regular games) and Cork Order (corks choice)
    if (gameType === 'corks_choice') {
        startRulesRow.style.display = 'none';
        document.getElementById(`starterRow_${eventId}`).style.display = 'none';
        corkOrderRow.style.display = 'flex';
        corkWinnerRow.style.display = 'flex';
    } else {
        startRulesRow.style.display = 'flex';
        corkOrderRow.style.display = 'none';
        corkWinnerRow.style.display = 'none';
        handleStartRulesChange(eventId); // Update starter row visibility
    }
};

// Handle legs change
window.handleLegsChange = function(eventId) {
    const numLegs = parseInt(document.getElementById(`numLegs_${eventId}`).value);
    eventConfigs[eventId].numLegs = numLegs;

    const gameType = document.getElementById(`gameType_${eventId}`).value;
    if (gameType === 'mixed') {
        renderMixedConfig(eventId);
    }
};

// Render mixed config
function renderMixedConfig(eventId) {
    const numLegs = parseInt(document.getElementById(`numLegs_${eventId}`).value);
    const container = document.getElementById(`mixedConfig_${eventId}`);
    const config = eventConfigs[eventId];

    // Initialize/resize mixedLegs array
    while (config.mixedLegs.length < numLegs) {
        config.mixedLegs.push({ type: '501', score: 501, inRule: 'straight', outRule: 'double' });
    }
    config.mixedLegs = config.mixedLegs.slice(0, numLegs);

    let html = '<div style="font-size: 13px; color: var(--yellow); margin-bottom: 12px;">Configure each leg:</div>';

    for (let i = 0; i < numLegs; i++) {
        const leg = config.mixedLegs[i];
        const isX01 = ['301', '501', '701', 'x01'].includes(leg.type);

        html += `
            <div class="mixed-leg-row">
                <span class="leg-label">Leg ${i + 1}</span>
                <select class="config-select game-type-select" onchange="updateMixedLeg(${eventId}, ${i}, 'type', this.value)">
                    <option value="501" ${leg.type === '501' ? 'selected' : ''}>501</option>
                    <option value="301" ${leg.type === '301' ? 'selected' : ''}>301</option>
                    <option value="701" ${leg.type === '701' ? 'selected' : ''}>701</option>
                    <option value="cricket" ${leg.type === 'cricket' ? 'selected' : ''}>Cricket</option>
                    <option value="x01" ${leg.type === 'x01' ? 'selected' : ''}>X01</option>
                    <option value="corks_choice" ${leg.type === 'corks_choice' ? 'selected' : ''}>Corks Choice</option>
                </select>
                ${isX01 ? `
                    <div class="x01-inline">
                        ${leg.type === 'x01' ? `
                            <input type="number" class="config-input" value="${leg.score}"
                                   onchange="updateMixedLeg(${eventId}, ${i}, 'score', this.value)" min="101" max="1001" step="100">
                        ` : ''}
                        <select class="config-select mini" onchange="updateMixedLeg(${eventId}, ${i}, 'inRule', this.value)">
                            <option value="straight" ${leg.inRule === 'straight' ? 'selected' : ''}>SI</option>
                            <option value="double" ${leg.inRule === 'double' ? 'selected' : ''}>DI</option>
                        </select>
                        <select class="config-select mini" onchange="updateMixedLeg(${eventId}, ${i}, 'outRule', this.value)">
                            <option value="double" ${leg.outRule === 'double' ? 'selected' : ''}>DO</option>
                            <option value="straight" ${leg.outRule === 'straight' ? 'selected' : ''}>SO</option>
                            <option value="master" ${leg.outRule === 'master' ? 'selected' : ''}>MO</option>
                        </select>
                    </div>
                ` : ''}
            </div>
        `;
    }

    container.innerHTML = html;
}

// Update mixed leg config
window.updateMixedLeg = function(eventId, legIndex, property, value) {
    const config = eventConfigs[eventId];

    if (property === 'score') {
        config.mixedLegs[legIndex].score = parseInt(value);
    } else {
        config.mixedLegs[legIndex][property] = value;
    }

    if (property === 'type') {
        if (value === '301') config.mixedLegs[legIndex].score = 301;
        if (value === '501') config.mixedLegs[legIndex].score = 501;
        if (value === '701') config.mixedLegs[legIndex].score = 701;
        renderMixedConfig(eventId);
    }
};

// Submit tournament
window.submitTournament = async function() {
    const form = document.getElementById('tournamentForm');

    // Custom validation
    if (!window.validateForm()) {
        // Scroll to first error
        const firstError = document.querySelector('.invalid');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstError.focus();
        }
        return;
    }

    // HTML5 validation as backup
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const formData = new FormData(form);

    // Upload tournament image if selected
    let tournamentImageUrl = '';
    if (tournamentImageFile) {
        showLoading('Uploading tournament image...');
        try {
            tournamentImageUrl = await uploadImage(tournamentImageFile, 'tournaments');
        } catch (uploadError) {
            console.error('Tournament image upload failed:', uploadError);
        }
    }

    // Upload event images
    const eventImageUrls = {};
    for (const [eventId, file] of Object.entries(eventImageFiles)) {
        if (file) {
            showLoading(`Uploading event ${eventId} image...`);
            try {
                eventImageUrls[eventId] = await uploadImage(file, 'events');
            } catch (uploadError) {
                console.error(`Event ${eventId} image upload failed:`, uploadError);
            }
        }
    }

    // Get player limit from permissions
    const perms = window.userPermissions || { max_tournament_players: 8 };
    const isAdmin = window.isAdmin || false;
    const maxPlayers = isAdmin ? 999 : perms.max_tournament_players;

    const data = {
        tournament_name: formData.get('tournament_name'),
        tournament_date: formData.get('tournament_date'),
        tournament_time: formData.get('tournament_time') || '',
        image_url: tournamentImageUrl,
        venue_name: formData.get('venue_name'),
        venue_address: formData.get('venue_address') || '',
        tournament_details: formData.get('tournament_details') || '',
        full_name: formData.get('director_first') + ' ' + formData.get('director_last'),
        director_name: formData.get('director_first') + ' ' + formData.get('director_last'),
        email: formData.get('director_email'),
        phone: formData.get('director_phone') || '',
        director_phone: formData.get('director_phone') || '',
        director_pin: window.directorPin || null, // 8-digit player PIN for dashboard access
        max_players: maxPlayers, // Permission-based player limit
        boards_available: 12, // Default for Heartbreaker, can be customized
        events: []
    };

    // Process each event
    for (let i = 1; i <= eventCounter; i++) {
        if (!document.getElementById(`event-${i}`)) continue;

        const config = eventConfigs[i];
        const gameType = document.getElementById(`gameType_${i}`).value;
        const numLegs = parseInt(document.getElementById(`numLegs_${i}`).value);
        const startRules = document.getElementById(`startRules_${i}`).value;
        const numSets = parseInt(document.getElementById(`numSets_${i}`)?.value || '0');

        // Map start rules to cork rules
        let corkRules;
        let useCork = true;

        if (gameType === 'corks_choice') {
            corkRules = 'cork_every_leg'; // Always cork in corks choice
        } else {
            switch(startRules) {
                case 'cork-every': corkRules = 'cork_every_leg'; break;
                case 'alternate-cork': corkRules = 'alternate_cork_first_deciding'; break;
                case 'loser-cork': corkRules = 'loser_starts_cork_first_deciding'; break;
                case 'winner-cork': corkRules = 'winner_starts_cork_first_deciding'; break;
                case 'select-starter': corkRules = 'choose_no_cork'; useCork = false; break;
                default: corkRules = 'cork_every_leg';
            }
        }

        const event = {
            event_name: formData.get(`events[${i}][event_name]`),
            image_url: eventImageUrls[i] || '',
            entry_type: formData.get(`events[${i}][event_type]`),
            format: formData.get(`events[${i}][format]`),
            game: gameType,
            cork_rules: corkRules,
            use_cork: useCork,
            entry_fee: parseFloat(formData.get(`events[${i}][entry_fee]`)) || 0,
            start_time: formData.get(`events[${i}][start_time]`) || '',
            event_details: formData.get(`events[${i}][event_details]`) || '',
            num_legs: numLegs,
            leg_mode: config.legMode,
            num_sets: numSets
        };

        // Add corks choice specific params if applicable
        if (gameType === 'corks_choice') {
            event.cork_order = document.getElementById(`corkOrder_${i}`).value;
            event.cork_winner_gets = document.getElementById(`corkWinnerGets_${i}`).value;
        }

        // Calculate best_of or total_legs based on leg mode
        if (config.legMode === 'best-of') {
            event.best_of = numLegs;
            event.legs_to_win = Math.ceil(numLegs / 2);
        } else {
            event.total_legs = numLegs;
        }

        // Add starter selection if applicable
        if (startRules === 'select-starter') {
            event.default_starter = config.selectedStarter;
        }

        // Add X01/game specific settings
        if (gameType === 'x01') {
            event.x01_value = parseInt(document.getElementById(`x01Score_${i}`).value) || 501;
            event.in_option = document.getElementById(`inRule_${i}`).value;
            event.out_option = document.getElementById(`outRule_${i}`).value;
        } else if (['501', '301', '701'].includes(gameType)) {
            event.in_option = document.getElementById(`standardInRule_${i}`).value;
            event.out_option = document.getElementById(`standardOutRule_${i}`).value;
        }

        // Handle mixed format
        if (gameType === 'mixed') {
            event.legs = config.mixedLegs.map((leg, idx) => ({
                leg_number: idx + 1,
                game: leg.type,
                x01_value: leg.type === 'x01' ? leg.score : (leg.type === '301' ? 301 : (leg.type === '701' ? 701 : 501)),
                in_option: leg.inRule || 'straight',
                out_option: leg.outRule || 'double'
            }));
        }

        data.events.push(event);
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = 'CREATING...';

    // Check if Heartbreaker preset is selected
    const presetSelect = document.getElementById('tournamentPreset');
    const isHeartbreaker = presetSelect && presetSelect.value === 'heartbreaker';

    showLoading('Creating tournament...');
    try {
        // Route to appropriate backend function based on preset
        const functionName = isHeartbreaker ? 'createHeartbreakerTournament' : 'createTournament';
        const result = await callFunction(functionName, data);
        hideLoading();

        if (result.success) {
            // Show success page
            document.body.innerHTML = `
                <div class="success-page">
                    <div class="success-card">
                        <div class="success-icon">&#9989;</div>
                        <h1 class="success-title">TOURNAMENT CREATED!</h1>

                        <div class="pin-display">
                            <div class="pin-label">Your Director PIN</div>
                            <div class="pin-value">${result.pin}</div>
                            <div class="pin-hint">Save this 8-digit PIN - you'll need it to manage your tournament!</div>
                        </div>

                        <div style="margin: 20px 0; font-size: 16px; font-weight: 600;">
                            ${result.events_created} event${result.events_created > 1 ? 's' : ''} created
                        </div>

                        <a href="/pages/director-dashboard.html?pin=${result.pin}" class="success-link">
                            GO TO DASHBOARD
                        </a>
                    </div>
                </div>
            `;
        } else {
            throw new Error(result.error || 'Unknown error');
        }

    } catch (error) {
        hideLoading();
        console.error('Error creating tournament:', error);
        alert('Something went wrong. Please try again.');
        btn.disabled = false;
        btn.textContent = 'CREATE TOURNAMENT';
    }
};

// ===== TEMPLATE & DRAFT FUNCTIONS =====

// Collect all form data into an object
function collectFormData() {
    const form = document.getElementById('tournamentForm');
    const formData = new FormData(form);

    const data = {
        tournament_name: formData.get('tournament_name') || '',
        tournament_date: formData.get('tournament_date') || '',
        tournament_time: formData.get('tournament_time') || '',
        image_url: formData.get('image_url') || '',
        venue_name: formData.get('venue_name') || '',
        venue_address: formData.get('venue_address') || '',
        tournament_details: formData.get('tournament_details') || '',
        events: []
    };

    // Collect each event's data
    for (let i = 1; i <= eventCounter; i++) {
        if (!document.getElementById(`event-${i}`)) continue;

        const config = eventConfigs[i];
        const event = {
            event_name: formData.get(`events[${i}][event_name]`) || '',
            image_url: formData.get(`events[${i}][image_url]`) || '',
            event_type: formData.get(`events[${i}][event_type]`) || '',
            format: formData.get(`events[${i}][format]`) || 'single_elim',
            entry_fee: formData.get(`events[${i}][entry_fee]`) || '10',
            start_time: formData.get(`events[${i}][start_time]`) || '',
            event_details: formData.get(`events[${i}][event_details]`) || '',
            numLegs: document.getElementById(`numLegs_${i}`).value,
            legMode: config.legMode,
            numSets: document.getElementById(`numSets_${i}`)?.value || '0',
            startRules: document.getElementById(`startRules_${i}`).value,
            selectedStarter: config.selectedStarter,
            gameType: document.getElementById(`gameType_${i}`).value,
            x01Score: document.getElementById(`x01Score_${i}`)?.value || '501',
            inRule: document.getElementById(`inRule_${i}`)?.value || 'straight',
            outRule: document.getElementById(`outRule_${i}`)?.value || 'double',
            standardInRule: document.getElementById(`standardInRule_${i}`)?.value || 'straight',
            standardOutRule: document.getElementById(`standardOutRule_${i}`)?.value || 'double',
            mixedLegs: config.mixedLegs || []
        };

        data.events.push(event);
    }

    return data;
}

// Apply template data to the form
function applyTemplateData(template) {
    // Clear existing events except the first one
    const container = document.getElementById('eventsContainer');
    container.innerHTML = '';
    eventCounter = 0;

    // Apply tournament-level fields (NOT name/date/time for templates)
    if (template.venue_name) {
        document.querySelector('[name="venue_name"]').value = template.venue_name;
    }
    if (template.venue_address) {
        document.querySelector('[name="venue_address"]').value = template.venue_address;
    }
    if (template.tournament_details) {
        document.querySelector('[name="tournament_details"]').value = template.tournament_details;
    }

    // Recreate events from template
    if (template.events && template.events.length > 0) {
        template.events.forEach((eventData, index) => {
            addEvent();
            const eventId = eventCounter;

            // Basic event fields
            const eventNameInput = document.querySelector(`[name="events[${eventId}][event_name]"]`);
            if (eventNameInput) eventNameInput.value = eventData.event_name || '';

            const eventTypeSelect = document.querySelector(`[name="events[${eventId}][event_type]"]`);
            if (eventTypeSelect) eventTypeSelect.value = eventData.event_type || '';

            const formatSelect = document.querySelector(`[name="events[${eventId}][format]"]`);
            if (formatSelect) formatSelect.value = eventData.format || 'single_elim';

            const entryFeeInput = document.querySelector(`[name="events[${eventId}][entry_fee]"]`);
            if (entryFeeInput) entryFeeInput.value = eventData.entry_fee || '10';

            const startTimeInput = document.querySelector(`[name="events[${eventId}][start_time]"]`);
            if (startTimeInput) startTimeInput.value = eventData.start_time || '';

            const eventDetailsInput = document.querySelector(`[name="events[${eventId}][event_details]"]`);
            if (eventDetailsInput) eventDetailsInput.value = eventData.event_details || '';

            // Game configuration
            document.getElementById(`numLegs_${eventId}`).value = eventData.numLegs || '3';
            eventConfigs[eventId].numLegs = parseInt(eventData.numLegs) || 3;

            setLegMode(eventId, eventData.legMode || 'best-of');

            if (document.getElementById(`numSets_${eventId}`)) {
                document.getElementById(`numSets_${eventId}`).value = eventData.numSets || '0';
            }

            document.getElementById(`startRules_${eventId}`).value = eventData.startRules || 'cork-every';
            handleStartRulesChange(eventId);

            if (eventData.selectedStarter) {
                setStarter(eventId, eventData.selectedStarter);
            }

            document.getElementById(`gameType_${eventId}`).value = eventData.gameType || '501';
            handleGameTypeChange(eventId);

            // X01 settings
            if (document.getElementById(`x01Score_${eventId}`)) {
                document.getElementById(`x01Score_${eventId}`).value = eventData.x01Score || '501';
            }
            if (document.getElementById(`inRule_${eventId}`)) {
                document.getElementById(`inRule_${eventId}`).value = eventData.inRule || 'straight';
            }
            if (document.getElementById(`outRule_${eventId}`)) {
                document.getElementById(`outRule_${eventId}`).value = eventData.outRule || 'double';
            }
            if (document.getElementById(`standardInRule_${eventId}`)) {
                document.getElementById(`standardInRule_${eventId}`).value = eventData.standardInRule || 'straight';
            }
            if (document.getElementById(`standardOutRule_${eventId}`)) {
                document.getElementById(`standardOutRule_${eventId}`).value = eventData.standardOutRule || 'double';
            }

            // Mixed legs
            if (eventData.mixedLegs && eventData.mixedLegs.length > 0) {
                eventConfigs[eventId].mixedLegs = eventData.mixedLegs;
                if (eventData.gameType === 'mixed') {
                    renderMixedConfig(eventId);
                }
            }
        });
    } else {
        // Add at least one event
        addEvent();
    }
}

// Save current form as template
window.saveAsTemplate = async function() {
    if (!window.directorPin) {
        alert('Please sign in first to save templates');
        return;
    }

    const templateName = prompt('Enter a name for this template:');
    if (!templateName || !templateName.trim()) return;

    const formData = collectFormData();

    try {
        const result = await callFunction('saveTournamentTemplate', {
            pin: window.directorPin,
            template_name: templateName.trim(),
            template_data: formData
        });

        if (result.success) {
            alert('Template saved successfully!');
        } else {
            throw new Error(result.error || 'Failed to save template');
        }
    } catch (error) {
        console.error('Error saving template:', error);
        alert('Something went wrong. Please try again.');
    }
};

// Open template modal
window.openTemplateModal = async function() {
    if (!window.directorPin) {
        alert('Please sign in first to load templates');
        return;
    }

    document.getElementById('templateModal').style.display = 'flex';
    await loadTemplates();
};

// Close template modal
window.closeTemplateModal = function() {
    document.getElementById('templateModal').style.display = 'none';
};

// Load templates from server
async function loadTemplates() {
    const templateList = document.getElementById('templateList');
    templateList.innerHTML = '<div class="no-templates">Loading templates...</div>';

    try {
        const result = await callFunction('getTournamentTemplates', {
            pin: window.directorPin
        });

        if (result.success && result.templates && result.templates.length > 0) {
            templateList.innerHTML = result.templates.map(t => `
                <div class="template-item" onclick="loadTemplate('${t.id}')">
                    <div>
                        <div class="template-name">${t.name}</div>
                        <div class="template-meta">${t.events_count || 0} event(s)</div>
                    </div>
                    <button type="button" class="template-delete" onclick="event.stopPropagation(); deleteTemplate('${t.id}')">Delete</button>
                </div>
            `).join('');
        } else {
            templateList.innerHTML = '<div class="no-templates">No templates saved yet</div>';
        }
    } catch (error) {
        console.error('Error loading templates:', error);
        templateList.innerHTML = '<div class="no-templates">Error loading templates</div>';
    }
}

// Load a specific template
window.loadTemplate = async function(templateId) {
    try {
        const result = await callFunction('getTournamentTemplate', {
            pin: window.directorPin,
            template_id: templateId
        });

        if (result.success && result.template) {
            applyTemplateData(result.template.data);
            closeTemplateModal();
            alert('Template loaded!');
        } else {
            throw new Error(result.error || 'Failed to load template');
        }
    } catch (error) {
        console.error('Error loading template:', error);
        alert('Unable to load template. Check your connection and try again.');
    }
};

// Delete a template
window.deleteTemplate = async function(templateId) {
    if (!confirm('Are you sure you want to delete this template?')) return;

    try {
        const result = await callFunction('deleteTournamentTemplate', {
            pin: window.directorPin,
            template_id: templateId
        });

        if (result.success) {
            await loadTemplates();
        } else {
            throw new Error(result.error || 'Failed to delete template');
        }
    } catch (error) {
        console.error('Error deleting template:', error);
        alert('Something went wrong. Please try again.');
    }
};

// Save as draft
window.saveAsDraft = async function() {
    if (!window.directorPin) {
        alert('Please sign in first to save drafts');
        return;
    }

    const formData = collectFormData();

    try {
        const result = await callFunction('saveTournamentDraft', {
            pin: window.directorPin,
            draft_data: formData
        });

        if (result.success) {
            alert('Draft saved! You can continue editing later by signing in with your PIN.');
        } else {
            throw new Error(result.error || 'Failed to save draft');
        }
    } catch (error) {
        console.error('Error saving draft:', error);
        alert('Something went wrong. Please try again.');
    }
};

// Check for existing draft and prompt to load
async function checkForDraft() {
    if (!window.directorPin) return;

    try {
        const result = await callFunction('getTournamentDraft', {
            pin: window.directorPin
        });

        if (result.success && result.draft) {
            const loadDraft = confirm('You have a saved draft. Would you like to continue where you left off?');
            if (loadDraft) {
                applyTemplateData(result.draft.data);

                // Also apply tournament-specific fields for drafts
                if (result.draft.data.tournament_name) {
                    document.querySelector('[name="tournament_name"]').value = result.draft.data.tournament_name;
                }
                if (result.draft.data.tournament_date) {
                    document.querySelector('[name="tournament_date"]').value = result.draft.data.tournament_date;
                }
                if (result.draft.data.tournament_time) {
                    document.querySelector('[name="tournament_time"]').value = result.draft.data.tournament_time;
                }
            }
        }
    } catch (error) {
        console.error('Error checking for draft:', error);
    }
}
</script>
<script src="/js/nav-menu.js"></script>
<script src="/js/feedback.js"></script>
</body>
</html>
