<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Match Night - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FF469A">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');

        :root {
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --green: #10b981;
            --success: #22c55e;
            --text-light: #f0f0f0;
            --text-primary: #f0f0f0;
            --text-dim: #8a8aa3;
            --text-secondary: #a0a0a0;
            --black: #000000;
            --border: rgba(255, 255, 255, 0.1);
            --border-strong: #000;
            --border-color: rgba(255,255,255,0.15);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }

        html, body { min-height: 100%; min-height: 100dvh; }
        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            color: var(--text-light);
            line-height: 1.6;
            padding-bottom: 100px;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Header Bar - Match Hub Style */
        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .header-logo { width: 36px; height: 36px; }
        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            letter-spacing: 2px;
            color: var(--pink);
            flex: 1;
        }
        .back-btn {
            background: var(--bg-card);
            border: 2px solid var(--text-dim);
            border-radius: 8px;
            padding: 8px 14px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .back-btn:hover { border-color: var(--pink); color: var(--pink); }

        .container { max-width: 600px; margin: 0 auto; padding: 16px; }

        /* PIN Entry Screen - Match Hub Style */
        .pin-screen {
            text-align: center;
            padding: 40px 20px;
        }
        .pin-card {
            background: var(--bg-panel);
            border: 3px solid var(--border-strong);
            border-radius: 16px;
            padding: 40px 30px;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }
        .pin-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--yellow);
            margin-bottom: 8px;
            letter-spacing: 2px;
        }
        .pin-subtitle {
            color: var(--text-dim);
            margin-bottom: 30px;
            font-size: 13px;
        }
        .pin-input {
            width: 200px;
            padding: 16px;
            font-size: 32px;
            letter-spacing: 8px;
            text-align: center;
            background: var(--bg-dark);
            border: 3px solid var(--yellow);
            border-radius: 12px;
            color: var(--yellow);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 20px;
        }
        .pin-input:focus { outline: none; border-color: var(--pink); }
        .pin-input::placeholder { color: rgba(253,216,53,0.3); letter-spacing: 4px; }
        .pin-btn {
            background: linear-gradient(180deg, var(--pink) 0%, #cc3879 100%);
            color: white;
            border: 3px solid #000;
            padding: 14px 40px;
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 2px;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
            transition: all 0.2s;
        }
        .pin-btn:hover { transform: translateY(-2px); }
        .pin-btn:disabled { background: #4a5568; cursor: not-allowed; transform: none; }
        .pin-error {
            color: #ef4444;
            margin-top: 16px;
            font-size: 14px;
            display: none;
        }

        /* Match Screen */
        .match-screen { display: none; }

        /* Match Header Card - Match Hub Style */
        .match-header-card {
            background: var(--bg-panel);
            border: 3px solid var(--border-strong);
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        .match-teams-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            gap: 16px;
        }

        .team-side {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .team-side.home { align-items: flex-end; text-align: right; }
        .team-side.away { align-items: flex-start; text-align: left; }

        .team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            letter-spacing: 1px;
        }
        .team-side.home .team-name { color: var(--pink); }
        .team-side.away .team-name { color: var(--teal); }

        .team-record {
            font-size: 11px;
            color: var(--text-dim);
        }

        .score-center {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-dark);
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid var(--border-strong);
        }
        .score-num {
            font-family: 'Bebas Neue', cursive;
            font-size: 42px;
            min-width: 36px;
            text-align: center;
        }
        .score-num.home { color: var(--pink); }
        .score-num.away { color: var(--teal); }
        .score-dash { color: var(--text-dim); font-size: 28px; }

        /* Match Metadata Grid */
        .match-meta-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 1px;
            background: rgba(255,255,255,0.1);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .meta-item {
            background: var(--bg-panel);
            padding: 12px 8px;
            text-align: center;
        }
        .meta-label {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .meta-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--yellow);
            margin-top: 2px;
        }

        /* Rounds/Sets Section Title */
        .rounds-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--teal);
            margin-bottom: 12px;
            letter-spacing: 2px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        /* Round Cards - Game Card Style */
        .round-card {
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .round-card:hover { border-color: var(--pink); transform: translateY(-2px); }
        .round-card.selected {
            border-color: var(--yellow);
            box-shadow: 0 0 20px rgba(253,216,53,0.3);
        }
        .round-card.completed {
            opacity: 0.7;
            cursor: default;
        }
        .round-card.completed:hover { border-color: var(--border-strong); transform: none; }
        .round-card.in-progress {
            border-color: var(--success);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 4px 4px 0 rgba(0,0,0,0.3); }
            50% { box-shadow: 4px 4px 15px rgba(34,197,94,0.4); }
        }

        /* Round Card Header - Game Card Style */
        .round-card-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 14px 16px;
            background: rgba(0,0,0,0.4);
            border-bottom: 2px solid rgba(0,0,0,0.5);
            gap: 8px;
        }

        .round-team-side {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .round-team-side.left { align-items: flex-end; text-align: right; }
        .round-team-side.right { align-items: flex-start; text-align: left; }

        .round-player-name {
            font-weight: 600;
            font-size: 14px;
        }
        .round-team-side.left .round-player-name { color: var(--pink); }
        .round-team-side.right .round-player-name { color: var(--teal); }
        .round-player-name.empty { color: var(--text-dim); font-style: italic; font-weight: 400; }

        .round-score-center {
            text-align: center;
        }
        .round-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--text-light);
        }
        .round-format-badge {
            display: inline-block;
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            background: var(--teal);
            color: var(--black);
            border-radius: 4px;
            margin-top: 4px;
        }

        /* Round Card Body */
        .round-card-body {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .round-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .round-number {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--text-dim);
        }

        .round-status {
            font-size: 10px;
            padding: 4px 10px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .status-not-started { background: rgba(255,255,255,0.1); color: var(--text-dim); }
        .status-in-progress { background: var(--success); color: #000; }
        .status-completed { background: #4a5568; color: white; }

        /* Legacy round styles for compatibility */
        .round-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .round-type {
            background: var(--yellow);
            color: #000;
            padding: 3px 10px;
            font-size: 11px;
            font-weight: 800;
            border-radius: 4px;
            letter-spacing: 1px;
        }

        .round-players {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 8px;
            align-items: center;
            font-size: 14px;
            padding: 12px 16px;
        }
        .round-players .home-players { text-align: left; color: var(--pink); font-weight: 600; }
        .round-players .vs { color: var(--text-dim); font-size: 12px; text-align: center; }
        .round-players .away-players { text-align: right; color: var(--teal); font-weight: 600; }
        .round-players .player-name { display: block; }
        .round-players .empty { color: var(--text-dim); font-style: italic; font-weight: 400; }

        .round-result {
            margin-top: 0;
            padding: 10px 16px;
            background: rgba(0,0,0,0.2);
            display: flex;
            justify-content: center;
            gap: 20px;
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
        }
        .round-result .home-score { color: var(--pink); }
        .round-result .away-score { color: var(--teal); }

        /* Action Footer */
        .action-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-panel);
            border-top: 3px solid var(--pink);
            padding: 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom, 0));
            display: none;
        }
        .action-footer.visible { display: block; }
        .start-btn {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            display: block;
            background: linear-gradient(180deg, var(--success) 0%, #16a34a 100%);
            color: white;
            border: 3px solid #000;
            padding: 16px;
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 2px;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
        }
        .start-btn:disabled { background: #4a5568; cursor: not-allowed; }

        /* Substitution Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-panel);
            border: 3px solid #000;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
        }
        .modal-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--yellow);
            margin-bottom: 16px;
            text-align: center;
        }
        .modal-text {
            color: var(--text-dim);
            font-size: 14px;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
        }
        .modal-btns {
            display: flex;
            gap: 12px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            border: 2px solid #000;
            border-radius: 6px;
            cursor: pointer;
        }
        .modal-btn.primary { background: var(--pink); color: white; }
        .modal-btn.secondary { background: rgba(255,255,255,0.1); color: white; }

        /* Player Select */
        .player-select-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }
        .player-option {
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-option:hover { border-color: var(--pink); }
        .player-option.selected { border-color: var(--yellow); background: rgba(253,216,53,0.1); }
        .player-option .name { font-weight: 600; }
        .player-option .level { font-size: 12px; color: var(--text-dim); }

        .loading { text-align: center; padding: 40px; color: var(--text-dim); }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(145,215,235,0.2);
            border-top-color: var(--teal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="header-bar">
        <button class="back-btn" onclick="goBack()">‚Üê BACK</button>
        <span class="header-title">MATCH NIGHT</span>
    </div>

    <div class="container">
        <!-- PIN Entry Screen -->
        <div class="pin-screen" id="pinScreen">
            <div class="pin-card">
                <div class="pin-title">ENTER MATCH PIN</div>
                <div class="pin-subtitle">Enter the 5-digit match PIN sent to your captain</div>
                <input type="tel" class="pin-input" id="matchPinInput" placeholder="00000" maxlength="5" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
                <br>
                <button class="pin-btn" id="loadMatchBtn" onclick="loadMatch()">LOAD MATCH</button>
                <div class="pin-error" id="pinError">Match not found. Check your PIN and try again.</div>
            </div>
        </div>

        <!-- Match Screen -->
        <div class="match-screen" id="matchScreen">
            <div class="match-header-card">
                <div class="match-teams-row">
                    <div class="team-side home">
                        <div class="team-name" id="homeTeamName">HOME</div>
                        <div class="team-record" id="homeRecord"></div>
                    </div>
                    <div class="score-center">
                        <span class="score-num home" id="homeScore">0</span>
                        <span class="score-dash">-</span>
                        <span class="score-num away" id="awayScore">0</span>
                    </div>
                    <div class="team-side away">
                        <div class="team-name" id="awayTeamName">AWAY</div>
                        <div class="team-record" id="awayRecord"></div>
                    </div>
                </div>
                <div class="match-meta-grid">
                    <div class="meta-item">
                        <div class="meta-label">WEEK</div>
                        <div class="meta-value" id="matchWeek">1</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">LEAGUE</div>
                        <div class="meta-value" id="leagueName">-</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">STATUS</div>
                        <div class="meta-value" id="matchStatus">IN PROGRESS</div>
                    </div>
                </div>
            </div>

            <div class="rounds-title">SELECT A ROUND TO PLAY</div>
            <div id="roundsList">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading rounds...
                </div>
            </div>
        </div>
    </div>

    <div class="action-footer" id="actionFooter">
        <button class="start-btn" id="startBtn" onclick="confirmStartRound()">START MATCH</button>
    </div>

    <!-- Late Player Modal -->
    <div class="modal" id="latePlayerModal">
        <div class="modal-content">
            <div class="modal-title">PLAYER UNAVAILABLE?</div>
            <div class="modal-text">
                If a player is running late, you can start a different round first, or substitute another player.
            </div>
            <div class="modal-btns">
                <button class="modal-btn secondary" onclick="closeLatePlayerModal()">PICK DIFFERENT ROUND</button>
                <button class="modal-btn primary" onclick="showSubstitution()">SUBSTITUTE PLAYER</button>
            </div>
        </div>
    </div>

    <!-- Substitution Modal -->
    <div class="modal" id="subModal">
        <div class="modal-content">
            <div class="modal-title">SUBSTITUTE PLAYER</div>
            <div class="modal-text" id="subModalText">Select a replacement player:</div>
            <div class="player-select-list" id="subPlayerList"></div>
            <div class="modal-btns">
                <button class="modal-btn secondary" onclick="closeSubModal()">CANCEL</button>
                <button class="modal-btn primary" onclick="confirmSubstitution()">CONFIRM</button>
            </div>
        </div>
    </div>

    <!-- Confirm Start Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <div class="modal-title">START ROUND?</div>
            <div class="modal-text" id="confirmText">Round 1: 501 Singles</div>
            <div class="modal-btns">
                <button class="modal-btn secondary" onclick="closeConfirmModal()">CANCEL</button>
                <button class="modal-btn primary" onclick="startRound()">START</button>
            </div>
        </div>
    </div>

<script type="module">
import { callFunction } from '/js/firebase-config.js';

let matchData = null;
let leagueData = null;
let homeTeam = null;
let awayTeam = null;
let rounds = [];
let selectedRound = null;
let substitutingTeam = null;
let substitutingPlayerIndex = null;
let selectedSubPlayer = null;

// Check URL params for direct access
const params = new URLSearchParams(window.location.search);
const urlPin = params.get('pin');
const urlLeagueId = params.get('league_id');
const urlMatchId = params.get('match_id');

window.onload = function() {
    if (urlPin) {
        document.getElementById('matchPinInput').value = urlPin;
        loadMatch();
    } else if (urlLeagueId && urlMatchId) {
        loadMatchDirect(urlLeagueId, urlMatchId);
    }

    // PIN input formatting
    document.getElementById('matchPinInput').addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });

    document.getElementById('matchPinInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadMatch();
    });
};

window.loadMatch = async function() {
    const pin = document.getElementById('matchPinInput').value.trim();
    if (pin.length !== 5) {
        showError('Please enter a 5-digit PIN');
        return;
    }

    const btn = document.getElementById('loadMatchBtn');
    btn.disabled = true;
    btn.textContent = 'LOADING...';
    hideError();

    try {
        const result = await callFunction('getMatchByPIN', { match_pin: pin });

        if (result.success) {
            matchData = result.match;
            leagueData = result.league;
            homeTeam = result.home_team;
            awayTeam = result.away_team;

            await loadMatchNightData(matchData.league_id, matchData.id);
            showMatchScreen();
        } else {
            showError(result.error || 'Match not found');
        }
    } catch (error) {
        showError('Error loading match: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'LOAD MATCH';
    }
};

async function loadMatchDirect(leagueId, matchId) {
    document.getElementById('pinScreen').innerHTML = '<div class="loading"><div class="spinner"></div>Loading match...</div>';

    try {
        const result = await callFunction('getMatchNightData', { league_id: leagueId, match_id: matchId });

        if (result.success) {
            leagueData = result.league;
            matchData = result.match;
            matchData.league_id = leagueId;
            homeTeam = result.home_team;
            awayTeam = result.away_team;
            rounds = result.rounds;

            showMatchScreen();
            renderRounds();
        }
    } catch (error) {
        document.getElementById('pinScreen').innerHTML = '<div class="loading">Error loading match</div>';
    }
}

async function loadMatchNightData(leagueId, matchId) {
    try {
        const result = await callFunction('getMatchNightData', { league_id: leagueId, match_id: matchId });

        if (result.success) {
            rounds = result.rounds;
            renderRounds();
        }
    } catch (error) {
        console.error('Error loading match night data:', error);
    }
}

function showMatchScreen() {
    document.getElementById('pinScreen').style.display = 'none';
    document.getElementById('matchScreen').style.display = 'block';

    document.getElementById('leagueName').textContent = leagueData.name || '-';
    document.getElementById('homeTeamName').textContent = homeTeam?.team_name || 'HOME';
    document.getElementById('awayTeamName').textContent = awayTeam?.team_name || 'AWAY';
    document.getElementById('matchWeek').textContent = matchData.week || 1;
    document.getElementById('homeScore').textContent = matchData.home_score || 0;
    document.getElementById('awayScore').textContent = matchData.away_score || 0;

    // Set status
    const status = matchData.status === 'completed' ? 'FINAL' :
                   matchData.status === 'in_progress' ? 'LIVE' : 'UPCOMING';
    document.getElementById('matchStatus').textContent = status;
}

function renderRounds() {
    const container = document.getElementById('roundsList');

    if (rounds.length === 0) {
        container.innerHTML = '<div class="loading">No rounds configured for this match</div>';
        return;
    }

    container.innerHTML = rounds.map((round, index) => {
        const statusClass = round.status === 'completed' ? 'completed' :
                           round.status === 'in_progress' ? 'in-progress' : '';
        const statusLabel = round.status === 'completed' ? 'COMPLETED' :
                           round.status === 'in_progress' ? 'IN PROGRESS' : 'NOT STARTED';
        const statusBadge = round.status === 'completed' ? 'status-completed' :
                           round.status === 'in_progress' ? 'status-in-progress' : 'status-not-started';

        // Get player names
        const homePlayerNames = getPlayerNames(round.home_players, homeTeam);
        const awayPlayerNames = getPlayerNames(round.away_players, awayTeam);

        // Format score display
        const homeRoundScore = round.home_score || 0;
        const awayRoundScore = round.away_score || 0;
        const scoreDisplay = round.status === 'completed' ? `${homeRoundScore} - ${awayRoundScore}` : 'vs';

        return `
            <div class="round-card ${statusClass}" data-round="${index}" onclick="selectRound(${index})">
                <div class="round-card-header">
                    <div class="round-team-side left">
                        ${homePlayerNames.length > 0
                            ? homePlayerNames.map(n => `<span class="round-player-name">${n}</span>`).join('')
                            : '<span class="round-player-name empty">TBD</span>'}
                    </div>
                    <div class="round-score-center">
                        <div class="round-score">${scoreDisplay}</div>
                        <span class="round-format-badge">${round.format_label || round.game_type}</span>
                    </div>
                    <div class="round-team-side right">
                        ${awayPlayerNames.length > 0
                            ? awayPlayerNames.map(n => `<span class="round-player-name">${n}</span>`).join('')
                            : '<span class="round-player-name empty">TBD</span>'}
                    </div>
                </div>
                <div class="round-card-body">
                    <div class="round-info">
                        <span class="round-number">ROUND ${round.round_number}</span>
                    </div>
                    <span class="round-status ${statusBadge}">${statusLabel}</span>
                </div>
            </div>
        `;
    }).join('');
}

function getPlayerNames(playerIds, team) {
    if (!playerIds || playerIds.length === 0) return [];
    if (!team || !team.roster) return playerIds;

    return playerIds.map(id => {
        const player = team.roster.find(p => p.player_id === id || p.id === id);
        return player ? player.name : id;
    });
}

window.selectRound = function(index) {
    const round = rounds[index];
    if (round.status === 'completed') return;

    // Deselect previous
    document.querySelectorAll('.round-card').forEach(c => c.classList.remove('selected'));

    // Select new
    selectedRound = index;
    document.querySelector(`[data-round="${index}"]`).classList.add('selected');

    // Show action footer
    document.getElementById('actionFooter').classList.add('visible');
    document.getElementById('startBtn').textContent = `START ROUND ${round.round_number}`;
};

window.confirmStartRound = function() {
    if (selectedRound === null) return;

    const round = rounds[selectedRound];
    document.getElementById('confirmText').textContent =
        `Round ${round.round_number}: ${round.format_label || round.game_type}`;
    document.getElementById('confirmModal').classList.add('active');
};

window.closeConfirmModal = function() {
    document.getElementById('confirmModal').classList.remove('active');
};

window.startRound = async function() {
    closeConfirmModal();

    const round = rounds[selectedRound];
    const btn = document.getElementById('startBtn');
    btn.disabled = true;
    btn.textContent = 'STARTING...';

    try {
        // Mark round as in progress
        await callFunction('startRound', {
            league_id: matchData.league_id,
            match_id: matchData.id,
            round_number: round.round_number,
            home_players: round.home_players,
            away_players: round.away_players
        });

        // Build scorer URL
        launchScorer(round);

    } catch (error) {
        alert('Error starting round: ' + error.message);
        btn.disabled = false;
        btn.textContent = `START ROUND ${round.round_number}`;
    }
};

function launchScorer(round) {
    const params = new URLSearchParams();

    // Player info
    const homePlayers = getPlayerNames(round.home_players, homeTeam);
    const awayPlayers = getPlayerNames(round.away_players, awayTeam);

    params.set('home_players', JSON.stringify(homePlayers.map(name => ({ name }))));
    params.set('away_players', JSON.stringify(awayPlayers.map(name => ({ name }))));

    // League context
    params.set('origin', 'league');
    params.set('return_url', window.location.href);
    params.set('league_id', matchData.league_id);
    params.set('match_id', matchData.id);
    params.set('round_number', round.round_number);

    // Game settings
    params.set('legs_to_win', round.leg_mode === 'best-of' ? Math.ceil(round.legs / 2) : round.legs);
    params.set('cork', 'true');

    // Determine scorer type
    const gameType = round.game_type.toLowerCase();
    let scorerUrl;

    if (gameType === 'cricket') {
        scorerUrl = `/pages/league-cricket.html?${params.toString()}`;
    } else if (gameType === 'choice') {
        // Cork's choice game - cork winner chooses between 501 and Cricket
        params.set('format', 'choice');
        params.set('checkout', round.checkout || 'double');
        scorerUrl = `/pages/league-501.html?${params.toString()}`;
    } else {
        // X01 games
        const score = gameType === '301' ? 301 : gameType === '701' ? 701 : 501;
        params.set('starting_score', score);
        params.set('checkout', round.checkout || 'double');
        scorerUrl = `/pages/league-501.html?${params.toString()}`;
    }

    window.location.href = scorerUrl;
}

window.showLatePlayerModal = function() {
    document.getElementById('latePlayerModal').classList.add('active');
};

window.closeLatePlayerModal = function() {
    document.getElementById('latePlayerModal').classList.remove('active');
};

window.showSubstitution = function() {
    closeLatePlayerModal();
    // Show substitution UI - list available players
    renderSubPlayerList();
    document.getElementById('subModal').classList.add('active');
};

function renderSubPlayerList() {
    const container = document.getElementById('subPlayerList');
    const allPlayers = [...(homeTeam?.roster || []), ...(awayTeam?.roster || [])];

    if (allPlayers.length === 0) {
        container.innerHTML = '<div class="loading">No players available</div>';
        return;
    }

    container.innerHTML = allPlayers.map(player => `
        <div class="player-option" data-id="${player.player_id || player.id}" onclick="selectSubPlayer('${player.player_id || player.id}')">
            <span class="name">${player.name}</span>
            <span class="level">${player.level || ''}</span>
        </div>
    `).join('');
}

window.selectSubPlayer = function(playerId) {
    document.querySelectorAll('.player-option').forEach(el => el.classList.remove('selected'));
    document.querySelector(`[data-id="${playerId}"]`)?.classList.add('selected');
    selectedSubPlayer = playerId;
};

window.closeSubModal = function() {
    document.getElementById('subModal').classList.remove('active');
    selectedSubPlayer = null;
};

window.confirmSubstitution = function() {
    if (!selectedSubPlayer) {
        alert('Please select a player');
        return;
    }
    // Note: Substitution recording is handled through Captain Dashboard
    // This modal is for quick reference during match night
    closeSubModal();
    alert(`${selectedSubPlayer} noted as substitute. Record official substitution in Captain Dashboard.`);
};

function showError(msg) {
    const el = document.getElementById('pinError');
    el.textContent = msg;
    el.style.display = 'block';
}

function hideError() {
    document.getElementById('pinError').style.display = 'none';
}

window.goBack = function() {
    if (matchData) {
        // Go back to captain dashboard or league page
        window.location.href = '/pages/dashboard.html';
    } else {
        window.history.back();
    }
};

// Register service worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
        .then(() => {})
        .catch(err => console.error('[SW] Registration failed:', err));
}
</script>
<script src="/js/nav-menu.js"></script>
<script src="/js/feedback.js"></script>
</body>
</html>
