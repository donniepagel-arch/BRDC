<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Profile - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/brdc-styles.css">
    <style>
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .team-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .team-header {
            background: linear-gradient(135deg, rgba(255,70,154,0.2), rgba(145,215,235,0.2));
            border: 4px solid var(--black);
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.5);
        }

        .team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            color: var(--yellow);
            margin-bottom: 10px;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.5);
        }

        .team-meta {
            font-size: 16px;
            color: var(--teal);
        }

        .team-record {
            display: inline-flex;
            gap: 20px;
            margin-top: 15px;
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
        }

        .record-stat { color: white; }
        .record-stat .value { color: var(--yellow); margin-left: 5px; }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255,255,255,0.05);
            border: 3px solid var(--black);
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .tab:hover { background: rgba(255,255,255,0.1); }
        .tab.active { background: var(--pink); color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Players Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .player-card {
            background: rgba(0,0,0,0.4);
            border: 3px solid var(--black);
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
        }

        .player-card:hover {
            border-color: var(--teal);
            transform: translateY(-3px);
        }

        .player-card.captain { border-color: var(--yellow); }

        .player-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: white;
            margin-bottom: 5px;
        }

        .player-role {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .player-role.captain { background: var(--yellow); color: black; }
        .player-role.player { background: var(--teal); color: black; }

        .player-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            font-size: 12px;
            color: #aaa;
        }

        .player-stats .value { color: var(--yellow); font-weight: bold; }

        /* Matches List */
        .match-card {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            margin-bottom: 15px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .match-card-header {
            background: var(--black);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .match-card-header:hover { background: rgba(0,0,0,0.8); }

        .match-teams {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: white;
        }

        .match-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
        }

        .match-score.win { color: #22c55e; }
        .match-score.loss { color: #ef4444; }

        .match-date {
            font-size: 12px;
            color: #aaa;
        }

        .match-details {
            display: none;
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .match-details.expanded { display: block; }

        .game-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 5px;
            border-radius: 4px;
        }

        .game-players { font-size: 14px; }
        .game-result {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
        }

        .game-result.win { color: #22c55e; }
        .game-result.loss { color: #ef4444; }

        /* Standings */
        .standings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .standings-table th,
        .standings-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .standings-table th {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--teal);
            background: rgba(0,0,0,0.3);
        }

        .standings-table tr.current-team {
            background: rgba(253, 216, 53, 0.1);
        }

        .standings-table tr.current-team td {
            color: var(--yellow);
            font-weight: bold;
        }

        .rank-badge {
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
        }

        .rank-1 { background: gold; color: black; }
        .rank-2 { background: silver; color: black; }
        .rank-3 { background: #cd7f32; color: white; }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <button class="back-btn" onclick="goBack()">< BACK</button>
        <img src="/images/white_logo.jpg" alt="BRDC" class="header-logo">
        <span class="header-title">TEAM PROFILE</span>
    </div>

    <div class="team-container" id="mainContent">
        <div class="empty-state">
            <div class="empty-state-icon">...</div>
            Loading team...
        </div>
    </div>

    <script type="module">
        import { callFunction, db } from '/js/firebase-config.js';
        import { doc, getDoc, collection, getDocs, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const urlParams = new URLSearchParams(window.location.search);
        const leagueId = urlParams.get('league_id');
        const teamId = urlParams.get('team_id');

        let leagueData = null;
        let teamData = null;
        let players = [];
        let matches = [];
        let standings = [];

        window.goBack = function() {
            if (leagueId) {
                window.location.href = `/pages/league-view.html?id=${leagueId}`;
            } else {
                history.back();
            }
        };

        async function loadData() {
            if (!leagueId || !teamId) {
                document.getElementById('mainContent').innerHTML = '<div class="empty-state"><div class="empty-state-icon">!</div>Missing team or league ID</div>';
                return;
            }

            try {
                // Load league
                const leagueDoc = await getDoc(doc(db, 'leagues', leagueId));
                if (!leagueDoc.exists()) {
                    throw new Error('League not found');
                }
                leagueData = leagueDoc.data();

                // Load team
                const teamDoc = await getDoc(doc(db, 'leagues', leagueId, 'teams', teamId));
                if (!teamDoc.exists()) {
                    throw new Error('Team not found');
                }
                teamData = { id: teamId, ...teamDoc.data() };

                // Load all teams for standings
                const teamsSnap = await getDocs(collection(db, 'leagues', leagueId, 'teams'));
                standings = teamsSnap.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => {
                        // Sort by points, then wins, then point differential
                        const aPoints = (a.wins || 0) * 2 + (a.draws || 0);
                        const bPoints = (b.wins || 0) * 2 + (b.draws || 0);
                        if (bPoints !== aPoints) return bPoints - aPoints;
                        if ((b.wins || 0) !== (a.wins || 0)) return (b.wins || 0) - (a.wins || 0);
                        return ((b.points_for || 0) - (b.points_against || 0)) - ((a.points_for || 0) - (a.points_against || 0));
                    });

                // Load players from team data
                if (teamData.player_ids) {
                    players = teamData.player_ids.map((id, i) => ({
                        id,
                        name: teamData.player_names?.[i] || 'Unknown',
                        is_captain: teamData.captain_id === id || i === 0,
                        level: teamData.player_levels?.[i] || null
                    }));
                }

                // Load matches
                const matchesSnap = await getDocs(collection(db, 'leagues', leagueId, 'matches'));
                matches = matchesSnap.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(m => m.home_team_id === teamId || m.away_team_id === teamId)
                    .sort((a, b) => {
                        // Sort by week, completed first
                        if (a.status === 'completed' && b.status !== 'completed') return -1;
                        if (b.status === 'completed' && a.status !== 'completed') return 1;
                        return (a.week || 0) - (b.week || 0);
                    });

                renderPage();

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('mainContent').innerHTML = `<div class="empty-state"><div class="empty-state-icon">!</div>${error.message}</div>`;
            }
        }

        function renderPage() {
            const wins = teamData.wins || 0;
            const losses = teamData.losses || 0;
            const draws = teamData.draws || 0;

            const html = `
                <div class="team-header">
                    <div class="team-name">${teamData.team_name}</div>
                    <div class="team-meta">${leagueData.league_name || leagueData.name}</div>
                    <div class="team-record">
                        <span class="record-stat">W<span class="value">${wins}</span></span>
                        <span class="record-stat">L<span class="value">${losses}</span></span>
                        ${draws > 0 ? `<span class="record-stat">D<span class="value">${draws}</span></span>` : ''}
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('players')">PLAYERS</div>
                    <div class="tab" onclick="switchTab('matches')">MATCHES</div>
                    <div class="tab" onclick="switchTab('standings')">STANDINGS</div>
                </div>

                <div id="playersTab" class="tab-content active">
                    ${renderPlayers()}
                </div>

                <div id="matchesTab" class="tab-content">
                    ${renderMatches()}
                </div>

                <div id="standingsTab" class="tab-content">
                    ${renderStandings()}
                </div>
            `;

            document.getElementById('mainContent').innerHTML = html;
        }

        function renderPlayers() {
            if (players.length === 0) {
                return '<div class="empty-state"><div class="empty-state-icon">?</div>No players on roster</div>';
            }

            return `
                <div class="players-grid">
                    ${players.map(p => `
                        <div class="player-card ${p.is_captain ? 'captain' : ''}" onclick="viewPlayer('${p.id}')">
                            <div class="player-name">${p.name}</div>
                            <span class="player-role ${p.is_captain ? 'captain' : 'player'}">${p.is_captain ? 'Captain' : 'Player'}</span>
                            ${p.level ? `<span class="player-role player" style="margin-left: 5px;">${p.level}</span>` : ''}
                            <div class="player-stats">
                                <div>Click to view profile</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderMatches() {
            const completedMatches = matches.filter(m => m.status === 'completed');
            const upcomingMatches = matches.filter(m => m.status !== 'completed');

            if (matches.length === 0) {
                return '<div class="empty-state"><div class="empty-state-icon">?</div>No matches scheduled</div>';
            }

            let html = '';

            if (completedMatches.length > 0) {
                html += '<h3 style="font-family: Bebas Neue, cursive; color: var(--teal); margin-bottom: 15px;">COMPLETED MATCHES</h3>';
                html += completedMatches.map(m => renderMatchCard(m)).join('');
            }

            if (upcomingMatches.length > 0) {
                html += '<h3 style="font-family: Bebas Neue, cursive; color: var(--yellow); margin: 20px 0 15px;">UPCOMING MATCHES</h3>';
                html += upcomingMatches.map(m => renderMatchCard(m, true)).join('');
            }

            return html;
        }

        function renderMatchCard(match, upcoming = false) {
            const isHome = match.home_team_id === teamId;
            const ourScore = isHome ? (match.home_score || 0) : (match.away_score || 0);
            const theirScore = isHome ? (match.away_score || 0) : (match.home_score || 0);
            const opponent = isHome ? match.away_team_name : match.home_team_name;
            const won = ourScore > theirScore;

            return `
                <div class="match-card">
                    <div class="match-card-header" onclick="toggleMatch('${match.id}')">
                        <div>
                            <div class="match-teams">${isHome ? 'vs' : '@'} ${opponent}</div>
                            <div class="match-date">Week ${match.week || '?'} - ${formatDate(match.match_date)}</div>
                        </div>
                        ${upcoming ? `
                            <div class="match-score" style="color: var(--yellow);">UPCOMING</div>
                        ` : `
                            <div class="match-score ${won ? 'win' : 'loss'}">${ourScore} - ${theirScore}</div>
                        `}
                    </div>
                    <div class="match-details" id="matchDetails_${match.id}">
                        ${renderMatchDetails(match, isHome)}
                    </div>
                </div>
            `;
        }

        function renderMatchDetails(match, isHome) {
            if (!match.games || match.games.length === 0) {
                return '<div style="text-align: center; color: #aaa; padding: 15px;">No game details available</div>';
            }

            return match.games.map((game, i) => {
                const homePlayer = game.home_player || 'TBD';
                const awayPlayer = game.away_player || 'TBD';
                const homeWon = game.home_legs > game.away_legs;

                return `
                    <div class="game-row">
                        <div class="game-players">
                            <strong>Game ${i + 1}:</strong> ${homePlayer} vs ${awayPlayer}
                            <div style="font-size: 11px; color: #888;">${game.game_type || '501'}</div>
                        </div>
                        <div class="game-result ${(isHome && homeWon) || (!isHome && !homeWon) ? 'win' : 'loss'}">
                            ${game.home_legs || 0} - ${game.away_legs || 0}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderStandings() {
            if (standings.length === 0) {
                return '<div class="empty-state"><div class="empty-state-icon">?</div>No standings available</div>';
            }

            return `
                <div style="overflow-x: auto;">
                    <table class="standings-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>TEAM</th>
                                <th>W</th>
                                <th>L</th>
                                <th>PTS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${standings.map((t, i) => {
                                const rank = i + 1;
                                const points = (t.wins || 0) * 2 + (t.draws || 0);
                                const isCurrent = t.id === teamId;

                                return `
                                    <tr class="${isCurrent ? 'current-team' : ''}">
                                        <td>
                                            <span class="rank-badge ${rank <= 3 ? 'rank-' + rank : ''}">${rank}</span>
                                        </td>
                                        <td style="cursor: pointer;" onclick="viewTeam('${t.id}')">${t.team_name}</td>
                                        <td>${t.wins || 0}</td>
                                        <td>${t.losses || 0}</td>
                                        <td style="color: var(--yellow); font-weight: bold;">${points}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        };

        window.toggleMatch = function(matchId) {
            const details = document.getElementById('matchDetails_' + matchId);
            details.classList.toggle('expanded');
        };

        window.viewPlayer = function(playerId) {
            window.location.href = `/pages/player-public.html?player_id=${playerId}&league_id=${leagueId}`;
        };

        window.viewTeam = function(otherTeamId) {
            if (otherTeamId !== teamId) {
                window.location.href = `/pages/team-profile.html?league_id=${leagueId}&team_id=${otherTeamId}`;
            }
        };

        function formatDate(dateStr) {
            if (!dateStr) return 'TBD';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        loadData();
    </script>
</body>
</html>
