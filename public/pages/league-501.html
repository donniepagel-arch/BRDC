<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>501 Scorer - BRDC League</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BRDC">
    <link rel="apple-touch-icon" href="/images/gold_logo.png">
    <meta name="theme-color" content="#FF469A">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rowdies:wght@700&family=Inter:wght@400;600;700;800;900&display=swap');

        :root {
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --bg-dark: #0a0a1a;
            --bg-panel: #12122a;
            --text-light: #f0f0f0;
            --text-dim: #7a7a9a;
            --home-color: #FF469A;
            --away-color: #91D7EB;
            --border-color: #2a2a4a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; -ms-touch-action: manipulation; }
        button, .calc-key, .side-btn, .action-btn, .modal-btn, .score-value, .score-input-value, .player-chip, .throw-item { touch-action: manipulation; -ms-touch-action: manipulation; }
        html { height: 100%; height: 100dvh; }
        body {
            height: 100%;
            height: 100dvh;
            overflow: hidden;
            background: linear-gradient(180deg, var(--bg-dark) 0%, #050510 100%);
            color: var(--text-light);
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .container { display: flex; flex-direction: column; height: 100%; max-height: 100dvh; }

        /* Header */
        .header {
            background: var(--bg-panel);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--pink);
            flex-shrink: 0;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .back-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: var(--text-light);
            padding: 6px 12px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 1px;
            cursor: pointer;
            border-radius: 6px;
        }
        .game-title { font-family: 'Rowdies', cursive; font-size: 20px; text-shadow: 2px 2px 0 rgba(0,0,0,0.5); }
        .game-format {
            background: var(--yellow);
            color: #000;
            padding: 4px 10px;
            font-size: 10px;
            font-weight: 800;
            border-radius: 4px;
            letter-spacing: 1px;
        }
        .leg-indicator {
            background: rgba(0,0,0,0.4);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 2px;
            border: 2px solid rgba(255,255,255,0.1);
        }

        /* Score Display */
        .score-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            flex: 0 0 auto;
            overflow: hidden;
        }

        .team-panel {
            display: flex;
            flex-direction: column;
            padding: 8px;
            position: relative;
        }
        .team-panel.home {
            background: linear-gradient(180deg, rgba(255,70,154,0.12) 0%, transparent 100%);
            border-right: 1px solid var(--border-color);
        }
        .team-panel.away {
            background: linear-gradient(180deg, rgba(145,215,235,0.12) 0%, transparent 100%);
            border-left: 1px solid var(--border-color);
        }
        .team-panel.active {
            box-shadow: inset 0 0 40px rgba(253,216,53,0.15);
        }
        .team-panel.active::before {
            content: 'THROWING';
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--yellow);
            color: #000;
            padding: 3px 12px;
            font-size: 9px;
            font-weight: 800;
            border-radius: 10px;
            letter-spacing: 1px;
            z-index: 10;
        }

        .team-header { text-align: center; padding-top: 8px; }
        .team-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
            opacity: 0.7;
            font-weight: 700;
        }
        .team-label.home { color: var(--pink); }
        .team-label.away { color: var(--teal); }

        .player-names {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            min-height: 36px;
            margin-top: 4px;
        }
        .player-name { display: block; line-height: 1.2; }
        .player-name.throwing { color: var(--yellow); }

        .score-value {
            font-family: 'Rowdies', cursive;
            font-size: 100px;
            line-height: 1;
            text-align: center;
            margin: 4px 0;
            text-shadow: 4px 4px 0 rgba(0,0,0,0.5);
            cursor: pointer;
            transition: transform 0.1s;
        }
        .score-value:active {
            transform: scale(0.95);
        }
        .team-panel.home .score-value { color: var(--pink); }
        .team-panel.away .score-value { color: var(--teal); }

        /* Checkout Hint */
        .checkout-hint {
            text-align: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            font-weight: 400;
            color: var(--yellow);
            background: rgba(253,216,53,0.15);
            padding: 4px 10px;
            border-radius: 4px;
            margin: 0 auto 4px;
            max-width: 180px;
            border: 1px solid rgba(253,216,53,0.3);
            min-height: 22px;
            letter-spacing: 1px;
        }

        .legs-display {
            text-align: center;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .legs-display span {
            background: rgba(0,0,0,0.4);
            padding: 3px 10px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 4px;
            margin-top: 4px;
        }
        .stat-box {
            background: rgba(0,0,0,0.4);
            padding: 4px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .stat-box .value {
            font-family: 'Rowdies', cursive;
            font-size: 14px;
            color: var(--yellow);
        }
        .stat-box .label {
            font-size: 7px;
            text-transform: uppercase;
            color: var(--text-dim);
            letter-spacing: 1px;
            font-weight: 700;
        }

        /* Input Section - Calculator Style */
        .input-section {
            background: var(--bg-panel);
            border-top: 3px solid var(--pink);
            padding: 10px 0;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0));
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .input-layout {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            width: 100%;
            height: 100%;
        }

        .keypad-area {
            flex: 1;
            min-width: 0;
            padding: 0 10px;
            max-width: 400px;
            margin: 0 auto;
        }

        .score-input-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .score-input-value {
            background: rgba(0,0,0,0.6);
            border: 3px solid var(--yellow);
            border-radius: 10px;
            padding: 10px 20px;
            width: 100%;
            text-align: center;
            font-family: 'Rowdies', cursive;
            font-size: 48px;
            color: var(--yellow);
            box-shadow: 0 0 20px rgba(253,216,53,0.2);
            cursor: pointer;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .score-input-value.invalid {
            border-color: #ef4444;
            color: #ef4444;
            box-shadow: 0 0 20px rgba(239,68,68,0.3);
        }

        .score-input-value.checkout-hint-mode {
            font-size: 28px;
            font-family: 'Bebas Neue', cursive;
            color: rgba(253,216,53,0.5);
            letter-spacing: 3px;
        }

        /* Calculator Keypad with Side Quick Buttons - DartConnect Style */
        .keypad-container {
            display: grid;
            grid-template-columns: 58px 1fr 58px;
            gap: 5px;
            margin-bottom: 6px;
        }

        .side-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .side-btn {
            flex: 1;
            background: linear-gradient(180deg, rgba(253,216,53,0.3) 0%, rgba(253,216,53,0.15) 100%);
            border: 2px solid var(--yellow);
            color: var(--yellow);
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            font-weight: 400;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s;
            padding: 8px 2px;
            min-height: 60px;
        }
        .side-btn:active {
            background: var(--yellow);
            color: #000;
            transform: scale(0.95);
        }

        .calc-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }

        .calc-key {
            background: linear-gradient(180deg, #2a2a4a 0%, #1a1a35 100%);
            border: 3px solid rgba(255,255,255,0.25);
            color: var(--text-light);
            padding: 20px 10px;
            font-size: 36px;
            font-weight: 800;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.1s;
            font-family: 'Bebas Neue', cursive;
            box-shadow: 0 3px 0 rgba(0,0,0,0.4);
            min-height: 68px;
        }

        .calc-key:active {
            background: var(--yellow);
            color: #000;
            transform: translateY(2px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.4);
            border-color: var(--yellow);
        }

        /* Bottom row - 5 columns */
        .calc-bottom-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin-bottom: 8px;
        }

        .calc-bottom-row .calc-key {
            padding: 16px 6px;
            font-size: 26px;
            min-height: 58px;
        }

        .calc-key.operator {
            background: linear-gradient(180deg, rgba(145,215,235,0.4) 0%, rgba(145,215,235,0.2) 100%);
            border-color: var(--teal);
            color: var(--teal);
        }
        .calc-key.operator:active {
            background: var(--teal);
            color: #000;
        }

        .calc-key.shortcut {
            background: linear-gradient(180deg, rgba(255,70,154,0.4) 0%, rgba(255,70,154,0.2) 100%);
            border-color: var(--pink);
            color: var(--pink);
        }
        .calc-key.shortcut:active {
            background: var(--pink);
            color: #fff;
        }

        /* Action Buttons */
        .action-row {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 8px;
        }

        .action-btn {
            padding: 18px;
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 2px;
            cursor: pointer;
            border-radius: 8px;
            border: none;
            box-shadow: 0 4px 0 rgba(0,0,0,0.4);
            transition: all 0.1s;
        }
        .action-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 rgba(0,0,0,0.4); }
        .action-btn.undo { background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%); color: white; }
        .action-btn.miss { background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%); color: white; }
        .action-btn.enter { background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%); color: white; font-size: 24px; }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(5,5,16,0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-panel);
            border: 4px solid var(--pink);
            border-radius: 16px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 0 60px rgba(255,70,154,0.3), 8px 8px 0 rgba(0,0,0,0.5);
        }
        .modal-title {
            font-family: 'Rowdies', cursive;
            font-size: 28px;
            color: var(--yellow);
            text-shadow: 3px 3px 0 rgba(0,0,0,0.5);
            margin-bottom: 8px;
        }
        .winner-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            margin: 12px 0;
            letter-spacing: 2px;
        }
        .modal-stats {
            background: rgba(0,0,0,0.4);
            padding: 14px;
            border-radius: 10px;
            margin: 12px 0;
            text-align: left;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .modal-stats .row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-weight: 600;
            font-size: 14px;
        }
        .modal-stats .row:last-child { border-bottom: none; }
        .modal-stats .row .val { color: var(--yellow); }
        .modal-btn {
            background: linear-gradient(180deg, var(--yellow) 0%, #f59e0b 100%);
            color: #000;
            border: 3px solid #000;
            padding: 12px 24px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 2px;
            cursor: pointer;
            border-radius: 8px;
            margin: 6px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
        }
        .modal-btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 rgba(0,0,0,0.5); }
        .modal-btn.secondary { background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%); color: white; }

        /* Game Select Buttons */
        .game-select-btn {
            padding: 14px 20px;
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .game-select-btn:hover, .game-select-btn:active {
            background: linear-gradient(180deg, var(--teal) 0%, #6bc0d4 100%);
            border-color: var(--teal);
            color: #000;
        }

        /* Wrong Game Button - inline with header */
        .wrong-game-btn {
            padding: 4px 8px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 4px;
            color: #f87171;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 8px;
        }
        .wrong-game-btn:hover {
            background: rgba(239, 68, 68, 0.4);
        }
        .wrong-game-btn.hidden {
            display: none;
        }

        /* Setup Screen Styles */
        .setup-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, var(--bg-dark) 0%, #050510 100%);
            overflow-y: auto;
            z-index: 2000;
            padding: 20px;
        }
        .setup-screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .setup-container {
            background: var(--bg-panel);
            border: 4px solid var(--pink);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            margin: 20px auto;
            box-shadow: 0 0 60px rgba(255,70,154,0.2);
        }
        .setup-header {
            text-align: center;
            margin-bottom: 24px;
        }
        .setup-title {
            font-family: 'Rowdies', cursive;
            font-size: 32px;
            color: var(--pink);
            text-shadow: 3px 3px 0 rgba(0,0,0,0.5);
            margin-bottom: 8px;
        }
        .setup-subtitle {
            font-size: 14px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }
        .setup-section {
            margin-bottom: 20px;
        }
        .setup-section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--yellow);
            letter-spacing: 2px;
            margin-bottom: 10px;
            border-bottom: 2px solid rgba(253,216,53,0.3);
            padding-bottom: 4px;
        }
        .setup-form-group {
            margin-bottom: 14px;
        }
        .setup-label {
            display: block;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }
        .setup-input {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 16px;
            font-weight: 600;
        }
        .setup-input:focus {
            outline: none;
            border-color: var(--pink);
            background: rgba(255,70,154,0.1);
        }
        .setup-input::placeholder {
            color: var(--text-dim);
        }
        .setup-select {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .setup-select:focus {
            outline: none;
            border-color: var(--pink);
        }
        .setup-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .setup-toggle-group {
            display: flex;
            gap: 8px;
        }
        .setup-toggle-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .setup-toggle-btn:hover {
            background: rgba(255,255,255,0.12);
        }
        .setup-toggle-btn.active {
            background: var(--pink);
            border-color: var(--pink);
            color: white;
        }
        .setup-start-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(180deg, var(--yellow) 0%, #d4a600 100%);
            color: #000;
            border: 3px solid #000;
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            letter-spacing: 3px;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
            transition: all 0.1s;
            margin-top: 10px;
        }
        .setup-start-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.5);
        }
        .setup-back-btn {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: var(--text-light);
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 2px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Double Out Selection Modal */
        .darts-select {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 20px 0;
        }
        .dart-count-btn {
            background: linear-gradient(180deg, rgba(253,216,53,0.3) 0%, rgba(253,216,53,0.1) 100%);
            border: 4px solid var(--yellow);
            color: var(--yellow);
            width: 85px;
            height: 85px;
            border-radius: 50%;
            font-family: 'Rowdies', cursive;
            font-size: 36px;
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dart-count-btn:active, .dart-count-btn.selected {
            background: var(--yellow);
            border-color: var(--yellow);
            color: #000;
            transform: scale(0.95);
        }
        .dart-count-btn:disabled {
            background: rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.2);
            cursor: not-allowed;
        }

        /* Quick Out Selector */
        .quick-out-container {
            background: rgba(253, 216, 53, 0.1);
            border: 2px solid var(--yellow);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .quick-out-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .quick-out-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--yellow);
            color: var(--yellow);
            padding: 10px 16px;
            border-radius: 8px;
            font-family: 'Rowdies', cursive;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .quick-out-btn:active {
            background: var(--yellow);
            color: #000;
        }

        /* Throw History - Side Layout */
        .side-history {
            width: 90px;
            flex-shrink: 0;
            background: rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            padding: 6px 4px;
            border-radius: 0;
            max-height: 100%;
        }
        .side-history.home {
            border-right: 3px solid var(--pink);
        }
        .side-history.away {
            border-left: 3px solid var(--teal);
        }
        .history-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 6px;
            text-align: center;
            flex-shrink: 0;
        }
        .side-history.home .history-label { color: var(--pink); }
        .side-history.away .history-label { color: var(--teal); }
        .history-throws {
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }
        .throw-item {
            background: rgba(255,255,255,0.08);
            padding: 8px 4px;
            border-radius: 6px;
            font-size: 28px;
            font-weight: 700;
            font-family: 'Bebas Neue', cursive;
            text-align: center;
            letter-spacing: 1px;
            cursor: pointer;
            transition: background 0.15s;
            flex-shrink: 0;
            min-height: 44px;
        }
        .throw-item:active {
            background: rgba(255,255,255,0.2);
        }
        .throw-item.home { border-left: 3px solid var(--pink); }
        .throw-item.away { border-right: 3px solid var(--teal); }
        .throw-item.ton { color: var(--yellow); }
        .throw-item.ton80 { color: var(--yellow); background: rgba(253,216,53,0.2); }
        .throw-item.bust { color: #ef4444; text-decoration: line-through; opacity: 0.6; }

        @media (max-width: 500px) {
            .score-value { font-size: 72px; }
            .score-input-value { font-size: 36px; padding: 8px 12px; min-height: 70px; }
            .calc-key { padding: 16px 8px; font-size: 30px; min-height: 58px; }
            .calc-bottom-row .calc-key { padding: 12px 4px; font-size: 22px; min-height: 50px; }
            .side-btn { font-size: 20px; padding: 6px 2px; min-height: 50px; }
            .action-btn { padding: 12px; font-size: 16px; }
            .action-btn.enter { font-size: 18px; }
            .side-history { width: 70px; padding: 4px 3px; }
            .throw-item { font-size: 24px; padding: 6px 3px; min-height: 40px; }
            .history-label { font-size: 9px; }
            .keypad-area { padding: 0 4px; }
            .keypad-container { grid-template-columns: 50px 1fr 50px; gap: 4px; }
        }

        /* Game Shot Quick Select */
        .game-shot-select {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 10px;
        }
        .game-shot-select.active {
            display: flex;
        }
        .game-shot-title {
            font-family: 'Rowdies', cursive;
            font-size: 28px;
            color: var(--yellow);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.5);
        }
        .game-shot-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--teal);
            letter-spacing: 2px;
        }
        .dart-select-row {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .dart-select-btn {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 4px solid var(--yellow);
            background: linear-gradient(180deg, rgba(253,216,53,0.3) 0%, rgba(253,216,53,0.1) 100%);
            color: var(--yellow);
            font-family: 'Rowdies', cursive;
            font-size: 36px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .dart-select-btn:active {
            background: var(--yellow);
            color: #000;
            transform: scale(0.95);
        }
        .dart-select-btn .dart-label {
            font-size: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            margin-top: -4px;
        }
        .dart-select-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .game-shot-cancel {
            margin-top: 8px;
            padding: 10px 30px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 2px;
            cursor: pointer;
        }

        /* Mobile Responsiveness */
        @media (max-width: 480px) {
            /* Reduce score font size on narrow screens */
            .score-value {
                font-size: 72px;
            }

            /* Keypad container - narrower side buttons */
            .keypad-container {
                grid-template-columns: 48px 1fr 48px;
            }

            .side-btn {
                font-size: 20px;
                min-height: 54px;
            }

            /* Calc keys smaller on mobile */
            .calc-key {
                padding: 16px 8px;
                font-size: 30px;
                min-height: 58px;
            }

            /* Bottom row - adjust for narrow screens */
            .calc-bottom-row {
                grid-template-columns: repeat(5, 1fr);
                gap: 3px;
            }

            .calc-bottom-row .calc-key {
                padding: 12px 4px;
                font-size: 20px;
                min-height: 50px;
            }

            /* Action row */
            .action-row {
                gap: 4px;
            }

            .action-btn {
                padding: 14px 8px;
                font-size: 14px;
            }

            /* Header adjustments */
            .header {
                padding: 6px 8px;
            }

            .game-title {
                font-size: 16px;
            }

            .game-format {
                padding: 3px 6px;
                font-size: 9px;
            }

            /* Stats grid */
            .stats-grid {
                gap: 3px;
            }

            .stat-box {
                padding: 3px 5px;
            }

            .stat-val {
                font-size: 12px;
            }

            /* Fix asymmetric border - add border-left to away panel */
            .team-panel.away {
                border-left: 2px solid var(--border-color);
            }

            /* Modal adjustments for mobile */
            .modal-content {
                padding: 15px;
                margin: 10px;
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        @media (max-width: 360px) {
            /* Very narrow phones */
            .score-value {
                font-size: 60px;
            }

            .keypad-container {
                grid-template-columns: 42px 1fr 42px;
            }

            .side-btn {
                font-size: 18px;
                min-height: 48px;
            }

            .calc-key {
                font-size: 26px;
                padding: 14px 6px;
                min-height: 52px;
            }

            .calc-bottom-row .calc-key {
                font-size: 18px;
                padding: 10px 2px;
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <button class="back-btn" onclick="exitGame()">EXIT</button>
                <span class="game-title" id="gameTitle">GAME 1</span>
                <span class="game-format" id="gameFormat">501 DO</span>
                <button class="wrong-game-btn" id="wrongGameBtn" onclick="showGameSelector('current')">WRONG GAME?</button>
            </div>
            <div class="leg-indicator" id="legIndicator">LEG 1</div>
        </div>

        <div class="score-display">
            <!-- Home Team -->
            <div class="team-panel home active" id="homePanel">
                <div class="team-header">
                    <div class="team-label home">HOME</div>
                    <div class="player-names" id="homeNames">
                        <span class="player-name" id="homeName1">Player A</span>
                        <span class="player-name" id="homeName2"></span>
                    </div>
                </div>
                <div class="score-value" id="homeScore" onclick="submitRemainingScore(0)">501</div>
                <div class="checkout-hint" id="homeCheckout"></div>
                <div class="legs-display"><span id="homeLegs">0</span> LEGS</div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="homeLegAvg">0.0</div>
                        <div class="label">Leg Avg</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="homeAvg">0.0</div>
                        <div class="label">Match Avg</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="homeDarts">0</div>
                        <div class="label">Darts</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="home180s">0</div>
                        <div class="label">180s</div>
                    </div>
                </div>
            </div>

            <!-- Away Team -->
            <div class="team-panel away" id="awayPanel">
                <div class="team-header">
                    <div class="team-label away">AWAY</div>
                    <div class="player-names" id="awayNames">
                        <span class="player-name" id="awayName1">Player B</span>
                        <span class="player-name" id="awayName2"></span>
                    </div>
                </div>
                <div class="score-value" id="awayScore" onclick="submitRemainingScore(1)">501</div>
                <div class="checkout-hint" id="awayCheckout"></div>
                <div class="legs-display"><span id="awayLegs">0</span> LEGS</div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="awayLegAvg">0.0</div>
                        <div class="label">Leg Avg</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="awayAvg">0.0</div>
                        <div class="label">Match Avg</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="awayDarts">0</div>
                        <div class="label">Darts</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="away180s">0</div>
                        <div class="label">180s</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-layout">
                <!-- Home Throws - Left Side -->
                <div class="side-history home">
                    <div class="history-label">HOME</div>
                    <div class="history-throws" id="homeThrows"></div>
                </div>

                <!-- Center Keypad Area -->
                <div class="keypad-area">
                    <div class="score-input-display">
                        <div class="score-input-value" id="scoreInput" onclick="clearInput()">0</div>
                    </div>

                    <!-- Game Shot Quick Select (shown when checkout score entered) -->
                    <div class="game-shot-select" id="gameShotSelect">
                        <div class="game-shot-title">GAME SHOT!</div>
                        <div class="game-shot-score" id="gameShotScore">141 checkout</div>
                        <div style="font-size: 12px; opacity: 0.7; margin-bottom: 8px;">Which dart hit the out?</div>
                        <div class="dart-select-row">
                            <button class="dart-select-btn" id="dart1Btn" onclick="completeCheckoutQuick(1)">
                                1st<span class="dart-label">DART</span>
                            </button>
                            <button class="dart-select-btn" id="dart2Btn" onclick="completeCheckoutQuick(2)">
                                2nd<span class="dart-label">DART</span>
                            </button>
                            <button class="dart-select-btn" id="dart3Btn" onclick="completeCheckoutQuick(3)">
                                3rd<span class="dart-label">DART</span>
                            </button>
                        </div>
                        <button class="game-shot-cancel" onclick="cancelGameShot()">CANCEL</button>
                    </div>

                    <!-- Quick Checkout Buttons (shown when on checkout) -->
                    <div class="quick-out-container" id="quickOutContainer" style="display: none;">
                        <div style="font-size: 11px; color: var(--yellow); letter-spacing: 2px; margin-bottom: 8px;">QUICK OUTS</div>
                        <div class="quick-out-grid" id="quickOutGrid">
                            <!-- Populated dynamically based on remaining score -->
                        </div>
                    </div>

                    <div class="keypad-container" id="keypadContainer">
                        <div class="side-buttons">
                            <button class="side-btn" onclick="quickScore(26)">26</button>
                            <button class="side-btn" onclick="quickScore(41)">41</button>
                            <button class="side-btn" onclick="quickScore(45)">45</button>
                            <button class="side-btn" onclick="quickScore(60)">60</button>
                        </div>
                        <div class="calc-keypad">
                            <button class="calc-key" onclick="appendDigit('1')">1</button>
                            <button class="calc-key" onclick="appendDigit('2')">2</button>
                            <button class="calc-key" onclick="appendDigit('3')">3</button>
                            <button class="calc-key" onclick="appendDigit('4')">4</button>
                            <button class="calc-key" onclick="appendDigit('5')">5</button>
                            <button class="calc-key" onclick="appendDigit('6')">6</button>
                            <button class="calc-key" onclick="appendDigit('7')">7</button>
                            <button class="calc-key" onclick="appendDigit('8')">8</button>
                            <button class="calc-key" onclick="appendDigit('9')">9</button>
                        </div>
                        <div class="side-buttons">
                            <button class="side-btn" onclick="quickScore(81)">81</button>
                            <button class="side-btn" onclick="quickScore(85)">85</button>
                            <button class="side-btn" onclick="quickScore(121)">121</button>
                            <button class="side-btn" onclick="quickScore(180)">180</button>
                        </div>
                    </div>

                    <div class="calc-bottom-row">
                        <button class="calc-key shortcut" onclick="quickScore(100)">100</button>
                        <button class="calc-key operator" onclick="multiply()">x</button>
                        <button class="calc-key" onclick="appendDigit('0')">0</button>
                        <button class="calc-key operator" onclick="add()">+</button>
                        <button class="calc-key shortcut" onclick="quickScore(140)">140</button>
                    </div>

                    <div class="action-row">
                        <button class="action-btn undo" onclick="undoScore()">UNDO</button>
                        <button class="action-btn miss" onclick="submitScore(0)">MISS</button>
                        <button class="action-btn enter" onclick="submitCurrentScore()">ENTER</button>
                    </div>
                </div>

                <!-- Away Throws - Right Side -->
                <div class="side-history away">
                    <div class="history-label">AWAY</div>
                    <div class="history-throws" id="awayThrows"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leg Complete Modal -->
    <div class="modal" id="legModal">
        <div class="modal-content">
            <div class="modal-title">LEG COMPLETE!</div>
            <div class="winner-name" id="legWinnerName">Player Wins</div>
            <div class="modal-stats" id="legStats"></div>
            <div id="nextGameInfo" style="display: none; margin: 16px 0; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                <div style="font-size: 13px; color: var(--text-dim); margin-bottom: 6px;">NEXT GAME</div>
                <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <span id="nextGameLabel" style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--teal);"></span>
                    <button onclick="showGameSelector()" style="background: var(--yellow); color: #000; border: 2px solid #000; padding: 6px 12px; font-weight: 700; font-size: 12px; border-radius: 4px; cursor: pointer;">CHANGE</button>
                </div>
            </div>
            <button class="modal-btn" onclick="nextLeg()">NEXT LEG</button>
        </div>
    </div>

    <!-- Game Selector Modal -->
    <div class="modal" id="gameSelectorModal">
        <div class="modal-content" style="max-width: 340px;">
            <div class="modal-title" style="font-size: 24px;">SELECT GAME</div>
            <div style="display: flex; flex-direction: column; gap: 8px; margin: 16px 0;">
                <button class="game-select-btn" onclick="selectNextGame('501')">501</button>
                <button class="game-select-btn" onclick="selectNextGame('301')">301</button>
                <button class="game-select-btn" onclick="selectNextGame('cricket')">CRICKET</button>
                <button class="game-select-btn" onclick="selectNextGame('x01')">X01 (CUSTOM)</button>
            </div>
            <div id="x01CustomOptions" style="display: none; margin: 12px 0; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                <div style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                    <input type="number" id="x01CustomScore" value="501" min="101" max="1001" step="100" style="width: 80px; padding: 8px; background: rgba(255,255,255,0.1); border: 2px solid var(--teal); border-radius: 4px; color: white; font-weight: 700; text-align: center;">
                    <select id="x01CustomIn" style="padding: 8px; background: var(--bg-dark); border: 2px solid var(--teal); border-radius: 4px; color: white; font-weight: 600;">
                        <option value="straight">SI</option>
                        <option value="double">DI</option>
                    </select>
                    <select id="x01CustomOut" style="padding: 8px; background: var(--bg-dark); border: 2px solid var(--teal); border-radius: 4px; color: white; font-weight: 600;">
                        <option value="double" selected>DO</option>
                        <option value="straight">SO</option>
                        <option value="master">MO</option>
                    </select>
                </div>
                <button onclick="confirmX01Selection()" style="margin-top: 10px; width: 100%; padding: 10px; background: var(--teal); color: #000; border: 2px solid #000; font-weight: 700; border-radius: 4px; cursor: pointer;">CONFIRM</button>
            </div>
            <button class="modal-btn secondary" onclick="closeGameSelector()" style="margin-top: 8px;">CANCEL</button>
        </div>
    </div>

    <!-- Game Complete Modal -->
    <div class="modal" id="gameModal">
        <div class="modal-content">
            <div class="modal-title">GAME OVER!</div>
            <div class="winner-name" id="gameWinnerName">Player Wins</div>
            <div class="modal-stats" id="gameStats"></div>
            <button class="modal-btn" onclick="saveGame()">SAVE RESULT</button>
            <button class="modal-btn secondary" onclick="exitWithoutSave()">EXIT</button>
        </div>
    </div>

    <!-- Checkout Darts Modal (for double out) -->
    <div class="modal" id="dartsModal">
        <div class="modal-content" style="max-width: 360px;">
            <div class="modal-title" style="color: var(--yellow); font-size: 36px;">GAME SHOT!</div>
            <div id="checkoutScoreDisplay" style="font-family: 'Rowdies', cursive; font-size: 48px; color: var(--teal); margin: 10px 0;"></div>
            <div class="winner-name" style="font-size: 16px; opacity: 0.8; margin-bottom: 16px;">Which dart hit the out?</div>
            <div class="darts-select" style="gap: 12px;">
                <button class="dart-count-btn" id="dartBtn1" onclick="confirmCheckout(1)" style="flex-direction: column; padding: 16px 20px;">
                    <span style="font-size: 28px;">1st</span>
                    <span style="font-size: 11px; opacity: 0.7; margin-top: 4px;">DART</span>
                </button>
                <button class="dart-count-btn" id="dartBtn2" onclick="confirmCheckout(2)" style="flex-direction: column; padding: 16px 20px;">
                    <span style="font-size: 28px;">2nd</span>
                    <span style="font-size: 11px; opacity: 0.7; margin-top: 4px;">DART</span>
                </button>
                <button class="dart-count-btn" id="dartBtn3" onclick="confirmCheckout(3)" style="flex-direction: column; padding: 16px 20px;">
                    <span style="font-size: 28px;">3rd</span>
                    <span style="font-size: 11px; opacity: 0.7; margin-top: 4px;">DART</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Game Shot Confirmation Modal -->
    <div class="modal" id="confirmGameModal">
        <div class="modal-content">
            <div class="modal-title" style="color: var(--yellow);">GAME SHOT!</div>
            <div class="winner-name" id="confirmWinnerName">Player wins the game!</div>
            <div style="font-size: 28px; font-family: 'Rowdies', cursive; color: var(--teal); margin: 15px 0;" id="confirmCheckoutScore">141 checkout</div>
            <div style="font-size: 14px; opacity: 0.7; margin-bottom: 20px;">Confirm this is correct?</div>
            <div style="display: flex; gap: 12px;">
                <button class="modal-btn" onclick="confirmGameWin()" style="flex: 1;">CONFIRM</button>
                <button class="modal-btn secondary" onclick="undoGameWin()" style="flex: 1;">UNDO</button>
            </div>
        </div>
    </div>

    <!-- Match Complete Modal -->
    <div class="modal" id="matchCompleteModal">
        <div class="modal-content" style="max-width: 440px; border-color: var(--yellow);">
            <div style="font-size: 64px; margin-bottom: 8px;">üèÜ</div>
            <div class="modal-title" style="font-size: 36px; margin-bottom: 16px;">MATCH COMPLETE!</div>

            <!-- Score Display -->
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin: 24px 0;">
                <div style="text-align: center; flex: 1;">
                    <div id="matchCompleteHomeName" style="font-size: 14px; color: var(--pink); letter-spacing: 1px; margin-bottom: 4px;">HOME</div>
                    <div id="matchCompleteHomeScore" style="font-size: 72px; font-family: 'Bebas Neue', cursive; line-height: 1;">0</div>
                </div>
                <div style="font-size: 28px; color: var(--text-muted);">-</div>
                <div style="text-align: center; flex: 1;">
                    <div id="matchCompleteAwayName" style="font-size: 14px; color: var(--teal); letter-spacing: 1px; margin-bottom: 4px;">AWAY</div>
                    <div id="matchCompleteAwayScore" style="font-size: 72px; font-family: 'Bebas Neue', cursive; line-height: 1;">0</div>
                </div>
            </div>

            <!-- Winner Announcement -->
            <div id="matchCompleteWinner" style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--yellow); letter-spacing: 2px; margin: 16px 0;">WINNER WINS!</div>

            <!-- Key Stats Summary -->
            <div id="matchCompleteStats" class="modal-stats" style="margin: 20px 0;"></div>

            <!-- Buttons -->
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <button class="modal-btn" onclick="viewMatchReport()" style="width: 100%;">VIEW MATCH REPORT</button>
                <button class="modal-btn secondary" onclick="backToHub()" style="width: 100%;">BACK TO HUB</button>
            </div>
        </div>
    </div>

    <!-- PIN Entry Screen -->
    <div class="modal" id="pinEntryScreen" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-title" style="font-size: 28px;">ENTER MATCH PIN</div>
            <div style="margin: 20px 0; font-size: 14px; opacity: 0.8;">Enter the 6-character match PIN to start scoring</div>
            <div style="display: flex; justify-content: center; gap: 8px; margin: 20px 0;" id="pinInputContainer">
                <input type="text" maxlength="1" class="pin-char" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-family: 'Bebas Neue', cursive; background: rgba(255,255,255,0.1); border: 2px solid var(--pink); border-radius: 8px; color: #fff; text-transform: uppercase;">
                <input type="text" maxlength="1" class="pin-char" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-family: 'Bebas Neue', cursive; background: rgba(255,255,255,0.1); border: 2px solid var(--pink); border-radius: 8px; color: #fff; text-transform: uppercase;">
                <input type="text" maxlength="1" class="pin-char" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-family: 'Bebas Neue', cursive; background: rgba(255,255,255,0.1); border: 2px solid var(--pink); border-radius: 8px; color: #fff; text-transform: uppercase;">
                <input type="text" maxlength="1" class="pin-char" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-family: 'Bebas Neue', cursive; background: rgba(255,255,255,0.1); border: 2px solid var(--pink); border-radius: 8px; color: #fff; text-transform: uppercase;">
                <input type="text" maxlength="1" class="pin-char" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-family: 'Bebas Neue', cursive; background: rgba(255,255,255,0.1); border: 2px solid var(--pink); border-radius: 8px; color: #fff; text-transform: uppercase;">
                <input type="text" maxlength="1" class="pin-char" style="width: 45px; height: 55px; text-align: center; font-size: 24px; font-family: 'Bebas Neue', cursive; background: rgba(255,255,255,0.1); border: 2px solid var(--pink); border-radius: 8px; color: #fff; text-transform: uppercase;">
            </div>
            <div id="pinError" style="color: var(--pink); font-size: 14px; margin-bottom: 15px; display: none;"></div>
            <button class="modal-btn" onclick="loadMatchByPin()" id="loadMatchBtn">LOAD MATCH</button>
        </div>
    </div>

    <!-- Casual Setup Screen -->
    <div class="setup-screen" id="setupScreen">
        <div class="setup-container">
            <div class="setup-header">
                <div class="setup-title">501 SCORER</div>
                <div class="setup-subtitle">CASUAL GAME SETUP</div>
            </div>

            <!-- Players Section -->
            <div class="setup-section">
                <div class="setup-section-title">PLAYERS</div>
                <div class="setup-grid-2">
                    <div class="setup-form-group">
                        <label class="setup-label">Player 1</label>
                        <input type="text" id="setupPlayer1" class="setup-input" placeholder="Player 1">
                    </div>
                    <div class="setup-form-group">
                        <label class="setup-label">Player 2</label>
                        <input type="text" id="setupPlayer2" class="setup-input" placeholder="Player 2">
                    </div>
                </div>
            </div>

            <!-- Match Format Section -->
            <div class="setup-section">
                <div class="setup-section-title">MATCH FORMAT</div>
                <div class="setup-grid-2">
                    <div class="setup-form-group">
                        <label class="setup-label">Best of (Legs)</label>
                        <select id="setupLegs" class="setup-select">
                            <option value="1">1 Leg</option>
                            <option value="3" selected>3 Legs</option>
                            <option value="5">5 Legs</option>
                            <option value="7">7 Legs</option>
                            <option value="9">9 Legs</option>
                        </select>
                    </div>
                    <div class="setup-form-group">
                        <label class="setup-label">Starting Score</label>
                        <select id="setupScore" class="setup-select">
                            <option value="301">301</option>
                            <option value="501" selected>501</option>
                            <option value="701">701</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Game Options Section -->
            <div class="setup-section">
                <div class="setup-section-title">GAME OPTIONS</div>
                <div class="setup-grid-2">
                    <div class="setup-form-group">
                        <label class="setup-label">Double In</label>
                        <div class="setup-toggle-group">
                            <button class="setup-toggle-btn active" onclick="toggleSetupDI(false)">OFF</button>
                            <button class="setup-toggle-btn" onclick="toggleSetupDI(true)">ON</button>
                        </div>
                    </div>
                    <div class="setup-form-group">
                        <label class="setup-label">Double Out</label>
                        <div class="setup-toggle-group">
                            <button class="setup-toggle-btn" onclick="toggleSetupDO(false)">OFF</button>
                            <button class="setup-toggle-btn active" onclick="toggleSetupDO(true)">ON</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Starting Rules Section -->
            <div class="setup-section">
                <div class="setup-section-title">WHO STARTS FIRST?</div>
                <div class="setup-toggle-group" style="flex-direction: column; gap: 8px;">
                    <button class="setup-toggle-btn active" onclick="setSetupStarter('cork')">Cork for it</button>
                    <button class="setup-toggle-btn" onclick="setSetupStarter('player1')">Player 1 starts</button>
                    <button class="setup-toggle-btn" onclick="setSetupStarter('player2')">Player 2 starts</button>
                    <button class="setup-toggle-btn" onclick="setSetupStarter('alternate')">Alternate (loser starts)</button>
                </div>
            </div>

            <button class="setup-start-btn" onclick="startCasualGame()">START GAME</button>
            <button class="setup-back-btn" onclick="window.location.href='/pages/game-setup.html'">BACK TO GAME SETUP</button>
        </div>
    </div>

    <!-- Pre-Leg Popup (Always shows before each leg) -->
    <div class="modal" id="starterModal">
        <div class="modal-content" style="max-width: 420px;">
            <!-- Leg Info Header -->
            <div id="preLegHeader" style="margin-bottom: 20px;">
                <div id="starterLegInfo" style="font-size: 16px; opacity: 0.7; letter-spacing: 2px; margin-bottom: 8px;">LEG 1</div>
                <div id="preLegGame" style="font-size: 28px; font-family: 'Bebas Neue', cursive; color: var(--yellow); letter-spacing: 2px;">501 DOUBLE OUT</div>
            </div>

            <!-- Teams Display -->
            <div id="preLegTeams" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding: 16px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 12px; color: var(--pink); letter-spacing: 1px; margin-bottom: 4px;">HOME</div>
                    <div id="preLegHomeName" style="font-size: 18px; font-weight: 700;">Team 1</div>
                </div>
                <div style="font-size: 16px; color: var(--text-dim); padding: 0 16px;">VS</div>
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 12px; color: var(--teal); letter-spacing: 1px; margin-bottom: 4px;">AWAY</div>
                    <div id="preLegAwayName" style="font-size: 18px; font-weight: 700;">Team 2</div>
                </div>
            </div>

            <!-- Cork Section (when cork is needed) -->
            <div id="corkSection" style="display: none;">
                <!-- Cork Ready Phase -->
                <div id="corkReadyPhase">
                    <div style="font-size: 14px; opacity: 0.7; margin-bottom: 12px;">DETERMINE STARTER</div>
                    <button class="modal-btn" onclick="startCorkShuffle()" style="width: 100%; font-size: 18px; padding: 16px; background: linear-gradient(180deg, var(--yellow) 0%, #d4a600 100%); color: #000;">
                        &#127919; CORK IT
                    </button>
                </div>

                <!-- Cork Shuffle Phase -->
                <div id="corkShufflePhase" style="display: none;">
                    <div style="font-size: 14px; opacity: 0.7; margin-bottom: 8px;">THROWS AT BULL FIRST...</div>
                    <div id="shuffleName" style="font-size: 48px; font-family: 'Archivo Black', sans-serif; color: var(--yellow); padding: 20px 0;"></div>
                </div>

                <!-- Throws First Phase -->
                <div id="throwsFirstPhase" style="display: none;">
                    <div id="throwsFirstName" style="font-size: 36px; font-family: 'Archivo Black', sans-serif; margin-bottom: 4px;"></div>
                    <div style="font-size: 16px; opacity: 0.8; margin-bottom: 20px;">THROWS AT BULL FIRST</div>
                    <button class="modal-btn primary" onclick="showWhoGotIt()" style="width: 100%; font-size: 18px; padding: 16px;">CONTINUE</button>
                </div>

                <!-- Who Got It Phase -->
                <div id="whoGotItPhase" style="display: none;">
                    <div style="font-size: 16px; margin-bottom: 16px;">WHO GOT CLOSEST?</div>
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn" onclick="corkWinner(0)" id="corkHomeBtn" style="flex: 1; background: linear-gradient(180deg, var(--pink) 0%, #cc3879 100%); font-size: 16px; padding: 18px 12px;"></button>
                        <button class="modal-btn" onclick="corkWinner(1)" id="corkAwayBtn" style="flex: 1; background: linear-gradient(180deg, var(--teal) 0%, #5cb8d3 100%); color: #000; font-size: 16px; padding: 18px 12px;"></button>
                    </div>
                </div>

                <!-- Choose First or Second Phase (after cork winner) -->
                <div id="chooseOrderPhase" style="display: none;">
                    <div style="font-size: 14px; opacity: 0.7; margin-bottom: 8px;">CORK WINNER</div>
                    <div id="chooseOrderWinner" style="font-size: 28px; font-family: 'Archivo Black', sans-serif; color: var(--yellow); margin-bottom: 16px;"></div>
                    <div style="font-size: 16px; margin-bottom: 16px;">CHOOSE YOUR OPTION</div>
                    <div style="display: flex; gap: 12px;">
                        <button class="modal-btn primary" onclick="chooseThrowOrder('first')" style="flex: 1; padding: 18px 12px; font-size: 16px;">
                            THROW FIRST
                        </button>
                        <button class="modal-btn" onclick="chooseThrowOrder('second')" style="flex: 1; padding: 18px 12px; font-size: 16px; background: rgba(255,255,255,0.1);">
                            THROW SECOND
                        </button>
                    </div>
                </div>
            </div>

            <!-- No Cork Section (starter already determined) -->
            <div id="noCorkSection" style="display: none;">
                <div style="font-size: 14px; opacity: 0.7; margin-bottom: 8px;">STARTING</div>
                <div id="starterName" style="font-size: 36px; font-family: 'Archivo Black', sans-serif; color: var(--yellow); margin-bottom: 20px;"></div>
                <button class="modal-btn primary" onclick="confirmStarter()" style="width: 100%; font-size: 18px; padding: 16px;">READY</button>
            </div>

            <!-- Starter Ready Phase (after cork winner selected) -->
            <div id="starterReadyPhase" style="display: none;">
                <div style="font-size: 14px; opacity: 0.7; margin-bottom: 8px;">STARTING</div>
                <div id="starterReadyName" style="font-size: 36px; font-family: 'Archivo Black', sans-serif; color: var(--yellow); margin-bottom: 20px;"></div>
                <button class="modal-btn primary" onclick="confirmStarter()" style="width: 100%; font-size: 18px; padding: 16px;">READY</button>
            </div>

            <!-- Corks Choice Game Selector (shows after cork winner for corks_choice mode) -->
            <div id="corksChoicePhase" style="display: none;">
                <div style="font-size: 14px; opacity: 0.7; margin-bottom: 8px;">CORK WINNER CHOOSES</div>
                <div id="corksChoiceWinner" style="font-size: 28px; font-family: 'Archivo Black', sans-serif; color: var(--yellow); margin-bottom: 16px;"></div>
                <div style="font-size: 14px; margin-bottom: 16px;">SELECT GAME TYPE</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="modal-btn" onclick="selectCorksChoiceGame('501')" style="padding: 14px; font-size: 16px;">501</button>
                    <button class="modal-btn" onclick="selectCorksChoiceGame('301')" style="padding: 14px; font-size: 16px;">301</button>
                    <button class="modal-btn" onclick="selectCorksChoiceGame('701')" style="padding: 14px; font-size: 16px;">701</button>
                    <button class="modal-btn" onclick="selectCorksChoiceGame('cricket')" style="padding: 14px; font-size: 16px;">CRICKET</button>
                </div>
            </div>

            <!-- Game OR Start Phase (winner picks game OR to start first) -->
            <div id="gameOrStartPhase" style="display: none;">
                <div style="font-size: 14px; opacity: 0.7; margin-bottom: 8px;">CORK WINNER</div>
                <div id="gameOrStartWinner" style="font-size: 28px; font-family: 'Archivo Black', sans-serif; color: var(--yellow); margin-bottom: 16px;"></div>
                <div style="font-size: 14px; margin-bottom: 16px;">PICK THE GAME OR START FIRST</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                    <button class="modal-btn" onclick="gameOrStartPickGame('501')" style="padding: 14px; font-size: 16px;">501</button>
                    <button class="modal-btn" onclick="gameOrStartPickGame('301')" style="padding: 14px; font-size: 16px;">301</button>
                    <button class="modal-btn" onclick="gameOrStartPickGame('701')" style="padding: 14px; font-size: 16px;">701</button>
                    <button class="modal-btn" onclick="gameOrStartPickGame('cricket')" style="padding: 14px; font-size: 16px;">CRICKET</button>
                </div>
                <div style="margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px;">
                    <button class="modal-btn primary" onclick="gameOrStartPickStart()" style="width: 100%; padding: 16px; font-size: 18px; background: linear-gradient(180deg, #4CAF50 0%, #2E7D32 100%);">üéØ START FIRST</button>
                </div>
            </div>

            <!-- Opponent Picks Game Phase (when cork winner chose to start) -->
            <div id="opponentPicksGamePhase" style="display: none;">
                <div style="font-size: 14px; opacity: 0.7; margin-bottom: 8px;">OPPONENT PICKS GAME</div>
                <div id="opponentPicksGameName" style="font-size: 28px; font-family: 'Archivo Black', sans-serif; color: var(--yellow); margin-bottom: 16px;"></div>
                <div style="font-size: 14px; margin-bottom: 16px;">SELECT GAME TYPE</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="modal-btn" onclick="opponentSelectGame('501')" style="padding: 14px; font-size: 16px;">501</button>
                    <button class="modal-btn" onclick="opponentSelectGame('301')" style="padding: 14px; font-size: 16px;">301</button>
                    <button class="modal-btn" onclick="opponentSelectGame('701')" style="padding: 14px; font-size: 16px;">701</button>
                    <button class="modal-btn" onclick="opponentSelectGame('cricket')" style="padding: 14px; font-size: 16px;">CRICKET</button>
                </div>
            </div>

            <!-- Cork's Choice for Doubles (format=choice) - Simple 501 vs Cricket -->
            <div id="doublesChoicePhase" style="display: none;">
                <div id="doublesChoiceWinner" style="font-size: 24px; font-family: 'Archivo Black', sans-serif; color: var(--yellow); margin-bottom: 8px;"></div>
                <div style="font-size: 16px; opacity: 0.8; margin-bottom: 24px;">CHOOSE YOUR GAME</div>
                <div style="display: flex; gap: 16px;">
                    <button class="modal-btn" onclick="selectDoublesChoice('501')" style="flex: 1; padding: 32px 20px; font-size: 32px; font-family: 'Archivo Black', sans-serif; background: linear-gradient(180deg, var(--pink) 0%, #cc3879 100%); border-radius: 12px;">
                        501
                    </button>
                    <button class="modal-btn" onclick="selectDoublesChoice('cricket')" style="flex: 1; padding: 32px 20px; font-size: 28px; font-family: 'Archivo Black', sans-serif; background: linear-gradient(180deg, var(--teal) 0%, #5cb8d3 100%); color: #000; border-radius: 12px;">
                        CRICKET
                    </button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
import { callFunction, showLoading, hideLoading } from '/js/firebase-config.js';
import { callWithQueue, setupOfflineQueue, processCallQueue, saveGameState, getGameState, clearGameState, initOfflineStorage } from '/js/offline-storage.js';

// Setup offline queue for automatic retry
setupOfflineQueue(callFunction);

// Checkout table
const CHECKOUTS = {
    170: 'T20 T20 Bull', 167: 'T20 T19 Bull', 164: 'T20 T18 Bull', 161: 'T20 T17 Bull',
    160: 'T20 T20 D20', 158: 'T20 T20 D19', 157: 'T20 T19 D20', 156: 'T20 T20 D18',
    155: 'T20 T19 D19', 154: 'T20 T18 D20', 153: 'T20 T19 D18', 152: 'T20 T20 D16',
    151: 'T20 T17 D20', 150: 'T20 T18 D18', 149: 'T20 T19 D16', 148: 'T20 T20 D14',
    147: 'T20 T17 D18', 146: 'T20 T18 D16', 145: 'T20 T15 D20', 144: 'T20 T20 D12',
    143: 'T20 T17 D16', 142: 'T20 T14 D20', 141: 'T20 T19 D12', 140: 'T20 T20 D10',
    139: 'T20 T13 D20', 138: 'T20 T18 D12', 137: 'T20 T19 D10', 136: 'T20 T20 D8',
    135: 'T20 T15 D15', 134: 'T20 T14 D16', 133: 'T20 T19 D8', 132: 'T20 T16 D12',
    131: 'T20 T13 D16', 130: 'T20 T18 D8', 129: 'T19 T16 D12', 128: 'T18 T14 D16',
    127: 'T20 T17 D8', 126: 'T19 T19 D6', 125: 'T20 T15 D10', 124: 'T20 T14 D11',
    123: 'T19 T16 D9', 122: 'T18 T18 D7', 121: 'T20 T11 D14', 120: 'T20 S20 D20',
    119: 'T19 T12 D13', 118: 'T20 S18 D20', 117: 'T20 S17 D20', 116: 'T20 S16 D20',
    115: 'T20 S15 D20', 114: 'T20 S14 D20', 113: 'T20 S13 D20', 112: 'T20 S12 D20',
    111: 'T20 S11 D20', 110: 'T20 S10 D20', 109: 'T20 S9 D20', 108: 'T20 S16 D16',
    107: 'T19 S10 D20', 106: 'T20 S6 D20', 105: 'T20 S5 D20', 104: 'T18 S10 D20',
    103: 'T19 S6 D20', 102: 'T20 S10 D16', 101: 'T17 S10 D20', 100: 'T20 D20',
    99: 'T19 S10 D16', 98: 'T20 D19', 97: 'T19 D20', 96: 'T20 D18', 95: 'T19 D19',
    94: 'T18 D20', 93: 'T19 D18', 92: 'T20 D16', 91: 'T17 D20', 90: 'T18 D18',
    89: 'T19 D16', 88: 'T20 D14', 87: 'T17 D18', 86: 'T18 D16', 85: 'T15 D20',
    84: 'T20 D12', 83: 'T17 D16', 82: 'T14 D20', 81: 'T19 D12', 80: 'T20 D10',
    79: 'T13 D20', 78: 'T18 D12', 77: 'T19 D10', 76: 'T20 D8', 75: 'T17 D12',
    74: 'T14 D16', 73: 'T19 D8', 72: 'T16 D12', 71: 'T13 D16', 70: 'T18 D8',
    69: 'T19 D6', 68: 'T20 D4', 67: 'T17 D8', 66: 'T10 D18', 65: 'T19 D4',
    64: 'T16 D8', 63: 'T13 D12', 62: 'T10 D16', 61: 'T15 D8', 60: 'S20 D20',
    59: 'S19 D20', 58: 'S18 D20', 57: 'S17 D20', 56: 'T16 D4', 55: 'S15 D20',
    54: 'S14 D20', 53: 'S13 D20', 52: 'S12 D20', 51: 'S11 D20', 50: 'S10 D20',
    49: 'S9 D20', 48: 'S16 D16', 47: 'S15 D16', 46: 'S6 D20', 45: 'S13 D16',
    44: 'S12 D16', 43: 'S11 D16', 42: 'S10 D16', 41: 'S9 D16', 40: 'D20',
    39: 'S7 D16', 38: 'D19', 37: 'S5 D16', 36: 'D18', 35: 'S3 D16', 34: 'D17',
    33: 'S1 D16', 32: 'D16', 31: 'S15 D8', 30: 'D15', 29: 'S13 D8', 28: 'D14',
    27: 'S11 D8', 26: 'D13', 25: 'S9 D8', 24: 'D12', 23: 'S7 D8', 22: 'D11',
    21: 'S5 D8', 20: 'D10', 19: 'S3 D8', 18: 'D9', 17: 'S1 D8', 16: 'D8',
    15: 'S7 D4', 14: 'D7', 13: 'S5 D4', 12: 'D6', 11: 'S3 D4', 10: 'D5',
    9: 'S1 D4', 8: 'D4', 7: 'S3 D2', 6: 'D3', 5: 'S1 D2', 4: 'D2', 3: 'S1 D1', 2: 'D1'
};

// URL Parameters (mutable for PIN-loaded matches)
const params = new URLSearchParams(window.location.search);
let leagueId = params.get('league_id');
let matchId = params.get('match_id');
let tournamentId = params.get('tournament_id'); // Tournament support
let tournamentMatchId = params.get('tournament_match_id'); // Tournament match ID
let gameIndex = parseInt(params.get('game_index') || '0');
let gameNumber = parseInt(params.get('game_number') || '1');
let checkout = params.get('checkout') || 'double';
let inRule = params.get('in_rule') || 'straight';
let adminPin = params.get('admin_pin') || '';
let fromMatch = params.get('from_match') === 'true';
let isCasual = params.get('casual') === 'true';
let matchPin = params.get('match_pin') || '';
let isKnockout = params.get('knockout') === 'true';
let knockoutId = params.get('knockout_id') || '';
let knockoutMatchNumber = parseInt(params.get('match_number') || '0');
let totalGames = parseInt(params.get('total_games') || '0');
let homeTeamName = decodeURIComponent(params.get('home_team_name') || 'Home');
let awayTeamName = decodeURIComponent(params.get('away_team_name') || 'Away');

let homePlayers = [], awayPlayers = [];
try { homePlayers = JSON.parse(params.get('home_players') || '[]'); } catch(e) {}
try { awayPlayers = JSON.parse(params.get('away_players') || '[]'); } catch(e) {}

// For choice games, default to 501 until cork winner chooses
const formatParam = params.get('format');
let STARTING_SCORE = formatParam === 'choice' ? 501 : parseInt(params.get('starting_score') || formatParam || '501');
let LEGS_TO_WIN = parseInt(params.get('legs_to_win') || '2');
let useCork = params.get('cork') !== 'false'; // Default to cork unless explicitly disabled
let corkRule = params.get('cork_rule') || 'alternate_cork_first_deciding';
let corkOption = params.get('cork_option') || 'alternate_random_first_last'; // Who has option to choose first/second
let corkOptionHolder = null; // Who has the option this leg
let lastLegWinner = null; // Track who won the previous leg for loser_starts rule
let lastLegStarter = null; // Track who started the previous leg for alternating
let loadedMatchData = null; // Store full match data for saving
let practiceMode = params.get('practice_mode') || null;
let isChicago = params.get('chicago') === 'true';
let chicagoGame = parseInt(params.get('chicago_game') || '0');
let isMixedGame = params.get('mixed') === 'true';
let mixedLegIndex = parseInt(params.get('mixed_leg') || '0');
let isCorksChoice = params.get('corks_choice') === 'true';
let corkWinnerGets = params.get('cork_winner_gets') || 'choose-and-start'; // choose-and-start, choose-only, choose-or-start

// Cork's Choice for doubles games (format=choice) - simpler than full corks_choice
let isChoiceGame = params.get('format') === 'choice' || params.get('game_type') === 'choice';
let chosenFormat = null; // Will be '501' or 'cricket' after cork winner chooses
let corkWinnerSide = null; // 'home' or 'away' - tracks who won the cork
let isVerificationMode = params.get('verification_mode') === 'true';

// Resume mode params
let isResumeMode = params.get('resume') === 'true';
let resumeHomeScore = parseInt(params.get('resume_home_score') || STARTING_SCORE);
let resumeAwayScore = parseInt(params.get('resume_away_score') || STARTING_SCORE);
let resumeHomeDarts = parseInt(params.get('resume_home_darts') || '0');
let resumeAwayDarts = parseInt(params.get('resume_away_darts') || '0');
let resumeActiveTeam = parseInt(params.get('resume_active') || '0');

// Fallback bot config for bots without x01_skills (legacy support)
const BOT_CONFIG_FALLBACK = {
    easy:   { avg: 40, variance: 15, checkout_pct_low: 20, checkout_pct_81: 8, checkout_pct_101: 3, checkout_pct_141: 1, pct_100: 5, pct_140: 1, pct_171: 0 },
    medium: { avg: 55, variance: 18, checkout_pct_low: 45, checkout_pct_81: 30, checkout_pct_101: 18, checkout_pct_141: 8, pct_100: 25, pct_140: 8, pct_171: 1 },
    league: { avg: 65, variance: 20, checkout_pct_low: 55, checkout_pct_81: 38, checkout_pct_101: 25, checkout_pct_141: 12, pct_100: 35, pct_140: 15, pct_171: 2 },
    hard:   { avg: 75, variance: 22, checkout_pct_low: 65, checkout_pct_81: 48, checkout_pct_101: 32, checkout_pct_141: 18, pct_100: 45, pct_140: 22, pct_171: 4 },
    pro:    { avg: 90, variance: 25, checkout_pct_low: 80, checkout_pct_81: 58, checkout_pct_101: 40, checkout_pct_141: 25, pct_100: 65, pct_140: 35, pct_171: 8 }
};

// Check if away team is a bot
function isAwayBot() {
    // Support both old practice mode format and new isBot format from game-setup
    return (practiceMode && awayPlayers[0]?.is_bot) || awayPlayers[0]?.isBot;
}

// Check if home team is a bot
function isHomeBot() {
    return homePlayers[0]?.isBot;
}

// Check if current active team is a bot
function isCurrentTeamBot() {
    return activeTeam === 0 ? isHomeBot() : isAwayBot();
}

// Get bot skills for a team - uses actual x01_skills if available
function getBotSkills(teamIndex) {
    const players = teamIndex === 0 ? homePlayers : awayPlayers;
    const bot = players[0];

    // If bot has actual x01_skills from database, use them
    if (bot?.x01_skills) {
        const skills = bot.x01_skills;
        // Calculate variance based on skill level (higher avg = higher variance for realism)
        const avg = skills.three_dart_avg || 55;
        const variance = Math.max(12, avg * 0.35); // ~35% of avg, min 12

        return {
            avg: avg,
            variance: variance,
            checkout_pct_low: (skills.checkout_pct_low || 45) / 100,
            checkout_pct_81: (skills.checkout_pct_81 || 30) / 100,
            checkout_pct_101: (skills.checkout_pct_101 || 18) / 100,
            checkout_pct_141: (skills.checkout_pct_141 || 8) / 100,
            pct_100: (skills.pct_100_plus || 25) / 100,
            pct_140: (skills.pct_140_plus || 8) / 100,
            pct_171: (skills.pct_171_plus || 1) / 100
        };
    }

    // Fallback to difficulty-based config for legacy bots
    const difficulty = bot?.botDifficulty || bot?.bot_level || 'medium';
    const fallback = BOT_CONFIG_FALLBACK[difficulty] || BOT_CONFIG_FALLBACK.medium;
    return {
        avg: fallback.avg,
        variance: fallback.variance,
        checkout_pct_low: fallback.checkout_pct_low / 100,
        checkout_pct_81: fallback.checkout_pct_81 / 100,
        checkout_pct_101: fallback.checkout_pct_101 / 100,
        checkout_pct_141: fallback.checkout_pct_141 / 100,
        pct_100: fallback.pct_100 / 100,
        pct_140: fallback.pct_140 / 100,
        pct_171: fallback.pct_171 / 100
    };
}

// Get tiered checkout percentage based on checkout score
function getCheckoutPct(skills, checkoutScore) {
    if (checkoutScore >= 141) return skills.checkout_pct_141;
    if (checkoutScore >= 101) return skills.checkout_pct_101;
    if (checkoutScore >= 81) return skills.checkout_pct_81;
    return skills.checkout_pct_low;
}

// Generate bot score using actual x01_skills
function generateBotScore(teamIndex, currentScore) {
    const skills = getBotSkills(teamIndex);

    // Check if bot can checkout
    if (currentScore <= 170 && CHECKOUTS[currentScore]) {
        const checkoutPct = getCheckoutPct(skills, currentScore);
        if (Math.random() < checkoutPct) {
            // Successful checkout - determine darts used (1-3)
            // Higher checkouts more likely to need 3 darts
            let dartsUsed;
            if (currentScore >= 100) {
                dartsUsed = Math.random() < 0.1 ? 2 : 3; // 10% 2-dart, 90% 3-dart
            } else if (currentScore >= 60) {
                dartsUsed = Math.random() < 0.3 ? 1 : (Math.random() < 0.5 ? 2 : 3);
            } else {
                dartsUsed = Math.random() < 0.4 ? 1 : (Math.random() < 0.7 ? 2 : 3);
            }
            return { score: currentScore, isCheckout: true, dartsUsed };
        }
    }

    // Generate score using actual skill probabilities
    let score;
    const roll = Math.random();

    // Check for big scores based on actual skill percentages
    if (roll < skills.pct_171) {
        // 171-180 score (very rare, based on bot's actual pct_171_plus)
        score = 171 + Math.floor(Math.random() * 10); // 171-180
    } else if (roll < skills.pct_171 + skills.pct_140) {
        // 140-170 score (based on bot's actual pct_140_plus)
        score = 140 + Math.floor(Math.random() * 31); // 140-170
    } else if (roll < skills.pct_171 + skills.pct_140 + skills.pct_100) {
        // 100-139 score (based on bot's actual pct_100_plus)
        score = 100 + Math.floor(Math.random() * 40); // 100-139
    } else {
        // Normal score with variance around average
        score = skills.avg + (Math.random() - 0.5) * skills.variance * 2;
        score = Math.round(score);
    }

    // Clamp to valid range
    score = Math.max(0, Math.min(180, score));

    // Don't bust - if score would bust, play safe
    if (score >= currentScore) {
        // Leave a good checkout if possible
        if (currentScore <= 170) {
            score = Math.floor(currentScore * 0.3); // Play safe, leave checkout
        } else {
            score = Math.floor(currentScore * 0.6); // Reduce score
        }
    }

    // Avoid leaving impossible checkouts (like 169, 168, 166, 165, 163, 162, 159)
    const remaining = currentScore - score;
    const impossibleScores = [169, 168, 166, 165, 163, 162, 159];
    if (impossibleScores.includes(remaining)) {
        score = Math.max(0, score - 1);
    }

    return { score, isCheckout: false, dartsUsed: 3 };
}

// Bot plays its turn
let botPlaying = false; // Prevent duplicate bot plays

function botPlay() {
    if (!isCurrentTeamBot()) return;
    if (botPlaying) return; // Already playing
    botPlaying = true;

    const currentScore = teams[activeTeam].score;

    // Delay for realism (shorter for bot vs bot)
    const isBotVsBot = isHomeBot() && isAwayBot();
    const delay = isBotVsBot ? (400 + Math.random() * 300) : (800 + Math.random() * 700);

    setTimeout(() => {
        const result = generateBotScore(activeTeam, currentScore);

        if (result.isCheckout) {
            // Bot checks out
            completeCheckout(result.score, result.dartsUsed);
        } else {
            // Normal score - call submitScore directly with the value
            setTimeout(() => {
                submitScore(result.score);
            }, isBotVsBot ? 150 : 300);
        }
    }, delay);
}

// Game State
let activeTeam = 0;
let activePlayerIndex = [0, 0]; // Track which player on each team is throwing [home, away]
let corkFirstThrow = null; // Who throws first at the bull
let inputValue = '0';
let leg = 1;
let gameStartTime = Date.now();
let history = []; // For undo
let pendingCheckout = null;
let pendingGameWin = null; // Store state for game-winning confirmation
let throwHistory = [[], []]; // Track throws for each team [home, away]

// DartConnect-compatible throw tracking per leg
let legThrowsHistory = []; // Array of throwHistory snapshots for each completed leg
let legFirstThrow = []; // Who threw first in each leg (0=home, 1=away)
let currentLegFirstThrow = null; // Who threw first in current leg
let legCorkWinner = []; // Who won the cork for each leg ('home', 'away', or null if no cork)
let currentLegCorkWinner = null; // Who won the cork for current leg

// Leg tracking for summaries
let legStats = [[], []]; // Track each leg's stats for both teams
let currentLegStats = [{}, {}]; // Stats for current leg
let playerLegStats = {}; // Per-player stats for current leg (for doubles)
let allPlayerLegStats = []; // History of playerLegStats for each completed leg

// Create empty stat object for a player
function createEmptyPlayerStats() {
    return {
        darts: 0, points: 0, first9Points: 0, first9Darts: 0,
        tons: 0, ton40s: 0, ton80s: 0, checkout: 0,
        ton_00: 0, ton_20: 0, ton_40: 0, ton_60: 0, ton_80: 0,
        ton_71: 0, checkout_attempts: 0, checkout_darts: 0, high_score: 0,
        first_turn_score: 0, ton_points: 0, threw_first: null,
        co_80_attempts: 0, co_80_hits: 0,
        co_120_attempts: 0, co_120_hits: 0,
        co_140_attempts: 0, co_140_hits: 0,
        co_161_attempts: 0, co_161_hits: 0
    };
}

function resetCurrentLegStats() {
    currentLegStats = [
        {
            darts: 0, points: 0, first9Points: 0, first9Darts: 0,
            tons: 0, ton40s: 0, ton80s: 0, checkout: 0,
            // DartConnect breakdown: T00, T20, T40, T60, T80
            ton_00: 0, ton_20: 0, ton_40: 0, ton_60: 0, ton_80: 0,
            ton_71: 0, // 171s
            checkout_attempts: 0, checkout_darts: 0, high_score: 0,
            // NEW: HSI (High Straight In) tracking
            first_turn_score: 0,
            // NEW: Sum of all 100+ turn scores (Ton Points)
            ton_points: 0,
            // NEW: With/Against Darts tracking
            threw_first: null,
            // NEW: Checkout % by range tracking
            co_80_attempts: 0, co_80_hits: 0,
            co_120_attempts: 0, co_120_hits: 0,
            co_140_attempts: 0, co_140_hits: 0,
            co_161_attempts: 0, co_161_hits: 0
        },
        {
            darts: 0, points: 0, first9Points: 0, first9Darts: 0,
            tons: 0, ton40s: 0, ton80s: 0, checkout: 0,
            // DartConnect breakdown: T00, T20, T40, T60, T80
            ton_00: 0, ton_20: 0, ton_40: 0, ton_60: 0, ton_80: 0,
            ton_71: 0, // 171s
            checkout_attempts: 0, checkout_darts: 0, high_score: 0,
            // NEW: HSI (High Straight In) tracking
            first_turn_score: 0,
            // NEW: Sum of all 100+ turn scores (Ton Points)
            ton_points: 0,
            // NEW: With/Against Darts tracking
            threw_first: null,
            // NEW: Checkout % by range tracking
            co_80_attempts: 0, co_80_hits: 0,
            co_120_attempts: 0, co_120_hits: 0,
            co_140_attempts: 0, co_140_hits: 0,
            co_161_attempts: 0, co_161_hits: 0
        }
    ];

    // Reset per-player stats for doubles
    playerLegStats = {};
    homePlayers.forEach(p => {
        if (p?.name) playerLegStats[p.name] = createEmptyPlayerStats();
    });
    awayPlayers.forEach(p => {
        if (p?.name) playerLegStats[p.name] = createEmptyPlayerStats();
    });

    // Reset player indices for new leg
    activePlayerIndex = [0, 0];
}
resetCurrentLegStats();

let teams = [
    {
        name: homePlayers.map(p => p?.name || 'Home').join(' & ') || 'Home',
        score: STARTING_SCORE,
        legs: 0,
        darts: 0,
        points: 0,
        tons: 0,
        ton40s: 0,
        ton80s: 0,
        // DartConnect breakdown
        ton_00: 0, ton_20: 0, ton_40: 0, ton_60: 0, ton_80: 0,
        ton_71: 0,
        highCheckout: 0,
        highScore: 0,
        bestLeg: 999, // Best leg darts (lower is better)
        totalCheckouts: 0,
        checkoutAttempts: 0,
        checkoutDarts: 0, // Total darts thrown at doubles
        first9Darts: 0,
        first9Points: 0
    },
    {
        name: awayPlayers.map(p => p?.name || 'Away').join(' & ') || 'Away',
        score: STARTING_SCORE,
        legs: 0,
        darts: 0,
        points: 0,
        tons: 0,
        ton40s: 0,
        ton80s: 0,
        // DartConnect breakdown
        ton_00: 0, ton_20: 0, ton_40: 0, ton_60: 0, ton_80: 0,
        ton_71: 0,
        highCheckout: 0,
        highScore: 0,
        bestLeg: 999,
        totalCheckouts: 0,
        checkoutAttempts: 0,
        checkoutDarts: 0,
        first9Darts: 0,
        first9Points: 0
    }
];

// Warn user before leaving with game in progress
window.onbeforeunload = function(e) {
    const gameInProgress = (teams[0].darts > 0 || teams[1].darts > 0) && !pendingGameWin;
    if (gameInProgress) {
        e.preventDefault();
        return "You have a game in progress. Are you sure you want to leave?";
    }
};

// Load leg scores from URL params (for mixed game mode)
if (isMixedGame) {
    const homeLegsParam = parseInt(params.get('home_legs') || '0');
    const awayLegsParam = parseInt(params.get('away_legs') || '0');
    teams[0].legs = homeLegsParam;
    teams[1].legs = awayLegsParam;
}

// ============================================
// OFFLINE BACKUP - Save/Restore game state
// ============================================

const GAME_STATE_ID = `x01_${leagueId || 'casual'}_${matchId || Date.now()}`;

async function backupGameState() {
    try {
        await initOfflineStorage();
        const state = {
            // Core game state
            teams: teams,
            leg: leg,
            activeTeam: activeTeam,
            activePlayerIndex: activePlayerIndex,
            throwHistory: throwHistory,
            legThrowsHistory: legThrowsHistory,
            legStats: legStats,
            currentLegStats: currentLegStats,
            playerLegStats: playerLegStats,
            allPlayerLegStats: allPlayerLegStats,
            currentLegFirstThrow: currentLegFirstThrow,
            legFirstThrow: legFirstThrow,
            currentLegCorkWinner: currentLegCorkWinner,
            legCorkWinner: legCorkWinner,
            lastLegWinner: lastLegWinner,
            lastLegStarter: lastLegStarter,

            // Game configuration
            STARTING_SCORE: STARTING_SCORE,
            LEGS_TO_WIN: LEGS_TO_WIN,
            checkout: checkout,
            inRule: inRule,
            gameNumber: gameNumber,
            gameStartTime: gameStartTime,

            // Player info
            homePlayers: homePlayers,
            awayPlayers: awayPlayers,

            // Context
            leagueId: leagueId,
            matchId: matchId,
            isMixedGame: isMixedGame,
            mixedLegIndex: mixedLegIndex,
            isCorksChoice: isCorksChoice,
            isCasual: isCasual
        };

        await saveGameState(GAME_STATE_ID, state);
        console.log('Game state backed up after leg', leg - 1);
    } catch (e) {
        console.warn('Failed to backup game state:', e);
    }
}

async function checkForSavedGame() {
    try {
        await initOfflineStorage();
        const saved = await getGameState(GAME_STATE_ID);

        if (saved && saved.teams && saved.teams[0].darts > 0) {
            // We have a saved game with actual progress
            const homeLegs = saved.teams[0].legs;
            const awayLegs = saved.teams[1].legs;
            const homeName = saved.teams[0].name;
            const awayName = saved.teams[1].name;

            if (confirm(`Resume saved game?\n\n${homeName}: ${homeLegs} legs\n${awayName}: ${awayLegs} legs\n\nClick OK to resume or Cancel to start fresh.`)) {
                restoreGameState(saved);
                return true;
            } else {
                // User chose to start fresh - clear saved state
                await clearGameState(GAME_STATE_ID);
            }
        }
    } catch (e) {
        console.warn('Error checking for saved game:', e);
    }
    return false;
}

function restoreGameState(saved) {
    // Restore core state
    teams[0] = saved.teams[0];
    teams[1] = saved.teams[1];
    leg = saved.leg;
    activeTeam = saved.activeTeam;
    activePlayerIndex = saved.activePlayerIndex || [0, 0];
    throwHistory = saved.throwHistory || [[], []];
    legThrowsHistory = saved.legThrowsHistory || [];
    legStats = saved.legStats || [[], []];
    currentLegStats = saved.currentLegStats || [{}, {}];
    playerLegStats = saved.playerLegStats || {};
    allPlayerLegStats = saved.allPlayerLegStats || [];
    currentLegFirstThrow = saved.currentLegFirstThrow;
    legFirstThrow = saved.legFirstThrow || [];
    currentLegCorkWinner = saved.currentLegCorkWinner || null;
    legCorkWinner = saved.legCorkWinner || [];
    lastLegWinner = saved.lastLegWinner;
    lastLegStarter = saved.lastLegStarter;

    // Update UI
    updateUI();
    document.getElementById('homeLegs').textContent = teams[0].legs;
    document.getElementById('awayLegs').textContent = teams[1].legs;

    console.log('Game state restored - Leg', leg, 'Score:', teams[0].legs, '-', teams[1].legs);
}

async function clearSavedGame() {
    try {
        await clearGameState(GAME_STATE_ID);
        console.log('Saved game state cleared');
    } catch (e) {
        console.warn('Error clearing saved game:', e);
    }
}

async function init() {
    document.getElementById('gameTitle').textContent = `GAME ${gameNumber}`;
    // Build format display: e.g., "501 DI/DO" or "301 SI/DO"
    const inDisplay = inRule === 'double' ? 'DI' : 'SI';
    const outDisplay = checkout === 'double' ? 'DO' : (checkout === 'master' ? 'MO' : 'SO');
    document.getElementById('gameFormat').textContent = `${STARTING_SCORE} ${inDisplay}/${outDisplay}`;

    if (homePlayers[0]) document.getElementById('homeName1').textContent = homePlayers[0].name || 'Home';
    if (homePlayers[1]) document.getElementById('homeName2').textContent = homePlayers[1].name || '';
    if (awayPlayers[0]) document.getElementById('awayName1').textContent = awayPlayers[0].name || 'Away';
    if (awayPlayers[1]) document.getElementById('awayName2').textContent = awayPlayers[1].name || '';

    // Update cork button names
    document.getElementById('corkHomeBtn').textContent = teams[0].name;
    document.getElementById('corkAwayBtn').textContent = teams[1].name;

    updateUI();

    // Start live match tracking for league/tournament games
    if ((leagueId && matchId) || tournamentId) {
        try {
            const scorerPin = localStorage.getItem('brdc_player_pin') || adminPin || matchPin;
            if (scorerPin) {
                await callFunction('startLiveMatch', {
                    scorer_pin: scorerPin,
                    match_id: matchId || tournamentMatchId,
                    event_id: leagueId || tournamentId,
                    event_type: tournamentId ? 'tournament' : 'league',
                    match_data: {
                        event_name: homeTeamName + ' vs ' + awayTeamName,
                        game_type: '501',
                        starting_score: STARTING_SCORE,
                        race_to: LEGS_TO_WIN,
                        team1_name: homeTeamName,
                        team1_player_ids: homePlayers.map(p => p?.id).filter(Boolean),
                        team1_player_names: homePlayers.map(p => p?.name).filter(Boolean),
                        team2_name: awayTeamName,
                        team2_player_ids: awayPlayers.map(p => p?.id).filter(Boolean),
                        team2_player_names: awayPlayers.map(p => p?.name).filter(Boolean)
                    }
                });
            }
        } catch (e) {
            console.warn('Failed to start live match tracking:', e);
        }
    }

    // Check for saved game state (offline recovery)
    const hasRestoredGame = await checkForSavedGame();
    if (hasRestoredGame) {
        // Game restored - don't show cork modal, just continue
        return;
    }

    // Handle bot games
    const homeIsBot = isHomeBot();
    const awayIsBot = isAwayBot();

    if (homeIsBot || awayIsBot) {
        // Skip cork for bot games
        if (homeIsBot && awayIsBot) {
            // Bot vs Bot - random starter
            activeTeam = Math.random() < 0.5 ? 0 : 1;
        } else if (awayIsBot) {
            // Human vs Bot - human starts
            activeTeam = 0;
        } else {
            // Bot vs Human - human starts
            activeTeam = 1;
        }
        updateUI();

        // Start bot play if it's a bot's turn
        if (isCurrentTeamBot()) {
            setTimeout(() => botPlay(), 500);
        }
        return;
    }

    // Show starter modal (with or without cork)
    const needsCork = shouldCorkThisLeg(leg);
    showStarterModal(needsCork);
}

// PIN Entry Functions
function setupPinEntry() {
    const pinInputs = document.querySelectorAll('.pin-char');

    pinInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
            if (e.target.value.length === 1 && index < pinInputs.length - 1) {
                pinInputs[index + 1].focus();
            }
            // Auto-submit when all filled
            const pin = Array.from(pinInputs).map(i => i.value).join('');
            if (pin.length === 6) {
                loadMatchByPin();
            }
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                pinInputs[index - 1].focus();
            }
            if (e.key === 'Enter') {
                loadMatchByPin();
            }
        });
    });

    // Focus first input
    if (pinInputs[0]) pinInputs[0].focus();
}

window.loadMatchByPin = async function() {
    const pinInputs = document.querySelectorAll('.pin-char');
    const pin = Array.from(pinInputs).map(i => i.value).join('').toUpperCase();

    if (pin.length !== 6) {
        showPinError('Enter all 6 characters');
        return;
    }

    document.getElementById('loadMatchBtn').textContent = 'LOADING...';
    document.getElementById('loadMatchBtn').disabled = true;

    try {
        const result = await callFunction('getMatchByPin', { pin: pin });

        if (!result.success) {
            showPinError(result.error || 'Match not found');
            document.getElementById('loadMatchBtn').textContent = 'LOAD MATCH';
            document.getElementById('loadMatchBtn').disabled = false;
            return;
        }

        // Redirect to match hub with the league and match IDs
        window.location.href = `/pages/match-hub.html?league_id=${result.match.league_id}&match_id=${result.match.match_id}`;

    } catch (error) {
        showPinError('Error: ' + error.message);
        document.getElementById('loadMatchBtn').textContent = 'LOAD MATCH';
        document.getElementById('loadMatchBtn').disabled = false;
    }
};

function showPinError(msg) {
    const el = document.getElementById('pinError');
    el.textContent = msg;
    el.style.display = 'block';
}

// Starter Modal Functions (Cork or Ready)
let pendingStarter = null;

function showStarterModal(needsCork) {
    // Update leg info
    document.getElementById('starterLegInfo').textContent = `LEG ${leg} of ${LEGS_TO_WIN * 2 - 1}`;

    // Update game info
    if (isCorksChoice) {
        document.getElementById('preLegGame').textContent = 'CORKS CHOICE';
    } else {
        const inText = inRule === 'double' ? 'DI' : 'SI';
        const outText = checkout === 'double' ? 'DO' : (checkout === 'master' ? 'MO' : 'SO');
        document.getElementById('preLegGame').textContent = `${STARTING_SCORE} ${inText}/${outText}`;
    }

    // Update team names
    document.getElementById('preLegHomeName').textContent = teams[0].name;
    document.getElementById('preLegAwayName').textContent = teams[1].name;
    document.getElementById('corkHomeBtn').textContent = teams[0].name;
    document.getElementById('corkAwayBtn').textContent = teams[1].name;

    // Hide all sections first
    document.getElementById('corkSection').style.display = 'none';
    document.getElementById('noCorkSection').style.display = 'none';
    document.getElementById('starterReadyPhase').style.display = 'none';
    document.getElementById('corksChoicePhase').style.display = 'none';

    // Hide all cork phases
    document.getElementById('corkReadyPhase').style.display = 'none';
    document.getElementById('corkShufflePhase').style.display = 'none';
    document.getElementById('throwsFirstPhase').style.display = 'none';
    document.getElementById('whoGotItPhase').style.display = 'none';
    document.getElementById('chooseOrderPhase').style.display = 'none';

    if (needsCork) {
        // Show cork section with "Cork It" button
        document.getElementById('corkSection').style.display = 'block';
        document.getElementById('corkReadyPhase').style.display = 'block';
    } else {
        // Determine starter and show no-cork section
        pendingStarter = determineStarterWithoutCork(leg);
        document.getElementById('noCorkSection').style.display = 'block';
        const starterName = teams[pendingStarter].name;
        const starterColor = pendingStarter === 0 ? 'var(--pink)' : 'var(--teal)';
        document.getElementById('starterName').textContent = starterName;
        document.getElementById('starterName').style.color = starterColor;
    }

    document.getElementById('starterModal').classList.add('active');
}

function showStarterReadyPhase() {
    // Hide cork phases
    document.getElementById('corkSection').style.display = 'none';
    document.getElementById('noCorkSection').style.display = 'none';
    document.getElementById('starterReadyPhase').style.display = 'block';

    const starterName = teams[pendingStarter].name;
    const starterColor = pendingStarter === 0 ? 'var(--pink)' : 'var(--teal)';
    document.getElementById('starterReadyName').textContent = starterName;
    document.getElementById('starterReadyName').style.color = starterColor;
}

window.startCorkShuffle = function() {
    document.getElementById('corkReadyPhase').style.display = 'none';
    document.getElementById('corkShufflePhase').style.display = 'block';

    const spinner = document.getElementById('shuffleName');
    let count = 0;
    const names = [teams[0].name, teams[1].name];

    // Animate the shuffle
    const interval = setInterval(() => {
        spinner.textContent = names[count % 2];
        spinner.style.color = count % 2 === 0 ? 'var(--pink)' : 'var(--teal)';
        count++;
    }, 100);

    // Stop after random duration (1.5-2.5 seconds)
    const duration = 1500 + Math.random() * 1000;
    setTimeout(() => {
        clearInterval(interval);
        // Randomly pick who throws first at the bull
        const throwsFirst = Math.random() < 0.5 ? 0 : 1;
        corkFirstThrow = throwsFirst;

        // Show "Throws First" phase
        document.getElementById('corkShufflePhase').style.display = 'none';
        document.getElementById('throwsFirstPhase').style.display = 'block';
        document.getElementById('throwsFirstName').textContent = teams[throwsFirst].name;
        document.getElementById('throwsFirstName').style.color = throwsFirst === 0 ? 'var(--pink)' : 'var(--teal)';
    }, duration);
};

window.showWhoGotIt = function() {
    document.getElementById('throwsFirstPhase').style.display = 'none';
    document.getElementById('whoGotItPhase').style.display = 'block';
};

window.corkWinner = function(winner) {
    corkOptionHolder = winner; // Cork winner has the option
    corkWinnerSide = winner === 0 ? 'home' : 'away'; // Track for game data
    currentLegCorkWinner = corkWinnerSide; // Track cork winner for this leg

    // If doubles choice game (format=choice), show simple 501/Cricket selector
    if (isChoiceGame) {
        showDoublesChoiceSelector(winner);
    }
    // If corks choice mode, show full game selector
    else if (isCorksChoice) {
        showCorksChoiceSelector(winner);
    } else {
        // Show choose first/second phase
        showChooseOrderPhase(winner);
    }
};

function showChooseOrderPhase(winner) {
    // Hide other phases
    document.getElementById('whoGotItPhase').style.display = 'none';
    document.getElementById('chooseOrderPhase').style.display = 'block';

    const winnerName = teams[winner].name;
    const winnerColor = winner === 0 ? 'var(--pink)' : 'var(--teal)';
    document.getElementById('chooseOrderWinner').textContent = winnerName;
    document.getElementById('chooseOrderWinner').style.color = winnerColor;
}

window.chooseThrowOrder = function(choice) {
    if (choice === 'first') {
        // Cork winner throws first
        pendingStarter = corkOptionHolder;
    } else {
        // Cork winner throws second (opponent throws first)
        pendingStarter = 1 - corkOptionHolder;
    }

    // Check if we need to redirect to cricket
    if (window.pendingCricketRedirect) {
        const newParams = new URLSearchParams(window.location.search);
        newParams.delete('corks_choice');
        newParams.delete('starting_score');
        newParams.delete('in_rule');
        newParams.delete('out_rule');
        newParams.delete('checkout');
        newParams.set('starter', pendingStarter === 0 ? 'home' : 'away');
        window.location.href = `/pages/league-cricket.html?${newParams.toString()}`;
        return;
    }

    // Hide choose order phase and show ready phase
    document.getElementById('chooseOrderPhase').style.display = 'none';
    showStarterReadyPhase();
};

// Doubles Choice (format=choice) - Simple 501 vs Cricket selector
function showDoublesChoiceSelector(winner) {
    // Hide all other phases
    document.getElementById('corkSection').style.display = 'none';
    document.getElementById('noCorkSection').style.display = 'none';
    document.getElementById('starterReadyPhase').style.display = 'none';
    document.getElementById('whoGotItPhase').style.display = 'none';

    const winnerName = teams[winner].name;
    const winnerColor = winner === 0 ? 'var(--pink)' : 'var(--teal)';

    document.getElementById('doublesChoicePhase').style.display = 'block';
    document.getElementById('doublesChoiceWinner').textContent = winnerName;
    document.getElementById('doublesChoiceWinner').style.color = winnerColor;
}

// Handle doubles choice selection (501 or Cricket)
window.selectDoublesChoice = function(gameType) {
    chosenFormat = gameType;

    if (gameType === 'cricket') {
        // Redirect to cricket scorer with cork winner info
        const newParams = new URLSearchParams(window.location.search);
        newParams.delete('format'); // Remove choice format
        newParams.set('cork_choice', 'cricket');
        newParams.set('cork_winner', corkWinnerSide);
        newParams.set('starter', corkWinnerSide); // Cork winner starts
        window.location.href = `/pages/league-cricket.html?${newParams.toString()}`;
        return;
    }

    // 501 selected - continue on this page
    STARTING_SCORE = 501;
    isChoiceGame = false; // Disable for this game

    // Update display
    document.getElementById('gameFormat').textContent = '501 DO';
    document.getElementById('preLegGame').textContent = '501 SI/DO';
    document.getElementById('homeScore').textContent = '501';
    document.getElementById('awayScore').textContent = '501';
    teams[0].score = 501;
    teams[1].score = 501;

    // Cork winner starts
    pendingStarter = corkOptionHolder;

    document.getElementById('doublesChoicePhase').style.display = 'none';
    showStarterReadyPhase();
};

function showCorksChoiceSelector(winner) {
    // Hide all other phases
    document.getElementById('corkSection').style.display = 'none';
    document.getElementById('noCorkSection').style.display = 'none';
    document.getElementById('starterReadyPhase').style.display = 'none';
    document.getElementById('corksChoicePhase').style.display = 'none';
    document.getElementById('gameOrStartPhase').style.display = 'none';

    const winnerName = teams[winner].name;
    const winnerColor = winner === 0 ? 'var(--pink)' : 'var(--teal)';

    if (corkWinnerGets === 'choose-or-start') {
        // Game OR Start mode - winner picks game (opponent starts) OR picks to start (opponent picks game)
        document.getElementById('gameOrStartPhase').style.display = 'block';
        document.getElementById('gameOrStartWinner').textContent = winnerName;
        document.getElementById('gameOrStartWinner').style.color = winnerColor;
    } else {
        // Regular corks choice - winner picks game (and maybe throw order)
        document.getElementById('corksChoicePhase').style.display = 'block';
        document.getElementById('corksChoiceWinner').textContent = winnerName;
        document.getElementById('corksChoiceWinner').style.color = winnerColor;
    }
}

window.selectCorksChoiceGame = function(gameType) {
    if (gameType === 'cricket') {
        // For choose-only, opponent starts automatically
        if (corkWinnerGets === 'choose-only') {
            pendingStarter = 1 - corkOptionHolder; // Opponent starts
            const newParams = new URLSearchParams(window.location.search);
            newParams.delete('corks_choice');
            newParams.delete('starting_score');
            newParams.delete('in_rule');
            newParams.delete('out_rule');
            newParams.delete('checkout');
            newParams.set('starter', pendingStarter === 0 ? 'home' : 'away');
            window.location.href = `/pages/league-cricket.html?${newParams.toString()}`;
            return;
        }
        // Show choose order phase first, then redirect
        document.getElementById('corksChoicePhase').style.display = 'none';
        document.getElementById('chooseOrderPhase').style.display = 'block';
        document.getElementById('chooseOrderWinner').textContent = teams[corkOptionHolder].name;
        document.getElementById('chooseOrderWinner').style.color = corkOptionHolder === 0 ? 'var(--pink)' : 'var(--teal)';

        // Store that we're going to cricket after choose
        window.pendingCricketRedirect = true;
    } else {
        // X01 game - update current page settings
        const newScore = parseInt(gameType);
        STARTING_SCORE = newScore;
        isCorksChoice = false; // Disable for this game

        // Update display
        document.getElementById('gameFormat').textContent = `${newScore} DO`;
        document.getElementById('preLegGame').textContent = `${newScore} SI/DO`;
        document.getElementById('homeScore').textContent = newScore;
        document.getElementById('awayScore').textContent = newScore;
        teams[0].score = newScore;
        teams[1].score = newScore;

        document.getElementById('corksChoicePhase').style.display = 'none';

        // For choose-only, opponent starts automatically
        if (corkWinnerGets === 'choose-only') {
            pendingStarter = 1 - corkOptionHolder; // Opponent starts
            showStarterReadyPhase();
        } else {
            // Show choose order phase (choose-and-start mode)
            showChooseOrderPhase(corkOptionHolder);
        }
    }
};

// Game OR Start mode: Cork winner picks a game (opponent starts)
window.gameOrStartPickGame = function(gameType) {
    // Cork winner picked the game, so opponent starts
    pendingStarter = 1 - corkOptionHolder;

    if (gameType === 'cricket') {
        const newParams = new URLSearchParams(window.location.search);
        newParams.delete('corks_choice');
        newParams.delete('starting_score');
        newParams.delete('in_rule');
        newParams.delete('out_rule');
        newParams.delete('checkout');
        newParams.set('starter', pendingStarter === 0 ? 'home' : 'away');
        window.location.href = `/pages/league-cricket.html?${newParams.toString()}`;
        return;
    }

    // X01 game - update current page settings
    const newScore = parseInt(gameType);
    STARTING_SCORE = newScore;
    isCorksChoice = false;

    // Update display
    document.getElementById('gameFormat').textContent = `${newScore} DO`;
    document.getElementById('preLegGame').textContent = `${newScore} SI/DO`;
    document.getElementById('homeScore').textContent = newScore;
    document.getElementById('awayScore').textContent = newScore;
    teams[0].score = newScore;
    teams[1].score = newScore;

    document.getElementById('gameOrStartPhase').style.display = 'none';
    showStarterReadyPhase();
};

// Game OR Start mode: Cork winner picks to start first (opponent picks game)
window.gameOrStartPickStart = function() {
    // Cork winner will start, opponent picks the game
    pendingStarter = corkOptionHolder;
    const opponent = 1 - corkOptionHolder;

    document.getElementById('gameOrStartPhase').style.display = 'none';
    document.getElementById('opponentPicksGamePhase').style.display = 'block';
    document.getElementById('opponentPicksGameName').textContent = teams[opponent].name;
    document.getElementById('opponentPicksGameName').style.color = opponent === 0 ? 'var(--pink)' : 'var(--teal)';
};

// Opponent picks game (after cork winner chose to start first)
window.opponentSelectGame = function(gameType) {
    // Starter is already set (cork winner), just set the game

    if (gameType === 'cricket') {
        const newParams = new URLSearchParams(window.location.search);
        newParams.delete('corks_choice');
        newParams.delete('starting_score');
        newParams.delete('in_rule');
        newParams.delete('out_rule');
        newParams.delete('checkout');
        newParams.set('starter', pendingStarter === 0 ? 'home' : 'away');
        window.location.href = `/pages/league-cricket.html?${newParams.toString()}`;
        return;
    }

    // X01 game - update current page settings
    const newScore = parseInt(gameType);
    STARTING_SCORE = newScore;
    isCorksChoice = false;

    // Update display
    document.getElementById('gameFormat').textContent = `${newScore} DO`;
    document.getElementById('preLegGame').textContent = `${newScore} SI/DO`;
    document.getElementById('homeScore').textContent = newScore;
    document.getElementById('awayScore').textContent = newScore;
    teams[0].score = newScore;
    teams[1].score = newScore;

    document.getElementById('opponentPicksGamePhase').style.display = 'none';
    showStarterReadyPhase();
};

window.confirmStarter = function() {
    activeTeam = pendingStarter;
    lastLegStarter = pendingStarter;
    document.getElementById('starterModal').classList.remove('active');
    updateUI();

    // If bot should throw first, let it play
    if ((isAwayBot() && activeTeam === 1) || (isHomeBot() && activeTeam === 0)) {
        botPlay();
    }
};

// Calculator input functions
// runningTotal: accumulates completed terms (e.g., after 3√ó19+ it holds 57)
// pendingMultiplier: the left side of a pending multiply (e.g., after 3√ó it holds 3)
// pendingOp: 'add' means we've pressed + and are building the next term
//            'multiply' means we've pressed √ó and need a number to multiply
let runningTotal = 0;
let pendingMultiplier = null;
let pendingOp = null;
let storedValue = 0;

window.appendDigit = function(digit) {
    if (inputValue === '0') {
        inputValue = digit;
    } else if (inputValue.length < 3) {
        inputValue += digit;
    }
    updateInputDisplay();
};

window.clearInput = function() {
    inputValue = '0';
    pendingOp = null;
    storedValue = 0;
    runningTotal = 0;
    pendingMultiplier = null;
    updateInputDisplay();
};

// Remaining Score Feature (DartConnect style)
// Type what you have LEFT, then tap your score to calculate and submit the throw
window.submitRemainingScore = function(teamIndex) {
    // Only allow for the active team
    if (teamIndex !== activeTeam) {
        return;
    }

    // Get the remaining score they typed - support chained operations
    let remainingScore;
    const currentVal = parseInt(inputValue) || 0;

    if (pendingMultiplier !== null && currentVal > 0) {
        // Complete pending multiplication and add to running total
        const term = pendingMultiplier * currentVal;
        remainingScore = runningTotal + term;
    } else if (pendingOp === 'add' || runningTotal > 0) {
        // Add final term to running total
        remainingScore = runningTotal + currentVal;
    } else if (pendingOp === 'multiply') {
        // Legacy multiply
        remainingScore = storedValue * (currentVal || 1);
    } else {
        remainingScore = currentVal;
    }

    // If no value entered or just 0, do nothing
    if (remainingScore === 0) {
        return;
    }

    const currentScore = teams[activeTeam].score;
    const throwScore = currentScore - remainingScore;

    // Validate the calculated throw score
    if (throwScore < 0) {
        alert('Invalid: The remaining score cannot be higher than your current score!');
        return;
    }
    if (throwScore > 180) {
        alert('Invalid: Maximum score per turn is 180!');
        return;
    }

    // Reset all operation state
    pendingOp = null;
    storedValue = 0;
    runningTotal = 0;
    pendingMultiplier = null;
    inputValue = '0';
    updateInputDisplay();

    // Submit the calculated throw score
    submitScore(throwScore);
};

window.multiply = function() {
    const currentVal = parseInt(inputValue) || 0;

    // Handle chained operations properly for patterns like: 3√ó19 + 2√ó6 + 3√ó13
    if (pendingMultiplier !== null) {
        // Complete the pending multiplication: e.g., 3√ó19 = 57
        const term = pendingMultiplier * currentVal;
        runningTotal += term;
        pendingMultiplier = null;
    } else if (currentVal > 0) {
        // This is the start of a multiplication: store the multiplier
        // e.g., user typed "3" then pressed √ó
        pendingMultiplier = currentVal;
    }

    // However, if we just pressed √ó after typing a number like "3", we want to
    // set up for multiplication, not add to running total
    // Let me reconsider...

    // Actually, let's use a simpler approach:
    // √ó always stores current input as the multiplier
    pendingMultiplier = currentVal > 0 ? currentVal : pendingMultiplier;
    inputValue = '0';
    updateInputDisplay();
};

window.add = function() {
    const currentVal = parseInt(inputValue) || 0;

    // Complete any pending operation and add to running total
    if (pendingMultiplier !== null && currentVal > 0) {
        // We have a pending multiply: e.g., 3√ó19, add 57 to running total
        const term = pendingMultiplier * currentVal;
        runningTotal += term;
        pendingMultiplier = null;
    } else if (currentVal > 0) {
        // No pending multiply, just add the number directly
        runningTotal += currentVal;
    }

    // For display purposes, update storedValue to show running total
    storedValue = runningTotal;
    pendingOp = 'add';
    inputValue = '0';
    updateInputDisplay();
};

window.quickScore = function(score) {
    inputValue = score.toString();
    pendingOp = null;
    storedValue = 0;
    updateInputDisplay();
    submitCurrentScore();
};

function updateInputDisplay() {
    const display = document.getElementById('scoreInput');
    let displayText = '';

    // Show expression based on calculator state
    if (pendingMultiplier !== null) {
        // We have a pending multiplication: show "3x" or "3x19" or "57+2x" or "57+2x6"
        if (runningTotal > 0) {
            displayText = runningTotal + '+' + pendingMultiplier + 'x' + (inputValue !== '0' ? inputValue : '');
        } else {
            displayText = pendingMultiplier + 'x' + (inputValue !== '0' ? inputValue : '');
        }
    } else if (pendingOp === 'add' || runningTotal > 0) {
        // We have a running total and are building next term
        displayText = runningTotal + '+' + (inputValue !== '0' ? inputValue : '');
    } else if (pendingOp === 'multiply') {
        // Legacy display (shouldn't hit this with new logic)
        displayText = storedValue + 'x' + (inputValue !== '0' ? inputValue : '');
    } else {
        displayText = inputValue;
    }

    // Check if we should show checkout hint instead (only for active player on their turn)
    const activeScore = teams[activeTeam].score;
    const isOnCheckout = activeScore <= 170 && CHECKOUTS[activeScore];
    if (inputValue === '0' && !pendingOp && isOnCheckout) {
        display.textContent = CHECKOUTS[activeScore];
        display.classList.add('checkout-hint-mode');
        display.classList.remove('invalid');
        return;
    }

    display.textContent = displayText;
    display.classList.remove('checkout-hint-mode');

    // Calculate preview value for validation
    let previewValue;
    const currentVal = parseInt(inputValue) || 0;

    if (pendingMultiplier !== null) {
        // Preview: runningTotal + (pendingMultiplier √ó currentVal)
        const term = pendingMultiplier * (currentVal || 1);
        previewValue = runningTotal + term;
    } else if (pendingOp === 'add' || runningTotal > 0) {
        // Preview: runningTotal + currentVal
        previewValue = runningTotal + currentVal;
    } else if (pendingOp === 'multiply') {
        // Legacy preview
        previewValue = storedValue * (currentVal || 1);
    } else {
        previewValue = currentVal;
    }

    // Validate: max possible is 180
    if (previewValue > 180) {
        display.classList.add('invalid');
    } else {
        display.classList.remove('invalid');
    }
}

window.submitCurrentScore = function() {
    let finalScore;
    const currentValue = parseInt(inputValue) || 0;

    // Calculate final score handling chained operations like: 3√ó19 + 2√ó6 + 3√ó13 = 108
    if (pendingMultiplier !== null && currentValue > 0) {
        // Complete pending multiplication and add to running total
        const term = pendingMultiplier * currentValue;
        finalScore = runningTotal + term;
    } else if (pendingOp === 'add') {
        // Add final term to running total
        finalScore = runningTotal + currentValue;
    } else if (pendingOp === 'multiply') {
        // Legacy: simple multiply (shouldn't hit this with new logic, but keep for safety)
        finalScore = storedValue * currentValue;
    } else {
        // No pending operation, just use the input value
        finalScore = currentValue;
    }

    // Reset all operation state
    pendingOp = null;
    storedValue = 0;
    runningTotal = 0;
    pendingMultiplier = null;

    if (finalScore > 180) {
        alert('Maximum score is 180!');
        inputValue = '0';
        updateInputDisplay();
        return;
    }
    submitScore(finalScore);
};

window.submitScore = function(score, dartsUsed = 3) {
    // Hide wrong game button after first score
    hideWrongGameBtn();

    const team = teams[activeTeam];

    // Double-in validation: first score of leg must be even (or 0)
    if (inRule === 'double' && currentLegStats[activeTeam].darts === 0 && score > 0) {
        if (score % 2 !== 0) {
            alert('Double In: First score must be even (you need to start with a double)');
            inputValue = '0';
            updateInputDisplay();
            return;
        }
    }

    const newScore = team.score - score;

    // Save state for undo (keep max 10 turns for history viewing)
    // Store state for undo including per-player tracking
    const playerName = getCurrentPlayerName();
    const playerStatsCopy = playerLegStats[playerName] ? {...playerLegStats[playerName]} : null;
    history.push({
        team: activeTeam,
        score: team.score,
        darts: team.darts,
        points: team.points,
        tons: team.tons,
        ton40s: team.ton40s,
        ton80s: team.ton80s,
        legStatsDarts: currentLegStats[activeTeam].darts,
        legStatsPoints: currentLegStats[activeTeam].points,
        legStatsTon80s: currentLegStats[activeTeam].ton80s,
        // Per-player tracking for doubles undo
        playerIndex: [...activePlayerIndex],
        playerName: playerName,
        playerStats: playerStatsCopy
    });
    if (history.length > 10) {
        history.shift(); // Remove oldest turn
    }

    // Track who threw first in this leg
    if (currentLegFirstThrow === null) {
        currentLegFirstThrow = activeTeam;
        // Set threw_first for with/against darts tracking
        currentLegStats[activeTeam].threw_first = true;
        currentLegStats[1 - activeTeam].threw_first = false;
    }

    // Bust check
    if (newScore < 0 || newScore === 1) {
        // Bust - no score, but track it
        throwHistory[activeTeam].push({ value: score, bust: true, remaining: team.score });
        team.darts += 3;
        inputValue = '0';
        updateInputDisplay();
        updateThrowHistory();
        switchTeam();
        return;
    }

    // Add to throw history with remaining score for DartConnect format
    throwHistory[activeTeam].push({ value: score, bust: false, remaining: newScore });

    // Checkout check
    if (newScore === 0) {
        if (checkout === 'double') {
            // Ask how many darts were used
            pendingCheckout = { score, team: activeTeam };

            // Calculate minimum darts possible for this checkout
            const minDarts = getMinCheckoutDarts(score);

            // Enable/disable dart buttons based on minimum required
            document.getElementById('dartBtn1').disabled = minDarts > 1;
            document.getElementById('dartBtn2').disabled = minDarts > 2;
            document.getElementById('dartBtn3').disabled = false; // Always possible

            // Show checkout score
            document.getElementById('checkoutScoreDisplay').textContent = score;

            document.getElementById('dartsModal').classList.add('active');
            return;
        } else {
            // Straight out - complete checkout
            completeCheckout(score, dartsUsed);
            return;
        }
    }

    // Normal score
    team.score = newScore;
    team.darts += 3;
    team.points += score;

    // Get current player for per-player tracking (doubles)
    const currentPlayerName = getCurrentPlayerName();
    const pStats = playerLegStats[currentPlayerName];

    // Update leg-level stats (team totals)
    currentLegStats[activeTeam].darts += 3;
    currentLegStats[activeTeam].points += score;
    // Per-player stats
    if (pStats) { pStats.darts += 3; pStats.points += score; }

    // Track first 9 darts (first 3 throws = 9 darts)
    if (currentLegStats[activeTeam].first9Darts < 9) {
        currentLegStats[activeTeam].first9Darts += 3;
        currentLegStats[activeTeam].first9Points += score;
        team.first9Darts += 3;
        team.first9Points += score;
    }
    if (pStats && pStats.first9Darts < 9) {
        pStats.first9Darts += 3;
        pStats.first9Points += score;
    }

    // Track first turn score (HSI - High Straight In)
    if (currentLegStats[activeTeam].darts === 3 && currentLegStats[activeTeam].first_turn_score === 0) {
        currentLegStats[activeTeam].first_turn_score = score;
    }
    if (pStats && pStats.darts === 3 && pStats.first_turn_score === 0) {
        pStats.first_turn_score = score;
    }

    // Track high score
    if (score > currentLegStats[activeTeam].high_score) {
        currentLegStats[activeTeam].high_score = score;
    }
    if (pStats && score > pStats.high_score) {
        pStats.high_score = score;
    }
    if (score > team.highScore) {
        team.highScore = score;
    }

    // DartConnect ton breakdown (T00: 100-119, T20: 120-139, T40: 140-159, T60: 160-179, T80: 180)
    if (score >= 180) {
        team.ton80s++;
        team.ton_80++;
        currentLegStats[activeTeam].ton80s++;
        currentLegStats[activeTeam].ton_80++;
        currentLegStats[activeTeam].ton_points += score;
        if (pStats) { pStats.ton80s++; pStats.ton_80++; pStats.ton_points += score; }
    } else if (score >= 160) {
        team.ton40s++;
        team.ton_60++;
        currentLegStats[activeTeam].ton40s++;
        currentLegStats[activeTeam].ton_60++;
        currentLegStats[activeTeam].ton_points += score;
        if (pStats) { pStats.ton40s++; pStats.ton_60++; pStats.ton_points += score; }
    } else if (score >= 140) {
        team.ton40s++;
        team.ton_40++;
        currentLegStats[activeTeam].ton40s++;
        currentLegStats[activeTeam].ton_40++;
        currentLegStats[activeTeam].ton_points += score;
        if (pStats) { pStats.ton40s++; pStats.ton_40++; pStats.ton_points += score; }
    } else if (score >= 120) {
        team.tons++;
        team.ton_20++;
        currentLegStats[activeTeam].tons++;
        currentLegStats[activeTeam].ton_20++;
        currentLegStats[activeTeam].ton_points += score;
        if (pStats) { pStats.tons++; pStats.ton_20++; pStats.ton_points += score; }
    } else if (score >= 100) {
        team.tons++;
        team.ton_00++;
        currentLegStats[activeTeam].tons++;
        currentLegStats[activeTeam].ton_00++;
        currentLegStats[activeTeam].ton_points += score;
        if (pStats) { pStats.tons++; pStats.ton_00++; pStats.ton_points += score; }
    }

    // Track 171s specifically
    if (score === 171) {
        team.ton_71++;
        currentLegStats[activeTeam].ton_71++;
        if (pStats) pStats.ton_71++;
    }

    // Track checkout attempts (when on a checkout score before throwing)
    // Note: newScore is score AFTER this throw, so we check the old score
    const scoreBeforeThrow = team.score + score;  // Reconstruct score before this throw
    if (scoreBeforeThrow <= 170 && scoreBeforeThrow >= 2 && CHECKOUTS[scoreBeforeThrow]) {
        // Was on a checkout before this throw but didn't finish
        team.checkoutAttempts++;
        currentLegStats[activeTeam].checkout_attempts++;
        team.checkoutDarts += 3; // All 3 darts were at doubles
        currentLegStats[activeTeam].checkout_darts += 3;
        if (pStats) { pStats.checkout_attempts++; pStats.checkout_darts += 3; }

        // Track checkout % by range (attempt but no hit)
        if (scoreBeforeThrow >= 161 && scoreBeforeThrow <= 170) {
            currentLegStats[activeTeam].co_161_attempts++;
            if (pStats) pStats.co_161_attempts++;
        } else if (scoreBeforeThrow >= 140 && scoreBeforeThrow <= 160) {
            currentLegStats[activeTeam].co_140_attempts++;
            if (pStats) pStats.co_140_attempts++;
        } else if (scoreBeforeThrow >= 120 && scoreBeforeThrow <= 139) {
            currentLegStats[activeTeam].co_120_attempts++;
            if (pStats) pStats.co_120_attempts++;
        } else if (scoreBeforeThrow >= 80 && scoreBeforeThrow <= 119) {
            currentLegStats[activeTeam].co_80_attempts++;
            if (pStats) pStats.co_80_attempts++;
        }
    }

    inputValue = '0';
    updateInputDisplay();
    updateThrowHistory();
    switchTeam();
};

window.confirmCheckout = function(darts) {
    document.getElementById('dartsModal').classList.remove('active');
    if (pendingCheckout) {
        completeCheckout(pendingCheckout.score, darts);
        pendingCheckout = null;
    }
};

// Calculate minimum possible darts for a starting score
function calculateMinDarts(startScore) {
    // Based on max 180 per turn and max 170 checkout
    if (startScore <= 170) return 3;   // Can checkout in 1 turn
    if (startScore <= 350) return 6;   // 180 + checkout (max 170)
    if (startScore <= 530) return 9;   // 180 + 180 + checkout (max 170)
    if (startScore <= 710) return 12;  // 180 + 180 + 180 + checkout
    return Math.ceil((startScore - 170) / 180) * 3 + 3;
}

// Calculate minimum darts needed for a checkout score (for dart button validation)
function getMinCheckoutDarts(checkoutScore) {
    // 1-dart checkouts: even numbers 2-40 (doubles) and 50 (Bull)
    if ((checkoutScore >= 2 && checkoutScore <= 40 && checkoutScore % 2 === 0) || checkoutScore === 50) {
        return 1;
    }

    // 2-dart checkouts: max is T20 + Bull = 110
    // All valid checkouts from 1-110 that aren't 1-dart can be done in 2 darts
    if (checkoutScore <= 110) {
        return 2;
    }

    // 3-dart checkouts: 111-170 (max is T20 + T20 + Bull = 170)
    return 3;
}

function completeCheckout(score, dartsUsed) {
    const team = teams[activeTeam];
    const totalDarts = currentLegStats[activeTeam].darts + dartsUsed;

    // Validate minimum darts - prevent impossible scores like 8-darters
    const minDarts = calculateMinDarts(STARTING_SCORE);
    if (totalDarts < minDarts) {
        alert(`Invalid: ${STARTING_SCORE} cannot be completed in ${totalDarts} darts.\nMinimum possible is ${minDarts} darts.`);
        document.getElementById('dartsModal').classList.remove('active');
        return;
    }

    // Get current player for per-player tracking (doubles)
    const checkoutPlayerName = getCurrentPlayerName();
    const pStats = playerLegStats[checkoutPlayerName];

    // Store state for potential undo before making changes
    const preCheckoutState = {
        teamScore: team.score,
        teamDarts: team.darts,
        teamPoints: team.points,
        teamLegs: team.legs,
        teamTotalCheckouts: team.totalCheckouts,
        teamHighCheckout: team.highCheckout,
        teamBestLeg: team.bestLeg,
        teamCheckoutAttempts: team.checkoutAttempts,
        teamCheckoutDarts: team.checkoutDarts,
        legStatsDarts: currentLegStats[activeTeam].darts,
        legStatsPoints: currentLegStats[activeTeam].points,
        legStatsFirst9Darts: currentLegStats[activeTeam].first9Darts,
        legStatsFirst9Points: currentLegStats[activeTeam].first9Points,
        legStatsCheckoutAttempts: currentLegStats[activeTeam].checkout_attempts,
        legStatsCheckoutDarts: currentLegStats[activeTeam].checkout_darts,
        checkoutScore: score,
        dartsUsed: dartsUsed,
        activeTeamIdx: activeTeam,
        checkoutPlayer: checkoutPlayerName
    };

    team.score = 0;
    team.darts += dartsUsed;
    team.points += score;
    team.legs++;
    team.totalCheckouts++;

    // Track checkout attempt and darts (the successful checkout counts as 1 attempt, with dartsUsed darts)
    team.checkoutAttempts++;
    team.checkoutDarts += dartsUsed;
    currentLegStats[activeTeam].checkout_attempts++;
    currentLegStats[activeTeam].checkout_darts += dartsUsed;
    if (pStats) { pStats.checkout_attempts++; pStats.checkout_darts += dartsUsed; pStats.checkout = score; }

    // Track checkout % by range (both attempt and hit for successful checkout)
    if (score >= 161 && score <= 170) {
        currentLegStats[activeTeam].co_161_attempts++;
        currentLegStats[activeTeam].co_161_hits++;
        if (pStats) { pStats.co_161_attempts++; pStats.co_161_hits++; }
    } else if (score >= 140 && score <= 160) {
        currentLegStats[activeTeam].co_140_attempts++;
        currentLegStats[activeTeam].co_140_hits++;
        if (pStats) { pStats.co_140_attempts++; pStats.co_140_hits++; }
    } else if (score >= 120 && score <= 139) {
        currentLegStats[activeTeam].co_120_attempts++;
        currentLegStats[activeTeam].co_120_hits++;
        if (pStats) { pStats.co_120_attempts++; pStats.co_120_hits++; }
    } else if (score >= 80 && score <= 119) {
        currentLegStats[activeTeam].co_80_attempts++;
        currentLegStats[activeTeam].co_80_hits++;
        if (pStats) { pStats.co_80_attempts++; pStats.co_80_hits++; }
    }

    // Track leg winner and starter for cork rules
    lastLegWinner = activeTeam;
    lastLegStarter = lastLegStarter === null ? activeTeam : lastLegStarter; // First leg starter

    // Update leg-level stats
    currentLegStats[activeTeam].darts += dartsUsed;
    currentLegStats[activeTeam].points += score;
    currentLegStats[activeTeam].checkout = score;
    // Per-player stats
    if (pStats) {
        pStats.darts += dartsUsed;
        pStats.points += score;
    }

    // Track tons for checkout score (100+) - attribute to individual player
    if (score >= 180) {
        team.ton80s++; team.ton_80++;
        currentLegStats[activeTeam].ton80s++;
        currentLegStats[activeTeam].ton_80++;
        currentLegStats[activeTeam].ton_points += score;
        if (pStats) { pStats.ton80s++; pStats.ton_80++; pStats.ton_points += score; }
    } else if (score >= 160) {
        team.ton40s++; team.ton_60++;
        currentLegStats[activeTeam].ton40s++;
        currentLegStats[activeTeam].ton_60++;
        currentLegStats[activeTeam].ton_points += score;
        if (pStats) { pStats.ton40s++; pStats.ton_60++; pStats.ton_points += score; }
    } else if (score >= 140) {
        team.ton40s++; team.ton_40++;
        currentLegStats[activeTeam].ton40s++;
        currentLegStats[activeTeam].ton_40++;
        currentLegStats[activeTeam].ton_points += score;
        if (pStats) { pStats.ton40s++; pStats.ton_40++; pStats.ton_points += score; }
    } else if (score >= 120) {
        team.tons++; team.ton_20++;
        currentLegStats[activeTeam].tons++;
        currentLegStats[activeTeam].ton_20++;
        currentLegStats[activeTeam].ton_points += score;
        if (pStats) { pStats.tons++; pStats.ton_20++; pStats.ton_points += score; }
    } else if (score >= 100) {
        team.tons++; team.ton_00++;
        currentLegStats[activeTeam].tons++;
        currentLegStats[activeTeam].ton_00++;
        currentLegStats[activeTeam].ton_points += score;
        if (pStats) { pStats.tons++; pStats.ton_00++; pStats.ton_points += score; }
    }

    // Track first 9 if still counting
    if (preCheckoutState.legStatsFirst9Darts < 9) {
        const remaining = 9 - preCheckoutState.legStatsFirst9Darts;
        const dartsToAdd = Math.min(dartsUsed, remaining);
        currentLegStats[activeTeam].first9Darts = preCheckoutState.legStatsFirst9Darts + dartsToAdd;
        // Approximate score proportionally
        const proportionalScore = Math.round(score * (dartsToAdd / dartsUsed));
        currentLegStats[activeTeam].first9Points = preCheckoutState.legStatsFirst9Points + proportionalScore;
        // Update team totals
        team.first9Darts += dartsToAdd;
        team.first9Points += proportionalScore;
        // Per-player first 9
        if (pStats && pStats.first9Darts < 9) {
            const pRemaining = 9 - pStats.first9Darts;
            const pDartsToAdd = Math.min(dartsUsed, pRemaining);
            pStats.first9Darts += pDartsToAdd;
            pStats.first9Points += Math.round(score * (pDartsToAdd / dartsUsed));
        }
    }

    if (score > team.highCheckout) team.highCheckout = score;

    // Track best leg (fewest darts to win)
    const legDarts = currentLegStats[activeTeam].darts;
    if (legDarts < team.bestLeg) team.bestLeg = legDarts;

    // Save leg stats for summary
    legStats[activeTeam].push({...currentLegStats[activeTeam]});
    legStats[1 - activeTeam].push({...currentLegStats[1 - activeTeam]});

    // Save per-player stats for this leg (deep copy)
    const legPlayerStats = {};
    Object.keys(playerLegStats).forEach(name => {
        legPlayerStats[name] = {...playerLegStats[name]};
    });
    allPlayerLegStats.push(legPlayerStats);

    // Save throw history for this leg (DartConnect format)
    legThrowsHistory.push([...throwHistory[0].map(t => ({...t})), [...throwHistory[1].map(t => ({...t}))]]);
    legFirstThrow.push(currentLegFirstThrow);
    legCorkWinner.push(currentLegCorkWinner); // Track cork winner for audit trail

    inputValue = '0';
    updateInputDisplay();

    // Check for game win - show confirmation modal
    if (team.legs >= LEGS_TO_WIN) {
        // Store pending game win for confirmation
        pendingGameWin = {
            ...preCheckoutState,
            winnerIdx: activeTeam,
            winnerName: team.name
        };

        // Show confirmation modal
        document.getElementById('confirmWinnerName').textContent = `${team.name} wins the game!`;
        document.getElementById('confirmCheckoutScore').textContent = `${score} checkout in ${totalDarts} darts`;
        document.getElementById('confirmGameModal').classList.add('active');
    } else {
        showLegWinner(activeTeam);
    }
}

// Confirm the game win and proceed
window.confirmGameWin = function() {
    document.getElementById('confirmGameModal').classList.remove('active');
    if (pendingGameWin) {
        showGameWinner(pendingGameWin.winnerIdx);
        pendingGameWin = null;
    }
};

// Undo the game-winning checkout
window.undoGameWin = function() {
    document.getElementById('confirmGameModal').classList.remove('active');

    if (pendingGameWin) {
        const state = pendingGameWin;
        const team = teams[state.activeTeamIdx];

        // Restore team state
        team.score = state.teamScore;
        team.darts = state.teamDarts;
        team.points = state.teamPoints;
        team.legs = state.teamLegs;
        team.totalCheckouts = state.teamTotalCheckouts;
        team.highCheckout = state.teamHighCheckout;
        team.bestLeg = state.teamBestLeg;

        // Restore leg stats
        currentLegStats[state.activeTeamIdx].darts = state.legStatsDarts;
        currentLegStats[state.activeTeamIdx].points = state.legStatsPoints;
        currentLegStats[state.activeTeamIdx].checkout = 0;
        currentLegStats[state.activeTeamIdx].first9Darts = state.legStatsFirst9Darts;
        currentLegStats[state.activeTeamIdx].first9Points = state.legStatsFirst9Points;

        // Remove the leg stats we just pushed
        legStats[state.activeTeamIdx].pop();
        legStats[1 - state.activeTeamIdx].pop();

        // Remove the saved throw history for this leg
        if (legThrowsHistory.length > 0) {
            legThrowsHistory.pop();
        }
        if (legFirstThrow.length > 0) {
            legFirstThrow.pop();
        }
        if (legCorkWinner.length > 0) {
            legCorkWinner.pop();
        }

        // Remove from throw history
        if (throwHistory[state.activeTeamIdx].length > 0) {
            throwHistory[state.activeTeamIdx].pop();
        }

        pendingGameWin = null;

        // Update UI
        updateUI();
        updateThrowHistory();
    }
};

// Get the current active player for the active team
function getCurrentPlayerName() {
    const players = activeTeam === 0 ? homePlayers : awayPlayers;
    const idx = activePlayerIndex[activeTeam];
    return players[idx]?.name || (activeTeam === 0 ? 'Home' : 'Away');
}

// Check if current game is doubles (more than 1 player per team)
function isDoublesGame() {
    return homePlayers.length > 1 || awayPlayers.length > 1;
}

function switchTeam() {
    // In doubles, rotate to next player on the team that just threw
    if (isDoublesGame()) {
        const players = activeTeam === 0 ? homePlayers : awayPlayers;
        if (players.length > 1) {
            activePlayerIndex[activeTeam] = (activePlayerIndex[activeTeam] + 1) % players.length;
        }
    }

    activeTeam = activeTeam === 0 ? 1 : 0;
    updateUI();

    // Reset bot flag when switching
    botPlaying = false;

    // If it's a bot's turn, let it play
    if (isCurrentTeamBot()) {
        botPlay();
    }
}

window.undoScore = function() {
    // First press: clear input if there's something entered
    if (inputValue !== '0') {
        inputValue = '0';
        pendingOp = null;
        storedValue = 0;
        updateInputDisplay();
        return;
    }

    // Second press: undo last turn
    if (history.length === 0) return;

    const prev = history.pop();
    const team = teams[prev.team];
    team.score = prev.score;
    team.darts = prev.darts;
    team.points = prev.points;
    team.tons = prev.tons;
    team.ton40s = prev.ton40s;
    team.ton80s = prev.ton80s;

    // Restore leg stats (for correct averages)
    if (prev.legStatsDarts !== undefined) {
        currentLegStats[prev.team].darts = prev.legStatsDarts;
        currentLegStats[prev.team].points = prev.legStatsPoints;
        currentLegStats[prev.team].ton80s = prev.legStatsTon80s;
    }

    // Restore per-player stats and rotation (for doubles)
    if (prev.playerIndex) {
        activePlayerIndex = [...prev.playerIndex];
    }
    if (prev.playerName && prev.playerStats && playerLegStats[prev.playerName]) {
        playerLegStats[prev.playerName] = {...prev.playerStats};
    }

    // Remove from throw history
    if (throwHistory[prev.team].length > 0) {
        throwHistory[prev.team].pop();
    }

    activeTeam = prev.team;
    updateUI();
    updateThrowHistory();
};

function updateUI() {
    document.getElementById('homeScore').textContent = teams[0].score;
    document.getElementById('awayScore').textContent = teams[1].score;

    document.getElementById('homeCheckout').textContent = CHECKOUTS[teams[0].score] || '';
    document.getElementById('awayCheckout').textContent = CHECKOUTS[teams[1].score] || '';

    document.getElementById('homeLegs').textContent = teams[0].legs;
    document.getElementById('awayLegs').textContent = teams[1].legs;
    document.getElementById('legIndicator').textContent = `LEG ${leg}`;

    // Leg stats (current leg only)
    const homeLegDarts = currentLegStats[0].darts;
    const awayLegDarts = currentLegStats[1].darts;
    const homeLegPoints = currentLegStats[0].points;
    const awayLegPoints = currentLegStats[1].points;

    // Leg average (this leg only)
    const homeLegAvg = homeLegDarts > 0 ? (homeLegPoints / homeLegDarts * 3).toFixed(1) : '0.0';
    const awayLegAvg = awayLegDarts > 0 ? (awayLegPoints / awayLegDarts * 3).toFixed(1) : '0.0';

    // Match average (all legs combined)
    const homeMatchDarts = teams[0].darts + homeLegDarts;
    const awayMatchDarts = teams[1].darts + awayLegDarts;
    const homeMatchPoints = teams[0].points + homeLegPoints;
    const awayMatchPoints = teams[1].points + awayLegPoints;
    const homeMatchAvg = homeMatchDarts > 0 ? (homeMatchPoints / homeMatchDarts * 3).toFixed(1) : '0.0';
    const awayMatchAvg = awayMatchDarts > 0 ? (awayMatchPoints / awayMatchDarts * 3).toFixed(1) : '0.0';

    document.getElementById('homeLegAvg').textContent = homeLegAvg;
    document.getElementById('awayLegAvg').textContent = awayLegAvg;
    document.getElementById('homeAvg').textContent = homeMatchAvg;
    document.getElementById('awayAvg').textContent = awayMatchAvg;
    document.getElementById('homeDarts').textContent = homeLegDarts;
    document.getElementById('awayDarts').textContent = awayLegDarts;
    document.getElementById('home180s').textContent = currentLegStats[0].ton80s;
    document.getElementById('away180s').textContent = currentLegStats[1].ton80s;

    document.getElementById('homePanel').classList.toggle('active', activeTeam === 0);
    document.getElementById('awayPanel').classList.toggle('active', activeTeam === 1);

    // Update checkout hint in score input
    updateCheckoutHint();
}

function updateCheckoutHint() {
    const display = document.getElementById('scoreInput');
    const activeScore = teams[activeTeam].score;
    const quickOutContainer = document.getElementById('quickOutContainer');
    const quickOutGrid = document.getElementById('quickOutGrid');

    // Only show hint when input is empty/zero and there's a checkout available
    if (inputValue === '0' && !pendingOp && CHECKOUTS[activeScore]) {
        display.textContent = CHECKOUTS[activeScore];
        display.classList.add('checkout-hint-mode');
    } else {
        display.classList.remove('checkout-hint-mode');
    }

    // Show quick out buttons when on a checkout (score <= 170)
    if (activeScore > 0 && activeScore <= 170 && checkout !== 'straight') {
        const commonOuts = getQuickOutsForScore(activeScore);
        if (commonOuts.length > 0) {
            quickOutGrid.innerHTML = commonOuts.map(score =>
                `<button class="quick-out-btn" onclick="quickCheckout(${score})">${score}</button>`
            ).join('');
            quickOutContainer.style.display = 'block';
        } else {
            quickOutContainer.style.display = 'none';
        }
    } else {
        quickOutContainer.style.display = 'none';
    }
}

// Get quick out options based on remaining score
function getQuickOutsForScore(score) {
    const outs = [];

    // Common double checkouts (most frequent in darts)
    const commonCheckouts = [2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 24, 32, 36, 40, 50];

    for (const checkout of commonCheckouts) {
        if (checkout === score) {
            outs.push(checkout);
        }
    }

    // If exact match found, also suggest higher reachable outs
    if (outs.length === 0) {
        // Show the remaining score as an out option if it's a valid checkout
        if (isValidCheckout(score)) {
            outs.push(score);
        }
    }

    // Add common setup + out combinations for current score
    // For example, if on 61, suggest 61 (T15+D8) or could hit 25 for 36 remaining
    if (score <= 50 && isValidCheckout(score)) {
        outs.push(score);
    } else if (score <= 110 && isValidCheckout(score)) {
        outs.push(score);
    } else if (score <= 170 && isValidCheckout(score)) {
        outs.push(score);
    }

    return [...new Set(outs)].slice(0, 6); // Limit to 6 unique options
}

// Check if a score is a valid checkout (can be finished with double or bull)
function isValidCheckout(score) {
    if (score < 2 || score > 170) return false;
    if (score === 169 || score === 168 || score === 166 || score === 165 || score === 163 || score === 162 || score === 159) return false;
    return true;
}

// Quick checkout - enters the checkout score directly
window.quickCheckout = function(score) {
    inputValue = score.toString();
    updateInputDisplay();
    submitScore();
};

function updateThrowHistory() {
    const homeContainer = document.getElementById('homeThrows');
    const awayContainer = document.getElementById('awayThrows');

    // Render all home throws (oldest at top, newest at bottom)
    homeContainer.innerHTML = throwHistory[0].map((t, idx) => {
        let classes = 'throw-item home';
        if (t.bust) classes += ' bust';
        else if (t.value >= 180) classes += ' ton80';
        else if (t.value >= 100) classes += ' ton';
        return `<div class="${classes}" onclick="editThrow(0, ${idx})">${t.value}</div>`;
    }).join('');

    // Render all away throws (oldest at top, newest at bottom)
    awayContainer.innerHTML = throwHistory[1].map((t, idx) => {
        let classes = 'throw-item away';
        if (t.bust) classes += ' bust';
        else if (t.value >= 180) classes += ' ton80';
        else if (t.value >= 100) classes += ' ton';
        return `<div class="${classes}" onclick="editThrow(1, ${idx})">${t.value}</div>`;
    }).join('');

    // Auto-scroll to show newest scores at bottom
    homeContainer.scrollTop = homeContainer.scrollHeight;
    awayContainer.scrollTop = awayContainer.scrollHeight;
}

// Edit a past throw
window.editThrow = function(teamIdx, throwIdx) {
    const currentValue = throwHistory[teamIdx][throwIdx].value;
    const newValue = prompt(`Edit score (was ${currentValue}):`, currentValue);

    if (newValue === null) return; // Cancelled

    const newScore = parseInt(newValue);
    if (isNaN(newScore) || newScore < 0 || newScore > 180) {
        alert('Invalid score. Must be 0-180.');
        return;
    }

    // Update the throw
    const oldValue = throwHistory[teamIdx][throwIdx].value;
    const wasBust = throwHistory[teamIdx][throwIdx].bust;

    throwHistory[teamIdx][throwIdx].value = newScore;
    throwHistory[teamIdx][throwIdx].bust = false; // Reset bust status, will recalc

    // Recalculate scores from scratch for this leg
    recalculateScores();
    updateThrowHistory();
    updateUI();
};

// Recalculate all scores based on throw history
function recalculateScores() {
    // Reset scores to starting value
    teams[0].score = STARTING_SCORE;
    teams[1].score = STARTING_SCORE;

    // Reset current leg stats
    currentLegStats[0] = { darts: 0, points: 0, first9Points: 0, first9Darts: 0, tons: 0, ton40s: 0, ton80s: 0, checkout: 0 };
    currentLegStats[1] = { darts: 0, points: 0, first9Points: 0, first9Darts: 0, tons: 0, ton40s: 0, ton80s: 0, checkout: 0 };

    // Replay all throws
    for (let i = 0; i < 2; i++) {
        for (let j = 0; j < throwHistory[i].length; j++) {
            const t = throwHistory[i][j];
            const newScore = teams[i].score - t.value;

            // Check for bust
            if (newScore < 0 || newScore === 1) {
                t.bust = true;
                currentLegStats[i].darts += 3;
            } else {
                t.bust = false;
                teams[i].score = newScore;
                currentLegStats[i].darts += 3;
                currentLegStats[i].points += t.value;

                // Track first 9 darts
                if (currentLegStats[i].first9Darts < 9) {
                    currentLegStats[i].first9Darts += 3;
                    currentLegStats[i].first9Points += t.value;
                }

                if (t.value >= 180) currentLegStats[i].ton80s++;
                else if (t.value >= 140) currentLegStats[i].ton40s++;
                else if (t.value >= 100) currentLegStats[i].tons++;
            }
        }
    }
}

function showLegWinner(teamIndex) {
    const winner = currentLegStats[teamIndex];
    const loser = currentLegStats[1 - teamIndex];
    const winnerTeam = teams[teamIndex];
    const loserTeam = teams[1 - teamIndex];

    const winnerAvg = winner.darts > 0 ? (winner.points / winner.darts * 3).toFixed(1) : '0.0';
    const loserAvg = loser.darts > 0 ? (loser.points / loser.darts * 3).toFixed(1) : '0.0';
    const winnerFirst9 = winner.first9Darts > 0 ? (winner.first9Points / winner.first9Darts * 3).toFixed(1) : '-';
    const loserFirst9 = loser.first9Darts > 0 ? (loser.first9Points / loser.first9Darts * 3).toFixed(1) : '-';

    const winnerColor = teamIndex === 0 ? 'var(--pink)' : 'var(--teal)';
    const loserColor = teamIndex === 0 ? 'var(--teal)' : 'var(--pink)';

    document.getElementById('legWinnerName').textContent = winnerTeam.name + ' WINS LEG ' + leg + '!';
    document.getElementById('legStats').innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 8px; font-size: 13px;">
            <div style="font-weight: 700; color: var(--text-dim);"></div>
            <div style="font-weight: 800; text-align: center; min-width: 50px; color: ${winnerColor};">${winnerTeam.name.split(' ')[0]}</div>
            <div style="font-weight: 800; text-align: center; min-width: 50px; color: ${loserColor};">${loserTeam.name.split(' ')[0]}</div>

            <div>Darts</div>
            <div style="text-align: center; color: var(--yellow); font-weight: 700;">${winner.darts}</div>
            <div style="text-align: center; opacity: 0.7;">${loser.darts}</div>

            <div>Average</div>
            <div style="text-align: center; color: var(--yellow); font-weight: 700;">${winnerAvg}</div>
            <div style="text-align: center; opacity: 0.7;">${loserAvg}</div>

            <div>First 9 Avg</div>
            <div style="text-align: center; color: var(--yellow); font-weight: 700;">${winnerFirst9}</div>
            <div style="text-align: center; opacity: 0.7;">${loserFirst9}</div>

            <div>Checkout</div>
            <div style="text-align: center; color: var(--yellow); font-weight: 700;">${winner.checkout || '-'}</div>
            <div style="text-align: center; opacity: 0.7;">-</div>

            <div>100+</div>
            <div style="text-align: center;">${winner.tons + winner.ton40s + winner.ton80s}</div>
            <div style="text-align: center; opacity: 0.7;">${loser.tons + loser.ton40s + loser.ton80s}</div>

            <div>140+</div>
            <div style="text-align: center;">${winner.ton40s + winner.ton80s}</div>
            <div style="text-align: center; opacity: 0.7;">${loser.ton40s + loser.ton80s}</div>

            <div>180s</div>
            <div style="text-align: center;">${winner.ton80s}</div>
            <div style="text-align: center; opacity: 0.7;">${loser.ton80s}</div>
        </div>
        <div style="margin-top: 12px; text-align: center; font-size: 16px; font-weight: 700;">
            <span style="color: ${winnerColor};">${winnerTeam.legs}</span>
            <span style="opacity: 0.5; margin: 0 8px;">-</span>
            <span style="color: ${loserColor};">${loserTeam.legs}</span>
        </div>
    `;

    // Show next game info if in mixed mode
    const nextGameInfo = document.getElementById('nextGameInfo');
    if (isMixedGame) {
        const mixedConfig = JSON.parse(sessionStorage.getItem('mixedGameConfig') || '{}');
        const nextLegIndex = mixedLegIndex + 1;
        if (mixedConfig.legs && nextLegIndex < mixedConfig.legs.length) {
            const nextLeg = mixedConfig.legs[nextLegIndex];
            const gameLabel = getGameLabel(nextLeg);
            document.getElementById('nextGameLabel').textContent = gameLabel;
            nextGameInfo.style.display = 'block';
        } else {
            nextGameInfo.style.display = 'none';
        }
    } else {
        nextGameInfo.style.display = 'none';
    }

    document.getElementById('legModal').classList.add('active');

    // Backup game state after each leg for recovery
    backupGameState();
}

window.nextLeg = function() {
    document.getElementById('legModal').classList.remove('active');

    // Handle mixed game mode - navigate to next leg's game type
    if (isMixedGame) {
        const mixedConfig = JSON.parse(sessionStorage.getItem('mixedGameConfig') || '{}');
        if (mixedConfig.legs && mixedConfig.legs.length > 0) {
            // Update current leg index
            const nextLegIndex = mixedLegIndex + 1;

            // Update match score in sessionStorage
            mixedConfig.current_leg = nextLegIndex;
            mixedConfig.home_legs = teams[0].legs;
            mixedConfig.away_legs = teams[1].legs;
            sessionStorage.setItem('mixedGameConfig', JSON.stringify(mixedConfig));

            // Check if there are more legs
            if (nextLegIndex < mixedConfig.legs.length) {
                const nextLeg = mixedConfig.legs[nextLegIndex];

                // Build common params
                const newParams = new URLSearchParams();
                // Preserve league/match context for return navigation
                if (leagueId) newParams.set('league_id', leagueId);
                if (matchId) newParams.set('match_id', matchId);
                if (fromMatch) newParams.set('from_match', 'true');
                newParams.set('home_players', JSON.stringify(homePlayers));
                newParams.set('away_players', JSON.stringify(awayPlayers));
                newParams.set('casual', isCasual ? 'true' : 'false');
                newParams.set('mixed', 'true');
                newParams.set('mixed_leg', nextLegIndex.toString());
                newParams.set('legs_to_win', LEGS_TO_WIN.toString());
                newParams.set('home_legs', teams[0].legs.toString());
                newParams.set('away_legs', teams[1].legs.toString());

                if (useCork) {
                    newParams.set('cork', 'true');
                }

                // Navigate to appropriate scorer
                if (nextLeg.type === 'cricket') {
                    window.location.href = `/pages/league-cricket.html?${newParams.toString()}`;
                } else {
                    // X01 game
                    const score = nextLeg.score || (nextLeg.type === '301' ? 301 : (nextLeg.type === '701' ? 701 : 501));
                    newParams.set('starting_score', score.toString());
                    newParams.set('in_rule', nextLeg.inRule || 'straight');
                    newParams.set('out_rule', nextLeg.outRule || 'double');
                    newParams.set('checkout', nextLeg.outRule || 'double');
                    window.location.href = `/pages/league-501.html?${newParams.toString()}`;
                }
                return;
            }
        }
    }

    leg++;
    teams[0].score = STARTING_SCORE;
    teams[1].score = STARTING_SCORE;
    history = [];
    throwHistory = [[], []]; // Clear throw history for new leg
    currentLegFirstThrow = null; // Reset first throw tracker
    currentLegCorkWinner = null; // Reset cork winner tracker for new leg
    resetCurrentLegStats(); // Reset leg-level stats
    updateThrowHistory();

    // Apply cork rules for new leg
    const homeIsBot = isHomeBot();
    const awayIsBot = isAwayBot();

    if (homeIsBot || awayIsBot) {
        // Bot games - use simplified logic
        if (homeIsBot && awayIsBot) {
            activeTeam = leg % 2 === 0 ? 1 : 0;
        } else {
            activeTeam = awayIsBot ? 0 : 1;
        }
        lastLegStarter = activeTeam;
        updateUI();
        botPlaying = false;
        if (isCurrentTeamBot()) {
            setTimeout(() => botPlay(), 500);
        }
    } else {
        // Show starter modal (with or without cork)
        const needsCork = shouldCorkThisLeg(leg);
        showStarterModal(needsCork);
    }
};

// Determine if this leg needs a cork based on cork_rule
function shouldCorkThisLeg(legNum) {
    // If cork is disabled entirely, never cork
    if (!useCork) return false;

    // Check if this is a deciding leg
    const isDecidingLeg = teams[0].legs === teams[1].legs && teams[0].legs === LEGS_TO_WIN - 1;

    switch (corkRule) {
        case 'cork_every_leg':
            return true;

        case 'home_first':
        case 'away_first':
        case 'choose_no_cork':
            // Manual starter selection - no cork needed
            return false;

        case 'loser_starts_cork_first_deciding':
        case 'winner_starts_cork_first_deciding':
        case 'alternate_cork_first_deciding':
        case 'cork_first_leg':
        default:
            // Cork for leg 1 and deciding leg
            if (legNum === 1) return true;
            if (isDecidingLeg) return true;
            return false;
    }
}

// Determine who starts without a cork (for non-cork legs)
function determineStarterWithoutCork(legNum) {
    switch (corkRule) {
        case 'home_first':
            // Home/Team1 always starts first leg, then alternate
            if (legNum === 1) return 0;
            return lastLegStarter !== null ? 1 - lastLegStarter : 0;

        case 'away_first':
            // Away/Team2 always starts first leg, then alternate
            if (legNum === 1) return 1;
            return lastLegStarter !== null ? 1 - lastLegStarter : 1;

        case 'loser_starts_cork_first_deciding':
            // Loser of previous leg starts (non-cork legs)
            if (lastLegWinner !== null) {
                return 1 - lastLegWinner; // Opposite of winner
            }
            return lastLegStarter !== null ? 1 - lastLegStarter : 0;

        case 'winner_starts_cork_first_deciding':
            // Winner of previous leg starts (non-cork legs)
            if (lastLegWinner !== null) {
                return lastLegWinner;
            }
            return lastLegStarter !== null ? 1 - lastLegStarter : 0;

        case 'alternate_cork_first_deciding':
        case 'cork_first_leg':
        default:
            // Alternate from last starter
            if (lastLegStarter !== null) {
                return 1 - lastLegStarter;
            }
            return 0;
    }
}

function showGameWinner(teamIndex) {
    const winner = teams[teamIndex];
    const loser = teams[1 - teamIndex];

    // Calculate total stats from legStats (more accurate than teams object)
    const winnerLegStats = legStats[teamIndex];
    const loserLegStats = legStats[1 - teamIndex];

    const winnerTotalDarts = winnerLegStats.reduce((sum, leg) => sum + (leg.darts || 0), 0);
    const winnerTotalPoints = winnerLegStats.reduce((sum, leg) => sum + (leg.points || 0), 0);
    const loserTotalDarts = loserLegStats.reduce((sum, leg) => sum + (leg.darts || 0), 0);
    const loserTotalPoints = loserLegStats.reduce((sum, leg) => sum + (leg.points || 0), 0);

    const winnerAvg = winnerTotalDarts > 0 ? (winnerTotalPoints / winnerTotalDarts * 3).toFixed(1) : '0.0';
    const loserAvg = loserTotalDarts > 0 ? (loserTotalPoints / loserTotalDarts * 3).toFixed(1) : '0.0';

    // Calculate ton stats from legStats
    const winnerTons = winnerLegStats.reduce((sum, leg) => sum + (leg.tons || 0), 0);
    const winnerTon40s = winnerLegStats.reduce((sum, leg) => sum + (leg.ton40s || 0), 0);
    const winnerTon80s = winnerLegStats.reduce((sum, leg) => sum + (leg.ton80s || 0), 0);
    const loserTons = loserLegStats.reduce((sum, leg) => sum + (leg.tons || 0), 0);
    const loserTon40s = loserLegStats.reduce((sum, leg) => sum + (leg.ton40s || 0), 0);
    const loserTon80s = loserLegStats.reduce((sum, leg) => sum + (leg.ton80s || 0), 0);

    const winnerColor = teamIndex === 0 ? 'var(--pink)' : 'var(--teal)';
    const loserColor = teamIndex === 0 ? 'var(--teal)' : 'var(--pink)';

    // Calculate checkout percentages
    const winnerCOPct = winner.checkoutAttempts > 0 ? Math.round((winner.totalCheckouts / winner.checkoutAttempts) * 100) : 0;
    const loserCOPct = loser.checkoutAttempts > 0 ? Math.round((loser.totalCheckouts / loser.checkoutAttempts) * 100) : 0;

    // Best leg display
    const winnerBest = winner.bestLeg < 999 ? winner.bestLeg : '-';
    const loserBest = loser.bestLeg < 999 ? loser.bestLeg : '-';

    document.getElementById('gameWinnerName').textContent = winner.name + ' WINS!';
    document.getElementById('gameStats').innerHTML = `
        <div style="text-align: center; margin-bottom: 12px;">
            <span style="font-size: 32px; font-family: 'Rowdies', cursive;">
                <span style="color: ${winnerColor};">${winner.legs}</span>
                <span style="opacity: 0.5; margin: 0 12px;">-</span>
                <span style="color: ${loserColor};">${loser.legs}</span>
            </span>
        </div>

        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 6px; font-size: 12px;">
            <div style="font-weight: 700; color: var(--text-dim);"></div>
            <div style="font-weight: 800; text-align: center; min-width: 55px; color: ${winnerColor}; font-size: 11px;">${winner.name.split(' ')[0].substring(0, 8)}</div>
            <div style="font-weight: 800; text-align: center; min-width: 55px; color: ${loserColor}; font-size: 11px;">${loser.name.split(' ')[0].substring(0, 8)}</div>

            <div>Average</div>
            <div style="text-align: center; color: var(--yellow); font-weight: 700;">${winnerAvg}</div>
            <div style="text-align: center; opacity: 0.7;">${loserAvg}</div>

            <div>Darts</div>
            <div style="text-align: center;">${winnerTotalDarts}</div>
            <div style="text-align: center; opacity: 0.7;">${loserTotalDarts}</div>

            <div>Best Leg</div>
            <div style="text-align: center;">${winnerBest}</div>
            <div style="text-align: center; opacity: 0.7;">${loserBest}</div>

            <div>High Checkout</div>
            <div style="text-align: center; color: var(--yellow);">${winner.highCheckout || '-'}</div>
            <div style="text-align: center; opacity: 0.7;">${loser.highCheckout || '-'}</div>

            <div>Checkout %</div>
            <div style="text-align: center;">${winnerCOPct}%</div>
            <div style="text-align: center; opacity: 0.7;">${loserCOPct}%</div>

            <div>100+</div>
            <div style="text-align: center;">${winnerTons + winnerTon40s + winnerTon80s}</div>
            <div style="text-align: center; opacity: 0.7;">${loserTons + loserTon40s + loserTon80s}</div>

            <div>140+</div>
            <div style="text-align: center;">${winnerTon40s + winnerTon80s}</div>
            <div style="text-align: center; opacity: 0.7;">${loserTon40s + loserTon80s}</div>

            <div>180s</div>
            <div style="text-align: center; color: var(--yellow);">${winnerTon80s}</div>
            <div style="text-align: center; opacity: 0.7;">${loserTon80s}</div>
        </div>
    `;
    document.getElementById('gameModal').classList.add('active');
}

window.saveGame = async function() {
    const winner = teams[0].legs >= LEGS_TO_WIN ? 'home' : 'away';
    const duration = Math.floor((Date.now() - gameStartTime) / 1000);

    const homeAvg = teams[0].darts > 0 ? parseFloat((teams[0].points / teams[0].darts * 3).toFixed(2)) : 0;
    const awayAvg = teams[1].darts > 0 ? parseFloat((teams[1].points / teams[1].darts * 3).toFixed(2)) : 0;

    // Build comprehensive DartConnect-compatible leg data with throws
    const buildLegData = () => {
        const legs = [];
        const numLegs = Math.max(legStats[0].length, legStats[1].length);

        // Get player names for player_stats
        const homePlayerName = homePlayers[0]?.name || teams[0].name;
        const awayPlayerName = awayPlayers[0]?.name || teams[1].name;

        for (let i = 0; i < numLegs; i++) {
            const homeLeg = legStats[0][i] || {};
            const awayLeg = legStats[1][i] || {};
            const legWinner = (homeLeg.checkout && homeLeg.checkout > 0) ? 'home' : 'away';

            // Build throws array from saved throw history
            const legThrows = legThrowsHistory[i] || [[], []];
            const firstThrow = legFirstThrow[i] !== undefined ? (legFirstThrow[i] === 0 ? 'home' : 'away') : 'home';
            const throws = [];

            // Interleave home and away throws into rounds
            const homeThrows = legThrows[0] || [];
            const awayThrows = legThrows[1] || [];
            const maxRounds = Math.max(homeThrows.length, awayThrows.length);

            for (let r = 0; r < maxRounds; r++) {
                const homeT = homeThrows[r];
                const awayT = awayThrows[r];
                const roundData = { round: r + 1 };

                if (homeT) {
                    roundData.home = {
                        player: homePlayerName,
                        score: homeT.value,
                        remaining: homeT.remaining,
                        bust: homeT.bust || false
                    };
                    // Mark notable scores
                    if (homeT.value >= 100) roundData.home.notable = true;
                    if (homeT.value === 180) roundData.home.notable = '180';
                    if (homeLeg.checkout && r === homeThrows.length - 1 && legWinner === 'home') {
                        roundData.home.checkout = true;
                    }
                }

                if (awayT) {
                    roundData.away = {
                        player: awayPlayerName,
                        score: awayT.value,
                        remaining: awayT.remaining,
                        bust: awayT.bust || false
                    };
                    // Mark notable scores
                    if (awayT.value >= 100) roundData.away.notable = true;
                    if (awayT.value === 180) roundData.away.notable = '180';
                    if (awayLeg.checkout && r === awayThrows.length - 1 && legWinner === 'away') {
                        roundData.away.checkout = true;
                    }
                }

                throws.push(roundData);
            }

            // Build player_stats object using per-player tracking (supports doubles)
            const player_stats = {};
            const legPlayerStats = allPlayerLegStats[i] || {};

            // Add stats for all home players
            homePlayers.forEach(p => {
                if (p?.name) {
                    const ps = legPlayerStats[p.name] || {};
                    player_stats[p.name] = {
                        darts: ps.darts || 0,
                        points: ps.points || 0,
                        average: ps.darts > 0 ? parseFloat(((ps.points || 0) / (ps.darts || 1) * 3).toFixed(2)) : 0,
                        tons: (ps.ton_00 || 0) + (ps.ton_20 || 0) + (ps.ton_40 || 0) + (ps.ton_60 || 0) + (ps.ton_80 || 0),
                        ton_80: ps.ton_80 || 0,
                        checkout: ps.checkout || 0,
                        high_score: ps.high_score || 0,
                        first9_darts: ps.first9Darts || 0,
                        first9_points: ps.first9Points || 0
                    };
                }
            });
            // Fallback for singles: use team stats if no per-player data
            if (homePlayers.length === 1 && !legPlayerStats[homePlayerName]) {
                player_stats[homePlayerName] = {
                    darts: homeLeg.darts || 0,
                    points: homeLeg.points || 0,
                    average: homeLeg.darts > 0 ? parseFloat(((homeLeg.points || 0) / (homeLeg.darts || 1) * 3).toFixed(2)) : 0,
                    tons: (homeLeg.ton_00 || 0) + (homeLeg.ton_20 || 0) + (homeLeg.ton_40 || 0) + (homeLeg.ton_60 || 0) + (homeLeg.ton_80 || 0),
                    ton_80: homeLeg.ton_80 || 0,
                    checkout: legWinner === 'home' ? (homeLeg.checkout || 0) : 0
                };
            }

            // Add stats for all away players
            awayPlayers.forEach(p => {
                if (p?.name) {
                    const ps = legPlayerStats[p.name] || {};
                    player_stats[p.name] = {
                        darts: ps.darts || 0,
                        points: ps.points || 0,
                        average: ps.darts > 0 ? parseFloat(((ps.points || 0) / (ps.darts || 1) * 3).toFixed(2)) : 0,
                        tons: (ps.ton_00 || 0) + (ps.ton_20 || 0) + (ps.ton_40 || 0) + (ps.ton_60 || 0) + (ps.ton_80 || 0),
                        ton_80: ps.ton_80 || 0,
                        checkout: ps.checkout || 0,
                        high_score: ps.high_score || 0,
                        first9_darts: ps.first9Darts || 0,
                        first9_points: ps.first9Points || 0
                    };
                }
            });
            // Fallback for singles: use team stats if no per-player data
            if (awayPlayers.length === 1 && !legPlayerStats[awayPlayerName]) {
                player_stats[awayPlayerName] = {
                    darts: awayLeg.darts || 0,
                    points: awayLeg.points || 0,
                    average: awayLeg.darts > 0 ? parseFloat(((awayLeg.points || 0) / (awayLeg.darts || 1) * 3).toFixed(2)) : 0,
                    tons: (awayLeg.ton_00 || 0) + (awayLeg.ton_20 || 0) + (awayLeg.ton_40 || 0) + (awayLeg.ton_60 || 0) + (awayLeg.ton_80 || 0),
                    ton_80: awayLeg.ton_80 || 0,
                    checkout: legWinner === 'away' ? (awayLeg.checkout || 0) : 0
                };
            }

            // Get cork winner for this leg (null if no cork was done)
            const legCorkWinnerValue = legCorkWinner[i] || null;

            legs.push({
                leg_number: i + 1,
                format: STARTING_SCORE.toString(),
                winner: legWinner,
                first_throw: firstThrow,
                cork_winner: legCorkWinnerValue, // Who won the cork for this leg (audit trail)
                home_stats: {
                    darts_thrown: homeLeg.darts || 0,
                    points_scored: homeLeg.points || 0,
                    first9_darts: homeLeg.first9Darts || 0,
                    first9_points: homeLeg.first9Points || 0,
                    tons: homeLeg.tons || 0,
                    ton_00: homeLeg.ton_00 || 0,
                    ton_20: homeLeg.ton_20 || 0,
                    ton_40: homeLeg.ton_40 || 0,
                    ton_60: homeLeg.ton_60 || 0,
                    ton_80: homeLeg.ton_80 || 0,
                    ton_forties: (homeLeg.ton_40 || 0) + (homeLeg.ton_60 || 0) + (homeLeg.ton_80 || 0),
                    ton_eighties: homeLeg.ton_80 || 0,
                    ton_71: homeLeg.ton_71 || 0,
                    checkout: legWinner === 'home' ? (homeLeg.checkout || 0) : 0,
                    checkout_attempts: homeLeg.checkout_attempts || 0,
                    checkout_darts: homeLeg.checkout_darts || 0,
                    high_score: homeLeg.high_score || 0,
                    // NEW: HSI, Ton Points, With/Against Darts, Checkout Ranges
                    first_turn_score: homeLeg.first_turn_score || 0,
                    ton_points: homeLeg.ton_points || 0,
                    threw_first: homeLeg.threw_first,
                    co_80_attempts: homeLeg.co_80_attempts || 0,
                    co_80_hits: homeLeg.co_80_hits || 0,
                    co_120_attempts: homeLeg.co_120_attempts || 0,
                    co_120_hits: homeLeg.co_120_hits || 0,
                    co_140_attempts: homeLeg.co_140_attempts || 0,
                    co_140_hits: homeLeg.co_140_hits || 0,
                    co_161_attempts: homeLeg.co_161_attempts || 0,
                    co_161_hits: homeLeg.co_161_hits || 0
                },
                away_stats: {
                    darts_thrown: awayLeg.darts || 0,
                    points_scored: awayLeg.points || 0,
                    first9_darts: awayLeg.first9Darts || 0,
                    first9_points: awayLeg.first9Points || 0,
                    tons: awayLeg.tons || 0,
                    ton_00: awayLeg.ton_00 || 0,
                    ton_20: awayLeg.ton_20 || 0,
                    ton_40: awayLeg.ton_40 || 0,
                    ton_60: awayLeg.ton_60 || 0,
                    ton_80: awayLeg.ton_80 || 0,
                    ton_forties: (awayLeg.ton_40 || 0) + (awayLeg.ton_60 || 0) + (awayLeg.ton_80 || 0),
                    ton_eighties: awayLeg.ton_80 || 0,
                    ton_71: awayLeg.ton_71 || 0,
                    checkout: legWinner === 'away' ? (awayLeg.checkout || 0) : 0,
                    checkout_attempts: awayLeg.checkout_attempts || 0,
                    checkout_darts: awayLeg.checkout_darts || 0,
                    high_score: awayLeg.high_score || 0,
                    // NEW: HSI, Ton Points, With/Against Darts, Checkout Ranges
                    first_turn_score: awayLeg.first_turn_score || 0,
                    ton_points: awayLeg.ton_points || 0,
                    threw_first: awayLeg.threw_first,
                    co_80_attempts: awayLeg.co_80_attempts || 0,
                    co_80_hits: awayLeg.co_80_hits || 0,
                    co_120_attempts: awayLeg.co_120_attempts || 0,
                    co_120_hits: awayLeg.co_120_hits || 0,
                    co_140_attempts: awayLeg.co_140_attempts || 0,
                    co_140_hits: awayLeg.co_140_hits || 0,
                    co_161_attempts: awayLeg.co_161_attempts || 0,
                    co_161_hits: awayLeg.co_161_hits || 0
                },
                player_stats: player_stats,
                throws: throws
            });
        }
        return legs;
    };

    // Handle Chicago match progression
    if (isChicago && chicagoGame > 0) {
        const chicagoMatch = JSON.parse(sessionStorage.getItem('chicagoMatch') || '{}');

        // Update wins
        if (winner === 'home') chicagoMatch.home_wins++;
        else chicagoMatch.away_wins++;

        // Check if match is over (first to 2 wins)
        if (chicagoMatch.home_wins >= 2 || chicagoMatch.away_wins >= 2) {
            const matchWinner = chicagoMatch.home_wins >= 2 ? 'Home' : 'Away';
            alert(`Chicago Match Over! ${matchWinner} wins ${chicagoMatch.home_wins}-${chicagoMatch.away_wins}`);
            sessionStorage.removeItem('chicagoMatch');
            window.location.href = '/pages/scorer-hub.html';
            return;
        }

        // Move to next game
        chicagoMatch.current_game++;
        sessionStorage.setItem('chicagoMatch', JSON.stringify(chicagoMatch));

        const nextGame = chicagoMatch.games[chicagoMatch.current_game - 1];
        const params = new URLSearchParams();
        params.set('home_players', JSON.stringify(chicagoMatch.home_players));
        params.set('away_players', JSON.stringify(chicagoMatch.away_players));
        params.set('casual', 'true');
        params.set('chicago', 'true');
        params.set('chicago_game', chicagoMatch.current_game.toString());
        params.set('legs_to_win', '1');
        params.set('cork_rule', chicagoMatch.cork_rule);
        if (chicagoMatch.practice_mode && chicagoMatch.practice_mode !== 'off') {
            params.set('practice_mode', chicagoMatch.practice_mode);
        }

        if (nextGame.type === 'cricket') {
            // Game 2: Cricket
            window.location.href = `/pages/league-cricket.html?${params.toString()}`;
        } else {
            // Game 3: 301 DIDO
            params.set('starting_score', nextGame.starting_score.toString());
            params.set('in_rule', nextGame.in_rule);
            params.set('out_rule', nextGame.out_rule);
            params.set('checkout', nextGame.out_rule);
            window.location.href = `/pages/league-501.html?${params.toString()}`;
        }
        return;
    }

    // Build comprehensive game stats with leg-by-leg data (DartConnect compatible)
    const comprehensiveGameStats = {
        game_type: chosenFormat || '501',
        starting_score: STARTING_SCORE,
        duration_seconds: duration,
        // Cork's choice fields (for doubles choice games)
        cork_choice: chosenFormat || null,
        cork_winner: corkWinnerSide || null,
        // Summary stats
        home: {
            name: teams[0].name,
            legs: teams[0].legs,
            average: homeAvg,
            first9_avg: teams[0].first9Darts > 0 ? parseFloat((teams[0].first9Points / teams[0].first9Darts * 3).toFixed(2)) : 0,
            // Ton breakdown
            tons: teams[0].tons,
            ton_00: teams[0].ton_00,
            ton_20: teams[0].ton_20,
            ton_40: teams[0].ton_40,
            ton_60: teams[0].ton_60,
            ton_80: teams[0].ton_80,
            ton80s: teams[0].ton80s,
            ton_71: teams[0].ton_71,
            // Checkout stats
            high_checkout: teams[0].highCheckout,
            high_score: teams[0].highScore,
            best_leg: teams[0].bestLeg < 999 ? teams[0].bestLeg : 0,
            checkout_attempts: teams[0].checkoutAttempts,
            checkout_darts: teams[0].checkoutDarts,
            checkouts_hit: teams[0].totalCheckouts
        },
        away: {
            name: teams[1].name,
            legs: teams[1].legs,
            average: awayAvg,
            first9_avg: teams[1].first9Darts > 0 ? parseFloat((teams[1].first9Points / teams[1].first9Darts * 3).toFixed(2)) : 0,
            // Ton breakdown
            tons: teams[1].tons,
            ton_00: teams[1].ton_00,
            ton_20: teams[1].ton_20,
            ton_40: teams[1].ton_40,
            ton_60: teams[1].ton_60,
            ton_80: teams[1].ton_80,
            ton80s: teams[1].ton80s,
            ton_71: teams[1].ton_71,
            // Checkout stats
            high_checkout: teams[1].highCheckout,
            high_score: teams[1].highScore,
            best_leg: teams[1].bestLeg < 999 ? teams[1].bestLeg : 0,
            checkout_attempts: teams[1].checkoutAttempts,
            checkout_darts: teams[1].checkoutDarts,
            checkouts_hit: teams[1].totalCheckouts
        },
        // Leg-by-leg data for player stat aggregation
        legs: buildLegData()
    };

    const gameResult = {
        game_number: gameNumber,
        game_type: '501',
        winner,
        home_legs: teams[0].legs,
        away_legs: teams[1].legs,
        stats: { home_avg: homeAvg, away_avg: awayAvg, home_180s: teams[0].ton80s, away_180s: teams[1].ton80s }
    };

    if (fromMatch) {
        const matchState = JSON.parse(sessionStorage.getItem('activeMatch') || '{}');
        if (!matchState.games_completed) matchState.games_completed = [];
        matchState.games_completed.push(gameResult);
        matchState[winner + '_score'] = (matchState[winner + '_score'] || 0) + 1;
        sessionStorage.setItem('activeMatch', JSON.stringify(matchState));

        try {
            if (leagueId && matchId) {
                showLoading('Saving game...');
                await callWithQueue(callFunction, 'submitGameResult', {
                    league_id: leagueId, match_id: matchId, game_number: gameNumber,
                    winner, home_legs_won: teams[0].legs, away_legs_won: teams[1].legs,
                    admin_pin: adminPin,
                    game_stats: comprehensiveGameStats
                });
                hideLoading();
            }
        } catch (e) {
            hideLoading();
            if (e.message !== 'QUEUED_OFFLINE') console.error('Save error:', e);
        }

        // Clear saved game state (game completed successfully)
        await clearSavedGame();

        // Check if this is the final game of the match
        const isFinalGame = totalGames > 0 && gameNumber >= totalGames;

        if (isFinalGame) {
            // Show match complete modal instead of returning to hub
            showMatchCompleteModal(matchState, comprehensiveGameStats);
            return;
        }

        // Not the final game - return to match-hub with league and match context
        window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}`;
        return;
    }

    showLoading('Saving game...');
    try {
        if (leagueId && matchId) {
            // League game submission with offline queue fallback
            await callWithQueue(callFunction, 'submitGameResult', {
                league_id: leagueId, match_id: matchId, game_number: gameNumber,
                winner, home_legs_won: teams[0].legs, away_legs_won: teams[1].legs,
                admin_pin: adminPin,
                game_stats: comprehensiveGameStats
            });
            hideLoading();
            alert('Game saved!');
        } else if (tournamentId && tournamentMatchId) {
            // Tournament game submission with offline queue fallback
            await callWithQueue(callFunction, 'submitMatchResult', {
                tournament_id: tournamentId,
                match_id: tournamentMatchId,
                player1_score: teams[0].legs,
                player2_score: teams[1].legs,
                game_stats: comprehensiveGameStats
            });
            hideLoading();
            alert('Tournament match saved!');
        } else if (isKnockout && knockoutId) {
            // Knockout match submission with offline queue fallback
            const winnerTeamIndex = teams[0].legs >= LEGS_TO_WIN ? 0 : 1;
            await callWithQueue(callFunction, 'submitKnockoutMatch', {
                knockout_id: knockoutId,
                match_number: knockoutMatchNumber,
                winner_index: winnerTeamIndex,
                score: [teams[0].legs, teams[1].legs]
            });
            hideLoading();
            // Clear knockout context from localStorage
            localStorage.removeItem('knockoutContext');
        } else if (isVerificationMode) {
            // Stats verification mode - save results and submit
            hideLoading();
            await handleVerificationComplete(comprehensiveGameStats);
            return; // handleVerificationComplete handles navigation
        } else if (isCasual) {
            // Casual/Pickup game - save to pickup_games collection
            hideLoading();
            await saveCasualGame(comprehensiveGameStats);
            return; // saveCasualGame handles navigation
        } else {
            hideLoading();
        }
    } catch (e) {
        hideLoading();
        if (e.message === 'QUEUED_OFFLINE') {
            alert('You appear to be offline. Game has been queued and will sync when connection is restored.');
        } else {
            console.error('Save error:', e);
            alert('Error: ' + e.message);
        }
    }

    await navigateAway();
};

// Save casual/pickup game with stats
async function saveCasualGame(gameStats) {
    // Get player info - check URL params for pre-verified player
    const statPlayerId = params.get('stat_player_id');
    const statPlayerName = params.get('stat_player_name');

    // Check if players are bots
    const player1IsBot = isHomeBot();
    const player2IsBot = isAwayBot();

    // Prompt for player PINs if not pre-verified and not a bot
    let player1Pin = statPlayerId ? null : (localStorage.getItem('brdc_player_pin') || null);
    let player2Pin = null;

    const player1Name = homePlayers[0]?.name || teams[0].name;
    const player2Name = awayPlayers[0]?.name || teams[1].name;

    // Build confirmation message
    let confirmMsg = `Save this game to track stats?\n\n${player1Name}${player1IsBot ? ' (Bot)' : ''}: ${teams[0].legs} legs\n${player2Name}${player2IsBot ? ' (Bot)' : ''}: ${teams[1].legs} legs\n\n${teams[0].name} avg: ${gameStats.home.average}\n${teams[1].name} avg: ${gameStats.away.average}`;

    // If no pre-verified player, offer to save with PINs
    const wantToSave = confirm(confirmMsg);

    if (!wantToSave) {
        showCasualGameSummary(gameStats);
        return;
    }

    // Get PINs for human players who want to track stats
    if (!statPlayerId && !player1IsBot) {
        player1Pin = prompt(`Enter PIN for ${player1Name} to track stats (or leave blank for guest):`);
        if (player1Pin) localStorage.setItem('brdc_player_pin', player1Pin.toUpperCase());
    }

    if (!player2IsBot) {
        player2Pin = prompt(`Enter PIN for ${player2Name} to track stats (or leave blank for guest):`);
    }

    showLoading('Saving game...');

    try {
        const winnerIndex = teams[0].legs >= LEGS_TO_WIN ? 0 : 1;

        // Build legs data for pickup game format
        const pickupLegs = gameStats.legs.map((leg, idx) => ({
            winner: leg.winner === 'home' ? 'player1' : 'player2',
            player1_stats: {
                darts_thrown: leg.home_stats?.darts_thrown || 0,
                points_scored: leg.home_stats?.points_scored || 0,
                first9_darts: leg.home_stats?.first9_darts || 0,
                first9_points: leg.home_stats?.first9_points || 0,
                tons: leg.home_stats?.tons || 0,
                ton_00: leg.home_stats?.ton_00 || 0,
                ton_20: leg.home_stats?.ton_20 || 0,
                ton_40: leg.home_stats?.ton_40 || 0,
                ton_60: leg.home_stats?.ton_60 || 0,
                ton_80: leg.home_stats?.ton_80 || 0,
                checkout: leg.home_stats?.checkout || 0,
                checkout_attempts: leg.home_stats?.checkout_attempts || 0,
                checkout_darts: leg.home_stats?.checkout_darts || 0,
                high_score: leg.home_stats?.high_score || 0,
                // NEW: HSI, Ton Points, With/Against Darts, Checkout Ranges
                first_turn_score: leg.home_stats?.first_turn_score || 0,
                ton_points: leg.home_stats?.ton_points || 0,
                threw_first: leg.home_stats?.threw_first,
                co_80_attempts: leg.home_stats?.co_80_attempts || 0,
                co_80_hits: leg.home_stats?.co_80_hits || 0,
                co_120_attempts: leg.home_stats?.co_120_attempts || 0,
                co_120_hits: leg.home_stats?.co_120_hits || 0,
                co_140_attempts: leg.home_stats?.co_140_attempts || 0,
                co_140_hits: leg.home_stats?.co_140_hits || 0,
                co_161_attempts: leg.home_stats?.co_161_attempts || 0,
                co_161_hits: leg.home_stats?.co_161_hits || 0
            },
            player2_stats: {
                darts_thrown: leg.away_stats?.darts_thrown || 0,
                points_scored: leg.away_stats?.points_scored || 0,
                first9_darts: leg.away_stats?.first9_darts || 0,
                first9_points: leg.away_stats?.first9_points || 0,
                tons: leg.away_stats?.tons || 0,
                ton_00: leg.away_stats?.ton_00 || 0,
                ton_20: leg.away_stats?.ton_20 || 0,
                ton_40: leg.away_stats?.ton_40 || 0,
                ton_60: leg.away_stats?.ton_60 || 0,
                ton_80: leg.away_stats?.ton_80 || 0,
                checkout: leg.away_stats?.checkout || 0,
                checkout_attempts: leg.away_stats?.checkout_attempts || 0,
                checkout_darts: leg.away_stats?.checkout_darts || 0,
                high_score: leg.away_stats?.high_score || 0,
                // NEW: HSI, Ton Points, With/Against Darts, Checkout Ranges
                first_turn_score: leg.away_stats?.first_turn_score || 0,
                ton_points: leg.away_stats?.ton_points || 0,
                threw_first: leg.away_stats?.threw_first,
                co_80_attempts: leg.away_stats?.co_80_attempts || 0,
                co_80_hits: leg.away_stats?.co_80_hits || 0,
                co_120_attempts: leg.away_stats?.co_120_attempts || 0,
                co_120_hits: leg.away_stats?.co_120_hits || 0,
                co_140_attempts: leg.away_stats?.co_140_attempts || 0,
                co_140_hits: leg.away_stats?.co_140_hits || 0,
                co_161_attempts: leg.away_stats?.co_161_attempts || 0,
                co_161_hits: leg.away_stats?.co_161_hits || 0
            }
        }));

        // Get bot IDs if applicable
        const player1BotId = player1IsBot ? (homePlayers[0]?.registeredBotId || null) : null;
        const player2BotId = player2IsBot ? (awayPlayers[0]?.registeredBotId || null) : null;

        const payload = {
            game_type: STARTING_SCORE.toString(),
            players: [
                {
                    id: statPlayerId || player1BotId || null,
                    pin: player1Pin?.toUpperCase() || null,
                    name: player1Name,
                    is_bot: player1IsBot
                },
                {
                    id: player2BotId || null,
                    pin: player2Pin?.toUpperCase() || null,
                    name: player2Name,
                    is_bot: player2IsBot
                }
            ],
            winner_index: winnerIndex,
            legs: pickupLegs,
            match_config: {
                bestOfLegs: LEGS_TO_WIN * 2 - 1,
                bestOfSets: 1,
                doubleOut: outRule === 'double',
                doubleIn: inRule === 'double'
            }
        };

        const result = await callFunction('savePickupGame', payload);
        hideLoading();

        if (result.success) {
            showCasualGameSummary(gameStats, 'Game saved! Stats updated.');
        } else {
            showCasualGameSummary(gameStats, 'Could not save: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        hideLoading();
        console.error('Error saving casual game:', error);
        showCasualGameSummary(gameStats, 'Error saving: ' + error.message);
    }
}

// Show casual game summary with stats
function showCasualGameSummary(gameStats, saveMessage = null) {
    const modal = document.getElementById('gameModal');
    const statsDiv = document.getElementById('gameStats');
    const winnerName = document.getElementById('gameWinnerName');

    const winner = teams[0].legs >= LEGS_TO_WIN ? teams[0] : teams[1];
    winnerName.textContent = winner.name + ' WINS!';

    statsDiv.innerHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-size: 24px; color: var(--yellow);">${teams[0].legs} - ${teams[1].legs}</div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
            <div>
                <div style="font-weight: 700; color: var(--pink); margin-bottom: 8px;">${teams[0].name}</div>
                <div style="font-size: 28px; font-family: 'Rowdies', cursive;">${gameStats.home.average}</div>
                <div style="font-size: 11px; opacity: 0.7;">3-Dart Avg</div>
                <div style="margin-top: 8px;">
                    <span style="color: var(--yellow);">${gameStats.home.ton80s || 0}</span> 180s
                    <span style="margin-left: 10px; color: var(--teal);">${gameStats.home.high_checkout || '-'}</span> High Out
                </div>
            </div>
            <div>
                <div style="font-weight: 700; color: var(--teal); margin-bottom: 8px;">${teams[1].name}</div>
                <div style="font-size: 28px; font-family: 'Rowdies', cursive;">${gameStats.away.average}</div>
                <div style="font-size: 11px; opacity: 0.7;">3-Dart Avg</div>
                <div style="margin-top: 8px;">
                    <span style="color: var(--yellow);">${gameStats.away.ton80s || 0}</span> 180s
                    <span style="margin-left: 10px; color: var(--teal);">${gameStats.away.high_checkout || '-'}</span> High Out
                </div>
            </div>
        </div>
        ${saveMessage ? `<div style="margin-top: 15px; font-size: 13px; color: ${saveMessage.includes('saved') ? '#4CAF50' : '#ff6b6b'};">${saveMessage}</div>` : ''}
    `;

    // Replace the buttons with just a "DONE" button
    const modalContent = modal.querySelector('.modal-content');
    const existingBtns = modalContent.querySelectorAll('.modal-btn');
    existingBtns.forEach(btn => btn.style.display = 'none');

    // Add done button if not exists
    if (!document.getElementById('casualDoneBtn')) {
        const doneBtn = document.createElement('button');
        doneBtn.id = 'casualDoneBtn';
        doneBtn.className = 'modal-btn';
        doneBtn.textContent = 'DONE';
        doneBtn.onclick = () => navigateAway();
        doneBtn.style.marginTop = '15px';
        modalContent.appendChild(doneBtn);
    }

    modal.classList.add('active');
}

// Handle verification mode completion
async function handleVerificationComplete(gameStats) {
    // Get verification session from sessionStorage
    const sessionData = sessionStorage.getItem('verificationSession');
    if (!sessionData) {
        alert('Verification session not found. Results cannot be saved.');
        navigateAway();
        return;
    }

    const session = JSON.parse(sessionData);

    // Build leg data for verification - player is always home team (position 0)
    const x01Legs = gameStats.legs.map((leg, idx) => {
        const playerStats = leg.home_stats || {};
        const dartsThrown = playerStats.darts_thrown || 0;
        const pointsScored = playerStats.points_scored || 0;
        const avg = dartsThrown > 0 ? (pointsScored / dartsThrown * 3) : 0;
        const won = leg.winner === 'home';

        return {
            leg: idx + 1,
            darts: dartsThrown,
            avg: avg,
            won: won,
            checkout: playerStats.checkout || 0,
            tons: playerStats.tons || 0
        };
    });

    // Calculate player's wins
    const playerWins = x01Legs.filter(l => l.won).length;

    // Calculate verified average (best 3 of 5)
    const sortedByAvg = [...x01Legs].sort((a, b) => b.avg - a.avg);
    const top3 = sortedByAvg.slice(0, 3);
    const droppedLegs = sortedByAvg.slice(3).map(l => l.leg);
    const verified3DA = top3.reduce((sum, l) => sum + l.avg, 0) / 3;

    // Check if player won at least 2 of top 3 legs
    const top3Wins = top3.filter(l => l.won).length;
    const isValidVerification = top3Wins >= 2;

    // Show verification results modal
    const modal = document.getElementById('gameModal');
    const statsDiv = document.getElementById('gameStats');
    const winnerName = document.getElementById('gameWinnerName');

    winnerName.textContent = isValidVerification ? '501 VERIFICATION COMPLETE!' : '501 VERIFICATION';
    winnerName.style.color = isValidVerification ? '#22c55e' : '#FDD835';

    let legsHtml = x01Legs.map(l => {
        const dropped = droppedLegs.includes(l.leg);
        return `
            <div style="display: flex; justify-content: space-between; padding: 6px 0; ${dropped ? 'opacity: 0.4; text-decoration: line-through;' : ''}">
                <span>Leg ${l.leg}</span>
                <span style="color: ${l.won ? '#22c55e' : '#ef4444'};">${l.won ? 'WIN' : 'LOSS'}</span>
                <span style="color: var(--yellow);">${l.avg.toFixed(1)} avg</span>
                <span>${l.darts} darts</span>
            </div>
        `;
    }).join('');

    statsDiv.innerHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
            <div style="font-size: 14px; opacity: 0.7; margin-bottom: 4px;">YOUR RECORD</div>
            <div style="font-size: 28px; color: var(--yellow);">${playerWins} - ${5 - playerWins}</div>
        </div>
        <div style="margin-bottom: 15px;">
            ${legsHtml}
        </div>
        <div style="background: rgba(145,215,235,0.15); border: 2px solid var(--teal); border-radius: 8px; padding: 12px; text-align: center;">
            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 4px;">VERIFIED 3-DART AVERAGE (Best 3 of 5)</div>
            <div style="font-size: 36px; font-family: 'Rowdies', cursive; color: var(--yellow);">${verified3DA.toFixed(1)}</div>
            <div style="font-size: 12px; color: ${isValidVerification ? '#22c55e' : '#ef4444'}; margin-top: 8px;">
                ${isValidVerification ?
                    `Won ${top3Wins} of 3 counting legs - Valid verification` :
                    `Won only ${top3Wins} of 3 counting legs - Must win at least 2`}
            </div>
        </div>
    `;

    // Replace buttons
    const modalContent = modal.querySelector('.modal-content');
    const existingBtns = modalContent.querySelectorAll('.modal-btn');
    existingBtns.forEach(btn => btn.style.display = 'none');

    // Remove existing verification buttons if present
    const existingVerBtns = modalContent.querySelectorAll('.verification-btn');
    existingVerBtns.forEach(btn => btn.remove());

    if (isValidVerification) {
        // Save button
        const saveBtn = document.createElement('button');
        saveBtn.className = 'modal-btn verification-btn';
        saveBtn.textContent = 'SAVE VERIFIED STATS';
        saveBtn.style.marginTop = '15px';
        saveBtn.style.background = '#22c55e';
        saveBtn.onclick = async () => {
            saveBtn.textContent = 'SAVING...';
            saveBtn.disabled = true;

            try {
                // Submit to Cloud Function
                const result = await callFunction('submitVerification', {
                    player_id: session.player_id,
                    player_pin: session.player_pin,
                    x01_legs: x01Legs,
                    cricket_legs: [] // Empty for now - cricket verification separate
                });

                if (result.success) {
                    // Store results for return page
                    sessionStorage.setItem('verificationResults', JSON.stringify({
                        game_type: '501',
                        verified_3da: result.verified_3da || verified3DA,
                        legs: x01Legs
                    }));

                    // Clear session
                    sessionStorage.removeItem('verificationSession');

                    alert(`501 Stats Verified!\n\nVerified 3DA: ${(result.verified_3da || verified3DA).toFixed(1)}`);
                    navigateAway();
                } else {
                    throw new Error(result.error || 'Failed to save verification');
                }
            } catch (err) {
                console.error('Verification save error:', err);
                alert('Error saving verification: ' + err.message);
                saveBtn.textContent = 'SAVE VERIFIED STATS';
                saveBtn.disabled = false;
            }
        };
        modalContent.appendChild(saveBtn);
    } else {
        // Retry button
        const retryBtn = document.createElement('button');
        retryBtn.className = 'modal-btn verification-btn';
        retryBtn.textContent = 'TRY AGAIN';
        retryBtn.style.marginTop = '15px';
        retryBtn.onclick = () => {
            // Restart verification
            window.location.reload();
        };
        modalContent.appendChild(retryBtn);
    }

    // Cancel button
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'modal-btn verification-btn';
    cancelBtn.textContent = 'BACK TO VERIFICATION';
    cancelBtn.style.marginTop = '10px';
    cancelBtn.style.background = 'rgba(255,255,255,0.1)';
    cancelBtn.onclick = () => {
        sessionStorage.removeItem('verificationSession');
        navigateAway();
    };
    modalContent.appendChild(cancelBtn);

    modal.classList.add('active');
}

// ========== MATCH COMPLETE MODAL ==========

function showMatchCompleteModal(matchState, gameStats) {
    const homeScore = matchState.home_score || 0;
    const awayScore = matchState.away_score || 0;

    // Populate team names
    document.getElementById('matchCompleteHomeName').textContent = homeTeamName;
    document.getElementById('matchCompleteAwayName').textContent = awayTeamName;

    // Populate scores
    const homeScoreEl = document.getElementById('matchCompleteHomeScore');
    const awayScoreEl = document.getElementById('matchCompleteAwayScore');
    homeScoreEl.textContent = homeScore;
    awayScoreEl.textContent = awayScore;

    // Style winner score with yellow
    if (homeScore > awayScore) {
        homeScoreEl.style.color = 'var(--yellow)';
        awayScoreEl.style.color = 'var(--text-muted)';
    } else if (awayScore > homeScore) {
        awayScoreEl.style.color = 'var(--yellow)';
        homeScoreEl.style.color = 'var(--text-muted)';
    } else {
        homeScoreEl.style.color = 'var(--text-light)';
        awayScoreEl.style.color = 'var(--text-light)';
    }

    // Winner announcement
    const winnerEl = document.getElementById('matchCompleteWinner');
    if (homeScore > awayScore) {
        winnerEl.textContent = `${homeTeamName} WINS!`;
        winnerEl.style.color = 'var(--pink)';
    } else if (awayScore > homeScore) {
        winnerEl.textContent = `${awayTeamName} WINS!`;
        winnerEl.style.color = 'var(--teal)';
    } else {
        winnerEl.textContent = 'MATCH TIED!';
        winnerEl.style.color = 'var(--yellow)';
    }

    // Build stats summary from accumulated game results
    const gamesCompleted = matchState.games_completed || [];
    let totalHomeLegs = 0;
    let totalAwayLegs = 0;
    let totalHome180s = 0;
    let totalAway180s = 0;
    let homeAvgSum = 0;
    let awayAvgSum = 0;
    let homeAvgCount = 0;
    let awayAvgCount = 0;
    let highCheckoutHome = 0;
    let highCheckoutAway = 0;

    gamesCompleted.forEach(g => {
        totalHomeLegs += g.home_legs || 0;
        totalAwayLegs += g.away_legs || 0;
        if (g.stats) {
            if (g.stats.home_avg) { homeAvgSum += g.stats.home_avg; homeAvgCount++; }
            if (g.stats.away_avg) { awayAvgSum += g.stats.away_avg; awayAvgCount++; }
            totalHome180s += g.stats.home_180s || 0;
            totalAway180s += g.stats.away_180s || 0;
        }
    });

    // Add current game stats
    if (gameStats) {
        if (gameStats.home?.high_checkout > highCheckoutHome) highCheckoutHome = gameStats.home.high_checkout;
        if (gameStats.away?.high_checkout > highCheckoutAway) highCheckoutAway = gameStats.away.high_checkout;
    }

    const homeAvg = homeAvgCount > 0 ? (homeAvgSum / homeAvgCount).toFixed(1) : '-';
    const awayAvg = awayAvgCount > 0 ? (awayAvgSum / awayAvgCount).toFixed(1) : '-';

    const statsHtml = `
        <div class="row"><span>Total Legs</span><span class="val">${totalHomeLegs} - ${totalAwayLegs}</span></div>
        <div class="row"><span>Match 3DA</span><span class="val">${homeAvg} - ${awayAvg}</span></div>
        <div class="row"><span>180s</span><span class="val">${totalHome180s} - ${totalAway180s}</span></div>
        ${highCheckoutHome > 0 || highCheckoutAway > 0 ?
            `<div class="row"><span>High Checkout</span><span class="val">${highCheckoutHome || '-'} - ${highCheckoutAway || '-'}</span></div>` : ''}
    `;

    document.getElementById('matchCompleteStats').innerHTML = statsHtml;

    // End live match tracking
    if ((leagueId && matchId) || tournamentId) {
        try {
            const scorerPin = localStorage.getItem('brdc_player_pin') || adminPin || matchPin;
            if (scorerPin) {
                callFunction('endLiveMatch', {
                    scorer_pin: scorerPin,
                    match_id: matchId || tournamentMatchId,
                    result: {
                        winner: homeScore > awayScore ? 'team1' : (awayScore > homeScore ? 'team2' : 'tie'),
                        team1_score: homeScore,
                        team2_score: awayScore,
                        total_legs: totalHomeLegs + totalAwayLegs
                    }
                }).catch(e => console.warn('Failed to end live match tracking:', e));
            }
        } catch (e) {
            console.warn('Failed to end live match tracking:', e);
        }
    }

    // Show modal
    document.getElementById('matchCompleteModal').classList.add('active');
}

window.viewMatchReport = function() {
    if (leagueId && matchId) {
        window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}&tab=games`;
    } else {
        window.location.href = '/pages/scorer-hub.html';
    }
};

window.backToHub = function() {
    if (leagueId && matchId) {
        window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}`;
    } else {
        window.location.href = '/pages/scorer-hub.html';
    }
};

window.exitWithoutSave = function() {
    if (confirm('Exit without saving?')) navigateAway();
};

async function navigateAway() {
    // Clear saved game state (game completed successfully)
    await clearSavedGame();

    // Simple return logic: league games go to match-hub, everything else to scorer-hub
    if (leagueId && matchId) {
        window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}`;
    } else {
        window.location.href = '/pages/scorer-hub.html';
    }
}

window.exitGame = function() {
    // For casual games, offer to save and resume from game-setup
    if (isCasual) {
        const hasProgress = teams[0].darts > 0 || teams[1].darts > 0 || teams[0].legs > 0 || teams[1].legs > 0;
        if (hasProgress) {
            // Save match state for resume
            const resumeState = {
                timestamp: Date.now(),
                gameType: '501',
                startingScore: STARTING_SCORE,
                inRule: inRule,
                outRule: outRule,
                teams: teams.map(t => ({
                    name: t.name,
                    score: t.score,
                    legs: t.legs,
                    sets: t.sets || 0,
                    darts: t.darts,
                    points: t.points,
                    tons: t.tons,
                    ton40s: t.ton40s,
                    ton80s: t.ton80s,
                    highCheckout: t.highCheckout,
                    bestLeg: t.bestLeg,
                    totalCheckouts: t.totalCheckouts,
                    checkoutAttempts: t.checkoutAttempts
                })),
                activeTeam: activeTeam,
                currentLeg: currentLeg,
                legsToWin: legsToWin,
                setsToWin: setsToWin,
                isMixedGame: isMixedGame,
                mixedLegIndex: mixedLegIndex,
                homePlayers: homePlayers,
                awayPlayers: awayPlayers
            };
            sessionStorage.setItem('matchResumeState', JSON.stringify(resumeState));
            window.location.href = '/pages/game-setup.html?resume=true';
            return;
        }
    }

    // Non-casual games or no progress - confirm and navigate away
    if (teams[0].darts > 0 || teams[1].darts > 0) {
        if (!confirm('Exit? Game progress will be lost.')) return;
    }
    navigateAway();
};

// ===== CASUAL SETUP SCREEN FUNCTIONS =====
let setupState = {
    player1Name: 'Player 1',
    player2Name: 'Player 2',
    legs: 3,
    startingScore: 501,
    doubleIn: false,
    doubleOut: true,
    starterRule: 'cork' // 'cork', 'player1', 'player2', 'alternate'
};

function showSetupScreen() {
    document.getElementById('setupScreen').classList.add('active');
}

function hideSetupScreen() {
    document.getElementById('setupScreen').classList.remove('active');
}

window.toggleSetupDI = function(enabled) {
    setupState.doubleIn = enabled;
    const btns = document.querySelectorAll('#setupScreen .setup-section:nth-child(4) .setup-form-group:first-child .setup-toggle-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    btns[enabled ? 1 : 0].classList.add('active');
};

window.toggleSetupDO = function(enabled) {
    setupState.doubleOut = enabled;
    const btns = document.querySelectorAll('#setupScreen .setup-section:nth-child(4) .setup-form-group:last-child .setup-toggle-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    btns[enabled ? 1 : 0].classList.add('active');
};

window.setSetupStarter = function(rule) {
    setupState.starterRule = rule;
    const btns = document.querySelectorAll('#setupScreen .setup-section:nth-child(5) .setup-toggle-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    const index = ['cork', 'player1', 'player2', 'alternate'].indexOf(rule);
    if (index >= 0) btns[index].classList.add('active');
};

window.startCasualGame = function() {
    // Get values from setup form
    setupState.player1Name = document.getElementById('setupPlayer1').value.trim() || 'Player 1';
    setupState.player2Name = document.getElementById('setupPlayer2').value.trim() || 'Player 2';
    setupState.legs = parseInt(document.getElementById('setupLegs').value) || 3;
    setupState.startingScore = parseInt(document.getElementById('setupScore').value) || 501;

    // Update global state
    STARTING_SCORE = setupState.startingScore;
    LEGS_TO_WIN = Math.ceil(setupState.legs / 2);
    legsToWin = LEGS_TO_WIN;
    inRule = setupState.doubleIn ? 'double' : 'straight';
    checkout = setupState.doubleOut ? 'double' : 'straight';
    isCasual = true;

    // Update cork settings based on starter rule
    switch (setupState.starterRule) {
        case 'cork':
            useCork = true;
            corkRule = 'cork_every';
            break;
        case 'player1':
            useCork = false;
            activeTeam = 0;
            lastLegStarter = 0;
            break;
        case 'player2':
            useCork = false;
            activeTeam = 1;
            lastLegStarter = 1;
            break;
        case 'alternate':
            useCork = false;
            corkRule = 'loser_starts';
            activeTeam = 0;
            lastLegStarter = 0;
            break;
    }

    // Set up players
    homePlayers = [{ id: 'casual_p1', name: setupState.player1Name }];
    awayPlayers = [{ id: 'casual_p2', name: setupState.player2Name }];

    // Update team data
    teams[0].name = setupState.player1Name;
    teams[1].name = setupState.player2Name;
    teams[0].score = STARTING_SCORE;
    teams[1].score = STARTING_SCORE;

    // Hide setup screen and start game
    hideSetupScreen();
    init();
};

// Startup: Check if we have match data or need setup/PIN entry
if (isCasual && homePlayers.length > 0) {
    // Casual game from game-setup - initialize directly
    init();

    // Restore resume state if applicable
    if (isResumeMode && (resumeHomeDarts > 0 || resumeAwayDarts > 0)) {
        teams[0].score = resumeHomeScore;
        teams[1].score = resumeAwayScore;
        teams[0].darts = resumeHomeDarts;
        teams[1].darts = resumeAwayDarts;
        activeTeam = resumeActiveTeam;

        // Update displays
        updateScoreDisplay();
        updateThrowHistory();
        updateActivePanel();

        // Hide wrong game button since we're resuming mid-leg
        const wrongGameBtn = document.getElementById('wrongGameBtn');
        if (wrongGameBtn) wrongGameBtn.style.display = 'none';

        // Clear the resume state from sessionStorage
        sessionStorage.removeItem('matchResumeState');
    }
} else if (leagueId && matchId && homePlayers.length > 0) {
    // URL has match params - initialize directly
    init();
} else if (matchPin) {
    // Match PIN provided in URL - load match
    document.getElementById('pinEntryScreen').style.display = 'flex';
    document.getElementById('pinEntryScreen').classList.add('active');
    const pinInputs = document.querySelectorAll('.pin-char');
    matchPin.split('').forEach((char, i) => {
        if (pinInputs[i]) pinInputs[i].value = char;
    });
    loadMatchByPin();
} else {
    // No match data - show casual setup screen (unified scorer behavior)
    showSetupScreen();
}

// ===== GAME SELECTOR FUNCTIONS =====
let gameSelectorMode = 'next'; // 'next' or 'current'
let selectedNextGameType = null;

function getGameLabel(leg) {
    if (!leg) return '501';
    if (leg.type === 'cricket') return 'CRICKET';
    if (leg.type === 'x01') return `${leg.score || 501} ${(leg.inRule === 'double' ? 'DI' : 'SI')}/${(leg.outRule === 'double' ? 'DO' : (leg.outRule === 'master' ? 'MO' : 'SO'))}`;
    if (leg.type === '301') return `301 ${(leg.outRule === 'double' ? 'DO' : 'SO')}`;
    if (leg.type === '701') return `701 ${(leg.outRule === 'double' ? 'DO' : 'SO')}`;
    return `501 ${(leg.outRule === 'double' ? 'DO' : 'SO')}`;
}

window.showGameSelector = function(mode) {
    gameSelectorMode = mode || 'next';
    document.getElementById('x01CustomOptions').style.display = 'none';
    document.getElementById('gameSelectorModal').classList.add('active');
};

window.selectNextGame = function(type) {
    if (type === 'x01') {
        document.getElementById('x01CustomOptions').style.display = 'block';
        selectedNextGameType = 'x01';
    } else {
        selectedNextGameType = type;
        applyGameSelection(type, type === '301' ? 301 : 501, 'straight', 'double');
    }
};

window.confirmX01Selection = function() {
    const score = parseInt(document.getElementById('x01CustomScore').value) || 501;
    const inRule = document.getElementById('x01CustomIn').value;
    const outRule = document.getElementById('x01CustomOut').value;
    applyGameSelection('x01', score, inRule, outRule);
};

function applyGameSelection(type, score, inRule, outRule) {
    document.getElementById('gameSelectorModal').classList.remove('active');

    if (gameSelectorMode === 'current') {
        // Change current game - navigate immediately
        navigateToGame(type, score, inRule, outRule, mixedLegIndex);
    } else {
        // Update next leg in mixed config
        const mixedConfig = JSON.parse(sessionStorage.getItem('mixedGameConfig') || '{}');
        const nextLegIndex = mixedLegIndex + 1;
        if (mixedConfig.legs && nextLegIndex < mixedConfig.legs.length) {
            mixedConfig.legs[nextLegIndex] = { type, score, inRule, outRule };
            sessionStorage.setItem('mixedGameConfig', JSON.stringify(mixedConfig));
            document.getElementById('nextGameLabel').textContent = getGameLabel(mixedConfig.legs[nextLegIndex]);
        }
    }
}

function navigateToGame(type, score, inRule, outRule, legIndex) {
    const newParams = new URLSearchParams();
    newParams.set('home_players', JSON.stringify(homePlayers));
    newParams.set('away_players', JSON.stringify(awayPlayers));
    newParams.set('casual', isCasual ? 'true' : 'false');
    newParams.set('mixed', 'true');
    newParams.set('mixed_leg', legIndex.toString());
    newParams.set('legs_to_win', LEGS_TO_WIN.toString());
    newParams.set('home_legs', teams[0].legs.toString());
    newParams.set('away_legs', teams[1].legs.toString());
    if (useCork) newParams.set('cork', 'true');

    if (type === 'cricket') {
        window.location.href = `/pages/league-cricket.html?${newParams.toString()}`;
    } else {
        newParams.set('starting_score', score.toString());
        newParams.set('in_rule', inRule);
        newParams.set('out_rule', outRule);
        newParams.set('checkout', outRule);
        window.location.href = `/pages/league-501.html?${newParams.toString()}`;
    }
}

window.closeGameSelector = function() {
    document.getElementById('gameSelectorModal').classList.remove('active');
    document.getElementById('x01CustomOptions').style.display = 'none';
};

function hideWrongGameBtn() {
    const btn = document.getElementById('wrongGameBtn');
    if (btn) btn.classList.add('hidden');
}

// Show/hide wrong game button based on mode
if (isMixedGame || isCasual) {
    document.getElementById('wrongGameBtn').style.display = 'block';
} else {
    document.getElementById('wrongGameBtn').style.display = 'none';
}

// Register service worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
        .then(() => {})
        .catch(err => console.error('[SW] Registration failed:', err));
}
</script>
<script src="/js/nav-menu.js"></script>
<script src="/js/feedback.js"></script>
</body>
</html>
