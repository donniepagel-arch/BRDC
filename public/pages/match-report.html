<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Report - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BRDC">
    <link rel="apple-touch-icon" href="/images/gold_logo.png">
    <meta name="theme-color" content="#FF469A">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --green: #10b981;
            --text-light: #f0f0f0;
            --text-primary: #f0f0f0;
            --text-dim: #8a8aa3;
            --text-secondary: #a0a0a0;
            --text-muted: #666;
            --black: #000000;
            --border: rgba(255, 255, 255, 0.1);
            --border-strong: #000;
            --glow-pink: rgba(255, 70, 154, 0.3);
            --glow-teal: rgba(145, 215, 235, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-light);
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .header-logo { width: 40px; height: 40px; }
        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 3px;
            color: var(--pink);
        }

        .back-btn {
            background: var(--bg-card);
            border: 2px solid var(--text-dim);
            border-radius: 8px;
            padding: 10px 16px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .back-btn:hover { border-color: var(--pink); color: var(--pink); }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 12px;
        }
        @media (min-width: 600px) {
            .container { padding: 20px; }
        }

        /* Match Header */
        .match-summary {
            background: var(--bg-panel);
            border: 4px solid var(--border-strong);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
        }

        .match-header-bar {
            background: linear-gradient(135deg, var(--pink) 0%, #d63384 100%);
            padding: 20px;
            text-align: center;
        }

        .match-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: white;
            margin: 0;
        }

        .match-meta {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 10px;
            font-size: 14px;
            color: rgba(255,255,255,0.9);
        }

        /* Compact Score Display */
        .score-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px;
            background: var(--bg-card);
        }
        .team-name-compact {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .team-name-compact.home { color: var(--pink); text-align: right; }
        .team-name-compact.away { color: var(--teal); text-align: left; }
        .score-box-report {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-dark);
            padding: 10px 16px;
            border-radius: 8px;
            border: 2px solid var(--border-strong);
        }
        .score-num-report {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            min-width: 32px;
            text-align: center;
        }
        .score-num-report.home { color: var(--pink); }
        .score-num-report.away { color: var(--teal); }
        .score-dash-report { color: var(--text-dim); font-size: 24px; }

        /* Desktop expand */
        @media (min-width: 600px) {
            .team-name-compact { font-size: 22px; max-width: 160px; }
            .score-num-report { font-size: 42px; min-width: 42px; }
            .score-box-report { padding: 12px 24px; gap: 12px; }
        }

        /* Report Navigation */
        .report-nav {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            flex-wrap: nowrap;
        }

        .nav-btn {
            background: var(--bg-card);
            border: 2px solid var(--border-strong);
            border-radius: 6px;
            padding: 8px 12px;
            font-family: 'Bebas Neue', cursive;
            font-size: 12px;
            letter-spacing: 0.5px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            white-space: nowrap;
            flex-shrink: 0;
        }
        .nav-btn:hover, .nav-btn:active {
            border-color: var(--teal);
            color: var(--teal);
        }
        .nav-btn.active {
            background: linear-gradient(135deg, var(--pink) 0%, #d63384 100%);
            border-color: var(--border-strong);
            color: white;
        }

        /* Desktop nav buttons */
        @media (min-width: 600px) {
            .nav-btn {
                padding: 10px 18px;
                font-size: 14px;
                border-radius: 8px;
            }
            .report-nav { gap: 10px; }
        }

        /* Player Filter */
        .player-filter {
            background: var(--bg-panel);
            border: 2px solid var(--text-dim);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .filter-label {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--yellow);
            margin-bottom: 10px;
        }

        .filter-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-chip {
            background: var(--bg-card);
            border: 2px solid var(--text-dim);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-chip:hover { border-color: var(--teal); }
        .filter-chip.active { background: var(--pink); border-color: var(--pink); color: white; }
        .filter-chip.home { border-color: var(--pink); }
        .filter-chip.away { border-color: var(--teal); }

        /* Player Cards Grid */
        .player-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        @media (min-width: 500px) {
            .player-cards { grid-template-columns: repeat(2, 1fr); }
        }
        @media (min-width: 800px) {
            .player-cards { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; }
        }

        .player-card {
            background: var(--bg-panel);
            border: 3px solid var(--border-strong);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.15s;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
        }
        .player-card:hover, .player-card:active {
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }
        .player-card.home { border-color: var(--pink); }
        .player-card.away { border-color: var(--teal); }

        .player-card-header {
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-card.home .player-card-header { background: rgba(255, 70, 154, 0.2); }
        .player-card.away .player-card-header { background: rgba(145, 215, 235, 0.2); }

        .player-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
        }
        .player-card.home .player-name { color: var(--pink); }
        .player-card.away .player-name { color: var(--teal); }

        .player-record {
            background: var(--bg-dark);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        .player-record .wins { color: var(--green); font-weight: 700; }
        .player-record .losses { color: #ef4444; font-weight: 700; }

        .player-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: rgba(255,255,255,0.1);
            padding: 1px;
        }

        .stat-cell {
            background: var(--bg-card);
            padding: 12px;
            text-align: center;
        }
        .stat-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; }
        .stat-value { font-family: 'Bebas Neue', cursive; font-size: 20px; }
        .stat-value.highlight { color: var(--yellow); }

        /* Games List */
        .games-section { margin-top: 20px; }
        .section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--yellow);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .game-card {
            background: var(--bg-panel);
            border: 3px solid var(--border-strong);
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
            transition: all 0.15s;
        }
        .game-card:hover, .game-card:active {
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }
        .game-card.home-win { border-color: var(--pink); }
        .game-card.away-win { border-color: var(--teal); }

        .game-header {
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .game-info {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
        }
        .game-format {
            background: var(--bg-card);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--teal);
        }

        .game-result {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .legs-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
        }
        .winner-badge {
            background: var(--green);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Leg Detail */
        .leg-row {
            background: var(--bg-dark);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: background 0.2s;
        }
        .leg-row:hover { background: rgba(255,255,255,0.05); }
        .leg-row:last-child { border-bottom: none; }

        .leg-summary {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            padding: 12px 15px;
            align-items: center;
            gap: 20px;
        }

        .leg-home, .leg-away { display: flex; align-items: center; gap: 10px; }
        .leg-home { justify-content: flex-start; color: var(--pink); }
        .leg-away { justify-content: flex-end; color: var(--teal); }

        .leg-avg {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
        }
        .leg-avg.big { color: var(--yellow); }

        .leg-center {
            text-align: center;
            font-family: 'Bebas Neue', cursive;
        }
        .leg-number { font-size: 16px; color: var(--yellow); }
        .leg-format { font-size: 11px; color: var(--text-dim); }

        .leg-winner-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }

        /* Throws Table */
        .throws-detail {
            display: none;
            background: var(--bg-panel);
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .throws-detail.show { display: block; }

        .throws-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .throws-table th {
            padding: 8px;
            text-align: center;
            color: var(--text-dim);
            font-weight: normal;
            font-size: 10px;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .throws-table td {
            padding: 6px 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .throws-table .round-num { color: var(--yellow); font-weight: 700; }
        .throws-table .home-cell { color: var(--pink); }
        .throws-table .away-cell { color: var(--teal); }
        .throws-table .notable { background: rgba(253, 216, 53, 0.15); }
        .throws-table .first-throw { background: rgba(16, 185, 129, 0.15); }
        .throws-table .checkout { color: var(--green); font-weight: 700; }

        .throws-footer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 12px;
        }

        .throws-footer .home-summary { color: var(--pink); }
        .throws-footer .away-summary { color: var(--teal); text-align: right; }

        /* Head to Head Section */
        .h2h-section {
            background: var(--bg-panel);
            border: 2px solid var(--yellow);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .h2h-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .h2h-selectors {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .h2h-selector {
            background: var(--bg-card);
            border: 2px solid var(--text-dim);
            border-radius: 8px;
            padding: 10px 15px;
            color: var(--text-light);
            font-size: 14px;
            cursor: pointer;
        }
        .h2h-selector:focus { outline: none; border-color: var(--yellow); }

        .h2h-vs {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--yellow);
        }

        .h2h-results {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
        }

        .h2h-player {
            text-align: center;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 8px;
        }
        .h2h-player.player1 { border-left: 4px solid var(--pink); }
        .h2h-player.player2 { border-right: 4px solid var(--teal); }

        .h2h-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            margin-bottom: 10px;
        }
        .h2h-player.player1 .h2h-name { color: var(--pink); }
        .h2h-player.player2 .h2h-name { color: var(--teal); }

        .h2h-score-block { text-align: center; }
        .h2h-legs-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            color: var(--yellow);
        }
        .h2h-label { font-size: 12px; color: var(--text-dim); margin-top: 5px; }

        /* Match Counts Section */
        .counts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .counts-card {
            background: var(--bg-panel);
            border: 2px solid var(--text-dim);
            border-radius: 12px;
            overflow: hidden;
        }

        .counts-header {
            background: var(--bg-card);
            padding: 12px 15px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--yellow);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .counts-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .counts-table th {
            padding: 10px;
            text-align: left;
            color: var(--text-dim);
            font-weight: normal;
            font-size: 10px;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .counts-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .counts-table .player-name { font-weight: 600; }
        .counts-table .home-player { color: var(--pink); }
        .counts-table .away-player { color: var(--teal); }
        .counts-table .highlight { color: var(--yellow); font-weight: 700; }

        @media (max-width: 768px) {
            .team-scoreboard { grid-template-columns: 1fr; text-align: center; }
            .vs-badge { margin: 10px auto; }
            .player-cards { grid-template-columns: 1fr; }
            .h2h-results { grid-template-columns: 1fr; }
            .h2h-score-block { order: -1; }
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--text-dim);
        }

        /* Clickable Player Names */
        .player-link {
            cursor: pointer;
            transition: all 0.15s;
        }
        .player-link:hover {
            text-decoration: underline;
            filter: brightness(1.2);
        }

        /* Print Styles */
        @media print {
            body {
                background: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            body::before {
                display: none;
            }

            .header-bar {
                background: white !important;
                border-bottom: 2px solid #333 !important;
                position: relative;
                box-shadow: none;
            }

            .back-btn, .report-nav, .player-filter {
                display: none !important;
            }

            .match-summary {
                box-shadow: none;
                border: 2px solid #333;
            }

            .match-header-bar {
                background: #f0f0f0 !important;
                color: black !important;
            }

            .match-title {
                color: black !important;
            }

            .match-meta {
                color: #333 !important;
            }

            .score-row {
                background: #f8f8f8 !important;
            }

            .team-name-compact.home,
            .team-name-compact.away {
                color: black !important;
            }

            .score-num-report.home { color: #d63384 !important; }
            .score-num-report.away { color: #0d6efd !important; }

            .player-card, .game-card, .counts-card {
                box-shadow: none;
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }

            .player-card-header {
                background: #f0f0f0 !important;
            }

            .player-name {
                color: black !important;
            }

            .stat-cell, .leg-row, .throws-detail {
                background: white !important;
            }

            .section-title, .counts-header {
                color: #333 !important;
            }

            .stat-label, .leg-format, .match-number {
                color: #666 !important;
            }

            .stat-value, .leg-avg, .leg-number {
                color: black !important;
            }

            .stat-value.highlight {
                color: #d4a300 !important;
            }

            .throws-detail {
                display: block !important;
            }

            .container {
                max-width: 100%;
                padding: 10px;
            }

            .tab-panel {
                display: block !important;
            }

            #tab-h2h, #tab-counts {
                page-break-before: always;
            }

            .player-link {
                cursor: default;
                text-decoration: none !important;
            }

            .player-link:hover {
                filter: none;
            }
        }

        /* Print button */
        .print-btn {
            background: var(--bg-card);
            border: 2px solid var(--yellow);
            border-radius: 8px;
            padding: 8px 14px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--yellow);
            cursor: pointer;
            margin-left: auto;
        }
        .print-btn:hover {
            background: var(--yellow);
            color: var(--bg-dark);
        }

        @media print {
            .print-btn { display: none; }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <button class="back-btn" onclick="goBack()">‚Üê BACK</button>
        <img src="/images/gold_logo.png" alt="BRDC" class="header-logo">
        <span class="header-title">MATCH REPORT</span>
        <button class="print-btn" onclick="window.print()">PRINT / SHARE</button>
    </div>

    <div class="container">
        <!-- Match Summary Header -->
        <div class="match-summary" id="matchSummary">
            <div class="match-header-bar">
                <h1 class="match-title" id="matchTitle">Loading...</h1>
                <div class="match-meta" id="matchMeta"></div>
            </div>
            <!-- Compact Score Row -->
            <div class="score-row">
                <span class="team-name-compact home" id="homeTeamName">Home</span>
                <div class="score-box-report">
                    <span class="score-num-report home" id="homeScore">0</span>
                    <span class="score-dash-report">-</span>
                    <span class="score-num-report away" id="awayScore">0</span>
                </div>
                <span class="team-name-compact away" id="awayTeamName">Away</span>
            </div>
        </div>

        <!-- Report Navigation Tabs - Scrollable on mobile -->
        <div class="report-nav" style="overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px;">
            <button class="nav-btn active" data-tab="summary" onclick="showTab('summary')">SUMMARY</button>
            <button class="nav-btn" data-tab="players" onclick="showTab('players')">PLAYERS</button>
            <button class="nav-btn" data-tab="games" onclick="showTab('games')">SETS</button>
            <button class="nav-btn" data-tab="h2h" onclick="showTab('h2h')">H2H</button>
            <button class="nav-btn" data-tab="counts" onclick="showTab('counts')">COUNTS</button>
        </div>

        <!-- Player Filter -->
        <div class="player-filter" id="playerFilter">
            <div class="filter-label">FILTER BY PLAYER</div>
            <div class="filter-chips" id="filterChips">
                <div class="filter-chip active" data-player="all" onclick="filterByPlayer('all')">All Players</div>
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tabContent">
            <!-- Summary Tab -->
            <div id="tab-summary" class="tab-panel">
                <div class="player-cards" id="playerCards"></div>
                <div class="games-section">
                    <div class="section-title">MATCH RESULTS</div>
                    <div id="gamesSummary"></div>
                </div>
            </div>

            <!-- Player Stats Tab -->
            <div id="tab-players" class="tab-panel" style="display:none;">
                <div class="player-cards" id="detailedPlayerCards"></div>
            </div>

            <!-- Game Detail Tab -->
            <div id="tab-games" class="tab-panel" style="display:none;">
                <div id="gamesDetail"></div>
            </div>

            <!-- Head to Head Tab -->
            <div id="tab-h2h" class="tab-panel" style="display:none;">
                <div class="h2h-section">
                    <div class="h2h-header">
                        <div class="section-title" style="margin:0;">HEAD TO HEAD</div>
                        <div class="h2h-selectors">
                            <select class="h2h-selector" id="h2hPlayer1" onchange="updateH2H()"></select>
                            <span class="h2h-vs">VS</span>
                            <select class="h2h-selector" id="h2hPlayer2" onchange="updateH2H()"></select>
                        </div>
                    </div>
                    <div id="h2hContent"></div>
                </div>
            </div>

            <!-- Match Counts Tab -->
            <div id="tab-counts" class="tab-panel" style="display:none;">
                <div class="counts-grid" id="countsGrid"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, doc, getDoc, callFunction } from '/js/firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        const leagueId = urlParams.get('league_id');
        const matchId = urlParams.get('match_id');
        const matchPin = urlParams.get('pin');

        let matchData = null;
        let homeTeam = null;
        let awayTeam = null;
        let allPlayers = [];
        let selectedPlayer = 'all';
        let playerStats = {};

        async function loadMatch() {
            try {
                if (matchPin) {
                    const result = await callFunction('getMatchByPin', { pin: matchPin });
                    if (!result.success) throw new Error(result.error);
                    matchData = result.match;
                    // Normalize team name fields
                    if (result.home_team) {
                        homeTeam = { ...result.home_team, name: result.home_team.name || result.home_team.team_name };
                    } else {
                        homeTeam = { name: matchData.home_team_name };
                    }
                    if (result.away_team) {
                        awayTeam = { ...result.away_team, name: result.away_team.name || result.away_team.team_name };
                    } else {
                        awayTeam = { name: matchData.away_team_name };
                    }
                } else if (leagueId && matchId) {
                    const matchDoc = await getDoc(doc(db, 'leagues', leagueId, 'matches', matchId));
                    if (!matchDoc.exists()) throw new Error('Match not found');
                    matchData = { id: matchId, ...matchDoc.data() };

                    // Try to load teams - check both 'name' and 'team_name' per CLAUDE.md
                    if (matchData.home_team_id) {
                        const homeDoc = await getDoc(doc(db, 'leagues', leagueId, 'teams', matchData.home_team_id));
                        if (homeDoc.exists()) {
                            const data = homeDoc.data();
                            homeTeam = { ...data, name: data.name || data.team_name };
                        } else {
                            homeTeam = { name: matchData.home_team_name };
                        }
                    }
                    if (matchData.away_team_id) {
                        const awayDoc = await getDoc(doc(db, 'leagues', leagueId, 'teams', matchData.away_team_id));
                        if (awayDoc.exists()) {
                            const data = awayDoc.data();
                            awayTeam = { ...data, name: data.name || data.team_name };
                        } else {
                            awayTeam = { name: matchData.away_team_name };
                        }
                    }
                } else {
                    throw new Error('No match identifier provided');
                }

                // Build player list
                buildPlayerList();
                // Calculate all player stats
                calculatePlayerStats();
                // Render everything
                renderMatchSummary();
                renderPlayerFilter();
                renderPlayerCards();
                renderGamesSummary();
                renderH2HSelectors();
                renderMatchCounts();

            } catch (error) {
                console.error('Error loading match:', error);
                document.getElementById('matchTitle').textContent = 'Error: ' + error.message;
            }
        }

        function buildPlayerList() {
            const games = matchData.games || [];
            const playerSet = new Set();

            games.forEach(game => {
                (game.home_players || []).forEach(p => {
                    if (p && p.name) playerSet.add(JSON.stringify({ name: p.name, side: 'home' }));
                });
                (game.away_players || []).forEach(p => {
                    if (p && p.name) playerSet.add(JSON.stringify({ name: p.name, side: 'away' }));
                });
            });

            allPlayers = Array.from(playerSet).map(s => JSON.parse(s));
        }

        function calculatePlayerStats() {
            playerStats = {};
            const games = matchData.games || [];

            allPlayers.forEach(p => {
                playerStats[p.name] = {
                    name: p.name,
                    side: p.side,
                    // Overall
                    games_played: 0,
                    games_won: 0,
                    legs_played: 0,
                    legs_won: 0,
                    // X01
                    x01_legs: 0,
                    x01_legs_won: 0,
                    x01_total_points: 0,
                    x01_total_darts: 0,
                    x01_first9_points: 0,
                    x01_first9_darts: 0,
                    x01_checkouts: 0,
                    x01_checkout_opps: 0,
                    x01_high_checkout: 0,
                    x01_high_turn: 0,
                    x01_tons: 0,
                    x01_ton40: 0,
                    x01_ton80: 0,
                    // Cricket
                    cricket_legs: 0,
                    cricket_legs_won: 0,
                    cricket_marks: 0,
                    cricket_rounds: 0,
                    cricket_5m_plus: 0,
                    cricket_high_marks: 0,
                    // Leg details for H2H
                    leg_results: []
                };
            });

            games.forEach((game, gameIdx) => {
                const format = game.format || '501';
                const isX01 = ['501', '301', '701'].includes(format) || /^\d+$/.test(format);
                const isCricket = format.toLowerCase().includes('cricket');
                const gameWinner = game.winner;

                const homePlayers = game.home_players || [];
                const awayPlayers = game.away_players || [];

                // Track game participation
                [...homePlayers, ...awayPlayers].forEach(p => {
                    if (p && p.name && playerStats[p.name]) {
                        playerStats[p.name].games_played++;
                        const isHome = homePlayers.some(hp => hp.name === p.name);
                        if ((gameWinner === 'home' && isHome) || (gameWinner === 'away' && !isHome)) {
                            playerStats[p.name].games_won++;
                        }
                    }
                });

                // Process each leg
                (game.legs || []).forEach((leg, legIdx) => {
                    const legWinner = leg.winner;
                    const throws = leg.throws || [];
                    const legFormat = leg.format || format;
                    const legIsX01 = ['501', '301', '701'].includes(legFormat) || /^\d+$/.test(legFormat);
                    const legIsCricket = legFormat.toLowerCase().includes('cricket');

                    // Track per-player stats from throws
                    const legPlayerStats = {};

                    throws.forEach((t, roundIdx) => {
                        ['home', 'away'].forEach(side => {
                            const throwData = t[side];
                            if (!throwData || !throwData.player) return;

                            const name = throwData.player;
                            if (!legPlayerStats[name]) {
                                legPlayerStats[name] = {
                                    side,
                                    darts: 0,
                                    points: 0,
                                    first9_points: 0,
                                    first9_darts: 0,
                                    marks: 0,
                                    rounds: 0,
                                    high_turn: 0,
                                    tons: 0,
                                    ton40: 0,
                                    ton80: 0,
                                    marks_per_round: []
                                };
                            }

                            const pStats = legPlayerStats[name];
                            pStats.darts += 3;
                            pStats.rounds++;

                            if (legIsX01) {
                                const score = throwData.score || 0;
                                pStats.points += score;

                                // First 9 (first 3 rounds = 9 darts)
                                if (pStats.rounds <= 3) {
                                    pStats.first9_points += score;
                                    pStats.first9_darts += 3;
                                }

                                // High turn tracking
                                if (score > pStats.high_turn) pStats.high_turn = score;
                                if (score >= 100) pStats.tons++;
                                if (score >= 140) pStats.ton40++;
                                if (score === 180) pStats.ton80++;
                            }

                            if (legIsCricket) {
                                const marks = countMarks(throwData.hit);
                                pStats.marks += marks;
                                pStats.marks_per_round.push(marks);
                            }
                        });
                    });

                    // Update player cumulative stats
                    for (const [name, stats] of Object.entries(legPlayerStats)) {
                        if (!playerStats[name]) continue;
                        const ps = playerStats[name];
                        const isWinner = stats.side === legWinner;

                        ps.legs_played++;
                        if (isWinner) ps.legs_won++;

                        if (legIsX01) {
                            ps.x01_legs++;
                            if (isWinner) ps.x01_legs_won++;
                            ps.x01_total_points += stats.points;
                            ps.x01_total_darts += stats.darts;
                            ps.x01_first9_points += stats.first9_points;
                            ps.x01_first9_darts += stats.first9_darts;
                            ps.x01_tons += stats.tons;
                            ps.x01_ton40 += stats.ton40;
                            ps.x01_ton80 += stats.ton80;
                            if (stats.high_turn > ps.x01_high_turn) ps.x01_high_turn = stats.high_turn;

                            // Checkout tracking
                            if (isWinner && leg.checkout) {
                                ps.x01_checkouts++;
                                const co = leg.checkout.out || 0;
                                if (co > ps.x01_high_checkout) ps.x01_high_checkout = co;
                            }
                            // Checkout opportunities (simplified: count if player got below 170)
                            if (stats.points > 0) {
                                const startScore = parseInt(legFormat) || 501;
                                // This is simplified - real COO tracking needs turn-by-turn remaining
                            }
                        }

                        if (legIsCricket) {
                            ps.cricket_legs++;
                            if (isWinner) ps.cricket_legs_won++;
                            ps.cricket_marks += stats.marks;
                            ps.cricket_rounds += stats.rounds;
                            // 5+ mark rounds
                            const fivePlus = stats.marks_per_round.filter(m => m >= 5).length;
                            ps.cricket_5m_plus += fivePlus;
                            const maxMarks = Math.max(0, ...stats.marks_per_round);
                            if (maxMarks > ps.cricket_high_marks) ps.cricket_high_marks = maxMarks;
                        }

                        // Store leg result for H2H
                        ps.leg_results.push({
                            gameIdx,
                            legIdx,
                            opponent: getOpponent(name, game),
                            won: isWinner,
                            format: legFormat
                        });
                    }
                });
            });
        }

        function getOpponent(playerName, game) {
            const homePlayers = (game.home_players || []).map(p => p.name);
            const awayPlayers = (game.away_players || []).map(p => p.name);

            if (homePlayers.includes(playerName)) {
                return awayPlayers;
            }
            return homePlayers;
        }

        function countMarks(hit) {
            if (!hit) return 0;
            let marks = 0;
            const parts = hit.split(',').map(p => p.trim());
            for (const part of parts) {
                // Handle multipliers like "S20x2"
                const match = part.match(/([TDStds]?)(\d+|B|Bull)(x(\d+))?/i);
                if (match) {
                    const prefix = match[1].toUpperCase();
                    const mult = parseInt(match[4]) || 1;

                    if (prefix === 'T') marks += 3 * mult;
                    else if (prefix === 'D') marks += 2 * mult;
                    else if (prefix === 'S' || prefix === '') marks += 1 * mult;
                }
                // Bulls
                if (part.includes('DB') || part.includes('Double')) marks += 2;
                else if (part.includes('SB') || part.includes('Single')) marks += 1;
            }
            return marks;
        }

        function renderMatchSummary() {
            const homeName = homeTeam?.name || homeTeam?.team_name || 'Home';
            const awayName = awayTeam?.name || awayTeam?.team_name || 'Away';

            document.getElementById('matchTitle').textContent = `${homeName} vs ${awayName}`;

            const games = matchData.games || [];
            const totalLegs = games.reduce((sum, g) => sum + (g.legs?.length || 0), 0);
            const totalDarts = matchData.total_darts || 0;
            const duration = matchData.match_length || '-';

            // Format date properly
            let dateStr = '-';
            if (matchData.match_date) {
                const date = matchData.match_date.toDate ? matchData.match_date.toDate() : new Date(matchData.match_date);
                dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } else if (matchData.date) {
                dateStr = matchData.date;
            }

            document.getElementById('matchMeta').innerHTML = `
                <span>Week ${matchData.week || '-'}</span>
                <span>${dateStr}</span>
                <span>Sets: ${games.length}</span>
                <span>Legs: ${totalLegs}</span>
                <span>Darts: ${totalDarts.toLocaleString()}</span>
                <span>Duration: ${duration}</span>
            `;

            document.getElementById('homeTeamName').textContent = homeName;
            document.getElementById('awayTeamName').textContent = awayName;
            document.getElementById('homeScore').textContent = matchData.home_score || 0;
            document.getElementById('awayScore').textContent = matchData.away_score || 0;
        }

        function renderPlayerFilter() {
            const container = document.getElementById('filterChips');
            let html = '<div class="filter-chip active" data-player="all" onclick="filterByPlayer(\'all\')">All Players</div>';

            allPlayers.forEach(p => {
                const sideClass = p.side;
                html += `<div class="filter-chip ${sideClass}" data-player="${p.name}" onclick="filterByPlayer('${p.name}')">${p.name}</div>`;
            });

            container.innerHTML = html;
        }

        window.filterByPlayer = function(player) {
            selectedPlayer = player;
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.player === player);
            });
            renderGamesSummary();
        };

        function renderPlayerCards() {
            const container = document.getElementById('playerCards');
            let html = '';

            allPlayers.forEach(p => {
                const stats = playerStats[p.name];
                if (!stats) return;

                const winPct = stats.games_played > 0 ?
                    Math.round((stats.games_won / stats.games_played) * 100) : 0;
                const x01Avg = stats.x01_total_darts > 0 ?
                    (stats.x01_total_points / stats.x01_total_darts * 3).toFixed(2) : '-';
                const first9Avg = stats.x01_first9_darts > 0 ?
                    (stats.x01_first9_points / stats.x01_first9_darts * 3).toFixed(2) : '-';
                const mpr = stats.cricket_rounds > 0 ?
                    (stats.cricket_marks / stats.cricket_rounds).toFixed(2) : '-';
                const ppd = stats.x01_total_darts > 0 ?
                    (stats.x01_total_points / stats.x01_total_darts).toFixed(2) : '-';
                const escapedName = p.name.replace(/'/g, "\\'");

                html += `
                    <div class="player-card ${stats.side}">
                        <div class="player-card-header">
                            <div class="player-name player-link" onclick="viewPlayer('${escapedName}')">${p.name}</div>
                            <div class="player-record">
                                <span class="wins">${stats.games_won}W</span> -
                                <span class="losses">${stats.games_played - stats.games_won}L</span>
                                (${winPct}%)
                            </div>
                        </div>
                        <div class="player-stats-grid">
                            <div class="stat-cell">
                                <div class="stat-label">501 Avg</div>
                                <div class="stat-value ${parseFloat(x01Avg) >= 60 ? 'highlight' : ''}">${x01Avg}</div>
                            </div>
                            <div class="stat-cell">
                                <div class="stat-label">First 9</div>
                                <div class="stat-value ${parseFloat(first9Avg) >= 70 ? 'highlight' : ''}">${first9Avg}</div>
                            </div>
                            <div class="stat-cell">
                                <div class="stat-label">Cricket MPR</div>
                                <div class="stat-value ${parseFloat(mpr) >= 3 ? 'highlight' : ''}">${mpr}</div>
                            </div>
                            <div class="stat-cell">
                                <div class="stat-label">PPD</div>
                                <div class="stat-value">${ppd}</div>
                            </div>
                            <div class="stat-cell">
                                <div class="stat-label">High Out</div>
                                <div class="stat-value ${stats.x01_high_checkout >= 100 ? 'highlight' : ''}">${stats.x01_high_checkout || '-'}</div>
                            </div>
                            <div class="stat-cell">
                                <div class="stat-label">High Turn</div>
                                <div class="stat-value ${stats.x01_high_turn >= 140 ? 'highlight' : ''}">${stats.x01_high_turn || '-'}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Also populate detailed cards
            document.getElementById('detailedPlayerCards').innerHTML = renderDetailedPlayerCards();
        }

        function renderDetailedPlayerCards() {
            let html = '';
            allPlayers.forEach(p => {
                const stats = playerStats[p.name];
                if (!stats) return;

                const x01Avg = stats.x01_total_darts > 0 ?
                    (stats.x01_total_points / stats.x01_total_darts * 3).toFixed(2) : '-';
                const first9Avg = stats.x01_first9_darts > 0 ?
                    (stats.x01_first9_points / stats.x01_first9_darts * 3).toFixed(2) : '-';
                const mpr = stats.cricket_rounds > 0 ?
                    (stats.cricket_marks / stats.cricket_rounds).toFixed(2) : '-';
                const coEff = stats.x01_legs > 0 ?
                    Math.round((stats.x01_checkouts / stats.x01_legs) * 100) : 0;
                const escapedName = p.name.replace(/'/g, "\\'");

                html += `
                    <div class="player-card ${stats.side}">
                        <div class="player-card-header">
                            <div class="player-name player-link" onclick="viewPlayer('${escapedName}')">${p.name}</div>
                            <div class="player-record">
                                Sets: ${stats.games_won}/${stats.games_played} |
                                Legs: ${stats.legs_won}/${stats.legs_played}
                            </div>
                        </div>
                        <div style="padding: 15px;">
                            <div style="margin-bottom: 15px;">
                                <div style="font-family: 'Bebas Neue', cursive; color: var(--yellow); margin-bottom: 8px;">501 STATS</div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 12px;">
                                    <div><span style="color: var(--text-dim);">3DA:</span> <b>${x01Avg}</b></div>
                                    <div><span style="color: var(--text-dim);">First 9:</span> <b>${first9Avg}</b></div>
                                    <div><span style="color: var(--text-dim);">Legs:</span> ${stats.x01_legs_won}/${stats.x01_legs}</div>
                                    <div><span style="color: var(--text-dim);">CO%:</span> ${coEff}%</div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 12px; margin-top: 8px;">
                                    <div><span style="color: var(--text-dim);">100+:</span> ${stats.x01_tons}</div>
                                    <div><span style="color: var(--text-dim);">140+:</span> ${stats.x01_ton40}</div>
                                    <div><span style="color: var(--text-dim);">180:</span> ${stats.x01_ton80}</div>
                                    <div><span style="color: var(--text-dim);">High Out:</span> ${stats.x01_high_checkout || '-'}</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-family: 'Bebas Neue', cursive; color: var(--yellow); margin-bottom: 8px;">CRICKET STATS</div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 12px;">
                                    <div><span style="color: var(--text-dim);">MPR:</span> <b>${mpr}</b></div>
                                    <div><span style="color: var(--text-dim);">Legs:</span> ${stats.cricket_legs_won}/${stats.cricket_legs}</div>
                                    <div><span style="color: var(--text-dim);">5M+:</span> ${stats.cricket_5m_plus}</div>
                                    <div><span style="color: var(--text-dim);">High:</span> ${stats.cricket_high_marks || '-'}M</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            return html;
        }

        function renderGamesSummary() {
            const container = document.getElementById('gamesSummary');
            const games = matchData.games || [];
            let html = '';

            games.forEach((game, gameIdx) => {
                // Filter check
                if (selectedPlayer !== 'all') {
                    const gamePlayers = [...(game.home_players || []), ...(game.away_players || [])].map(p => p.name);
                    if (!gamePlayers.includes(selectedPlayer)) return;
                }

                const format = game.format || '501';
                const isCricket = format.toLowerCase().includes('cricket');
                const formatLabel = isCricket ? 'CRICKET' : `${format} ${game.in_rule === 'double' ? 'DI' : 'SI'}/${game.checkout === 'double' ? 'DO' : 'SO'}`;
                const winnerClass = game.winner === 'home' ? 'home-win' : 'away-win';
                const gameType = game.type === 'doubles' ? 'DOUBLES' : game.type === 'triples' ? 'TRIPLES' : 'SINGLES';

                html += `
                    <div class="game-card ${winnerClass}">
                        <div class="game-header">
                            <div class="game-info">
                                SET ${game.game_number || gameIdx + 1} - ${gameType}
                                <span class="game-format">${formatLabel}</span>
                            </div>
                            <div class="game-result">
                                <span class="legs-score">${game.home_legs_won || 0} - ${game.away_legs_won || 0}</span>
                                <span class="winner-badge">${game.winner === 'home' ? 'HOME' : 'AWAY'}</span>
                            </div>
                        </div>
                        ${renderLegs(game, gameIdx)}
                    </div>
                `;
            });

            container.innerHTML = html || '<div class="loading">No sets match filter</div>';

            // Also update games detail tab
            document.getElementById('gamesDetail').innerHTML = html;
        }

        function renderLegs(game, gameIdx) {
            const legs = game.legs || [];
            if (legs.length === 0) return '';

            let html = '';
            legs.forEach((leg, legIdx) => {
                const format = leg.format || game.format || '501';
                const isCricket = format.toLowerCase().includes('cricket');
                const formatLabel = isCricket ? 'Cricket' : format;
                const legWinner = leg.winner;

                const homeStats = leg.home_stats || {};
                const awayStats = leg.away_stats || {};

                // Use canonical field names with legacy fallbacks
                const homeMpr = homeStats.cricket_mpr || homeStats.mpr;
                const homeTda = homeStats.x01_three_dart_avg || homeStats.three_dart_avg;
                const awayMpr = awayStats.cricket_mpr || awayStats.mpr;
                const awayTda = awayStats.x01_three_dart_avg || awayStats.three_dart_avg;

                const homeAvg = isCricket ?
                    (homeMpr?.toFixed?.(2) || homeMpr || '-') + ' MPR' :
                    (homeTda?.toFixed?.(2) || homeTda || '-') + ' 3DA';
                const awayAvg = isCricket ?
                    (awayMpr?.toFixed?.(2) || awayMpr || '-') + ' MPR' :
                    (awayTda?.toFixed?.(2) || awayTda || '-') + ' 3DA';

                const homeBig = isCricket ? (homeMpr >= 3) : (homeTda >= 60);
                const awayBig = isCricket ? (awayMpr >= 3) : (awayTda >= 60);

                html += `
                    <div class="leg-row" onclick="toggleThrows(${gameIdx}, ${legIdx})">
                        <div class="leg-summary">
                            <div class="leg-home">
                                ${legWinner === 'home' ? '<div class="leg-winner-indicator"></div>' : ''}
                                <div class="leg-avg ${homeBig ? 'big' : ''}">${homeAvg}</div>
                            </div>
                            <div class="leg-center">
                                <div class="leg-number">LEG ${leg.leg_number || legIdx + 1}</div>
                                <div class="leg-format">${formatLabel}</div>
                            </div>
                            <div class="leg-away">
                                <div class="leg-avg ${awayBig ? 'big' : ''}">${awayAvg}</div>
                                ${legWinner === 'away' ? '<div class="leg-winner-indicator"></div>' : ''}
                            </div>
                        </div>
                        <div class="throws-detail" id="throws-${gameIdx}-${legIdx}">
                            ${renderThrowsTable(leg, game, isCricket)}
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function renderThrowsTable(leg, game, isCricket) {
            const throws = leg.throws || [];
            if (throws.length === 0) return '<div style="padding: 15px; color: var(--text-dim);">No throw data available</div>';

            const firstThrow = leg.first_throw || 'home';
            const homeStats = leg.home_stats || {};
            const awayStats = leg.away_stats || {};

            let html = `<table class="throws-table">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>${isCricket ? 'Hits' : 'Score'}</th>
                        <th>${isCricket ? 'Score' : 'Left'}</th>
                        <th>Rnd</th>
                        <th>${isCricket ? 'Score' : 'Left'}</th>
                        <th>${isCricket ? 'Hits' : 'Score'}</th>
                        <th>Player</th>
                    </tr>
                </thead>
                <tbody>`;

            throws.forEach(t => {
                const homeT = t.home || {};
                const awayT = t.away || {};
                const isFirst = t.round === 1;
                const homeFirst = firstThrow === 'home' && isFirst;
                const awayFirst = firstThrow === 'away' && isFirst;
                const homeNotable = homeT.notable || (homeT.score >= 100 && !isCricket);
                const awayNotable = awayT.notable || (awayT.score >= 100 && !isCricket);
                const homeCheckout = homeT.checkout;
                const awayCheckout = awayT.checkout;

                html += `<tr>
                    <td class="home-cell ${homeFirst ? 'first-throw' : ''}">${homeT.player || '-'}</td>
                    <td class="home-cell ${homeNotable ? 'notable' : ''} ${homeCheckout ? 'checkout' : ''}">${isCricket ? (homeT.hit || '-') : (homeT.score ?? '-')}</td>
                    <td class="home-cell">${isCricket ? (homeT.score ?? '-') : (homeT.remaining ?? '-')}</td>
                    <td class="round-num">${t.round}</td>
                    <td class="away-cell">${isCricket ? (awayT.score ?? '-') : (awayT.remaining ?? '-')}</td>
                    <td class="away-cell ${awayNotable ? 'notable' : ''} ${awayCheckout ? 'checkout' : ''}">${isCricket ? (awayT.hit || '-') : (awayT.score ?? '-')}</td>
                    <td class="away-cell ${awayFirst ? 'first-throw' : ''}">${awayT.player || '-'}</td>
                </tr>`;
            });

            html += '</tbody></table>';

            // Footer - use canonical field names with legacy fallbacks
            const footerHomeMpr = homeStats.cricket_mpr || homeStats.mpr || '-';
            const footerHomeTda = homeStats.x01_three_dart_avg || homeStats.three_dart_avg || '-';
            const footerAwayMpr = awayStats.cricket_mpr || awayStats.mpr || '-';
            const footerAwayTda = awayStats.x01_three_dart_avg || awayStats.three_dart_avg || '-';
            html += `<div class="throws-footer">
                <div class="home-summary">
                    <b>${isCricket ? footerHomeMpr + ' MPR' : footerHomeTda + ' 3DA'}</b>
                    &bull; Darts: ${homeStats.darts || '-'}
                    ${leg.checkout && leg.winner === 'home' ? '&bull; Out: ' + leg.checkout.out : ''}
                </div>
                <div class="away-summary">
                    Darts: ${awayStats.darts || '-'} &bull;
                    <b>${isCricket ? footerAwayMpr + ' MPR' : footerAwayTda + ' 3DA'}</b>
                    ${leg.checkout && leg.winner === 'away' ? '&bull; Out: ' + leg.checkout.out : ''}
                </div>
            </div>`;

            return html;
        }

        window.toggleThrows = function(gameIdx, legIdx) {
            const el = document.getElementById(`throws-${gameIdx}-${legIdx}`);
            if (el) {
                el.classList.toggle('show');
            }
        };

        function renderH2HSelectors() {
            const select1 = document.getElementById('h2hPlayer1');
            const select2 = document.getElementById('h2hPlayer2');

            let html = '';
            allPlayers.forEach(p => {
                html += `<option value="${p.name}">${p.name}</option>`;
            });

            select1.innerHTML = html;
            select2.innerHTML = html;

            // Set defaults to first home vs first away
            const homePlayers = allPlayers.filter(p => p.side === 'home');
            const awayPlayers = allPlayers.filter(p => p.side === 'away');
            if (homePlayers.length > 0) select1.value = homePlayers[0].name;
            if (awayPlayers.length > 0) select2.value = awayPlayers[0].name;

            updateH2H();
        }

        window.updateH2H = function() {
            const player1 = document.getElementById('h2hPlayer1').value;
            const player2 = document.getElementById('h2hPlayer2').value;
            const container = document.getElementById('h2hContent');

            const stats1 = playerStats[player1];
            const stats2 = playerStats[player2];

            if (!stats1 || !stats2) {
                container.innerHTML = '<div class="loading">Select two players</div>';
                return;
            }

            // Find head-to-head legs
            const h2hLegs = [];
            const games = matchData.games || [];

            games.forEach((game, gameIdx) => {
                const homePlayers = (game.home_players || []).map(p => p.name);
                const awayPlayers = (game.away_players || []).map(p => p.name);

                const p1InGame = homePlayers.includes(player1) || awayPlayers.includes(player1);
                const p2InGame = homePlayers.includes(player2) || awayPlayers.includes(player2);

                if (p1InGame && p2InGame) {
                    (game.legs || []).forEach((leg, legIdx) => {
                        h2hLegs.push({
                            game,
                            gameIdx,
                            leg,
                            legIdx,
                            p1Side: homePlayers.includes(player1) ? 'home' : 'away',
                            p2Side: homePlayers.includes(player2) ? 'home' : 'away'
                        });
                    });
                }
            });

            let p1Wins = 0, p2Wins = 0;
            h2hLegs.forEach(h => {
                if (h.leg.winner === h.p1Side) p1Wins++;
                if (h.leg.winner === h.p2Side) p2Wins++;
            });

            // Calculate H2H specific averages
            let p1TotalPoints = 0, p1TotalDarts = 0, p1Marks = 0, p1Rounds = 0;
            let p2TotalPoints = 0, p2TotalDarts = 0, p2Marks = 0, p2Rounds = 0;

            h2hLegs.forEach(h => {
                const throws = h.leg.throws || [];
                throws.forEach(t => {
                    if (t[h.p1Side]?.player === player1) {
                        p1TotalPoints += t[h.p1Side].score || 0;
                        p1TotalDarts += 3;
                        if (t[h.p1Side].hit) p1Marks += countMarks(t[h.p1Side].hit);
                        p1Rounds++;
                    }
                    if (t[h.p2Side]?.player === player2) {
                        p2TotalPoints += t[h.p2Side].score || 0;
                        p2TotalDarts += 3;
                        if (t[h.p2Side].hit) p2Marks += countMarks(t[h.p2Side].hit);
                        p2Rounds++;
                    }
                });
            });

            const p1Avg = p1TotalDarts > 0 ? (p1TotalPoints / p1TotalDarts * 3).toFixed(2) : '-';
            const p2Avg = p2TotalDarts > 0 ? (p2TotalPoints / p2TotalDarts * 3).toFixed(2) : '-';
            const p1MPR = p1Rounds > 0 ? (p1Marks / p1Rounds).toFixed(2) : '-';
            const p2MPR = p2Rounds > 0 ? (p2Marks / p2Rounds).toFixed(2) : '-';
            const escapedP1 = player1.replace(/'/g, "\\'");
            const escapedP2 = player2.replace(/'/g, "\\'");

            container.innerHTML = `
                <div class="h2h-results">
                    <div class="h2h-player player1">
                        <div class="h2h-name player-link" onclick="viewPlayer('${escapedP1}')">${player1}</div>
                        <div style="font-size: 14px; margin-top: 10px;">
                            <div>501 Avg: <b>${p1Avg}</b></div>
                            <div>Cricket MPR: <b>${p1MPR}</b></div>
                        </div>
                    </div>
                    <div class="h2h-score-block">
                        <div class="h2h-legs-score">${p1Wins} - ${p2Wins}</div>
                        <div class="h2h-label">Legs Won (${h2hLegs.length} shared legs)</div>
                    </div>
                    <div class="h2h-player player2">
                        <div class="h2h-name player-link" onclick="viewPlayer('${escapedP2}')">${player2}</div>
                        <div style="font-size: 14px; margin-top: 10px;">
                            <div>501 Avg: <b>${p2Avg}</b></div>
                            <div>Cricket MPR: <b>${p2MPR}</b></div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div style="font-family: 'Bebas Neue', cursive; color: var(--yellow); margin-bottom: 10px;">SHARED LEGS</div>
                    ${h2hLegs.map(h => {
                        const format = h.leg.format || h.game.format || '501';
                        const winner = h.leg.winner === h.p1Side ? player1 : player2;
                        return `<div style="padding: 8px; background: var(--bg-card); border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
                            Set ${h.game.game_number} Leg ${h.leg.leg_number} - ${format} - <b style="color: ${h.leg.winner === h.p1Side ? 'var(--pink)' : 'var(--teal)'}">${winner} wins</b>
                        </div>`;
                    }).join('')}
                </div>
            `;
        };

        function renderMatchCounts() {
            const container = document.getElementById('countsGrid');

            // Build counts data
            const tonCounts = [];
            const cricketCounts = [];
            const checkoutCounts = [];

            allPlayers.forEach(p => {
                const stats = playerStats[p.name];
                if (!stats) return;

                tonCounts.push({
                    name: p.name,
                    side: stats.side,
                    tons: stats.x01_tons,
                    ton40: stats.x01_ton40,
                    ton80: stats.x01_ton80,
                    high: stats.x01_high_turn
                });

                cricketCounts.push({
                    name: p.name,
                    side: stats.side,
                    mpr: stats.cricket_rounds > 0 ? (stats.cricket_marks / stats.cricket_rounds).toFixed(2) : '-',
                    fivePlus: stats.cricket_5m_plus,
                    high: stats.cricket_high_marks
                });

                checkoutCounts.push({
                    name: p.name,
                    side: stats.side,
                    checkouts: stats.x01_checkouts,
                    legs: stats.x01_legs,
                    high: stats.x01_high_checkout,
                    first9: stats.x01_first9_darts > 0 ? (stats.x01_first9_points / stats.x01_first9_darts * 3).toFixed(2) : '-'
                });
            });

            // Sort by relevant stat
            tonCounts.sort((a, b) => b.tons - a.tons);
            cricketCounts.sort((a, b) => parseFloat(b.mpr) - parseFloat(a.mpr));
            checkoutCounts.sort((a, b) => b.checkouts - a.checkouts);

            container.innerHTML = `
                <div class="counts-card">
                    <div class="counts-header">501 TON COUNTS</div>
                    <table class="counts-table">
                        <thead>
                            <tr><th>Player</th><th>100+</th><th>140+</th><th>180</th><th>High</th></tr>
                        </thead>
                        <tbody>
                            ${tonCounts.map(p => {
                                const escaped = p.name.replace(/'/g, "\\'");
                                return `
                                <tr>
                                    <td class="player-name ${p.side}-player player-link" onclick="viewPlayer('${escaped}')">${p.name}</td>
                                    <td>${p.tons}</td>
                                    <td>${p.ton40}</td>
                                    <td class="${p.ton80 > 0 ? 'highlight' : ''}">${p.ton80}</td>
                                    <td class="${p.high >= 140 ? 'highlight' : ''}">${p.high}</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="counts-card">
                    <div class="counts-header">CHECKOUT PERFORMANCE</div>
                    <table class="counts-table">
                        <thead>
                            <tr><th>Player</th><th>First 9</th><th>Checkouts</th><th>CO%</th><th>High Out</th></tr>
                        </thead>
                        <tbody>
                            ${checkoutCounts.map(p => {
                                const coPct = p.legs > 0 ? Math.round((p.checkouts / p.legs) * 100) : 0;
                                const escaped = p.name.replace(/'/g, "\\'");
                                return `
                                <tr>
                                    <td class="player-name ${p.side}-player player-link" onclick="viewPlayer('${escaped}')">${p.name}</td>
                                    <td>${p.first9}</td>
                                    <td>${p.checkouts}/${p.legs}</td>
                                    <td>${coPct}%</td>
                                    <td class="${p.high >= 100 ? 'highlight' : ''}">${p.high || '-'}</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>

                <div class="counts-card">
                    <div class="counts-header">CRICKET COUNTS</div>
                    <table class="counts-table">
                        <thead>
                            <tr><th>Player</th><th>MPR</th><th>5M+ Rnds</th><th>High Marks</th></tr>
                        </thead>
                        <tbody>
                            ${cricketCounts.map(p => {
                                const escaped = p.name.replace(/'/g, "\\'");
                                return `
                                <tr>
                                    <td class="player-name ${p.side}-player player-link" onclick="viewPlayer('${escaped}')">${p.name}</td>
                                    <td class="${parseFloat(p.mpr) >= 3 ? 'highlight' : ''}">${p.mpr}</td>
                                    <td>${p.fivePlus}</td>
                                    <td>${p.high || '-'}M</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        window.showTab = function(tab) {
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            // Show/hide panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            const targetPanel = document.getElementById(`tab-${tab}`);
            if (targetPanel) targetPanel.style.display = 'block';

            // Refresh content if needed
            if (tab === 'games') {
                renderGamesSummary();
            }
        };

        window.goBack = function() {
            if (leagueId) {
                window.location.href = `/pages/league-view.html?league_id=${leagueId}`;
            } else {
                window.history.back();
            }
        };

        window.viewPlayer = function(playerName) {
            const encodedName = encodeURIComponent(playerName);
            window.location.href = `/pages/player-profile.html?name=${encodedName}&league_id=${leagueId}`;
        };

        // Initialize
        loadMatch();
    </script>
<script src="/js/feedback.js"></script>
<script src="/js/nav-menu.js"></script>
</body>
</html>
