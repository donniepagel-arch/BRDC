<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Stats - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="stylesheet" href="/css/brdc-styles.css">
    <style>
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .player-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .player-header {
            background: linear-gradient(135deg, rgba(255,70,154,0.2), rgba(145,215,235,0.2));
            border: 4px solid var(--black);
            padding: 30px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 25px;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.5);
        }

        .player-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid var(--yellow);
            background: linear-gradient(135deg, #1F85AF, #001F4D);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-family: 'Bebas Neue', cursive;
            color: white;
            flex-shrink: 0;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .player-info h1 {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--yellow);
            margin: 0 0 5px;
        }

        .player-team {
            font-size: 18px;
            color: var(--teal);
            margin-bottom: 10px;
        }

        .player-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .badge-captain { background: var(--yellow); color: black; }
        .badge-level { background: var(--teal); color: black; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(0,0,0,0.4);
            border: 3px solid var(--black);
            padding: 20px;
            text-align: center;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
        }

        .stat-card h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--teal);
            margin: 0 0 10px;
        }

        .stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--yellow);
        }

        .stat-label {
            font-size: 11px;
            color: #888;
        }

        .section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--yellow);
            margin: 25px 0 15px;
            border-bottom: 3px solid var(--pink);
            padding-bottom: 8px;
        }

        .match-item {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .match-info h4 {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: white;
            margin: 0 0 5px;
        }

        .match-info p {
            font-size: 12px;
            color: #aaa;
            margin: 0;
        }

        .match-result {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
        }

        .match-result.win { color: #22c55e; }
        .match-result.loss { color: #ef4444; }

        .detailed-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stat-table {
            background: rgba(0,0,0,0.3);
            border: 3px solid var(--black);
            padding: 15px;
        }

        .stat-table h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--teal);
            margin: 0 0 15px;
            text-align: center;
        }

        .stat-table table {
            width: 100%;
            font-size: 13px;
        }

        .stat-table td {
            padding: 6px 0;
        }

        .stat-table td:last-child {
            text-align: right;
            color: var(--yellow);
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #aaa;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            .player-header { flex-direction: column; text-align: center; }
            .detailed-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <button class="back-btn" onclick="goBack()">< BACK</button>
        <img src="/images/white_logo.jpg" alt="BRDC" class="header-logo">
        <span class="header-title">PLAYER STATS</span>
    </div>

    <div class="player-container" id="mainContent">
        <div class="empty-state">
            <div class="empty-state-icon">...</div>
            Loading player...
        </div>
    </div>

    <script type="module">
        import { callFunction, db } from '/js/firebase-config.js';
        import { doc, getDoc, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const urlParams = new URLSearchParams(window.location.search);
        const playerId = urlParams.get('player_id');
        const leagueId = urlParams.get('league_id');

        let playerData = null;
        let teamData = null;
        let leagueData = null;
        let stats = null;
        let recentMatches = [];

        window.goBack = function() {
            history.back();
        };

        async function loadData() {
            if (!playerId) {
                document.getElementById('mainContent').innerHTML = '<div class="empty-state"><div class="empty-state-icon">!</div>Missing player ID</div>';
                return;
            }

            try {
                // Try to get player from global players collection first
                let playerDoc = await getDoc(doc(db, 'players', playerId));

                if (playerDoc.exists()) {
                    playerData = { id: playerId, ...playerDoc.data() };
                } else if (leagueId) {
                    // Try to find in league registrations
                    const regDoc = await getDoc(doc(db, 'leagues', leagueId, 'registrations', playerId));
                    if (regDoc.exists()) {
                        playerData = { id: playerId, ...regDoc.data() };
                    }
                }

                if (!playerData) {
                    // Last resort: search teams for this player
                    if (leagueId) {
                        const teamsSnap = await getDocs(collection(db, 'leagues', leagueId, 'teams'));
                        for (const teamDoc of teamsSnap.docs) {
                            const team = teamDoc.data();
                            const playerIndex = team.player_ids?.indexOf(playerId);
                            if (playerIndex > -1) {
                                playerData = {
                                    id: playerId,
                                    name: team.player_names?.[playerIndex] || 'Unknown',
                                    is_captain: team.captain_id === playerId,
                                    level: team.player_levels?.[playerIndex] || null
                                };
                                teamData = { id: teamDoc.id, ...team };
                                break;
                            }
                        }
                    }
                }

                if (!playerData) {
                    throw new Error('Player not found');
                }

                // Load league data if we have a league ID
                if (leagueId) {
                    const leagueDoc = await getDoc(doc(db, 'leagues', leagueId));
                    if (leagueDoc.exists()) {
                        leagueData = leagueDoc.data();
                    }

                    // Find team if not already found
                    if (!teamData) {
                        const teamsSnap = await getDocs(collection(db, 'leagues', leagueId, 'teams'));
                        for (const td of teamsSnap.docs) {
                            const team = td.data();
                            if (team.player_ids?.includes(playerId)) {
                                teamData = { id: td.id, ...team };
                                break;
                            }
                        }
                    }

                    // Load stats
                    try {
                        const statsResult = await callFunction('getPlayerStats', {
                            league_id: leagueId,
                            player_id: playerId
                        });
                        if (statsResult.success) {
                            stats = statsResult.stats;
                        }
                    } catch (e) {
                        // Stats not available
                    }

                    // Load recent matches
                    const matchesSnap = await getDocs(collection(db, 'leagues', leagueId, 'matches'));
                    recentMatches = matchesSnap.docs
                        .map(d => ({ id: d.id, ...d.data() }))
                        .filter(m => {
                            if (m.status !== 'completed') return false;
                            // Check if player was in this match
                            return m.games?.some(g =>
                                g.home_player_id === playerId || g.away_player_id === playerId
                            );
                        })
                        .slice(0, 10);
                }

                renderPage();

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('mainContent').innerHTML = `<div class="empty-state"><div class="empty-state-icon">!</div>${error.message}</div>`;
            }
        }

        function renderPage() {
            const initial = (playerData.name || 'U').charAt(0).toUpperCase();
            const s = stats || {};

            // Calculate summary stats
            const avg501 = s.x01_total_darts > 0 ? (s.x01_total_points / s.x01_total_darts * 3).toFixed(1) : '-';
            const mpr = s.cricket_total_rounds > 0 ? (s.cricket_total_marks / s.cricket_total_rounds).toFixed(2) : '-';

            const html = `
                <div class="player-header">
                    <div class="player-avatar">
                        ${playerData.photo_url ? `<img src="${playerData.photo_url}" alt="">` : initial}
                    </div>
                    <div class="player-info">
                        <h1>${playerData.name || playerData.full_name || 'Unknown Player'}</h1>
                        <div class="player-team">${teamData?.team_name || 'No Team'}</div>
                        <div class="player-badges">
                            ${playerData.is_captain ? '<span class="badge badge-captain">Captain</span>' : ''}
                            ${playerData.level || playerData.skill_level ? `<span class="badge badge-level">${playerData.level || playerData.skill_level}</span>` : ''}
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>501 Average</h3>
                        <div class="stat-value">${avg501}</div>
                        <div class="stat-label">3-Dart Avg</div>
                    </div>
                    <div class="stat-card">
                        <h3>Cricket MPR</h3>
                        <div class="stat-value">${mpr}</div>
                        <div class="stat-label">Marks/Round</div>
                    </div>
                    <div class="stat-card">
                        <h3>180s</h3>
                        <div class="stat-value">${s.x01_ton_eighties || 0}</div>
                        <div class="stat-label">Perfect Rounds</div>
                    </div>
                    <div class="stat-card">
                        <h3>High Checkout</h3>
                        <div class="stat-value">${s.x01_high_checkout || '-'}</div>
                        <div class="stat-label">Best Finish</div>
                    </div>
                </div>

                <div class="section-title">DETAILED STATISTICS</div>
                <div class="detailed-stats">
                    <div class="stat-table">
                        <h3>501 Stats</h3>
                        <table>
                            <tr><td>Legs Played</td><td>${s.x01_legs_played || 0}</td></tr>
                            <tr><td>Legs Won</td><td>${s.x01_legs_won || 0}</td></tr>
                            <tr><td>Win %</td><td>${s.x01_legs_played > 0 ? ((s.x01_legs_won / s.x01_legs_played) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>100+</td><td>${s.x01_tons || 0}</td></tr>
                            <tr><td>140+</td><td>${s.x01_ton_forties || 0}</td></tr>
                            <tr><td>180s</td><td>${s.x01_ton_eighties || 0}</td></tr>
                            <tr><td>171s</td><td>${s.x01_one_seventy_ones || 0}</td></tr>
                            <tr><td>100+ Checkouts</td><td>${s.x01_ton_plus_checkouts || 0}</td></tr>
                        </table>
                    </div>
                    <div class="stat-table">
                        <h3>Cricket Stats</h3>
                        <table>
                            <tr><td>Legs Played</td><td>${s.cricket_legs_played || 0}</td></tr>
                            <tr><td>Legs Won</td><td>${s.cricket_legs_won || 0}</td></tr>
                            <tr><td>Win %</td><td>${s.cricket_legs_played > 0 ? ((s.cricket_legs_won / s.cricket_legs_played) * 100).toFixed(1) : 0}%</td></tr>
                            <tr><td>Total Marks</td><td>${s.cricket_total_marks || 0}</td></tr>
                            <tr><td>Total Rounds</td><td>${s.cricket_total_rounds || 0}</td></tr>
                            <tr><td>9-Mark Rounds</td><td>${s.cricket_nine_mark_rounds || 0}</td></tr>
                            <tr><td>8-Mark Rounds</td><td>${s.cricket_eight_mark_rounds || 0}</td></tr>
                        </table>
                    </div>
                </div>

                ${recentMatches.length > 0 ? `
                    <div class="section-title">RECENT MATCHES</div>
                    ${recentMatches.map(m => renderMatchItem(m)).join('')}
                ` : ''}
            `;

            document.getElementById('mainContent').innerHTML = html;
        }

        function renderMatchItem(match) {
            // Find player's games in this match
            const playerGames = match.games?.filter(g =>
                g.home_player_id === playerId || g.away_player_id === playerId
            ) || [];

            let wins = 0, losses = 0;
            playerGames.forEach(g => {
                const isHome = g.home_player_id === playerId;
                const playerLegs = isHome ? g.home_legs : g.away_legs;
                const oppLegs = isHome ? g.away_legs : g.home_legs;
                if (playerLegs > oppLegs) wins++;
                else if (oppLegs > playerLegs) losses++;
            });

            const opponent = match.home_team_name + ' vs ' + match.away_team_name;

            return `
                <div class="match-item">
                    <div class="match-info">
                        <h4>Week ${match.week || '?'}</h4>
                        <p>${opponent}</p>
                    </div>
                    <div class="match-result ${wins >= losses ? 'win' : 'loss'}">${wins}W - ${losses}L</div>
                </div>
            `;
        }

        loadData();
    </script>
</body>
</html>
