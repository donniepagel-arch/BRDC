<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - BRDC</title>

    <!-- Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com">
    <link rel="preconnect" href="https://us-central1-brdc-35f92.cloudfunctions.net">

    <!-- DNS prefetch for additional domains -->
    <link rel="dns-prefetch" href="https://www.gstatic.com">

    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FF469A">

    <!-- Fonts - non-blocking with display=swap -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/brdc-styles.css">
    <link rel="stylesheet" href="/css/fb-mobile.css">
    <style>

        :root {
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --text-light: #f0f0f0;
            --text-dim: #8a8aa3;
            --border-color: rgba(255,255,255,0.15);
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { min-height: 100%; overflow-x: hidden; width: 100%; }
        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            color: var(--text-light);
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* ===== LOGIN PAGE STYLES ===== */
        .login-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
        }

        .login-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--pink);
            letter-spacing: 3px;
            margin-bottom: 30px;
        }

        .login-box {
            background: var(--bg-panel);
            border: 3px solid #000;
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: min(380px, 95vw);
            box-shadow: 8px 8px 0 rgba(0,0,0,0.4);
        }

        .login-form-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--teal);
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group { margin-bottom: 16px; }

        .form-label {
            display: block;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 24px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--yellow);
            text-align: center;
            letter-spacing: 4px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--pink);
            background: rgba(255,70,154,0.1);
            box-shadow: 0 0 20px rgba(255,70,154,0.3);
        }

        .form-input::placeholder {
            color: rgba(253, 216, 53, 0.4);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(180deg, var(--pink) 0%, #d63384 100%);
            border: 3px solid #000;
            border-radius: 10px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
        }

        .login-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--danger);
            border-radius: 8px;
            padding: 12px;
            color: #fca5a5;
            font-size: 13px;
            text-align: center;
            margin-bottom: 16px;
        }

        .login-error.hidden { display: none; }

        .login-links {
            text-align: center;
            margin-top: 16px;
        }

        .login-links a {
            color: var(--teal);
            text-decoration: none;
        }

        .login-links a:hover { text-decoration: underline; }

        /* ===== FB LAYOUT OVERRIDES ===== */
        .fb-main {
            padding: 12px;
            padding-top: calc(56px + env(safe-area-inset-top, 0px) + 12px);
            padding-bottom: calc(56px + env(safe-area-inset-bottom, 0px) + 12px);
        }

        /* ===== SCHEDULE STORIES ===== */
        .fb-stories-container {
            margin-bottom: 16px;
        }

        .fb-stories-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 4px 0 8px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .fb-stories-scroll::-webkit-scrollbar {
            display: none;
        }

        .fb-story-card {
            flex: 0 0 auto;
            width: 130px;
            height: 160px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 10px 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .fb-story-card:hover {
            border-color: var(--pink);
            transform: translateY(-2px);
        }

        .fb-story-card.league {
            border-color: var(--teal);
        }

        .fb-story-card.tournament {
            border-color: var(--yellow);
        }

        .fb-story-card.today {
            border-color: var(--pink);
            background: linear-gradient(135deg, rgba(255,70,154,0.2), var(--bg-card));
        }

        .fb-story-card.completed {
            opacity: 0.85;
        }

        .fb-story-card.past {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            opacity: 0.7;
        }

        .fb-story-card.past .fb-story-event,
        .fb-story-card.past .fb-story-week,
        .fb-story-card.past .fb-story-date,
        .fb-story-card.past .fb-story-opponent,
        .fb-story-card.past .fb-story-record {
            color: #a0aec0;
        }

        .fb-story-week {
            font-size: 9px;
            color: var(--pink);
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .fb-story-date {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .fb-story-day {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--text-light);
            line-height: 1;
        }

        .fb-story-opponent {
            font-size: 11px;
            color: var(--teal);
            margin-top: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            font-weight: 600;
        }

        .fb-story-card.completed .fb-story-opponent {
            color: var(--text-light);
        }

        .fb-story-stats {
            font-size: 9px;
            color: var(--text-dim);
            margin-top: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        .fb-story-stats .home-avg {
            color: var(--pink);
        }

        .fb-story-stats .away-avg {
            color: var(--teal);
        }

        .fb-story-record {
            font-size: 9px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .fb-story-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            margin-top: 4px;
        }

        .fb-story-score .winner {
            color: var(--yellow);
        }

        .fb-story-score .loser {
            color: var(--text-dim);
        }

        .fb-story-status {
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 8px;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }

        .fb-story-status.scheduled {
            background: rgba(145, 215, 235, 0.2);
            color: var(--teal);
        }

        .fb-story-status.today-status {
            background: rgba(255, 70, 154, 0.3);
            color: var(--pink);
        }

        .fb-story-status.past-status {
            background: rgba(113, 128, 150, 0.3);
            color: #a0aec0;
        }

        .fb-story-status.completed {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .fb-story-event {
            font-size: 10px;
            color: var(--teal);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fb-story-card.today .fb-story-event {
            color: var(--pink);
            font-weight: 600;
        }

        .fb-see-all-link {
            display: block;
            text-align: center;
            font-size: 13px;
            color: var(--teal);
            text-decoration: none;
            padding: 8px;
        }

        .fb-see-all-link:hover {
            text-decoration: underline;
        }

        /* ===== STATS SUMMARY ===== */
        .fb-stats-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .fb-stat-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fb-stat-card:hover {
            border-color: var(--teal);
        }

        .fb-stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--yellow);
            display: block;
            line-height: 1;
        }

        .fb-stat-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
            display: block;
        }

        /* ===== FEED FILTERS ===== */
        .fb-feed-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 4px;
            scrollbar-width: none;
        }

        .fb-feed-filters::-webkit-scrollbar {
            display: none;
        }

        .fb-filter-btn {
            flex: 0 0 auto;
            padding: 8px 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-dim);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fb-filter-btn:hover {
            border-color: var(--teal);
            color: var(--text-light);
        }

        .fb-filter-btn.active {
            background: var(--pink);
            border-color: var(--pink);
            color: white;
        }

        /* ===== NEWS FEED ===== */
        .fb-feed {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .fb-feed-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .fb-feed-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .fb-feed-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--pink);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            overflow: hidden;
        }

        .fb-feed-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .fb-feed-meta {
            flex: 1;
        }

        .fb-feed-author {
            font-weight: 600;
            color: var(--text-light);
            font-size: 14px;
        }

        .fb-feed-time {
            font-size: 12px;
            color: var(--text-dim);
        }

        .fb-feed-card-body {
            padding: 12px;
        }

        .fb-feed-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-light);
        }

        .fb-feed-event-tag {
            display: inline-block;
            background: rgba(145, 215, 235, 0.2);
            color: var(--teal);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-top: 8px;
        }

        .fb-feed-card-actions {
            display: flex;
            border-top: 1px solid var(--border-color);
        }

        .fb-feed-action-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .fb-feed-action-btn:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text-light);
        }

        .fb-feed-action-btn:not(:last-child) {
            border-right: 1px solid var(--border-color);
        }

        .fb-feed-loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }

        .fb-feed-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }

        .fb-feed-empty-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* ===== FAB ===== */
        .fb-fab {
            position: fixed;
            bottom: calc(70px + env(safe-area-inset-bottom, 0px));
            right: 16px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pink), #d63384);
            border: none;
            color: white;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 70, 154, 0.4);
            z-index: 100;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fb-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 70, 154, 0.5);
        }

        .fb-fab:active {
            transform: scale(0.95);
        }

        /* ===== MODALS ===== */
        .fb-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10002;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .fb-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .fb-modal {
            background: var(--bg-panel);
            border: 3px solid var(--pink);
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .fb-modal-large {
            max-width: 600px;
        }

        .fb-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .fb-modal-header h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 1px;
            color: var(--pink);
        }

        .fb-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-dim);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .fb-modal-close:hover {
            background: var(--pink);
            color: white;
        }

        .fb-modal-body {
            padding: 16px;
        }

        .fb-modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        /* Post Modal Specific */
        #postContent {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 14px;
            resize: vertical;
        }

        #postContent:focus {
            outline: none;
            border-color: var(--pink);
        }

        .fb-form-group {
            margin-top: 12px;
        }

        .fb-form-group label {
            display: block;
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .fb-form-group select {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 14px;
        }

        .fb-quick-posts {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .fb-quick-post-btn {
            padding: 6px 12px;
            background: rgba(145, 215, 235, 0.2);
            border: 1px solid var(--teal);
            border-radius: 16px;
            color: var(--teal);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fb-quick-post-btn:hover {
            background: var(--teal);
            color: var(--bg-dark);
        }

        .fb-btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--pink), #d63384);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fb-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 70, 154, 0.4);
        }

        /* ===== MATCH RESULT CARDS IN FEED ===== */
        .fb-match-result {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
        }

        .fb-match-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fb-match-team {
            text-align: center;
            flex: 1;
        }

        .fb-match-team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--teal);
        }

        .fb-match-team.winner .fb-match-team-name {
            color: var(--yellow);
        }

        .fb-match-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: var(--text-light);
            padding: 0 12px;
        }

        .fb-match-score .winner {
            color: var(--yellow);
        }

        .fb-match-legs {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        /* ===== INITIAL LOADER ===== */
        #initialLoader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%);
            z-index: 9999;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loader-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,70,154,0.3);
            border-top-color: #FF469A;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* ===== ACCESSIBILITY ===== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        :focus-visible {
            outline: 2px solid var(--yellow);
            outline-offset: 2px;
        }
    </style>
</head>
<body class="fb-page">
    <!-- Initial Loading Screen -->
    <div id="initialLoader">
        <img src="/images/gold_logo.png" alt="BRDC" style="height: 80px; margin-bottom: 20px;">
        <div class="loader-spinner"></div>
        <div id="initialLoaderText" style="margin-top: 16px; color: var(--pink); font-weight: 600;"></div>
    </div>

    <!-- Login Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <img src="/images/gold_logo.png" alt="Burning River Dart Club logo" class="login-logo">
        <h1 class="login-title">BRDC DASHBOARD</h1>

        <div class="login-box" style="position: relative;">
            <!-- Loading overlay -->
            <div id="loginLoader" class="hidden" style="position: absolute; inset: 0; background: rgba(22, 33, 62, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 16px; z-index: 10;">
                <div class="loader-spinner"></div>
                <div style="margin-top: 16px; color: var(--pink); font-weight: 600;">Logging in...</div>
            </div>

            <h2 class="login-form-title">LOGIN</h2>

            <div class="login-error hidden" id="loginError"></div>

            <div class="form-group">
                <label class="form-label" for="pinInput">Your 8-Digit PIN</label>
                <input type="password" class="form-input" id="pinInput" placeholder="--------" maxlength="8" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
            </div>

            <button class="login-btn" id="loginBtn" onclick="login()">LOGIN</button>

            <div class="login-links">
                <a href="#" onclick="showForgotPin(); return false;">Forgot PIN?</a>
                <span style="color: var(--text-dim); margin: 0 10px;">|</span>
                <a href="/pages/register.html">New Player? Register</a>
            </div>
        </div>
    </div>

    <!-- FB Header -->
    <header class="fb-header">
        <div class="fb-header-left">
            <button class="fb-header-btn" id="sidebarToggle" aria-label="Open menu">
                <div class="fb-hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
        </div>
        <div class="fb-header-center">
            <a href="/">
                <img src="/images/gold_logo.png" alt="BRDC" class="fb-header-logo">
            </a>
        </div>
        <div class="fb-header-right">
            <button class="fb-header-btn" id="searchBtn" aria-label="Search">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                </svg>
            </button>
            <button class="fb-header-btn fb-header-btn-badge" id="chatBtn" data-count="0" aria-label="Messages">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content (hidden until logged in) -->
    <main class="fb-main" id="mainContent" style="display: none;">

        <!-- My Events Row -->
        <section class="fb-stories-container">
            <h3 class="fb-section-title" style="margin: 0 16px 8px; font-family: 'Bebas Neue', cursive; font-size: 18px; color: var(--text-light);">My Events</h3>
            <div class="fb-stories-scroll" id="scheduleStories">
                <!-- Story cards populated by JS -->
                <div class="fb-story-card">
                    <div class="fb-story-date">Loading</div>
                    <div class="fb-story-day">...</div>
                </div>
            </div>
            <a href="/pages/events-hub.html" class="fb-see-all-link">See All Events</a>
        </section>

        <!-- Stats Summary Cards -->
        <section class="fb-stats-summary">
            <div class="fb-stat-card" onclick="goToProfile()">
                <span class="fb-stat-value" id="stat3DA">-</span>
                <span class="fb-stat-label">3DA</span>
            </div>
            <div class="fb-stat-card" onclick="goToProfile()">
                <span class="fb-stat-value" id="statMPR">-</span>
                <span class="fb-stat-label">MPR</span>
            </div>
            <div class="fb-stat-card" onclick="goToProfile()">
                <span class="fb-stat-value" id="statWinPct">-</span>
                <span class="fb-stat-label">WIN%</span>
            </div>
        </section>

        <!-- Feed Filter Bar -->
        <section class="fb-feed-filters">
            <button class="fb-filter-btn active" data-filter="all" onclick="filterFeed('all')">All</button>
            <button class="fb-filter-btn" data-filter="results" onclick="filterFeed('results')">Results</button>
            <button class="fb-filter-btn" data-filter="events" onclick="filterFeed('events')">Events</button>
            <button class="fb-filter-btn" data-filter="friends" onclick="filterFeed('friends')">Friends</button>
        </section>

        <!-- News Feed -->
        <section class="fb-feed" id="newsFeed">
            <div class="fb-feed-loading">Loading your feed...</div>
        </section>

    </main>

    <!-- FAB (Floating Action Button) -->
    <button class="fb-fab" id="fabButton" onclick="openPostModal()" aria-label="Create post">+</button>

    <!-- Post Modal -->
    <div class="fb-modal-overlay" id="postModal">
        <div class="fb-modal">
            <div class="fb-modal-header">
                <h3>Create Post</h3>
                <button class="fb-modal-close" onclick="closePostModal()">X</button>
            </div>
            <div class="fb-modal-body">
                <textarea id="postContent" placeholder="What's on your mind?" rows="4"></textarea>
                <div class="fb-form-group">
                    <label>Tag Event (optional)</label>
                    <select id="postEventTag">
                        <option value="">Select an event...</option>
                    </select>
                </div>
                <div class="fb-quick-posts">
                    <button class="fb-quick-post-btn" onclick="setQuickPost('anyone_going')">Anyone going?</button>
                    <button class="fb-quick-post-btn" onclick="setQuickPost('looking_for_partner')">Looking for partner</button>
                    <button class="fb-quick-post-btn" onclick="setQuickPost('whos_playing')">Who's playing tonight?</button>
                </div>
            </div>
            <div class="fb-modal-footer">
                <button class="fb-btn-primary" onclick="submitPost()">POST</button>
            </div>
        </div>
    </div>

    <!-- Story Detail Modal -->
    <div class="fb-modal-overlay" id="storyModal">
        <div class="fb-modal fb-modal-large">
            <button class="fb-modal-close" onclick="closeStoryModal()" style="position: absolute; top: 16px; right: 16px; z-index: 10;">X</button>
            <div class="fb-modal-body" id="storyModalContent">
                <!-- Match card or tournament details populated by JS -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { callFunction, db } from '/js/firebase-config.js';
        import { collection, doc, getDoc, getDocs, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Global state
        let currentPlayer = null;
        let dashboardData = null;

        // Mark module as loaded
        window.moduleLoaded = true;

        // Initialize on load
        initDashboard();

        function initDashboard() {
            hideInitialLoader();

            const savedSession = localStorage.getItem('brdc_session');
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    if (session.player_id) {
                        // Ensure player_pin is set for chat/social features
                        if (session.pin) {
                            localStorage.setItem('brdc_player_pin', session.pin.toUpperCase());
                        }

                        // Show loading state while dashboard data loads
                        showInitialLoader('Loading your dashboard...');

                        // Load dashboard data
                        loadDashboard(session.player_id, session.source_type, session.league_id);
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem('brdc_session');
                }
            }
            showLoginPage();
        }

        function hideInitialLoader() {
            const loader = document.getElementById('initialLoader');
            if (loader) loader.style.display = 'none';
        }

        function showInitialLoader(message) {
            const loader = document.getElementById('initialLoader');
            const text = document.getElementById('initialLoaderText');
            if (loader) {
                loader.style.display = 'flex';
                if (text && message) text.textContent = message;
            }
        }

        function showLoginPage() {
            hideInitialLoader();

            // Reset login form visibility
            const loginBox = document.querySelector('.login-box');
            if (loginBox) {
                loginBox.querySelector('h2').style.display = '';
                loginBox.querySelector('.form-group').style.display = '';
                loginBox.querySelector('.login-btn').style.display = '';
                loginBox.querySelector('.login-links').style.display = '';
            }

            // Hide login loader
            const loginLoader = document.getElementById('loginLoader');
            if (loginLoader) {
                loginLoader.classList.add('hidden');
                loginLoader.style.display = 'none';
            }

            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('mainContent').style.display = 'none';
        }

        function showDashboard() {
            // Hide all loaders
            hideInitialLoader();
            const loginLoader = document.getElementById('loginLoader');
            if (loginLoader) {
                loginLoader.classList.add('hidden');
                loginLoader.style.display = 'none';
            }

            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('mainContent').style.display = 'block';

            // Initialize FB navigation
            if (window.FBNav && currentPlayer) {
                window.FBNav.init(currentPlayer);
            }
        }

        // Login function
        window.login = async function() {
            const pin = document.getElementById('pinInput').value.trim();
            const errorDiv = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn');
            const loader = document.getElementById('loginLoader');

            errorDiv.classList.add('hidden');

            if (pin.length !== 8) {
                errorDiv.textContent = 'Please enter your 8-digit PIN';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Show loading overlay
            btn.disabled = true;
            loader.classList.remove('hidden');
            loader.style.display = 'flex';

            try {
                const result = await callFunction('globalLogin', { pin: pin });

                if (result.success) {
                    currentPlayer = result.player;
                    localStorage.setItem('brdc_session', JSON.stringify({
                        player_id: currentPlayer.id,
                        name: currentPlayer.name,
                        pin: pin,
                        source_type: currentPlayer.source_type || 'global',
                        league_id: currentPlayer.league_id || null,
                        logged_in_at: Date.now()
                    }));
                    // Also store PIN separately for chat/social features
                    localStorage.setItem('brdc_player_pin', pin.toUpperCase());

                    // Hide login loader and show initial loader for dashboard loading
                    loader.classList.add('hidden');
                    loader.style.display = 'none';
                    document.getElementById('loginOverlay').classList.add('hidden');
                    showInitialLoader('Loading your dashboard...');

                    loadDashboard(currentPlayer.id, currentPlayer.source_type, currentPlayer.league_id);
                } else {
                    loader.classList.add('hidden');
                    loader.style.display = 'none';
                    errorDiv.textContent = result.error || 'Login failed';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                loader.classList.add('hidden');
                loader.style.display = 'none';
                errorDiv.textContent = error.message || 'Login failed. Please try again.';
                errorDiv.classList.remove('hidden');
            } finally {
                btn.disabled = false;
            }
        };

        async function loadDashboard(playerId, sourceType, leagueId) {
            try {
                const result = await callFunction('getDashboardData', {
                    player_id: playerId,
                    source_type: sourceType || 'global',
                    league_id: leagueId || null
                });

                if (result.success) {
                    dashboardData = result.dashboard;
                    currentPlayer = dashboardData.player;

                    // Also try to load league stats for more accurate calculations
                    try {
                        const statsResult = await callFunction('getPlayerStatsFiltered', {
                            player_id: playerId,
                            source: 'combined'
                        });
                        if (statsResult.success && statsResult.stats) {
                            dashboardData.playerStats = statsResult.stats;
                        }
                    } catch (statsError) {
                        console.log('Could not load filtered stats, using player.stats:', statsError);
                    }

                    renderDashboard();
                    showDashboard();
                } else {
                    localStorage.removeItem('brdc_session');
                    showLoginPage();
                }
            } catch (error) {
                console.error('Load dashboard error:', error);
                localStorage.removeItem('brdc_session');
                showLoginPage();
            }
        }

        function renderDashboard() {
            const player = dashboardData.player;
            const roles = dashboardData.roles;

            // Use stats from playerStats (loaded from league stats) or fallback to player.stats
            const stats = dashboardData.playerStats || player.stats || {};
            let x01Avg = '-';
            let mpr = '-';
            let winPct = '-';
            let legsPlayed = 0;
            let legsWon = 0;

            // Handle different stats formats
            if (stats.x01_total_darts !== undefined) {
                // Calculate 3DA: (total_points / total_darts) * 3
                const x01Darts = stats.x01_total_darts || 0;
                const x01Points = stats.x01_total_points || 0;
                x01Avg = x01Darts > 0 ? ((x01Points / x01Darts) * 3).toFixed(1) : '-';

                // Calculate MPR: marks / rounds, where rounds = darts / 3
                const cricketDarts = stats.cricket_total_darts || 0;
                const cricketMarks = stats.cricket_total_marks || 0;
                const cricketRounds = cricketDarts / 3;
                mpr = cricketRounds > 0 ? (cricketMarks / cricketRounds).toFixed(2) : '-';

                legsPlayed = (stats.x01_legs_played || 0) + (stats.cricket_legs_played || 0);
                legsWon = (stats.x01_legs_won || 0) + (stats.cricket_legs_won || 0);
            } else if (stats.totals) {
                const totals = stats.totals;
                x01Avg = totals.x01_three_dart_avg ? totals.x01_three_dart_avg.toFixed(1) : (totals.three_dart_avg ? totals.three_dart_avg.toFixed(1) : '-');
                mpr = totals.cricket_mpr ? totals.cricket_mpr.toFixed(2) : '-';
                legsPlayed = totals.legs_played || 0;
                legsWon = totals.legs_won || 0;
            } else if (stats.x01) {
                const x01 = stats.x01 || {};
                const cricket = stats.cricket || {};

                // Calculate 3DA
                x01Avg = x01.total_darts > 0 ? ((x01.total_points / x01.total_darts) * 3).toFixed(1) : '-';

                // Calculate MPR: marks / rounds, where rounds = darts / 3
                const cricketDarts = cricket.total_darts || 0;
                const cricketMarks = cricket.total_marks || 0;
                const cricketRounds = cricketDarts / 3;
                mpr = cricketRounds > 0 ? (cricketMarks / cricketRounds).toFixed(2) : '-';

                legsPlayed = stats.matches_played || 0;
                legsWon = stats.matches_won || 0;
            }

            // Calculate win percentage
            if (legsPlayed > 0) {
                winPct = Math.round((legsWon / legsPlayed) * 100) + '%';
            }

            document.getElementById('stat3DA').textContent = x01Avg;
            document.getElementById('statMPR').textContent = mpr;
            document.getElementById('statWinPct').textContent = winPct;

            // Load schedule stories and feed
            loadScheduleStories(roles);
            loadFeed();
        }

        // Load schedule stories (upcoming events)
        async function loadScheduleStories(roles) {
            const container = document.getElementById('scheduleStories');
            const events = [];

            // Get upcoming and recent matches from roles
            if (roles && roles.playing) {
                for (const team of roles.playing) {
                    try {
                        const result = await callFunction('getTeamScheduleEnhanced', {
                            league_id: team.league_id || team.id,
                            team_id: team.team_id,
                            player_id: currentPlayer.id
                        });

                        if (result.success) {
                            // Add all upcoming matches
                            (result.upcoming || []).forEach(match => {
                                const matchDate = getDateFromTimestamp(match.match_date);

                                // Calculate team averages from rosters
                                const myRoster = match.my_team?.roster || [];
                                const oppRoster = match.opponent?.roster || [];

                                const myAvg = calculateTeamAvg(myRoster);
                                const oppAvg = calculateTeamAvg(oppRoster);

                                events.push({
                                    type: 'league',
                                    date: matchDate,
                                    week: match.week,
                                    opponent: match.opponent?.name || 'TBD',
                                    myTeam: match.my_team?.name || 'My Team',
                                    myRecord: match.my_team?.record || '(0-0)',
                                    oppRecord: match.opponent?.record || '(0-0)',
                                    myStanding: match.my_team?.standing || '',
                                    oppStanding: match.opponent?.standing || '',
                                    myAvg: myAvg,
                                    oppAvg: oppAvg,
                                    id: match.id,
                                    leagueId: team.league_id || team.id,
                                    leagueName: formatLeagueName(team.league_name || team.name),
                                    completed: false,
                                    isHome: match.is_home
                                });
                            });

                            // Add recent completed matches
                            (result.past || []).forEach(match => {
                                const matchDate = getDateFromTimestamp(match.match_date);

                                events.push({
                                    type: 'league',
                                    date: matchDate,
                                    week: match.week,
                                    opponent: match.opponent?.name || 'TBD',
                                    myTeam: match.my_team?.name || 'My Team',
                                    myRecord: match.my_team?.record || '(0-0)',
                                    oppRecord: match.opponent?.record || '(0-0)',
                                    myStanding: match.my_team?.standing || '',
                                    oppStanding: match.opponent?.standing || '',
                                    id: match.id,
                                    leagueId: team.league_id || team.id,
                                    leagueName: formatLeagueName(team.league_name || team.name),
                                    completed: true,
                                    won: match.won,
                                    myScore: match.my_score ?? '-',
                                    theirScore: match.their_score ?? '-',
                                    isHome: match.is_home
                                });
                            });
                        }
                    } catch (e) {
                        console.error('Error loading team schedule:', e);
                    }
                }
            }

            // Calculate isPast for each event based on actual date
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            events.forEach(event => {
                const eventDate = new Date(event.date);
                eventDate.setHours(0, 0, 0, 0);
                event.isPast = eventDate < now;
            });

            // Sort: future events first (by date asc), then past events at end (by date desc)
            events.sort((a, b) => {
                if (a.isPast && !b.isPast) return 1;  // Past goes after future
                if (!a.isPast && b.isPast) return -1; // Future goes before past
                if (a.isPast && b.isPast) return b.date - a.date; // Most recent past first
                return a.date - b.date; // Earliest future first
            });

            // Render story cards
            if (events.length > 0) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                container.innerHTML = events.map(matchEvent => {
                    const eventDate = new Date(matchEvent.date);
                    eventDate.setHours(0, 0, 0, 0);
                    const isToday = eventDate.getTime() === today.getTime();
                    const dayName = eventDate.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
                    const dayNum = eventDate.getDate();
                    const monthName = eventDate.toLocaleDateString('en-US', { month: 'short' }).toUpperCase();

                    // Determine status and past state
                    const isPast = matchEvent.isPast;
                    let statusClass = 'scheduled';
                    let statusText = 'UPCOMING';
                    if (matchEvent.completed) {
                        statusClass = 'completed';
                        statusText = matchEvent.won ? 'WIN' : 'LOSS';
                    } else if (isToday) {
                        statusClass = 'today-status';
                        statusText = 'TODAY';
                    } else if (isPast) {
                        statusClass = 'past-status';
                        statusText = 'PAST';
                    }

                    // Build card HTML
                    if (matchEvent.completed) {
                        // Completed match card - show score
                        const myScoreClass = matchEvent.won ? 'winner' : 'loser';
                        const theirScoreClass = matchEvent.won ? 'loser' : 'winner';

                        return `
                            <div class="fb-story-card ${matchEvent.type} completed past" onclick="openStoryModal('${matchEvent.id || ''}', '${matchEvent.type || 'league'}', '${matchEvent.leagueId || ''}')">
                                <div class="fb-story-event">${formatLeagueName(matchEvent.leagueName)}</div>
                                <div class="fb-story-week">WEEK ${matchEvent.week || '?'}</div>
                                <div class="fb-story-date">${dayName} ${monthName} ${dayNum}</div>
                                <div class="fb-story-opponent">${matchEvent.isHome ? 'vs' : '@'} ${matchEvent.opponent}${matchEvent.oppStanding ? ` (${matchEvent.oppStanding})` : ''}</div>
                                <div class="fb-story-score">
                                    <span class="${myScoreClass}">${matchEvent.myScore}</span>
                                    <span style="color: var(--text-dim);">-</span>
                                    <span class="${theirScoreClass}">${matchEvent.theirScore}</span>
                                </div>
                                <div class="fb-story-record">${matchEvent.myRecord} vs ${matchEvent.oppRecord}</div>
                                <div class="fb-story-status ${statusClass}">${statusText}</div>
                            </div>
                        `;
                    } else {
                        // Non-completed match card - show stats preview
                        const hasStats = matchEvent.myAvg || matchEvent.oppAvg;
                        const cardClasses = ['fb-story-card', matchEvent.type];
                        if (isToday) cardClasses.push('today');
                        if (isPast) cardClasses.push('past');

                        return `
                            <div class="${cardClasses.join(' ')}" onclick="openStoryModal('${matchEvent.id || ''}', '${matchEvent.type || 'league'}', '${matchEvent.leagueId || ''}')">
                                <div class="fb-story-event">${formatLeagueName(matchEvent.leagueName)}</div>
                                <div class="fb-story-week">WEEK ${matchEvent.week || '?'}</div>
                                <div class="fb-story-date">${dayName} ${monthName} ${dayNum}</div>
                                <div class="fb-story-opponent">${matchEvent.isHome ? 'vs' : '@'} ${matchEvent.opponent}${matchEvent.oppStanding ? ` (${matchEvent.oppStanding})` : ''}</div>
                                ${hasStats ? `
                                    <div class="fb-story-stats">
                                        <span class="home-avg">${matchEvent.myAvg || '-'}</span>
                                        <span style="color: var(--text-dim);"> vs </span>
                                        <span class="away-avg">${matchEvent.oppAvg || '-'}</span>
                                    </div>
                                ` : ''}
                                <div class="fb-story-record">${matchEvent.myRecord} vs ${matchEvent.oppRecord}</div>
                                <div class="fb-story-status ${statusClass}">${statusText}</div>
                            </div>
                        `;
                    }
                }).join('');
            } else {
                container.innerHTML = `
                    <div class="fb-story-card">
                        <div class="fb-story-date">NO EVENTS</div>
                        <div class="fb-story-day">-</div>
                        <div class="fb-story-event">Check back later</div>
                    </div>
                `;
            }
        }

        // Helper to calculate team average from roster
        function calculateTeamAvg(roster) {
            if (!roster || roster.length === 0) return null;

            const validAvgs = roster
                .map(p => parseFloat(p.x01_three_dart_avg))
                .filter(avg => !isNaN(avg) && avg > 0);

            if (validAvgs.length === 0) return null;

            const avg = validAvgs.reduce((sum, a) => sum + a, 0) / validAvgs.length;
            return avg.toFixed(1);
        }

        // Helper functions for date handling
        function getTimestamp(date) {
            if (!date) return 0;
            if (date._seconds) return date._seconds;
            if (date.seconds) return date.seconds;
            if (date.toDate) return date.toDate().getTime() / 1000;
            return new Date(date).getTime() / 1000;
        }

        function getDateFromTimestamp(date) {
            if (!date) return new Date();
            if (date._seconds) return new Date(date._seconds * 1000);
            if (date.seconds) return new Date(date.seconds * 1000);
            if (date.toDate) return date.toDate();
            // Handle date strings like "2026-01-28" - parse as local time, not UTC
            if (typeof date === 'string' && date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const [year, month, day] = date.split('-').map(Number);
                return new Date(year, month - 1, day);
            }
            return new Date(date);
        }

        // Load news feed from Firestore
        async function loadFeed(filter = 'all') {
            const container = document.getElementById('newsFeed');
            container.innerHTML = '<div class="fb-feed-loading">Loading your feed...</div>';

            try {
                const roles = dashboardData?.roles;
                const feedItems = [];

                // Get feed from all leagues player is in
                if (roles && roles.playing) {
                    for (const team of roles.playing) {
                        const leagueId = team.league_id || team.id;

                        // Get feed items from this league
                        const feedSnap = await getDocs(
                            query(
                                collection(db, 'leagues', leagueId, 'feed'),
                                orderBy('created_at', 'desc'),
                                limit(50)
                            )
                        );

                        feedSnap.forEach(doc => {
                            const item = { id: doc.id, ...doc.data(), leagueId };
                            feedItems.push(item);
                        });
                    }
                }

                // Sort all feed items by date
                feedItems.sort((a, b) => {
                    const dateA = getTimestamp(a.created_at);
                    const dateB = getTimestamp(b.created_at);
                    return dateB - dateA;
                });

                // Filter based on selected filter
                let filtered = feedItems;
                if (filter === 'results') {
                    filtered = feedItems.filter(i => i.type === 'match_result');
                } else if (filter === 'events') {
                    filtered = feedItems.filter(i => i.type === 'event');
                } else if (filter === 'friends') {
                    // TODO: filter by friends
                    filtered = feedItems;
                }

                // Render
                if (filtered.length > 0) {
                    container.innerHTML = filtered.slice(0, 20).map(item => renderFeedCard(item)).join('');
                } else {
                    container.innerHTML = `
                        <div class="fb-feed-empty">
                            <div class="fb-feed-empty-icon">&#127919;</div>
                            <p>No recent activity</p>
                            <p style="font-size: 13px; margin-top: 8px;">Join a league or tournament to see updates here!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading feed:', error);
                container.innerHTML = `
                    <div class="fb-feed-empty">
                        <div class="fb-feed-empty-icon"></div>
                        <p>Error loading feed</p>
                    </div>
                `;
            }
        }

        // Render a single feed card based on type
        function renderFeedCard(item) {
            switch (item.type) {
                case 'match_result':
                    return renderMatchResultFeedCard(item);
                case 'league_night':
                    return renderLeagueNightCard(item);
                default:
                    return '';
            }
        }

        function renderPostCard(post) {
            const authorInitial = (post.author_name || 'U').charAt(0).toUpperCase();
            const timeAgo = formatTimeAgo(post.created_at);

            return `
                <div class="fb-feed-card">
                    <div class="fb-feed-card-header">
                        <div class="fb-feed-avatar">
                            ${post.author_photo ? `<img src="${post.author_photo}" alt="">` : authorInitial}
                        </div>
                        <div class="fb-feed-meta">
                            <div class="fb-feed-author">${post.author_name || 'Unknown'}</div>
                            <div class="fb-feed-time">${timeAgo}</div>
                        </div>
                    </div>
                    <div class="fb-feed-card-body">
                        <div class="fb-feed-text">${post.content}</div>
                        ${post.event_tag ? `<span class="fb-feed-event-tag">${post.event_tag}</span>` : ''}
                    </div>
                    <div class="fb-feed-card-actions">
                        <button class="fb-feed-action-btn">&#128077; Like</button>
                        <button class="fb-feed-action-btn">&#128172; Comment</button>
                        <button class="fb-feed-action-btn">&#128279; Share</button>
                    </div>
                </div>
            `;
        }

        // Render match result feed card with top performers
        function renderMatchResultFeedCard(item) {
            const data = item.data;
            const matchDate = getDateFromTimestamp(item.created_at);
            const dateStr = matchDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            const homeWon = data.home_score > data.away_score;

            // Render rosters
            const homeRosterHtml = (data.home_roster || [])
                .sort((a, b) => (a.level || 'Z').localeCompare(b.level || 'Z'))
                .map(p => `<div style="font-size: 12px; color: var(--text-light);">${p.name}</div>`)
                .join('');

            const awayRosterHtml = (data.away_roster || [])
                .sort((a, b) => (a.level || 'Z').localeCompare(b.level || 'Z'))
                .map(p => `<div style="font-size: 12px; color: var(--text-light);">${p.name}</div>`)
                .join('');

            // Render top performers by level
            let performersHtml = '';
            if (data.top_performers) {
                const levels = ['A', 'B', 'C'];
                const performersList = levels.map(level => {
                    const perf = data.top_performers[level];
                    if (!perf) return '';
                    const stat = perf.avg_3da || perf.mpr;
                    const statLabel = perf.avg_3da ? `${perf.avg_3da} 3DA` : `${perf.mpr} MPR`;
                    return `<span style="color: var(--text-light); font-size: 12px;">${level}: ${perf.name} (${statLabel})</span>`;
                }).filter(x => x).join('  ');

                if (performersList) {
                    performersHtml = `<div style="text-align: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">${performersList}</div>`;
                }
            }

            return `
                <div class="fb-feed-card">
                    <div class="fb-feed-card-header">
                        <div class="fb-feed-avatar" style="background: var(--teal)">
                            &#127919;
                        </div>
                        <div class="fb-feed-meta">
                            <div class="fb-feed-author">${item.league_name || 'League'} - Week ${item.week}</div>
                            <div class="fb-feed-time">${dateStr}</div>
                        </div>
                    </div>
                    <div class="fb-feed-card-body">
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px; align-items: center;">
                            <div style="text-align: right;">
                                <div style="font-weight: 600; font-size: 16px; color: ${homeWon ? 'var(--yellow)' : 'var(--text-light)'}; margin-bottom: 6px;">
                                    ${data.home_team_name}
                                </div>
                                ${homeRosterHtml}
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: 700;">
                                    <span style="color: ${homeWon ? 'var(--yellow)' : 'var(--text-light)'};">${data.home_score}</span>
                                    <span style="color: var(--text-dim); margin: 0 8px;">-</span>
                                    <span style="color: ${!homeWon ? 'var(--yellow)' : 'var(--text-light)'};">${data.away_score}</span>
                                </div>
                            </div>
                            <div style="text-align: left;">
                                <div style="font-weight: 600; font-size: 16px; color: ${!homeWon ? 'var(--yellow)' : 'var(--text-light)'}; margin-bottom: 6px;">
                                    ${data.away_team_name}
                                </div>
                                ${awayRosterHtml}
                            </div>
                        </div>
                        ${performersHtml}
                    </div>
                    <div class="fb-feed-card-actions">
                        <button class="fb-feed-action-btn" onclick="window.location.href='/pages/match-hub.html?league_id=${item.league_id}&match_id=${item.match_id}'">
                            &#128202; View Match
                        </button>
                    </div>
                </div>
            `;
        }

        // Render league night summary card
        function renderLeagueNightCard(item) {
            const data = item.data;
            const matchDate = getDateFromTimestamp(item.created_at);
            const dateStr = matchDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            // Render top performers by level
            let performersHtml = '';
            if (data.top_performers) {
                const levels = ['A', 'B', 'C'];
                const performersList = levels.map(level => {
                    const perf = data.top_performers[level];
                    if (!perf) return '';
                    const stat = perf.avg_3da || perf.mpr;
                    const statLabel = perf.avg_3da ? `${perf.avg_3da} 3DA` : `${perf.mpr} MPR`;
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0;">
                            <span style="color: var(--pink); font-weight: 600;">${level} Level</span>
                            <span style="color: var(--text-light);">${perf.name}</span>
                            <span style="color: var(--yellow);">${statLabel}</span>
                        </div>
                    `;
                }).join('');

                if (performersList) {
                    performersHtml = `
                        <div style="margin-top: 12px;">
                            <div style="font-weight: 600; margin-bottom: 6px; color: var(--text-light);">Top Performers</div>
                            ${performersList}
                        </div>
                    `;
                }
            }

            // Render top 3 standings
            let standingsHtml = '';
            if (data.standings_top3 && data.standings_top3.length > 0) {
                const standingsList = data.standings_top3.map(team => `
                    <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                        <span>${team.rank}. ${team.team_name}</span>
                        <span style="color: var(--text-dim);">${team.wins}-${team.losses}</span>
                    </div>
                `).join('');

                standingsHtml = `
                    <div style="margin-top: 12px;">
                        <div style="font-weight: 600; margin-bottom: 6px; color: var(--text-light);">Standings</div>
                        ${standingsList}
                    </div>
                `;
            }

            return `
                <div class="fb-feed-card">
                    <div class="fb-feed-card-header">
                        <div class="fb-feed-avatar" style="background: var(--pink); font-size: 20px;">
                            
                        </div>
                        <div class="fb-feed-meta">
                            <div class="fb-feed-author">${item.league_name || 'League'} - Week ${item.week}</div>
                            <div class="fb-feed-time">${dateStr}  ${data.matches_played} matches</div>
                        </div>
                    </div>
                    <div class="fb-feed-card-body">
                        ${performersHtml}
                        ${standingsHtml}
                    </div>
                    <div class="fb-feed-card-actions">
                        <button class="fb-feed-action-btn" onclick="window.location.href='/pages/league-view.html?league_id=${item.league_id}'">
                             View League
                        </button>
                    </div>
                </div>
            `;
        }

        // Render notable throw card
        function renderNotableThrowCard(item) {
            const data = item.data;
            const matchDate = getDateFromTimestamp(item.created_at);
            const dateStr = matchDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            let icon = '';
            let title = '';
            let description = '';

            if (item.type === 'maximum') {
                icon = '';
                title = '180 Maximum!';
                description = `${item.player_name} throws a maximum 180`;
            } else if (item.type === 'high_score') {
                icon = '';
                title = `${data.score} Points!`;
                description = `${item.player_name} with a big ${data.score}`;
            } else if (item.type === 'ton_checkout') {
                icon = '';
                title = `${data.checkout} Checkout`;
                description = `${item.player_name} checks out ${data.checkout}`;
            } else if (item.type === 'big_checkout') {
                icon = '';
                title = `BIG ${data.checkout} Checkout!`;
                description = `${item.player_name} with a huge ${data.checkout} checkout`;
            } else if (item.type === 'nine_mark') {
                icon = '';
                title = '9-Mark Maximum!';
                description = `${item.player_name} throws 9 marks`;
            } else if (item.type === 'high_marks') {
                icon = '';
                title = `${data.marks} Marks!`;
                description = `${item.player_name} with ${data.marks} marks`;
            } else if (item.type === 'bull_run') {
                icon = '';
                title = 'Bull Run!';
                description = `${item.player_name} lights up the bulls (${data.notable})`;
            }

            return `
                <div class="fb-feed-card">
                    <div class="fb-feed-card-header">
                        <div class="fb-feed-avatar" style="background: var(--yellow); font-size: 20px;">
                            ${icon}
                        </div>
                        <div class="fb-feed-meta">
                            <div class="fb-feed-author">${title}</div>
                            <div class="fb-feed-time">${dateStr}  Week ${item.week}</div>
                        </div>
                    </div>
                    <div class="fb-feed-card-body">
                        <div class="fb-feed-text">${description}</div>
                        <span class="fb-feed-event-tag">${item.team_name} vs ${data.opponent_team}</span>
                    </div>
                </div>
            `;
        }

        // Render weekly leader card
        function renderWeeklyLeaderCard(item) {
            const data = item.data;
            const matchDate = getDateFromTimestamp(item.created_at);
            const dateStr = matchDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            return `
                <div class="fb-feed-card">
                    <div class="fb-feed-card-header">
                        <div class="fb-feed-avatar" style="background: var(--pink)">
                            
                        </div>
                        <div class="fb-feed-meta">
                            <div class="fb-feed-author">Week ${item.week} Leader</div>
                            <div class="fb-feed-time">${dateStr}</div>
                        </div>
                    </div>
                    <div class="fb-feed-card-body">
                        <div class="fb-feed-text">
                            <strong>${item.player_name}</strong> leads the week with ${data.value} ${data.stat_type}
                        </div>
                    </div>
                </div>
            `;
        }

        // Render milestone card
        function renderMilestoneCard(item) {
            const data = item.data;
            const matchDate = getDateFromTimestamp(item.created_at);
            const dateStr = matchDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            let title = '';
            let description = '';

            if (data.milestone_type === 'legs_played') {
                title = `${data.value} Legs Played!`;
                description = `${item.player_name} reaches ${data.value} legs played`;
            } else if (data.milestone_type === 'first_180') {
                title = 'First 180!';
                description = `${item.player_name} throws their first maximum 180`;
            }

            return `
                <div class="fb-feed-card">
                    <div class="fb-feed-card-header">
                        <div class="fb-feed-avatar" style="background: var(--success)">
                            
                        </div>
                        <div class="fb-feed-meta">
                            <div class="fb-feed-author">${title}</div>
                            <div class="fb-feed-time">${dateStr}</div>
                        </div>
                    </div>
                    <div class="fb-feed-card-body">
                        <div class="fb-feed-text">${description}</div>
                    </div>
                </div>
            `;
        }

        // Render hat trick card
        function renderHatTrickCard(item) {
            const data = item.data;
            const matchDate = getDateFromTimestamp(item.created_at);
            const dateStr = matchDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            return `
                <div class="fb-feed-card">
                    <div class="fb-feed-card-header">
                        <div class="fb-feed-avatar" style="background: var(--yellow); font-size: 20px;">
                            
                        </div>
                        <div class="fb-feed-meta">
                            <div class="fb-feed-author">Hat Trick!</div>
                            <div class="fb-feed-time">${dateStr}  Week ${item.week}</div>
                        </div>
                    </div>
                    <div class="fb-feed-card-body">
                        <div class="fb-feed-text">
                            <strong>${item.player_name}</strong> throws ${data.ton_count} tons in one set!
                        </div>
                        <span class="fb-feed-event-tag">${item.team_name} vs ${data.opponent_team}</span>
                    </div>
                </div>
            `;
        }

        // Render upset card
        function renderUpsetCard(item) {
            const data = item.data;
            const matchDate = getDateFromTimestamp(item.created_at);
            const dateStr = matchDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            return `
                <div class="fb-feed-card">
                    <div class="fb-feed-card-header">
                        <div class="fb-feed-avatar" style="background: var(--danger); font-size: 20px;">
                            
                        </div>
                        <div class="fb-feed-meta">
                            <div class="fb-feed-author">UPSET!</div>
                            <div class="fb-feed-time">${dateStr}  Week ${item.week}</div>
                        </div>
                    </div>
                    <div class="fb-feed-card-body">
                        <div class="fb-feed-text">
                            <strong>#${data.winner_rank} ${data.winner_team_name}</strong> defeats <strong>#${data.loser_rank} ${data.loser_team_name}</strong> ${data.winner_score}-${data.loser_score}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEventCard(event) {
            return `
                <div class="fb-feed-card">
                    <div class="fb-feed-card-header">
                        <div class="fb-feed-avatar">&#128197;</div>
                        <div class="fb-feed-meta">
                            <div class="fb-feed-author">${event.name}</div>
                            <div class="fb-feed-time">${event.date_str}</div>
                        </div>
                    </div>
                    <div class="fb-feed-card-body">
                        <div class="fb-feed-text">${event.description || 'Upcoming event'}</div>
                        <span class="fb-feed-event-tag">${event.type}</span>
                    </div>
                </div>
            `;
        }

        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const seconds = timestamp._seconds || timestamp.seconds || Math.floor(timestamp / 1000);
            const date = new Date(seconds * 1000);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Filter feed
        window.filterFeed = function(filter) {
            document.querySelectorAll('.fb-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            loadFeed(filter);
        };

        // Navigation
        window.goToProfile = function() {
            let url = `/pages/player-profile.html?player_id=${currentPlayer.id}`;
            if (currentPlayer.league_id) {
                url += `&league_id=${currentPlayer.league_id}`;
            }
            window.location.href = url;
        };

        window.viewMatch = function(matchId, leagueId) {
            window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}`;
        };

        window.shareMatch = function(matchId) {
            const url = `${window.location.origin}/pages/match-hub.html?match_id=${matchId}`;
            if (navigator.share) {
                navigator.share({
                    title: 'Match Result - BRDC',
                    text: 'Check out this match result!',
                    url: url
                }).catch(err => console.log('Share cancelled:', err));
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(url).then(() => {
                    alert('Link copied to clipboard!');
                }).catch(err => {
                    console.error('Copy failed:', err);
                    alert('Could not copy link');
                });
            }
        };

        // Post Modal
        window.openPostModal = function() {
            document.getElementById('postModal').classList.add('visible');
            document.body.style.overflow = 'hidden';
        };

        window.closePostModal = function() {
            document.getElementById('postModal').classList.remove('visible');
            document.body.style.overflow = '';
        };

        window.setQuickPost = function(type) {
            const textarea = document.getElementById('postContent');
            const templates = {
                'anyone_going': 'Anyone going to the match tonight?',
                'looking_for_partner': 'Looking for a doubles partner for upcoming tournaments!',
                'whos_playing': "Who's playing tonight? Let's get some games in!"
            };
            textarea.value = templates[type] || '';
        };

        window.submitPost = async function() {
            const content = document.getElementById('postContent').value.trim();
            if (!content) {
                alert('Please enter some text');
                return;
            }

            try {
                const result = await callFunction('createPost', {
                    player_id: currentPlayer.id,
                    content: content,
                    event_tag: document.getElementById('postEventTag').value || null
                });

                if (result.success) {
                    closePostModal();
                    document.getElementById('postContent').value = '';
                    loadFeed();
                } else {
                    alert('Failed to create post');
                }
            } catch (error) {
                console.error('Error creating post:', error);
                alert('Failed to create post. Please try again.');
            }
        };

        // Story Modal - show match preview with full details
        window.openStoryModal = async function(eventId, eventType, leagueId) {
            console.log('openStoryModal called:', { eventId, eventType, leagueId });

            const modal = document.getElementById('storyModal');
            const content = document.getElementById('storyModalContent');

            if (!modal || !content) {
                console.error('Modal elements not found');
                return;
            }

            modal.classList.add('visible');
            modal.querySelector('.fb-modal').classList.add('open');
            document.body.style.overflow = 'hidden';
            content.innerHTML = '<div class="fb-feed-loading">Loading match details...</div>';
            console.log('Modal should be visible now');

            try {
                if (eventType === 'league') {
                    // Find the match in our cached data
                    const roles = dashboardData?.roles;
                    let matchData = null;

                    if (roles && roles.playing) {
                        for (const team of roles.playing) {
                            if ((team.league_id || team.id) === leagueId) {
                                const result = await callFunction('getTeamScheduleEnhanced', {
                                    league_id: leagueId,
                                    team_id: team.team_id,
                                    player_id: currentPlayer.id
                                });

                                console.log('getTeamScheduleEnhanced result:', result);
                                if (result.success) {
                                    // Check upcoming and past matches
                                    const allMatches = [...(result.upcoming || []), ...(result.past || [])];
                                    matchData = allMatches.find(m => m.id === eventId);
                                    console.log('Found matchData:', matchData);
                                    console.log('my_team roster:', matchData?.my_team?.roster);
                                    console.log('opponent roster:', matchData?.opponent?.roster);
                                    if (matchData) {
                                        matchData.leagueName = formatLeagueName(result.league_name);
                                        break;
                                    }
                                }
                            }
                        }
                    }

                    if (matchData) {
                        content.innerHTML = renderMatchPreviewModal(matchData, leagueId);
                    } else {
                        // Fallback to direct navigation if match not found
                        window.location.href = `/pages/match-hub.html?league_id=${leagueId}&match_id=${eventId}`;
                    }
                } else {
                    // Tournament or other event
                    window.location.href = `/pages/event-view.html?id=${eventId}`;
                }
            } catch (error) {
                console.error('Error loading match details:', error);
                content.innerHTML = '<p style="text-align: center; color: var(--text-dim);">Error loading details</p>';
            }
        };

        // Render match preview modal content - matches league-view.html format
        // Home team always on LEFT, away team always on RIGHT
        function renderMatchPreviewModal(match, leagueId) {
            const matchDate = getDateFromTimestamp(match.match_date);
            const dateStr = matchDate.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });

            const myTeam = match.my_team || {};
            const opponent = match.opponent || {};
            const isCompleted = match.completed || false;
            const isHome = match.is_home;

            // Determine home/away teams (home always on left, away always on right)
            const homeTeam = isHome ? myTeam : opponent;
            const awayTeam = isHome ? opponent : myTeam;
            const homeRoster = homeTeam.roster || [];
            const awayRoster = awayTeam.roster || [];

            // Calculate team averages
            const homeAvg = calculateTeamAvg(homeRoster);
            const awayAvg = calculateTeamAvg(awayRoster);

            // Calculate team MPR
            const calcTeamMPR = (roster) => {
                if (!roster || roster.length === 0) return null;
                const validMprs = roster.map(p => parseFloat(p.cricket_mpr)).filter(m => !isNaN(m) && m > 0);
                if (validMprs.length === 0) return null;
                return (validMprs.reduce((sum, m) => sum + m, 0) / validMprs.length).toFixed(2);
            };
            const homeMPR = calcTeamMPR(homeRoster);
            const awayMPR = calcTeamMPR(awayRoster);

            // Determine scores for completed matches
            const homeScore = isHome ? match.my_score : match.their_score;
            const awayScore = isHome ? match.their_score : match.my_score;
            const homeWon = isCompleted && homeScore > awayScore;
            const awayWon = isCompleted && awayScore > homeScore;

            // Build roster rows (side by side like league-view)
            const maxPlayers = Math.max(homeRoster.length, awayRoster.length, 3);
            let rosterRows = '';
            for (let i = 0; i < maxPlayers; i++) {
                const homePlayer = homeRoster[i];
                const awayPlayer = awayRoster[i];
                const homeName = homePlayer ? homePlayer.name : '';
                const awayName = awayPlayer ? awayPlayer.name : '';
                const home3DA = homePlayer ? (homePlayer.x01_three_dart_avg || '-') : '';
                const homePlayerMpr = homePlayer ? (homePlayer.cricket_mpr || '-') : '';
                const away3DA = awayPlayer ? (awayPlayer.x01_three_dart_avg || '-') : '';
                const awayPlayerMpr = awayPlayer ? (awayPlayer.cricket_mpr || '-') : '';

                rosterRows += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <div style="flex: 1; text-align: right; padding-right: 8px;">
                            ${homePlayer ? `<span style="color: var(--text-dim); font-family: 'JetBrains Mono', monospace; font-size: 11px; margin-right: 8px;">${home3DA} / ${homePlayerMpr}</span>` : ''}
                            <span style="color: var(--text-light); font-size: 13px;">${homeName}</span>
                        </div>
                        <div style="flex: 1; text-align: left; padding-left: 8px;">
                            <span style="color: var(--text-light); font-size: 13px;">${awayName}</span>
                            ${awayPlayer ? `<span style="color: var(--text-dim); font-family: 'JetBrains Mono', monospace; font-size: 11px; margin-left: 8px;">${away3DA} / ${awayPlayerMpr}</span>` : ''}
                        </div>
                    </div>
                `;
            }

            // Build score section for completed matches
            let scoreSection = '';
            if (isCompleted) {
                scoreSection = `
                    <div style="display: flex; justify-content: center; align-items: center; gap: 16px; margin: 16px 0;">
                        <div style="font-family: 'Bebas Neue', cursive; font-size: 48px; ${homeWon ? 'color: var(--yellow);' : 'color: var(--text-dim);'}">${homeScore}</div>
                        <div style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--text-dim);">-</div>
                        <div style="font-family: 'Bebas Neue', cursive; font-size: 48px; ${awayWon ? 'color: var(--yellow);' : 'color: var(--text-dim);'}">${awayScore}</div>
                    </div>
                    <div style="text-align: center; font-size: 12px; color: ${match.won ? 'var(--success)' : 'var(--danger)'}; text-transform: uppercase; font-weight: 700; margin-bottom: 12px;">
                        ${match.won ? 'VICTORY' : 'DEFEAT'}
                    </div>
                `;
            }

            return `
                <div style="padding: 0;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 16px;">
                        <div style="font-size: 10px; color: var(--pink); text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">
                            ${formatLeagueName(match.leagueName)} - WEEK ${match.week || '?'}
                        </div>
                        <div style="font-size: 14px; color: var(--text-dim); margin-top: 4px;">
                            ${dateStr}
                        </div>
                    </div>

                    <!-- Teams Header - Home on LEFT, Away on RIGHT -->
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 8px; margin-bottom: 8px; align-items: start;">
                        <!-- Home Team (Left) -->
                        <div style="text-align: right;">
                            ${homeWon ? '<div style="color: var(--yellow); font-size: 14px; margin-bottom: 2px;"></div>' : ''}
                            <div style="font-family: 'Bebas Neue', cursive; font-size: 18px; color: ${isHome ? 'var(--pink)' : 'var(--teal)'};">
                                ${homeTeam.name || 'Home Team'}
                            </div>
                            <div style="display: flex; justify-content: flex-end; gap: 6px; margin-top: 4px;">
                                ${homeTeam.standing ? `<span style="background: var(--pink); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold;">${homeTeam.standing}</span>` : ''}
                                <span style="background: #333; color: #888; padding: 2px 6px; border-radius: 3px; font-size: 10px;">${homeTeam.record || '0-0'}</span>
                            </div>
                            <div style="font-size: 11px; color: ${isHome ? 'var(--pink)' : 'var(--teal)'}; font-family: 'JetBrains Mono', monospace; margin-top: 4px;">
                                ${homeAvg || '-'} / ${homeMPR || '-'}
                            </div>
                        </div>

                        <!-- Center -->
                        <div style="text-align: center; padding-top: 8px;">
                            <div style="font-family: 'Bebas Neue', cursive; font-size: 14px; color: var(--text-dim);">
                                ${isCompleted ? 'FINAL' : (isHome ? 'VS' : '@')}
                            </div>
                        </div>

                        <!-- Away Team (Right) -->
                        <div style="text-align: left;">
                            ${awayWon ? '<div style="color: var(--yellow); font-size: 14px; margin-bottom: 2px;"></div>' : ''}
                            <div style="font-family: 'Bebas Neue', cursive; font-size: 18px; color: ${!isHome ? 'var(--pink)' : 'var(--teal)'};">
                                ${awayTeam.name || 'Away Team'}
                            </div>
                            <div style="display: flex; justify-content: flex-start; gap: 6px; margin-top: 4px;">
                                ${awayTeam.standing ? `<span style="background: var(--pink); color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold;">${awayTeam.standing}</span>` : ''}
                                <span style="background: #333; color: #888; padding: 2px 6px; border-radius: 3px; font-size: 10px;">${awayTeam.record || '0-0'}</span>
                            </div>
                            <div style="font-size: 11px; color: ${!isHome ? 'var(--pink)' : 'var(--teal)'}; font-family: 'JetBrains Mono', monospace; margin-top: 4px;">
                                ${awayAvg || '-'} / ${awayMPR || '-'}
                            </div>
                        </div>
                    </div>

                    ${scoreSection}

                    <!-- Rosters - Side by side like league-view -->
                    <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 10px; color: ${isHome ? 'var(--pink)' : 'var(--teal)'}; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">
                                ${isHome ? 'YOUR TEAM' : 'OPPONENT'} (HOME)
                            </div>
                            <div style="font-size: 10px; color: ${!isHome ? 'var(--pink)' : 'var(--teal)'}; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">
                                ${!isHome ? 'YOUR TEAM' : 'OPPONENT'} (AWAY)
                            </div>
                        </div>
                        ${rosterRows || '<div style="color: var(--text-dim); font-size: 12px; text-align: center; padding: 12px;">No roster data available</div>'}
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="viewMatch('${match.id}', '${leagueId}')" style="
                            flex: 1;
                            padding: 12px;
                            background: linear-gradient(135deg, var(--pink), #d63384);
                            border: none;
                            border-radius: 8px;
                            color: white;
                            font-family: 'Bebas Neue', cursive;
                            font-size: 16px;
                            letter-spacing: 1px;
                            cursor: pointer;
                        ">${isCompleted ? 'VIEW REPORT' : 'VIEW MATCH HUB'}</button>
                        ${!isCompleted ? `
                            <button onclick="confirmAttendance('${match.id}', '${leagueId}', 'confirmed')" style="
                                padding: 12px 16px;
                                background: rgba(34, 197, 94, 0.2);
                                border: 2px solid var(--success);
                                border-radius: 8px;
                                color: var(--success);
                                font-family: 'Bebas Neue', cursive;
                                font-size: 14px;
                                letter-spacing: 1px;
                                cursor: pointer;
                            ">CONFIRM</button>
                            <button onclick="confirmAttendance('${match.id}', '${leagueId}', 'unavailable')" style="
                                padding: 12px 16px;
                                background: rgba(239, 68, 68, 0.2);
                                border: 2px solid var(--danger);
                                border-radius: 8px;
                                color: var(--danger);
                                font-family: 'Bebas Neue', cursive;
                                font-size: 14px;
                                letter-spacing: 1px;
                                cursor: pointer;
                            ">CAN'T MAKE IT</button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        window.closeStoryModal = function() {
            const modal = document.getElementById('storyModal');
            modal.classList.remove('visible');
            modal.querySelector('.fb-modal').classList.remove('open');
            document.body.style.overflow = '';
        };

        // Confirm attendance handler
        window.confirmAttendance = async function(matchId, leagueId, status) {
            try {
                const result = await callFunction('updatePlayerAvailability', {
                    league_id: leagueId,
                    match_id: matchId,
                    player_id: currentPlayer.id,
                    status: status
                });

                if (result.success) {
                    const statusText = status === 'confirmed' ? 'confirmed' : 'marked as unavailable';
                    alert(`Your attendance has been ${statusText}.`);
                    closeStoryModal();
                    // Refresh stories to show updated status
                    loadScheduleStories(dashboardData?.roles);
                } else {
                    alert('Failed to update availability. Please try again.');
                }
            } catch (error) {
                console.error('Error updating availability:', error);
                alert('Failed to update availability. Please try again.');
            }
        };

        // Forgot PIN
        window.showForgotPin = function() {
            alert('Please contact your league director to reset your PIN.');
        };

        // Logout
        window.logout = function() {
            localStorage.removeItem('brdc_session');
            if (window.FBNav && window.FBNav.logout) {
                window.FBNav.logout();
            }
            showLoginPage();
        };

        // Enter key on PIN input
        document.getElementById('pinInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                window.login();
            }
        });

        // Header button handlers
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            if (window.FBNav && window.FBNav.sidebar) {
                window.FBNav.sidebar.open();
            }
        });

        document.getElementById('searchBtn').addEventListener('click', function() {
            if (window.FBNav && window.FBNav.search) {
                window.FBNav.search.open();
            }
        });

        document.getElementById('chatBtn').addEventListener('click', function() {
            if (window.FBNav && window.FBNav.chatSidebar) {
                window.FBNav.chatSidebar.toggle();
            } else {
                window.location.href = '/pages/messages.html';
            }
        });

        // Close modals on overlay click
        document.querySelectorAll('.fb-modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('visible');
                    document.body.style.overflow = '';
                }
            });
        });
    </script>

    <!-- FB Nav Script (creates footer and sidebar) -->
    <script src="/js/fb-nav.js"></script>
    <script src="/js/stats-helpers.js"></script>
    <script src="/js/display-helpers.js"></script>
    <script src="/js/feedback.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(err => console.error('[SW] Registration failed:', err));
        }
    </script>
</body>
</html>
