<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FF469A">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap');

        :root {
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --text-light: #f0f0f0;
            --text-dim: #8a8aa3;
            --border-color: rgba(255,255,255,0.15);
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { min-height: 100%; overflow-x: hidden; width: 100%; }
        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            color: var(--text-light);
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Header Bar */
        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .back-btn, .logout-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .back-btn:hover, .logout-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--pink);
        }

        .logout-btn { margin-left: auto; }

        /* Floating chat bubble container */
        .chat-bubble-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 9998;
        }

        .floating-chat-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--teal) 0%, #147a94 100%);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(145, 215, 235, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .floating-chat-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(145, 215, 235, 0.6);
        }
        .floating-chat-btn:active {
            transform: scale(0.95);
        }
        .floating-chat-btn .unread-badge {
            position: absolute;
            top: -4px;
            right: -4px;
        }

        /* Expanded chat menu */
        .chat-expanded-menu {
            position: absolute;
            bottom: 60px;
            right: 0;
            display: none;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            padding-bottom: 10px;
        }

        .chat-bubble-container.expanded .chat-expanded-menu {
            display: flex;
            animation: fadeInUp 0.3s ease;
        }

        .chat-bubble-container.expanded .floating-chat-btn {
            background: linear-gradient(135deg, var(--pink) 0%, #c4386a 100%);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Chat room circles (vertical) */
        .chat-rooms-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .chat-room-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-panel);
            border: 2px solid var(--teal);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            font-size: 18px;
            transition: transform 0.2s, border-color 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .chat-room-circle:hover {
            transform: scale(1.1);
            border-color: var(--yellow);
        }

        .chat-room-circle .room-label {
            position: absolute;
            right: 54px;
            background: var(--bg-panel);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            border: 1px solid rgba(255,255,255,0.2);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .chat-room-circle:hover .room-label {
            opacity: 1;
        }

        /* DM circles (horizontal row) */
        .chat-dms-section {
            display: flex;
            flex-direction: row-reverse;
            gap: 8px;
            align-items: center;
        }

        .chat-dm-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-panel);
            border: 2px solid var(--pink);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            font-size: 14px;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .chat-dm-circle:hover {
            transform: scale(1.1);
            border-color: var(--yellow);
        }

        .chat-dm-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-dm-circle .dm-initial {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--pink);
        }

        /* Group DM - overlapping circles */
        .chat-dm-group {
            display: flex;
            flex-direction: row-reverse;
        }

        .chat-dm-group .chat-dm-circle {
            margin-left: -12px;
        }

        .chat-dm-group .chat-dm-circle:last-child {
            margin-left: 0;
        }

        /* Circle unread badge */
        .circle-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--pink);
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-panel);
        }

        .circle-badge.hidden { display: none; }

        .unread-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--pink);
            color: white;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-panel);
        }

        .unread-badge.hidden { display: none; }

        /* League/Tournament Cards */
        .league-team-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-left: 4px solid var(--teal);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }

        .league-team-card.tournament {
            border-left-color: var(--yellow);
        }

        .league-team-card.past {
            opacity: 0.6;
            border-left-color: #666;
        }

        .league-team-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .league-team-header:hover .league-team-name {
            color: var(--yellow);
        }

        .league-team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
            transition: color 0.2s;
        }

        .league-team-card.tournament .league-team-name {
            color: var(--yellow);
        }

        .league-team-league {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-top: 2px;
        }

        .league-team-stats {
            text-align: right;
        }

        .league-team-stats .stat-label {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
        }

        .league-team-stats .stat-value {
            font-size: 16px;
            color: var(--yellow);
            font-weight: bold;
        }

        .teammates-section {
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 12px;
        }

        .teammates-title {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .teammate-row {
            display: flex;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
        }

        .teammate-row:last-child {
            border-bottom: none;
        }

        .teammate-row:hover {
            background: rgba(255,255,255,0.05);
            margin: 0 -10px;
            padding-left: 10px;
            padding-right: 10px;
        }

        .teammate-level {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
            background: rgba(255,255,255,0.1);
        }

        .teammate-level.level-a { background: rgba(255,70,154,0.3); color: var(--pink); }
        .teammate-level.level-b { background: rgba(145,215,235,0.3); color: var(--teal); }
        .teammate-level.level-c { background: rgba(253,216,53,0.3); color: var(--yellow); }

        .teammate-name {
            flex: 1;
            font-size: 14px;
        }

        .teammate-name.captain::after {
            content: ' ‚≠ê';
            font-size: 12px;
        }

        .teammate-stats {
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }

        .teammate-stats span {
            margin-left: 12px;
        }

        .teammate-stats .value {
            color: var(--yellow);
            font-weight: bold;
        }

        /* Team Cards Grid - Clean mobile design */
        .team-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        .team-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .team-card:hover {
            border-color: var(--teal);
            transform: translateY(-2px);
        }

        .team-card.past {
            opacity: 0.5;
        }

        .team-card-league {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .team-card-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
            margin-bottom: 8px;
            line-height: 1.1;
        }

        .team-card-record {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--yellow);
        }

        .team-card-arrow {
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-dim);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .team-card:hover .team-card-arrow {
            opacity: 1;
        }

        .header-logo {
            width: 40px;
            height: 40px;

        }

        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 3px;
            color: var(--pink);
        }

        /* Container */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page */
        .login-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            
        }

        .login-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--pink);
            letter-spacing: 3px;
            margin-bottom: 30px;
        }

        .login-box {
            background: var(--bg-panel);
            border: 3px solid #000;
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: min(380px, 95vw);
            box-shadow: 8px 8px 0 rgba(0,0,0,0.4);
        }

        .login-form-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--teal);
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group { margin-bottom: 16px; }

        .form-label {
            display: block;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 24px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--yellow);
            text-align: center;
            letter-spacing: 4px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--pink);
            background: rgba(255,70,154,0.1);
            box-shadow: 0 0 20px rgba(255,70,154,0.3);
        }

        .form-input::placeholder {
            color: rgba(253, 216, 53, 0.4);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(180deg, var(--pink) 0%, #d63384 100%);
            border: 3px solid #000;
            border-radius: 10px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
        }

        .login-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--danger);
            border-radius: 8px;
            padding: 12px;
            color: #fca5a5;
            font-size: 13px;
            text-align: center;
            margin-bottom: 16px;
        }

        .login-links {
            text-align: center;
        }

        /* Accessibility - Screen Reader Only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus Indicators */
        :focus-visible {
            outline: 2px solid var(--yellow);
            outline-offset: 2px;
        }

        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--yellow);
            outline-offset: 2px;
        }

        /* Skip Link for Accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--yellow);
            color: #000;
            padding: 8px 16px;
            z-index: 9999;
            font-weight: bold;
        }

        .skip-link:focus {
            top: 0;
            margin-top: 20px;
            font-size: 13px;
        }

        .login-links a {
            color: var(--teal);
            text-decoration: none;
        }

        .login-links a:hover { text-decoration: underline; }

        .dashboard-content { display: none; }

        /* Welcome Section */
        /* Profile Header - Clean Mobile-First Design */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            margin-bottom: 15px;
        }

        .player-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--pink), var(--teal));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid #000;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            flex-shrink: 0;
        }

        .player-avatar:hover .avatar-edit-overlay {
            opacity: 1;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-edit-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 18px;
        }

        .avatar-input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }

        .profile-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 1px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-stats-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .profile-stat {
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .profile-stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--yellow);
        }

        .profile-stat-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .profile-link {
            font-size: 12px;
            color: var(--teal);
            text-decoration: none;
            margin-top: 4px;
            display: inline-block;
        }

        .profile-link:hover {
            color: var(--yellow);
            text-decoration: underline;
        }

        /* Player Quick Actions */
        .player-quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .player-quick-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .player-quick-btn:hover {
            border-color: var(--teal);
            transform: translateY(-2px);
        }

        .player-quick-btn .pq-icon {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .player-quick-btn .pq-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .player-quick-btn.active {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .player-quick-btn.active .pq-label {
            color: var(--success);
        }


        /* Verify Stats Card */
        .verify-stats-card {
            background: linear-gradient(135deg, rgba(145, 215, 235, 0.15) 0%, rgba(255, 70, 154, 0.15) 100%);
            border: 2px solid var(--teal);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .verify-stats-card:hover {
            transform: translateY(-2px);
            border-color: var(--pink);
            box-shadow: 0 4px 15px rgba(255, 70, 154, 0.2);
        }

        .verify-stats-card.verified {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%);
            border-color: var(--success);
        }

        .verify-stats-icon {
            font-size: 28px;
            flex-shrink: 0;
        }

        .verify-stats-content {
            flex: 1;
            min-width: 0;
        }

        .verify-stats-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--teal);
            letter-spacing: 1px;
        }

        .verify-stats-card.verified .verify-stats-title {
            color: var(--success);
        }

        .verify-stats-desc {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            margin-top: 2px;
        }

        .verify-stats-badge {
            background: var(--success);
            color: #000;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        /* Verified stats display - expanded view */
        .verify-stats-card.verified {
            cursor: default;
            flex-direction: column;
            align-items: stretch;
            padding: 16px;
        }

        .verify-stats-card.verified:hover {
            transform: none;
            box-shadow: none;
        }

        .verified-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .verified-header .verify-stats-icon {
            font-size: 24px;
        }

        .verified-header .verify-stats-title {
            flex: 1;
        }

        .verified-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .verified-stat-box {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .verified-stat-label {
            font-size: 10px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .verified-stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: var(--yellow);
            line-height: 1;
        }

        .verified-stat-value.pending {
            color: rgba(255,255,255,0.3);
            font-size: 24px;
        }

        .reverify-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 10px;
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .reverify-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--teal);
            color: var(--teal);
        }

        .verified-expires {
            font-size: 10px;
            color: rgba(255,255,255,0.4);
            text-align: center;
            margin-top: 8px;
        }

        .verify-stats-arrow {
            color: var(--teal);
            font-size: 18px;
        }

        /* Profile Actions (gear + admin) */
        .profile-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .settings-icon-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
            line-height: 1;
        }

        .settings-icon-btn:hover {
            transform: rotate(45deg);
        }

        /* Admin Button */
        .admin-btn {
            background: linear-gradient(180deg, var(--yellow) 0%, #f59e0b 100%);
            border: 2px solid #000;
            border-radius: 8px;
            padding: 8px 12px;
            color: #000;
            font-family: 'Bebas Neue', cursive;
            font-size: 12px;
            letter-spacing: 1px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .admin-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 rgba(0,0,0,0.4);
        }

        /* Settings Tab Styles */
        .settings-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .settings-section h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--teal);
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 14px;
        }

        .setting-label small {
            display: block;
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .notification-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255,255,255,0.1);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.sms {
            background: var(--pink);
        }

        .toggle-switch.email {
            background: var(--teal);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.email::after {
            transform: translateX(24px);
        }

        .toggle-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 40px;
        }

        .toggle-label.active {
            color: var(--yellow);
            font-weight: bold;
        }

        .profile-edit-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .profile-edit-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .profile-edit-form label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        .profile-edit-form input {
            padding: 10px 12px;
            background: rgba(255,255,255,0.08);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .profile-edit-form input:focus {
            outline: none;
            border-color: var(--teal);
        }

        .save-btn {
            background: linear-gradient(180deg, var(--pink) 0%, #c4386a 100%);
            border: 2px solid #000;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
        }

        .save-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
        }

        /* Editable Profile Fields */
        .profile-field {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-field:last-child {
            border-bottom: none;
        }

        .profile-field-info {
            flex: 1;
        }

        .profile-field-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .profile-field-value {
            font-size: 15px;
            color: var(--text-primary);
        }

        .profile-field-value.empty {
            color: var(--text-dim);
            font-style: italic;
        }

        .profile-field-edit {
            display: none;
            flex: 1;
        }

        .profile-field-edit input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-dark);
            border: 2px solid var(--teal);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .profile-field-edit input:focus {
            outline: none;
        }

        .profile-field.editing .profile-field-info {
            display: none;
        }

        .profile-field.editing .profile-field-edit {
            display: block;
        }

        .profile-field.editing .edit-btn {
            display: none;
        }

        .profile-field.editing .save-field-btn,
        .profile-field.editing .cancel-field-btn {
            display: inline-flex;
        }

        .edit-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--teal);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-btn:hover {
            background: rgba(145, 215, 235, 0.2);
            border-color: var(--teal);
        }

        .edit-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .edit-btn.disabled:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--border-color);
        }

        .save-field-btn, .cancel-field-btn {
            display: none;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-left: 6px;
        }

        .save-field-btn {
            background: var(--success);
            color: white;
        }

        .cancel-field-btn {
            background: rgba(255,255,255,0.1);
            color: var(--text-dim);
        }

        .profile-field-actions {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .field-locked-hint {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        /* Privacy Toggle Styles */
        .privacy-setting {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .privacy-setting:last-child {
            border-bottom: none;
        }

        .privacy-info {
            flex: 1;
        }

        .privacy-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .privacy-desc {
            font-size: 11px;
            color: var(--text-dim);
        }

        .privacy-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .privacy-toggle.on {
            background: var(--success);
        }

        .privacy-toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .privacy-toggle.on::after {
            transform: translateX(20px);
        }

        /* Tabs */
        .tab-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            border-bottom: 3px solid var(--border-color);
            padding-bottom: 5px;
        }

        .tab {
            background: rgba(0,0,0,0.3);
            border: 2px solid transparent;
            padding: 12px 20px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px 8px 0 0;
        }

        .tab:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        .tab.active {
            background: var(--pink);
            color: white;
            border-color: var(--pink);
        }

        .tab.captain-tab {
            display: none;
        }

        .tab.captain-tab.show {
            display: block;
            background: rgba(145, 215, 235, 0.2);
        }

        .tab.captain-tab.show.active {
            background: var(--teal);
            color: #000;
        }

        .tab.director-tab.show {
            display: block;
            background: rgba(255, 215, 0, 0.2);
        }

        .tab.director-tab.show.active {
            background: var(--yellow);
            color: #000;
        }

        /* Sub-tabs (inside main tabs) */
        .sub-tab-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
        }

        .sub-tab {
            background: rgba(0,0,0,0.2);
            border: none;
            padding: 10px 18px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 1px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px 6px 0 0;
        }

        .sub-tab:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        .sub-tab.active {
            background: var(--teal);
            color: #000;
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        .director-list {
            display: grid;
            gap: 12px;
        }

        .director-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-card);
            border: 3px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .director-item:hover {
            border-color: var(--yellow);
            transform: translateY(-2px);
        }

        .director-item-info h4 {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .director-item-info p {
            font-size: 12px;
            color: var(--text-dim);
        }

        .director-item-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .director-item-status.active { background: var(--success); color: #000; }
        .director-item-status.registration { background: var(--teal); color: #000; }
        .director-item-status.draft { background: var(--yellow); color: #000; }

        /* History Tab Styles */
        .history-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .history-filters select {
            padding: 10px 15px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            min-width: 150px;
        }

        .match-history-item {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .match-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border-color);
        }

        .match-history-date {
            font-size: 12px;
            color: var(--text-dim);
        }

        .match-history-league {
            font-size: 11px;
            color: var(--teal);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .match-history-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
        }

        .match-history-team {
            text-align: center;
            flex: 1;
        }

        .match-history-team.winner {
            color: var(--yellow);
        }

        .match-history-team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
        }

        .match-history-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            padding: 0 20px;
            color: var(--pink);
        }

        .match-history-result {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 20px;
            margin-top: 5px;
            display: inline-block;
        }

        .match-history-result.win { background: var(--success); color: white; }
        .match-history-result.loss { background: var(--danger); color: white; }
        .match-history-result.tie { background: var(--yellow); color: #000; }

        .match-history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid var(--border-color);
        }

        .match-history-stat {
            text-align: center;
        }

        .match-history-stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
        }

        .match-history-stat-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        /* Stats Tab Styles */
        .stats-filters, .stats-source-filter {
            margin-bottom: 20px;
        }

        .stats-filters select, .stats-source-filter select {
            padding: 10px 15px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            min-width: 200px;
            width: 100%;
            max-width: 300px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-card .stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--pink);
            line-height: 1;
        }

        .stat-card .stat-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .stats-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-section h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-name {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-val {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: white;
        }

        /* Achievements Grid */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .achievement {
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.2s;
        }

        .achievement.unlocked {
            border-color: var(--yellow);
            background: rgba(253, 216, 53, 0.1);
        }

        .achievement.locked {
            opacity: 0.5;
        }

        .achievement-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .achievement-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .achievement-desc {
            font-size: 10px;
            color: var(--text-dim);
        }

        .achievement-progress {
            margin-top: 8px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .achievement-progress-bar {
            height: 100%;
            background: var(--yellow);
            transition: width 0.3s;
        }
        .director-item-status.completed { background: #666; color: #fff; }

        /* Game Day Control Styles */
        .gameday-section {
            background: linear-gradient(135deg, rgba(255, 70, 154, 0.1) 0%, rgba(145, 215, 235, 0.05) 100%);
            border: 2px solid rgba(255, 70, 154, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .gameday-league-selector select {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            font-weight: 600;
            background: var(--bg-card);
            border: 3px solid var(--pink);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .gameday-matches-section {
            margin-bottom: 20px;
        }

        .gameday-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .gameday-header h4 {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
        }

        .gameday-week-badge {
            background: var(--pink);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .gameday-match-cards {
            display: grid;
            gap: 10px;
        }

        .gameday-match-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 16px;
            gap: 10px;
        }

        .gameday-match-card.in-progress {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, var(--bg-card) 100%);
        }

        .gameday-match-card.completed {
            border-color: #666;
            opacity: 0.7;
        }

        .match-card-teams {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .match-card-team {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .match-card-team.winner {
            color: var(--success);
            font-weight: 700;
        }

        .match-card-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            min-width: 50px;
            text-align: center;
            color: var(--yellow);
        }

        .match-card-status {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .match-card-status.scheduled { background: var(--bg-panel); color: var(--text-dim); }
        .match-card-status.in-progress { background: var(--success); color: #000; }
        .match-card-status.completed { background: #666; color: #fff; }

        .gameday-actions-section {
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .gameday-action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .gameday-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 10px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 600;
        }

        .gameday-action-btn:hover {
            border-color: var(--teal);
            background: rgba(145, 215, 235, 0.1);
        }

        .gameday-action-btn .action-icon {
            font-size: 20px;
        }

        .gameday-level-message {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px;
        }

        .gameday-level-message label {
            font-size: 12px;
            color: var(--text-dim);
            display: block;
            margin-bottom: 8px;
        }

        .level-buttons {
            display: flex;
            gap: 8px;
        }

        .level-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            transition: all 0.2s;
        }

        .level-btn:hover {
            border-color: var(--yellow);
            background: rgba(253, 216, 53, 0.15);
        }

        /* Substitution Modal Styles */
        .sub-form-group {
            margin-bottom: 16px;
        }

        .sub-form-group label {
            display: block;
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sub-form-group select,
        .sub-form-group input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .sub-form-group select:focus,
        .sub-form-group input:focus {
            border-color: var(--teal);
            outline: none;
        }

        /* Message Modal Styles */
        .message-recipients {
            margin-bottom: 16px;
        }

        .message-recipients label {
            display: block;
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .recipients-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 100px;
            overflow-y: auto;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .recipient-chip {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(145, 215, 235, 0.2);
            border-radius: 20px;
            font-size: 12px;
            color: var(--teal);
        }

        .recipient-count {
            font-size: 12px;
            color: var(--text-dim);
        }

        .message-form-group {
            margin-bottom: 16px;
        }

        .message-form-group label {
            display: block;
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .message-form-group textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            resize: vertical;
        }

        .message-form-group textarea:focus {
            border-color: var(--teal);
            outline: none;
        }

        .message-templates label {
            display: block;
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .template-btn {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-btn:hover {
            background: rgba(255, 70, 154, 0.2);
            border-color: var(--pink);
            color: var(--pink);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Calendar Styles */
        .calendar-container {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cal-month {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 1px;
        }

        .cal-nav {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .cal-nav:hover {
            background: var(--pink);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 5px;
        }

        .cal-day-header {
            text-align: center;
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            padding: 5px;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        /* Week view (collapsed) - horizontal scroll with arrows on sides */
        .calendar-week-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .calendar-week-row .cal-nav {
            flex-shrink: 0;
        }

        .calendar-days.week-view {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            flex: 1;
            padding: 2px 0;
        }

        .calendar-days.week-view::-webkit-scrollbar {
            display: none;
        }

        .calendar-days.week-view .cal-day {
            flex: 0 0 auto;
            width: calc((100% - 36px) / 7);
            min-width: 38px;
            aspect-ratio: unset;
            min-height: 48px;
            padding: 4px;
            scroll-snap-align: start;
            position: relative;
        }

        .calendar-days.week-view .cal-day .cal-day-name {
            position: absolute;
            top: 3px;
            left: 5px;
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .calendar-days.week-view .cal-day .cal-day-num {
            font-size: 18px;
            font-weight: 600;
            margin-top: -2px;
        }

        /* Week view: dots on bottom */
        .calendar-days.week-view .cal-day.has-event::after {
            bottom: 4px;
            top: auto;
            right: auto;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
        }

        .calendar-days.week-view .cal-day.has-multiple::after {
            width: 10px;
            border-radius: 3px;
        }


        /* Week view header - centered month */
        .calendar-week-header {
            text-align: center;
            margin-bottom: 8px;
        }

        .calendar-week-header .cal-month {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
        }

        /* Expand link below week row */
        .calendar-expand-link {
            display: block;
            text-align: center;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-dim);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }

        .calendar-expand-link:hover {
            color: var(--teal);
        }

        /* Full month view - hidden by default */
        .calendar-full-month {
            display: none;
            margin-top: 10px;
        }

        .calendar-full-month.expanded {
            display: block;
        }

        .cal-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            min-height: 40px;
        }

        .cal-day:hover {
            background: rgba(255,255,255,0.1);
        }

        .cal-day.other-month {
            color: var(--text-dim);
            opacity: 0.4;
        }

        .cal-day.today {
            background: rgba(255, 70, 154, 0.2);
            border: 2px solid var(--pink);
        }

        .cal-day.selected {
            background: rgba(145, 215, 235, 0.3);
            border: 2px solid var(--teal);
            box-shadow: 0 0 8px rgba(145, 215, 235, 0.4);
        }

        .cal-day.today.selected {
            background: linear-gradient(135deg, rgba(255, 70, 154, 0.2), rgba(145, 215, 235, 0.3));
            border: 2px solid var(--teal);
        }

        .cal-day.has-event {
            background: rgba(145, 215, 235, 0.15);
        }

        .cal-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4CAF50; /* Green for leagues */
        }

        .cal-day.has-tournament::after {
            background: var(--yellow);
        }

        /* Participating indicator - ring around the dot */

        .cal-day.has-multiple::after {
            width: 12px;
            border-radius: 3px;
        }

        /* Event Popup */
        .event-popup {
            background: var(--bg-panel);
            border: 3px solid var(--pink);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .event-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .event-popup-header span {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
        }

        .popup-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 18px;
            cursor: pointer;
        }

        .popup-close:hover {
            color: var(--pink);
        }

        .event-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .event-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .event-item:last-child {
            margin-bottom: 0;
        }

        .event-type-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .event-type-badge.league {
            background: var(--teal);
            color: #000;
        }

        .event-type-badge.tournament {
            background: var(--yellow);
            color: #000;
        }

        .event-type-badge.social {
            background: var(--pink);
            color: white;
        }

        .event-type-badge.upcoming-tournament {
            background: #FF9800;
            color: #000;
        }

        .event-type-badge.deadline {
            background: #e53935;
            color: white;
        }

        /* Calendar Legend */
        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            justify-content: center;
        }

        .calendar-legend.compact {
            gap: 12px;
            padding: 8px;
            margin-top: 8px;
            font-size: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--text-dim);
        }

        .calendar-legend.compact .legend-item {
            font-size: 10px;
            gap: 4px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .calendar-legend.compact .legend-dot {
            width: 6px;
            height: 6px;
        }

        .legend-dot.league { background: #4CAF50; }
        .legend-dot.tournament { background: var(--yellow); }
        .legend-dot.upcoming-tournament { background: #FF9800; }
        .legend-dot.deadline { background: #e53935; }
        .legend-dot.social { background: var(--pink); }

        /* Single Day View (replaces event-popup, shown inline below calendar) */
        /* RULE 8: Container has no border - only the match card has colored border */
        .single-day-view {
            background: var(--bg-panel);
            border: none;
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
        }

        .single-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .single-day-header span {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
        }

        .single-day-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 18px;
            cursor: pointer;
        }

        .single-day-close:hover {
            color: var(--pink);
        }

        .single-day-content .match-card:last-child {
            margin-bottom: 0;
        }

        /* Calendar day indicators for different event types */
        .cal-day.has-deadline::before {
            content: '';
            position: absolute;
            bottom: 4px;
            left: calc(50% - 10px);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #e53935;
        }

        .cal-day.has-upcoming::before {
            content: '';
            position: absolute;
            bottom: 4px;
            left: calc(50% + 4px);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #FF9800;
        }

        .cal-day.has-social::after {
            background: var(--pink) !important;
        }

        /* Match Card Layout */
        .match-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }

        .match-card.event-league {
            border-color: var(--teal);
        }

        .match-card.event-tournament {
            border-color: var(--yellow);
        }

        .match-card.event-upcoming-tournament {
            border-color: #FF9800;
        }

        .match-card.event-deadline {
            border-color: #e53935;
        }

        .match-card.event-social {
            border-color: var(--pink);
        }

        /* Tournament Card Styles */
        .tournament-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-bottom: 2px solid #000;
        }

        .tournament-card-title-section {
            flex: 1;
        }

        .tournament-card-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 1px;
            color: var(--yellow);
        }

        .tournament-card-venue {
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .tournament-card-info-section {
            text-align: right;
        }

        .tournament-card-date {
            font-size: 12px;
            color: var(--text);
            margin-bottom: 5px;
        }

        .tournament-status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .tournament-status-badge.upcoming {
            background: rgba(255, 152, 0, 0.2);
            color: #FF9800;
        }

        .tournament-status-badge.live {
            background: rgba(233, 30, 99, 0.2);
            color: var(--pink);
        }

        .tournament-status-badge.completed {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .tournament-card-stats {
            display: flex;
            justify-content: space-around;
            padding: 12px 15px;
            background: rgba(0,0,0,0.15);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .tournament-card-stat {
            text-align: center;
        }

        .tournament-card-stat .stat-value {
            display: block;
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--yellow);
        }

        .tournament-card-stat .stat-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .tournament-card-events {
            padding: 10px 15px;
        }

        .tournament-card-event {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .tournament-card-event:last-child {
            margin-bottom: 0;
        }

        .tournament-card-event.registered {
            background: rgba(76, 175, 80, 0.15);
            border-left: 3px solid #4CAF50;
        }

        .tournament-card-event-name {
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tournament-card-event-name .registered-check {
            color: #4CAF50;
            font-size: 14px;
        }

        .tournament-card-event-info {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--text-dim);
        }

        .tournament-card-event-signups {
            color: var(--yellow);
        }

        .match-card-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 14px 12px;
            background: rgba(0,0,0,0.4);
            border-bottom: 2px solid rgba(0,0,0,0.5);
            gap: 6px;
        }

        .match-card-header.completed {
            grid-template-columns: 1fr auto 1fr;
            background: rgba(0,0,0,0.5);
        }

        .match-team-side {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .match-team-side.left {
            align-items: flex-end;
            text-align: right;
            padding-right: 8px;
        }

        .match-team-side.right {
            align-items: flex-start;
            text-align: left;
            padding-left: 8px;
        }

        .match-team-info-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .match-team-side.left .match-team-info-row {
            justify-content: flex-end;
        }

        .match-team-side.right .match-team-info-row {
            justify-content: flex-start;
        }

        .match-team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 1px;
            color: #fff;
        }

        .match-header-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 42px;
            color: var(--text-primary);
            line-height: 1;
            min-width: 30px;
            text-align: center;
        }

        .match-header-score.winner {
            color: var(--yellow);
        }

        .match-team-record {
            display: inline-block;
            font-size: 8px;
            color: #555;
            font-weight: 500;
            background: transparent;
            padding: 0;
            vertical-align: middle;
        }

        .match-team-standing {
            font-size: 11px;
            color: var(--yellow);
            font-weight: 700;
            margin: 0 2px;
        }

        .match-team-avg {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .match-team-avg .better { color: #4ade80; }
        .match-team-avg .worse { color: #f87171; }

        .match-team-side.winner .match-team-name {
            color: var(--yellow);
        }

        .winner-star-slot {
            display: grid;
            place-items: center;
            height: 100%;
            width: 100%;
        }

        .winner-star {
            color: #FFD700;
            font-size: 20px;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
            line-height: 1;
        }

        @keyframes star-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.9; }
        }

        .match-center {
            text-align: center;
            padding: 0 15px;
        }

        .match-week {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        .match-vs {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--pink);
            line-height: 1;
        }

        .match-card-body {
            display: block;
            padding: 8px 10px;
        }

        .match-roster {
            padding: 8px;
        }

        .match-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .match-row:last-child {
            border-bottom: none;
        }

        .match-player-cell {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            font-size: 11px;
            flex: 1;
            min-width: 0;
        }

        .match-player-cell.left {
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .match-player-cell.right {
            text-align: right;
        }


        .match-roster-title {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 6px;
            letter-spacing: 1px;
        }

        .match-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .match-player:last-child {
            border-bottom: none;
        }

        .match-player-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .match-player-name.captain::before {
            content: '‚òÖ ';
            color: var(--yellow);
        }

        .match-player-stats {
            color: var(--text-dim);
            font-size: 10px;
            text-align: right;
        }

        .match-card-footer {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.1);
            gap: 8px;
        }

        .match-card-footer > *:nth-child(1) {
            justify-self: start;
        }

        .match-card-footer > *:nth-child(2) {
            justify-self: center;
        }

        .match-card-footer > *:nth-child(3) {
            justify-self: center;
        }

        .match-card-footer > *:nth-child(4) {
            justify-self: end;
        }

        /* Match Night Button */
        .match-night-btn-container {
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-top: 2px solid rgba(145, 215, 235, 0.3);
        }

        .match-night-btn {
            display: block;
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, var(--teal) 0%, #5BC0BE 100%);
            color: #000;
            text-align: center;
            text-decoration: none;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 2px;
            border: 3px solid #000;
            border-radius: 8px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
            transition: all 0.15s ease;
        }

        .match-night-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,0.5);
            background: linear-gradient(135deg, #A8E6CF 0%, var(--teal) 100%);
        }

        .match-night-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        .match-hub-btn {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(145, 215, 235, 0.15);
            border: 1px solid var(--teal);
            color: var(--teal);
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 4px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .match-hub-btn:hover {
            background: var(--teal);
            color: #000;
        }

        .attendance-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 6px 10px;
            min-width: 100px;
            border: 1px solid;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .attendance-btn .btn-icon {
            font-size: 12px;
            font-weight: bold;
        }

        .attendance-btn.confirm {
            background: rgba(76, 175, 80, 0.15);
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .attendance-btn.confirm:hover {
            background: #4CAF50;
            color: #000;
        }

        .attendance-btn.confirm.active {
            background: #4CAF50;
            color: #000;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .attendance-btn.cant-make {
            background: rgba(244, 67, 54, 0.15);
            border-color: #F44336;
            color: #F44336;
        }

        .attendance-btn.cant-make:hover {
            background: #F44336;
            color: #fff;
        }

        .attendance-btn.cant-make.active {
            background: #F44336;
            color: #fff;
            box-shadow: 0 0 10px rgba(244, 67, 54, 0.5);
        }

        .match-card-link {
            display: inline-block;
            padding: 6px 16px;
            background: var(--teal);
            color: #000;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 4px;
            text-decoration: none;
            cursor: pointer;
        }

        .match-card-link:hover {
            background: var(--yellow);
        }

        /* Events Footer - Simple collapsed state (just More Info) */
        .match-card-footer.events-collapsed {
            display: flex;
            justify-content: center;
            padding: 10px 12px;
            background: rgba(0,0,0,0.15);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        /* Events Footer - Expanded state wrapper */
        .match-card-footer.events-expanded-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .events-expanded-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
            align-items: center;
        }

        .events-expanded-buttons:not(.centered) > *:nth-child(1) {
            justify-self: start;
        }

        .events-expanded-buttons:not(.centered) > *:nth-child(2),
        .events-expanded-buttons:not(.centered) > *:nth-child(3) {
            justify-self: center;
        }

        .events-expanded-buttons:not(.centered) > *:nth-child(4) {
            justify-self: end;
        }

        .events-expanded-buttons.centered {
            grid-template-columns: 1fr 1fr;
        }

        .events-expanded-buttons.centered > * {
            justify-self: center;
        }

        .more-info-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            padding: 4px 8px;
            transition: color 0.2s ease;
        }

        .more-info-btn:hover {
            color: var(--teal);
        }

        .more-info-btn .expand-icon {
            font-size: 10px;
            transition: transform 0.2s ease;
        }

        .more-info-btn.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .expand-match-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(145, 215, 235, 0.15);
            border: 1px solid var(--teal);
            border-radius: 4px;
            color: var(--teal);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .expand-match-btn:hover {
            background: var(--teal);
            color: #000;
        }

        .expand-match-btn .expand-icon {
            font-size: 10px;
            transition: transform 0.2s ease;
        }

        .expand-match-btn.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .match-card-body.collapsed {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .match-card-body.collapsed.expanded {
            max-height: 500px;
        }

        /* Compact Events Card Layout */
        .events-card-compact {
            padding: 10px 12px;
            background: rgba(0,0,0,0.15);
        }

        .events-card-week {
            font-family: 'Bebas Neue', cursive;
            font-size: 12px;
            color: var(--teal);
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .events-card-teams {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 6px;
        }

        .events-team-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .events-team-row.winner .events-team-name {
            color: var(--yellow);
        }

        .events-team-name {
            font-weight: 700;
            color: var(--text-light);
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .events-team-record {
            color: var(--text-dim);
            font-size: 11px;
        }

        .events-team-score {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-light);
            min-width: 20px;
            text-align: center;
        }

        .events-team-row.winner .events-team-score {
            color: var(--yellow);
        }

        .events-winner-star {
            color: var(--yellow);
            font-size: 12px;
        }

        .events-card-stats {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-dim);
            padding-top: 6px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .events-stats-vs {
            color: var(--text-dim);
            font-size: 10px;
            text-transform: uppercase;
        }

        .events-card-stats .better {
            color: #4CAF50;
        }

        .events-card-stats .worse {
            color: #F44336;
        }

        /* Events View Toggle */
        .events-toggle-btns {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .events-toggle-btn {
            flex: 1;
            padding: 12px 20px;
            background: rgba(255,255,255,0.05);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-dim);
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .events-toggle-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .events-toggle-btn.active {
            background: var(--pink);
            border-color: var(--pink);
            color: #fff;
        }

        /* Event Type Filters */
        .event-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 6px 14px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-dim);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            background: rgba(255,255,255,0.1);
        }

        .filter-chip.active {
            background: var(--teal);
            border-color: var(--teal);
            color: #000;
        }

        /* Events List Container */
        .events-list-container {
            max-height: 600px;
            overflow-y: auto;
        }

        /* Collapsible Event Cards */
        .event-card-collapsible {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }

        .event-card-collapsible.event-league {
            border-color: var(--teal);
        }

        .event-card-collapsible.event-tournament {
            border-color: var(--yellow);
        }

        .event-card-header {
            display: flex;
            align-items: center;
            padding: 12px;
            cursor: pointer;
            background: rgba(0,0,0,0.2);
        }

        .event-card-header:hover {
            background: rgba(0,0,0,0.3);
        }

        .event-card-expand-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-dim);
            transition: transform 0.2s;
            margin-right: 10px;
        }

        .event-card-collapsible.expanded .event-card-expand-icon {
            transform: rotate(90deg);
        }

        .event-card-summary {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .event-card-type-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .event-card-type-badge.league {
            background: var(--teal);
            color: #000;
        }

        .event-card-type-badge.tournament {
            background: var(--yellow);
            color: #000;
        }

        .event-card-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            flex: 1;
        }

        .event-card-date {
            font-size: 12px;
            color: var(--text-dim);
        }

        .event-card-body {
            display: none;
            padding: 0;
            border-top: 2px solid rgba(255,255,255,0.1);
        }

        .event-card-collapsible.expanded .event-card-body {
            display: block;
        }

        /* Player stat comparison colors - applied to individual stat spans */
        .match-player-stats .better {
            color: #4CAF50;
            font-weight: 600;
        }

        .match-player-stats .worse {
            color: #F44336;
            font-weight: 600;
        }

        /* Team combined stats in header */
        .match-team-avg {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .match-team-avg .better {
            color: #4CAF50;
            font-weight: 600;
        }

        .match-team-avg .worse {
            color: #F44336;
            font-weight: 600;
        }


        /* Fill-in player styling */
        .match-player-name.fill-in,
        .player-name.fill-in {
            color: var(--yellow);
            font-style: italic;
        }

        .fill-in-badge {
            display: inline-block;
            font-size: 8px;
            font-weight: 700;
            background: var(--yellow);
            color: #000;
            padding: 1px 4px;
            border-radius: 3px;
            vertical-align: middle;
            margin: 0 2px;
            font-style: normal;
        }

        /* OUT player styling (players who were subbed out) */
        .match-row.out-row {
            opacity: 0.6;
            border-top: 1px dashed rgba(255,255,255,0.1);
            padding-top: 4px;
            margin-top: 4px;
        }

        .match-player-name.out {
            color: var(--text-dim);
            font-style: italic;
        }

        .match-player-stats.out-stats {
            color: var(--text-dim);
        }

        .out-badge {
            display: inline-block;
            font-size: 8px;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            color: var(--text-dim);
            padding: 1px 4px;
            border-radius: 3px;
            vertical-align: middle;
            margin: 0 2px;
            font-style: normal;
        }

        /* Captain schedule card badges */
        .your-team-badge {
            display: inline-block;
            font-size: 9px;
            font-weight: 700;
            background: var(--pink);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            vertical-align: middle;
            margin-right: 6px;
            letter-spacing: 0.5px;
        }

        .need-sub-badge {
            display: inline-block;
            font-size: 8px;
            font-weight: 700;
            background: #ef4444;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            vertical-align: middle;
            margin: 0 2px;
        }

        .confirmed-badge {
            color: #22c55e;
            font-size: 12px;
            margin: 0 2px;
        }

        .unavail-badge {
            color: #ef4444;
            font-size: 12px;
            margin: 0 2px;
        }

        /* Captain match card footer */
        .match-card-footer.captain-footer {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px 14px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .captain-action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            border: none;
            background: var(--pink);
            color: white;
        }

        .captain-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 70, 154, 0.3);
        }

        .captain-action-btn.secondary {
            background: transparent;
            border: 2px solid var(--teal);
            color: var(--teal);
        }

        .captain-action-btn.secondary:hover {
            background: var(--teal);
            color: var(--bg-dark);
            box-shadow: 0 4px 12px rgba(145, 215, 235, 0.3);
        }

        /* Tournament event card expanded content */
        .tournament-events-list {
            padding: 12px;
        }

        .tournament-event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .tournament-event-item:last-child {
            margin-bottom: 0;
        }

        .tournament-event-name {
            font-weight: 600;
            font-size: 13px;
        }

        .tournament-event-time {
            font-size: 12px;
            color: var(--text-dim);
        }

        .tournament-event-signups {
            font-size: 12px;
            color: var(--teal);
            font-weight: 600;
        }

        .event-card-footer {
            padding: 10px 12px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        /* Match card in events view - collapsible */
        .match-card-collapsible {
            border-left: 4px solid var(--teal);
        }

        .match-card-collapsible.win {
            border-left-color: #4CAF50;
        }

        .match-card-collapsible.loss {
            border-left-color: #F44336;
        }

        .match-card-collapsible .match-header {
            gap: 12px;
        }

        .match-card-header-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .match-week-badge {
            background: var(--teal);
            color: #000;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
        }

        .match-card-collapsible.win .match-week-badge {
            background: #4CAF50;
        }

        .match-card-collapsible.loss .match-week-badge {
            background: #F44336;
            color: #fff;
        }

        .match-league-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            color: var(--text-light);
        }

        .match-status-badge {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dim);
        }

        .match-status-badge.win {
            color: #4CAF50;
        }

        .match-status-badge.loss {
            color: #F44336;
        }

        /* Deadline cards */
        .deadline-card {
            border-left: 4px solid var(--yellow);
        }

        .deadline-card.urgent {
            border-left-color: #F44336;
        }

        .deadline-card.soon {
            border-left-color: #FF9800;
        }

        .deadline-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .deadline-date {
            font-size: 12px;
            color: var(--text-light);
        }

        .deadline-countdown {
            font-size: 11px;
            color: var(--text-dim);
        }

        .deadline-countdown.urgent {
            color: #F44336;
            font-weight: 600;
        }

        .deadline-countdown.soon {
            color: #FF9800;
            font-weight: 600;
        }

        /* Info cards */
        .info-card .event-card-header {
            cursor: pointer;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-dim);
        }

        .status-dot.active {
            background: #4CAF50;
        }

        /* Non-league event items */
        .event-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }

        .event-card:hover {
            background: var(--bg-panel);
        }

        .event-details {
            flex: 1;
        }

        .event-title {
            font-weight: 600;
            font-size: 14px;
        }

        .event-subtitle {
            font-size: 12px;
            color: var(--text-dim);
        }

        .stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--yellow);
        }

        .stat-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
        }

        .stats-link {
            text-align: center;
            margin-bottom: 20px;
        }

        .stats-link a {
            color: var(--teal);
            font-size: 13px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .stats-link a:hover {
            color: var(--yellow);
            text-decoration: underline;
        }

        /* Team Selector */
        .team-selector {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .team-selector label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 8px;
            display: block;
        }

        .team-selector select {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        /* Team Name Editor */
        .team-name-editor {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .team-name-display {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .team-name-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }
        .team-name-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--primary-pink);
            flex: 1;
        }
        .edit-team-name-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-dim);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        .edit-team-name-btn:hover {
            border-color: var(--primary-pink);
            color: var(--primary-pink);
        }
        .team-name-edit {
            margin-top: 10px;
        }
        .team-name-edit input {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .team-name-edit input:focus {
            outline: none;
            border-color: var(--primary-pink);
        }
        .team-name-buttons {
            display: flex;
            gap: 10px;
        }
        .save-name-btn {
            flex: 1;
            padding: 10px;
            background: var(--primary-pink);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            cursor: pointer;
        }
        .cancel-name-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-dim);
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            cursor: pointer;
        }

        /* Schedule Table */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        .schedule-table th {
            background: var(--bg-panel);
            padding: 15px;
            text-align: left;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 1px;
            color: var(--teal);
        }

        .schedule-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .schedule-table tr:last-child td {
            border-bottom: none;
        }

        .availability-btns {
            display: flex;
            gap: 8px;
        }

        .avail-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            background: transparent;
            color: white;
        }

        .avail-btn.confirm {
            border-color: var(--success);
            color: var(--success);
        }

        .avail-btn.confirm:hover, .avail-btn.confirm.selected {
            background: var(--success);
            color: #000;
        }

        .avail-btn.cant {
            border-color: var(--danger);
            color: var(--danger);
        }

        .avail-btn.cant:hover, .avail-btn.cant.selected {
            background: var(--danger);
            color: white;
        }

        .match-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .match-status.upcoming { background: var(--yellow); color: #000; }
        .match-status.completed { background: var(--success); color: #000; }
        .match-status.in-progress { background: var(--pink); color: white; }

        /* New Match Card Layout */
        .match-cards-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .match-section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--teal);
            letter-spacing: 1px;
            margin: 20px 0 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        .match-section-title:first-child {
            margin-top: 0;
        }

        /* Note: Primary .match-card styles are defined earlier in the file */
        /* This only adds the past state modifier */
        .match-card.past {
            opacity: 0.8;
        }

        /* Match date in old card style (preserved for backwards compatibility) */
        .match-date {
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }

        @media (max-width: 700px) {
            .match-avail-btn {
                width: 100% !important;
                border-radius: 0 !important;
            }

            .match-team-section {
                padding: 10px !important;
            }

            .match-center-divider {
                display: none;
            }
        }

        .match-avail-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 12px;
            width: 70px;
            border: none;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .match-avail-btn .icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .match-avail-btn.cant-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .match-avail-btn.cant-btn:hover,
        .match-avail-btn.cant-btn.selected {
            background: #ef4444;
            color: white;
        }

        .match-avail-btn.in-btn {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .match-avail-btn.in-btn:hover,
        .match-avail-btn.in-btn.selected {
            background: #22c55e;
            color: white;
        }

        .match-avail-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .match-team-section {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .match-team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .match-team-header .match-team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--teal);
            cursor: pointer;
        }

        .match-team-header .match-team-name:hover {
            color: var(--pink);
        }

        .match-team-header .match-team-record {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }

        .match-player-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            font-size: 13px;
        }

        .match-player-row.unavailable {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .match-player-row.sub {
            background: rgba(253, 216, 53, 0.15);
            border: 1px solid rgba(253, 216, 53, 0.3);
        }

        .match-player-row.confirmed {
            background: rgba(34, 197, 94, 0.1);
        }

        .match-player-level {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--pink);
            width: 20px;
        }

        .match-player-name {
            flex: 0 0 auto;
            cursor: pointer;
        }

        .match-player-name:hover {
            color: var(--pink);
        }

        .match-player-stats {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
        }

        .match-center-divider {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            min-width: 90px;
            background: var(--bg-panel);
            border-left: 2px solid var(--border-color);
            border-right: 2px solid var(--border-color);
        }

        .match-center-week {
            font-family: 'Bebas Neue', cursive;
            font-size: 26px;
            color: var(--pink);
            letter-spacing: 2px;
            line-height: 1;
        }

        .match-center-date {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
        }

        .match-result {
            text-align: center;
            padding: 8px;
            background: var(--bg-panel);
            border-top: 2px solid var(--border-color);
        }

        .match-result-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--pink);
        }

        .match-result-score.won {
            color: var(--success);
        }

        .match-result-score.lost {
            color: #ef4444;
        }

        .match-result-label {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* All Teams View */
        .all-teams-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .all-teams-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: var(--bg-panel);
            cursor: pointer;
            border-bottom: 2px solid var(--border-color);
        }

        .all-teams-header:hover {
            background: rgba(255,255,255,0.05);
        }

        .all-teams-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
            letter-spacing: 1px;
        }

        .all-teams-league {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            flex: 1;
        }

        .all-teams-expand {
            font-size: 12px;
            color: rgba(255,255,255,0.4);
        }

        .all-teams-next .match-card {
            border: none;
            border-radius: 0;
        }

        .all-teams-full {
            padding: 10px;
            border-top: 2px solid var(--border-color);
        }

        .all-teams-full .match-card {
            margin-bottom: 10px;
        }

        /* Roster Cards */
        .roster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .roster-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .roster-card.captain-card {
            border-color: var(--teal);
        }

        .player-position {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--teal);
            margin-bottom: 5px;
        }

        .player-name-roster {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .player-stats-mini {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-mini {
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-mini-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .stat-mini-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--yellow);
        }

        /* Contact Section */
        .contact-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .contact-section h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
            margin-bottom: 15px;
        }

        .contact-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 15px;
        }

        .contact-textarea:focus {
            outline: none;
            border-color: var(--teal);
        }

        .recipient-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .recipient-checkboxes label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .send-btn {
            background: linear-gradient(180deg, var(--teal) 0%, #5ba3b5 100%);
            border: 3px solid #000;
            border-radius: 10px;
            padding: 14px 30px;
            color: #000;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }

        .send-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        /* Captain Sub-tabs */
        .captain-subtabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .captain-subtab {
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--border-color);
            padding: 10px 18px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: white;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .captain-subtab:hover {
            background: rgba(255,255,255,0.1);
        }

        .captain-subtab.active {
            background: var(--teal);
            color: #000;
            border-color: var(--teal);
        }

        .captain-subcontent {
            display: none;
        }

        .captain-subcontent.active {
            display: block;
        }

        /* Urgent Sub Banner */
        .urgent-sub-banner {
            background: linear-gradient(135deg, rgba(255, 70, 154, 0.2) 0%, rgba(239, 68, 68, 0.2) 100%);
            border: 2px solid var(--pink);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            animation: urgentPulse 2s ease-in-out infinite;
        }

        @keyframes urgentPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 70, 154, 0.4); }
            50% { box-shadow: 0 0 20px 4px rgba(255, 70, 154, 0.2); }
        }

        .urgent-sub-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .urgent-icon {
            font-size: 28px;
        }

        .urgent-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .urgent-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--pink);
            letter-spacing: 1px;
        }

        .urgent-subtitle {
            font-size: 12px;
            color: var(--text-dim);
        }

        .urgent-sub-btn {
            background: linear-gradient(180deg, var(--pink) 0%, #cc3879 100%);
            color: white;
            border: 2px solid #000;
            padding: 12px 20px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.4);
            transition: all 0.15s;
            white-space: nowrap;
        }

        .urgent-sub-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0 rgba(0,0,0,0.4);
        }

        /* ========== ROSTER TAB STYLES ========== */
        .roster-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .roster-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .roster-section-header h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            color: var(--teal);
            margin: 0;
        }

        .notification-summary {
            font-size: 11px;
            color: var(--text-dim);
        }

        .notification-summary .push-count {
            color: #22c55e;
            font-weight: 600;
        }

        .small-action-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .small-action-btn:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        /* Team Roster List */
        .team-roster-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .team-player-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            border-left: 3px solid var(--pink);
        }

        .team-player-row.level-a { border-left-color: var(--pink); }
        .team-player-row.level-b { border-left-color: var(--yellow); }
        .team-player-row.level-c { border-left-color: var(--teal); }

        .player-level-badge {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            font-weight: 700;
        }

        .player-level-badge.level-a { background: var(--pink); color: white; }
        .player-level-badge.level-b { background: var(--yellow); color: #000; }
        .player-level-badge.level-c { background: var(--teal); color: #000; }

        .player-info {
            flex: 1;
        }

        .player-info-name {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .captain-star {
            color: var(--yellow);
        }

        .player-info-stats {
            font-size: 12px;
            color: var(--text-dim);
        }

        .player-availability {
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .player-availability.available {
            color: #22c55e;
        }

        .player-availability.has-gaps {
            color: var(--yellow);
        }

        .player-notification-status {
            font-size: 16px;
            opacity: 0.7;
        }

        .player-notification-status[title*="Push"] {
            opacity: 1;
        }

        .roster-text-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .roster-text-btn:hover {
            background: var(--teal);
            border-color: var(--teal);
        }

        /* Availability Grid */
        .availability-grid-container {
            overflow-x: auto;
        }

        .availability-grid {
            display: grid;
            grid-template-columns: 100px repeat(18, 32px);
            gap: 2px;
            font-size: 11px;
        }

        .avail-header {
            padding: 6px 4px;
            text-align: center;
            font-weight: 600;
            color: var(--text-dim);
        }

        .avail-player-name {
            padding: 6px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .avail-cell {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .avail-cell.available {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .avail-cell.unavailable {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .avail-cell.unknown {
            background: rgba(255,255,255,0.05);
            color: var(--text-dim);
        }

        .avail-cell:hover {
            transform: scale(1.1);
        }

        /* Go-To Subs */
        .goto-subs-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .goto-level-section {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
        }

        .goto-level-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .level-badge {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            font-weight: 700;
        }

        .level-badge.level-a { background: var(--pink); color: white; }
        .level-badge.level-b { background: var(--yellow); color: #000; }
        .level-badge.level-c { background: var(--teal); color: #000; }

        .goto-level-title {
            font-weight: 600;
            font-size: 13px;
        }

        .goto-subs-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .goto-sub-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .goto-sub-item .drag-handle {
            cursor: grab;
            color: var(--text-dim);
            font-size: 14px;
        }

        .goto-sub-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
        }

        .goto-sub-stats {
            font-size: 11px;
            color: var(--text-dim);
        }

        .goto-sub-actions {
            display: flex;
            gap: 6px;
        }

        .goto-text-btn {
            padding: 6px 10px;
            background: var(--teal);
            border: none;
            border-radius: 4px;
            color: #000;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
        }

        .goto-remove-btn {
            padding: 6px 8px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-dim);
            font-size: 11px;
            cursor: pointer;
        }

        .goto-remove-btn:hover {
            border-color: #ef4444;
            color: #ef4444;
        }

        .empty-goto {
            font-size: 12px;
            color: var(--text-dim);
            padding: 8px;
        }

        .empty-goto span {
            color: var(--teal);
            cursor: pointer;
        }

        .empty-goto span:hover {
            text-decoration: underline;
        }

        /* Sub Pool */
        .sub-pool-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .filter-pill {
            padding: 6px 14px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-dim);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-pill:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        .filter-pill.active {
            background: var(--teal);
            border-color: var(--teal);
            color: #000;
        }

        .sub-pool-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .sub-pool-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .sub-pool-item .sub-level {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
        }

        .sub-pool-item .sub-level.A { background: var(--pink); color: white; }
        .sub-pool-item .sub-level.B { background: var(--yellow); color: #000; }
        .sub-pool-item .sub-level.C { background: var(--teal); color: #000; }

        .sub-pool-info {
            flex: 1;
        }

        .sub-pool-name {
            font-weight: 600;
            font-size: 13px;
        }

        .sub-pool-stats {
            font-size: 11px;
            color: var(--text-dim);
        }

        .sub-pool-actions {
            display: flex;
            gap: 6px;
        }

        .add-goto-btn {
            padding: 6px 10px;
            background: transparent;
            border: 1px solid var(--teal);
            border-radius: 4px;
            color: var(--teal);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        .add-goto-btn:hover {
            background: var(--teal);
            color: #000;
        }

        .text-sub-btn {
            padding: 6px 10px;
            background: var(--pink);
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
        }

        /* ========== CONTACT TAB STYLES ========== */
        .section-label {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--text-dim);
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .contact-quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (min-width: 600px) {
            .contact-quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .quick-contact-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 12px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .quick-contact-btn:hover {
            border-color: var(--pink);
            transform: translateY(-2px);
        }

        .quick-contact-btn .qc-icon {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .quick-contact-btn .qc-label {
            font-weight: 700;
            font-size: 13px;
            color: var(--text-light);
        }

        .quick-contact-btn .qc-desc {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .quick-contact-btn.highlight {
            border-color: var(--yellow);
            background: rgba(253, 216, 53, 0.1);
        }

        .quick-contact-btn.highlight:hover {
            border-color: var(--yellow);
            box-shadow: 0 0 15px rgba(253, 216, 53, 0.2);
        }

        .contact-composer {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .composer-header h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            color: var(--teal);
            margin: 0 0 16px 0;
        }

        .composer-field {
            margin-bottom: 14px;
        }

        .composer-field > label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .recipient-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .recipient-pill {
            padding: 8px 14px;
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-light);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .recipient-pill:hover {
            border-color: var(--pink);
        }

        .recipient-pill.active {
            background: var(--pink);
            border-color: var(--pink);
            color: white;
        }

        .individual-selector {
            margin-top: 10px;
        }

        .individual-selector select {
            width: 100%;
            padding: 10px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .channel-options {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .channel-option {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .channel-option input {
            width: 18px;
            height: 18px;
            accent-color: var(--pink);
        }

        .channel-label {
            font-size: 13px;
            font-weight: 500;
        }

        .composer-field select {
            width: 100%;
            padding: 10px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .merge-tags {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .merge-tag {
            color: var(--teal);
            cursor: pointer;
            margin-left: 6px;
        }

        .merge-tag:hover {
            text-decoration: underline;
        }

        .contact-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            resize: vertical;
        }

        .composer-actions {
            margin-top: 16px;
        }

        .send-message-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(180deg, var(--pink) 0%, #d63384 100%);
            border: 2px solid #000;
            border-radius: 8px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
        }

        .send-message-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 70, 154, 0.3);
        }

        .contact-history {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0,0,0,0.2);
        }

        .history-header h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            color: var(--text-light);
            margin: 0;
        }

        .history-toggle {
            font-size: 12px;
            color: var(--teal);
            cursor: pointer;
        }

        .history-list {
            padding: 12px 16px;
        }

        .message-history-item {
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .message-history-item:last-child {
            margin-bottom: 0;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .history-recipients {
            font-size: 12px;
            font-weight: 600;
            color: var(--teal);
        }

        .history-time {
            font-size: 11px;
            color: var(--text-dim);
        }

        .history-message {
            font-size: 13px;
            color: var(--text-light);
            line-height: 1.4;
        }

        /* ========== SETTINGS TAB STYLES ========== */
        .settings-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .settings-section h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            color: var(--teal);
            margin: 0 0 16px 0;
        }

        .settings-field {
            margin-bottom: 16px;
        }

        .settings-field > label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .optional-label {
            font-weight: 400;
            color: var(--text-dim);
            font-size: 11px;
        }

        .team-photo-upload {
            width: 120px;
            height: 120px;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            overflow: hidden;
        }

        .team-photo-upload:hover {
            border-color: var(--teal);
        }

        .team-photo-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .photo-placeholder {
            font-size: 36px;
            opacity: 0.5;
        }

        .photo-hint {
            font-size: 11px;
            color: var(--text-dim);
        }

        .team-photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .settings-input-row {
            display: flex;
            gap: 10px;
        }

        .settings-input {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .settings-save-btn {
            padding: 10px 20px;
            background: var(--teal);
            border: none;
            border-radius: 6px;
            color: #000;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
        }

        .settings-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .settings-toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-toggle-row:last-child {
            border-bottom: none;
        }

        .toggle-info {
            flex: 1;
        }

        .toggle-title {
            font-weight: 600;
            font-size: 14px;
            display: block;
        }

        .toggle-desc {
            font-size: 12px;
            color: var(--text-dim);
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border-color);
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--teal);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .settings-action-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 14px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 10px;
            text-align: left;
        }

        .settings-action-btn:hover {
            border-color: var(--teal);
            background: rgba(0,0,0,0.3);
        }

        .settings-action-btn .action-icon {
            font-size: 24px;
        }

        .settings-action-btn .action-text {
            flex: 1;
        }

        .settings-action-btn .action-title {
            font-weight: 600;
            font-size: 14px;
            display: block;
        }

        .settings-action-btn .action-desc {
            font-size: 12px;
            color: var(--text-dim);
        }

        .settings-action-btn .action-arrow {
            color: var(--text-dim);
            font-size: 18px;
        }

        /* ========== AVAILABILITY MODAL STYLES ========== */
        .availability-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .availability-modal-content {
            width: 100%;
            max-width: 450px;
            max-height: 85vh;
            background: var(--bg-panel);
            border: 3px solid var(--teal);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .availability-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(0,0,0,0.3);
            border-bottom: 2px solid var(--border-color);
        }

        .availability-modal-header h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 1px;
            margin: 0;
            color: var(--teal);
        }

        .availability-modal-desc {
            padding: 12px 20px;
            font-size: 13px;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border-color);
        }

        .availability-match-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .avail-match-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .avail-match-item.confirmed {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .avail-match-item.unavailable {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .avail-match-info {
            flex: 1;
        }

        .avail-match-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .avail-match-date {
            font-size: 12px;
            color: var(--text-dim);
        }

        .avail-match-actions {
            display: flex;
            gap: 8px;
        }

        .avail-btn {
            padding: 8px 14px;
            font-size: 12px;
            font-weight: 700;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid transparent;
        }

        .avail-btn.confirm {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .avail-btn.confirm:hover, .avail-btn.confirm.active {
            background: var(--success);
            color: white;
        }

        .avail-btn.cancel {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
            color: var(--error);
        }

        .avail-btn.cancel:hover, .avail-btn.cancel.active {
            background: var(--error);
            color: white;
        }

        /* ========== FILL-IN MODAL STYLES ========== */
        .fillin-modal, .playlist-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .fillin-modal-content, .playlist-modal-content {
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            background: var(--bg-panel);
            border: 3px solid var(--pink);
            border-radius: 16px;
            overflow-y: auto;
        }

        .fillin-modal-header, .playlist-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: rgba(0,0,0,0.3);
            border-bottom: 2px solid var(--border-color);
        }

        .fillin-modal-header h3, .playlist-modal-header h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 1px;
            margin: 0;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 24px;
            cursor: pointer;
        }

        .fillin-step {
            padding: 20px;
        }

        .step-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--teal);
            margin-bottom: 16px;
        }

        .fillin-field {
            margin-bottom: 16px;
        }

        .fillin-field label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .fillin-field select {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .fillin-sub-selection {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .sub-selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .select-all-goto {
            padding: 6px 12px;
            background: var(--teal);
            border: none;
            border-radius: 4px;
            color: #000;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
        }

        .fillin-sub-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .fillin-sub-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .fillin-sub-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--pink);
        }

        .deadline-row {
            display: flex;
            gap: 10px;
        }

        .deadline-row input {
            flex: 1;
            padding: 10px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .fillin-step-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .fillin-back-btn {
            padding: 12px 20px;
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            font-weight: 600;
            cursor: pointer;
        }

        .fillin-next-btn {
            flex: 1;
            padding: 12px 20px;
            background: var(--teal);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: 700;
            cursor: pointer;
        }

        .fillin-preview {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .preview-label {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .preview-message {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .preview-recipients {
            margin-top: 12px;
            font-size: 12px;
            color: var(--teal);
        }

        .fillin-send-btn {
            flex: 1;
            padding: 14px 20px;
            background: linear-gradient(180deg, var(--pink) 0%, #d63384 100%);
            border: 2px solid #000;
            border-radius: 8px;
            color: white;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
        }

        .response-waiting {
            text-align: center;
            padding: 30px;
        }

        .waiting-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .waiting-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .waiting-deadline {
            font-size: 13px;
            color: var(--text-dim);
        }

        .interested-list {
            margin-top: 16px;
        }

        .interested-header {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--teal);
            margin-bottom: 10px;
        }

        .interested-subs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .interested-sub-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
        }

        .interested-sub-item input[type="radio"] {
            accent-color: var(--teal);
        }

        .share-with-team-btn {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 2px solid var(--teal);
            border-radius: 8px;
            color: var(--teal);
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
        }

        .confirm-fillin-btn {
            width: 100%;
            padding: 14px;
            background: #22c55e;
            border: 2px solid #000;
            border-radius: 8px;
            color: white;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
        }

        /* Playlist Modal */
        .playlist-list {
            padding: 16px;
        }

        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .create-playlist-btn {
            width: calc(100% - 32px);
            margin: 0 16px 16px;
            padding: 12px;
            background: transparent;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            color: var(--text-dim);
            font-weight: 600;
            cursor: pointer;
        }

        .create-playlist-btn:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        /* Lineup Builder */
        .lineup-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .lineup-game {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--pink);
            min-width: 80px;
        }

        .lineup-select {
            flex: 1;
            padding: 10px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .action-btn {
            flex: 1;
            min-width: 150px;
            padding: 14px 20px;
            background: rgba(255,255,255,0.08);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
            text-decoration: none;
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--pink);
        }

        .action-btn.primary {
            background: linear-gradient(180deg, var(--pink) 0%, #d63384 100%);
            border-color: #000;
        }

        /* Subs List */
        .subs-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .sub-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
        }

        .sub-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .sub-info {
            font-size: 13px;
            color: var(--text-dim);
            margin-bottom: 10px;
        }

        .sub-btn {
            padding: 8px 16px;
            background: var(--teal);
            border: 2px solid #000;
            border-radius: 6px;
            color: #000;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
        }

        /* Recent Messages Section */
        .messages-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .messages-section h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .conversation-item:hover {
            background: rgba(255,255,255,0.08);
        }

        .conversation-item.unread {
            border-left: 3px solid var(--pink);
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--pink), var(--teal));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .conversation-preview {
            font-size: 12px;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            font-size: 11px;
            color: var(--text-dim);
        }

        .conversation-unread-badge {
            background: var(--pink);
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view-all-link {
            display: block;
            text-align: center;
            color: var(--teal);
            font-size: 13px;
            padding: 10px;
            margin-top: 10px;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.15s;
        }

        .view-all-link:hover {
            background: rgba(145, 215, 235, 0.1);
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            .profile-header {
                gap: 12px;
            }
            .profile-name {
                font-size: 20px;
            }
            .profile-stats-row {
                gap: 12px;
            }
            .profile-stat-value {
                font-size: 18px;
            }
            .admin-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
            .tab {
                padding: 10px 12px;
                font-size: 13px;
            }
            .tab-container {
                gap: 3px;
            }
            .calendar-container {
                padding: 12px;
            }
            .cal-day {
                min-height: 36px;
                font-size: 13px;
            }
            .team-cards-grid {
                grid-template-columns: 1fr;
            }
            .settings-section {
                padding: 15px;
            }
            .setting-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        /* ============================================
           DART TRADER TAB STYLES
           ============================================ */
        .trader-browse-link {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .browse-marketplace-btn {
            flex: 1;
            min-width: 200px;
            display: block;
            background: linear-gradient(135deg, var(--teal) 0%, #147a94 100%);
            color: var(--bg-dark);
            text-align: center;
            padding: 16px 20px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 16px;
            text-decoration: none;
            transition: all 0.2s;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .browse-marketplace-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(145, 215, 235, 0.4);
        }

        .browse-marketplace-btn.community-events-btn {
            background: linear-gradient(135deg, var(--yellow) 0%, #c9a800 100%);
        }

        .browse-marketplace-btn.community-events-btn:hover {
            box-shadow: 0 4px 15px rgba(253, 216, 53, 0.4);
        }

        .trader-section {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .trader-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .trader-section-header h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--teal);
            letter-spacing: 1px;
        }

        .new-listing-btn {
            background: var(--pink);
            border: none;
            color: white;
            padding: 10px 18px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .new-listing-btn:hover {
            background: #d63384;
            transform: translateY(-2px);
        }

        .my-listings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 14px;
        }

        .my-listing-card {
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 14px;
            transition: all 0.15s;
        }

        .my-listing-card:hover {
            border-color: var(--teal);
        }

        .my-listing-card.sold {
            opacity: 0.6;
        }

        .my-listing-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .my-listing-category {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--teal);
            font-weight: 700;
            letter-spacing: 1px;
        }

        .my-listing-status {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 700;
        }

        .my-listing-status.active {
            background: var(--success);
            color: white;
        }

        .my-listing-status.sold {
            background: var(--danger);
            color: white;
        }

        .my-listing-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--text-light);
            margin-bottom: 6px;
        }

        .my-listing-price {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--yellow);
            margin-bottom: 10px;
        }

        .my-listing-actions {
            display: flex;
            gap: 8px;
        }

        .my-listing-actions button {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }

        .edit-listing-btn {
            background: rgba(255,255,255,0.1);
            color: var(--text-light);
        }

        .edit-listing-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .sold-listing-btn {
            background: var(--success);
            color: white;
        }

        .sold-listing-btn:hover {
            background: #1ea354;
        }

        .delete-listing-btn {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger) !important;
        }

        .delete-listing-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* Listing Form */
        .listing-form-container {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--pink);
            margin-bottom: 20px;
        }

        .listing-form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--border-color);
        }

        .listing-form-header h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--yellow);
            letter-spacing: 1px;
        }

        .close-form-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-dim);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .close-form-btn:hover {
            background: var(--danger);
            color: white;
        }

        .trader-form-group {
            margin-bottom: 16px;
        }

        .trader-form-label {
            display: block;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .trader-form-input,
        .trader-form-select,
        .trader-form-textarea {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-card);
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            font-size: 15px;
            color: var(--text-light);
            transition: all 0.15s;
        }

        .trader-form-input:focus,
        .trader-form-select:focus,
        .trader-form-textarea:focus {
            outline: none;
            border-color: var(--teal);
            background: rgba(145, 215, 235, 0.05);
        }

        .trader-form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .trader-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .darts-fields {
            background: rgba(145, 215, 235, 0.05);
            border: 1px solid rgba(145, 215, 235, 0.2);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .listing-image-upload {
            background: var(--bg-card);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.15s;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .listing-image-upload:hover {
            border-color: var(--teal);
        }

        .listing-image-placeholder-content span {
            display: block;
            font-size: 32px;
            margin-bottom: 6px;
        }

        .listing-image-placeholder-content small {
            font-size: 12px;
            opacity: 0.7;
        }

        .listing-image-preview {
            position: relative;
            width: 100%;
        }

        .listing-image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            object-fit: cover;
        }

        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .contact-prefs {
            display: flex;
            gap: 20px;
        }

        .contact-pref {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .contact-pref input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--teal);
        }

        .form-hint {
            display: block;
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 6px;
        }

        .trader-form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .cancel-listing-btn {
            flex: 1;
            padding: 14px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: var(--text-light);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .cancel-listing-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .submit-listing-btn {
            flex: 2;
            padding: 14px;
            background: linear-gradient(180deg, var(--pink) 0%, #d63384 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .submit-listing-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 70, 154, 0.4);
        }

        .submit-listing-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        @media (max-width: 600px) {
            .trader-form-row {
                grid-template-columns: 1fr;
            }
            .my-listings-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Skeleton Loading States */
        .skeleton {
            background: linear-gradient(90deg, #1e2a47 25%, #2a3a57 50%, #1e2a47 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }
        .skeleton-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .skeleton-title {
            height: 24px;
            width: 60%;
        }
        .skeleton-badge {
            height: 20px;
            width: 60px;
            border-radius: 10px;
        }
        .skeleton-row {
            display: flex;
            gap: 12px;
            margin-bottom: 10px;
        }
        .skeleton-text {
            height: 14px;
            width: 100%;
        }
        .skeleton-text.short { width: 40%; }
        .skeleton-text.medium { width: 70%; }
        .skeleton-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .skeleton-score {
            height: 40px;
            width: 80px;
            margin: 0 auto;
        }
        .skeleton-roster {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .skeleton-player {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .skeleton-level {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        .skeleton-name {
            height: 14px;
            width: 120px;
        }
        .skeleton-stats {
            height: 12px;
            width: 60px;
            margin-left: auto;
        }

        /* Mobile Responsive - Tablet */
        @media (max-width: 768px) {
            .login-box { max-width: 95vw; }
            .quick-links-row { flex-wrap: wrap; }
            .quick-link-card { flex: 1 1 calc(50% - 5px) !important; min-width: 140px; }
        }

        /* Mobile Responsive - Phone */
        @media (max-width: 480px) {
            .quick-links-row { flex-direction: column; }
            .quick-link-card { flex: 1 1 100% !important; }
            .teammate-level { min-width: 32px; min-height: 32px; width: 32px; height: 32px; }
            .container { padding: 0 10px; }
            .login-box { padding: 24px 20px; }
            .login-title { font-size: 30px; }
            .tab-container { gap: 4px; }
            .tab { font-size: 11px; padding: 10px 8px; }
        }

        /* Mobile Responsive - Small Phone */
        @media (max-width: 360px) {
            .login-box { padding: 20px 16px; }
            .form-input { font-size: 20px; letter-spacing: 3px; }
            .quick-link-card span:last-child { font-size: 14px !important; }
        }

        /* Tooltip hints for stats jargon */
        [data-tooltip] {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted var(--text-dim);
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-dark);
            border: 1px solid var(--teal);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            color: var(--text-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            pointer-events: none;
        }
        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: calc(100% - 5px);
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--teal);
            z-index: 1001;
        }

        /* Onboarding Tutorial Modal */
        .onboarding-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .onboarding-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .onboarding-modal {
            background: var(--bg-panel);
            border: 3px solid var(--pink);
            border-radius: 20px;
            width: 100%;
            max-width: 420px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(255, 70, 154, 0.3);
            display: flex;
            flex-direction: column;
        }

        .onboarding-content {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
            text-align: center;
        }

        .onboarding-icon {
            font-size: 64px;
            margin-bottom: 20px;
            display: block;
        }

        .onboarding-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: var(--pink);
            letter-spacing: 2px;
            margin-bottom: 16px;
        }

        .onboarding-text {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-light);
            margin-bottom: 20px;
        }

        .onboarding-text strong {
            color: var(--yellow);
        }

        .onboarding-highlight {
            background: rgba(145, 215, 235, 0.15);
            border: 2px solid var(--teal);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }

        .onboarding-highlight-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--teal);
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .onboarding-list {
            text-align: left;
            padding-left: 20px;
            margin: 12px 0;
        }

        .onboarding-list li {
            margin-bottom: 8px;
            color: var(--text-light);
        }

        .onboarding-list li::marker {
            color: var(--yellow);
        }

        .onboarding-term {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 8px;
            text-align: left;
        }

        .onboarding-term-abbr {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            color: var(--yellow);
            min-width: 50px;
        }

        .onboarding-term-def {
            font-size: 13px;
            color: var(--text-dim);
        }

        .onboarding-footer {
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .onboarding-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .onboarding-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: background 0.3s, transform 0.3s;
        }

        .onboarding-dot.active {
            background: var(--pink);
            transform: scale(1.2);
        }

        .onboarding-dot.completed {
            background: var(--teal);
        }

        .onboarding-buttons {
            display: flex;
            gap: 12px;
        }

        .onboarding-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 10px;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.15s;
            min-height: 48px;
        }

        .onboarding-btn-skip {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: var(--text-dim);
        }

        .onboarding-btn-skip:hover {
            border-color: var(--text-dim);
            color: var(--text-light);
        }

        .onboarding-btn-next {
            background: linear-gradient(180deg, var(--pink) 0%, #d63384 100%);
            border: 2px solid #000;
            color: white;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.4);
        }

        .onboarding-btn-next:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.4);
        }

        .onboarding-btn-prev {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-light);
        }

        .onboarding-btn-prev:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--teal);
        }

        .onboarding-checkbox-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 12px;
        }

        .onboarding-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--pink);
            cursor: pointer;
        }

        .onboarding-checkbox-label {
            font-size: 13px;
            color: var(--text-dim);
            cursor: pointer;
        }

        /* Onboarding slide transitions */
        .onboarding-slide {
            display: none;
        }

        .onboarding-slide.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mobile responsive for onboarding */
        @media (max-width: 480px) {
            .onboarding-modal {
                max-height: 95vh;
                border-radius: 16px;
            }
            .onboarding-content {
                padding: 24px 20px;
            }
            .onboarding-icon {
                font-size: 48px;
            }
            .onboarding-title {
                font-size: 26px;
            }
            .onboarding-text {
                font-size: 14px;
            }
            .onboarding-footer {
                padding: 16px 20px;
            }
            .onboarding-btn {
                font-size: 16px;
                padding: 12px 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Initial Loading Screen (shown while checking session) -->
    <div id="initialLoader" style="display: flex; flex-direction: column; align-items: center; justify-content: center; position: fixed; inset: 0; background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%); z-index: 9999;">
        <img src="/images/gold_logo.png" alt="BRDC" style="height: 80px; margin-bottom: 20px;">
        <div style="width: 40px; height: 40px; border: 3px solid rgba(255,70,154,0.3); border-top-color: #FF469A; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
    </div>

    <!-- Fallback: If module fails to load, show login after timeout -->
    <script>
        window.moduleLoaded = false;
        window.showFallbackLogin = function() {
            if (!window.moduleLoaded) {
                console.warn('Module load timeout - showing login');
                var loader = document.getElementById('initialLoader');
                var login = document.getElementById('loginPage');
                if (loader) loader.style.display = 'none';
                if (login) login.style.display = 'flex';
            }
        };
        // Catch any script errors
        window.onerror = function(msg, url, line) {
            console.error('Script error:', msg, url, line);
            window.showFallbackLogin();
            return true;
        };
        // Try at 3 seconds, 6 seconds, 10 seconds
        setTimeout(window.showFallbackLogin, 3000);
        setTimeout(window.showFallbackLogin, 6000);
        setTimeout(window.showFallbackLogin, 10000);
    </script>

    <!-- Skip Link for Accessibility -->
    <a href="#dashboardContent" class="skip-link">Skip to main content</a>

    <!-- Login Page (hidden initially) -->
    <div class="login-page" id="loginPage" style="display: flex;" role="main" aria-labelledby="loginPageTitle">
        <img src="/images/gold_logo.png" alt="Burning River Dart Club logo" class="login-logo">
        <h1 class="login-title" id="loginPageTitle">BRDC DASHBOARD</h1>

        <div class="login-box" role="form" aria-labelledby="loginFormTitle">
            <h2 class="login-form-title" id="loginFormTitle">LOGIN</h2>

            <div class="login-error" id="loginError" role="alert" aria-live="assertive" style="display: none;"></div>

            <div class="form-group">
                <label class="form-label" for="pinInput">Your 8-Digit PIN</label>
                <input type="password" class="form-input" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" inputmode="numeric" pattern="[0-9]*" autocomplete="off" aria-required="true" aria-describedby="loginError">
            </div>

            <button class="login-btn" id="loginBtn" onclick="login()">LOGIN</button>

            <nav class="login-links" aria-label="Login help links">
                <a href="#" onclick="showForgotPin()">Forgot PIN?</a>
                <span style="color: var(--text-dim); margin: 0 10px;" aria-hidden="true">|</span>
                <a href="/pages/register.html">New Player? Register</a>
            </nav>
        </div>
    </div>

    <!-- Onboarding Tutorial Modal -->
    <div class="onboarding-overlay" id="onboardingOverlay" role="dialog" aria-modal="true" aria-labelledby="onboardingTitle">
        <div class="onboarding-modal">
            <div class="onboarding-content">
                <!-- Slide 1: Welcome -->
                <div class="onboarding-slide active" data-slide="0">
                    <span class="onboarding-icon" aria-hidden="true">üéØ</span>
                    <h2 class="onboarding-title" id="onboardingTitle">WELCOME TO BRDC</h2>
                    <p class="onboarding-text">
                        Your all-in-one platform for <strong>leagues</strong>, <strong>tournaments</strong>, and <strong>casual darts</strong>.
                    </p>
                    <div class="onboarding-highlight">
                        <div class="onboarding-highlight-title">What You Can Do Here</div>
                        <ul class="onboarding-list">
                            <li>Track your stats and rankings</li>
                            <li>Manage league matches and scores</li>
                            <li>Find opponents and schedule games</li>
                            <li>Connect with the dart community</li>
                        </ul>
                    </div>
                </div>

                <!-- Slide 2: Dashboard Overview -->
                <div class="onboarding-slide" data-slide="1">
                    <span class="onboarding-icon" aria-hidden="true">üìä</span>
                    <h2 class="onboarding-title">YOUR DASHBOARD</h2>
                    <p class="onboarding-text">
                        Your dashboard is organized into tabs for easy navigation.
                    </p>
                    <div class="onboarding-term">
                        <span class="onboarding-term-abbr">SCHEDULE</span>
                        <span class="onboarding-term-def">View your upcoming matches and events</span>
                    </div>
                    <div class="onboarding-term">
                        <span class="onboarding-term-abbr">CAPTAIN</span>
                        <span class="onboarding-term-def">Manage your team if you're a captain</span>
                    </div>
                    <div class="onboarding-term">
                        <span class="onboarding-term-abbr">TRADER</span>
                        <span class="onboarding-term-def">Buy/sell dart equipment</span>
                    </div>
                </div>

                <!-- Slide 3: Scoring Matches -->
                <div class="onboarding-slide" data-slide="2">
                    <span class="onboarding-icon" aria-hidden="true">üìù</span>
                    <h2 class="onboarding-title">SCORING MATCHES</h2>
                    <p class="onboarding-text">
                        When you have a match, tap it in your schedule to access scoring options.
                    </p>
                    <div class="onboarding-highlight">
                        <div class="onboarding-highlight-title">Match Hub</div>
                        <p style="font-size: 13px; color: var(--text-dim); margin: 0;">
                            From the Match Hub you can start scoring, view lineups, and see live stats as you play.
                        </p>
                    </div>
                    <p class="onboarding-text" style="margin-bottom: 0;">
                        Scores sync in real-time so captains and spectators can follow along!
                    </p>
                </div>

                <!-- Slide 4: Key Terms -->
                <div class="onboarding-slide" data-slide="3">
                    <span class="onboarding-icon" aria-hidden="true">üìñ</span>
                    <h2 class="onboarding-title">KEY TERMS</h2>
                    <p class="onboarding-text">
                        Quick reference for common dart stats and jargon:
                    </p>
                    <div class="onboarding-term">
                        <span class="onboarding-term-abbr">3DA</span>
                        <span class="onboarding-term-def">Three Dart Average - points per 3 darts in 01 games</span>
                    </div>
                    <div class="onboarding-term">
                        <span class="onboarding-term-abbr">MPR</span>
                        <span class="onboarding-term-def">Marks Per Round - cricket marks per 3 darts</span>
                    </div>
                    <div class="onboarding-term">
                        <span class="onboarding-term-abbr">SIDO</span>
                        <span class="onboarding-term-def">Single In, Double Out - start anywhere, must finish on double</span>
                    </div>
                    <p class="onboarding-text" style="margin: 12px 0 0 0;">
                        <a href="/pages/glossary.html" style="color: var(--teal);">View full glossary</a>
                    </p>
                </div>

                <!-- Slide 5: Get Help -->
                <div class="onboarding-slide" data-slide="4">
                    <span class="onboarding-icon" aria-hidden="true">üí¨</span>
                    <h2 class="onboarding-title">GET HELP</h2>
                    <p class="onboarding-text">
                        Need assistance? We're here to help!
                    </p>
                    <div class="onboarding-highlight">
                        <div class="onboarding-highlight-title">Feedback Button</div>
                        <p style="font-size: 13px; color: var(--text-dim); margin: 0;">
                            Look for the <strong style="color: var(--pink);">pink feedback button</strong> at the bottom of any page to report issues or suggest features.
                        </p>
                    </div>
                    <p class="onboarding-text">
                        You can also message captains or directors directly through the app.
                    </p>
                    <p class="onboarding-text" style="color: var(--yellow); font-weight: 600; margin-bottom: 0;">
                        Good luck and throw well!
                    </p>
                </div>
            </div>

            <div class="onboarding-footer">
                <div class="onboarding-progress" role="progressbar" aria-valuenow="1" aria-valuemin="1" aria-valuemax="5">
                    <div class="onboarding-dot active" data-dot="0"></div>
                    <div class="onboarding-dot" data-dot="1"></div>
                    <div class="onboarding-dot" data-dot="2"></div>
                    <div class="onboarding-dot" data-dot="3"></div>
                    <div class="onboarding-dot" data-dot="4"></div>
                </div>
                <div class="onboarding-buttons">
                    <button class="onboarding-btn onboarding-btn-skip" id="onboardingSkip" onclick="skipOnboarding()">SKIP</button>
                    <button class="onboarding-btn onboarding-btn-prev" id="onboardingPrev" onclick="prevOnboardingSlide()" style="display: none;">BACK</button>
                    <button class="onboarding-btn onboarding-btn-next" id="onboardingNext" onclick="nextOnboardingSlide()">NEXT</button>
                </div>
                <div class="onboarding-checkbox-row" id="onboardingCheckboxRow" style="display: none;">
                    <input type="checkbox" class="onboarding-checkbox" id="dontShowAgain">
                    <label class="onboarding-checkbox-label" for="dontShowAgain">Don't show this again</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content" id="dashboardContent" role="main">
        <header class="header-bar" role="banner">
            <a href="/" style="text-decoration: none;" aria-label="Go to homepage">
                <img src="/images/gold_logo.png" alt="Burning River Dart Club" class="header-logo" style="cursor: pointer;">
            </a>
            <h1 class="header-title">DASHBOARD</h1>
            <button class="logout-btn" onclick="logout()" aria-label="Log out of your account">LOGOUT</button>
        </header>

        <div class="container">
            <!-- Profile Header - Clean Design -->
            <div class="profile-header">
                <div class="player-avatar" id="playerAvatar" title="Click to change photo">
                    <span id="avatarEmoji" aria-hidden="true">üë§</span>
                    <img id="avatarImage" style="display: none;" alt="Your profile photo">
                    <div class="avatar-edit-overlay" aria-hidden="true">üì∑</div>
                    <label for="avatarInput" class="sr-only">Upload profile photo</label>
                    <input type="file" class="avatar-input" id="avatarInput" accept="image/*" aria-label="Upload profile photo">
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="welcomeName">Welcome!</div>
                    <div class="profile-stats-row">
                        <div class="profile-stat">
                            <span class="profile-stat-value" id="statAvg">-</span>
                            <span class="profile-stat-label" data-tooltip="Three Dart Average - points per 3 darts">3DA</span>
                        </div>
                        <div class="profile-stat">
                            <span class="profile-stat-value" id="statMpr">-</span>
                            <span class="profile-stat-label" data-tooltip="Marks Per Round - cricket marks per 3 darts">MPR</span>
                        </div>
                    </div>
                    <a href="/pages/player-profile.html" class="profile-link" id="fullStatsLink">View Full Profile ‚Üí</a>
                </div>
                <div class="profile-actions">
                    <button class="settings-icon-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
                    <a href="/pages/admin.html" class="admin-btn" id="adminLink" style="display: none;">
                        üîß ADMIN
                    </a>
                </div>
            </div>

            <!-- Tonight's Match Card (shows when there's a match today) -->
            <div class="match-card event-league" id="tonightsMatchBanner" style="display: none;">
                <div class="match-card-body" id="tonightsMatchBody">
                    <!-- Populated by JS with same structure as schedule cards -->
                </div>
            </div>

            <!-- Verify Your Stats Card (hidden for closed beta) -->
            <div class="verify-stats-card" id="verifyStatsCard" onclick="navigateTo('/pages/stat-verification.html', event)" style="display: none; cursor: pointer;">
                <!-- Unverified state (default) -->
                <div class="verify-stats-icon" id="verifyStatsIcon">üéØ</div>
                <div class="verify-stats-content" id="verifyStatsContent">
                    <div class="verify-stats-title" id="verifyStatsTitle">VERIFY YOUR STATS</div>
                    <div class="verify-stats-desc" id="verifyStatsDesc">Get your official skill rating for captains to see</div>
                </div>
                <div class="verify-stats-arrow" id="verifyStatsArrow">‚Üí</div>
            </div>

            <!-- Quick Links -->
            <div class="quick-links-row" style="display: flex; gap: 10px; margin-bottom: 15px;">
                <a href="/pages/online-play.html" class="quick-link-card" style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); border: 2px solid var(--teal); border-radius: 10px; text-decoration: none; color: var(--text-light);">
                    <span style="font-size: 20px;">üåê</span>
                    <span style="font-family: 'Bebas Neue', cursive; font-size: 16px; letter-spacing: 1px;">ONLINE PLAY</span>
                </a>
                <a href="/pages/matchmaker-view.html" class="quick-link-card" style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); border: 2px solid var(--pink); border-radius: 10px; text-decoration: none; color: var(--text-light);">
                    <span style="font-size: 20px;">üíò</span>
                    <span style="font-family: 'Bebas Neue', cursive; font-size: 16px; letter-spacing: 1px;">MATCHMAKER</span>
                </a>
                <a href="/pages/members.html" class="quick-link-card" style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); border: 2px solid var(--yellow); border-radius: 10px; text-decoration: none; color: var(--text-light);">
                    <span style="font-size: 20px;">üë•</span>
                    <span style="font-family: 'Bebas Neue', cursive; font-size: 16px; letter-spacing: 1px;">MEMBERS</span>
                </a>
                <a href="/pages/browse-events.html" class="quick-link-card" style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); border: 2px solid var(--teal); border-radius: 10px; text-decoration: none; color: var(--text-light);">
                    <span style="font-size: 20px;">üèÜ</span>
                    <span style="font-family: 'Bebas Neue', cursive; font-size: 16px; letter-spacing: 1px;">LEAGUES</span>
                </a>
                <a href="/pages/community-events.html" class="quick-link-card" style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); border: 2px solid #4CAF50; border-radius: 10px; text-decoration: none; color: var(--text-light);">
                    <span style="font-size: 20px;">üìç</span>
                    <span style="font-family: 'Bebas Neue', cursive; font-size: 16px; letter-spacing: 1px;">EVENTS</span>
                </a>
                <a href="/pages/dart-trader.html" class="quick-link-card" style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); border: 2px solid #FF9800; border-radius: 10px; text-decoration: none; color: var(--text-light);">
                    <span style="font-size: 20px;">üè™</span>
                    <span style="font-family: 'Bebas Neue', cursive; font-size: 16px; letter-spacing: 1px;">TRADER</span>
                </a>
                <a href="/virtual-darts/index.html" class="quick-link-card" style="flex: 1; display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-card); border: 2px solid #9C27B0; border-radius: 10px; text-decoration: none; color: var(--text-light);">
                    <span style="font-size: 20px;">üéØ</span>
                    <span style="font-family: 'Bebas Neue', cursive; font-size: 16px; letter-spacing: 1px;">PRACTICE</span>
                </a>
            </div>

            <!-- Main Tabs -->
            <nav class="tab-container" role="tablist" aria-label="Dashboard sections">
                <button class="tab active" role="tab" aria-selected="true" aria-controls="scheduleTab" id="scheduleTabBtn" onclick="switchTab('schedule', event)">üìÖ SCHEDULE</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="activityTab" id="activityTabBtn" onclick="switchTab('activity', event)" style="display: none;">üéØ ACTIVITY</button>
                <button class="tab captain-tab" role="tab" aria-selected="false" aria-controls="captainTab" id="captainTabBtn" onclick="switchTab('captain', event)">üö¢ CAPTAIN</button>
                <button class="tab director-tab" role="tab" aria-selected="false" aria-controls="directorTab" id="directorTabBtn" onclick="switchTab('director', event)" style="display: none;">üëë DIRECTOR</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="traderTab" id="traderTabBtn" onclick="switchTab('trader', event)">üè™ TRADER</button>
            </nav>

            <!-- SCHEDULE Tab (formerly teams) -->
            <section id="scheduleTab" class="tab-content active" role="tabpanel" aria-labelledby="scheduleTabBtn">
                <!-- Calendar View -->
                <div class="calendar-container" id="calendarContainer">
                    <!-- Week View (collapsed, default) -->
                    <div class="calendar-week-view" id="calendarWeekView">
                        <div class="calendar-week-header">
                            <span class="cal-month" id="calWeekLabel">January</span>
                        </div>
                        <div class="calendar-week-row">
                            <button class="cal-nav" onclick="changeWeek(-1)">‚óÄ</button>
                            <div class="calendar-days week-view" id="calendarWeekDays">
                                <!-- Week days filled by JS -->
                            </div>
                            <button class="cal-nav" onclick="changeWeek(1)">‚ñ∂</button>
                        </div>
                        <!-- Legend (always visible) -->
                        <div class="calendar-legend compact">
                            <div class="legend-item"><span class="legend-dot league"></span>League</div>
                            <div class="legend-item"><span class="legend-dot tournament"></span>Tournament</div>
                            <div class="legend-item"><span class="legend-dot upcoming-tournament"></span>Upcoming</div>
                            <div class="legend-item"><span class="legend-dot deadline"></span>Deadline</div>
                            <div class="legend-item"><span class="legend-dot social"></span>Social</div>
                        </div>
                        <span class="calendar-expand-link" onclick="toggleCalendarExpand()" id="expandBtnText">View full calendar ‚Ä∫</span>
                    </div>

                    <!-- Full Month View (expanded) -->
                    <div class="calendar-full-month" id="calendarFullMonth">
                        <div class="calendar-header">
                            <button class="cal-nav" onclick="changeMonth(-1)">‚óÄ</button>
                            <span class="cal-month" id="calMonth">January 2026</span>
                            <button class="cal-nav" onclick="changeMonth(1)">‚ñ∂</button>
                        </div>
                        <div class="calendar-grid">
                            <div class="cal-day-header">Sun</div>
                            <div class="cal-day-header">Mon</div>
                            <div class="cal-day-header">Tue</div>
                            <div class="cal-day-header">Wed</div>
                            <div class="cal-day-header">Thu</div>
                            <div class="cal-day-header">Fri</div>
                            <div class="cal-day-header">Sat</div>
                        </div>
                        <div class="calendar-days" id="calendarDays">
                            <!-- Days filled by JS -->
                        </div>

                        <!-- Calendar Legend -->
                        <div class="calendar-legend">
                            <div class="legend-item"><span class="legend-dot league"></span>League Match</div>
                            <div class="legend-item"><span class="legend-dot tournament"></span>Tournament</div>
                            <div class="legend-item"><span class="legend-dot upcoming-tournament"></span>Upcoming Tournament</div>
                            <div class="legend-item"><span class="legend-dot deadline"></span>Registration Deadline</div>
                            <div class="legend-item"><span class="legend-dot social"></span>Social/Casual</div>
                        </div>
                        <span class="calendar-expand-link" onclick="toggleCalendarExpand()">‚Äπ Collapse calendar</span>
                    </div>
                </div>

                <!-- Events View Toggle Buttons (now below calendar) -->
                <div class="events-toggle-btns">
                    <button class="events-toggle-btn" id="myEventsBtn" onclick="showEventsView('my')">MY EVENTS</button>
                    <button class="events-toggle-btn" id="allEventsBtn" onclick="showEventsView('all')" style="display: none;">ALL EVENTS</button>
                </div>

                <!-- Event Type Filters (shown for My Events / All Events views) -->
                <div class="event-filters" id="eventFilters" style="display: none;">
                    <button class="filter-chip active" data-filter="all" onclick="filterEvents('all')">All</button>
                    <button class="filter-chip" data-filter="league" onclick="filterEvents('league')">Leagues</button>
                    <button class="filter-chip" data-filter="tournament" onclick="filterEvents('tournament')">Tournaments</button>
                </div>

                <!-- Single Day View (shown when a calendar date is clicked) -->
                <div class="single-day-view" id="singleDayView" style="display: none;">
                    <div class="single-day-header">
                        <span id="singleDayDate">January 15, 2026</span>
                        <button class="single-day-close" onclick="closeSingleDayView()">‚úï</button>
                    </div>
                    <div class="single-day-content" id="singleDayContent">
                        <!-- Skeleton loading state -->
                        <div class="skeleton-card">
                            <div class="skeleton-header">
                                <div class="skeleton skeleton-title"></div>
                                <div class="skeleton skeleton-badge"></div>
                            </div>
                            <div class="skeleton skeleton-score" style="margin-bottom: 12px;"></div>
                            <div class="skeleton-roster">
                                <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                                <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                                <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Events List Container (shown for My Events / All Events) -->
                <div class="events-list-container" id="eventsListContainer" style="display: none;">
                    <!-- Skeleton loading state -->
                    <div id="eventsSkeletonLoader">
                        <div class="skeleton-card">
                            <div class="skeleton-header">
                                <div class="skeleton skeleton-title"></div>
                                <div class="skeleton skeleton-badge"></div>
                            </div>
                            <div class="skeleton skeleton-score" style="margin-bottom: 12px;"></div>
                            <div class="skeleton-roster">
                                <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                                <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                                <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                            </div>
                        </div>
                        <div class="skeleton-card">
                            <div class="skeleton-header">
                                <div class="skeleton skeleton-title"></div>
                                <div class="skeleton skeleton-badge"></div>
                            </div>
                            <div class="skeleton skeleton-score" style="margin-bottom: 12px;"></div>
                            <div class="skeleton-roster">
                                <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                                <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                                <div class="skeleton-player"><div class="skeleton skeleton-level"></div><div class="skeleton skeleton-name"></div><div class="skeleton skeleton-stats"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Messages Section -->
                <div class="messages-section" id="recentMessagesSection" style="display: none;">
                    <h3>RECENT MESSAGES <span id="totalUnreadCount" style="font-size: 14px; color: var(--pink);"></span></h3>
                    <div id="recentMessagesList">
                        <div class="empty-state">Loading...</div>
                    </div>
                    <a href="/pages/messages.html" class="view-all-link">View All Messages ‚Üí</a>
                </div>
            </div>

            <!-- CAPTAIN Tab -->
            <div id="captainTab" class="tab-content">
                <div class="team-selector" id="captainTeamSelector">
                    <label>SELECT TEAM TO MANAGE</label>
                    <select id="captainTeamSelect" onchange="loadCaptainTeam()"></select>
                    <a href="#" id="openCaptainDashboardLink" onclick="openCaptainDashboard()" style="display: inline-block; margin-left: 10px; font-size: 12px; color: var(--teal); text-decoration: none;">Open Dedicated View ‚Üí</a>
                </div>

                <!-- Captain Sub-tabs -->
                <div class="captain-subtabs">
                    <div class="captain-subtab active" onclick="switchCaptainSubtab('roster')">ROSTER</div>
                    <div class="captain-subtab" onclick="switchCaptainSubtab('schedule')">SCHEDULE</div>
                    <div class="captain-subtab" onclick="switchCaptainSubtab('contact')">CONTACT</div>
                    <div class="captain-subtab" onclick="switchCaptainSubtab('settings')">SETTINGS</div>
                </div>

                <!-- Urgent Sub Request Banner - shows when match is within 48 hours -->
                <div class="urgent-sub-banner" id="urgentSubBanner" style="display: none;">
                    <div class="urgent-sub-info">
                        <span class="urgent-icon">üÜò</span>
                        <div class="urgent-text">
                            <span class="urgent-title">Next match in <span id="urgentMatchCountdown">--</span></span>
                            <span class="urgent-subtitle" id="urgentMatchInfo">vs Opponent</span>
                        </div>
                    </div>
                    <button class="urgent-sub-btn" onclick="openFillinRequest()">NEED A SUB?</button>
                </div>

                <!-- ========== ROSTER Sub-content ========== -->
                <div id="captainRoster" class="captain-subcontent active">

                    <!-- Your Team Section -->
                    <div class="roster-section">
                        <div class="roster-section-header">
                            <h3>YOUR TEAM</h3>
                            <span class="notification-summary" id="teamNotificationSummary">
                                <span class="push-count" id="pushEnabledCount">0</span> push
                                <span class="sms-count">/ <span id="smsOnlyCount">0</span> SMS only</span>
                            </span>
                        </div>
                        <div class="team-roster-list" id="teamRosterList">
                            <div class="empty-state">Loading roster...</div>
                        </div>
                    </div>

                    <!-- Season Availability Grid -->
                    <div class="roster-section">
                        <div class="roster-section-header">
                            <h3>SEASON AVAILABILITY</h3>
                            <button class="small-action-btn" onclick="toggleAvailabilityEdit()">‚úèÔ∏è Edit</button>
                        </div>
                        <div class="availability-grid-container" id="availabilityGrid">
                            <div class="empty-state">Loading availability...</div>
                        </div>
                    </div>

                    <!-- Go-To Subs Section -->
                    <div class="roster-section">
                        <div class="roster-section-header">
                            <h3>GO-TO SUBS</h3>
                            <button class="small-action-btn" onclick="manageSubPlaylists()">‚öôÔ∏è Manage Lists</button>
                        </div>
                        <div class="goto-subs-container" id="gotoSubsContainer">
                            <!-- Level A Go-Tos -->
                            <div class="goto-level-section">
                                <div class="goto-level-header">
                                    <span class="level-badge level-a">A</span>
                                    <span class="goto-level-title">A-Level Go-Tos</span>
                                </div>
                                <div class="goto-subs-list" id="gotoSubsA">
                                    <div class="empty-goto">No go-to subs set. <span onclick="openSubPool('A')">Add from pool ‚Üí</span></div>
                                </div>
                            </div>
                            <!-- Level B Go-Tos -->
                            <div class="goto-level-section">
                                <div class="goto-level-header">
                                    <span class="level-badge level-b">B</span>
                                    <span class="goto-level-title">B-Level Go-Tos</span>
                                </div>
                                <div class="goto-subs-list" id="gotoSubsB">
                                    <div class="empty-goto">No go-to subs set. <span onclick="openSubPool('B')">Add from pool ‚Üí</span></div>
                                </div>
                            </div>
                            <!-- Level C Go-Tos -->
                            <div class="goto-level-section">
                                <div class="goto-level-header">
                                    <span class="level-badge level-c">C</span>
                                    <span class="goto-level-title">C-Level Go-Tos</span>
                                </div>
                                <div class="goto-subs-list" id="gotoSubsC">
                                    <div class="empty-goto">No go-to subs set. <span onclick="openSubPool('C')">Add from pool ‚Üí</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- All Available Subs -->
                    <div class="roster-section">
                        <div class="roster-section-header">
                            <h3>ALL AVAILABLE SUBS</h3>
                        </div>
                        <div class="sub-pool-filters">
                            <button class="filter-pill active" data-level="all" onclick="filterSubPool('all')">All</button>
                            <button class="filter-pill" data-level="A" onclick="filterSubPool('A')">A-Level</button>
                            <button class="filter-pill" data-level="B" onclick="filterSubPool('B')">B-Level</button>
                            <button class="filter-pill" data-level="C" onclick="filterSubPool('C')">C-Level</button>
                        </div>
                        <div class="sub-pool-list" id="subPoolList">
                            <div class="empty-state">Loading subs...</div>
                        </div>
                    </div>
                </div>

                <!-- ========== SCHEDULE Sub-content ========== -->
                <div id="captainSchedule" class="captain-subcontent">
                    <div id="captainScheduleTable">
                        <div class="empty-state">Loading schedule...</div>
                    </div>
                </div>

                <!-- ========== CONTACT Sub-content ========== -->
                <div id="captainContact" class="captain-subcontent">

                    <!-- Quick Actions -->
                    <div class="section-label">QUICK ACTIONS</div>
                    <div class="contact-quick-actions">
                        <button class="quick-contact-btn" onclick="quickRemindTeam()">
                            <span class="qc-icon">‚è∞</span>
                            <span class="qc-label">Remind Team</span>
                            <span class="qc-desc">About next match</span>
                        </button>
                        <button class="quick-contact-btn highlight" onclick="textUnconfirmedPlayers()">
                            <span class="qc-icon">üì±</span>
                            <span class="qc-label">Text Unconfirmed</span>
                            <span class="qc-desc">Players who haven't replied</span>
                        </button>
                        <button class="quick-contact-btn" onclick="openFillinRequest()">
                            <span class="qc-icon">üÜò</span>
                            <span class="qc-label">Need a Sub</span>
                            <span class="qc-desc">Request fill-in</span>
                        </button>
                        <button class="quick-contact-btn" onclick="contactDirector()">
                            <span class="qc-icon">üëë</span>
                            <span class="qc-label">Contact Director</span>
                            <span class="qc-desc">League questions</span>
                        </button>
                    </div>

                    <!-- Message Composer -->
                    <div class="section-label" style="margin-top: 20px;">SEND CUSTOM MESSAGE</div>
                    <div class="contact-composer">

                        <!-- Recipients -->
                        <div class="composer-field">
                            <label>TO:</label>
                            <div class="recipient-pills" id="recipientPills">
                                <button class="recipient-pill active" data-recipient="team" onclick="toggleRecipient('team')">üéØ My Team</button>
                                <button class="recipient-pill" data-recipient="subs" onclick="toggleRecipient('subs')">üë• Subs</button>
                                <button class="recipient-pill" data-recipient="individual" onclick="toggleRecipient('individual')">üë§ Individual</button>
                                <button class="recipient-pill" data-recipient="director" onclick="toggleRecipient('director')">üëë Director</button>
                                <button class="recipient-pill" data-recipient="opponent" onclick="toggleRecipient('opponent')">‚öîÔ∏è Opponent Captain</button>
                            </div>
                            <!-- Individual selector (hidden by default) -->
                            <div class="individual-selector" id="individualSelector" style="display: none;">
                                <select id="individualRecipientSelect">
                                    <option value="">Select person...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Channels -->
                        <div class="composer-field">
                            <label>VIA:</label>
                            <div class="channel-options">
                                <label class="channel-option">
                                    <input type="checkbox" id="channelDM" checked>
                                    <span class="channel-label">üí¨ In-App</span>
                                </label>
                                <label class="channel-option">
                                    <input type="checkbox" id="channelSMS" checked>
                                    <span class="channel-label">üì± SMS</span>
                                </label>
                                <label class="channel-option">
                                    <input type="checkbox" id="channelEmail">
                                    <span class="channel-label">üìß Email</span>
                                </label>
                            </div>
                        </div>

                        <!-- Templates -->
                        <div class="composer-field">
                            <label>TEMPLATE:</label>
                            <select id="messageTemplate" onchange="loadMessageTemplate()">
                                <option value="">Custom message...</option>
                                <option value="reminder">Match Reminder</option>
                                <option value="running_late">Running Late</option>
                                <option value="practice">Practice Reminder</option>
                                <option value="congrats">Congrats on the Win!</option>
                            </select>
                        </div>

                        <!-- Message -->
                        <div class="composer-field">
                            <label>MESSAGE:</label>
                            <div class="merge-tags">
                                Insert:
                                <span class="merge-tag" onclick="insertMergeTag('[first_name]')">[first_name]</span>
                                <span class="merge-tag" onclick="insertMergeTag('[match_date]')">[match_date]</span>
                                <span class="merge-tag" onclick="insertMergeTag('[opponent]')">[opponent]</span>
                                <span class="merge-tag" onclick="insertMergeTag('[venue]')">[venue]</span>
                            </div>
                            <textarea id="captainMessage" class="contact-textarea" placeholder="Type your message..."></textarea>
                        </div>

                        <!-- Send -->
                        <div class="composer-actions">
                            <button class="send-message-btn" onclick="sendCaptainComposedMessage()">
                                <span>üì§ SEND MESSAGE</span>
                            </button>
                        </div>
                    </div>

                    <!-- Message History -->
                    <div class="contact-history">
                        <div class="history-header">
                            <h3>SENT MESSAGES</h3>
                            <span class="history-toggle" onclick="toggleMessageHistory()">Show ‚ñº</span>
                        </div>
                        <div class="history-list" id="captainMessageHistory" style="display: none;">
                            <div class="empty-state">No messages sent yet</div>
                        </div>
                    </div>
                </div>

                <!-- ========== SETTINGS Sub-content ========== -->
                <div id="captainSettings" class="captain-subcontent">

                    <!-- Team Identity -->
                    <div class="settings-section">
                        <h3>TEAM IDENTITY</h3>

                        <!-- Team Photo -->
                        <div class="settings-field">
                            <label>Team Photo</label>
                            <div class="team-photo-upload" id="teamPhotoUpload" onclick="document.getElementById('teamPhotoInput').click()">
                                <input type="file" id="teamPhotoInput" accept="image/*" style="display: none;" onchange="handleTeamPhotoSelect(event)">
                                <div id="teamPhotoPreview" class="team-photo-preview">
                                    <span class="photo-placeholder">üì∑</span>
                                    <span class="photo-hint">Tap to upload</span>
                                </div>
                            </div>
                        </div>

                        <!-- Team Name -->
                        <div class="settings-field">
                            <label>Team Name</label>
                            <div class="settings-input-row">
                                <input type="text" id="settingsTeamName" class="settings-input" placeholder="Enter team name" maxlength="50">
                                <button class="settings-save-btn" onclick="saveTeamNameFromSettings()">Save</button>
                            </div>
                        </div>

                        <!-- Team Motto (optional fun) -->
                        <div class="settings-field">
                            <label>Team Motto <span class="optional-label">(optional)</span></label>
                            <input type="text" id="settingsTeamMotto" class="settings-input" placeholder="e.g., 'Fear the dart!'" maxlength="100">
                        </div>
                    </div>

                    <!-- Notification Preferences -->
                    <div class="settings-section">
                        <h3>AUTO-REMINDERS</h3>

                        <div class="settings-toggle-row">
                            <div class="toggle-info">
                                <span class="toggle-title">Match Reminders</span>
                                <span class="toggle-desc">Auto-remind team before matches</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoRemindersEnabled" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="settings-field" id="reminderTimingField">
                            <label>Remind team:</label>
                            <select id="reminderTiming" class="settings-select">
                                <option value="1day">1 day before</option>
                                <option value="2days" selected>2 days before</option>
                                <option value="3days">3 days before</option>
                                <option value="1week">1 week before</option>
                            </select>
                        </div>

                        <div class="settings-toggle-row">
                            <div class="toggle-info">
                                <span class="toggle-title">Include SMS</span>
                                <span class="toggle-desc">Also send text messages</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="reminderIncludeSMS" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Roster Management -->
                    <div class="settings-section">
                        <h3>ROSTER MANAGEMENT</h3>

                        <button class="settings-action-btn" onclick="openRosterEditor()">
                            <span class="action-icon">üë•</span>
                            <span class="action-text">
                                <span class="action-title">Edit Roster Positions</span>
                                <span class="action-desc">Change A/B/C assignments</span>
                            </span>
                            <span class="action-arrow">‚Üí</span>
                        </button>

                        <button class="settings-action-btn" onclick="openPermanentReplacement()">
                            <span class="action-icon">üîÑ</span>
                            <span class="action-text">
                                <span class="action-title">Permanent Replacement</span>
                                <span class="action-desc">Mid-season roster change</span>
                            </span>
                            <span class="action-arrow">‚Üí</span>
                        </button>

                        <button class="settings-action-btn" onclick="markPlayerInactive()">
                            <span class="action-icon">üö´</span>
                            <span class="action-text">
                                <span class="action-title">Mark Player Inactive</span>
                                <span class="action-desc">Out for remainder of season</span>
                            </span>
                            <span class="action-arrow">‚Üí</span>
                        </button>
                    </div>

                    <!-- Captain Options -->
                    <div class="settings-section">
                        <h3>CAPTAIN OPTIONS</h3>

                        <button class="settings-action-btn" onclick="requestCaptainTransfer()">
                            <span class="action-icon">üëë</span>
                            <span class="action-text">
                                <span class="action-title">Transfer Captain Role</span>
                                <span class="action-desc">Assign new team captain</span>
                            </span>
                            <span class="action-arrow">‚Üí</span>
                        </button>
                    </div>
                </div>

                <!-- ========== FILL-IN REQUEST MODAL ========== -->
                <div class="fillin-modal" id="fillinModal" style="display: none;">
                    <div class="fillin-modal-content">
                        <div class="fillin-modal-header">
                            <h3>üÜò REQUEST FILL-IN</h3>
                            <button class="modal-close" onclick="closeFillinModal()">‚úï</button>
                        </div>

                        <!-- Step 1: Select Match & Player -->
                        <div class="fillin-step" id="fillinStep1">
                            <div class="step-title">Step 1: Who needs a sub?</div>

                            <div class="fillin-field">
                                <label>Match:</label>
                                <select id="fillinMatchSelect" onchange="loadFillinMatchDetails()">
                                    <option value="">Select match...</option>
                                </select>
                            </div>

                            <div class="fillin-field">
                                <label>Player needing sub:</label>
                                <select id="fillinPlayerSelect">
                                    <option value="">Select player...</option>
                                </select>
                            </div>

                            <button class="fillin-next-btn" onclick="goToFillinStep(2)">Next ‚Üí</button>
                        </div>

                        <!-- Step 2: Select Subs to Contact -->
                        <div class="fillin-step" id="fillinStep2" style="display: none;">
                            <div class="step-title">Step 2: Who to ask?</div>

                            <div class="fillin-sub-selection">
                                <div class="sub-selection-header">
                                    <span>Select subs to text:</span>
                                    <button class="select-all-goto" onclick="selectAllGotoSubs()">Select all go-tos</button>
                                </div>
                                <div class="fillin-sub-list" id="fillinSubList">
                                    <!-- Populated by JS -->
                                </div>
                            </div>

                            <div class="fillin-field">
                                <label>Response deadline:</label>
                                <div class="deadline-row">
                                    <input type="date" id="fillinDeadlineDate">
                                    <input type="time" id="fillinDeadlineTime" value="18:00">
                                </div>
                            </div>

                            <div class="fillin-field">
                                <label>If no response, remind me to send to:</label>
                                <select id="fillinFallbackList">
                                    <option value="none">Don't remind me</option>
                                    <option value="all">All available subs</option>
                                    <option value="backup">Backup list</option>
                                </select>
                            </div>

                            <div class="fillin-step-actions">
                                <button class="fillin-back-btn" onclick="goToFillinStep(1)">‚Üê Back</button>
                                <button class="fillin-next-btn" onclick="goToFillinStep(3)">Preview ‚Üí</button>
                            </div>
                        </div>

                        <!-- Step 3: Preview & Send -->
                        <div class="fillin-step" id="fillinStep3" style="display: none;">
                            <div class="step-title">Step 3: Preview & Send</div>

                            <div class="fillin-preview">
                                <div class="preview-label">Message to be sent:</div>
                                <div class="preview-message" id="fillinPreviewMessage">
                                    <!-- Populated by JS -->
                                </div>
                                <div class="preview-recipients">
                                    Sending to: <span id="fillinRecipientCount">0</span> subs
                                </div>
                            </div>

                            <div class="fillin-step-actions">
                                <button class="fillin-back-btn" onclick="goToFillinStep(2)">‚Üê Back</button>
                                <button class="fillin-send-btn" onclick="sendFillinRequests()">üì± SEND REQUESTS</button>
                            </div>
                        </div>

                        <!-- Step 4: Responses -->
                        <div class="fillin-step" id="fillinStep4" style="display: none;">
                            <div class="step-title">Responses</div>

                            <div class="fillin-responses" id="fillinResponses">
                                <div class="response-waiting">
                                    <div class="waiting-icon">‚è≥</div>
                                    <div class="waiting-text">Waiting for responses...</div>
                                    <div class="waiting-deadline">Deadline: <span id="responseDeadline">-</span></div>
                                </div>
                            </div>

                            <div class="interested-list" id="interestedList" style="display: none;">
                                <div class="interested-header">INTERESTED SUBS:</div>
                                <div class="interested-subs" id="interestedSubs">
                                    <!-- Populated when responses come in -->
                                </div>
                                <button class="share-with-team-btn" onclick="shareInterestedWithTeam()">
                                    üí¨ Share list with team for input
                                </button>
                            </div>

                            <div class="fillin-final-actions" id="fillinFinalActions" style="display: none;">
                                <button class="confirm-fillin-btn" onclick="confirmSelectedFillin()">‚úÖ CONFIRM SELECTED SUB</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========== SUB PLAYLIST MODAL ========== -->
                <div class="playlist-modal" id="playlistModal" style="display: none;">
                    <div class="playlist-modal-content">
                        <div class="playlist-modal-header">
                            <h3>‚öôÔ∏è MANAGE SUB PLAYLISTS</h3>
                            <button class="modal-close" onclick="closePlaylistModal()">‚úï</button>
                        </div>
                        <div class="playlist-list" id="playlistList">
                            <!-- Populated by JS -->
                        </div>
                        <button class="create-playlist-btn" onclick="createNewPlaylist()">+ Create New List</button>
                    </div>
                </div>

            </div>

            <!-- ========== PLAYER AVAILABILITY MODAL ========== -->
            <div class="availability-modal" id="availabilityModal" style="display: none;">
                <div class="availability-modal-content">
                    <div class="availability-modal-header">
                        <h3>üìÖ SET YOUR AVAILABILITY</h3>
                        <button class="modal-close" onclick="closeAvailabilityModal()">‚úï</button>
                    </div>
                    <p class="availability-modal-desc">Let your captain know if you can make it to upcoming matches.</p>
                    <div class="availability-match-list" id="availabilityMatchList">
                        <div class="empty-state">Loading matches...</div>
                    </div>
                </div>
            </div>

            <!-- ACTIVITY Tab (leagues, tournaments, history, stats) -->
            <div id="activityTab" class="tab-content">
                <div class="sub-tab-container">
                    <div class="sub-tab active" onclick="switchActivitySubTab('leagues')">üèÜ Leagues</div>
                    <div class="sub-tab" onclick="switchActivitySubTab('tournaments')">üéØ Tournaments</div>
                    <div class="sub-tab" onclick="switchActivitySubTab('history')">üìú History</div>
                    <div class="sub-tab" onclick="switchActivitySubTab('stats')">üìä Stats</div>
                </div>
                <div id="leaguesSubTab" class="sub-tab-content active">
                    <div id="leaguesContent">
                        <div class="empty-state">Loading leagues...</div>
                    </div>
                </div>
                <div id="tournamentsSubTab" class="sub-tab-content">
                    <div id="tournamentsContent">
                        <div class="empty-state">Loading tournaments...</div>
                    </div>
                </div>
                <div id="historySubTab" class="sub-tab-content">
                    <div class="history-filters">
                        <select id="historyLeagueFilter" onchange="filterMatchHistory()">
                            <option value="all">All Leagues</option>
                        </select>
                        <select id="historyGameFilter" onchange="filterMatchHistory()">
                            <option value="all">All Games</option>
                            <option value="x01">501 Only</option>
                            <option value="cricket">Cricket Only</option>
                        </select>
                    </div>
                    <div id="matchHistoryContent">
                        <div class="empty-state">Loading match history...</div>
                    </div>
                </div>
                <!-- Stats Sub-Tab (inside Activity) -->
                <div id="statsSubTab" class="sub-tab-content">
                    <!-- Stats Overview Cards -->
                    <div class="stats-overview" id="statsOverview">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalMatches">-</div>
                        <div class="stat-label">Matches Played</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statWinRate">-</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statOverall3DA">-</div>
                        <div class="stat-label">Overall 3DA</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statOverallMPR">-</div>
                        <div class="stat-label">Overall MPR</div>
                    </div>
                </div>

                <!-- X01 Stats Section -->
                <div class="stats-section">
                    <h3>501 Statistics</h3>
                    <div class="stats-grid" id="x01StatsGrid">
                        <div class="stat-row">
                            <span class="stat-name">3-Dart Average</span>
                            <span class="stat-val" id="stat501Avg">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">First 9 Average</span>
                            <span class="stat-val" id="stat501First9">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Checkout %</span>
                            <span class="stat-val" id="stat501Checkout">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Avg Checkout</span>
                            <span class="stat-val" id="stat501AvgOut">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">High Checkout</span>
                            <span class="stat-val" id="stat501HighOut">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Legs Won/Played</span>
                            <span class="stat-val" id="stat501Legs">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">180s</span>
                            <span class="stat-val" id="stat501_180s">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">140+</span>
                            <span class="stat-val" id="stat501_140s">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">100+</span>
                            <span class="stat-val" id="stat501_100s">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">High Score</span>
                            <span class="stat-val" id="stat501High">-</span>
                        </div>
                    </div>
                </div>

                <!-- Cricket Stats Section -->
                <div class="stats-section">
                    <h3>Cricket Statistics</h3>
                    <div class="stats-grid" id="cricketStatsGrid">
                        <div class="stat-row">
                            <span class="stat-name">Marks Per Round</span>
                            <span class="stat-val" id="statCricketMPR">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Legs Won/Played</span>
                            <span class="stat-val" id="statCricketLegs">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Win Rate</span>
                            <span class="stat-val" id="statCricketWinRate">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Total Marks</span>
                            <span class="stat-val" id="statCricketMarks">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Total Rounds</span>
                            <span class="stat-val" id="statCricketRounds">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">6+ Mark Rounds</span>
                            <span class="stat-val" id="statCricket6Mark">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">9 Mark Rounds</span>
                            <span class="stat-val" id="statCricket9Mark">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">High Round</span>
                            <span class="stat-val" id="statCricketHighRound">-</span>
                        </div>
                    </div>
                </div>

                <!-- Achievements Section -->
                <div class="stats-section">
                    <h3>Achievements</h3>
                    <div class="achievements-grid" id="achievementsGrid">
                        <div class="empty-state">Loading achievements...</div>
                    </div>
                </div>
                </div><!-- End statsSubTab -->
            </div><!-- End activityTab -->

            <!-- DIRECTOR Tab -->
            <div id="directorTab" class="tab-content">
                <!-- Game Day Control Section -->
                <div class="director-section gameday-section">
                    <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--pink); margin-bottom: 16px;">üéØ Game Day Control</h3>

                    <!-- League Selector -->
                    <div class="gameday-league-selector">
                        <select id="gamedayLeagueSelect" onchange="loadGamedayData()">
                            <option value="">Select a league...</option>
                        </select>
                    </div>

                    <!-- Game Day Content (hidden until league selected) -->
                    <div id="gamedayContent" style="display: none;">
                        <!-- Tonight's Matches -->
                        <div class="gameday-matches-section">
                            <div class="gameday-header">
                                <h4>Tonight's Matches</h4>
                                <span id="gamedayWeekBadge" class="gameday-week-badge">Week -</span>
                            </div>
                            <div id="gamedayMatchCards" class="gameday-match-cards">
                                <div class="empty-state">No matches scheduled</div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="gameday-actions-section">
                            <h4 style="font-family: 'Bebas Neue', cursive; font-size: 18px; color: var(--teal); margin-bottom: 12px;">Quick Actions</h4>
                            <div class="gameday-action-buttons">
                                <button class="gameday-action-btn" onclick="openSubstitutionModal()">
                                    <span class="action-icon">üîÑ</span>
                                    <span>Sub Players</span>
                                </button>
                                <button class="gameday-action-btn" onclick="openMessageModal('all')">
                                    <span class="action-icon">üì¢</span>
                                    <span>Message All</span>
                                </button>
                                <button class="gameday-action-btn" onclick="openMessageModal('captains')">
                                    <span class="action-icon">üëë</span>
                                    <span>Text Captains</span>
                                </button>
                                <button class="gameday-action-btn" onclick="openMessageModal('alternates')">
                                    <span class="action-icon">üîî</span>
                                    <span>Text Alternates</span>
                                </button>
                            </div>

                            <!-- Message by Level -->
                            <div class="gameday-level-message">
                                <label>Message by Level:</label>
                                <div class="level-buttons">
                                    <button class="level-btn" onclick="openMessageModal('level', 'A')">A</button>
                                    <button class="level-btn" onclick="openMessageModal('level', 'B')">B</button>
                                    <button class="level-btn" onclick="openMessageModal('level', 'C')">C</button>
                                    <button class="level-btn" onclick="openMessageModal('level', 'D')">D</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="director-section">
                    <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--yellow); margin-bottom: 20px;">üëë Leagues You're Directing</h3>
                    <div id="directorLeaguesList" class="director-list">
                        <div class="empty-state">Loading...</div>
                    </div>
                </div>
                <div class="director-section" style="margin-top: 30px;">
                    <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--teal); margin-bottom: 20px;">üèÜ Tournaments You're Directing</h3>
                    <div id="directorTournamentsList" class="director-list">
                        <div class="empty-state">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Substitution Modal -->
            <div id="substitutionModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Player Substitution</h3>
                        <button class="modal-close" onclick="closeSubstitutionModal()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div class="sub-form-group">
                            <label>Select Match</label>
                            <select id="subMatchSelect" onchange="loadMatchPlayers()">
                                <option value="">Select a match...</option>
                            </select>
                        </div>
                        <div class="sub-form-group">
                            <label>Player to Replace</label>
                            <select id="subPlayerOut">
                                <option value="">Select player...</option>
                            </select>
                        </div>
                        <div class="sub-form-group">
                            <label>Substitute Player</label>
                            <select id="subPlayerIn">
                                <option value="">Select substitute...</option>
                            </select>
                        </div>
                        <div class="sub-form-group">
                            <label>Reason (optional)</label>
                            <input type="text" id="subReason" placeholder="e.g., Injury, No-show">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="closeSubstitutionModal()">Cancel</button>
                        <button class="btn-primary" onclick="confirmSubstitution()">Confirm Sub</button>
                    </div>
                </div>
            </div>

            <!-- Message Modal -->
            <div id="messageModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 id="messageModalTitle">Send Message</h3>
                        <button class="modal-close" onclick="closeMessageModal()">‚úï</button>
                    </div>
                    <div class="modal-body">
                        <div class="message-recipients">
                            <label>Recipients:</label>
                            <div id="messageRecipientsList" class="recipients-list">
                                <span class="recipient-chip">Loading...</span>
                            </div>
                            <div id="messageRecipientCount" class="recipient-count">0 recipients</div>
                        </div>
                        <div class="message-form-group">
                            <label>Message</label>
                            <textarea id="messageText" rows="4" placeholder="Type your message..."></textarea>
                        </div>
                        <div class="message-templates">
                            <label>Quick Templates:</label>
                            <div class="template-buttons">
                                <button class="template-btn" onclick="insertTemplate('running_late')">Running Late</button>
                                <button class="template-btn" onclick="insertTemplate('need_sub')">Need Sub</button>
                                <button class="template-btn" onclick="insertTemplate('match_starting')">Match Starting</button>
                                <button class="template-btn" onclick="insertTemplate('reminder')">Match Reminder</button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="closeMessageModal()">Cancel</button>
                        <button class="btn-primary" onclick="sendDirectorMessage()">Send Message</button>
                    </div>
                </div>
            </div>

            <!-- DART TRADER Tab -->
            <div id="traderTab" class="tab-content">
                <!-- Browse Links -->
                <div class="trader-browse-link">
                    <a href="/pages/dart-trader.html" class="browse-marketplace-btn">
                        üîç Browse All Listings
                    </a>
                    <a href="/pages/community-events.html" class="browse-marketplace-btn community-events-btn">
                        üìç Community Events Map
                    </a>
                </div>

                <!-- My Listings Section -->
                <div class="trader-section">
                    <div class="trader-section-header">
                        <h3>My Listings</h3>
                        <button class="new-listing-btn" onclick="showListingForm()">+ New Listing</button>
                    </div>
                    <div id="myListings" class="my-listings-grid">
                        <div class="empty-state">Loading your listings...</div>
                    </div>
                </div>

                <!-- Listing Form (hidden by default) -->
                <div id="listingFormContainer" class="listing-form-container" style="display: none;">
                    <div class="listing-form-header">
                        <h3 id="listingFormTitle">Create New Listing</h3>
                        <button class="close-form-btn" onclick="hideListingForm()">‚úï</button>
                    </div>

                    <form id="listingForm" onsubmit="submitListing(event)">
                        <!-- Category Selection -->
                        <div class="trader-form-group">
                            <label class="trader-form-label">Category *</label>
                            <select id="listingCategory" class="trader-form-select" required onchange="toggleDartsFields()">
                                <option value="">Select a category...</option>
                                <option value="Darts">Darts (Barrels)</option>
                                <option value="Flights">Flights</option>
                                <option value="Shafts">Shafts / Stems</option>
                                <option value="Cases">Cases</option>
                                <option value="Dartboards">Dartboards</option>
                                <option value="Accessories">Accessories / Other</option>
                            </select>
                        </div>

                        <!-- Title -->
                        <div class="trader-form-group">
                            <label class="trader-form-label">Title *</label>
                            <input type="text" id="listingTitle" class="trader-form-input" placeholder="e.g. Target Phil Taylor Power 9Five Gen 3" required maxlength="100">
                        </div>

                        <!-- Darts-specific fields -->
                        <div id="dartsFields" class="darts-fields" style="display: none;">
                            <div class="trader-form-row">
                                <div class="trader-form-group">
                                    <label class="trader-form-label">Weight (grams) *</label>
                                    <input type="number" id="listingWeight" class="trader-form-input" placeholder="e.g. 24" step="0.5" min="12" max="50">
                                </div>
                                <div class="trader-form-group">
                                    <label class="trader-form-label">Material</label>
                                    <select id="listingMaterial" class="trader-form-select">
                                        <option value="">Select...</option>
                                        <option value="95% Tungsten">95% Tungsten</option>
                                        <option value="90% Tungsten">90% Tungsten</option>
                                        <option value="85% Tungsten">85% Tungsten</option>
                                        <option value="80% Tungsten">80% Tungsten</option>
                                        <option value="Brass">Brass</option>
                                        <option value="Nickel Silver">Nickel Silver</option>
                                    </select>
                                </div>
                            </div>
                            <div class="trader-form-row">
                                <div class="trader-form-group">
                                    <label class="trader-form-label">Point Type</label>
                                    <select id="listingPointType" class="trader-form-select">
                                        <option value="">Select...</option>
                                        <option value="Steel Tip">Steel Tip</option>
                                        <option value="Soft Tip">Soft Tip</option>
                                        <option value="Convertible">Convertible</option>
                                    </select>
                                </div>
                                <div class="trader-form-group">
                                    <label class="trader-form-label">Brand</label>
                                    <input type="text" id="listingBrand" class="trader-form-input" placeholder="e.g. Target, Winmau, Unicorn">
                                </div>
                            </div>
                        </div>

                        <!-- Condition (shown for all) -->
                        <div class="trader-form-group">
                            <label class="trader-form-label">Condition *</label>
                            <select id="listingCondition" class="trader-form-select" required>
                                <option value="">Select condition...</option>
                                <option value="New">New (never used)</option>
                                <option value="Like New">Like New (barely used)</option>
                                <option value="Good">Good (some use, no damage)</option>
                                <option value="Fair">Fair (visible wear)</option>
                            </select>
                        </div>

                        <!-- Price -->
                        <div class="trader-form-group">
                            <label class="trader-form-label">Price ($) *</label>
                            <input type="number" id="listingPrice" class="trader-form-input" placeholder="e.g. 75" min="1" max="9999" required>
                        </div>

                        <!-- Description -->
                        <div class="trader-form-group">
                            <label class="trader-form-label">Description</label>
                            <textarea id="listingDescription" class="trader-form-textarea" placeholder="Describe your item... condition details, why you're selling, any accessories included, etc." rows="4"></textarea>
                        </div>

                        <!-- Image Upload -->
                        <div class="trader-form-group">
                            <label class="trader-form-label">Photo</label>
                            <div class="listing-image-upload" id="listingImageUpload" onclick="document.getElementById('listingImageInput').click()">
                                <input type="file" id="listingImageInput" accept="image/*" style="display: none;" onchange="handleListingImageSelect(event)">
                                <div id="listingImagePreview" class="listing-image-preview" style="display: none;">
                                    <img id="listingPreviewImg" src="" alt="Preview">
                                    <button type="button" class="remove-image-btn" onclick="removeListingImage(event)">‚úï</button>
                                </div>
                                <div id="listingImagePlaceholder" class="listing-image-placeholder-content">
                                    <span>üì∑</span>
                                    <small>Tap to add photo</small>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Preferences -->
                        <div class="trader-form-group">
                            <label class="trader-form-label">Contact Preference</label>
                            <div class="contact-prefs">
                                <label class="contact-pref">
                                    <input type="checkbox" id="contactEmail" checked> Email
                                </label>
                                <label class="contact-pref">
                                    <input type="checkbox" id="contactPhone"> Phone
                                </label>
                            </div>
                            <small class="form-hint">Uses your profile contact info</small>
                        </div>

                        <!-- Submit -->
                        <div class="trader-form-actions">
                            <button type="button" class="cancel-listing-btn" onclick="hideListingForm()">Cancel</button>
                            <button type="submit" class="submit-listing-btn" id="submitListingBtn">Create Listing</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- SETTINGS Tab -->
            <div id="settingsTab" class="tab-content">
                <!-- Edit Profile Section -->
                <div class="settings-section">
                    <h3>Edit Profile</h3>

                    <!-- First Name (locked) -->
                    <div class="profile-field" id="firstNameField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">First Name</div>
                            <div class="profile-field-value" id="firstNameValue">-</div>
                            <div class="field-locked-hint">Contact admin to change first name</div>
                        </div>
                        <div class="profile-field-edit">
                            <input type="text" id="editFirstName">
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn disabled" title="Contact admin to change">Locked</button>
                        </div>
                    </div>

                    <!-- Last Name (editable) -->
                    <div class="profile-field" id="lastNameField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">Last Name</div>
                            <div class="profile-field-value" id="lastNameValue">-</div>
                        </div>
                        <div class="profile-field-edit">
                            <input type="text" id="editLastName">
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn" onclick="startEditField('lastName')">Edit</button>
                            <button class="save-field-btn" onclick="saveField('lastName')">‚úì</button>
                            <button class="cancel-field-btn" onclick="cancelEditField('lastName')">‚úï</button>
                        </div>
                    </div>

                    <!-- Phone (editable) -->
                    <div class="profile-field" id="phoneField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">Phone</div>
                            <div class="profile-field-value" id="phoneValue">-</div>
                        </div>
                        <div class="profile-field-edit">
                            <input type="tel" id="editPhone" placeholder="(555) 123-4567">
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn" onclick="startEditField('phone')">Edit</button>
                            <button class="save-field-btn" onclick="saveField('phone')">‚úì</button>
                            <button class="cancel-field-btn" onclick="cancelEditField('phone')">‚úï</button>
                        </div>
                    </div>

                    <!-- Email (editable) -->
                    <div class="profile-field" id="emailField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">Email</div>
                            <div class="profile-field-value" id="emailValue">-</div>
                        </div>
                        <div class="profile-field-edit">
                            <input type="email" id="editEmail" placeholder="you@example.com">
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn" onclick="startEditField('email')">Edit</button>
                            <button class="save-field-btn" onclick="saveField('email')">‚úì</button>
                            <button class="cancel-field-btn" onclick="cancelEditField('email')">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- Privacy Settings Section -->
                <div class="settings-section">
                    <h3>Privacy Settings</h3>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Show Phone Number</div>
                            <div class="privacy-desc">Allow other players to see your phone number on your profile</div>
                        </div>
                        <div class="privacy-toggle" id="privacyPhone" onclick="togglePrivacy('show_phone')"></div>
                    </div>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Show Email Address</div>
                            <div class="privacy-desc">Allow other players to see your email on your profile</div>
                        </div>
                        <div class="privacy-toggle" id="privacyEmail" onclick="togglePrivacy('show_email')"></div>
                    </div>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Public Stats</div>
                            <div class="privacy-desc">Show your stats on public leaderboards and profiles</div>
                        </div>
                        <div class="privacy-toggle on" id="privacyStats" onclick="togglePrivacy('show_stats')"></div>
                    </div>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Allow Messages</div>
                            <div class="privacy-desc">Receive direct messages from other players</div>
                        </div>
                        <div class="privacy-toggle on" id="privacyMessages" onclick="togglePrivacy('allow_messages')"></div>
                    </div>
                </div>

                <!-- Notifications Section -->
                <div class="settings-section">
                    <h3>Notifications</h3>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">SMS Text Messages</div>
                            <div class="privacy-desc">Receive match reminders and updates via text</div>
                        </div>
                        <div class="privacy-toggle on" id="notifySms" onclick="toggleNotification('sms')"></div>
                    </div>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Email Notifications</div>
                            <div class="privacy-desc">Receive updates and announcements via email</div>
                        </div>
                        <div class="privacy-toggle" id="notifyEmail" onclick="toggleNotification('email')"></div>
                    </div>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Push Notifications</div>
                            <div class="privacy-desc">Receive instant alerts on your device</div>
                        </div>
                        <div class="privacy-toggle" id="notifyPush" onclick="toggleNotification('push')"></div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div class="settings-section">
                    <h3>Profile</h3>

                    <!-- Bio -->
                    <div class="profile-field" id="bioField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">Bio</div>
                            <div class="profile-field-value" id="bioValue">Not set</div>
                        </div>
                        <div class="profile-field-edit">
                            <textarea id="editBio" maxlength="200" placeholder="Tell us about yourself..." style="width: 100%; padding: 8px 12px; background: var(--bg-dark); border: 2px solid var(--teal); border-radius: 6px; color: white; font-size: 14px; min-height: 60px; resize: vertical;"></textarea>
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn" onclick="startEditField('bio')">Edit</button>
                            <button class="save-field-btn" onclick="saveField('bio')">‚úì</button>
                            <button class="cancel-field-btn" onclick="cancelEditField('bio')">‚úï</button>
                        </div>
                    </div>

                    <!-- Home Bar -->
                    <div class="profile-field" id="homeBarField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">Home Bar</div>
                            <div class="profile-field-value" id="homeBarValue">Not set</div>
                        </div>
                        <div class="profile-field-edit">
                            <input type="text" id="editHomeBar" maxlength="100" placeholder="Where do you usually play?">
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn" onclick="startEditField('homeBar')">Edit</button>
                            <button class="save-field-btn" onclick="saveField('homeBar')">‚úì</button>
                            <button class="cancel-field-btn" onclick="cancelEditField('homeBar')">‚úï</button>
                        </div>
                    </div>

                    <!-- Preferred Game -->
                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Preferred Game</div>
                            <div class="privacy-desc">Your favorite game type</div>
                        </div>
                        <select id="preferredGame" onchange="savePreferredGame()" style="padding: 8px 12px; background: var(--bg-dark); border: 2px solid var(--border-color); border-radius: 6px; color: white; font-size: 14px;">
                            <option value="">No preference</option>
                            <option value="501">501</option>
                            <option value="cricket">Cricket</option>
                        </select>
                    </div>
                </div>

                <!-- Integrations Section -->
                <div class="settings-section">
                    <h3>Integrations</h3>

                    <!-- DartConnect ID -->
                    <div class="profile-field" id="dartconnectField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">DartConnect Player ID</div>
                            <div class="profile-field-value" id="dartconnectValue">Not linked</div>
                            <div class="field-locked-hint">Find your ID in your DartConnect profile URL</div>
                        </div>
                        <div class="profile-field-edit">
                            <input type="text" id="editDartconnect" placeholder="e.g., 12345">
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn" onclick="startEditField('dartconnect')">Link</button>
                            <button class="save-field-btn" onclick="saveField('dartconnect')">‚úì</button>
                            <button class="cancel-field-btn" onclick="cancelEditField('dartconnect')">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- Account Section -->
                <div class="settings-section">
                    <h3>Account</h3>

                    <!-- Current PIN display -->
                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Your PIN</div>
                            <div class="privacy-desc" id="currentPinDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                        </div>
                        <button class="edit-btn" onclick="togglePinVisibility()" id="showPinBtn">Show</button>
                    </div>

                    <!-- Generate New PIN -->
                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Generate New PIN</div>
                            <div class="privacy-desc">Get a new random PIN (old one will stop working)</div>
                        </div>
                        <button class="edit-btn" onclick="generateNewPin()" style="background: rgba(255,70,154,0.2); border-color: var(--pink); color: var(--pink);">New PIN</button>
                    </div>

                    <!-- Export Data -->
                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Export My Data</div>
                            <div class="privacy-desc">Download all your stats and profile data</div>
                        </div>
                        <button class="edit-btn" onclick="exportMyData()">Export</button>
                    </div>

                    <!-- Delete Account -->
                    <div class="privacy-setting" style="border-bottom: none;">
                        <div class="privacy-info">
                            <div class="privacy-title" style="color: var(--danger);">Delete Account</div>
                            <div class="privacy-desc">Permanently delete your account and all data</div>
                        </div>
                        <button class="edit-btn" onclick="confirmDeleteAccount()" style="background: rgba(239,68,68,0.2); border-color: var(--danger); color: var(--danger);">Delete</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Floating Chat Button with Expandable Menu -->
    <div class="chat-bubble-container" id="chatBubbleContainer">
        <!-- Expanded Menu -->
        <div class="chat-expanded-menu">
            <!-- Chat Rooms (vertical) -->
            <div class="chat-rooms-section" id="chatRoomsSection">
                <!-- Rooms will be inserted by JS -->
            </div>
            <!-- DMs (horizontal) -->
            <div class="chat-dms-section" id="chatDmsSection">
                <!-- DMs will be inserted by JS -->
            </div>
        </div>
        <!-- Main Button -->
        <button class="floating-chat-btn" onclick="toggleChatMenu()" title="Messages">
            üí¨
            <span class="unread-badge hidden" id="headerUnreadBadge">0</span>
        </button>
    </div>

    <!-- Director Selector Modal -->
    <div id="directorModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-panel); border: 4px solid #000; border-radius: 16px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 8px 8px 0 rgba(0,0,0,0.5);">
            <h3 style="font-family: 'Bebas Neue', cursive; font-size: 28px; margin-bottom: 20px; color: var(--yellow);">üëë SELECT LEAGUE</h3>
            <select id="directorLeagueSelect" style="width: 100%; padding: 14px; background: var(--bg-dark); border: 2px solid var(--border-color); border-radius: 8px; color: white; font-size: 16px; margin-bottom: 20px;"></select>
            <div style="display: flex; gap: 10px;">
                <button class="action-btn" onclick="closeDirectorModal()" style="flex: 1;">CANCEL</button>
                <button class="action-btn primary" onclick="goToDirectorDashboard()" style="flex: 1;">OPEN</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { callFunction, uploadImage, showLoading, hideLoading, db } from '/js/firebase-config.js';
        import { collection, doc, getDoc, getDocs, setDoc, query, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Dynamic import for push notifications (fail-safe)
        let initializePushNotifications = async () => false;
        try {
            const pushModule = await import('/js/push-notifications.js');
            initializePushNotifications = pushModule.initializePushNotifications;
        } catch (e) {
            // Push notifications not available
        }

        let currentPlayer = null;
        let dashboardData = null;
        let selectedTeamId = null;
        let selectedCaptainTeamId = null;
        let captainTeamData = null;

        // Avatar upload handling
        document.getElementById('avatarInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                return;
            }

            if (!currentPlayer) {
                alert('Please log in first');
                return;
            }

            showLoading('Uploading photo...');
            try {
                const photoUrl = await uploadImage(file, 'players');

                // Update player profile with new photo
                const result = await callFunction('updateGlobalPlayer', {
                    player_id: currentPlayer.id,
                    photo_url: photoUrl
                });

                if (result.success) {
                    // Show the uploaded image
                    document.getElementById('avatarImage').src = photoUrl;
                    document.getElementById('avatarImage').style.display = 'block';
                    document.getElementById('avatarEmoji').style.display = 'none';
                    currentPlayer.photo_url = photoUrl;
                }
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Photo upload failed:', error);
                alert('Failed to upload photo. Please try again.');
            }
        });

        // Mark module as loaded to prevent fallback timeout
        window.moduleLoaded = true;

        // Initialize dashboard - ES modules are deferred, so DOM is ready
        // But window.onload may have already fired, so call init directly
        function initDashboard() {
            // Always hide initial loader first - don't wait for async operations
            hideInitialLoader();

            const savedSession = localStorage.getItem('brdc_session');
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    if (session.player_id) {
                        // Show dashboard shell immediately while loading data
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('dashboardContent').style.display = 'block';
                        document.getElementById('welcomeName').textContent = session.name || 'Loading...';

                        // Load dashboard with timeout
                        const loadPromise = loadDashboard(session.player_id, session.source_type, session.league_id);
                        const timeoutPromise = new Promise((_, reject) =>
                            setTimeout(() => reject(new Error('Dashboard load timeout')), 15000)
                        );

                        Promise.race([loadPromise, timeoutPromise]).catch(err => {
                            console.error('Dashboard load failed:', err);
                            localStorage.removeItem('brdc_session');
                            showLoginPage();
                            alert('Session expired. Please log in again.');
                        });
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem('brdc_session');
                }
            }
            showLoginPage();
        }

        // Call init immediately - DOM is ready since ES modules are deferred
        initDashboard();

        function hideInitialLoader() {
            const loader = document.getElementById('initialLoader');
            if (loader) loader.style.display = 'none';
        }

        function showLoginPage() {
            hideInitialLoader();
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function showDashboard() {
            hideInitialLoader();
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

            // Check for pending tab from URL params
            if (window.pendingTab) {
                const tabBtn = document.querySelector(`.tab-container .tab[onclick*="switchTab('${window.pendingTab}')"]`);
                if (tabBtn) {
                    tabBtn.click();
                }
                window.pendingTab = null;
            }

            // Show onboarding for first-time users
            if (!localStorage.getItem('brdc_onboarding_complete')) {
                setTimeout(showOnboarding, 500); // Small delay for smoother UX
            }
        }

        // ================================
        // Onboarding Tutorial Functions
        // ================================
        let currentOnboardingSlide = 0;
        const totalOnboardingSlides = 5;
        let previouslyFocusedElement = null;

        function showOnboarding() {
            const overlay = document.getElementById('onboardingOverlay');
            if (!overlay) return;

            // Save currently focused element for restoration
            previouslyFocusedElement = document.activeElement;

            // Reset to first slide
            currentOnboardingSlide = 0;
            updateOnboardingSlide();

            // Show overlay
            overlay.classList.add('visible');

            // Focus trap - focus the first button
            setTimeout(() => {
                const skipBtn = document.getElementById('onboardingSkip');
                if (skipBtn) skipBtn.focus();
            }, 100);

            // Add keyboard listeners
            document.addEventListener('keydown', handleOnboardingKeyboard);
        }

        function hideOnboarding() {
            const overlay = document.getElementById('onboardingOverlay');
            if (!overlay) return;

            overlay.classList.remove('visible');

            // Remove keyboard listeners
            document.removeEventListener('keydown', handleOnboardingKeyboard);

            // Restore focus
            if (previouslyFocusedElement) {
                previouslyFocusedElement.focus();
            }
        }

        function updateOnboardingSlide() {
            const slides = document.querySelectorAll('.onboarding-slide');
            const dots = document.querySelectorAll('.onboarding-dot');
            const prevBtn = document.getElementById('onboardingPrev');
            const nextBtn = document.getElementById('onboardingNext');
            const skipBtn = document.getElementById('onboardingSkip');
            const checkboxRow = document.getElementById('onboardingCheckboxRow');
            const progressBar = document.querySelector('.onboarding-progress');

            // Update slides
            slides.forEach((slide, idx) => {
                slide.classList.toggle('active', idx === currentOnboardingSlide);
            });

            // Update progress dots
            dots.forEach((dot, idx) => {
                dot.classList.remove('active', 'completed');
                if (idx === currentOnboardingSlide) {
                    dot.classList.add('active');
                } else if (idx < currentOnboardingSlide) {
                    dot.classList.add('completed');
                }
            });

            // Update progress bar ARIA
            if (progressBar) {
                progressBar.setAttribute('aria-valuenow', currentOnboardingSlide + 1);
            }

            // Show/hide navigation buttons based on slide position
            const isFirstSlide = currentOnboardingSlide === 0;
            const isLastSlide = currentOnboardingSlide === totalOnboardingSlides - 1;

            if (prevBtn) {
                prevBtn.style.display = isFirstSlide ? 'none' : 'block';
            }

            if (skipBtn) {
                skipBtn.style.display = isLastSlide ? 'none' : 'block';
            }

            if (nextBtn) {
                nextBtn.textContent = isLastSlide ? 'GET STARTED' : 'NEXT';
            }

            // Show checkbox on last slide
            if (checkboxRow) {
                checkboxRow.style.display = isLastSlide ? 'flex' : 'none';
            }
        }

        window.nextOnboardingSlide = function() {
            if (currentOnboardingSlide < totalOnboardingSlides - 1) {
                currentOnboardingSlide++;
                updateOnboardingSlide();
            } else {
                // Last slide - complete onboarding
                completeOnboarding();
            }
        };

        window.prevOnboardingSlide = function() {
            if (currentOnboardingSlide > 0) {
                currentOnboardingSlide--;
                updateOnboardingSlide();
            }
        };

        window.skipOnboarding = function() {
            completeOnboarding();
        };

        function completeOnboarding() {
            const dontShowAgain = document.getElementById('dontShowAgain');

            // Always mark as complete for this session; if checked, persist permanently
            if (dontShowAgain && dontShowAgain.checked) {
                localStorage.setItem('brdc_onboarding_complete', 'true');
            } else {
                // Mark complete for this session using sessionStorage
                // so it won't show again during this browsing session
                sessionStorage.setItem('brdc_onboarding_shown', 'true');
                // Also set localStorage so it doesn't show repeatedly
                localStorage.setItem('brdc_onboarding_complete', 'true');
            }

            hideOnboarding();
        }

        function handleOnboardingKeyboard(e) {
            const overlay = document.getElementById('onboardingOverlay');
            if (!overlay || !overlay.classList.contains('visible')) return;

            switch (e.key) {
                case 'Escape':
                    e.preventDefault();
                    skipOnboarding();
                    break;
                case 'ArrowRight':
                case 'ArrowDown':
                    e.preventDefault();
                    nextOnboardingSlide();
                    break;
                case 'ArrowLeft':
                case 'ArrowUp':
                    e.preventDefault();
                    prevOnboardingSlide();
                    break;
                case 'Tab':
                    // Focus trap within modal
                    handleOnboardingFocusTrap(e);
                    break;
            }
        }

        function handleOnboardingFocusTrap(e) {
            const modal = document.querySelector('.onboarding-modal');
            if (!modal) return;

            const focusableElements = modal.querySelectorAll(
                'button:not([style*="display: none"]), input:not([style*="display: none"]), a[href], [tabindex]:not([tabindex="-1"])'
            );

            const visibleFocusable = Array.from(focusableElements).filter(el => {
                return el.offsetParent !== null && getComputedStyle(el).display !== 'none';
            });

            if (visibleFocusable.length === 0) return;

            const firstFocusable = visibleFocusable[0];
            const lastFocusable = visibleFocusable[visibleFocusable.length - 1];

            if (e.shiftKey) {
                // Shift+Tab: if on first element, go to last
                if (document.activeElement === firstFocusable) {
                    e.preventDefault();
                    lastFocusable.focus();
                }
            } else {
                // Tab: if on last element, go to first
                if (document.activeElement === lastFocusable) {
                    e.preventDefault();
                    firstFocusable.focus();
                }
            }
        }

        // Allow clicking dots to navigate directly
        document.addEventListener('DOMContentLoaded', function() {
            const dots = document.querySelectorAll('.onboarding-dot');
            dots.forEach((dot, idx) => {
                dot.style.cursor = 'pointer';
                dot.setAttribute('role', 'button');
                dot.setAttribute('aria-label', `Go to slide ${idx + 1}`);
                dot.setAttribute('tabindex', '0');
                dot.addEventListener('click', () => {
                    currentOnboardingSlide = idx;
                    updateOnboardingSlide();
                });
                dot.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        currentOnboardingSlide = idx;
                        updateOnboardingSlide();
                    }
                });
            });
        });

        window.login = async function() {
            const pin = document.getElementById('pinInput').value.trim();
            const errorDiv = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn');

            errorDiv.style.display = 'none';

            if (pin.length !== 8) {
                errorDiv.textContent = 'Please enter your 8-digit PIN';
                errorDiv.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'LOGGING IN...';

            try {
                const result = await callFunction('globalLogin', { pin: pin });

                if (result.success) {
                    currentPlayer = result.player;
                    localStorage.setItem('brdc_session', JSON.stringify({
                        player_id: currentPlayer.id,
                        name: currentPlayer.name,
                        pin: pin, // Save PIN for messaging
                        source_type: currentPlayer.source_type || 'global',
                        league_id: currentPlayer.league_id || null,
                        logged_in_at: Date.now()
                    }));
                    loadDashboard(currentPlayer.id, currentPlayer.source_type, currentPlayer.league_id);
                } else {
                    errorDiv.textContent = result.error || 'Login failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = error.message || 'Login failed. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'LOGIN';
            }
        };

        async function loadDashboard(playerId, sourceType, leagueId) {
            try {
                const result = await callFunction('getDashboardData', {
                    player_id: playerId,
                    source_type: sourceType || 'global',
                    league_id: leagueId || null
                });

                if (result.success) {
                    dashboardData = result.dashboard;
                    currentPlayer = dashboardData.player;
                    renderDashboard();
                    showDashboard();

                    // Initialize push notifications after successful login
                    if (currentPlayer?.id) {
                        initializePushNotifications(currentPlayer.id).catch(() => {});
                    }
                } else {
                    localStorage.removeItem('brdc_session');
                    showLoginPage();
                }
            } catch (error) {
                console.error('Load dashboard error:', error);
                localStorage.removeItem('brdc_session');
                showLoginPage();
            }
        }

        function renderDashboard() {
            const player = dashboardData.player;
            const roles = dashboardData.roles;

            // Profile header
            document.getElementById('welcomeName').textContent = player.name;

            // Show photo if exists, otherwise emoji
            if (player.photo_url) {
                document.getElementById('avatarImage').src = player.photo_url;
                document.getElementById('avatarImage').style.display = 'block';
                document.getElementById('avatarEmoji').style.display = 'none';
            } else {
                document.getElementById('avatarEmoji').textContent = player.isBot ? 'ü§ñ' : 'üë§';
                document.getElementById('avatarImage').style.display = 'none';
                document.getElementById('avatarEmoji').style.display = 'flex';
            }

            // Load notification settings (handled in populateSettingsForm)

            // Stats - handle multiple formats:
            // 1. Flat league stats (x01_legs_played, cricket_total_marks, etc.)
            // 2. unified_stats.totals format
            // 3. Global player format (stats.x01 / stats.cricket)
            const stats = player.stats || {};
            let x01Avg = '-';
            let mpr = '-';
            let ton180s = 0;
            let highOut = '-';
            let matchesPlayed = 0;
            let matchesWon = 0;
            let first9Avg = '-';
            let checkoutEff = '-';

            // Check for flat league stats format (from stats collection)
            if (stats.x01_total_darts !== undefined || stats.x01_legs_played !== undefined) {
                // League stats collection format: flat fields
                x01Avg = stats.x01_total_darts > 0 ? (stats.x01_total_points / stats.x01_total_darts * 3).toFixed(1) : '-';
                mpr = stats.cricket_total_rounds > 0 ? (stats.cricket_total_marks / stats.cricket_total_rounds).toFixed(2) : '-';
                ton180s = stats.x01_tons_180 || stats.x01_ton_80 || stats.x01_ton_eighties || 0;
                highOut = stats.x01_high_checkout || '-';
                matchesPlayed = (stats.x01_legs_played || 0) + (stats.cricket_legs_played || 0);
                matchesWon = (stats.x01_legs_won || 0) + (stats.cricket_legs_won || 0);
                // New DartConnect-compatible stats
                first9Avg = stats.x01_first9_avg ? stats.x01_first9_avg.toFixed(1) :
                    (stats.x01_first9_darts > 0 ? (stats.x01_first9_points / stats.x01_first9_darts * 3).toFixed(1) : '-');
                checkoutEff = stats.x01_checkout_efficiency ? stats.x01_checkout_efficiency.toFixed(1) + '%' :
                    (stats.x01_checkout_opps > 0 ? (stats.x01_checkouts / stats.x01_checkout_opps * 100).toFixed(1) + '%' : '-');
            }
            // Check for unified_stats format (league players)
            else if (stats.totals) {
                // League player format: unified_stats.totals
                const totals = stats.totals;
                // Use canonical field x01_three_dart_avg or legacy three_dart_avg
                x01Avg = totals.x01_three_dart_avg ? totals.x01_three_dart_avg.toFixed(1) :
                    (totals.three_dart_avg ? totals.three_dart_avg.toFixed(1) : '-');
                mpr = totals.cricket_mpr ? totals.cricket_mpr.toFixed(2) : '-';
                ton180s = totals.ton_eighties || totals['180s'] || 0;
                highOut = totals.high_checkout || '-';
                matchesPlayed = totals.matches_played || totals.legs_played || 0;
                matchesWon = totals.matches_won || totals.legs_won || 0;
                first9Avg = totals.first9_avg ? totals.first9_avg.toFixed(1) : '-';
                checkoutEff = totals.checkout_efficiency ? totals.checkout_efficiency.toFixed(1) + '%' : '-';
            } else {
                // Global player format: stats.x01 / stats.cricket
                const x01 = stats.x01 || {};
                const cricket = stats.cricket || {};
                x01Avg = x01.total_darts > 0 ? (x01.total_points / x01.total_darts * 3).toFixed(1) : '-';
                mpr = cricket.total_rounds > 0 ? (cricket.total_marks / cricket.total_rounds).toFixed(2) : '-';
                ton180s = x01.ton_eighties || 0;
                highOut = x01.high_checkout || '-';
                matchesPlayed = stats.matches_played || 0;
                matchesWon = stats.matches_won || 0;
                first9Avg = x01.first9_avg ? x01.first9_avg.toFixed(1) : '-';
                checkoutEff = x01.checkout_efficiency ? x01.checkout_efficiency.toFixed(1) + '%' : '-';
            }

            document.getElementById('statAvg').textContent = x01Avg;
            document.getElementById('statMpr').textContent = mpr;

            // Full stats link - include league_id for league players
            let statsUrl = `/pages/player-profile.html?player_id=${player.id}`;
            if (player.league_id) {
                statsUrl += `&league_id=${player.league_id}`;
            }
            document.getElementById('fullStatsLink').href = statsUrl;

            // Admin link (show for admins only)
            if (player.isAdmin) {
                document.getElementById('adminLink').style.display = 'block';
            }

            // Director tab (show if directing any leagues/tournaments)
            if (roles.directing && roles.directing.length > 0) {
                document.getElementById('directorTabBtn').classList.add('show');
                document.getElementById('directorTabBtn').style.display = 'block';
                populateDirectorTab(roles.directing);
            }

            // Captain tab (show if captain of any teams)
            if (roles.captaining && roles.captaining.length > 0) {
                document.getElementById('captainTabBtn').classList.add('show');
                document.getElementById('captainTabBtn').style.display = 'block';
                populateCaptainTeamSelect(roles.captaining);
            }

            // Teams tab - populate team selector
            if (roles.playing && roles.playing.length > 0) {
                populateTeamSelect(roles.playing);
            }

            // Load calendar (default tab)
            loadCalendar();

            // Load recent messages
            loadRecentMessages();

            // Update verification card status
            updateVerifyStatsCard(stats);
        }

        // ============================================================================
        // VERIFICATION CARD FUNCTIONS
        // ============================================================================

        function updateVerifyStatsCard(stats) {
            const card = document.getElementById('verifyStatsCard');
            if (!card) return;

            // Check for verification status
            const verificationStatus = stats?.verification_status;
            const verified3DA = stats?.verified_3da;
            const verifiedMPR = stats?.verified_mpr;
            const expiresAt = stats?.verification_expires_at;

            if (verificationStatus === 'verified' && (verified3DA || verifiedMPR)) {
                // Show verified stats in expanded view
                card.classList.add('verified');
                card.onclick = null; // Remove click handler - use button instead

                // Calculate days until expiration
                let expiresText = '';
                if (expiresAt) {
                    const expDate = expiresAt.toDate ? expiresAt.toDate() : new Date(expiresAt);
                    const daysLeft = Math.ceil((expDate - new Date()) / (1000 * 60 * 60 * 24));
                    if (daysLeft > 0) {
                        expiresText = `Expires in ${daysLeft} days`;
                    } else {
                        expiresText = 'Expired - please re-verify';
                    }
                }

                card.innerHTML = `
                    <div class="verified-header">
                        <div class="verify-stats-icon">‚úì</div>
                        <div class="verify-stats-title">VERIFIED STATS</div>
                        <span class="verify-stats-badge">VERIFIED</span>
                    </div>
                    <div class="verified-stats-grid">
                        <div class="verified-stat-box">
                            <div class="verified-stat-label">501 Average</div>
                            <div class="verified-stat-value ${verified3DA ? '' : 'pending'}">${verified3DA ? verified3DA.toFixed(1) : '---'}</div>
                        </div>
                        <div class="verified-stat-box">
                            <div class="verified-stat-label">Cricket MPR</div>
                            <div class="verified-stat-value ${verifiedMPR ? '' : 'pending'}">${verifiedMPR ? verifiedMPR.toFixed(2) : '---'}</div>
                        </div>
                    </div>
                    <button class="reverify-btn" onclick="navigateTo('/pages/stat-verification.html', event)">
                        üîÑ Re-verify Stats
                    </button>
                    ${expiresText ? `<div class="verified-expires">${expiresText}</div>` : ''}
                `;
            } else if (verificationStatus === 'self_reported') {
                // Show self-reported status
                const titleEl = document.getElementById('verifyStatsTitle');
                const descEl = document.getElementById('verifyStatsDesc');
                if (titleEl) titleEl.textContent = '‚ö†Ô∏è SELF-REPORTED STATS';
                if (descEl) descEl.textContent = 'Complete verification to get the ‚úì badge';
            } else {
                // Show default unverified status - keep original structure
                const titleEl = document.getElementById('verifyStatsTitle');
                const descEl = document.getElementById('verifyStatsDesc');
                if (titleEl) titleEl.textContent = 'VERIFY YOUR STATS';
                if (descEl) descEl.textContent = 'Get your official skill rating for captains to see';
            }
        }

        // ============================================================================
        // MESSAGING FUNCTIONS
        // ============================================================================

        async function loadRecentMessages() {
            if (!currentPlayer) return;

            // Get PIN from session for messaging functions
            const session = JSON.parse(localStorage.getItem('brdc_session') || '{}');
            const playerPin = session.pin || currentPlayer.pin;

            // Skip if no PIN available (messaging requires PIN)
            if (!playerPin) {
                return;
            }

            try {
                // Get conversations for this player
                const result = await callFunction('getConversations', {
                    player_pin: playerPin,
                    limit: 5
                });

                if (result.success && result.conversations && result.conversations.length > 0) {
                    renderRecentMessages(result.conversations);
                    document.getElementById('recentMessagesSection').style.display = 'block';
                }

                // Get unread count for header badge
                const unreadResult = await callFunction('getUnreadCount', {
                    player_pin: playerPin
                });

                if (unreadResult.success) {
                    updateUnreadBadge(unreadResult.total_unread || 0);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function renderRecentMessages(conversations) {
            const container = document.getElementById('recentMessagesList');

            if (!conversations || conversations.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><p>No messages yet</p></div>';
                return;
            }

            let totalUnread = 0;
            let html = '';

            conversations.forEach(conv => {
                const unreadCount = conv.unread_count || 0;
                totalUnread += unreadCount;

                // Get other participant name
                const otherName = conv.other_participant_name || 'Unknown';
                const initials = otherName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

                // Format time
                const timeStr = formatMessageTime(conv.last_message?.timestamp);
                const preview = conv.last_message?.text || 'No messages';

                html += `
                    <div class="conversation-item ${unreadCount > 0 ? 'unread' : ''}" onclick="openConversation('${conv.id}')">
                        <div class="conversation-avatar">${initials}</div>
                        <div class="conversation-info">
                            <div class="conversation-name">${otherName}</div>
                            <div class="conversation-preview">${preview.substring(0, 50)}${preview.length > 50 ? '...' : ''}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="conversation-time">${timeStr}</div>
                            ${unreadCount > 0 ? `<div class="conversation-unread-badge">${unreadCount}</div>` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Update total unread count display
            if (totalUnread > 0) {
                document.getElementById('totalUnreadCount').textContent = `(${totalUnread} unread)`;
            } else {
                document.getElementById('totalUnreadCount').textContent = '';
            }
        }

        function formatMessageTime(timestamp) {
            if (!timestamp) return '';

            let date;
            if (timestamp._seconds) {
                date = new Date(timestamp._seconds * 1000);
            } else if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else {
                date = new Date(timestamp);
            }

            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'now';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            if (days < 7) return `${days}d`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function updateUnreadBadge(count) {
            const badge = document.getElementById('headerUnreadBadge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        window.openConversation = function(conversationId) {
            window.location.href = `/pages/conversation.html?id=${conversationId}`;
        };

        window.goToMessages = function() {
            window.location.href = '/pages/messages.html';
        };

        // Chat bubble expansion
        let chatBubbleData = { rooms: [], dms: [] };

        window.toggleChatMenu = function() {
            const container = document.getElementById('chatBubbleContainer');
            const isExpanded = container.classList.contains('expanded');

            if (isExpanded) {
                container.classList.remove('expanded');
            } else {
                container.classList.add('expanded');
                loadChatBubbles();
            }
        };

        // Close chat menu when clicking outside
        document.addEventListener('click', function(e) {
            const container = document.getElementById('chatBubbleContainer');
            if (container && !container.contains(e.target) && container.classList.contains('expanded')) {
                container.classList.remove('expanded');
            }
        });

        async function loadChatBubbles() {
            if (!currentPlayer) return;

            const session = JSON.parse(localStorage.getItem('brdc_session') || '{}');
            const playerPin = session.pin || currentPlayer.pin;
            if (!playerPin) return;

            const roomsSection = document.getElementById('chatRoomsSection');
            const dmsSection = document.getElementById('chatDmsSection');

            try {
                // Load team/league chat rooms
                const rooms = [];

                // Add team chat rooms for teams player is on
                if (allTeams && allTeams.length > 0) {
                    allTeams.forEach(team => {
                        rooms.push({
                            id: `team_${team.team_id}`,
                            type: 'team',
                            name: team.team_name || 'Team Chat',
                            icon: 'üéØ',
                            unread: 0 // Would need real unread count from backend
                        });
                    });
                }

                // Render room circles (vertical)
                if (rooms.length > 0) {
                    roomsSection.innerHTML = rooms.map(room => `
                        <div class="chat-room-circle" onclick="openChatRoom('${room.id}')" title="${room.name}">
                            ${room.icon}
                            <span class="room-label">${room.name}</span>
                            ${room.unread > 0 ? `<span class="circle-badge">${room.unread}</span>` : ''}
                        </div>
                    `).join('');
                } else {
                    roomsSection.innerHTML = '';
                }

                // Load DM conversations
                const result = await callFunction('getConversations', {
                    player_pin: playerPin,
                    limit: 6
                });

                if (result.success && result.conversations && result.conversations.length > 0) {
                    const dms = result.conversations.map(conv => {
                        const otherName = conv.other_participant_name || 'Unknown';
                        const initial = otherName.charAt(0).toUpperCase();
                        const photoUrl = conv.other_participant_photo || null;
                        const participantCount = conv.participant_count || 2;

                        return {
                            id: conv.id,
                            name: otherName,
                            initial: initial,
                            photo: photoUrl,
                            unread: conv.unread_count || 0,
                            isGroup: participantCount > 2,
                            participants: conv.participants || []
                        };
                    });

                    // Render DM circles (horizontal)
                    dmsSection.innerHTML = dms.map(dm => {
                        if (dm.isGroup && dm.participants.length > 2) {
                            // Group DM - overlapping circles
                            const groupCircles = dm.participants.slice(0, 3).map((p, i) => {
                                const pInitial = (p.name || 'U').charAt(0).toUpperCase();
                                return `<div class="chat-dm-circle" style="z-index: ${3-i}">
                                    ${p.photo_url ? `<img src="${p.photo_url}" alt="">` : `<span class="dm-initial">${pInitial}</span>`}
                                </div>`;
                            }).join('');
                            return `
                                <div class="chat-dm-group" onclick="openConversation('${dm.id}')" title="${dm.name}">
                                    ${groupCircles}
                                    ${dm.unread > 0 ? `<span class="circle-badge" style="position: absolute; top: -4px; right: -4px;">${dm.unread}</span>` : ''}
                                </div>
                            `;
                        } else {
                            // Single DM
                            return `
                                <div class="chat-dm-circle" onclick="openConversation('${dm.id}')" title="${dm.name}">
                                    ${dm.photo ? `<img src="${dm.photo}" alt="">` : `<span class="dm-initial">${dm.initial}</span>`}
                                    ${dm.unread > 0 ? `<span class="circle-badge">${dm.unread}</span>` : ''}
                                </div>
                            `;
                        }
                    }).join('');
                } else {
                    dmsSection.innerHTML = '';
                }

                // If no rooms and no DMs, show a single "go to messages" option
                if (rooms.length === 0 && (!result.conversations || result.conversations.length === 0)) {
                    roomsSection.innerHTML = `
                        <div class="chat-room-circle" onclick="goToMessages()" title="Messages">
                            üì®
                            <span class="room-label">Open Messages</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading chat bubbles:', error);
                roomsSection.innerHTML = `
                    <div class="chat-room-circle" onclick="goToMessages()" title="Messages">
                        üì®
                        <span class="room-label">Open Messages</span>
                    </div>
                `;
            }
        }

        window.openChatRoom = function(roomId) {
            // For now, go to messages page - could be enhanced with room-specific view
            window.location.href = `/pages/messages.html?room=${roomId}`;
        };

        // Store all teams for "all teams" view
        let allTeams = [];

        function populateTeamSelect(teams) {
            if (teams.length === 0) return;
            allTeams = teams;
        }

        function populateCaptainTeamSelect(teams) {
            const select = document.getElementById('captainTeamSelect');
            select.innerHTML = teams.map(t =>
                `<option value="${t.league_id}|${t.team_id}">${t.team_name} - ${t.league_name}</option>`
            ).join('');

            // Auto-select first team
            if (teams.length > 0) {
                selectedCaptainTeamId = teams[0].team_id;
                loadCaptainTeam();
            }
        }

        let currentLeagueId = null;

        window.loadTeamSchedule = async function() {
            const select = document.getElementById('teamSelect');
            const container = document.getElementById('teamScheduleContainer');
            container.innerHTML = '<div class="empty-state">Loading schedule...</div>';

            // Handle "All Teams" view
            if (select.value === 'all') {
                await loadAllTeamsView();
                return;
            }

            const [leagueId, teamId] = select.value.split('|');
            selectedTeamId = teamId;
            currentLeagueId = leagueId;

            try {
                const result = await callFunction('getTeamScheduleEnhanced', {
                    league_id: leagueId,
                    team_id: teamId,
                    player_id: currentPlayer.id
                });

                if (result.success) {
                    renderTeamScheduleEnhanced(result);
                } else {
                    container.innerHTML = '<div class="empty-state">Could not load schedule</div>';
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
                container.innerHTML = '<div class="empty-state">Error loading schedule</div>';
            }
        };

        // Load view showing next match for each team
        async function loadAllTeamsView() {
            const container = document.getElementById('teamScheduleContainer');

            if (allTeams.length === 0) {
                container.innerHTML = '<div class="empty-state">No teams found</div>';
                return;
            }

            try {
                // Load schedule for each team in parallel
                const schedulePromises = allTeams.map(async (t) => {
                    const leagueId = t.id || t.league_id;
                    const result = await callFunction('getTeamScheduleEnhanced', {
                        league_id: leagueId,
                        team_id: t.team_id,
                        player_id: currentPlayer.id
                    });
                    return {
                        team: t,
                        leagueId,
                        ...result
                    };
                });

                const allSchedules = await Promise.all(schedulePromises);

                // Render "All Teams" view - show next upcoming match for each team
                let html = '<div class="match-cards-container">';

                allSchedules.forEach(schedule => {
                    if (!schedule.success) return;

                    const nextMatch = schedule.upcoming?.[0];
                    const teamName = schedule.team.team_name || 'My Team';
                    const leagueName = schedule.team.name || schedule.team.league_name || '';

                    html += `<div class="all-teams-section">`;
                    html += `<div class="all-teams-header" onclick="toggleTeamExpand('${schedule.team.team_id}')">
                        <span class="all-teams-title">${teamName}</span>
                        <span class="all-teams-league">${leagueName}</span>
                        <span class="all-teams-expand" id="expand-${schedule.team.team_id}">‚ñº</span>
                    </div>`;

                    if (nextMatch) {
                        currentLeagueId = schedule.leagueId;
                        html += `<div class="all-teams-next">${renderMatchCard(nextMatch, schedule.leagueId, false)}</div>`;
                    } else {
                        html += `<div class="empty-state" style="padding: 15px;">No upcoming matches</div>`;
                    }

                    // Hidden section for full schedule
                    html += `<div class="all-teams-full" id="full-${schedule.team.team_id}" style="display: none;">`;
                    if (schedule.upcoming?.length > 1) {
                        schedule.upcoming.slice(1).forEach(match => {
                            html += renderMatchCard(match, schedule.leagueId, false);
                        });
                    }
                    if (schedule.past?.length > 0) {
                        html += '<div class="match-section-title">PAST MATCHES</div>';
                        schedule.past.forEach(match => {
                            html += renderMatchCard(match, schedule.leagueId, true);
                        });
                    }
                    html += `</div></div>`;
                });

                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading all teams:', error);
                container.innerHTML = '<div class="empty-state">Error loading schedules</div>';
            }
        }

        window.toggleTeamExpand = function(teamId) {
            const fullSection = document.getElementById('full-' + teamId);
            const expandIcon = document.getElementById('expand-' + teamId);
            if (fullSection.style.display === 'none') {
                fullSection.style.display = 'block';
                expandIcon.textContent = '‚ñ≤';
            } else {
                fullSection.style.display = 'none';
                expandIcon.textContent = '‚ñº';
            }
        };

        function renderTeamScheduleEnhanced(data) {
            const container = document.getElementById('teamScheduleContainer');
            const { upcoming, past, league_id } = data;

            if ((!upcoming || upcoming.length === 0) && (!past || past.length === 0)) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üìÖ</div><p>No matches scheduled yet.</p></div>';
                return;
            }

            let html = '<div class="match-cards-container">';

            // Upcoming matches
            if (upcoming && upcoming.length > 0) {
                html += '<div class="match-section-title">UPCOMING MATCHES</div>';
                upcoming.forEach(match => {
                    html += renderMatchCard(match, league_id, false);
                });
            }

            // Past matches
            if (past && past.length > 0) {
                html += '<div class="match-section-title">PAST MATCHES</div>';
                past.forEach(match => {
                    html += renderMatchCard(match, league_id, true);
                });
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderMatchCard(match, leagueId, isPast) {
            const dateStr = match.match_date
                ? new Date(match.match_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
                : 'TBD';

            const myAvail = match.my_availability || 'unknown';
            const cantSelected = myAvail === 'unavailable' ? 'selected' : '';
            const inSelected = myAvail === 'confirmed' ? 'selected' : '';

            // Render player rows for a team
            const renderRoster = (roster, availability, isMyTeam, isPast, match) => {
                if (!roster || roster.length === 0) {
                    return '<div class="match-player-row"><span class="match-player-name">No players</span></div>';
                }

                return roster.map(p => {
                    let rowClass = '';
                    if (isMyTeam && availability) {
                        const avail = availability[p.id] || 'unknown';
                        if (avail === 'unavailable') rowClass = 'unavailable';
                        else if (avail === 'sub') rowClass = 'sub';
                        else if (avail === 'confirmed') rowClass = 'confirmed';
                    }

                    // Use match-specific stats for past matches if available
                    // Canonical: x01_three_dart_avg, cricket_mpr. Legacy: x01_avg, mpr
                    let x01Stat = p.x01_three_dart_avg || p.x01_avg || '-';
                    let mprStat = p.cricket_mpr || p.mpr || '-';
                    if (isPast && match && match.player_stats && match.player_stats[p.id]) {
                        const stats = match.player_stats[p.id];
                        x01Stat = stats.x01_three_dart_avg || stats.x01_avg || x01Stat;
                        mprStat = stats.cricket_mpr || stats.mpr || mprStat;
                    }

                    return `
                        <div class="match-player-row ${rowClass}">
                            <span class="match-player-level">${p.level || ''}</span>
                            <span class="match-player-name" onclick="viewPlayer('${p.id}', event)">${p.name}</span>
                            <span class="match-player-stats">${x01Stat} / ${mprStat}</span>
                        </div>
                    `;
                }).join('');
            };

            let resultHtml = '';
            if (isPast && match.completed) {
                const resultClass = match.won ? 'won' : 'lost';
                const resultLabel = match.won ? 'WIN' : 'LOSS';
                resultHtml = `
                    <div class="match-result">
                        <div class="match-result-label">${resultLabel}</div>
                        <div class="match-result-score ${resultClass}">${match.my_score} - ${match.their_score}</div>
                    </div>
                `;
            }

            // Add "Go to Match Night" button for upcoming matches
            let matchNightBtn = '';
            if (!isPast) {
                matchNightBtn = `
                    <div class="match-night-btn-container">
                        <a href="/pages/match-night.html?league_id=${leagueId}&match_id=${match.id}" class="match-night-btn">
                            üéØ GO TO MATCH NIGHT
                        </a>
                    </div>
                `;
            }

            return `
                <div class="match-card event-league ${isPast ? 'past' : ''}">
                    <div class="match-card-body">
                        <button class="match-avail-btn cant-btn ${cantSelected}"
                                onclick="updateAvailability('${leagueId}', '${match.id}', 'unavailable')"
                                ${isPast ? 'disabled' : ''}>
                            <span class="icon">‚úó</span>
                            CAN'T
                        </button>

                        <div class="match-team-section">
                            <div class="match-team-header">
                                <span class="match-team-name" onclick="viewTeam('${match.my_team.id}', event)">${match.my_team.name}</span>
                                <span class="match-team-record">${match.my_team.record}</span>
                            </div>
                            ${renderRoster(match.my_team.roster, match.my_team.availability, true, isPast, match)}
                        </div>

                        <div class="match-center-divider">
                            <div class="match-center-week">WK ${match.week}</div>
                            <div class="match-center-date">${dateStr}</div>
                        </div>

                        <div class="match-team-section">
                            <div class="match-team-header">
                                <span class="match-team-name" onclick="viewTeam('${match.opponent.id}', event)">${match.opponent.name}</span>
                                <span class="match-team-record">${match.opponent.record}</span>
                            </div>
                            ${renderRoster(match.opponent.roster, null, false, isPast, match)}
                        </div>

                        <button class="match-avail-btn in-btn ${inSelected}"
                                onclick="updateAvailability('${leagueId}', '${match.id}', 'confirmed')"
                                ${isPast ? 'disabled' : ''}>
                            <span class="icon">‚úì</span>
                            I'M IN
                        </button>
                    </div>
                    ${resultHtml}
                    ${matchNightBtn}
                </div>
            `;
        }

        // Notification preference toggle functions
        function loadNotificationSettings() {
            if (!currentPlayer) return;

            const notifications = currentPlayer.notifications || {};

            // Default: SMS on, email off, push off (needs permission)
            const smsEnabled = notifications.sms ?? true;
            const emailEnabled = notifications.email ?? false;
            const pushEnabled = notifications.push ?? false;

            document.getElementById('notifySms').classList.toggle('on', smsEnabled);
            document.getElementById('notifyEmail').classList.toggle('on', emailEnabled);
            document.getElementById('notifyPush').classList.toggle('on', pushEnabled);
        }

        window.toggleNotification = async function(type) {
            if (!currentPlayer) return;

            const toggleEl = document.getElementById(`notify${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const currentValue = toggleEl.classList.contains('on');
            const newValue = !currentValue;

            // Special handling for push notifications - need permission
            if (type === 'push' && newValue) {
                try {
                    // Request push notification permission
                    if (typeof initializePushNotifications === 'function') {
                        const granted = await initializePushNotifications(currentPlayer.id);
                        if (!granted) {
                            alert('Push notification permission was denied. Please enable it in your browser settings.');
                            return;
                        }
                    } else {
                        alert('Push notifications are not available in this browser.');
                        return;
                    }
                } catch (err) {
                    console.error('Push permission error:', err);
                    alert('Could not enable push notifications.');
                    return;
                }
            }

            // Optimistic UI update
            toggleEl.classList.toggle('on', newValue);

            try {
                // Update notification settings via updateGlobalPlayer
                const notifications = { ...(currentPlayer.notifications || {}) };
                notifications[type] = newValue;

                const result = await callFunction('updateGlobalPlayer', {
                    player_id: currentPlayer.id,
                    notifications: notifications
                });

                if (result.success) {
                    currentPlayer.notifications = notifications;
                } else {
                    // Revert on failure
                    toggleEl.classList.toggle('on', currentValue);
                    alert(result.error || 'Failed to update notification setting');
                }
            } catch (error) {
                console.error('Error updating notification:', error);
                // Revert on error
                toggleEl.classList.toggle('on', currentValue);
                alert('Error updating notification setting');
            }
        };

        window.viewPlayer = function(playerId, event) {
            const url = `/pages/player-profile.html?id=${playerId}`;
            // Support middle-click / ctrl+click to open in new tab
            if (event && (event.ctrlKey || event.metaKey || event.button === 1)) {
                window.open(url, '_blank');
            } else {
                window.location.href = url;
            }
        };

        window.viewTeam = function(teamId, event) {
            if (currentLeagueId) {
                const url = `/pages/team-profile.html?league_id=${currentLeagueId}&team_id=${teamId}`;
                // Support middle-click / ctrl+click to open in new tab
                if (event && (event.ctrlKey || event.metaKey || event.button === 1)) {
                    window.open(url, '_blank');
                } else {
                    window.location.href = url;
                }
            }
        };

        // General navigation helper that supports middle-click / ctrl+click
        window.navigateTo = function(url, event) {
            if (event && (event.ctrlKey || event.metaKey || event.button === 1)) {
                window.open(url, '_blank');
            } else {
                window.location.href = url;
            }
        };

        window.updateAvailability = async function(leagueId, matchId, status) {
            try {
                const result = await callFunction('updatePlayerAvailability', {
                    league_id: leagueId,
                    match_id: matchId,
                    player_id: currentPlayer.id,
                    status: status
                });

                if (result.success) {
                    // Reload schedule to show updated status
                    loadTeamSchedule();
                    if (status === 'unavailable') {
                        alert('Your captain has been notified to find a substitute.');
                    }
                } else {
                    console.error('Availability update failed:', result.error);
                    alert('Something went wrong. Please try again.');
                }
            } catch (error) {
                console.error('Error updating availability:', error);
                alert('Something went wrong. Please try again.');
            }
        };

        // ============================================================================
        // CAPTAIN FUNCTIONS
        // ============================================================================

        window.openCaptainDashboard = function() {
            if (selectedCaptainLeagueId) {
                window.open(`/pages/captain-dashboard.html?league_id=${selectedCaptainLeagueId}`, '_blank');
            } else {
                alert('Please select a team first');
            }
        };

        window.loadCaptainTeam = async function() {
            const select = document.getElementById('captainTeamSelect');
            const [leagueId, teamId] = select.value.split('|');
            selectedCaptainTeamId = teamId;
            selectedCaptainLeagueId = leagueId;

            try {
                const result = await callFunction('getCaptainTeamData', {
                    league_id: leagueId,
                    team_id: teamId,
                    captain_id: currentPlayer.id
                });

                if (result.success) {
                    captainTeamData = result;

                    // Load new roster tab sections
                    renderTeamRosterList(result.roster);
                    renderAvailabilityGrid(result.roster, result.schedule);
                    renderGotoSubs(result.goto_subs || {});
                    renderSubPool(result.subs);

                    // Load schedule
                    renderCaptainSchedule(result.schedule, leagueId);

                    // Load settings
                    loadCaptainSettings(result);

                    // Populate fill-in match select
                    populateFillinMatchSelect(result.schedule);

                    // Check for urgent upcoming match (within 48 hours)
                    checkUrgentMatch(result.schedule);
                }
            } catch (error) {
                console.error('Error loading captain team:', error);
            }
        };

        // Check for urgent upcoming match and show banner
        function checkUrgentMatch(schedule) {
            const banner = document.getElementById('urgentSubBanner');
            if (!banner || !schedule) {
                if (banner) banner.style.display = 'none';
                return;
            }

            const now = new Date();
            const upcoming = schedule
                .filter(m => !m.completed && m.match_date)
                .map(m => ({
                    ...m,
                    dateObj: new Date(m.match_date)
                }))
                .filter(m => m.dateObj > now)
                .sort((a, b) => a.dateObj - b.dateObj);

            if (upcoming.length === 0) {
                banner.style.display = 'none';
                return;
            }

            const nextMatch = upcoming[0];
            const hoursUntil = (nextMatch.dateObj - now) / (1000 * 60 * 60);

            // Show banner if match is within 48 hours
            if (hoursUntil <= 48) {
                banner.style.display = 'flex';

                // Format countdown
                let countdown;
                if (hoursUntil < 1) {
                    const minutes = Math.floor(hoursUntil * 60);
                    countdown = `${minutes} min`;
                } else if (hoursUntil < 24) {
                    countdown = `${Math.floor(hoursUntil)} hours`;
                } else {
                    const days = Math.floor(hoursUntil / 24);
                    countdown = days === 1 ? 'tomorrow' : `${days} days`;
                }

                document.getElementById('urgentMatchCountdown').textContent = countdown;
                document.getElementById('urgentMatchInfo').textContent =
                    `Week ${nextMatch.week} vs ${nextMatch.opponent_name}`;

                // Store for pre-selection in fill-in modal
                window.urgentMatchId = nextMatch.id;
            } else {
                banner.style.display = 'none';
                window.urgentMatchId = null;
            }
        }

        // Team name editing functions
        let selectedCaptainLeagueId = null;

        window.showTeamNameEdit = function() {
            const currentName = document.getElementById('currentTeamName').textContent;
            document.getElementById('newTeamNameInput').value = currentName;
            document.getElementById('teamNameEditForm').style.display = 'block';
            document.querySelector('.team-name-display').style.display = 'none';
            document.getElementById('newTeamNameInput').focus();
        };

        window.cancelTeamNameEdit = function() {
            document.getElementById('teamNameEditForm').style.display = 'none';
            document.querySelector('.team-name-display').style.display = 'flex';
        };

        window.saveTeamName = async function() {
            const newName = document.getElementById('newTeamNameInput').value.trim();
            if (!newName) {
                alert('Please enter a team name');
                return;
            }

            try {
                const result = await callFunction('updateTeamName', {
                    league_id: selectedCaptainLeagueId,
                    team_id: selectedCaptainTeamId,
                    captain_id: currentPlayer.id,
                    team_name: newName
                });

                if (result.success) {
                    document.getElementById('currentTeamName').textContent = newName;
                    cancelTeamNameEdit();

                    // Update the dropdown too
                    const select = document.getElementById('captainTeamSelect');
                    const selectedOption = select.options[select.selectedIndex];
                    const parts = selectedOption.text.split(' - ');
                    if (parts.length > 1) {
                        selectedOption.text = newName + ' - ' + parts.slice(1).join(' - ');
                    }
                } else {
                    console.error('Team name update failed:', result.error);
                    alert('Something went wrong. Please try again.');
                }
            } catch (error) {
                console.error('Error updating team name:', error);
                alert('Something went wrong. Please try again.');
            }
        };

        function renderCaptainRoster(roster) {
            const grid = document.getElementById('rosterGrid');

            if (!roster || roster.length === 0) {
                grid.innerHTML = '<div class="empty-state">No players on roster</div>';
                return;
            }

            const posLabel = (pos) => ['', 'A', 'B', 'C'][pos] || pos;
            grid.innerHTML = roster.map(p => `
                <div class="roster-card ${p.is_captain ? 'captain-card' : ''}">
                    <div class="player-position">${posLabel(p.position)} ${p.is_captain ? '- CAPTAIN' : ''}</div>
                    <div class="player-name-roster">${p.name}</div>
                    <div class="player-stats-mini">
                        <div class="stat-mini">
                            <div class="stat-mini-label">X01 Avg</div>
                            <div class="stat-mini-value">${p.x01_three_dart_avg || p.x01_avg || '-'}</div>
                        </div>
                        <div class="stat-mini">
                            <div class="stat-mini-label">MPR</div>
                            <div class="stat-mini-value">${p.cricket_mpr || p.mpr || '-'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderCaptainSchedule(schedule, leagueId) {
            const container = document.getElementById('captainScheduleTable');

            if (!schedule || schedule.length === 0) {
                container.innerHTML = '<div class="empty-state">No matches scheduled</div>';
                return;
            }

            const posLabel = (pos) => ['', 'A', 'B', 'C', 'D'][pos] || pos;

            // Separate into upcoming and past
            const upcoming = schedule.filter(m => !m.completed);
            const past = schedule.filter(m => m.completed);

            let html = '<div class="match-cards-container">';

            if (upcoming.length > 0) {
                html += '<div class="match-section-title">UPCOMING MATCHES</div>';
                upcoming.forEach(match => {
                    html += renderCaptainMatchCard(match, posLabel);
                });
            }

            if (past.length > 0) {
                html += '<div class="match-section-title">COMPLETED MATCHES</div>';
                past.forEach(match => {
                    html += renderCaptainMatchCard(match, posLabel, true);
                });
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderCaptainMatchCard(match, posLabel, isPast = false) {
            const dateStr = match.match_date
                ? new Date(match.match_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
                : 'TBD';

            const isCompleted = match.completed || isPast;
            const homeScore = match.home_score || 0;
            const awayScore = match.away_score || 0;
            const homeWon = isCompleted && homeScore > awayScore;
            const awayWon = isCompleted && awayScore > homeScore;

            // Calculate team averages
            const calcTeamAvg = (lineup) => {
                if (!lineup || lineup.length === 0) return { avg: null, mpr: null };
                const avgs = lineup.map(p => parseFloat(p.x01_three_dart_avg || p.x01_avg) || 0).filter(v => v > 0);
                const mprs = lineup.map(p => parseFloat(p.cricket_mpr || p.mpr) || 0).filter(v => v > 0);
                return {
                    avg: avgs.length > 0 ? (avgs.reduce((a, b) => a + b, 0) / avgs.length) : null,
                    mpr: mprs.length > 0 ? (mprs.reduce((a, b) => a + b, 0) / mprs.length) : null
                };
            };

            const homeTeamStats = calcTeamAvg(match.home_lineup);
            const awayTeamStats = calcTeamAvg(match.away_lineup);

            // Compare values for coloring
            const compareValues = (leftVal, rightVal) => {
                if (!leftVal || !rightVal) return { left: '', right: '' };
                if (Math.abs(leftVal - rightVal) < 0.1) return { left: '', right: '' };
                return leftVal > rightVal ? { left: 'better', right: 'worse' } : { left: 'worse', right: 'better' };
            };

            const avgCompare = compareValues(homeTeamStats.avg, awayTeamStats.avg);
            const mprCompare = compareValues(homeTeamStats.mpr, awayTeamStats.mpr);

            const homeAvgDisplay = homeTeamStats.avg ? homeTeamStats.avg.toFixed(1) : '-';
            const awayAvgDisplay = awayTeamStats.avg ? awayTeamStats.avg.toFixed(1) : '-';
            const homeMprDisplay = homeTeamStats.mpr ? homeTeamStats.mpr.toFixed(2) : '-';
            const awayMprDisplay = awayTeamStats.mpr ? awayTeamStats.mpr.toFixed(2) : '-';

            // Build roster rows - side by side comparison
            const homePlayers = match.home_lineup || [];
            const awayPlayers = match.away_lineup || [];
            const maxPlayers = Math.max(homePlayers.length, awayPlayers.length, 3);

            let rosterRows = '';
            for (let i = 0; i < maxPlayers; i++) {
                const homePlayer = homePlayers[i];
                const awayPlayer = awayPlayers[i];

                // Home player info
                let homeName = homePlayer ? (homePlayer.name || 'Unknown') : '';
                let homeStats = homePlayer ? `${homePlayer.x01_three_dart_avg || homePlayer.x01_avg || '-'} / ${homePlayer.cricket_mpr || homePlayer.mpr || '-'}` : '';
                let homeNameClass = 'match-player-name';
                let homeBadge = '';

                if (homePlayer) {
                    if (homePlayer.is_sub) {
                        homeBadge = '<span class="fill-in-badge">SUB</span> ';
                        homeNameClass += ' fill-in';
                    } else if (homePlayer.needs_fillin) {
                        homeBadge = '<span class="need-sub-badge">NEED</span> ';
                    } else if (homePlayer.availability === 'confirmed' && match.is_home) {
                        homeBadge = '<span class="confirmed-badge">‚úì</span> ';
                    } else if (homePlayer.availability === 'unavailable' && match.is_home) {
                        homeBadge = '<span class="unavail-badge">‚úó</span> ';
                    }
                    if (homePlayer.is_captain || homePlayer.position === 1) {
                        homeNameClass += ' captain';
                    }
                }

                // Away player info
                let awayName = awayPlayer ? (awayPlayer.name || 'Unknown') : '';
                let awayStats = awayPlayer ? `${awayPlayer.x01_three_dart_avg || awayPlayer.x01_avg || '-'} / ${awayPlayer.cricket_mpr || awayPlayer.mpr || '-'}` : '';
                let awayNameClass = 'match-player-name';
                let awayBadge = '';

                if (awayPlayer) {
                    if (awayPlayer.is_sub) {
                        awayBadge = ' <span class="fill-in-badge">SUB</span>';
                        awayNameClass += ' fill-in';
                    } else if (awayPlayer.needs_fillin) {
                        awayBadge = ' <span class="need-sub-badge">NEED</span>';
                    } else if (awayPlayer.availability === 'confirmed' && !match.is_home) {
                        awayBadge = ' <span class="confirmed-badge">‚úì</span>';
                    } else if (awayPlayer.availability === 'unavailable' && !match.is_home) {
                        awayBadge = ' <span class="unavail-badge">‚úó</span>';
                    }
                    if (awayPlayer.is_captain || awayPlayer.position === 1) {
                        awayNameClass += ' captain';
                    }
                }

                // Compare individual stats
                const homeAvg = homePlayer ? parseFloat(homePlayer.x01_three_dart_avg || homePlayer.x01_avg) || 0 : 0;
                const awayAvg = awayPlayer ? parseFloat(awayPlayer.x01_three_dart_avg || awayPlayer.x01_avg) || 0 : 0;
                const homeMpr = homePlayer ? parseFloat(homePlayer.cricket_mpr || homePlayer.mpr) || 0 : 0;
                const awayMpr = awayPlayer ? parseFloat(awayPlayer.cricket_mpr || awayPlayer.mpr) || 0 : 0;

                const playerAvgCompare = (homePlayer && awayPlayer) ? compareValues(homeAvg, awayAvg) : { left: '', right: '' };
                const playerMprCompare = (homePlayer && awayPlayer) ? compareValues(homeMpr, awayMpr) : { left: '', right: '' };

                const homeStatsHtml = homePlayer ? `<span class="${playerAvgCompare.left}">${homePlayer.x01_three_dart_avg || homePlayer.x01_avg || '-'}</span> / <span class="${playerMprCompare.left}">${homePlayer.cricket_mpr || homePlayer.mpr || '-'}</span>` : '';
                const awayStatsHtml = awayPlayer ? `<span class="${playerAvgCompare.right}">${awayPlayer.x01_three_dart_avg || awayPlayer.x01_avg || '-'}</span> / <span class="${playerMprCompare.right}">${awayPlayer.cricket_mpr || awayPlayer.mpr || '-'}</span>` : '';

                rosterRows += `
                    <div class="match-row">
                        <div class="match-player-cell left">
                            <span class="match-player-stats">${homeStatsHtml}</span>
                            <span class="${homeNameClass}">${homeBadge}${homeName}</span>
                        </div>
                        <div class="match-player-cell right">
                            <span class="${awayNameClass}">${awayName}${awayBadge}</span>
                            <span class="match-player-stats">${awayStatsHtml}</span>
                        </div>
                    </div>`;
            }

            // Status indicator
            let statusLabel = '';
            if (isCompleted) {
                statusLabel = 'FINAL';
            } else if (match.in_progress) {
                statusLabel = '<span style="color: var(--pink);">LIVE</span>';
            } else {
                statusLabel = dateStr;
            }

            // Your team indicator
            const yourTeamBadge = '<span class="your-team-badge">YOU</span>';

            return `
                <div class="match-card event-league ${isPast ? 'past' : ''}">
                    <div class="match-card-header${isCompleted ? ' completed' : ''}">
                        <div class="match-team-side left${homeWon ? ' winner' : ''}">
                            ${isCompleted && homeWon ? '<span class="winner-star">‚òÖ</span>' : ''}
                            <div class="match-team-info-row">
                                ${match.is_home ? yourTeamBadge : ''}
                                <span class="match-team-name">${match.home_team_name || 'Home'}</span>
                            </div>
                            <div class="match-team-avg">
                                <span class="${avgCompare.left}">${homeAvgDisplay}</span> / <span class="${mprCompare.left}">${homeMprDisplay}</span>
                            </div>
                            ${isCompleted ? `<div class="match-header-score${homeWon ? ' winner' : ''}">${homeScore}</div>` : ''}
                        </div>
                        <div class="match-center">
                            <div class="match-week">WEEK ${match.week || '?'}</div>
                            <div class="match-vs">${statusLabel}</div>
                        </div>
                        <div class="match-team-side right${awayWon ? ' winner' : ''}">
                            ${isCompleted ? `<div class="match-header-score${awayWon ? ' winner' : ''}">${awayScore}</div>` : ''}
                            <div class="match-team-info-row">
                                <span class="match-team-name">${match.away_team_name || 'Away'}</span>
                                ${!match.is_home ? yourTeamBadge : ''}
                            </div>
                            <div class="match-team-avg">
                                <span class="${avgCompare.right}">${awayAvgDisplay}</span> / <span class="${mprCompare.right}">${awayMprDisplay}</span>
                            </div>
                            ${isCompleted && awayWon ? '<span class="winner-star">‚òÖ</span>' : ''}
                        </div>
                    </div>
                    <div class="match-card-body">
                        ${rosterRows}
                    </div>
                    ${!isCompleted ? `
                    <div class="match-card-footer captain-footer">
                        <button class="captain-action-btn" onclick="openLineupForMatch('${match.id}')">üìù Set Lineup</button>
                        <a href="/pages/match-hub.html?league_id=${selectedCaptainLeagueId}&match_id=${match.id}" class="captain-action-btn secondary">View Match</a>
                    </div>` : `
                    <div class="match-card-footer captain-footer">
                        <a href="/pages/match-hub.html?league_id=${selectedCaptainLeagueId}&match_id=${match.id}" class="captain-action-btn secondary" style="margin: 0 auto;">View Match Details</a>
                    </div>`}
                </div>
            `;
        }

        // Helper to open lineup tab with specific match selected
        window.openLineupForMatch = function(matchId) {
            switchCaptainSubtab('lineup');
            document.getElementById('lineupMatchSelect').value = matchId;
            loadLineupForMatch();
        };

        function renderSubsList(subs) {
            const container = document.getElementById('subsList');

            if (!subs || subs.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üë•</div><p>No substitute players available</p></div>';
                return;
            }

            container.innerHTML = subs.map(s => `
                <div class="sub-card">
                    <div class="sub-name">${s.name}</div>
                    <div class="sub-info">${s.phone || 'No phone'} ‚Ä¢ ${s.preferred_level || 'Any level'}</div>
                    <button class="sub-btn" onclick="contactSub('${s.id}', '${s.name}', '${s.phone || ''}')">üì± CONTACT</button>
                </div>
            `).join('');
        }

        function populateLineupMatchSelect(schedule) {
            const select = document.getElementById('lineupMatchSelect');
            const upcoming = schedule.filter(m => !m.completed);

            select.innerHTML = '<option value="">-- Select upcoming match --</option>' +
                upcoming.map(m => {
                    const dateStr = m.match_date ? new Date(m.match_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'TBD';
                    return `<option value="${m.id}">Week ${m.week} vs ${m.opponent_name} (${dateStr})</option>`;
                }).join('');
        }

        window.loadLineupForMatch = async function() {
            const matchId = document.getElementById('lineupMatchSelect').value;
            const builder = document.getElementById('lineupBuilder');
            const saveBtn = document.getElementById('saveLineupBtn');

            if (!matchId) {
                builder.style.display = 'none';
                saveBtn.style.display = 'none';
                return;
            }

            // Get match format and current lineup
            const roster = captainTeamData.roster || [];
            const match = captainTeamData.schedule.find(m => m.id === matchId);
            const format = match?.format || captainTeamData.match_format || [];

            let html = '';
            format.forEach((game, i) => {
                const gameNum = i + 1;
                const gameType = game.type === 'doubles' ? 'DOUBLES' : 'SINGLES';
                const gameFormat = game.format?.toUpperCase() || '501';

                html += `<div class="lineup-row">
                    <div class="lineup-game">G${gameNum} - ${gameType}<br><span style="font-size: 12px; color: var(--text-dim);">${gameFormat}</span></div>
                    <select class="lineup-select" id="lineup_g${gameNum}_p1">
                        <option value="">Select Player</option>
                        ${roster.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                    </select>
                    ${game.type === 'doubles' ? `
                    <select class="lineup-select" id="lineup_g${gameNum}_p2">
                        <option value="">Select Partner</option>
                        ${roster.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                    </select>` : ''}
                </div>`;
            });

            builder.innerHTML = html;
            builder.style.display = 'block';
            saveBtn.style.display = 'block';
        };

        window.saveLineup = async function() {
            const matchId = document.getElementById('lineupMatchSelect').value;
            if (!matchId) return;

            const format = captainTeamData.match_format || [];
            const lineup = [];

            format.forEach((game, i) => {
                const gameNum = i + 1;
                const p1 = document.getElementById(`lineup_g${gameNum}_p1`)?.value;
                const p2 = document.getElementById(`lineup_g${gameNum}_p2`)?.value;

                lineup.push({
                    game: gameNum,
                    player1_id: p1 || null,
                    player2_id: game.type === 'doubles' ? (p2 || null) : null
                });
            });

            try {
                const [leagueId, teamId] = document.getElementById('captainTeamSelect').value.split('|');
                const result = await callFunction('setMatchLineup', {
                    league_id: leagueId,
                    match_id: matchId,
                    team_id: teamId,
                    captain_id: currentPlayer.id,
                    lineup: lineup
                });

                if (result.success) {
                    alert('Lineup saved!');
                } else {
                    console.error('Lineup save failed:', result.error);
                    alert('Something went wrong. Please try again.');
                }
            } catch (error) {
                console.error('Error saving lineup:', error);
                alert('Something went wrong. Please try again.');
            }
        };

        window.contactSub = function(subId, subName, phone) {
            if (!phone) {
                alert(`${subName} does not have a phone number on file.`);
                return;
            }
            // Switch to contact tab and pre-fill
            switchCaptainSubtab('contact');
            document.getElementById('contactAllPlayers').checked = false;
            document.getElementById('contactSubs').checked = false;
            document.getElementById('captainMessage').value = `Hi ${subName.split(' ')[0]}, are you available to sub this week?`;
        };

        window.insertCaptainTag = function(tag) {
            const textarea = document.getElementById('captainMessage');
            const start = textarea.selectionStart;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + tag + text.substring(textarea.selectionEnd);
            textarea.focus();
        };

        window.sendTeamMessage = async function() {
            const message = document.getElementById('captainMessage').value.trim();
            if (!message) {
                alert('Please enter a message');
                return;
            }

            const allPlayers = document.getElementById('contactAllPlayers').checked;
            const subsOnly = document.getElementById('contactSubs').checked;
            const alsoSendSMS = document.getElementById('alsoSendSMS').checked;

            if (!allPlayers && !subsOnly) {
                alert('Please select recipients');
                return;
            }

            try {
                const [leagueId, teamId] = document.getElementById('captainTeamSelect').value.split('|');
                const result = await callFunction('sendCaptainMessage', {
                    league_id: leagueId,
                    team_id: teamId,
                    captain_id: currentPlayer.id,
                    message: message,
                    send_sms: alsoSendSMS,
                    recipients: {
                        all_players: allPlayers,
                        subs_only: subsOnly
                    }
                });

                if (result.success) {
                    const smsNote = alsoSendSMS ? ' (SMS also sent)' : '';
                    alert(`Message sent to ${result.sent} player(s)!${smsNote}`);
                    document.getElementById('captainMessage').value = '';
                    document.getElementById('alsoSendSMS').checked = false;
                } else {
                    console.error('Message send failed:', result.error);
                    alert('Something went wrong. Please try again.');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Something went wrong. Please try again.');
            }
        };

        // ============================================================================
        // NEW CAPTAIN ROSTER TAB FUNCTIONS
        // ============================================================================

        // Render team roster list with notification status
        function renderTeamRosterList(roster) {
            const container = document.getElementById('teamRosterList');
            if (!roster || roster.length === 0) {
                container.innerHTML = '<div class="empty-state">No players on roster</div>';
                return;
            }

            const levelLabels = { 1: 'A', 2: 'B', 3: 'C' };
            let pushCount = 0;
            let smsOnlyCount = 0;

            const html = roster.map(p => {
                const level = levelLabels[p.position] || p.level || '?';
                const levelClass = `level-${level.toLowerCase()}`;
                const hasPush = p.has_push_enabled;
                if (hasPush) pushCount++; else smsOnlyCount++;

                const availText = p.unavailable_weeks && p.unavailable_weeks.length > 0
                    ? `üìÖ Out: Week ${p.unavailable_weeks.join(', ')}`
                    : '‚úì Available all season';
                const availClass = p.unavailable_weeks && p.unavailable_weeks.length > 0 ? 'has-gaps' : 'available';

                return `
                    <div class="team-player-row ${levelClass}">
                        <div class="player-level-badge ${levelClass}">${level}</div>
                        <div class="player-info">
                            <div class="player-info-name">
                                ${p.name}
                                ${p.is_captain ? '<span class="captain-star">‚òÖ</span>' : ''}
                            </div>
                            <div class="player-info-stats">${p.x01_three_dart_avg || p.x01_avg || '-'} / ${p.cricket_mpr || p.mpr || '-'}</div>
                        </div>
                        <div class="player-availability ${availClass}">${availText}</div>
                        <button class="roster-text-btn" onclick="textTeamPlayer('${p.id}', '${p.name}', '${p.phone || ''}')" title="Send text">
                            üì±
                        </button>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            document.getElementById('pushEnabledCount').textContent = pushCount;
            document.getElementById('smsOnlyCount').textContent = smsOnlyCount;
        }

        // Render availability grid
        function renderAvailabilityGrid(roster, schedule) {
            const container = document.getElementById('availabilityGrid');
            if (!roster || roster.length === 0) {
                container.innerHTML = '<div class="empty-state">No roster data</div>';
                return;
            }

            const totalWeeks = schedule ? Math.max(...schedule.map(m => m.week || 1), 18) : 18;

            let html = '<div class="availability-grid">';

            // Header row
            html += '<div class="avail-header"></div>';
            for (let w = 1; w <= totalWeeks; w++) {
                html += `<div class="avail-header">W${w}</div>`;
            }

            // Player rows
            roster.forEach(p => {
                const unavailable = p.unavailable_weeks || [];
                html += `<div class="avail-player-name">${p.name.split(' ')[0]}</div>`;
                for (let w = 1; w <= totalWeeks; w++) {
                    const isUnavail = unavailable.includes(w);
                    const status = isUnavail ? 'unavailable' : 'available';
                    const icon = isUnavail ? '‚úó' : '‚úì';
                    html += `<div class="avail-cell ${status}" data-player="${p.id}" data-week="${w}" onclick="togglePlayerAvailability('${p.id}', ${w})">${icon}</div>`;
                }
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Toggle availability editing
        window.toggleAvailabilityEdit = function() {
            alert('Availability is typically set by players in their own dashboard. You can override if needed by clicking a cell.');
        };

        // Toggle player availability for a week
        window.togglePlayerAvailability = async function(playerId, week) {
            const cell = document.querySelector(`.avail-cell[data-player="${playerId}"][data-week="${week}"]`);
            if (!cell) return;

            const isCurrentlyUnavailable = cell.classList.contains('unavailable');
            const newStatus = isCurrentlyUnavailable ? 'available' : 'unavailable';

            // Optimistic UI update
            cell.classList.toggle('unavailable');
            cell.classList.toggle('available');
            cell.textContent = isCurrentlyUnavailable ? '‚úì' : '‚úó';

            try {
                await callFunction('updateSeasonAvailability', {
                    league_id: selectedCaptainLeagueId,
                    team_id: captainTeamData?.team_id || selectedCaptainTeamId,
                    player_id: playerId,
                    week: week,
                    available: isCurrentlyUnavailable,
                    captain_id: currentPlayer.id
                });
            } catch (error) {
                console.error('Error updating availability:', error);
                // Revert on error
                cell.classList.toggle('unavailable');
                cell.classList.toggle('available');
                cell.textContent = isCurrentlyUnavailable ? '‚úó' : '‚úì';
            }
        };

        // Render go-to subs by level
        function renderGotoSubs(gotoSubs) {
            ['A', 'B', 'C'].forEach(level => {
                const container = document.getElementById(`gotoSubs${level}`);
                const subs = gotoSubs[level] || [];

                if (subs.length === 0) {
                    container.innerHTML = `<div class="empty-goto">No go-to subs set. <span onclick="openSubPool('${level}')">Add from pool ‚Üí</span></div>`;
                    return;
                }

                container.innerHTML = subs.map((sub, idx) => `
                    <div class="goto-sub-item" draggable="true" data-level="${level}" data-index="${idx}">
                        <span class="drag-handle">‚ò∞</span>
                        <span class="goto-sub-name">${sub.name}</span>
                        <span class="goto-sub-stats">${sub.x01_avg || '-'} / ${sub.mpr || '-'}</span>
                        <div class="goto-sub-actions">
                            <button class="goto-text-btn" onclick="textSub('${sub.id}', '${sub.name}', '${sub.phone || ''}')">üì± Text</button>
                            <button class="goto-remove-btn" onclick="removeGotoSub('${level}', '${sub.id}')">‚úï</button>
                        </div>
                    </div>
                `).join('');
            });
        }

        // Render sub pool
        function renderSubPool(subs) {
            const container = document.getElementById('subPoolList');
            if (!subs || subs.length === 0) {
                container.innerHTML = '<div class="empty-state">No substitute players available</div>';
                return;
            }

            captainSubPool = subs; // Store for filtering
            renderFilteredSubPool('all');
        }

        let captainSubPool = [];

        window.filterSubPool = function(level) {
            document.querySelectorAll('.sub-pool-filters .filter-pill').forEach(p => p.classList.remove('active'));
            document.querySelector(`.sub-pool-filters .filter-pill[data-level="${level}"]`).classList.add('active');
            renderFilteredSubPool(level);
        };

        function renderFilteredSubPool(level) {
            const container = document.getElementById('subPoolList');
            const filtered = level === 'all' ? captainSubPool : captainSubPool.filter(s => s.level === level || s.preferred_level === level);

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">No subs match this filter</div>';
                return;
            }

            container.innerHTML = filtered.map(sub => `
                <div class="sub-pool-item">
                    <div class="sub-level ${sub.level || sub.preferred_level || 'C'}">${sub.level || sub.preferred_level || '?'}</div>
                    <div class="sub-pool-info">
                        <div class="sub-pool-name">${sub.name}</div>
                        <div class="sub-pool-stats">${sub.x01_avg || '-'} / ${sub.mpr || '-'} ‚Ä¢ ${sub.phone || 'No phone'}</div>
                    </div>
                    <div class="sub-pool-actions">
                        <button class="add-goto-btn" onclick="addToGotoList('${sub.id}', '${sub.level || sub.preferred_level || 'C'}')">‚≠ê Add</button>
                        <button class="text-sub-btn" onclick="textSub('${sub.id}', '${sub.name}', '${sub.phone || ''}')">üì± Text</button>
                    </div>
                </div>
            `).join('');
        }

        window.openSubPool = function(level) {
            filterSubPool(level);
            // Scroll to sub pool section
            document.getElementById('subPoolList').scrollIntoView({ behavior: 'smooth' });
        };

        window.addToGotoList = async function(subId, level) {
            try {
                await callFunction('addGotoSub', {
                    league_id: selectedCaptainLeagueId,
                    team_id: selectedCaptainTeamId,
                    captain_id: currentPlayer.id,
                    sub_id: subId,
                    level: level
                });
                // Reload captain data to refresh go-to lists
                loadCaptainTeam();
            } catch (error) {
                alert('Error adding to go-to list: ' + error.message);
            }
        };

        window.removeGotoSub = async function(level, subId) {
            try {
                await callFunction('removeGotoSub', {
                    league_id: selectedCaptainLeagueId,
                    team_id: selectedCaptainTeamId,
                    captain_id: currentPlayer.id,
                    sub_id: subId,
                    level: level
                });
                loadCaptainTeam();
            } catch (error) {
                alert('Error removing from go-to list: ' + error.message);
            }
        };

        window.textSub = function(subId, subName, phone) {
            if (!phone) {
                alert(`${subName} does not have a phone number on file.`);
                return;
            }
            // Open SMS with pre-filled message
            const message = encodeURIComponent(`Hi ${subName.split(' ')[0]}! This is ${currentPlayer.name} from ${captainTeamData.team_name}. Are you available to sub for us?`);
            window.open(`sms:${phone}?body=${message}`, '_blank');
        };

        // Text a team player (different message than sub request)
        window.textTeamPlayer = function(playerId, playerName, phone) {
            if (!phone) {
                alert(`${playerName} does not have a phone number on file.`);
                return;
            }
            // Open SMS - captain can type their own message
            const message = encodeURIComponent(`Hi ${playerName.split(' ')[0]}! `);
            window.open(`sms:${phone}?body=${message}`, '_blank');
        };

        window.manageSubPlaylists = function() {
            document.getElementById('playlistModal').style.display = 'flex';
            // Load playlists
            renderPlaylistModal();
        };

        window.closePlaylistModal = function() {
            document.getElementById('playlistModal').style.display = 'none';
        };

        function renderPlaylistModal() {
            const container = document.getElementById('playlistList');
            // For now, show default playlists
            container.innerHTML = `
                <div class="playlist-item">
                    <span>Go-to A's</span>
                    <span style="color: var(--text-dim);">Default list</span>
                </div>
                <div class="playlist-item">
                    <span>Go-to B's</span>
                    <span style="color: var(--text-dim);">Default list</span>
                </div>
                <div class="playlist-item">
                    <span>Go-to C's</span>
                    <span style="color: var(--text-dim);">Default list</span>
                </div>
            `;
        }

        window.createNewPlaylist = function() {
            const name = prompt('Enter playlist name:');
            if (name) {
                alert(`Playlist "${name}" created! You can add subs from the sub pool.`);
            }
        };

        // ============================================================================
        // CAPTAIN CONTACT TAB FUNCTIONS
        // ============================================================================

        window.toggleRecipient = function(recipient) {
            const pill = document.querySelector(`.recipient-pill[data-recipient="${recipient}"]`);
            pill.classList.toggle('active');

            // Show/hide individual selector
            const individualSelector = document.getElementById('individualSelector');
            if (recipient === 'individual') {
                individualSelector.style.display = pill.classList.contains('active') ? 'block' : 'none';
                if (pill.classList.contains('active')) {
                    populateIndividualRecipients();
                }
            }
        };

        function populateIndividualRecipients() {
            const select = document.getElementById('individualRecipientSelect');
            const roster = captainTeamData.roster || [];
            const subs = captainTeamData.subs || [];

            let options = '<option value="">Select person...</option>';
            options += '<optgroup label="Team">';
            roster.forEach(p => {
                options += `<option value="player:${p.id}">${p.name}</option>`;
            });
            options += '</optgroup>';
            options += '<optgroup label="Subs">';
            subs.forEach(s => {
                options += `<option value="sub:${s.id}">${s.name}</option>`;
            });
            options += '</optgroup>';

            select.innerHTML = options;
        }

        window.loadMessageTemplate = function() {
            const template = document.getElementById('messageTemplate').value;
            const textarea = document.getElementById('captainMessage');

            const templates = {
                reminder: "Hey [first_name]! Just a reminder we have a match on [match_date] against [opponent] at [venue]. See you there!",
                running_late: "Hey team, I'm running a few minutes late tonight. Start without me if needed!",
                practice: "Practice reminder: We're meeting up this week to throw some darts. Let me know if you can make it!",
                congrats: "Great job tonight everyone! Way to pull together and get the W! üéØ"
            };

            if (templates[template]) {
                textarea.value = templates[template];
            }
        };

        window.insertMergeTag = function(tag) {
            const textarea = document.getElementById('captainMessage');
            const start = textarea.selectionStart;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + tag + text.substring(textarea.selectionEnd);
            textarea.focus();
        };

        window.quickRemindTeam = function() {
            // Select team and set reminder template
            document.querySelectorAll('.recipient-pill').forEach(p => p.classList.remove('active'));
            document.querySelector('.recipient-pill[data-recipient="team"]').classList.add('active');
            document.getElementById('messageTemplate').value = 'reminder';
            loadMessageTemplate();
            document.getElementById('channelDM').checked = true;
            document.getElementById('channelSMS').checked = true;
        };

        // Text players who haven't confirmed for next match
        window.textUnconfirmedPlayers = function() {
            if (!captainTeamData || !captainTeamData.roster) {
                alert('No roster data available');
                return;
            }

            // Find next match
            const upcoming = (captainTeamData.schedule || [])
                .filter(m => !m.completed && m.match_date)
                .sort((a, b) => new Date(a.match_date) - new Date(b.match_date));

            if (upcoming.length === 0) {
                alert('No upcoming matches found');
                return;
            }

            const nextMatch = upcoming[0];
            const matchDate = new Date(nextMatch.match_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            // Find players who haven't confirmed (no 'confirmed' availability status)
            const unconfirmed = captainTeamData.roster.filter(p => {
                return p.availability !== 'confirmed' && p.availability !== 'unavailable';
            });

            if (unconfirmed.length === 0) {
                alert('All players have confirmed their availability!');
                return;
            }

            // Filter to those with phone numbers
            const withPhones = unconfirmed.filter(p => p.phone);

            if (withPhones.length === 0) {
                alert(`${unconfirmed.length} player(s) haven't confirmed, but none have phone numbers on file.`);
                return;
            }

            // Compose bulk SMS (first player as example, user can modify)
            const names = withPhones.map(p => p.name.split(' ')[0]).join(', ');
            const message = encodeURIComponent(`Hey! Quick check - are you available for our match on ${matchDate} vs ${nextMatch.opponent_name}? Reply YES or NO. Thanks!`);

            // On mobile, open first player's SMS
            if (withPhones.length === 1) {
                window.open(`sms:${withPhones[0].phone}?body=${message}`, '_blank');
            } else {
                // Show list and let captain choose
                const phoneList = withPhones.map(p => `${p.name}: ${p.phone}`).join('\n');
                alert(`${withPhones.length} players haven't confirmed:\n\n${phoneList}\n\nOpening SMS for each...`);

                // Open SMS for first player, others shown in list
                window.open(`sms:${withPhones[0].phone}?body=${message}`, '_blank');
            }
        };

        window.contactDirector = function() {
            document.querySelectorAll('.recipient-pill').forEach(p => p.classList.remove('active'));
            document.querySelector('.recipient-pill[data-recipient="director"]').classList.add('active');
            document.getElementById('captainMessage').value = '';
            document.getElementById('captainMessage').placeholder = 'Message to league director...';
        };

        window.sendCaptainComposedMessage = async function() {
            const message = document.getElementById('captainMessage').value.trim();
            if (!message) {
                alert('Please enter a message');
                return;
            }

            // Get selected recipients
            const selectedRecipients = [];
            document.querySelectorAll('.recipient-pill.active').forEach(p => {
                selectedRecipients.push(p.dataset.recipient);
            });

            if (selectedRecipients.length === 0) {
                alert('Please select at least one recipient');
                return;
            }

            // Get selected channels
            const channels = {
                dm: document.getElementById('channelDM').checked,
                sms: document.getElementById('channelSMS').checked,
                email: document.getElementById('channelEmail').checked
            };

            if (!channels.dm && !channels.sms && !channels.email) {
                alert('Please select at least one channel');
                return;
            }

            try {
                const result = await callFunction('sendCaptainMessage', {
                    league_id: selectedCaptainLeagueId,
                    team_id: selectedCaptainTeamId,
                    captain_id: currentPlayer.id,
                    message: message,
                    recipients: selectedRecipients,
                    channels: channels,
                    individual_id: document.getElementById('individualRecipientSelect')?.value || null
                });

                if (result.success) {
                    // Save to local history
                    const recipientNames = selectedRecipients.map(r =>
                        r === 'team' ? 'Team' :
                        r === 'subs' ? 'Subs' :
                        r === 'director' ? 'Director' :
                        r === 'individual' ? 'Individual' : r
                    ).join(', ');
                    saveMessageToHistory(recipientNames, message);

                    alert(`Message sent to ${result.sent} recipient(s)!`);
                    document.getElementById('captainMessage').value = '';
                } else {
                    alert('Error: ' + (result.error || 'Failed to send message'));
                }
            } catch (error) {
                alert('Error sending message: ' + error.message);
            }
        };

        window.toggleMessageHistory = function() {
            const historyList = document.getElementById('captainMessageHistory');
            const toggle = document.querySelector('.history-toggle');
            if (historyList.style.display === 'none') {
                historyList.style.display = 'block';
                toggle.textContent = 'Hide ‚ñ≤';
                loadMessageHistory();
            } else {
                historyList.style.display = 'none';
                toggle.textContent = 'Show ‚ñº';
            }
        };

        async function loadMessageHistory() {
            const container = document.getElementById('captainMessageHistory');
            const history = JSON.parse(localStorage.getItem('brdc_captain_messages') || '[]');

            if (history.length === 0) {
                container.innerHTML = '<div class="empty-state">No messages sent yet this session</div>';
                return;
            }

            // Show most recent first, limit to 10
            const recent = history.slice(-10).reverse();
            container.innerHTML = recent.map(msg => {
                const timeAgo = getTimeAgo(new Date(msg.timestamp));
                return `
                    <div class="message-history-item">
                        <div class="history-item-header">
                            <span class="history-recipients">${msg.recipients}</span>
                            <span class="history-time">${timeAgo}</span>
                        </div>
                        <div class="history-message">${msg.message.substring(0, 100)}${msg.message.length > 100 ? '...' : ''}</div>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return date.toLocaleDateString();
        }

        function saveMessageToHistory(recipients, message) {
            const history = JSON.parse(localStorage.getItem('brdc_captain_messages') || '[]');
            history.push({
                timestamp: new Date().toISOString(),
                recipients: recipients,
                message: message
            });
            // Keep only last 50 messages
            if (history.length > 50) history.shift();
            localStorage.setItem('brdc_captain_messages', JSON.stringify(history));
        }

        // ============================================================================
        // CAPTAIN SETTINGS TAB FUNCTIONS
        // ============================================================================

        function loadCaptainSettings(data) {
            document.getElementById('settingsTeamName').value = data.team_name || '';
            document.getElementById('settingsTeamMotto').value = data.team_motto || '';

            // Load team photo if exists
            if (data.team_photo) {
                const preview = document.getElementById('teamPhotoPreview');
                preview.innerHTML = `<img src="${data.team_photo}" alt="Team photo">`;
            }
        }

        window.handleTeamPhotoSelect = async function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('teamPhotoPreview');
                preview.innerHTML = `<img src="${e.target.result}" alt="Team photo">`;
            };
            reader.readAsDataURL(file);

            // TODO: Upload to storage and save URL
            alert('Team photo upload will be saved when you click Save');
        };

        window.saveTeamNameFromSettings = async function() {
            const newName = document.getElementById('settingsTeamName').value.trim();
            if (!newName) {
                alert('Please enter a team name');
                return;
            }

            try {
                const result = await callFunction('updateTeamName', {
                    league_id: selectedCaptainLeagueId,
                    team_id: selectedCaptainTeamId,
                    captain_id: currentPlayer.id,
                    team_name: newName
                });

                if (result.success) {
                    alert('Team name saved!');
                    captainTeamData.team_name = newName;
                } else {
                    alert('Error: ' + (result.error || 'Failed to save'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        window.openRosterEditor = function() {
            alert('Roster position editor coming soon. Contact the league director for roster changes.');
        };

        window.openPermanentReplacement = function() {
            alert('Permanent replacement flow coming soon. Contact the league director for mid-season roster changes.');
        };

        window.markPlayerInactive = function() {
            alert('Mark inactive feature coming soon. Contact the league director to mark a player inactive.');
        };

        window.requestCaptainTransfer = function() {
            const confirm = window.confirm('Are you sure you want to transfer captain duties to another player? This cannot be undone.');
            if (confirm) {
                alert('Captain transfer request submitted. The league director will be notified.');
            }
        };

        // ============================================================================
        // FILL-IN REQUEST MODAL FUNCTIONS
        // ============================================================================

        let fillinRequestData = {
            matchId: null,
            playerId: null,
            selectedSubs: [],
            deadline: null,
            fallbackList: 'none'
        };

        window.openFillinRequest = function() {
            document.getElementById('fillinModal').style.display = 'flex';
            goToFillinStep(1);

            // Pre-select the urgent match if available, otherwise first upcoming match
            const select = document.getElementById('fillinMatchSelect');
            if (window.urgentMatchId && select) {
                select.value = window.urgentMatchId;
                loadFillinMatchDetails();
            } else if (select && select.options.length > 1) {
                // Select the first upcoming match
                select.selectedIndex = 1;
                loadFillinMatchDetails();
            }
        };

        window.closeFillinModal = function() {
            document.getElementById('fillinModal').style.display = 'none';
            fillinRequestData = { matchId: null, playerId: null, selectedSubs: [], deadline: null, fallbackList: 'none' };
        };

        function populateFillinMatchSelect(schedule) {
            const select = document.getElementById('fillinMatchSelect');
            const upcoming = (schedule || []).filter(m => !m.completed);

            select.innerHTML = '<option value="">Select match...</option>' +
                upcoming.map(m => {
                    const dateStr = m.match_date ? new Date(m.match_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'TBD';
                    return `<option value="${m.id}">Week ${m.week} vs ${m.opponent_name} (${dateStr})</option>`;
                }).join('');
        }

        window.loadFillinMatchDetails = function() {
            const matchId = document.getElementById('fillinMatchSelect').value;
            if (!matchId) return;

            fillinRequestData.matchId = matchId;
            const match = captainTeamData.schedule.find(m => m.id === matchId);
            const lineup = match.is_home ? match.home_lineup : match.away_lineup;

            const playerSelect = document.getElementById('fillinPlayerSelect');
            playerSelect.innerHTML = '<option value="">Select player...</option>' +
                (lineup || []).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        };

        window.goToFillinStep = function(step) {
            document.querySelectorAll('.fillin-step').forEach(s => s.style.display = 'none');
            document.getElementById(`fillinStep${step}`).style.display = 'block';

            if (step === 2) {
                fillinRequestData.playerId = document.getElementById('fillinPlayerSelect').value;
                populateFillinSubList();

                // Set default deadline
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('fillinDeadlineDate').value = tomorrow.toISOString().split('T')[0];
            }

            if (step === 3) {
                renderFillinPreview();
            }
        };

        function populateFillinSubList() {
            const container = document.getElementById('fillinSubList');
            const match = captainTeamData.schedule.find(m => m.id === fillinRequestData.matchId);
            const player = (match.is_home ? match.home_lineup : match.away_lineup).find(p => p.id === fillinRequestData.playerId);
            const level = player?.level || player?.position || 'C';

            // Filter subs by level
            const levelSubs = captainSubPool.filter(s => s.level === level || s.preferred_level === level);
            const gotoSubs = captainTeamData.goto_subs?.[level] || [];

            let html = '';

            // Go-to subs first
            if (gotoSubs.length > 0) {
                html += '<div style="font-size: 11px; color: var(--teal); margin-bottom: 6px;">‚≠ê YOUR GO-TOS:</div>';
                gotoSubs.forEach(sub => {
                    html += `
                        <div class="fillin-sub-item">
                            <input type="checkbox" id="fillinSub_${sub.id}" value="${sub.id}" data-name="${sub.name}" data-phone="${sub.phone || ''}" checked>
                            <label for="fillinSub_${sub.id}">${sub.name} <span style="color: var(--text-dim);">${sub.phone || 'No phone'}</span></label>
                        </div>
                    `;
                });
            }

            // Other subs
            const otherSubs = levelSubs.filter(s => !gotoSubs.find(g => g.id === s.id));
            if (otherSubs.length > 0) {
                html += '<div style="font-size: 11px; color: var(--text-dim); margin: 10px 0 6px;">OTHER AVAILABLE:</div>';
                otherSubs.forEach(sub => {
                    html += `
                        <div class="fillin-sub-item">
                            <input type="checkbox" id="fillinSub_${sub.id}" value="${sub.id}" data-name="${sub.name}" data-phone="${sub.phone || ''}">
                            <label for="fillinSub_${sub.id}">${sub.name} <span style="color: var(--text-dim);">${sub.phone || 'No phone'}</span></label>
                        </div>
                    `;
                });
            }

            container.innerHTML = html || '<div class="empty-state">No subs available for this level</div>';
        }

        window.selectAllGotoSubs = function() {
            document.querySelectorAll('#fillinSubList input[type="checkbox"]').forEach(cb => {
                if (cb.closest('.fillin-sub-item').previousElementSibling?.textContent?.includes('GO-TOS')) {
                    cb.checked = true;
                }
            });
        };

        function renderFillinPreview() {
            // Collect selected subs
            fillinRequestData.selectedSubs = [];
            document.querySelectorAll('#fillinSubList input[type="checkbox"]:checked').forEach(cb => {
                fillinRequestData.selectedSubs.push({
                    id: cb.value,
                    name: cb.dataset.name,
                    phone: cb.dataset.phone
                });
            });

            fillinRequestData.deadline = {
                date: document.getElementById('fillinDeadlineDate').value,
                time: document.getElementById('fillinDeadlineTime').value
            };
            fillinRequestData.fallbackList = document.getElementById('fillinFallbackList').value;

            const match = captainTeamData.schedule.find(m => m.id === fillinRequestData.matchId);
            const player = (match.is_home ? match.home_lineup : match.away_lineup).find(p => p.id === fillinRequestData.playerId);
            const dateStr = match.match_date ? new Date(match.match_date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) : 'TBD';
            const deadlineStr = `${fillinRequestData.deadline.date} at ${fillinRequestData.deadline.time}`;

            const previewMessage = `Hey! ${currentPlayer.name} from ${captainTeamData.team_name} here.

We need a sub for ${player?.level || '?'}-level on ${dateStr} vs ${match.opponent_name}.

Let us know by ${deadlineStr} if you're interested. We'll confirm by then.

Reply YES if you can make it!`;

            document.getElementById('fillinPreviewMessage').textContent = previewMessage;
            document.getElementById('fillinRecipientCount').textContent = fillinRequestData.selectedSubs.length;
        }

        window.sendFillinRequests = async function() {
            if (fillinRequestData.selectedSubs.length === 0) {
                alert('No subs selected');
                return;
            }

            try {
                const result = await callFunction('sendFillinRequests', {
                    league_id: selectedCaptainLeagueId,
                    team_id: selectedCaptainTeamId,
                    captain_id: currentPlayer.id,
                    match_id: fillinRequestData.matchId,
                    player_id: fillinRequestData.playerId,
                    subs: fillinRequestData.selectedSubs,
                    deadline: fillinRequestData.deadline,
                    fallback_list: fillinRequestData.fallbackList,
                    message: document.getElementById('fillinPreviewMessage').textContent
                });

                if (result.success) {
                    goToFillinStep(4);
                    document.getElementById('responseDeadline').textContent = `${fillinRequestData.deadline.date} ${fillinRequestData.deadline.time}`;
                    // Start polling for responses
                    pollFillinResponses(result.request_id);
                } else {
                    alert('Error: ' + (result.error || 'Failed to send requests'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        let fillinPollInterval = null;

        function pollFillinResponses(requestId) {
            // Poll every 10 seconds for responses
            fillinPollInterval = setInterval(async () => {
                try {
                    const result = await callFunction('getFillinResponses', { request_id: requestId });
                    if (result.responses && result.responses.length > 0) {
                        renderFillinResponses(result.responses);
                    }
                } catch (error) {
                    console.error('Error polling responses:', error);
                }
            }, 10000);
        }

        function renderFillinResponses(responses) {
            const interested = responses.filter(r => r.interested);
            if (interested.length > 0) {
                document.querySelector('.response-waiting').style.display = 'none';
                document.getElementById('interestedList').style.display = 'block';
                document.getElementById('fillinFinalActions').style.display = 'block';

                document.getElementById('interestedSubs').innerHTML = interested.map(r => `
                    <div class="interested-sub-item">
                        <input type="radio" name="selectedFillin" value="${r.sub_id}">
                        <span>${r.sub_name}</span>
                        <span style="color: var(--text-dim); font-size: 12px;">Responded ${new Date(r.responded_at).toLocaleTimeString()}</span>
                    </div>
                `).join('');
            }
        }

        window.shareInterestedWithTeam = async function() {
            // Auto-send to team chat + text
            try {
                await callFunction('shareFillinInterestWithTeam', {
                    league_id: selectedCaptainLeagueId,
                    team_id: selectedCaptainTeamId,
                    captain_id: currentPlayer.id,
                    interested_subs: fillinRequestData.selectedSubs.filter(s =>
                        document.querySelector(`#interestedSubs input[value="${s.id}"]`)
                    )
                });
                alert('Shared with team! Check your team chat to discuss.');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        window.confirmSelectedFillin = async function() {
            const selected = document.querySelector('#interestedSubs input[name="selectedFillin"]:checked');
            if (!selected) {
                alert('Please select a sub to confirm');
                return;
            }

            try {
                const result = await callFunction('confirmFillin', {
                    league_id: selectedCaptainLeagueId,
                    team_id: selectedCaptainTeamId,
                    match_id: fillinRequestData.matchId,
                    player_id: fillinRequestData.playerId,
                    sub_id: selected.value,
                    captain_id: currentPlayer.id
                });

                if (result.success) {
                    clearInterval(fillinPollInterval);
                    alert('Fill-in confirmed! They have been notified and added to the lineup.');
                    closeFillinModal();
                    loadCaptainTeam(); // Refresh data
                } else {
                    alert('Error: ' + (result.error || 'Failed to confirm'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        };

        // ============================================================================
        // DIRECTOR FUNCTIONS
        // ============================================================================

        window.openDirectorDashboard = function() {
            const leagues = dashboardData.roles.directing || [];

            if (leagues.length === 1) {
                // Go directly to that league
                const league = leagues[0];
                const url = league.type === 'tournament'
                    ? `/pages/director-dashboard.html?tournament=${league.id}`
                    : `/pages/league-director.html?league_id=${league.id}`;
                window.location.href = url;
            } else {
                // Show selector modal
                const select = document.getElementById('directorLeagueSelect');
                select.innerHTML = leagues.map(l =>
                    `<option value="${l.type}|${l.id}">${l.name} (${l.type})</option>`
                ).join('');
                document.getElementById('directorModal').style.display = 'flex';
            }
        };

        window.closeDirectorModal = function() {
            document.getElementById('directorModal').style.display = 'none';
        };

        window.goToDirectorDashboard = function() {
            const [type, id] = document.getElementById('directorLeagueSelect').value.split('|');
            const url = type === 'tournament'
                ? `/pages/director-dashboard.html?tournament=${id}`
                : `/pages/league-director.html?league_id=${id}`;
            window.location.href = url;
        };

        function populateDirectorTab(directing) {
            const leagues = directing.filter(d => d.type === 'league');
            const tournaments = directing.filter(d => d.type === 'tournament');

            // Populate leagues list
            const leaguesList = document.getElementById('directorLeaguesList');
            if (leagues.length === 0) {
                leaguesList.innerHTML = '<div class="empty-state">No leagues</div>';
            } else {
                leaguesList.innerHTML = leagues.map(l => {
                    const statusClass = l.status === 'active' ? 'active' :
                                       l.status === 'registration' ? 'registration' :
                                       l.status === 'draft' ? 'draft' : 'completed';
                    const statusText = (l.status || 'registration').toUpperCase();
                    return `
                        <a href="/pages/league-director.html?league_id=${l.id}" class="director-item" style="text-decoration: none; color: inherit;">
                            <div class="director-item-info">
                                <h4>${l.name}</h4>
                                <p>${l.player_count || 0} players ‚Ä¢ ${l.team_count || 0} teams</p>
                            </div>
                            <span class="director-item-status ${statusClass}">${statusText}</span>
                        </a>
                    `;
                }).join('');
            }

            // Populate tournaments list
            const tournamentsList = document.getElementById('directorTournamentsList');
            if (tournaments.length === 0) {
                tournamentsList.innerHTML = '<div class="empty-state">No tournaments</div>';
            } else {
                tournamentsList.innerHTML = tournaments.map(t => {
                    const statusClass = t.status === 'active' ? 'active' :
                                       t.status === 'registration' ? 'registration' : 'completed';
                    const statusText = (t.status || 'registration').toUpperCase();
                    return `
                        <a href="/pages/director-dashboard.html?tournament=${t.id}" class="director-item" style="text-decoration: none; color: inherit;">
                            <div class="director-item-info">
                                <h4>${t.name}</h4>
                                <p>${t.participant_count || 0} participants</p>
                            </div>
                            <span class="director-item-status ${statusClass}">${statusText}</span>
                        </a>
                    `;
                }).join('');
            }

            // Populate game day league selector
            populateGamedayLeagueSelector(leagues);
        }

        // ============================================================================
        // GAME DAY CONTROL FUNCTIONS
        // ============================================================================

        let gamedayLeagueData = null;
        let gamedayMatchesData = [];
        let gamedayPlayersData = [];
        let gamedayTeamsData = [];
        let currentMessageTarget = null;

        function populateGamedayLeagueSelector(leagues) {
            const select = document.getElementById('gamedayLeagueSelect');
            if (!select) return;

            // Only show active leagues
            const activeLeagues = leagues.filter(l => l.status === 'active');

            if (activeLeagues.length === 0) {
                select.innerHTML = '<option value="">No active leagues</option>';
                return;
            }

            select.innerHTML = '<option value="">Select a league...</option>' +
                activeLeagues.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
        }

        window.loadGamedayData = async function() {
            const leagueId = document.getElementById('gamedayLeagueSelect').value;
            const content = document.getElementById('gamedayContent');

            if (!leagueId) {
                content.style.display = 'none';
                return;
            }

            content.style.display = 'block';
            document.getElementById('gamedayMatchCards').innerHTML = '<div class="empty-state">Loading matches...</div>';

            try {
                // Load league data
                const leagueDoc = await db.collection('leagues').doc(leagueId).get();
                if (!leagueDoc.exists) {
                    throw new Error('League not found');
                }
                gamedayLeagueData = { id: leagueDoc.id, ...leagueDoc.data() };

                // Determine current week (today or next match day)
                const today = new Date();
                const dayOfWeek = today.toLocaleDateString('en-US', { weekday: 'long' });
                const leagueNight = gamedayLeagueData.league_night || '';

                // Load matches to find current/next week
                const matchesRef = db.collection('leagues').doc(leagueId).collection('matches');
                const matchesOrderedSnap = await matchesRef.orderBy('week', 'asc').get();

                let currentWeek = 1;
                let foundMatch = false;

                matchesOrderedSnap.forEach(doc => {
                    const match = doc.data();
                    const matchDate = match.match_date ? new Date(match.match_date) : null;

                    // Find matches for today or the closest upcoming match
                    if (matchDate) {
                        const matchDateStr = matchDate.toDateString();
                        const todayStr = today.toDateString();

                        if (matchDateStr === todayStr) {
                            currentWeek = match.week;
                            foundMatch = true;
                        } else if (!foundMatch && matchDate > today && match.status !== 'completed') {
                            currentWeek = match.week;
                        }
                    }
                });

                document.getElementById('gamedayWeekBadge').textContent = `Week ${currentWeek}`;

                // Load matches for current week
                const matchesSnap = await matchesRef.where('week', '==', currentWeek).get();
                gamedayMatchesData = [];
                matchesSnap.forEach(doc => {
                    gamedayMatchesData.push({ id: doc.id, ...doc.data() });
                });

                // Load teams
                const teamsSnap = await db.collection('leagues').doc(leagueId).collection('teams').get();
                gamedayTeamsData = [];
                teamsSnap.forEach(doc => {
                    gamedayTeamsData.push({ id: doc.id, ...doc.data() });
                });

                // Load players
                const playersSnap = await db.collection('leagues').doc(leagueId).collection('players').get();
                gamedayPlayersData = [];
                playersSnap.forEach(doc => {
                    gamedayPlayersData.push({ id: doc.id, ...doc.data() });
                });

                renderGamedayMatches();

            } catch (error) {
                console.error('Error loading game day data:', error);
                document.getElementById('gamedayMatchCards').innerHTML =
                    '<div class="empty-state">Error loading data. Try again.</div>';
            }
        };

        function renderGamedayMatches() {
            const container = document.getElementById('gamedayMatchCards');

            if (gamedayMatchesData.length === 0) {
                container.innerHTML = '<div class="empty-state">No matches scheduled for this week</div>';
                return;
            }

            // Build team name map
            const teamNames = {};
            gamedayTeamsData.forEach(t => {
                teamNames[t.id] = t.name || t.team_name || 'Team';
            });

            container.innerHTML = gamedayMatchesData.map(match => {
                const homeTeam = teamNames[match.home_team_id] || match.home_team_name || 'Home';
                const awayTeam = teamNames[match.away_team_id] || match.away_team_name || 'Away';

                // Check for bye
                if (match.is_bye || match.bye) {
                    return `
                        <div class="gameday-match-card completed">
                            <div class="match-card-teams">
                                <div class="match-card-team">${homeTeam}</div>
                                <div class="match-card-team" style="color: var(--text-dim);">BYE</div>
                            </div>
                            <span class="match-card-status scheduled">BYE WEEK</span>
                        </div>
                    `;
                }

                const homeScore = match.home_score || match.home_points || 0;
                const awayScore = match.away_score || match.away_points || 0;
                const status = match.status || 'scheduled';

                const statusClass = status === 'in_progress' || status === 'active' ? 'in-progress' :
                                   status === 'completed' || status === 'final' ? 'completed' : '';

                const homeWinner = status === 'completed' && homeScore > awayScore;
                const awayWinner = status === 'completed' && awayScore > homeScore;

                return `
                    <div class="gameday-match-card ${statusClass}">
                        <div class="match-card-teams">
                            <div class="match-card-team ${homeWinner ? 'winner' : ''}">${homeTeam}</div>
                            <div class="match-card-team ${awayWinner ? 'winner' : ''}">${awayTeam}</div>
                        </div>
                        <div class="match-card-score">${homeScore}-${awayScore}</div>
                        <span class="match-card-status ${statusClass.replace('-', '')}">${status.replace('_', ' ').toUpperCase()}</span>
                    </div>
                `;
            }).join('');
        }

        // Substitution Modal Functions
        window.openSubstitutionModal = function() {
            const modal = document.getElementById('substitutionModal');
            if (!modal) return;

            modal.style.display = 'flex';

            // Populate match select
            const matchSelect = document.getElementById('subMatchSelect');
            const teamNames = {};
            gamedayTeamsData.forEach(t => {
                teamNames[t.id] = t.name || t.team_name || 'Team';
            });

            matchSelect.innerHTML = '<option value="">Select a match...</option>' +
                gamedayMatchesData.filter(m => !m.is_bye && !m.bye).map(m => {
                    const home = teamNames[m.home_team_id] || 'Home';
                    const away = teamNames[m.away_team_id] || 'Away';
                    return `<option value="${m.id}">${home} vs ${away}</option>`;
                }).join('');

            // Clear other selects
            document.getElementById('subPlayerOut').innerHTML = '<option value="">Select player...</option>';
            document.getElementById('subPlayerIn').innerHTML = '<option value="">Select substitute...</option>';
            document.getElementById('subReason').value = '';
        };

        window.closeSubstitutionModal = function() {
            document.getElementById('substitutionModal').style.display = 'none';
        };

        window.loadMatchPlayers = function() {
            const matchId = document.getElementById('subMatchSelect').value;
            if (!matchId) return;

            const match = gamedayMatchesData.find(m => m.id === matchId);
            if (!match) return;

            // Get players from both teams
            const homeTeam = gamedayTeamsData.find(t => t.id === match.home_team_id);
            const awayTeam = gamedayTeamsData.find(t => t.id === match.away_team_id);

            // Collect player IDs from rosters
            const rosterPlayerIds = [];
            if (homeTeam?.roster) rosterPlayerIds.push(...homeTeam.roster);
            if (awayTeam?.roster) rosterPlayerIds.push(...awayTeam.roster);

            // Filter players on roster for "out" select
            const rosterPlayers = gamedayPlayersData.filter(p =>
                rosterPlayerIds.includes(p.id) || rosterPlayerIds.includes(p.player_id)
            );

            // Available subs (not on either team roster)
            const availableSubs = gamedayPlayersData.filter(p =>
                (p.is_sub || p.is_substitute || p.is_fillin) &&
                !rosterPlayerIds.includes(p.id) && !rosterPlayerIds.includes(p.player_id)
            );

            // Populate player out select
            const outSelect = document.getElementById('subPlayerOut');
            outSelect.innerHTML = '<option value="">Select player...</option>' +
                rosterPlayers.map(p => `<option value="${p.id}">${p.name || p.player_name}</option>`).join('');

            // Populate substitute select
            const inSelect = document.getElementById('subPlayerIn');
            inSelect.innerHTML = '<option value="">Select substitute...</option>' +
                availableSubs.map(p => {
                    const level = p.level ? ` (${p.level})` : '';
                    return `<option value="${p.id}">${p.name || p.player_name}${level}</option>`;
                }).join('');

            // Also add regular players as potential subs
            const otherPlayers = gamedayPlayersData.filter(p =>
                !rosterPlayerIds.includes(p.id) && !rosterPlayerIds.includes(p.player_id) &&
                !p.is_sub && !p.is_substitute && !p.is_fillin
            );
            otherPlayers.forEach(p => {
                const level = p.level ? ` (${p.level})` : '';
                inSelect.innerHTML += `<option value="${p.id}">${p.name || p.player_name}${level}</option>`;
            });
        };

        window.confirmSubstitution = async function() {
            const matchId = document.getElementById('subMatchSelect').value;
            const playerOutId = document.getElementById('subPlayerOut').value;
            const playerInId = document.getElementById('subPlayerIn').value;
            const reason = document.getElementById('subReason').value;

            if (!matchId || !playerOutId || !playerInId) {
                alert('Please select a match, player to replace, and substitute.');
                return;
            }

            try {
                const result = await callFunction('quickSubstitute', {
                    league_id: gamedayLeagueData.id,
                    match_id: matchId,
                    player_out_id: playerOutId,
                    player_in_id: playerInId,
                    reason: reason,
                    director_id: currentPlayer.id
                });

                if (result.success) {
                    alert('Substitution recorded successfully!');
                    closeSubstitutionModal();
                    loadGamedayData(); // Refresh
                } else {
                    alert('Error: ' + (result.error || 'Failed to record substitution'));
                }
            } catch (error) {
                console.error('Substitution error:', error);
                alert('Error recording substitution: ' + error.message);
            }
        };

        // Message Modal Functions
        window.openMessageModal = function(target, level = null) {
            const modal = document.getElementById('messageModal');
            if (!modal) return;

            currentMessageTarget = { type: target, level: level };

            // Set title based on target
            let title = 'Send Message';
            let recipients = [];

            switch(target) {
                case 'all':
                    title = 'Message All Players';
                    recipients = gamedayPlayersData.filter(p => p.phone || p.email);
                    break;
                case 'captains':
                    title = 'Message Captains';
                    const captainIds = gamedayTeamsData.map(t => t.captain_id).filter(Boolean);
                    recipients = gamedayPlayersData.filter(p =>
                        captainIds.includes(p.id) || captainIds.includes(p.player_id)
                    );
                    break;
                case 'alternates':
                    title = 'Message Alternates/Fill-ins';
                    recipients = gamedayPlayersData.filter(p =>
                        p.is_sub || p.is_substitute || p.is_fillin || p.is_alternate
                    );
                    break;
                case 'level':
                    title = `Message Level ${level} Players`;
                    recipients = gamedayPlayersData.filter(p =>
                        p.level === level || p.player_level === level
                    );
                    break;
            }

            document.getElementById('messageModalTitle').textContent = title;

            // Show recipients
            const recipientsList = document.getElementById('messageRecipientsList');
            if (recipients.length === 0) {
                recipientsList.innerHTML = '<span class="recipient-chip">No recipients found</span>';
            } else {
                recipientsList.innerHTML = recipients.slice(0, 20).map(p =>
                    `<span class="recipient-chip">${p.name || p.player_name || 'Player'}</span>`
                ).join('');
                if (recipients.length > 20) {
                    recipientsList.innerHTML += `<span class="recipient-chip">+${recipients.length - 20} more</span>`;
                }
            }

            document.getElementById('messageRecipientCount').textContent = `${recipients.length} recipient${recipients.length !== 1 ? 's' : ''}`;
            document.getElementById('messageText').value = '';

            modal.style.display = 'flex';
        };

        window.closeMessageModal = function() {
            document.getElementById('messageModal').style.display = 'none';
            currentMessageTarget = null;
        };

        window.insertTemplate = function(template) {
            const textarea = document.getElementById('messageText');
            const leagueName = gamedayLeagueData?.league_name || gamedayLeagueData?.name || 'league';

            const templates = {
                'running_late': `Hey! Just a heads up - running a few minutes late tonight. Be there soon!`,
                'need_sub': `We need a substitute for tonight's ${leagueName} match. Can anyone fill in? Reply ASAP if available!`,
                'match_starting': `Matches are starting! Please head to your assigned board. Good luck tonight!`,
                'reminder': `Reminder: ${leagueName} is tonight! See you at the venue. Let your captain know if you can't make it.`
            };

            textarea.value = templates[template] || '';
            textarea.focus();
        };

        window.sendDirectorMessage = async function() {
            const message = document.getElementById('messageText').value.trim();

            if (!message) {
                alert('Please enter a message.');
                return;
            }

            if (!currentMessageTarget || !gamedayLeagueData) {
                alert('Error: Missing data. Please try again.');
                return;
            }

            try {
                // Get recipient IDs based on target
                let recipientIds = [];
                switch(currentMessageTarget.type) {
                    case 'all':
                        recipientIds = gamedayPlayersData.map(p => p.id || p.player_id);
                        break;
                    case 'captains':
                        recipientIds = gamedayTeamsData.map(t => t.captain_id).filter(Boolean);
                        break;
                    case 'alternates':
                        recipientIds = gamedayPlayersData
                            .filter(p => p.is_sub || p.is_substitute || p.is_fillin || p.is_alternate)
                            .map(p => p.id || p.player_id);
                        break;
                    case 'level':
                        recipientIds = gamedayPlayersData
                            .filter(p => p.level === currentMessageTarget.level || p.player_level === currentMessageTarget.level)
                            .map(p => p.id || p.player_id);
                        break;
                }

                if (recipientIds.length === 0) {
                    alert('No recipients found.');
                    return;
                }

                // Call backend function to send messages
                const result = await callFunction('sendDirectorMessage', {
                    league_id: gamedayLeagueData.id,
                    director_id: currentPlayer.id,
                    recipient_ids: recipientIds,
                    message: message,
                    target_type: currentMessageTarget.type,
                    target_level: currentMessageTarget.level
                });

                if (result.success) {
                    alert(`Message sent to ${result.sent_count || recipientIds.length} recipient(s)!`);
                    closeMessageModal();
                } else {
                    alert('Error: ' + (result.error || 'Failed to send message'));
                }
            } catch (error) {
                console.error('Send message error:', error);
                alert('Error sending message: ' + error.message);
            }
        };

        // ============================================================================
        // TAB SWITCHING
        // ============================================================================

        window.switchTab = function(tabName, clickEvent) {
            document.querySelectorAll('.tab-container > .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.dashboard-content > .container > .tab-content').forEach(c => c.classList.remove('active'));

            // Use passed event or find tab by name
            if (clickEvent && clickEvent.target) {
                clickEvent.target.classList.add('active');
            } else {
                const tab = document.querySelector(`.tab[onclick*="switchTab('${tabName}'"]`);
                if (tab) tab.classList.add('active');
            }
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Load data for specific tabs
            if (tabName === 'schedule' && !scheduleLoaded) {
                loadCalendar();
            }
            if (tabName === 'activity') {
                // Load leagues data if not loaded (default sub-tab)
                if (!leaguesLoaded) {
                    loadLeaguesTab();
                }
            }
        };

        // Open settings (via gear icon)
        window.openSettings = function() {
            // Remove active state from all tabs
            document.querySelectorAll('.tab-container > .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.dashboard-content > .container > .tab-content').forEach(c => c.classList.remove('active'));

            // Show settings tab
            document.getElementById('settingsTab').classList.add('active');
            populateSettingsForm();
        };

        // ============================================================================
        // PLAYER AVAILABILITY MODAL
        // ============================================================================

        window.openAvailabilityModal = function() {
            const modal = document.getElementById('availabilityModal');
            if (modal) {
                modal.style.display = 'flex';
                loadPlayerAvailability();
            } else {
                alert('Availability modal not found. Please refresh the page.');
            }
        };

        window.closeAvailabilityModal = function() {
            document.getElementById('availabilityModal').style.display = 'none';
        };

        async function loadPlayerAvailability() {
            const container = document.getElementById('availabilityMatchList');
            if (!container) return;

            container.innerHTML = '<div class="empty-state">Loading your matches...</div>';

            try {
                // Get player's upcoming matches from their leagues
                const result = await callFunction('getPlayerUpcomingMatches', {
                    player_id: currentPlayer.id
                });

                if (result.success && result.matches && result.matches.length > 0) {
                    container.innerHTML = result.matches.map(match => {
                        const dateStr = match.match_date ?
                            new Date(match.match_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) : 'TBD';
                        const statusClass = match.availability === 'confirmed' ? 'confirmed' :
                                           match.availability === 'unavailable' ? 'unavailable' : 'pending';
                        const statusIcon = match.availability === 'confirmed' ? '‚úì' :
                                          match.availability === 'unavailable' ? '‚úó' : '?';

                        return `
                            <div class="avail-match-item ${statusClass}">
                                <div class="avail-match-info">
                                    <div class="avail-match-title">Week ${match.week} vs ${match.opponent_name}</div>
                                    <div class="avail-match-date">${dateStr} ‚Ä¢ ${match.league_name}</div>
                                </div>
                                <div class="avail-match-actions">
                                    <button class="avail-btn confirm ${match.availability === 'confirmed' ? 'active' : ''}"
                                            onclick="setAvailability('${match.league_id}', '${match.match_id}', '${match.team_id}', 'confirmed')">
                                        ‚úì IN
                                    </button>
                                    <button class="avail-btn cancel ${match.availability === 'unavailable' ? 'active' : ''}"
                                            onclick="setAvailability('${match.league_id}', '${match.match_id}', '${match.team_id}', 'unavailable')">
                                        ‚úó OUT
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="empty-state">No upcoming matches found</div>';
                }
            } catch (error) {
                console.error('Error loading availability:', error);
                container.innerHTML = '<div class="empty-state">Error loading matches. Try again later.</div>';
            }
        }

        window.setAvailability = async function(leagueId, matchId, teamId, status) {
            try {
                const result = await callFunction('setPlayerAvailability', {
                    player_id: currentPlayer.id,
                    league_id: leagueId,
                    match_id: matchId,
                    team_id: teamId,
                    availability: status,
                    notify_captain: true  // Alert captain when player marks unavailable
                });

                if (result.success) {
                    // Refresh the list
                    loadPlayerAvailability();

                    // Show confirmation
                    const statusText = status === 'confirmed' ? 'confirmed' : 'marked unavailable';
                    if (status === 'unavailable' && result.captain_notified) {
                        alert(`You're ${statusText}. Your captain has been notified.`);
                    }
                } else {
                    alert('Error: ' + (result.error || 'Failed to update availability'));
                }
            } catch (error) {
                alert('Error updating availability: ' + error.message);
            }
        };

        // Request push notifications
        window.requestPushNotifications = async function() {
            if (!('Notification' in window)) {
                alert('Push notifications are not supported in this browser.');
                return;
            }

            if (Notification.permission === 'granted') {
                alert('Notifications are already enabled!');
                updateNotificationButton(true);
                return;
            }

            if (Notification.permission === 'denied') {
                alert('Notifications are blocked. Please enable them in your browser settings.');
                return;
            }

            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    updateNotificationButton(true);
                    // Register for push notifications
                    if ('serviceWorker' in navigator) {
                        // TODO: Register push subscription with backend
                        alert('Notifications enabled! You\'ll be notified about matches and messages.');
                    }
                }
            } catch (error) {
                console.error('Error requesting notifications:', error);
            }
        };

        function updateNotificationButton(enabled) {
            const icon = document.getElementById('notifIcon');
            const label = document.getElementById('notifLabel');
            const btn = icon?.closest('.player-quick-btn');

            if (enabled) {
                if (icon) icon.textContent = 'üîî';
                if (label) label.textContent = 'Enabled';
                if (btn) btn.classList.add('active');
            } else {
                if (icon) icon.textContent = 'üîï';
                if (label) label.textContent = 'Notifications';
                if (btn) btn.classList.remove('active');
            }
        }

        // Check notification status on load
        function checkNotificationStatus() {
            if ('Notification' in window && Notification.permission === 'granted') {
                updateNotificationButton(true);
            }
        }

        // Sub-tab switching for ACTIVITY tab (leagues, tournaments, history, stats)
        window.switchActivitySubTab = function(subTabName) {
            // Update sub-tab buttons within activity tab
            const activityTab = document.getElementById('activityTab');
            activityTab.querySelectorAll('.sub-tab-container .sub-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update sub-tab content within activity tab
            activityTab.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(subTabName + 'SubTab').classList.add('active');

            // Load data for sub-tabs
            if (subTabName === 'leagues' && !leaguesLoaded) {
                loadLeaguesTab();
            }
            if (subTabName === 'tournaments' && !tournamentsLoaded) {
                loadTournamentsTab();
            }
            if (subTabName === 'history' && !historyLoaded) {
                loadMatchHistory();
            }
            if (subTabName === 'stats' && !statsLoaded) {
                loadDetailedStats();
            }
        };

        // ============================================================================
        // CALENDAR / SCHEDULE
        // ============================================================================

        let scheduleLoaded = false;
        let currentCalendarDate = new Date();
        let currentWeekStart = getWeekStart(new Date());
        let calendarEvents = [];
        let calendarExpanded = false;

        // Get Sunday of the week containing the given date
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            d.setDate(d.getDate() - day);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        async function loadCalendar() {
            scheduleLoaded = true;
            await loadCalendarEvents();
            renderWeekView();
            renderCalendar();
            // Auto-select next match day
            selectNextMatchDay();
            initEventsView();
            // Check for tonight's match
            loadTonightsMatch();
        }

        // Find and select the next day with an event
        function selectNextMatchDay() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Sort events by date and find the next one
            const futureEvents = calendarEvents
                .filter(e => {
                    if (!e.date) return false;
                    const eventDate = new Date(e.date.substring(0, 10) + 'T12:00:00');
                    return eventDate >= today;
                })
                .sort((a, b) => a.date.localeCompare(b.date));

            if (futureEvents.length > 0) {
                const nextEventDate = futureEvents[0].date.substring(0, 10);
                showDayEvents(nextEventDate);
            }
        }

        // Render the week view (collapsed)
        function renderWeekView() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];

            // Update label to show month name
            const weekLabel = currentWeekStart.toLocaleDateString('en-US', { month: 'long' });
            document.getElementById('calWeekLabel').textContent = weekLabel;

            let html = '';
            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

                const isToday = date.getTime() === today.getTime();
                const dayEvents = calendarEvents.filter(e => e.date && e.date.substring(0, 10) === dateStr);

                let classes = 'cal-day';
                if (isToday) classes += ' today';
                if (dayEvents.length > 0) {
                    classes += ' has-event';
                    if (dayEvents.some(e => e.type === 'tournament')) classes += ' has-tournament';
                    if (dayEvents.some(e => e.type === 'upcoming-tournament')) classes += ' has-upcoming';
                    if (dayEvents.some(e => e.type === 'deadline')) classes += ' has-deadline';
                    if (dayEvents.some(e => e.type === 'social')) classes += ' has-social';
                    if (dayEvents.some(e => e.participating)) classes += ' participating';
                    if (dayEvents.length > 1) classes += ' has-multiple';
                }

                html += `
                    <div class="${classes}" onclick="showDayEvents('${dateStr}')">
                        <span class="cal-day-name">${dayNames[i]}</span>
                        <span class="cal-day-num">${date.getDate()}</span>
                    </div>
                `;
            }

            document.getElementById('calendarWeekDays').innerHTML = html;
        }

        window.changeWeek = function(delta) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (delta * 7));
            renderWeekView();
        };

        window.toggleCalendarExpand = function() {
            calendarExpanded = !calendarExpanded;
            const weekView = document.getElementById('calendarWeekView');
            const fullMonth = document.getElementById('calendarFullMonth');

            if (calendarExpanded) {
                weekView.style.display = 'none';
                fullMonth.classList.add('expanded');
            } else {
                weekView.style.display = 'block';
                fullMonth.classList.remove('expanded');
            }
        };

        async function loadCalendarEvents() {
            calendarEvents = [];
            if (!currentPlayer) return;

            try {
                // Load league matches from all teams
                for (const team of allTeams) {
                    const leagueId = team.id || team.league_id;
                    const teamId = team.team_id;
                    const matchesSnap = await getDocs(collection(db, 'leagues', leagueId, 'matches'));
                    // Collect unique match dates for this league
                    const leagueMatchDates = new Map(); // date -> first match info
                    let teamMatchCount = 0;

                    matchesSnap.forEach(docSnap => {
                        const match = docSnap.data();
                        const isTeamMatch = !teamId ||
                            match.home_team_id === teamId ||
                            match.away_team_id === teamId;

                        const dateStr = match.match_date || match.date || match.scheduled_date;

                        if (isTeamMatch && dateStr) {
                            teamMatchCount++;
                            // Determine opponent name
                            let opponent = `Week ${match.week || '?'}`;
                            if (teamId) {
                                const oppName = match.home_team_id === teamId
                                    ? match.away_team_name
                                    : match.home_team_name;
                                opponent = (match.home_team_id === teamId ? 'vs ' : '@ ') + (oppName || 'TBD');
                            }

                            calendarEvents.push({
                                type: 'league',
                                date: dateStr,
                                title: team.team_name || team.name || 'League Match',
                                subtitle: opponent,
                                leagueId: leagueId,
                                matchId: docSnap.id,
                                week: match.week,
                                homeTeamId: match.home_team_id,
                                awayTeamId: match.away_team_id,
                                homeTeamName: match.home_team_name,
                                awayTeamName: match.away_team_name,
                                participating: true
                            });
                        }

                        // Track all league dates in case team has no matches
                        if (dateStr && !leagueMatchDates.has(dateStr)) {
                            leagueMatchDates.set(dateStr, {
                                week: match.week,
                                matchId: docSnap.id
                            });
                        }
                    });

                    // If team has no matches in schedule, show all league nights
                    if (teamMatchCount === 0 && leagueMatchDates.size > 0) {
                        leagueMatchDates.forEach((info, dateStr) => {
                            calendarEvents.push({
                                type: 'league',
                                date: dateStr,
                                title: team.name || 'League Night',
                                subtitle: `Week ${info.week || '?'}`,
                                leagueId: leagueId,
                                matchId: info.matchId
                            });
                        });
                    }
                }

                // Load tournaments - both registered and upcoming
                const tournamentsSnap = await getDocs(collection(db, 'tournaments'));
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (const tDoc of tournamentsSnap.docs) {
                    const tournament = tDoc.data();
                    const dateStr = tournament.tournament_date || tournament.date;
                    const regDeadline = tournament.registration_deadline;

                    // Check if player is registered
                    const regSnap = await getDocs(
                        query(collection(db, 'tournaments', tDoc.id, 'registrations'),
                            where('player_id', '==', currentPlayer.id))
                    );
                    const isRegistered = !regSnap.empty;

                    // Tournament date event
                    if (dateStr) {
                        const tourneyDate = new Date(dateStr + 'T12:00:00');

                        if (isRegistered) {
                            // Registered tournament
                            calendarEvents.push({
                                type: 'tournament',
                                date: dateStr,
                                title: tournament.tournament_name || tournament.name || 'Tournament',
                                subtitle: tournament.venue_name || '',
                                tournamentId: tDoc.id,
                                participating: true
                            });
                        } else if (tourneyDate >= today && tournament.status !== 'completed') {
                            // Upcoming tournament not registered for
                            calendarEvents.push({
                                type: 'upcoming-tournament',
                                date: dateStr,
                                title: tournament.tournament_name || tournament.name || 'Upcoming Tournament',
                                subtitle: 'Not registered - ' + (tournament.venue_name || 'Click to register'),
                                tournamentId: tDoc.id
                            });
                        }
                    }

                    // Registration deadline event (only for unregistered upcoming tournaments)
                    if (regDeadline && !isRegistered) {
                        const deadlineDate = new Date(regDeadline + 'T12:00:00');
                        if (deadlineDate >= today) {
                            calendarEvents.push({
                                type: 'deadline',
                                deadlineType: 'tournament',
                                date: regDeadline,
                                title: 'Registration Deadline',
                                subtitle: (tournament.tournament_name || tournament.name || 'Tournament') + ' closes',
                                tournamentId: tDoc.id
                            });
                        }
                    }
                }

                // Load league registration deadlines
                const leaguesSnap = await getDocs(collection(db, 'leagues'));
                for (const lDoc of leaguesSnap.docs) {
                    const league = lDoc.data();
                    const regDeadline = league.registration_deadline || league.registration_end;

                    // Check if player is already in this league
                    const isInLeague = allTeams.some(t => (t.id || t.league_id) === lDoc.id);

                    if (regDeadline && !isInLeague && league.status !== 'completed') {
                        const deadlineDate = new Date(regDeadline + 'T12:00:00');
                        if (deadlineDate >= today) {
                            calendarEvents.push({
                                type: 'deadline',
                                deadlineType: 'league',
                                date: regDeadline,
                                title: 'League Registration Deadline',
                                subtitle: (league.league_name || league.name || 'League') + ' registration closes',
                                leagueId: lDoc.id
                            });
                        }
                    }
                }

                // Load social/casual matches (pickup games, casual events)
                try {
                    const socialSnap = await getDocs(collection(db, 'pickup_games'));
                    socialSnap.forEach(docSnap => {
                        const game = docSnap.data();
                        const dateStr = game.date || game.game_date;
                        if (dateStr) {
                            const gameDate = new Date(dateStr + 'T12:00:00');
                            if (gameDate >= today && game.status !== 'completed') {
                                calendarEvents.push({
                                    type: 'social',
                                    date: dateStr,
                                    title: game.title || 'Casual Darts',
                                    subtitle: game.venue_name || game.location || 'Social event',
                                    gameId: docSnap.id
                                });
                            }
                        }
                    });
                } catch (e) {
                    // pickup_games collection may not exist
                }

            } catch (error) {
                console.error('Error loading calendar events:', error);
            }
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const today = new Date();

            document.getElementById('calMonth').textContent =
                currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPad = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            let html = '';

            // Previous month padding
            const prevMonth = new Date(year, month, 0);
            for (let i = startPad - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="cal-day other-month">${day}</div>`;
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                // Match events by extracting just the YYYY-MM-DD part (first 10 chars)
                const dayEvents = calendarEvents.filter(e => {
                    if (!e.date) return false;
                    const eventDateStr = e.date.substring(0, 10); // Get just YYYY-MM-DD
                    return eventDateStr === dateStr;
                });

                let classes = 'cal-day';
                if (isToday) classes += ' today';
                if (dayEvents.length > 0) {
                    classes += ' has-event';
                    if (dayEvents.some(e => e.type === 'tournament')) classes += ' has-tournament';
                    if (dayEvents.some(e => e.type === 'upcoming-tournament')) classes += ' has-upcoming';
                    if (dayEvents.some(e => e.type === 'deadline')) classes += ' has-deadline';
                    if (dayEvents.some(e => e.type === 'social')) classes += ' has-social';
                    if (dayEvents.some(e => e.participating)) classes += ' participating';
                    if (dayEvents.length > 1) classes += ' has-multiple';
                }

                html += `<div class="${classes}" onclick="showDayEvents('${dateStr}')">${day}</div>`;
            }

            // Next month padding
            const totalCells = startPad + daysInMonth;
            const remaining = 7 - (totalCells % 7);
            if (remaining < 7) {
                for (let i = 1; i <= remaining; i++) {
                    html += `<div class="cal-day other-month">${i}</div>`;
                }
            }

            document.getElementById('calendarDays').innerHTML = html;
        }

        window.changeMonth = function(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        };

        window.showDayEvents = async function(dateStr) {
            // Remove selected class from all days, then add to clicked day
            document.querySelectorAll('.cal-day.selected').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.cal-day').forEach(el => {
                if (el.getAttribute('onclick')?.includes(dateStr)) {
                    el.classList.add('selected');
                }
            });

            // Hide events list and show single day view
            document.getElementById('eventsListContainer').style.display = 'none';
            document.getElementById('eventFilters').style.display = 'none';
            document.getElementById('myEventsBtn').classList.remove('active');
            document.getElementById('allEventsBtn').classList.remove('active');

            const dayEvents = calendarEvents.filter(e => e.date && e.date.startsWith(dateStr));
            const singleDayView = document.getElementById('singleDayView');
            const content = document.getElementById('singleDayContent');

            const date = new Date(dateStr + 'T12:00:00');
            document.getElementById('singleDayDate').textContent =
                date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

            if (dayEvents.length === 0) {
                content.innerHTML = '<div class="empty-state" style="padding: 20px;">No events scheduled</div>';
            } else {
                // Build initial HTML - different layout for different event types
                content.innerHTML = dayEvents.map((event, idx) => {
                    const eventId = event.leagueId || event.tournamentId || event.gameId || '';
                    const deadlineType = event.deadlineType || '';

                    if (event.type === 'league' && event.matchId) {
                        // League match card - will be populated by loadMatchCard
                        return `<div class="match-card event-league" id="matchCard${idx}" data-league-id="${event.leagueId}">
                            <div style="padding: 20px; text-align: center; color: var(--text-dim);">Loading match...</div>
                        </div>`;
                    } else if (event.type === 'tournament' || event.type === 'upcoming-tournament') {
                        // Tournament card - will be populated by loadTournamentCard
                        return `<div class="match-card event-tournament" id="tournamentCard${idx}" data-tournament-id="${event.tournamentId}">
                            <div style="padding: 20px; text-align: center; color: var(--text-dim);">Loading tournament...</div>
                        </div>`;
                    } else {
                        // Other events (deadlines, social)
                        const eventTypeLabel = getEventTypeLabel(event.type);
                        return `
                        <div class="event-card" onclick="goToEvent('${event.type}', '${eventId}', '${deadlineType}')">
                            <span class="event-type-badge ${event.type}">${eventTypeLabel}</span>
                            <div class="event-details">
                                <div class="event-title">${event.title}</div>
                                <div class="event-subtitle">${event.subtitle}</div>
                            </div>
                        </div>`;
                    }
                }).join('');

                // Auto-load card details
                dayEvents.forEach((event, idx) => {
                    if (event.type === 'league' && event.matchId) {
                        loadMatchCard(idx, event);
                    } else if (event.type === 'tournament' || event.type === 'upcoming-tournament') {
                        loadTournamentCard(idx, event);
                    }
                });
            }

            singleDayView.style.display = 'block';
        };

        async function loadMatchCard(idx, event, idPrefix = 'matchCard') {
            const cardEl = document.getElementById(`${idPrefix}${idx}`);
            if (!cardEl) return;

            const { leagueId, matchId, week } = event;
            let { homeTeamId, awayTeamId } = event;

            try {
                // Always get match data for score/winner info
                let matchStatus = 'scheduled';
                let homeScore = 0;
                let awayScore = 0;
                let matchWinner = null;

                let homeLineup = [];
                let awayLineup = [];
                let matchGames = [];
                const matchDoc = await getDoc(doc(db, 'leagues', leagueId, 'matches', matchId));
                if (matchDoc.exists()) {
                    const matchData = matchDoc.data();
                    homeTeamId = homeTeamId || matchData.home_team_id;
                    awayTeamId = awayTeamId || matchData.away_team_id;
                    matchStatus = matchData.status || 'scheduled';
                    homeScore = matchData.home_score || 0;
                    awayScore = matchData.away_score || 0;
                    matchWinner = matchData.winner; // 'home', 'away', or 'tie'
                    homeLineup = matchData.home_lineup || [];
                    awayLineup = matchData.away_lineup || [];
                    matchGames = matchData.games || [];
                }

                if (!homeTeamId || !awayTeamId) {
                    cardEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim);">Match info not available</div>';
                    return;
                }

                // Fetch team data, all league players, all teams, and all matches (for records and total weeks)
                const [homeTeamDoc, awayTeamDoc, allPlayersSnap, allMatchesSnap, allTeamsSnap] = await Promise.all([
                    getDoc(doc(db, 'leagues', leagueId, 'teams', homeTeamId)),
                    getDoc(doc(db, 'leagues', leagueId, 'teams', awayTeamId)),
                    getDocs(collection(db, 'leagues', leagueId, 'players')),
                    getDocs(collection(db, 'leagues', leagueId, 'matches')),
                    getDocs(collection(db, 'leagues', leagueId, 'teams'))
                ]);

                const homeTeam = homeTeamDoc.data() || {};
                const awayTeam = awayTeamDoc.data() || {};

                // Initialize teamRecords with all teams (so teams with 0-0 record still appear in standings)
                const teamRecords = {};
                allTeamsSnap.forEach(doc => {
                    teamRecords[doc.id] = { wins: 0, losses: 0, ties: 0, gamesWon: 0, gamesLost: 0 };
                });

                // Calculate team records from completed matches and get total weeks
                let totalWeeks = 0;
                allMatchesSnap.forEach(doc => {
                    const m = doc.data();
                    // Track max week number for total weeks
                    if (m.week && m.week > totalWeeks) totalWeeks = m.week;

                    // Only count completed matches for records
                    if (m.status !== 'completed') return;

                    if (!teamRecords[m.home_team_id]) teamRecords[m.home_team_id] = { wins: 0, losses: 0, ties: 0, gamesWon: 0, gamesLost: 0 };
                    if (!teamRecords[m.away_team_id]) teamRecords[m.away_team_id] = { wins: 0, losses: 0, ties: 0, gamesWon: 0, gamesLost: 0 };

                    // Track match wins/losses
                    if (m.home_score > m.away_score) {
                        teamRecords[m.home_team_id].wins++;
                        teamRecords[m.away_team_id].losses++;
                    } else if (m.away_score > m.home_score) {
                        teamRecords[m.away_team_id].wins++;
                        teamRecords[m.home_team_id].losses++;
                    } else {
                        teamRecords[m.home_team_id].ties++;
                        teamRecords[m.away_team_id].ties++;
                    }

                    // Track games (rounds) won/lost for tie-breaker
                    teamRecords[m.home_team_id].gamesWon += m.home_score || 0;
                    teamRecords[m.home_team_id].gamesLost += m.away_score || 0;
                    teamRecords[m.away_team_id].gamesWon += m.away_score || 0;
                    teamRecords[m.away_team_id].gamesLost += m.home_score || 0;
                });

                // Group players by team_id
                const homeRoster = [];
                const awayRoster = [];
                const allPlayersById = {};
                allPlayersSnap.forEach(d => {
                    const player = { id: d.id, ...d.data() };
                    allPlayersById[d.id] = player;
                    if (player.team_id === homeTeamId) {
                        homeRoster.push(player);
                    } else if (player.team_id === awayTeamId) {
                        awayRoster.push(player);
                    }
                });

                // Sort by position (captain first)
                homeRoster.sort((a, b) => (a.position || 99) - (b.position || 99));
                awayRoster.sort((a, b) => (a.position || 99) - (b.position || 99));

                // RULE: Always use team roster with player IDs for stats lookup
                // DO NOT use games array for player identity - names don't match (see docs/CODING-RULES.md)

                // Build display roster with fill-ins in correct positions
                // Fill-ins replace the player they're subbing for; OUT players go at bottom
                const homeDisplayRoster = [...homeRoster];
                const awayDisplayRoster = [...awayRoster];
                const homeOutPlayers = [];
                const awayOutPlayers = [];

                if (matchStatus === 'completed') {
                    // Process home lineup for fill-ins with replacing_player_id
                    homeLineup.forEach(lineupEntry => {
                        if (lineupEntry.is_sub && lineupEntry.player_id && lineupEntry.replacing_player_id) {
                            const fillInPlayer = allPlayersById[lineupEntry.player_id];
                            if (fillInPlayer) {
                                // Find and replace the player being subbed out
                                const replacingIdx = homeDisplayRoster.findIndex(p => p.id === lineupEntry.replacing_player_id);
                                if (replacingIdx !== -1) {
                                    const outPlayer = homeDisplayRoster[replacingIdx];
                                    homeOutPlayers.push({ ...outPlayer, isOut: true });
                                    homeDisplayRoster[replacingIdx] = {
                                        ...fillInPlayer,
                                        isFillIn: true,
                                        position: outPlayer.position // Keep the original position
                                    };
                                }
                            }
                        }
                    });

                    // Process away lineup for fill-ins with replacing_player_id
                    awayLineup.forEach(lineupEntry => {
                        if (lineupEntry.is_sub && lineupEntry.player_id && lineupEntry.replacing_player_id) {
                            const fillInPlayer = allPlayersById[lineupEntry.player_id];
                            if (fillInPlayer) {
                                // Find and replace the player being subbed out
                                const replacingIdx = awayDisplayRoster.findIndex(p => p.id === lineupEntry.replacing_player_id);
                                if (replacingIdx !== -1) {
                                    const outPlayer = awayDisplayRoster[replacingIdx];
                                    awayOutPlayers.push({ ...outPlayer, isOut: true });
                                    awayDisplayRoster[replacingIdx] = {
                                        ...fillInPlayer,
                                        isFillIn: true,
                                        position: outPlayer.position // Keep the original position
                                    };
                                }
                            }
                        }
                    });

                    // Re-sort rosters by position after substitutions
                    homeDisplayRoster.sort((a, b) => (a.position || 99) - (b.position || 99));
                    awayDisplayRoster.sort((a, b) => (a.position || 99) - (b.position || 99));
                }

                // Get player stats - player document may have stats directly embedded
                const playerStats = {};

                // First check if stats are embedded in player docs
                [...homeDisplayRoster, ...awayDisplayRoster].forEach(p => {
                    // Check for embedded stats in player doc (canonical or legacy fields)
                    if (p.x01_three_dart_avg || p.ppd || p.x01_ppd || p.cricket_mpr || p.mpr || p.stats) {
                        playerStats[p.id] = p.stats || p;
                    }
                });

                // Fetch stats by player ID from stats collection - RULE: ONE SOURCE (stats/{playerId})
                const playerIds = [...homeDisplayRoster.map(p => p.id), ...awayDisplayRoster.map(p => p.id)].filter(Boolean);

                await Promise.all(playerIds.map(async (playerId) => {
                    try {
                        const statsDoc = await getDoc(doc(db, 'leagues', leagueId, 'stats', playerId));
                        if (statsDoc.exists()) {
                            playerStats[playerId] = { ...playerStats[playerId], ...statsDoc.data() };
                        }
                    } catch (e) {
                        // Stats unavailable for player
                    }
                }));

                // Team records - use calculated records from matches
                const homeRec = teamRecords[homeTeamId] || { wins: 0, losses: 0, ties: 0 };
                const awayRec = teamRecords[awayTeamId] || { wins: 0, losses: 0, ties: 0 };
                const homeRecord = getTeamRecord(homeRec);
                const awayRecord = getTeamRecord(awayRec);

                // Calculate team standings (sort by wins, then game percentage - tie-breaker)
                const teamsWithRecords = Object.entries(teamRecords).map(([id, rec]) => {
                    const totalGames = rec.gamesWon + rec.gamesLost;
                    const gamePct = totalGames > 0 ? rec.gamesWon / totalGames : 0;
                    return {
                        id,
                        wins: rec.wins,
                        losses: rec.losses,
                        gamePct: gamePct
                    };
                }).sort((a, b) => {
                    // Sort by wins first, then by game percentage (tie-breaker)
                    if (b.wins !== a.wins) return b.wins - a.wins;
                    if (a.losses !== b.losses) return a.losses - b.losses;
                    return b.gamePct - a.gamePct;
                });
                const homeStanding = teamsWithRecords.findIndex(t => t.id === homeTeamId) + 1;
                const awayStanding = teamsWithRecords.findIndex(t => t.id === awayTeamId) + 1;
                const totalTeams = teamsWithRecords.length || '?';

                // Calculate team combined averages (3DA and MPR)
                const calcTeam3DA = (roster) => {
                    const avgs = roster.map(p => {
                        const stats = playerStats[p.id] || {};
                        return get3DA(stats) || 0;
                    }).filter(v => v > 0);
                    if (avgs.length === 0) return null;
                    return avgs.reduce((a, b) => a + b, 0) / avgs.length;
                };
                const calcTeamMPR = (roster) => {
                    const mprs = roster.map(p => {
                        const stats = playerStats[p.id] || {};
                        return getMPR(stats) || 0;
                    }).filter(v => v > 0);
                    if (mprs.length === 0) return null;
                    return mprs.reduce((a, b) => a + b, 0) / mprs.length;
                };
                const homeTeam3DA = calcTeam3DA(homeDisplayRoster);
                const awayTeam3DA = calcTeam3DA(awayDisplayRoster);
                const homeTeamMPR = calcTeamMPR(homeDisplayRoster);
                const awayTeamMPR = calcTeamMPR(awayDisplayRoster);

                // Determine if user is home or away - "vs" means home, "@" means away
                const userIsHome = event.subtitle?.startsWith('vs');

                // Put user's team on left, opponent on right
                const leftTeam = userIsHome ? homeTeam : awayTeam;
                const rightTeam = userIsHome ? awayTeam : homeTeam;
                const leftRoster = userIsHome ? homeDisplayRoster : awayDisplayRoster;
                const rightRoster = userIsHome ? awayDisplayRoster : homeDisplayRoster;
                const leftOutPlayers = userIsHome ? homeOutPlayers : awayOutPlayers;
                const rightOutPlayers = userIsHome ? awayOutPlayers : homeOutPlayers;
                const leftRecord = userIsHome ? homeRecord : awayRecord;
                const rightRecord = userIsHome ? awayRecord : homeRecord;
                const leftTeamId = userIsHome ? homeTeamId : awayTeamId;
                const rightTeamId = userIsHome ? awayTeamId : homeTeamId;
                const leftTeam3DA = userIsHome ? homeTeam3DA : awayTeam3DA;
                const rightTeam3DA = userIsHome ? awayTeam3DA : homeTeam3DA;
                const leftTeamMPR = userIsHome ? homeTeamMPR : awayTeamMPR;
                const rightTeamMPR = userIsHome ? awayTeamMPR : homeTeamMPR;
                const leftStanding = userIsHome ? homeStanding : awayStanding;
                const rightStanding = userIsHome ? awayStanding : homeStanding;

                // Determine winner for completed matches
                const isCompleted = matchStatus === 'completed';
                const leftScore = userIsHome ? homeScore : awayScore;
                const rightScore = userIsHome ? awayScore : homeScore;
                const leftWon = isCompleted && leftScore > rightScore;
                const rightWon = isCompleted && rightScore > leftScore;

                // Helper to compare individual stats and return class (higher is better)
                const compareValues = (leftVal, rightVal) => {
                    if (!leftVal || !rightVal) return { left: '', right: '' };
                    if (Math.abs(leftVal - rightVal) < 0.1) return { left: '', right: '' };
                    return leftVal > rightVal
                        ? { left: 'better', right: 'worse' }
                        : { left: 'worse', right: 'better' };
                };

                // Build paired roster rows (captain vs captain, B vs B, C vs C)
                const maxPlayers = Math.max(leftRoster.length, rightRoster.length, 3);
                let rosterRows = '';
                for (let i = 0; i < maxPlayers; i++) {
                    const leftPlayer = leftRoster[i];
                    const rightPlayer = rightRoster[i];

                    const leftName = leftPlayer ? getPlayerName(leftPlayer) : '';
                    const rightName = rightPlayer ? getPlayerName(rightPlayer) : '';
                    const leftPlayerStats = leftPlayer ? playerStats[leftPlayer.id] || {} : {};
                    const rightPlayerStats = rightPlayer ? playerStats[rightPlayer.id] || {} : {};
                    const leftCaptain = leftPlayer && (leftPlayer.is_captain || leftPlayer.position === 1);
                    const rightCaptain = rightPlayer && (rightPlayer.is_captain || rightPlayer.position === 1);
                    const leftFillIn = leftPlayer && leftPlayer.isFillIn;
                    const rightFillIn = rightPlayer && rightPlayer.isFillIn;

                    // Get individual stats using stats-helpers.js
                    const left3DA = get3DA(leftPlayerStats);
                    const right3DA = get3DA(rightPlayerStats);
                    const leftMPR = getMPR(leftPlayerStats);
                    const rightMPR = getMPR(rightPlayerStats);

                    // Compare each stat separately
                    const daCompare = (leftPlayer && rightPlayer) ? compareValues(left3DA, right3DA) : { left: '', right: '' };
                    const mprCompare = (leftPlayer && rightPlayer) ? compareValues(leftMPR, rightMPR) : { left: '', right: '' };

                    // Format stats with separate colored spans
                    const left3DAStr = left3DA != null ? left3DA.toFixed(1) : '-';
                    const leftMPRStr = leftMPR != null ? leftMPR.toFixed(2) : '-';
                    const right3DAStr = right3DA != null ? right3DA.toFixed(1) : '-';
                    const rightMPRStr = rightMPR != null ? rightMPR.toFixed(2) : '-';

                    // Build name classes
                    const leftNameClass = `match-player-name${leftCaptain ? ' captain' : ''}${leftFillIn ? ' fill-in' : ''}`;
                    const rightNameClass = `match-player-name${rightCaptain ? ' captain' : ''}${rightFillIn ? ' fill-in' : ''}`;

                    rosterRows += `
                        <div class="match-row">
                            <div class="match-player-cell left">
                                <span class="match-player-stats"><span class="${daCompare.left}">${left3DAStr}</span> / <span class="${mprCompare.left}">${leftMPRStr}</span></span>
                                <span class="${leftNameClass}">${leftFillIn ? '<span class="fill-in-badge">SUB</span> ' : ''}${leftName}</span>
                            </div>
                            <div class="match-player-cell right">
                                <span class="${rightNameClass}">${rightName}${rightFillIn ? ' <span class="fill-in-badge">SUB</span>' : ''}</span>
                                <span class="match-player-stats"><span class="${daCompare.right}">${right3DAStr}</span> / <span class="${mprCompare.right}">${rightMPRStr}</span></span>
                            </div>
                        </div>`;
                }

                // Add OUT player rows (players who were subbed out)
                const maxOutPlayers = Math.max(leftOutPlayers.length, rightOutPlayers.length);
                for (let i = 0; i < maxOutPlayers; i++) {
                    const leftOutPlayer = leftOutPlayers[i];
                    const rightOutPlayer = rightOutPlayers[i];

                    const leftOutName = leftOutPlayer ? getPlayerName(leftOutPlayer) : '';
                    const rightOutName = rightOutPlayer ? getPlayerName(rightOutPlayer) : '';
                    const leftOutStats = leftOutPlayer ? playerStats[leftOutPlayer.id] || {} : {};
                    const rightOutStats = rightOutPlayer ? playerStats[rightOutPlayer.id] || {} : {};

                    // Get stats for OUT players (show their actual stats)
                    const leftOut3DA = leftOutPlayer ? get3DA(leftOutStats) : null;
                    const leftOutMPR = leftOutPlayer ? getMPR(leftOutStats) : null;
                    const rightOut3DA = rightOutPlayer ? get3DA(rightOutStats) : null;
                    const rightOutMPR = rightOutPlayer ? getMPR(rightOutStats) : null;

                    // Format stats - show actual stats for OUT player, dashes for opponent side
                    const leftOut3DAStr = leftOut3DA != null ? leftOut3DA.toFixed(1) : '-.-';
                    const leftOutMPRStr = leftOutMPR != null ? leftOutMPR.toFixed(2) : '-.--';
                    // Opponent side shows dashes since there's no matchup for OUT players
                    const rightOut3DAStr = rightOutPlayer ? (rightOut3DA != null ? rightOut3DA.toFixed(1) : '-.-') : '-.-';
                    const rightOutMPRStr = rightOutPlayer ? (rightOutMPR != null ? rightOutMPR.toFixed(2) : '-.--') : '-.--';

                    rosterRows += `
                        <div class="match-row out-row">
                            <div class="match-player-cell left">
                                <span class="match-player-stats out-stats">${leftOutPlayer ? leftOut3DAStr : '-.-'} / ${leftOutPlayer ? leftOutMPRStr : '-.--'}</span>
                                <span class="match-player-name out">${leftOutPlayer ? '<span class="out-badge">OUT</span> ' : ''}${leftOutName}</span>
                            </div>
                            <div class="match-player-cell right">
                                <span class="match-player-name out">${rightOutName}${rightOutPlayer ? ' <span class="out-badge">OUT</span>' : ''}</span>
                                <span class="match-player-stats out-stats">${rightOutPlayer ? rightOut3DAStr : '-.-'} / ${rightOutPlayer ? rightOutMPRStr : '-.--'}</span>
                            </div>
                        </div>`;
                }

                // Render match card - user's team always on left
                // Show big gold star in dedicated slot for winning team
                const winnerStar = '<span class="winner-star">‚òÖ</span>';

                // Determine if match can still be confirmed (not completed or in progress)
                const canConfirmAttendance = matchStatus !== 'completed' && matchStatus !== 'in_progress';

                // Compare team averages for coloring
                const team3DACompare = compareValues(leftTeam3DA, rightTeam3DA);
                const teamMPRCompare = compareValues(leftTeamMPR, rightTeamMPR);

                // Format team averages
                const left3DADisplay = leftTeam3DA ? leftTeam3DA.toFixed(1) : '-';
                const right3DADisplay = rightTeam3DA ? rightTeam3DA.toFixed(1) : '-';
                const leftMPRDisplay = leftTeamMPR ? leftTeamMPR.toFixed(2) : '-';
                const rightMPRDisplay = rightTeamMPR ? rightTeamMPR.toFixed(2) : '-';

                // Build team avg display with comparison colors
                const buildTeamAvgHtml = (da, mpr, daClass, mprClass) => {
                    if (!da && !mpr) return '';
                    return `<div class="match-team-avg"><span class="${daClass}">${da}</span> / <span class="${mprClass}">${mpr}</span></div>`;
                };

                cardEl.innerHTML = `
                    <div class="match-card-header${isCompleted ? ' completed' : ''}">
                        <div class="match-team-side left${leftWon ? ' winner' : ''}">
                            <div class="match-team-info-row"><span class="match-team-name">${getTeamName(leftTeam)}</span>${leftStanding ? `<span class="match-team-standing">${getOrdinal(leftStanding)}</span>` : ''}<span class="match-team-record">${leftRecord}</span></div>
                            ${buildTeamAvgHtml(left3DADisplay, leftMPRDisplay, team3DACompare.left, teamMPRCompare.left)}
                            ${isCompleted ? `<div class="match-header-score${leftWon ? ' winner' : ''}">${leftScore}</div>` : ''}
                        </div>
                        <div class="match-center">
                            <div class="match-week">WEEK ${week || '?'}${totalWeeks ? '/' + totalWeeks : ''}</div>
                            <div class="match-vs">${isCompleted ? 'FINAL' : (userIsHome ? 'VS' : '@')}</div>
                        </div>
                        <div class="match-team-side right${rightWon ? ' winner' : ''}">
                            ${isCompleted ? `<div class="match-header-score${rightWon ? ' winner' : ''}">${rightScore}</div>` : ''}
                            <div class="match-team-info-row"><span class="match-team-record">${rightRecord}</span>${rightStanding ? `<span class="match-team-standing">${getOrdinal(rightStanding)}</span>` : ''}<span class="match-team-name">${getTeamName(rightTeam)}</span></div>
                            ${buildTeamAvgHtml(right3DADisplay, rightMPRDisplay, team3DACompare.right, teamMPRCompare.right)}
                            ${isCompleted && rightWon ? winnerStar : ''}
                        </div>
                    </div>
                    <div class="match-card-body">
                        ${rosterRows}
                    </div>
                    <div class="match-card-footer">
                        ${canConfirmAttendance ? `
                            <button class="attendance-btn confirm" onclick="setAttendance('${leagueId}', '${matchId}', 'confirmed', event)">
                                <span class="btn-icon">‚úì</span> I'll Be There
                            </button>
                        ` : '<div></div>'}
                        <span class="match-card-link" onclick="goToEvent('league', '${leagueId}')">League Hub</span>
                        ${isCompleted
                            ? `<a href="/pages/match-report.html?league_id=${leagueId}&match_id=${matchId}" class="match-hub-btn">View Report</a>`
                            : `<a href="/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}" class="match-hub-btn">Match Hub</a>`
                        }
                        ${canConfirmAttendance ? `
                            <button class="attendance-btn cant-make" onclick="setAttendance('${leagueId}', '${matchId}', 'unavailable', event)">
                                <span class="btn-icon">‚úï</span> Can't Make It
                            </button>
                        ` : '<div></div>'}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading match card:', error);
                cardEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">Error loading match</div>';
            }
        }

        function getEventTypeLabel(type) {
            const labels = {
                'league': 'League',
                'tournament': 'Tournament',
                'upcoming-tournament': 'Upcoming',
                'deadline': 'Deadline',
                'social': 'Social'
            };
            return labels[type] || type;
        }

        window.closeEventPopup = function() {
            document.getElementById('eventPopup').style.display = 'none';
        };

        window.closeSingleDayView = function() {
            document.getElementById('singleDayView').style.display = 'none';
            document.querySelectorAll('.cal-day.selected').forEach(el => el.classList.remove('selected'));
        };

        window.goToEvent = function(type, id, deadlineType) {
            if (!id) return;
            if (type === 'league') {
                window.location.href = `/pages/league-view.html?league_id=${id}`;
            } else if (type === 'tournament' || type === 'upcoming-tournament') {
                window.location.href = `/pages/tournament-view.html?tournament_id=${id}`;
            } else if (type === 'deadline') {
                // Deadlines link to the league/tournament page for registration
                if (deadlineType === 'league') {
                    window.location.href = `/pages/league-view.html?league_id=${id}`;
                } else {
                    window.location.href = `/pages/tournament-view.html?tournament_id=${id}`;
                }
            } else if (type === 'social') {
                window.location.href = `/pages/online-play.html`;
            }
        };

        // Set attendance status for a future match
        window.setAttendance = async function(leagueId, matchId, status, clickEvent) {
            clickEvent.stopPropagation();

            if (!currentPlayer) {
                showToast('Please log in to confirm attendance', 'error');
                return;
            }

            const btn = clickEvent.target.closest('.attendance-btn');
            const btnsContainer = btn.closest('.match-attendance-btns');
            const allBtns = btnsContainer.querySelectorAll('.attendance-btn');

            // Update UI immediately
            allBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            try {
                // Save attendance to Firestore
                // Store in match_attendance subcollection under the match
                const attendanceRef = doc(db, 'leagues', leagueId, 'matches', matchId, 'attendance', currentPlayer.id);
                await setDoc(attendanceRef, {
                    player_id: currentPlayer.id,
                    player_name: `${currentPlayer.first_name || ''} ${currentPlayer.last_name || ''}`.trim(),
                    status: status, // 'confirmed' or 'unavailable'
                    updated_at: serverTimestamp()
                });

                showToast(status === 'confirmed' ? 'Attendance confirmed!' : 'Marked as unavailable', 'success');
            } catch (error) {
                console.error('Error setting attendance:', error);
                showToast('Failed to update attendance', 'error');
                // Revert UI
                btn.classList.remove('active');
            }
        };

        // ============================================================================
        // EVENTS VIEW (My Events / All Events)
        // ============================================================================

        let currentEventsView = 'my'; // 'my' or 'all'
        let currentEventFilter = 'all'; // 'all', 'league', 'tournament'
        let allEventsData = []; // Cache for all events

        window.showEventsView = async function(view) {
            currentEventsView = view;

            // Hide single day view and show events list
            document.getElementById('singleDayView').style.display = 'none';
            document.querySelectorAll('.cal-day.selected').forEach(el => el.classList.remove('selected'));
            document.getElementById('eventsListContainer').style.display = 'block';
            document.getElementById('eventFilters').style.display = 'flex';

            // Update button states
            document.getElementById('myEventsBtn').classList.toggle('active', view === 'my');
            document.getElementById('allEventsBtn').classList.toggle('active', view === 'all');

            await loadEventsView();
        };

        window.filterEvents = function(filter) {
            currentEventFilter = filter;

            // Update filter chip states
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.dataset.filter === filter);
            });

            renderEventsView();
        };

        async function loadEventsView() {
            const container = document.getElementById('eventsListContainer');
            container.innerHTML = '<div class="empty-state" style="padding: 30px;">Loading events...</div>';

            try {
                allEventsData = [];

                if (currentEventsView === 'my') {
                    // Load individual matches for user's leagues
                    for (const team of allTeams) {
                        const leagueId = team.id || team.league_id;
                        const userTeamId = team.team_id || team.teamId;
                        if (!leagueId) continue;

                        const leagueDoc = await getDoc(doc(db, 'leagues', leagueId));
                        if (!leagueDoc.exists()) continue;
                        const leagueData = leagueDoc.data();
                        const leagueName = leagueData.league_name || 'League';

                        // Load all matches for this league
                        const matchesSnap = await getDocs(collection(db, 'leagues', leagueId, 'matches'));
                        matchesSnap.forEach(mDoc => {
                            const m = mDoc.data();
                            // Only include matches where user's team is playing
                            if (m.home_team_id === userTeamId || m.away_team_id === userTeamId) {
                                allEventsData.push({
                                    type: 'league-match',
                                    leagueId: leagueId,
                                    leagueName: leagueName,
                                    matchId: mDoc.id,
                                    week: m.week || 0,
                                    date: m.date || m.match_date || m.scheduled_date,
                                    homeTeamId: m.home_team_id,
                                    awayTeamId: m.away_team_id,
                                    status: m.status || 'scheduled',
                                    homeScore: m.home_score || 0,
                                    awayScore: m.away_score || 0,
                                    winner: m.winner,
                                    userTeamId: userTeamId
                                });
                            }
                        });
                    }

                    // Sort matches by week
                    allEventsData.sort((a, b) => (a.week || 0) - (b.week || 0));

                    // Load tournaments user is registered for
                    const tournamentsSnap = await getDocs(collection(db, 'tournaments'));
                    for (const tDoc of tournamentsSnap.docs) {
                        const tData = tDoc.data();
                        const regSnap = await getDocs(query(
                            collection(db, 'tournaments', tDoc.id, 'registrations'),
                            where('player_id', '==', currentPlayer.id)
                        ));
                        if (!regSnap.empty) {
                            allEventsData.push({
                                type: 'tournament',
                                id: tDoc.id,
                                name: tData.tournament_name || 'Tournament',
                                date: tData.date,
                                location: tData.location || '',
                                status: tData.status || 'upcoming',
                                events: tData.events || []
                            });
                        }
                    }
                } else {
                    // All Events: Show registration deadlines and league/tournament info
                    const leaguesSnap = await getDocs(collection(db, 'leagues'));
                    leaguesSnap.forEach(lDoc => {
                        const lData = lDoc.data();
                        // Add registration deadline if exists and in future
                        if (lData.registration_deadline) {
                            const deadline = new Date(lData.registration_deadline);
                            if (deadline > new Date()) {
                                allEventsData.push({
                                    type: 'league-deadline',
                                    id: lDoc.id,
                                    name: lData.league_name || 'League',
                                    deadline: lData.registration_deadline,
                                    season: lData.season || '',
                                    location: lData.location || ''
                                });
                            }
                        }
                        // Also add active leagues as info cards
                        if (lData.status === 'active' || lData.status === 'registration') {
                            allEventsData.push({
                                type: 'league-info',
                                id: lDoc.id,
                                name: lData.league_name || 'League',
                                season: lData.season || '',
                                status: lData.status || 'active',
                                location: lData.location || ''
                            });
                        }
                    });

                    // Load all tournaments with registration deadlines
                    const tournamentsSnap = await getDocs(collection(db, 'tournaments'));
                    tournamentsSnap.forEach(tDoc => {
                        const tData = tDoc.data();
                        if (tData.registration_deadline) {
                            const deadline = new Date(tData.registration_deadline);
                            if (deadline > new Date()) {
                                allEventsData.push({
                                    type: 'tournament-deadline',
                                    id: tDoc.id,
                                    name: tData.tournament_name || 'Tournament',
                                    deadline: tData.registration_deadline,
                                    date: tData.date,
                                    location: tData.location || ''
                                });
                            }
                        }
                        // Add upcoming tournaments
                        if (tData.status === 'upcoming' || tData.status === 'registration') {
                            allEventsData.push({
                                type: 'tournament-info',
                                id: tDoc.id,
                                name: tData.tournament_name || 'Tournament',
                                date: tData.date,
                                location: tData.location || '',
                                status: tData.status || 'upcoming'
                            });
                        }
                    });

                    // Sort by deadline/date
                    allEventsData.sort((a, b) => {
                        const dateA = a.deadline || a.date || '';
                        const dateB = b.deadline || b.date || '';
                        return new Date(dateA) - new Date(dateB);
                    });
                }

                renderEventsView();
            } catch (error) {
                console.error('Error loading events:', error);
                container.innerHTML = '<div class="empty-state" style="padding: 30px; color: var(--danger);">Error loading events</div>';
            }
        }

        function renderEventsView() {
            const container = document.getElementById('eventsListContainer');

            // Filter events based on type
            let filteredEvents = allEventsData;
            if (currentEventFilter === 'league') {
                filteredEvents = allEventsData.filter(e => e.type.startsWith('league'));
            } else if (currentEventFilter === 'tournament') {
                filteredEvents = allEventsData.filter(e => e.type.startsWith('tournament'));
            }

            if (filteredEvents.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding: 30px;">
                    <p>No ${currentEventFilter === 'all' ? 'events' : currentEventFilter + 's'} found</p>
                    ${currentEventsView === 'my' ? '<p style="font-size: 12px; color: var(--text-dim);">Join a league or register for a tournament to see your events here</p>' : ''}
                </div>`;
                return;
            }

            container.innerHTML = filteredEvents.map((event, idx) => {
                switch (event.type) {
                    case 'league-match':
                        return renderLeagueMatchCard(event, idx);
                    case 'league-deadline':
                        return renderDeadlineCard(event, idx, 'league');
                    case 'league-info':
                        return renderInfoCard(event, idx, 'league');
                    case 'tournament':
                        return renderTournamentCard(event, idx);
                    case 'tournament-deadline':
                        return renderDeadlineCard(event, idx, 'tournament');
                    case 'tournament-info':
                        return renderInfoCard(event, idx, 'tournament');
                    default:
                        return '';
                }
            }).join('');

            // Auto-load match card details (same as single day view)
            filteredEvents.forEach((event, idx) => {
                if (event.type === 'league-match') {
                    loadEventsMatchCard(idx, event);
                } else if (event.type === 'tournament') {
                    loadEventsTournamentCard(idx, event);
                }
            });
        }

        // ========== TONIGHT'S MATCH BANNER ==========
        let tonightsMatchData = null;

        async function loadTonightsMatch() {
            if (!currentPlayer || !allTeams || allTeams.length === 0) {
                document.getElementById('tonightsMatchBanner').style.display = 'none';
                return;
            }

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            // Find a match for today
            for (const team of allTeams) {
                const leagueId = team.id || team.league_id;
                const teamId = team.team_id;
                if (!leagueId) continue;

                try {
                    const matchesSnap = await getDocs(collection(db, 'leagues', leagueId, 'matches'));

                    for (const matchDoc of matchesSnap.docs) {
                        const match = matchDoc.data();
                        const matchDate = match.match_date || match.date || match.scheduled_date;

                        // Check if match is today and involves our team
                        if (matchDate === todayStr &&
                            (match.home_team_id === teamId || match.away_team_id === teamId)) {

                            // Found today's match!
                            const isHome = match.home_team_id === teamId;

                            // Fetch team data and stats
                            const [homeTeamDoc, awayTeamDoc, allMatchesSnap, allPlayersSnap] = await Promise.all([
                                getDoc(doc(db, 'leagues', leagueId, 'teams', match.home_team_id)),
                                getDoc(doc(db, 'leagues', leagueId, 'teams', match.away_team_id)),
                                getDocs(collection(db, 'leagues', leagueId, 'matches')),
                                getDocs(collection(db, 'leagues', leagueId, 'players'))
                            ]);

                            const homeTeam = homeTeamDoc.data() || {};
                            const awayTeam = awayTeamDoc.data() || {};

                            // Calculate records
                            const teamRecords = {};
                            allMatchesSnap.forEach(d => {
                                const m = d.data();
                                if (m.status !== 'completed') return;
                                if (!teamRecords[m.home_team_id]) teamRecords[m.home_team_id] = { wins: 0, losses: 0 };
                                if (!teamRecords[m.away_team_id]) teamRecords[m.away_team_id] = { wins: 0, losses: 0 };
                                if (m.home_score > m.away_score) {
                                    teamRecords[m.home_team_id].wins++;
                                    teamRecords[m.away_team_id].losses++;
                                } else if (m.away_score > m.home_score) {
                                    teamRecords[m.away_team_id].wins++;
                                    teamRecords[m.home_team_id].losses++;
                                }
                            });

                            const userRecord = teamRecords[teamId] || { wins: 0, losses: 0 };
                            const oppTeamId = isHome ? match.away_team_id : match.home_team_id;
                            const oppRecord = teamRecords[oppTeamId] || { wins: 0, losses: 0 };

                            // Build rosters for team averages
                            const userRoster = [], oppRoster = [];
                            allPlayersSnap.forEach(d => {
                                const p = { id: d.id, ...d.data() };
                                if (p.team_id === teamId) userRoster.push(p);
                                else if (p.team_id === oppTeamId) oppRoster.push(p);
                            });

                            // Fetch stats
                            const playerStats = {};
                            const playerIds = [...userRoster, ...oppRoster].map(p => p.id).filter(Boolean);
                            await Promise.all(playerIds.map(async (playerId) => {
                                try {
                                    const statsDoc = await getDoc(doc(db, 'leagues', leagueId, 'stats', playerId));
                                    if (statsDoc.exists()) playerStats[playerId] = statsDoc.data();
                                } catch (e) { }
                            }));

                            // Calculate team averages
                            const calcTeamAvg = (roster) => {
                                const avgs = roster.map(p => {
                                    const s = playerStats[p.id] || {};
                                    return s.x01_total_darts > 0 ? (s.x01_total_points / s.x01_total_darts * 3) : 0;
                                }).filter(v => v > 0);
                                return avgs.length ? (avgs.reduce((a, b) => a + b, 0) / avgs.length).toFixed(1) : '--';
                            };
                            const calcTeamMPR = (roster) => {
                                const mprs = roster.map(p => {
                                    const s = playerStats[p.id] || {};
                                    return s.cricket_total_rounds > 0 ? (s.cricket_total_marks / s.cricket_total_rounds) : 0;
                                }).filter(v => v > 0);
                                return mprs.length ? (mprs.reduce((a, b) => a + b, 0) / mprs.length).toFixed(2) : '--';
                            };

                            // Sort rosters by position
                            userRoster.sort((a, b) => (a.position || 99) - (b.position || 99));
                            oppRoster.sort((a, b) => (a.position || 99) - (b.position || 99));

                            // Get availability for user's team
                            const userAvailability = match.home_availability && isHome ? match.home_availability :
                                                    match.away_availability && !isHome ? match.away_availability : {};

                            // Current player's availability
                            const myAvail = userAvailability[currentPlayer.id] || 'unknown';

                            tonightsMatchData = {
                                leagueId: leagueId,
                                matchId: matchDoc.id,
                                teamId: teamId,
                                week: match.week,
                                isHome: isHome,
                                captainId: team.captain_id || null
                            };

                            // Format date
                            const dateObj = new Date(matchDate);
                            const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                            // Render rosters - same as renderMatchCard
                            const renderRoster = (roster, isUserTeam, availability) => {
                                if (!roster || roster.length === 0) {
                                    return '<div class="match-player-row"><span class="match-player-name">No players</span></div>';
                                }
                                return roster.map(p => {
                                    const s = playerStats[p.id] || {};
                                    const x01Stat = s.x01_total_darts > 0 ? (s.x01_total_points / s.x01_total_darts * 3).toFixed(1) : '-';
                                    const mprStat = s.cricket_total_rounds > 0 ? (s.cricket_total_marks / s.cricket_total_rounds).toFixed(2) : '-';
                                    let rowClass = '';
                                    if (isUserTeam && availability) {
                                        const avail = availability[p.id] || 'unknown';
                                        if (avail === 'unavailable') rowClass = 'unavailable';
                                        else if (avail === 'confirmed') rowClass = 'confirmed';
                                    }
                                    return `
                                        <div class="match-player-row ${rowClass}">
                                            <span class="match-player-level">${p.level || ''}</span>
                                            <span class="match-player-name" onclick="viewPlayer('${p.id}', event)">${p.name}</span>
                                            <span class="match-player-stats">${x01Stat} / ${mprStat}</span>
                                        </div>
                                    `;
                                }).join('');
                            };

                            const cantSelected = myAvail === 'unavailable' ? 'selected' : '';
                            const inSelected = myAvail === 'confirmed' ? 'selected' : '';
                            const userTeamName = isHome ? (homeTeam.team_name || homeTeam.name || 'Your Team') : (awayTeam.team_name || awayTeam.name || 'Your Team');
                            const oppTeamName = isHome ? (awayTeam.team_name || awayTeam.name || 'Opponent') : (homeTeam.team_name || homeTeam.name || 'Opponent');
                            // oppTeamId already declared above at line 12483

                            // Use exact same HTML structure as renderMatchCard
                            document.getElementById('tonightsMatchBody').innerHTML = `
                                <button class="match-avail-btn cant-btn ${cantSelected}"
                                        onclick="tonightsCantMake()">
                                    <span class="icon">‚úó</span>
                                    CAN'T
                                </button>

                                <div class="match-team-section">
                                    <div class="match-team-header">
                                        <span class="match-team-name" onclick="viewTeam('${teamId}', event)">${userTeamName}</span>
                                        <span class="match-team-record">(${userRecord.wins}-${userRecord.losses})</span>
                                    </div>
                                    ${renderRoster(userRoster, true, userAvailability)}
                                </div>

                                <div class="match-center-divider">
                                    <div class="match-center-week">WK ${match.week || '?'}</div>
                                    <div class="match-center-date">${dateStr}</div>
                                </div>

                                <div class="match-team-section">
                                    <div class="match-team-header">
                                        <span class="match-team-name" onclick="viewTeam('${oppTeamId}', event)">${oppTeamName}</span>
                                        <span class="match-team-record">(${oppRecord.wins}-${oppRecord.losses})</span>
                                    </div>
                                    ${renderRoster(oppRoster, false, null)}
                                </div>

                                <button class="match-avail-btn in-btn ${inSelected}"
                                        onclick="tonightsConfirmAttendance()">
                                    <span class="icon">‚úì</span>
                                    I'M IN
                                </button>
                            `;

                            // Add match night button
                            const cardEl = document.getElementById('tonightsMatchBanner');
                            const existingBtn = cardEl.querySelector('.match-night-btn-container');
                            if (!existingBtn) {
                                cardEl.insertAdjacentHTML('beforeend', `
                                    <div class="match-night-btn-container">
                                        <a href="/pages/match-night.html?league_id=${leagueId}&match_id=${matchDoc.id}" class="match-night-btn">
                                            üéØ GO TO MATCH NIGHT
                                        </a>
                                    </div>
                                `)
                            }

                            // Start countdown timer
                            updateTonightsCountdown();
                            setInterval(updateTonightsCountdown, 60000);

                            // Show the banner
                            document.getElementById('tonightsMatchBanner').style.display = 'block';
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Error loading tonight\'s match:', error);
                }
            }

            // No match today
            document.getElementById('tonightsMatchBanner').style.display = 'none';
        }

        function updateTonightsCountdown() {
            const countdownEl = document.getElementById('tonightsCountdown');
            if (!countdownEl) return; // Element not present in current layout

            const now = new Date();
            // 7 PM start time
            const startTime = new Date();
            startTime.setHours(19, 0, 0, 0);

            if (now >= startTime) {
                countdownEl.textContent = 'NOW!';
                countdownEl.style.background = 'var(--success)';
            } else {
                const diffMs = startTime - now;
                const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                countdownEl.textContent = `${diffHrs}h ${diffMins}m`;
            }
        }

        // Tonight's Match action handlers
        window.tonightsConfirmAttendance = async function() {
            if (!tonightsMatchData) return;
            try {
                await callFunction('setPlayerAvailability', {
                    player_id: currentPlayer.id,
                    league_id: tonightsMatchData.leagueId,
                    match_id: tonightsMatchData.matchId,
                    team_id: tonightsMatchData.teamId,
                    availability: 'confirmed',
                    notify_captain: false
                });
                // Update button states
                const card = document.getElementById('tonightsMatchBanner');
                card.querySelector('.cant-btn')?.classList.remove('selected');
                card.querySelector('.in-btn')?.classList.add('selected');
                showToast('Confirmed! See you tonight! üéØ', 'success');
            } catch (error) {
                console.error('Error confirming:', error);
                showToast('Error confirming attendance', 'error');
            }
        };

        window.tonightsCantMake = async function() {
            if (!tonightsMatchData) return;
            try {
                await callFunction('setPlayerAvailability', {
                    player_id: currentPlayer.id,
                    league_id: tonightsMatchData.leagueId,
                    match_id: tonightsMatchData.matchId,
                    team_id: tonightsMatchData.teamId,
                    availability: 'unavailable',
                    notify_captain: true
                });
                // Update button states
                const card = document.getElementById('tonightsMatchBanner');
                card.querySelector('.cant-btn')?.classList.add('selected');
                card.querySelector('.in-btn')?.classList.remove('selected');
                showToast('Captain notified - hope to see you next week!', 'info');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error updating availability', 'error');
            }
        };

        window.tonightsRunningLate = async function() {
            if (!tonightsMatchData || !tonightsMatchData.captainId) {
                showToast('Could not find captain to message', 'error');
                return;
            }

            // Open a quick DM to captain with pre-filled message
            const captainId = tonightsMatchData.captainId;

            // Try to get captain's info
            try {
                const captainDoc = await getDoc(doc(db, 'leagues', tonightsMatchData.leagueId, 'players', captainId));
                if (captainDoc.exists()) {
                    const captain = captainDoc.data();
                    const captainName = captain.name || 'Captain';
                    const captainPlayerId = captain.player_id;

                    if (captainPlayerId) {
                        // Navigate to messages with pre-filled running late message
                        window.location.href = `/pages/messages.html?to=${captainPlayerId}&message=${encodeURIComponent('Hey, running a bit late tonight. Be there soon!')}`;
                    } else {
                        showToast('Captain not linked to player profile', 'error');
                    }
                } else {
                    showToast('Could not find captain', 'error');
                }
            } catch (error) {
                console.error('Error finding captain:', error);
                showToast('Error messaging captain', 'error');
            }
        };

        window.tonightsGoToMatchHub = function() {
            if (!tonightsMatchData) return;
            window.location.href = `/pages/match-hub.html?league_id=${tonightsMatchData.leagueId}&match_id=${tonightsMatchData.matchId}`;
        };

        // Render match card for My Events - SAME format as single day view
        function renderLeagueMatchCard(event, idx) {
            // Use exact same format as single day view - placeholder that gets populated by loadMatchCard
            return `<div class="match-card event-league" id="eventsMatchCard${idx}"
                         data-league-id="${event.leagueId}" data-match-id="${event.matchId}"
                         data-week="${event.week}" data-home-team-id="${event.homeTeamId}"
                         data-away-team-id="${event.awayTeamId}" data-league-name="${event.leagueName}">
                <div style="padding: 20px; text-align: center; color: var(--text-dim);">Loading match...</div>
            </div>`;
        }

        // Load match card for events list - COLLAPSED version with expand button
        async function loadEventsMatchCard(idx, event) {
            const cardEl = document.getElementById(`eventsMatchCard${idx}`);
            if (!cardEl) return;

            const { leagueId, matchId, week } = event;
            let { homeTeamId, awayTeamId } = event;

            try {
                // Fetch match data
                let matchStatus = 'scheduled';
                let homeScore = 0, awayScore = 0, matchWinner = null;

                const matchDoc = await getDoc(doc(db, 'leagues', leagueId, 'matches', matchId));
                if (matchDoc.exists()) {
                    const matchData = matchDoc.data();
                    homeTeamId = homeTeamId || matchData.home_team_id;
                    awayTeamId = awayTeamId || matchData.away_team_id;
                    matchStatus = matchData.status || 'scheduled';
                    homeScore = matchData.home_score || 0;
                    awayScore = matchData.away_score || 0;
                    matchWinner = matchData.winner;
                }

                // Fetch teams, players, and matches for standings
                const [homeTeamDoc, awayTeamDoc, allPlayersSnap, allMatchesSnap] = await Promise.all([
                    getDoc(doc(db, 'leagues', leagueId, 'teams', homeTeamId)),
                    getDoc(doc(db, 'leagues', leagueId, 'teams', awayTeamId)),
                    getDocs(collection(db, 'leagues', leagueId, 'players')),
                    getDocs(collection(db, 'leagues', leagueId, 'matches'))
                ]);

                const homeTeam = homeTeamDoc.data() || {};
                const awayTeam = awayTeamDoc.data() || {};

                // Calculate team records and total weeks
                const teamRecords = {};
                let totalWeeks = 0;
                allMatchesSnap.forEach(doc => {
                    const m = doc.data();
                    if (m.week && m.week > totalWeeks) totalWeeks = m.week;
                    if (m.status !== 'completed') return;
                    if (!teamRecords[m.home_team_id]) teamRecords[m.home_team_id] = { wins: 0, losses: 0, ties: 0 };
                    if (!teamRecords[m.away_team_id]) teamRecords[m.away_team_id] = { wins: 0, losses: 0, ties: 0 };
                    if (m.home_score > m.away_score) {
                        teamRecords[m.home_team_id].wins++;
                        teamRecords[m.away_team_id].losses++;
                    } else if (m.away_score > m.home_score) {
                        teamRecords[m.away_team_id].wins++;
                        teamRecords[m.home_team_id].losses++;
                    } else {
                        teamRecords[m.home_team_id].ties++;
                        teamRecords[m.away_team_id].ties++;
                    }
                });

                const homeRecord = getTeamRecord(teamRecords[homeTeamId]);
                const awayRecord = getTeamRecord(teamRecords[awayTeamId]);

                // Calculate standings
                const standingsArray = Object.keys(teamRecords).map(id => ({
                    id,
                    wins: teamRecords[id].wins,
                    losses: teamRecords[id].losses,
                    ties: teamRecords[id].ties
                })).sort((a, b) => b.wins - a.wins || a.losses - b.losses);
                const homeStanding = standingsArray.findIndex(t => t.id === homeTeamId) + 1;
                const awayStanding = standingsArray.findIndex(t => t.id === awayTeamId) + 1;

                // Build rosters by team_id - RULE: Use IDs only, never names
                const homeRoster = [], awayRoster = [];
                allPlayersSnap.forEach(d => {
                    const player = { id: d.id, ...d.data() };
                    if (player.team_id === homeTeamId) homeRoster.push(player);
                    else if (player.team_id === awayTeamId) awayRoster.push(player);
                });
                homeRoster.sort((a, b) => (a.position || 99) - (b.position || 99));
                awayRoster.sort((a, b) => (a.position || 99) - (b.position || 99));

                // Fetch stats by player ID - RULE: ONE SOURCE (stats/{playerId})
                const playerStats = {};
                const playerIds = [...homeRoster, ...awayRoster].map(p => p.id).filter(Boolean);
                await Promise.all(playerIds.map(async (playerId) => {
                    try {
                        const statsDoc = await getDoc(doc(db, 'leagues', leagueId, 'stats', playerId));
                        if (statsDoc.exists()) {
                            playerStats[playerId] = statsDoc.data();
                        }
                    } catch (e) {
                        // Stats unavailable for player
                    }
                }));

                // Calculate team averages
                const calcTeam3DA = (roster) => {
                    const avgs = roster.map(p => get3DA(playerStats[p.id] || {}) || 0).filter(v => v > 0);
                    return avgs.length ? avgs.reduce((a, b) => a + b, 0) / avgs.length : null;
                };
                const calcTeamMPR = (roster) => {
                    const mprs = roster.map(p => getMPR(playerStats[p.id] || {}) || 0).filter(v => v > 0);
                    return mprs.length ? mprs.reduce((a, b) => a + b, 0) / mprs.length : null;
                };
                const homeTeam3DA = calcTeam3DA(homeRoster);
                const awayTeam3DA = calcTeam3DA(awayRoster);
                const homeTeamMPR = calcTeamMPR(homeRoster);
                const awayTeamMPR = calcTeamMPR(awayRoster);

                // Determine user's side
                const userIsHome = event.userTeamId ? (event.userTeamId === homeTeamId) : (event.subtitle?.startsWith('vs'));
                const leftTeam = userIsHome ? homeTeam : awayTeam;
                const rightTeam = userIsHome ? awayTeam : homeTeam;
                const leftRecord = userIsHome ? homeRecord : awayRecord;
                const rightRecord = userIsHome ? awayRecord : homeRecord;
                const leftTeam3DA = userIsHome ? homeTeam3DA : awayTeam3DA;
                const rightTeam3DA = userIsHome ? awayTeam3DA : homeTeam3DA;
                const leftTeamMPR = userIsHome ? homeTeamMPR : awayTeamMPR;
                const rightTeamMPR = userIsHome ? awayTeamMPR : homeTeamMPR;
                const leftStanding = userIsHome ? homeStanding : awayStanding;
                const rightStanding = userIsHome ? awayStanding : homeStanding;

                const isCompleted = matchStatus === 'completed';
                const leftScore = userIsHome ? homeScore : awayScore;
                const rightScore = userIsHome ? awayScore : homeScore;
                const leftWon = isCompleted && leftScore > rightScore;
                const rightWon = isCompleted && rightScore > leftScore;

                const compareValues = (leftVal, rightVal) => {
                    if (!leftVal || !rightVal) return { left: '', right: '' };
                    if (Math.abs(leftVal - rightVal) < 0.1) return { left: '', right: '' };
                    return leftVal > rightVal ? { left: 'better', right: 'worse' } : { left: 'worse', right: 'better' };
                };

                const team3DACompare = compareValues(leftTeam3DA, rightTeam3DA);
                const teamMPRCompare = compareValues(leftTeamMPR, rightTeamMPR);

                const left3DADisplay = leftTeam3DA ? leftTeam3DA.toFixed(1) : '-';
                const right3DADisplay = rightTeam3DA ? rightTeam3DA.toFixed(1) : '-';
                const leftMPRDisplay = leftTeamMPR ? leftTeamMPR.toFixed(2) : '-';
                const rightMPRDisplay = rightTeamMPR ? rightTeamMPR.toFixed(2) : '-';

                const buildTeamAvgHtml = (da, mpr, daClass, mprClass) => {
                    if (!da && !mpr) return '';
                    return `<div class="match-team-avg"><span class="${daClass}">${da}</span> / <span class="${mprClass}">${mpr}</span></div>`;
                };

                const winnerStar = '<span class="winner-star">‚òÖ</span>';

                // Simplified structure: Header + collapsed footer (More Info), body hidden
                // On expand: shows roster + full footer with all buttons
                cardEl.innerHTML = `
                    <div class="match-card-header${isCompleted ? ' completed' : ''}">
                        <div class="match-team-side left${leftWon ? ' winner' : ''}">
                            <div class="match-team-info-row"><span class="match-team-name">${getTeamName(leftTeam)}</span>${leftStanding ? `<span class="match-team-standing">${getOrdinal(leftStanding)}</span>` : ''}<span class="match-team-record">${leftRecord}</span></div>
                            ${buildTeamAvgHtml(left3DADisplay, leftMPRDisplay, team3DACompare.left, teamMPRCompare.left)}
                            ${isCompleted ? `<div class="match-header-score${leftWon ? ' winner' : ''}">${leftScore}</div>` : ''}
                        </div>
                        <div class="match-center">
                            <div class="match-week">WEEK ${week || '?'}${totalWeeks ? '/' + totalWeeks : ''}</div>
                            <div class="match-vs">${isCompleted ? 'FINAL' : 'VS'}</div>
                        </div>
                        <div class="match-team-side right${rightWon ? ' winner' : ''}">
                            ${isCompleted ? `<div class="match-header-score${rightWon ? ' winner' : ''}">${rightScore}</div>` : ''}
                            <div class="match-team-info-row"><span class="match-team-record">${rightRecord}</span>${rightStanding ? `<span class="match-team-standing">${getOrdinal(rightStanding)}</span>` : ''}<span class="match-team-name">${getTeamName(rightTeam)}</span></div>
                            ${buildTeamAvgHtml(right3DADisplay, rightMPRDisplay, team3DACompare.right, teamMPRCompare.right)}
                            ${isCompleted && rightWon ? winnerStar : ''}
                        </div>
                    </div>
                    <div class="match-card-footer events-collapsed" id="eventsFooter${idx}">
                        ${isCompleted
                            ? `<a href="/pages/match-report.html?league_id=${leagueId}&match_id=${matchId}" class="match-card-link" style="margin: 0 auto;">View Report ‚Üí</a>`
                            : `<a href="/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}" class="match-card-link" style="margin: 0 auto;">Match Hub ‚Üí</a>`
                        }
                    </div>
                `;

                // Store data
                cardEl.dataset.loaded = 'true';
                cardEl.dataset.leagueId = leagueId;
                cardEl.dataset.matchId = matchId;
                cardEl.dataset.isCompleted = isCompleted ? 'true' : 'false';

            } catch (error) {
                console.error('Error loading events match card:', error);
                cardEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">Error loading match</div>';
            }
        }

        // Toggle expand/collapse for events match card
        window.toggleEventsMatchCard = async function(idx, leagueId, matchId) {
            const bodyEl = document.getElementById(`eventsMatchCardBody${idx}`);
            const footerEl = document.getElementById(`eventsFooter${idx}`);
            const btnEl = document.getElementById(`expandBtn${idx}`);
            const cardEl = document.getElementById(`eventsMatchCard${idx}`);

            if (!bodyEl || !footerEl || !btnEl) return;

            const isExpanded = bodyEl.style.display !== 'none';
            const isCompleted = cardEl?.dataset?.isCompleted === 'true';
            const matchLink = isCompleted
                ? `/pages/match-report.html?league_id=${leagueId}&match_id=${matchId}`
                : `/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}`;
            const matchLinkText = isCompleted ? 'View Report' : 'Match Hub';

            if (isExpanded) {
                // Collapse - switch back to simple footer
                bodyEl.style.display = 'none';
                footerEl.className = 'match-card-footer events-collapsed';
                footerEl.innerHTML = `
                    <button class="more-info-btn" id="expandBtn${idx}" onclick="toggleEventsMatchCard(${idx}, '${leagueId}', '${matchId}')">
                        <span class="expand-icon">‚ñº</span> More Info
                    </button>
                `;
            } else {
                // Expand - load roster and show full footer with buttons
                if (!bodyEl.dataset.loaded) {
                    bodyEl.innerHTML = '<div style="padding: 15px; text-align: center; color: var(--text-dim);">Loading roster...</div>';
                    bodyEl.style.display = 'block';

                    // Load the full roster content
                    await loadEventsMatchCardRoster(idx, leagueId, matchId);
                    bodyEl.dataset.loaded = 'true';
                } else {
                    bodyEl.style.display = 'block';
                }

                // Switch to expanded footer with links only (availability managed via modal)
                footerEl.className = 'match-card-footer events-expanded-wrapper';
                footerEl.innerHTML = `
                    <div class="events-expanded-buttons centered">
                        <span class="match-card-link" onclick="goToEvent('league', '${leagueId}')">League Hub</span>
                        <a href="${matchLink}" class="match-card-link">${matchLinkText}</a>
                    </div>
                    <button class="more-info-btn expanded" onclick="toggleEventsMatchCard(${idx}, '${leagueId}', '${matchId}')">
                        <span class="expand-icon">‚ñ≤</span> Collapse
                    </button>
                `;
            }
        };

        // Load roster content for events match card
        async function loadEventsMatchCardRoster(idx, leagueId, matchId) {
            const bodyEl = document.getElementById(`eventsMatchCardBody${idx}`);
            if (!bodyEl) return;

            try {
                const matchDoc = await getDoc(doc(db, 'leagues', leagueId, 'matches', matchId));
                const matchData = matchDoc.data() || {};
                const homeTeamId = matchData.home_team_id;
                const awayTeamId = matchData.away_team_id;

                const allPlayersSnap = await getDocs(collection(db, 'leagues', leagueId, 'players'));

                // Build rosters by team_id - RULE: Use IDs only, never names
                const homeRoster = [], awayRoster = [];
                allPlayersSnap.forEach(d => {
                    const player = { id: d.id, ...d.data() };
                    if (player.team_id === homeTeamId) homeRoster.push(player);
                    else if (player.team_id === awayTeamId) awayRoster.push(player);
                });
                homeRoster.sort((a, b) => (a.position || 99) - (b.position || 99));
                awayRoster.sort((a, b) => (a.position || 99) - (b.position || 99));

                // RULE: Always use team roster with player IDs - don't use games array for identity
                const homeDisplayRoster = homeRoster;
                const awayDisplayRoster = awayRoster;

                // Fetch stats by player ID - RULE: ONE SOURCE (stats/{playerId})
                const playerStats = {};
                const playerIds = [...homeDisplayRoster, ...awayDisplayRoster].map(p => p.id).filter(Boolean);
                await Promise.all(playerIds.map(async (playerId) => {
                    try {
                        const statsDoc = await getDoc(doc(db, 'leagues', leagueId, 'stats', playerId));
                        if (statsDoc.exists()) {
                            playerStats[playerId] = statsDoc.data();
                        }
                    } catch (e) {
                        // Stats unavailable for player
                    }
                }));

                // Build roster rows (simplified - same as main loadMatchCard)
                const compareValues = (leftVal, rightVal) => {
                    if (!leftVal || !rightVal) return { left: '', right: '' };
                    if (Math.abs(leftVal - rightVal) < 0.1) return { left: '', right: '' };
                    return leftVal > rightVal ? { left: 'better', right: 'worse' } : { left: 'worse', right: 'better' };
                };

                const maxPlayers = Math.max(homeDisplayRoster.length, awayDisplayRoster.length, 3);
                let rosterRows = '';
                for (let i = 0; i < maxPlayers; i++) {
                    const leftPlayer = homeDisplayRoster[i];
                    const rightPlayer = awayDisplayRoster[i];
                    const leftName = leftPlayer ? getPlayerName(leftPlayer) : '';
                    const rightName = rightPlayer ? getPlayerName(rightPlayer) : '';
                    const leftPlayerStats = leftPlayer ? playerStats[leftPlayer.id] || {} : {};
                    const rightPlayerStats = rightPlayer ? playerStats[rightPlayer.id] || {} : {};
                    const leftCaptain = leftPlayer && (leftPlayer.is_captain || leftPlayer.position === 1);
                    const rightCaptain = rightPlayer && (rightPlayer.is_captain || rightPlayer.position === 1);
                    const leftFillIn = leftPlayer && leftPlayer.isFillIn;
                    const rightFillIn = rightPlayer && rightPlayer.isFillIn;

                    const left3DA = get3DA(leftPlayerStats);
                    const right3DA = get3DA(rightPlayerStats);
                    const leftMPR = getMPR(leftPlayerStats);
                    const rightMPR = getMPR(rightPlayerStats);

                    const daCompare = (leftPlayer && rightPlayer) ? compareValues(left3DA, right3DA) : { left: '', right: '' };
                    const mprCompare = (leftPlayer && rightPlayer) ? compareValues(leftMPR, rightMPR) : { left: '', right: '' };

                    const left3DAStr = left3DA != null ? left3DA.toFixed(1) : '-';
                    const leftMPRStr = leftMPR != null ? leftMPR.toFixed(2) : '-';
                    const right3DAStr = right3DA != null ? right3DA.toFixed(1) : '-';
                    const rightMPRStr = rightMPR != null ? rightMPR.toFixed(2) : '-';

                    rosterRows += `
                        <div class="match-player-row">
                            <div class="match-player-cell left">
                                ${leftPlayer ? `
                                    <span class="match-player-name${leftCaptain ? ' captain' : ''}${leftFillIn ? ' fill-in' : ''}">
                                        ${leftCaptain ? 'üëë ' : ''}${leftFillIn ? '<span class="fill-in-badge">SUB</span>' : ''}${leftName}
                                    </span>
                                    <span class="match-player-stats">
                                        <span class="${daCompare.left}">${left3DAStr}</span> / <span class="${mprCompare.left}">${leftMPRStr}</span>
                                    </span>
                                ` : ''}
                            </div>
                            <div class="match-player-cell right">
                                ${rightPlayer ? `
                                    <span class="match-player-stats">
                                        <span class="${daCompare.right}">${right3DAStr}</span> / <span class="${mprCompare.right}">${rightMPRStr}</span>
                                    </span>
                                    <span class="match-player-name${rightCaptain ? ' captain' : ''}${rightFillIn ? ' fill-in' : ''}">
                                        ${rightName}${rightFillIn ? '<span class="fill-in-badge">SUB</span>' : ''}${rightCaptain ? ' üëë' : ''}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }

                bodyEl.innerHTML = rosterRows;

            } catch (error) {
                console.error('Error loading roster:', error);
                bodyEl.innerHTML = '<div style="padding: 15px; text-align: center; color: var(--danger);">Error loading roster</div>';
            }
        }

        // Load tournament card (shared by single day view and events list)
        async function loadTournamentCardContent(idx, tournamentId, idPrefix = 'tournamentCard') {
            const cardEl = document.getElementById(`${idPrefix}${idx}`);
            if (!cardEl) return;

            try {
                // Fetch tournament data
                const tDoc = await getDoc(doc(db, 'tournaments', tournamentId));
                if (!tDoc.exists()) {
                    cardEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">Tournament not found</div>';
                    return;
                }

                const tData = tDoc.data();
                const tournamentName = tData.tournament_name || tData.name || 'Tournament';
                const venueName = tData.venue_name || tData.location || '';
                const tournamentDate = tData.date ? new Date(tData.date + 'T12:00:00').toLocaleDateString('en-US', {
                    weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
                }) : 'Date TBD';
                const events = tData.events || [];
                const status = tData.status || 'upcoming';

                // Get user's registration
                let userRegistration = null;
                let registeredEventIds = [];
                if (currentPlayer) {
                    const regSnap = await getDocs(query(
                        collection(db, 'tournaments', tournamentId, 'registrations'),
                        where('player_id', '==', currentPlayer.id)
                    ));
                    if (!regSnap.empty) {
                        userRegistration = regSnap.docs[0].data();
                        registeredEventIds = userRegistration.event_ids || [];
                    }
                }

                // Get registration counts for each event
                const allRegsSnap = await getDocs(collection(db, 'tournaments', tournamentId, 'registrations'));
                const regsByEvent = {};
                let totalRegistrations = 0;
                allRegsSnap.forEach(rDoc => {
                    totalRegistrations++;
                    const r = rDoc.data();
                    const eventIds = r.event_ids || [];
                    eventIds.forEach(eid => {
                        regsByEvent[eid] = (regsByEvent[eid] || 0) + 1;
                    });
                });

                // Build events list
                const eventsHtml = events.length > 0 ? events.map(e => {
                    const signups = regsByEvent[e.id] || 0;
                    const isRegistered = registeredEventIds.includes(e.id);
                    return `
                        <div class="tournament-card-event ${isRegistered ? 'registered' : ''}">
                            <div class="tournament-card-event-name">
                                ${isRegistered ? '<span class="registered-check">‚úì</span>' : ''}
                                ${e.name || 'Event'}
                            </div>
                            <div class="tournament-card-event-info">
                                <span class="tournament-card-event-time">${e.time || ''}</span>
                                <span class="tournament-card-event-signups">${signups} players</span>
                            </div>
                        </div>
                    `;
                }).join('') : '<div style="padding: 10px; text-align: center; color: var(--text-dim);">No events listed</div>';

                // Determine status display
                const isCompleted = status === 'completed';
                const isLive = status === 'in_progress' || status === 'live';
                const statusBadge = isCompleted ? '<span class="tournament-status-badge completed">COMPLETED</span>' :
                                    isLive ? '<span class="tournament-status-badge live">LIVE</span>' :
                                    '<span class="tournament-status-badge upcoming">UPCOMING</span>';

                cardEl.innerHTML = `
                    <div class="tournament-card-header">
                        <div class="tournament-card-title-section">
                            <div class="tournament-card-name">${tournamentName}</div>
                            <div class="tournament-card-venue">${venueName}</div>
                        </div>
                        <div class="tournament-card-info-section">
                            <div class="tournament-card-date">${tournamentDate}</div>
                            ${statusBadge}
                        </div>
                    </div>
                    <div class="tournament-card-stats">
                        <div class="tournament-card-stat">
                            <span class="stat-value">${totalRegistrations}</span>
                            <span class="stat-label">Registered</span>
                        </div>
                        <div class="tournament-card-stat">
                            <span class="stat-value">${events.length}</span>
                            <span class="stat-label">Events</span>
                        </div>
                        <div class="tournament-card-stat">
                            <span class="stat-value">${registeredEventIds.length}</span>
                            <span class="stat-label">Your Events</span>
                        </div>
                    </div>
                    <div class="tournament-card-events">
                        ${eventsHtml}
                    </div>
                    <div class="match-card-footer">
                        <div></div>
                        <span class="match-card-link" onclick="goToEvent('tournament', '${tournamentId}')">View Tournament</span>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading tournament card:', error);
                cardEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">Error loading tournament</div>';
            }
        }

        // Load tournament card for single day view
        function loadTournamentCard(idx, event) {
            const tournamentId = event.tournamentId;
            loadTournamentCardContent(idx, tournamentId, 'tournamentCard');
        }

        // Load tournament card for events list view
        function loadEventsTournamentCard(idx, event) {
            const tournamentId = event.id;
            loadTournamentCardContent(idx, tournamentId, 'eventsTournamentCard');
        }

        // Render deadline card (for All Events)
        function renderDeadlineCard(event, idx, type) {
            const deadlineDate = new Date(event.deadline);
            const deadlineStr = deadlineDate.toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric'
            });
            const daysLeft = Math.ceil((deadlineDate - new Date()) / (1000 * 60 * 60 * 24));
            const urgency = daysLeft <= 3 ? 'urgent' : daysLeft <= 7 ? 'soon' : '';

            return `
                <div class="event-card-collapsible deadline-card event-${type} ${urgency}" id="eventCard${idx}">
                    <div class="event-card-header" onclick="goToEvent('${type}', '${event.id}')">
                        <span class="event-card-type-badge ${type}">Registration</span>
                        <div class="event-card-summary">
                            <span class="event-card-title">${event.name}</span>
                        </div>
                        <div class="deadline-info">
                            <span class="deadline-date">${deadlineStr}</span>
                            <span class="deadline-countdown ${urgency}">${daysLeft} day${daysLeft !== 1 ? 's' : ''} left</span>
                        </div>
                    </div>
                </div>`;
        }

        // Render info card (for All Events - leagues/tournaments without clicking into details)
        function renderInfoCard(event, idx, type) {
            const statusBadge = event.status === 'active'
                ? '<span class="status-dot active"></span>'
                : '<span class="status-dot"></span>';
            const dateStr = event.date ? new Date(event.date).toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric'
            }) : '';

            return `
                <div class="event-card-collapsible info-card event-${type}" id="eventCard${idx}">
                    <div class="event-card-header" onclick="goToEvent('${type}', '${event.id}')">
                        <span class="event-card-type-badge ${type}">${type === 'league' ? 'League' : 'Tournament'}</span>
                        <div class="event-card-summary">
                            <span class="event-card-title">${event.name}</span>
                            ${statusBadge}
                        </div>
                        <span class="event-card-date">${dateStr || event.season || event.location || ''}</span>
                    </div>
                </div>`;
        }

        function renderTournamentCard(event, idx) {
            // Use same match card format as league matches - placeholder that gets populated
            return `<div class="match-card event-tournament" id="eventsTournamentCard${idx}"
                         data-tournament-id="${event.id}" data-tournament-name="${event.name}"
                         data-date="${event.date || ''}" data-location="${event.location || ''}">
                <div style="padding: 20px; text-align: center; color: var(--text-dim);">Loading tournament...</div>
            </div>`;
        }

        // Toggle for match event cards - loads full match card content
        window.toggleMatchEventCard = async function(idx, leagueId, matchId) {
            const card = document.getElementById(`eventCard${idx}`);
            const body = document.getElementById(`eventCardBody${idx}`);
            const isExpanded = card.classList.contains('expanded');

            if (isExpanded) {
                card.classList.remove('expanded');
                return;
            }

            card.classList.add('expanded');

            // Load content if not already loaded
            if (body.dataset.loaded) return;

            try {
                await loadMatchEventCardContent(body, leagueId, matchId);
                body.dataset.loaded = 'true';
            } catch (error) {
                console.error('Error loading match card content:', error);
                body.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">Error loading match details</div>';
            }
        };

        window.toggleEventCard = async function(idx, type, id) {
            const card = document.getElementById(`eventCard${idx}`);
            const body = document.getElementById(`eventCardBody${idx}`);
            const isExpanded = card.classList.contains('expanded');

            if (isExpanded) {
                card.classList.remove('expanded');
                return;
            }

            card.classList.add('expanded');

            // Load content if not already loaded
            if (body.dataset.loaded) return;

            try {
                if (type === 'tournament') {
                    await loadTournamentCardBodyContent(body, id);
                }
                body.dataset.loaded = 'true';
            } catch (error) {
                console.error('Error loading card content:', error);
                body.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">Error loading details</div>';
            }
        };

        // Load match card content for events view (similar to calendar match card)
        async function loadMatchEventCardContent(body, leagueId, matchId) {
            // Get match data
            const matchDoc = await getDoc(doc(db, 'leagues', leagueId, 'matches', matchId));
            if (!matchDoc.exists()) {
                body.innerHTML = '<div style="padding: 20px; text-align: center;">Match not found</div>';
                return;
            }

            const matchData = matchDoc.data();
            const homeTeamId = matchData.home_team_id;
            const awayTeamId = matchData.away_team_id;
            const matchStatus = matchData.status || 'scheduled';
            const homeScore = matchData.home_score || 0;
            const awayScore = matchData.away_score || 0;
            const matchWinner = matchData.winner;

            // Find user's team
            const userTeam = allTeams.find(t => (t.id || t.league_id) === leagueId);
            const userTeamId = userTeam?.team_id || userTeam?.teamId;
            const userIsHome = userTeamId === homeTeamId;

            // Fetch teams, players, and all matches for standings
            const [homeTeamDoc, awayTeamDoc, allPlayersSnap, allMatchesSnap] = await Promise.all([
                getDoc(doc(db, 'leagues', leagueId, 'teams', homeTeamId)),
                getDoc(doc(db, 'leagues', leagueId, 'teams', awayTeamId)),
                getDocs(collection(db, 'leagues', leagueId, 'players')),
                getDocs(collection(db, 'leagues', leagueId, 'matches'))
            ]);

            const homeTeam = homeTeamDoc.data() || {};
            const awayTeam = awayTeamDoc.data() || {};

            // Calculate standings from completed matches
            const teamRecords = {};
            let totalWeeks = 0;
            allMatchesSnap.forEach(doc => {
                const m = doc.data();
                if (m.week && m.week > totalWeeks) totalWeeks = m.week;
                if (m.status !== 'completed') return;
                if (!teamRecords[m.home_team_id]) teamRecords[m.home_team_id] = { wins: 0, losses: 0, ties: 0 };
                if (!teamRecords[m.away_team_id]) teamRecords[m.away_team_id] = { wins: 0, losses: 0, ties: 0 };
                if (m.home_score > m.away_score) {
                    teamRecords[m.home_team_id].wins++;
                    teamRecords[m.away_team_id].losses++;
                } else if (m.away_score > m.home_score) {
                    teamRecords[m.away_team_id].wins++;
                    teamRecords[m.home_team_id].losses++;
                } else {
                    teamRecords[m.home_team_id].ties++;
                    teamRecords[m.away_team_id].ties++;
                }
            });

            // Build rosters by team_id - RULE: Use IDs only, never names
            const homeRoster = [];
            const awayRoster = [];
            allPlayersSnap.forEach(d => {
                const player = { id: d.id, ...d.data() };
                if (player.team_id === homeTeamId) homeRoster.push(player);
                else if (player.team_id === awayTeamId) awayRoster.push(player);
            });
            homeRoster.sort((a, b) => (a.position || 99) - (b.position || 99));
            awayRoster.sort((a, b) => (a.position || 99) - (b.position || 99));

            // RULE: Always use team roster with player IDs - don't use games array for identity
            const homeDisplayRoster = homeRoster;
            const awayDisplayRoster = awayRoster;

            // Fetch stats by player ID - RULE: ONE SOURCE (stats/{playerId})
            const playerStats = {};
            const playerIds = [...homeDisplayRoster, ...awayDisplayRoster].map(p => p.id).filter(Boolean);
            await Promise.all(playerIds.map(async (playerId) => {
                try {
                    const statsDoc = await getDoc(doc(db, 'leagues', leagueId, 'stats', playerId));
                    if (statsDoc.exists()) {
                        playerStats[playerId] = statsDoc.data();
                    }
                } catch (e) { }
            }));

            // Calculate team records and standings
            const homeRec = teamRecords[homeTeamId] || { wins: 0, losses: 0, ties: 0 };
            const awayRec = teamRecords[awayTeamId] || { wins: 0, losses: 0, ties: 0 };
            const homeRecord = getTeamRecord(homeRec);
            const awayRecord = getTeamRecord(awayRec);

            // Calculate standings
            const standings = Object.entries(teamRecords)
                .map(([id, rec]) => ({ id, ...rec, points: rec.wins * 2 + rec.ties }))
                .sort((a, b) => b.points - a.points || b.wins - a.wins);
            const homeStanding = standings.findIndex(t => t.id === homeTeamId) + 1;
            const awayStanding = standings.findIndex(t => t.id === awayTeamId) + 1;

            // Calculate team averages
            const calcTeam3DA = (roster) => {
                const vals = roster.map(p => get3DA(playerStats[p.id])).filter(v => v != null);
                return vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : null;
            };
            const calcTeamMPR = (roster) => {
                const vals = roster.map(p => getMPR(playerStats[p.id])).filter(v => v != null);
                return vals.length > 0 ? vals.reduce((a, b) => a + b, 0) / vals.length : null;
            };

            const homeTeam3DA = calcTeam3DA(homeDisplayRoster);
            const awayTeam3DA = calcTeam3DA(awayDisplayRoster);
            const homeTeamMPR = calcTeamMPR(homeDisplayRoster);
            const awayTeamMPR = calcTeamMPR(awayDisplayRoster);

            // Compare values helper
            const compareValues = (leftVal, rightVal) => {
                if (!leftVal || !rightVal) return { left: '', right: '' };
                if (Math.abs(leftVal - rightVal) < 0.1) return { left: '', right: '' };
                return leftVal > rightVal
                    ? { left: 'better', right: 'worse' }
                    : { left: 'worse', right: 'better' };
            };

            // Determine left/right based on user's team position
            const leftTeam = userIsHome ? homeTeam : awayTeam;
            const rightTeam = userIsHome ? awayTeam : homeTeam;
            const leftRoster = userIsHome ? homeDisplayRoster : awayDisplayRoster;
            const rightRoster = userIsHome ? awayDisplayRoster : homeDisplayRoster;
            const leftRec = userIsHome ? homeRec : awayRec;
            const rightRec = userIsHome ? awayRec : homeRec;
            const leftStanding = userIsHome ? homeStanding : awayStanding;
            const rightStanding = userIsHome ? awayStanding : homeStanding;
            const leftRecord = userIsHome ? homeRecord : awayRecord;
            const rightRecord = userIsHome ? awayRecord : homeRecord;
            const leftScore = userIsHome ? homeScore : awayScore;
            const rightScore = userIsHome ? awayScore : homeScore;
            const leftWon = matchWinner && ((userIsHome && matchWinner === 'home') || (!userIsHome && matchWinner === 'away'));
            const rightWon = matchWinner && ((userIsHome && matchWinner === 'away') || (!userIsHome && matchWinner === 'home'));
            const left3DA = userIsHome ? homeTeam3DA : awayTeam3DA;
            const right3DA = userIsHome ? awayTeam3DA : homeTeam3DA;
            const leftMPR = userIsHome ? homeTeamMPR : awayTeamMPR;
            const rightMPR = userIsHome ? awayTeamMPR : homeTeamMPR;

            const team3DACompare = compareValues(left3DA, right3DA);
            const teamMPRCompare = compareValues(leftMPR, rightMPR);

            const left3DADisplay = left3DA != null ? left3DA.toFixed(1) : '-';
            const right3DADisplay = right3DA != null ? right3DA.toFixed(1) : '-';
            const leftMPRDisplay = leftMPR != null ? leftMPR.toFixed(2) : '-';
            const rightMPRDisplay = rightMPR != null ? rightMPR.toFixed(2) : '-';

            const winnerStar = '<span class="winner-star">‚≠ê</span>';
            const isCompleted = matchStatus === 'completed';

            // Build roster rows
            const maxRows = Math.max(leftRoster.length, rightRoster.length);
            let rosterRows = '';
            for (let i = 0; i < maxRows; i++) {
                const leftPlayer = leftRoster[i];
                const rightPlayer = rightRoster[i];
                const leftStats = leftPlayer ? playerStats[leftPlayer.id] : null;
                const rightStats = rightPlayer ? playerStats[rightPlayer.id] : null;
                const left3da = get3DA(leftStats);
                const right3da = get3DA(rightStats);
                const leftMpr = getMPR(leftStats);
                const rightMpr = getMPR(rightStats);
                const compare3DA = compareValues(left3da, right3da);
                const compareMPR = compareValues(leftMpr, rightMpr);

                const leftFillIn = leftPlayer && leftPlayer.isFillIn;
                const rightFillIn = rightPlayer && rightPlayer.isFillIn;
                const leftNameClass = `match-player-name${leftFillIn ? ' fill-in' : ''}`;
                const rightNameClass = `match-player-name${rightFillIn ? ' fill-in' : ''}`;

                rosterRows += `
                    <div class="match-row">
                        <div class="match-player-cell left">
                            <span class="${leftNameClass}">${leftPlayer ? getPlayerName(leftPlayer) : ''}${leftFillIn ? ' <span class="fill-in-badge">SUB</span>' : ''}</span>
                            <span class="match-player-stats"><span class="${compare3DA.left}">${left3da != null ? left3da.toFixed(1) : '-'}</span> / <span class="${compareMPR.left}">${leftMpr != null ? leftMpr.toFixed(2) : '-'}</span></span>
                        </div>
                        <div class="match-player-cell right">
                            <span class="match-player-stats"><span class="${compare3DA.right}">${right3da != null ? right3da.toFixed(1) : '-'}</span> / <span class="${compareMPR.right}">${rightMpr != null ? rightMpr.toFixed(2) : '-'}</span></span>
                            <span class="${rightNameClass}">${rightFillIn ? '<span class="fill-in-badge">SUB</span> ' : ''}${rightPlayer ? getPlayerName(rightPlayer) : ''}</span>
                        </div>
                    </div>`;
            }

            const buildTeamAvgHtml = (avgDisplay, mprDisplay, avgClass, mprClass) => `
                <div class="match-team-avg">
                    <span class="${avgClass}">${avgDisplay}</span> /
                    <span class="${mprClass}">${mprDisplay}</span>
                </div>`;

            body.innerHTML = `
                <div class="match-card-header${isCompleted ? ' completed' : ''}">
                    <div class="match-team-side left${leftWon ? ' winner' : ''}">
                        ${isCompleted && leftWon ? winnerStar : ''}
                        <div class="match-team-info-row"><span class="match-team-name">${getTeamName(leftTeam)}</span>${leftStanding ? `<span class="match-team-standing">${getOrdinal(leftStanding)}</span>` : ''}<span class="match-team-record">${leftRecord}</span></div>
                        ${buildTeamAvgHtml(left3DADisplay, leftMPRDisplay, team3DACompare.left, teamMPRCompare.left)}
                        ${isCompleted ? `<div class="match-header-score${leftWon ? ' winner' : ''}">${leftScore}</div>` : ''}
                    </div>
                    <div class="match-center">
                        <div class="match-vs">${isCompleted ? 'FINAL' : 'VS'}</div>
                    </div>
                    <div class="match-team-side right${rightWon ? ' winner' : ''}">
                        ${isCompleted ? `<div class="match-header-score${rightWon ? ' winner' : ''}">${rightScore}</div>` : ''}
                        <div class="match-team-info-row"><span class="match-team-record">${rightRecord}</span>${rightStanding ? `<span class="match-team-standing">${getOrdinal(rightStanding)}</span>` : ''}<span class="match-team-name">${getTeamName(rightTeam)}</span></div>
                        ${buildTeamAvgHtml(right3DADisplay, rightMPRDisplay, team3DACompare.right, teamMPRCompare.right)}
                        ${isCompleted && rightWon ? winnerStar : ''}
                    </div>
                </div>
                <div class="match-card-body">
                    ${rosterRows}
                </div>
                <div class="match-card-footer">
                    <div></div>
                    <span class="match-card-link" onclick="goToEvent('league', '${leagueId}')">League Hub</span>
                    <a href="/pages/match-hub.html?league_id=${leagueId}&match_id=${matchId}" class="match-hub-btn">Match Hub</a>
                    <div></div>
                </div>`;
        }

        async function loadLeagueCardContent(body, leagueId) {
            // Find user's team in this league
            const userTeam = allTeams.find(t => t.leagueId === leagueId);

            // Load upcoming matches for user's team
            const matchesSnap = await getDocs(query(
                collection(db, 'leagues', leagueId, 'matches'),
                where('status', '!=', 'completed')
            ));

            let upcomingMatches = [];
            matchesSnap.forEach(mDoc => {
                const m = mDoc.data();
                if (userTeam && (m.home_team_id === userTeam.teamId || m.away_team_id === userTeam.teamId)) {
                    upcomingMatches.push({ id: mDoc.id, ...m });
                }
            });

            // Sort by date/week
            upcomingMatches.sort((a, b) => (a.week || 0) - (b.week || 0));

            if (upcomingMatches.length === 0) {
                body.innerHTML = `
                    <div style="padding: 15px; text-align: center; color: var(--text-dim);">
                        No upcoming matches
                    </div>
                    <div class="event-card-footer">
                        <span class="match-card-link" onclick="goToEvent('league', '${leagueId}')">League Hub</span>
                    </div>`;
                return;
            }

            // Show first 3 upcoming matches
            const matchesHtml = upcomingMatches.slice(0, 3).map(m => `
                <div class="tournament-event-item">
                    <div>
                        <div class="tournament-event-name">Week ${m.week || '?'}</div>
                        <div class="tournament-event-time">${m.date || 'TBD'}</div>
                    </div>
                    <div class="tournament-event-signups">${m.status || 'scheduled'}</div>
                </div>
            `).join('');

            body.innerHTML = `
                <div class="tournament-events-list">
                    ${matchesHtml}
                </div>
                <div class="event-card-footer">
                    <span class="match-card-link" onclick="goToEvent('league', '${leagueId}')">League Hub</span>
                </div>`;
        }

        async function loadTournamentCardBodyContent(body, tournamentId) {
            const tDoc = await getDoc(doc(db, 'tournaments', tournamentId));
            if (!tDoc.exists()) {
                body.innerHTML = '<div style="padding: 20px; text-align: center;">Tournament not found</div>';
                return;
            }

            const tData = tDoc.data();
            const events = tData.events || [];

            if (events.length === 0) {
                body.innerHTML = `
                    <div style="padding: 15px; text-align: center; color: var(--text-dim);">
                        No events scheduled yet
                    </div>
                    <div class="event-card-footer">
                        <span class="match-card-link" onclick="goToEvent('tournament', '${tournamentId}')">View Tournament</span>
                    </div>`;
                return;
            }

            // Get registration counts for each event
            const regSnap = await getDocs(collection(db, 'tournaments', tournamentId, 'registrations'));
            const regsByEvent = {};
            regSnap.forEach(rDoc => {
                const r = rDoc.data();
                const eventIds = r.event_ids || [];
                eventIds.forEach(eid => {
                    regsByEvent[eid] = (regsByEvent[eid] || 0) + 1;
                });
            });

            const eventsHtml = events.map(e => {
                const signups = regsByEvent[e.id] || 0;
                return `
                    <div class="tournament-event-item">
                        <div>
                            <div class="tournament-event-name">${e.name || 'Event'}</div>
                            <div class="tournament-event-time">${e.time || 'TBD'}</div>
                        </div>
                        <div class="tournament-event-signups">${signups} signed up</div>
                    </div>
                `;
            }).join('');

            body.innerHTML = `
                <div class="tournament-events-list">
                    ${eventsHtml}
                </div>
                <div class="event-card-footer">
                    <span class="match-card-link" onclick="goToEvent('tournament', '${tournamentId}')">View Tournament</span>
                </div>`;
        }

        // Initialize events view when schedule tab loads
        function initEventsView() {
            loadEventsView();
        }

        // ============================================================================
        // SETTINGS TAB
        // ============================================================================

        async function populateSettingsForm() {
            if (!currentPlayer) return;

            // Always fetch full player data from Firestore to get all fields
            try {
                const playerDoc = await getDoc(doc(db, 'players', currentPlayer.id));
                if (playerDoc.exists()) {
                    const fullData = playerDoc.data();
                    // Merge additional fields into currentPlayer
                    currentPlayer.phone = fullData.phone || '';
                    currentPlayer.email = fullData.email || '';
                    currentPlayer.first_name = fullData.first_name || currentPlayer.first_name || '';
                    currentPlayer.last_name = fullData.last_name || currentPlayer.last_name || '';
                    currentPlayer.privacy = fullData.privacy || {};
                    currentPlayer.notifications = fullData.notifications || {};
                    currentPlayer.pin = fullData.pin || '';
                    // Profile fields
                    currentPlayer.bio = fullData.bio || '';
                    currentPlayer.home_bar = fullData.home_bar || '';
                    currentPlayer.preferred_game = fullData.preferred_game || '';
                    currentPlayer.dartconnect_id = fullData.dartconnect_id || '';
                }
            } catch (err) {
                // Could not fetch full player data
            }

            // Populate display values - Edit Profile section
            document.getElementById('firstNameValue').textContent = currentPlayer.first_name || '-';
            document.getElementById('lastNameValue').textContent = currentPlayer.last_name || '-';

            const phoneVal = currentPlayer.phone || '';
            const emailVal = currentPlayer.email || '';

            const phoneDisplay = document.getElementById('phoneValue');
            const emailDisplay = document.getElementById('emailValue');

            phoneDisplay.textContent = phoneVal || 'Not set';
            phoneDisplay.classList.toggle('empty', !phoneVal);

            emailDisplay.textContent = emailVal || 'Not set';
            emailDisplay.classList.toggle('empty', !emailVal);

            // Populate edit inputs
            document.getElementById('editFirstName').value = currentPlayer.first_name || '';
            document.getElementById('editLastName').value = currentPlayer.last_name || '';
            document.getElementById('editPhone').value = phoneVal;
            document.getElementById('editEmail').value = emailVal;

            // Profile section
            const bioVal = currentPlayer.bio || '';
            const homeBarVal = currentPlayer.home_bar || '';
            const dartconnectVal = currentPlayer.dartconnect_id || '';

            document.getElementById('bioValue').textContent = bioVal || 'Not set';
            document.getElementById('bioValue').classList.toggle('empty', !bioVal);
            document.getElementById('editBio').value = bioVal;

            document.getElementById('homeBarValue').textContent = homeBarVal || 'Not set';
            document.getElementById('homeBarValue').classList.toggle('empty', !homeBarVal);
            document.getElementById('editHomeBar').value = homeBarVal;

            document.getElementById('preferredGame').value = currentPlayer.preferred_game || '';

            // Integrations section
            document.getElementById('dartconnectValue').textContent = dartconnectVal || 'Not linked';
            document.getElementById('dartconnectValue').classList.toggle('empty', !dartconnectVal);
            document.getElementById('editDartconnect').value = dartconnectVal;

            // Load privacy settings
            loadPrivacySettings();

            // Load notification settings
            loadNotificationSettings();
        }

        function loadPrivacySettings() {
            if (!currentPlayer) return;

            const privacy = currentPlayer.privacy || {};

            // Default: phone/email hidden, stats/messages visible
            const showPhone = privacy.show_phone ?? false;
            const showEmail = privacy.show_email ?? false;
            const showStats = privacy.show_stats ?? true;
            const allowMessages = privacy.allow_messages ?? true;

            document.getElementById('privacyPhone').classList.toggle('on', showPhone);
            document.getElementById('privacyEmail').classList.toggle('on', showEmail);
            document.getElementById('privacyStats').classList.toggle('on', showStats);
            document.getElementById('privacyMessages').classList.toggle('on', allowMessages);
        }

        // Inline field editing
        window.startEditField = function(field) {
            const fieldEl = document.getElementById(`${field}Field`);
            fieldEl.classList.add('editing');

            // Focus the input
            const input = document.getElementById(`edit${field.charAt(0).toUpperCase() + field.slice(1)}`);
            if (input) {
                input.focus();
                input.select();
            }
        };

        window.cancelEditField = function(field) {
            const fieldEl = document.getElementById(`${field}Field`);
            fieldEl.classList.remove('editing');

            // Reset input to original value
            const inputId = `edit${field.charAt(0).toUpperCase() + field.slice(1)}`;
            const input = document.getElementById(inputId);

            if (field === 'lastName') input.value = currentPlayer.last_name || '';
            else if (field === 'phone') input.value = currentPlayer.phone || '';
            else if (field === 'email') input.value = currentPlayer.email || '';
            else if (field === 'bio') input.value = currentPlayer.bio || '';
            else if (field === 'homeBar') input.value = currentPlayer.home_bar || '';
            else if (field === 'dartconnect') input.value = currentPlayer.dartconnect_id || '';
        };

        window.saveField = async function(field) {
            if (!currentPlayer) return;

            const inputId = `edit${field.charAt(0).toUpperCase() + field.slice(1)}`;
            const input = document.getElementById(inputId);
            const newValue = input.value.trim();

            // Validation
            if (field === 'lastName' && !newValue) {
                alert('Last name is required');
                return;
            }

            if (field === 'email' && newValue && !newValue.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            try {
                const updateData = {
                    player_id: currentPlayer.id
                };

                // Map field to API field name
                if (field === 'lastName') {
                    updateData.last_name = newValue;
                    updateData.first_name = currentPlayer.first_name;
                } else if (field === 'phone') {
                    updateData.phone = newValue;
                } else if (field === 'email') {
                    updateData.email = newValue;
                } else if (field === 'bio') {
                    updateData.bio = newValue;
                } else if (field === 'homeBar') {
                    updateData.home_bar = newValue;
                } else if (field === 'dartconnect') {
                    updateData.dartconnect_id = newValue;
                }

                const result = await callFunction('updateGlobalPlayer', updateData);

                if (result.success) {
                    // Update local data and UI
                    if (field === 'lastName') {
                        currentPlayer.last_name = newValue;
                        currentPlayer.name = `${currentPlayer.first_name} ${newValue}`;
                        document.getElementById('welcomeName').textContent = currentPlayer.name;
                        document.getElementById('lastNameValue').textContent = newValue;
                    } else if (field === 'phone') {
                        currentPlayer.phone = newValue;
                        const phoneDisplay = document.getElementById('phoneValue');
                        phoneDisplay.textContent = newValue || 'Not set';
                        phoneDisplay.classList.toggle('empty', !newValue);
                    } else if (field === 'email') {
                        currentPlayer.email = newValue;
                        const emailDisplay = document.getElementById('emailValue');
                        emailDisplay.textContent = newValue || 'Not set';
                        emailDisplay.classList.toggle('empty', !newValue);
                    } else if (field === 'bio') {
                        currentPlayer.bio = newValue;
                        document.getElementById('bioValue').textContent = newValue || 'Not set';
                        document.getElementById('bioValue').classList.toggle('empty', !newValue);
                    } else if (field === 'homeBar') {
                        currentPlayer.home_bar = newValue;
                        document.getElementById('homeBarValue').textContent = newValue || 'Not set';
                        document.getElementById('homeBarValue').classList.toggle('empty', !newValue);
                    } else if (field === 'dartconnect') {
                        currentPlayer.dartconnect_id = newValue;
                        document.getElementById('dartconnectValue').textContent = newValue || 'Not linked';
                        document.getElementById('dartconnectValue').classList.toggle('empty', !newValue);
                    }

                    // Update session storage for name fields
                    if (field === 'lastName') {
                        const session = JSON.parse(localStorage.getItem('brdc_session') || '{}');
                        session.last_name = newValue;
                        session.name = currentPlayer.name;
                        localStorage.setItem('brdc_session', JSON.stringify(session));
                    }

                    // Exit edit mode
                    document.getElementById(`${field}Field`).classList.remove('editing');
                } else {
                    alert(result.error || 'Failed to update');
                }
            } catch (error) {
                console.error('Error saving field:', error);
                alert('Error saving changes');
            }
        };

        // Privacy toggle
        window.togglePrivacy = async function(setting) {
            if (!currentPlayer) return;

            const toggleEl = document.getElementById(`privacy${setting.split('_').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('')}`);
            const currentValue = toggleEl.classList.contains('on');
            const newValue = !currentValue;

            // Optimistic UI update
            toggleEl.classList.toggle('on', newValue);

            try {
                // Update privacy settings via updateGlobalPlayer
                const privacy = { ...(currentPlayer.privacy || {}) };
                privacy[setting] = newValue;

                const result = await callFunction('updateGlobalPlayer', {
                    player_id: currentPlayer.id,
                    privacy: privacy
                });

                if (result.success) {
                    currentPlayer.privacy = privacy;
                } else {
                    // Revert on failure
                    toggleEl.classList.toggle('on', currentValue);
                    alert(result.error || 'Failed to update privacy setting');
                }
            } catch (error) {
                console.error('Error updating privacy:', error);
                // Revert on error
                toggleEl.classList.toggle('on', currentValue);
                alert('Error updating privacy setting');
            }
        };

        // Save preferred game dropdown
        window.savePreferredGame = async function() {
            if (!currentPlayer) return;
            const newValue = document.getElementById('preferredGame').value;

            try {
                const result = await callFunction('updateGlobalPlayer', {
                    player_id: currentPlayer.id,
                    preferred_game: newValue
                });

                if (result.success) {
                    currentPlayer.preferred_game = newValue;
                }
            } catch (error) {
                console.error('Error saving preferred game:', error);
            }
        };

        // PIN visibility toggle
        let pinVisible = false;
        window.togglePinVisibility = function() {
            pinVisible = !pinVisible;
            const display = document.getElementById('currentPinDisplay');
            const btn = document.getElementById('showPinBtn');

            if (pinVisible) {
                display.textContent = currentPlayer.pin || 'Unknown';
                btn.textContent = 'Hide';
            } else {
                display.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                btn.textContent = 'Show';
            }
        };

        // Generate new PIN
        window.generateNewPin = async function() {
            if (!currentPlayer) return;

            if (!confirm('Generate a new PIN? Your old PIN will stop working immediately.')) {
                return;
            }

            try {
                const result = await callFunction('generateNewPin', {
                    player_id: currentPlayer.id
                });

                if (result.success && result.new_pin) {
                    currentPlayer.pin = result.new_pin;
                    alert(`Your new PIN is: ${result.new_pin}\n\nPlease save this somewhere safe!`);

                    // Update session
                    const session = JSON.parse(localStorage.getItem('brdc_session') || '{}');
                    session.pin = result.new_pin;
                    localStorage.setItem('brdc_session', JSON.stringify(session));

                    // Show new PIN
                    pinVisible = true;
                    document.getElementById('currentPinDisplay').textContent = result.new_pin;
                    document.getElementById('showPinBtn').textContent = 'Hide';
                } else {
                    alert(result.error || 'Failed to generate new PIN');
                }
            } catch (error) {
                console.error('Error generating PIN:', error);
                alert('Error generating new PIN');
            }
        };

        // Export player data
        window.exportMyData = async function() {
            if (!currentPlayer) return;

            try {
                // Fetch full player data
                const playerDoc = await getDoc(doc(db, 'players', currentPlayer.id));
                if (!playerDoc.exists()) {
                    alert('Could not find player data');
                    return;
                }

                const data = {
                    profile: playerDoc.data(),
                    exported_at: new Date().toISOString()
                };

                // Remove sensitive fields
                delete data.profile.pin;

                // Create download
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `brdc-player-data-${currentPlayer.id}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data');
            }
        };

        // Delete account confirmation
        window.confirmDeleteAccount = async function() {
            if (!currentPlayer) return;

            const confirmed = prompt(
                'This will permanently delete your account and all data.\n\n' +
                'Type "DELETE" to confirm:'
            );

            if (confirmed !== 'DELETE') {
                if (confirmed !== null) {
                    alert('Account deletion cancelled. You must type "DELETE" exactly.');
                }
                return;
            }

            try {
                const result = await callFunction('deletePlayerAccount', {
                    player_id: currentPlayer.id,
                    confirmation: 'DELETE'
                });

                if (result.success) {
                    alert('Your account has been deleted.');
                    localStorage.removeItem('brdc_session');
                    window.location.href = '/';
                } else {
                    alert(result.error || 'Failed to delete account');
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('Error deleting account. Please contact support.');
            }
        };

        // ============================================================================
        // LEAGUES TAB
        // ============================================================================

        // Leagues tab data
        let leaguesLoaded = false;

        async function loadLeaguesTab() {
            const container = document.getElementById('leaguesContent');
            if (!currentPlayer) {
                container.innerHTML = '<div class="empty-state">Please log in to view leagues</div>';
                return;
            }

            try {
                // Use allTeams which is already loaded (from roles.playing)
                if (!allTeams || allTeams.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 48px; margin-bottom: 15px;">üèÜ</div>
                            <div>No leagues found</div>
                            <div style="font-size: 12px; margin-top: 8px; color: #666;">Join a league to see your teammates here</div>
                        </div>
                    `;
                    leaguesLoaded = true;
                    return;
                }

                let html = '<div class="team-cards-grid">';

                for (const team of allTeams) {
                    // roles.playing uses: id (league), name (league), team_id, team_name
                    const leagueId = team.id || team.league_id;
                    const leagueName = team.name || team.league_name || 'League';
                    const teamId = team.team_id;  // This is the correct field from roles.playing
                    const teamName = team.team_name || 'My Team';
                    const isPast = team.status === 'completed';

                    // Get team record if we have a team_id
                    let wins = 0, losses = 0;
                    if (teamId) {
                        try {
                            const teamDoc = await getDoc(doc(db, 'leagues', leagueId, 'teams', teamId));
                            if (teamDoc.exists()) {
                                const teamData = teamDoc.data();
                                wins = teamData.wins || 0;
                                losses = teamData.losses || 0;
                            }
                        } catch (e) { /* ignore */ }
                    }

                    // Only link to league-team if we have a team_id, otherwise link to league-view
                    const linkUrl = teamId
                        ? `/pages/league-team.html?league_id=${leagueId}&team_id=${teamId}`
                        : `/pages/league-view.html?league_id=${leagueId}`;

                    html += `
                        <div class="team-card ${isPast ? 'past' : ''}" onclick="navigateTo('${linkUrl}', event)" style="cursor: pointer;">
                            <div class="team-card-league">${leagueName}</div>
                            <div class="team-card-name">${teamName}</div>
                            <div class="team-card-record">${wins} - ${losses}</div>
                            <div class="team-card-arrow">‚Üí</div>
                        </div>
                    `;
                }

                html += '</div>';
                container.innerHTML = html;
                leaguesLoaded = true;
            } catch (error) {
                console.error('Error loading leagues tab:', error);
                container.innerHTML = '<div class="empty-state">Error loading leagues</div>';
            }
        }

        // ============================================================================
        // MATCH HISTORY TAB
        // ============================================================================

        let historyLoaded = false;
        let matchHistoryData = [];

        async function loadMatchHistory() {
            const container = document.getElementById('matchHistoryContent');
            const leagueFilter = document.getElementById('historyLeagueFilter');

            if (!currentPlayer) {
                container.innerHTML = '<div class="empty-state">Please log in to view match history</div>';
                return;
            }

            container.innerHTML = '<div class="empty-state">Loading match history...</div>';

            try {
                matchHistoryData = [];

                // Populate league filter dropdown
                let filterHtml = '<option value="all">All Leagues</option>';
                for (const team of allTeams) {
                    const leagueId = team.id || team.league_id;
                    const leagueName = team.name || team.league_name || 'League';
                    filterHtml += `<option value="${leagueId}">${leagueName}</option>`;
                }
                leagueFilter.innerHTML = filterHtml;

                // Load matches from all leagues the player is in
                for (const team of allTeams) {
                    const leagueId = team.id || team.league_id;
                    const leagueName = team.name || team.league_name || 'League';
                    const teamId = team.team_id;

                    if (!teamId) continue;

                    // Get completed matches where player's team participated
                    const matchesSnap = await getDocs(
                        query(
                            collection(db, 'leagues', leagueId, 'matches'),
                            where('status', '==', 'completed')
                        )
                    );

                    for (const matchDoc of matchesSnap.docs) {
                        const match = matchDoc.data();

                        // Check if this team was in the match
                        if (match.home_team_id !== teamId && match.away_team_id !== teamId) continue;

                        const isHome = match.home_team_id === teamId;
                        const myScore = isHome ? (match.home_score || 0) : (match.away_score || 0);
                        const oppScore = isHome ? (match.away_score || 0) : (match.home_score || 0);
                        const oppTeamName = isHome ? (match.away_team_name || 'Opponent') : (match.home_team_name || 'Opponent');
                        const myTeamName = isHome ? (match.home_team_name || team.team_name) : (match.away_team_name || team.team_name);

                        let result = 'tie';
                        if (myScore > oppScore) result = 'win';
                        else if (oppScore > myScore) result = 'loss';

                        // Get player's individual stats from this match
                        let playerMatchStats = null;
                        if (match.player_stats && match.player_stats[currentPlayer.id]) {
                            playerMatchStats = match.player_stats[currentPlayer.id];
                        }

                        matchHistoryData.push({
                            matchId: matchDoc.id,
                            leagueId: leagueId,
                            leagueName: leagueName,
                            date: match.date || match.match_date || '',
                            week: match.week,
                            myTeamName: myTeamName,
                            oppTeamName: oppTeamName,
                            myScore: myScore,
                            oppScore: oppScore,
                            result: result,
                            playerStats: playerMatchStats
                        });
                    }
                }

                // Sort by date descending
                matchHistoryData.sort((a, b) => new Date(b.date) - new Date(a.date));

                historyLoaded = true;
                filterMatchHistory();

            } catch (error) {
                console.error('Error loading match history:', error);
                container.innerHTML = '<div class="empty-state">Error loading match history</div>';
            }
        }

        window.filterMatchHistory = function() {
            const container = document.getElementById('matchHistoryContent');
            const leagueFilter = document.getElementById('historyLeagueFilter').value;
            const gameFilter = document.getElementById('historyGameFilter').value;

            let filtered = matchHistoryData;

            if (leagueFilter !== 'all') {
                filtered = filtered.filter(m => m.leagueId === leagueFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">No match history found</div>';
                return;
            }

            let html = '';
            for (const match of filtered) {
                const dateStr = match.date ? new Date(match.date + 'T12:00:00').toLocaleDateString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
                }) : 'Unknown date';

                const resultClass = match.result;
                const resultText = match.result.toUpperCase();

                // Player stats for this match
                let statsHtml = '';
                if (match.playerStats) {
                    const ps = match.playerStats;
                    const x01Avg = ps.x01_three_dart_avg || ps.x01_avg || ps.three_dart_avg;
                    const mpr = ps.cricket_mpr || ps.mpr;
                    const checkout = ps.x01_high_checkout || ps.high_checkout;

                    statsHtml = `
                        <div class="match-history-stats">
                            ${x01Avg ? `<div class="match-history-stat"><div class="match-history-stat-value">${Number(x01Avg).toFixed(1)}</div><div class="match-history-stat-label">3DA</div></div>` : ''}
                            ${mpr ? `<div class="match-history-stat"><div class="match-history-stat-value">${Number(mpr).toFixed(2)}</div><div class="match-history-stat-label">MPR</div></div>` : ''}
                            ${ps.x01_legs_won != null ? `<div class="match-history-stat"><div class="match-history-stat-value">${ps.x01_legs_won}/${ps.x01_legs_played || 0}</div><div class="match-history-stat-label">501 Legs</div></div>` : ''}
                            ${ps.cricket_legs_won != null ? `<div class="match-history-stat"><div class="match-history-stat-value">${ps.cricket_legs_won}/${ps.cricket_legs_played || 0}</div><div class="match-history-stat-label">Cricket</div></div>` : ''}
                            ${checkout ? `<div class="match-history-stat"><div class="match-history-stat-value">${checkout}</div><div class="match-history-stat-label">High Out</div></div>` : ''}
                        </div>
                    `;
                }

                html += `
                    <div class="match-history-item">
                        <div class="match-history-header">
                            <span class="match-history-date">${dateStr}${match.week ? ` ‚Ä¢ Week ${match.week}` : ''}</span>
                            <span class="match-history-league">${match.leagueName}</span>
                        </div>
                        <div class="match-history-teams">
                            <div class="match-history-team ${match.result === 'win' ? 'winner' : ''}">
                                <div class="match-history-team-name">${match.myTeamName}</div>
                                <span class="match-history-result ${resultClass}">${resultText}</span>
                            </div>
                            <div class="match-history-score">${match.myScore} - ${match.oppScore}</div>
                            <div class="match-history-team ${match.result === 'loss' ? 'winner' : ''}">
                                <div class="match-history-team-name">${match.oppTeamName}</div>
                            </div>
                        </div>
                        ${statsHtml}
                    </div>
                `;
            }

            container.innerHTML = html;
        };

        // ============================================================================
        // STATS TAB
        // ============================================================================

        let statsLoaded = false;

        async function loadDetailedStats() {
            if (!currentPlayer) return;

            const statsFilter = document.getElementById('statsLeagueFilter');

            // Populate filter dropdown
            let filterHtml = '<option value="all">All-Time Stats</option>';
            for (const team of allTeams) {
                const leagueId = team.id || team.league_id;
                const leagueName = team.name || team.league_name || 'League';
                filterHtml += `<option value="${leagueId}">${leagueName}</option>`;
            }
            statsFilter.innerHTML = filterHtml;

            await loadStatsForFilter('all');
            loadAchievements();
            statsLoaded = true;
        }

        window.loadDetailedStats = async function() {
            const filter = document.getElementById('statsLeagueFilter').value;
            await loadStatsForFilter(filter);
        };

        async function loadStatsForFilter(filter) {
            // Aggregate stats across leagues or for specific league
            let x01Stats = {
                total_points: 0, total_darts: 0, legs_won: 0, legs_played: 0,
                first9_points: 0, first9_darts: 0,
                checkouts_hit: 0, checkout_attempts: 0, checkout_total: 0,
                high_checkout: 0, high_score: 0,
                ton180: 0, ton140: 0, ton100: 0
            };
            let cricketStats = {
                total_marks: 0, total_rounds: 0, legs_won: 0, legs_played: 0,
                six_mark_rounds: 0, nine_mark_rounds: 0, high_round: 0
            };
            let totalMatches = 0;
            let matchWins = 0;

            try {
                for (const team of allTeams) {
                    const leagueId = team.id || team.league_id;

                    if (filter !== 'all' && filter !== leagueId) continue;

                    // Fetch stats by player ID (RULE 2: ONE STATS SOURCE)
                    const statsDoc = await getDoc(doc(db, 'leagues', leagueId, 'stats', currentPlayer.id));

                    if (statsDoc.exists()) {
                        const s = statsDoc.data();

                        // X01 stats
                        x01Stats.total_points += s.x01_total_points || 0;
                        x01Stats.total_darts += s.x01_total_darts || 0;
                        x01Stats.legs_won += s.x01_legs_won || 0;
                        x01Stats.legs_played += s.x01_legs_played || 0;
                        x01Stats.first9_points += s.x01_first9_points || 0;
                        x01Stats.first9_darts += s.x01_first9_darts || 0;
                        x01Stats.checkouts_hit += s.x01_checkouts_hit || 0;
                        x01Stats.checkout_attempts += s.x01_checkout_attempts || 0;
                        x01Stats.checkout_total += s.x01_total_checkout_points || 0;
                        x01Stats.high_checkout = Math.max(x01Stats.high_checkout, s.x01_high_checkout || 0);
                        x01Stats.high_score = Math.max(x01Stats.high_score, s.x01_high_score || 0);
                        x01Stats.ton180 += s.x01_ton_80 || s.x01_180s || 0;
                        x01Stats.ton140 += s.x01_ton_40 || s.x01_140s || 0;
                        x01Stats.ton100 += s.x01_tons || s.x01_100s || 0;

                        // Cricket stats
                        cricketStats.total_marks += s.cricket_total_marks || 0;
                        cricketStats.total_rounds += s.cricket_total_rounds || 0;
                        cricketStats.legs_won += s.cricket_legs_won || 0;
                        cricketStats.legs_played += s.cricket_legs_played || 0;
                        cricketStats.six_mark_rounds += s.cricket_6_mark_rounds || 0;
                        cricketStats.nine_mark_rounds += s.cricket_9_mark_rounds || 0;
                        cricketStats.high_round = Math.max(cricketStats.high_round, s.cricket_high_round || 0);

                        totalMatches += s.matches_played || 0;
                        matchWins += s.matches_won || 0;
                    }
                }

                // Calculate derived stats
                const x01Avg = x01Stats.total_darts > 0 ? (x01Stats.total_points / x01Stats.total_darts * 3).toFixed(1) : '-';
                const first9Avg = x01Stats.first9_darts > 0 ? (x01Stats.first9_points / x01Stats.first9_darts * 3).toFixed(1) : '-';
                const checkoutPct = x01Stats.checkout_attempts > 0 ? ((x01Stats.checkouts_hit / x01Stats.checkout_attempts) * 100).toFixed(1) + '%' : '-';
                const avgCheckout = x01Stats.checkouts_hit > 0 ? (x01Stats.checkout_total / x01Stats.checkouts_hit).toFixed(1) : '-';
                const x01WinRate = x01Stats.legs_played > 0 ? ((x01Stats.legs_won / x01Stats.legs_played) * 100).toFixed(0) + '%' : '-';

                const mpr = cricketStats.total_rounds > 0 ? (cricketStats.total_marks / cricketStats.total_rounds).toFixed(2) : '-';
                const cricketWinRate = cricketStats.legs_played > 0 ? ((cricketStats.legs_won / cricketStats.legs_played) * 100).toFixed(0) + '%' : '-';

                const overallWinRate = totalMatches > 0 ? ((matchWins / totalMatches) * 100).toFixed(0) + '%' : '-';

                // Update overview cards
                document.getElementById('statTotalMatches').textContent = totalMatches || '-';
                document.getElementById('statWinRate').textContent = overallWinRate;
                document.getElementById('statOverall3DA').textContent = x01Avg;
                document.getElementById('statOverallMPR').textContent = mpr;

                // Update X01 stats
                document.getElementById('stat501Avg').textContent = x01Avg;
                document.getElementById('stat501First9').textContent = first9Avg;
                document.getElementById('stat501Checkout').textContent = checkoutPct;
                document.getElementById('stat501AvgOut').textContent = avgCheckout;
                document.getElementById('stat501HighOut').textContent = x01Stats.high_checkout || '-';
                document.getElementById('stat501Legs').textContent = x01Stats.legs_played > 0 ? `${x01Stats.legs_won}/${x01Stats.legs_played} (${x01WinRate})` : '-';
                document.getElementById('stat501_180s').textContent = x01Stats.ton180 || '0';
                document.getElementById('stat501_140s').textContent = x01Stats.ton140 || '0';
                document.getElementById('stat501_100s').textContent = x01Stats.ton100 || '0';
                document.getElementById('stat501High').textContent = x01Stats.high_score || '-';

                // Update Cricket stats
                document.getElementById('statCricketMPR').textContent = mpr;
                document.getElementById('statCricketLegs').textContent = cricketStats.legs_played > 0 ? `${cricketStats.legs_won}/${cricketStats.legs_played}` : '-';
                document.getElementById('statCricketWinRate').textContent = cricketWinRate;
                document.getElementById('statCricketMarks').textContent = cricketStats.total_marks || '-';
                document.getElementById('statCricketRounds').textContent = cricketStats.total_rounds || '-';
                document.getElementById('statCricket6Mark').textContent = cricketStats.six_mark_rounds || '0';
                document.getElementById('statCricket9Mark').textContent = cricketStats.nine_mark_rounds || '0';
                document.getElementById('statCricketHighRound').textContent = cricketStats.high_round || '-';

            } catch (error) {
                console.error('Error loading detailed stats:', error);
            }
        }

        function loadAchievements() {
            const container = document.getElementById('achievementsGrid');

            // Define achievements based on stats
            const achievements = [
                { id: '180_club', icon: 'üéØ', name: 'The 180 Club', desc: 'Hit your first 180', check: () => currentPlayer.stats?.x01_ton_80 > 0 || currentPlayer.stats?.x01_180s > 0 },
                { id: 'ton_80_master', icon: 'üíØ', name: '180 Master', desc: 'Hit 10 180s', check: () => (currentPlayer.stats?.x01_ton_80 || currentPlayer.stats?.x01_180s || 0) >= 10 },
                { id: 'high_roller', icon: 'üèÜ', name: 'High Roller', desc: '100+ checkout', check: () => (currentPlayer.stats?.x01_high_checkout || 0) >= 100 },
                { id: 'checkout_king', icon: 'üëë', name: 'Checkout King', desc: '150+ checkout', check: () => (currentPlayer.stats?.x01_high_checkout || 0) >= 150 },
                { id: 'sharp_shooter', icon: 'üéØ', name: 'Sharp Shooter', desc: '50+ 3DA', check: () => get3DA(currentPlayer.stats) >= 50 },
                { id: 'pro_average', icon: '‚≠ê', name: 'Pro Average', desc: '60+ 3DA', check: () => get3DA(currentPlayer.stats) >= 60 },
                { id: 'cricket_star', icon: 'ü¶ó', name: 'Cricket Star', desc: '2.5+ MPR', check: () => getMPR(currentPlayer.stats) >= 2.5 },
                { id: 'cricket_pro', icon: 'üåü', name: 'Cricket Pro', desc: '3.0+ MPR', check: () => getMPR(currentPlayer.stats) >= 3.0 },
                { id: 'first_win', icon: 'üèÖ', name: 'First Victory', desc: 'Win your first match', check: () => (currentPlayer.stats?.matches_won || 0) >= 1 },
                { id: 'veteran', icon: 'üéñÔ∏è', name: 'Veteran', desc: 'Play 10 matches', check: () => (currentPlayer.stats?.matches_played || 0) >= 10 },
                { id: 'regular', icon: 'üìÖ', name: 'Regular', desc: 'Play 25 matches', check: () => (currentPlayer.stats?.matches_played || 0) >= 25 },
                { id: 'dedicated', icon: 'üí™', name: 'Dedicated', desc: 'Play 50 matches', check: () => (currentPlayer.stats?.matches_played || 0) >= 50 },
            ];

            let html = '';
            for (const ach of achievements) {
                const unlocked = ach.check();
                html += `
                    <div class="achievement ${unlocked ? 'unlocked' : 'locked'}">
                        <div class="achievement-icon">${ach.icon}</div>
                        <div class="achievement-name">${ach.name}</div>
                        <div class="achievement-desc">${ach.desc}</div>
                    </div>
                `;
            }

            container.innerHTML = html || '<div class="empty-state">No achievements yet</div>';
        }

        // Note: get3DA and getMPR are provided by stats-helpers.js

        // Tournaments tab data
        let tournamentsLoaded = false;

        async function loadTournamentsTab() {
            const container = document.getElementById('tournamentsContent');
            if (!currentPlayer) {
                container.innerHTML = '<div class="empty-state">Please log in to view tournaments</div>';
                return;
            }

            try {
                // Find tournaments player has participated in
                const tournamentsSnap = await getDocs(collection(db, 'tournaments'));
                const playerTournaments = [];

                for (const tournDoc of tournamentsSnap.docs) {
                    const tournament = tournDoc.data();
                    const tournamentId = tournDoc.id;

                    // Check if player is registered
                    try {
                        const regSnap = await getDocs(
                            query(
                                collection(db, 'tournaments', tournamentId, 'registrations'),
                                where('player_id', '==', currentPlayer.id)
                            )
                        );

                        if (!regSnap.empty) {
                            // Get player stats for this tournament
                            let playerStats = { x01_three_dart_avg: '-', cricket_mpr: '-' };
                            try {
                                const statsDoc = await getDoc(doc(db, 'tournaments', tournamentId, 'stats', currentPlayer.id));
                                if (statsDoc.exists()) {
                                    const s = statsDoc.data();
                                    // Calculate 3DA from components if available, else use canonical/legacy fields
                                    if (s.x01_total_darts > 0) {
                                        playerStats.x01_three_dart_avg = (s.x01_total_points / s.x01_total_darts * 3).toFixed(1);
                                    } else if (s.x01_three_dart_avg != null) {
                                        playerStats.x01_three_dart_avg = Number(s.x01_three_dart_avg).toFixed(1);
                                    } else if (s.x01_avg != null) {
                                        playerStats.x01_three_dart_avg = Number(s.x01_avg).toFixed(1);
                                    }
                                    // Calculate MPR from components if available, else use canonical/legacy fields
                                    if (s.cricket_total_rounds > 0) {
                                        playerStats.cricket_mpr = (s.cricket_total_marks / s.cricket_total_rounds).toFixed(2);
                                    } else if (s.cricket_mpr != null) {
                                        playerStats.cricket_mpr = Number(s.cricket_mpr).toFixed(2);
                                    } else if (s.mpr != null) {
                                        playerStats.cricket_mpr = Number(s.mpr).toFixed(2);
                                    }
                                }
                            } catch (e) { /* stats not available */ }

                            playerTournaments.push({
                                id: tournamentId,
                                name: tournament.tournament_name || tournament.name || 'Tournament',
                                date: tournament.date || tournament.start_date,
                                status: tournament.status,
                                ...playerStats
                            });
                        }
                    } catch (e) { /* skip */ }
                }

                if (playerTournaments.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 48px; margin-bottom: 15px;">üéØ</div>
                            <div>No tournaments found</div>
                            <div style="font-size: 12px; margin-top: 8px; color: #666;">Register for a tournament to see it here</div>
                        </div>
                    `;
                    tournamentsLoaded = true;
                    return;
                }

                // Sort by date (most recent first)
                playerTournaments.sort((a, b) => {
                    const dateA = a.date?.toDate?.() || new Date(a.date || 0);
                    const dateB = b.date?.toDate?.() || new Date(b.date || 0);
                    return dateB - dateA;
                });

                container.innerHTML = playerTournaments.map(t => {
                    const isPast = t.status === 'completed';
                    const dateStr = t.date
                        ? (t.date.toDate ? t.date.toDate() : new Date(t.date)).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                        : '';

                    return `
                        <div class="league-team-card tournament ${isPast ? 'past' : ''}" onclick="navigateTo('/pages/tournament-view.html?tournament_id=${t.id}', event)" style="cursor: pointer;">
                            <div class="league-team-header">
                                <div>
                                    <div class="league-team-name">${t.name}</div>
                                    <div class="league-team-league">${dateStr}</div>
                                </div>
                                <div class="league-team-stats">
                                    <div><span class="stat-label">3DA:</span> <span class="stat-value">${t.x01_three_dart_avg}</span></div>
                                    <div><span class="stat-label">MPR:</span> <span class="stat-value">${t.cricket_mpr}</span></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                tournamentsLoaded = true;
            } catch (error) {
                console.error('Error loading tournaments tab:', error);
                container.innerHTML = '<div class="empty-state">Error loading tournaments</div>';
            }
        }

        window.switchCaptainSubtab = function(subtabName) {
            document.querySelectorAll('.captain-subtab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.captain-subcontent').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById('captain' + subtabName.charAt(0).toUpperCase() + subtabName.slice(1)).classList.add('active');
        };

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================

        window.logout = function() {
            localStorage.removeItem('brdc_session');
            currentPlayer = null;
            document.getElementById('pinInput').value = '';
            showLoginPage();
        };

        window.showForgotPin = function() {
            const email = prompt('Enter your email address to recover your PIN:');
            if (email) {
                callFunction('recoverPin', { email: email })
                    .then(result => {
                        alert(result.message || 'If an account exists, your PIN has been sent to your email.');
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
            }
            return false;
        };

        // Handle Enter key
        document.getElementById('pinInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        // ============================================================================
        // DART TRADER FUNCTIONS
        // ============================================================================

        let myListings = [];
        let editingListingId = null;
        let traderLoaded = false;
        let listingImageFile = null;

        // Handle listing image selection
        window.handleListingImageSelect = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                return;
            }

            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            listingImageFile = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('listingPreviewImg').src = e.target.result;
                document.getElementById('listingImagePreview').style.display = 'block';
                document.getElementById('listingImagePlaceholder').style.display = 'none';
            };
            reader.readAsDataURL(file);

            event.stopPropagation();
        };

        // Remove listing image
        window.removeListingImage = function(event) {
            event.stopPropagation();
            listingImageFile = null;
            document.getElementById('listingImageInput').value = '';
            document.getElementById('listingImagePreview').style.display = 'none';
            document.getElementById('listingImagePlaceholder').style.display = 'block';
        };

        // Load my listings when trader tab is shown
        window.loadTraderTab = async function() {
            if (traderLoaded || !currentPlayer) return;

            try {
                const snapshot = await db.collection('dart_trader_listings')
                    .where('seller_id', '==', currentPlayer.id)
                    .orderBy('created_at', 'desc')
                    .get();

                myListings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMyListings();
                traderLoaded = true;
            } catch (error) {
                console.error('Error loading listings:', error);
                document.getElementById('myListings').innerHTML = `
                    <div class="empty-state">Error loading listings. Please try again.</div>
                `;
            }
        };

        // Render my listings
        function renderMyListings() {
            const container = document.getElementById('myListings');

            if (myListings.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; padding: 30px;">
                        <p style="font-size: 32px; margin-bottom: 10px;">üì¶</p>
                        <p>You haven't listed anything yet.</p>
                        <p style="color: var(--text-dim); font-size: 13px; margin-top: 8px;">Click "New Listing" to sell your dart gear!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = myListings.map(listing => `
                <div class="my-listing-card ${listing.status === 'sold' ? 'sold' : ''}">
                    <div class="my-listing-header">
                        <span class="my-listing-category">${listing.category || 'Item'}</span>
                        <span class="my-listing-status ${listing.status}">${listing.status === 'sold' ? 'SOLD' : 'Active'}</span>
                    </div>
                    <div class="my-listing-title">${escapeHtml(listing.title)}</div>
                    <div class="my-listing-price">$${parseFloat(listing.price).toFixed(0)}</div>
                    <div class="my-listing-actions">
                        ${listing.status !== 'sold' ? `
                            <button class="edit-listing-btn" onclick="editListing('${listing.id}')">Edit</button>
                            <button class="sold-listing-btn" onclick="markAsSold('${listing.id}')">Mark Sold</button>
                        ` : ''}
                        <button class="delete-listing-btn" onclick="deleteListing('${listing.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Show listing form
        window.showListingForm = function(listing = null) {
            editingListingId = listing?.id || null;
            document.getElementById('listingFormTitle').textContent = listing ? 'Edit Listing' : 'Create New Listing';
            document.getElementById('submitListingBtn').textContent = listing ? 'Save Changes' : 'Create Listing';

            // Reset form
            document.getElementById('listingForm').reset();

            // Reset image upload
            listingImageFile = null;
            document.getElementById('listingImageInput').value = '';

            // Populate if editing
            if (listing) {
                document.getElementById('listingCategory').value = listing.category || '';
                document.getElementById('listingTitle').value = listing.title || '';
                document.getElementById('listingCondition').value = listing.condition || '';
                document.getElementById('listingPrice').value = listing.price || '';
                document.getElementById('listingDescription').value = listing.description || '';

                if (listing.category === 'Darts') {
                    document.getElementById('listingWeight').value = listing.weight || '';
                    document.getElementById('listingMaterial').value = listing.material || '';
                    document.getElementById('listingPointType').value = listing.point_type || '';
                    document.getElementById('listingBrand').value = listing.brand || '';
                }

                // Show existing image if present
                if (listing.image_url) {
                    document.getElementById('listingPreviewImg').src = listing.image_url;
                    document.getElementById('listingImagePreview').style.display = 'block';
                    document.getElementById('listingImagePlaceholder').style.display = 'none';
                } else {
                    document.getElementById('listingImagePreview').style.display = 'none';
                    document.getElementById('listingImagePlaceholder').style.display = 'block';
                }

                toggleDartsFields();
            } else {
                // New listing - reset image preview
                document.getElementById('listingImagePreview').style.display = 'none';
                document.getElementById('listingImagePlaceholder').style.display = 'block';
            }

            document.getElementById('listingFormContainer').style.display = 'block';
            document.getElementById('listingCategory').focus();

            // Scroll to form
            document.getElementById('listingFormContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        };

        // Hide listing form
        window.hideListingForm = function() {
            document.getElementById('listingFormContainer').style.display = 'none';
            editingListingId = null;
        };

        // Toggle darts-specific fields
        window.toggleDartsFields = function() {
            const category = document.getElementById('listingCategory').value;
            const dartsFields = document.getElementById('dartsFields');
            const weightInput = document.getElementById('listingWeight');

            if (category === 'Darts') {
                dartsFields.style.display = 'block';
                weightInput.required = true;
            } else {
                dartsFields.style.display = 'none';
                weightInput.required = false;
            }
        };

        // Submit listing
        window.submitListing = async function(event) {
            event.preventDefault();

            if (!currentPlayer) {
                alert('Please log in to create a listing.');
                return;
            }

            const submitBtn = document.getElementById('submitListingBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                const category = document.getElementById('listingCategory').value;
                const listingData = {
                    category: category,
                    title: document.getElementById('listingTitle').value.trim(),
                    condition: document.getElementById('listingCondition').value,
                    price: parseFloat(document.getElementById('listingPrice').value),
                    description: document.getElementById('listingDescription').value.trim(),
                    seller_id: currentPlayer.id,
                    seller_name: currentPlayer.name || (currentPlayer.first_name + ' ' + currentPlayer.last_name),
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Upload image if selected
                if (listingImageFile) {
                    submitBtn.textContent = 'Uploading image...';
                    const imageUrl = await uploadImage(listingImageFile, 'dart-trader');
                    listingData.image_url = imageUrl;
                }

                // Add darts-specific fields
                if (category === 'Darts') {
                    listingData.weight = parseFloat(document.getElementById('listingWeight').value) || null;
                    listingData.material = document.getElementById('listingMaterial').value || null;
                    listingData.point_type = document.getElementById('listingPointType').value || null;
                    listingData.brand = document.getElementById('listingBrand').value.trim() || null;
                }

                // Add contact preferences
                const contactEmail = document.getElementById('contactEmail').checked;
                const contactPhone = document.getElementById('contactPhone').checked;

                if (contactEmail && currentPlayer.email) {
                    listingData.contact_email = currentPlayer.email;
                }
                if (contactPhone && currentPlayer.phone) {
                    listingData.contact_phone = currentPlayer.phone;
                }

                submitBtn.textContent = 'Saving...';

                if (editingListingId) {
                    // Update existing listing
                    await db.collection('dart_trader_listings').doc(editingListingId).update(listingData);

                    // Update local array
                    const idx = myListings.findIndex(l => l.id === editingListingId);
                    if (idx !== -1) {
                        myListings[idx] = { ...myListings[idx], ...listingData };
                    }
                } else {
                    // Create new listing
                    listingData.created_at = firebase.firestore.FieldValue.serverTimestamp();
                    listingData.status = 'active';

                    const docRef = await db.collection('dart_trader_listings').add(listingData);
                    myListings.unshift({ id: docRef.id, ...listingData, created_at: new Date() });
                }

                // Clear image after successful save
                listingImageFile = null;

                renderMyListings();
                hideListingForm();

            } catch (error) {
                console.error('Error saving listing:', error);
                alert('Error saving listing. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = editingListingId ? 'Save Changes' : 'Create Listing';
            }
        };

        // Edit listing
        window.editListing = function(listingId) {
            const listing = myListings.find(l => l.id === listingId);
            if (listing) {
                showListingForm(listing);
            }
        };

        // Mark listing as sold
        window.markAsSold = async function(listingId) {
            if (!confirm('Mark this listing as sold?')) return;

            try {
                await db.collection('dart_trader_listings').doc(listingId).update({
                    status: 'sold',
                    sold_at: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update local array
                const listing = myListings.find(l => l.id === listingId);
                if (listing) {
                    listing.status = 'sold';
                }

                renderMyListings();
            } catch (error) {
                console.error('Error marking as sold:', error);
                alert('Error updating listing. Please try again.');
            }
        };

        // Delete listing
        window.deleteListing = async function(listingId) {
            if (!confirm('Delete this listing permanently?')) return;

            try {
                await db.collection('dart_trader_listings').doc(listingId);
                // Actually delete or just mark as deleted
                await db.collection('dart_trader_listings').doc(listingId).delete();

                // Remove from local array
                myListings = myListings.filter(l => l.id !== listingId);
                renderMyListings();
            } catch (error) {
                console.error('Error deleting listing:', error);
                alert('Error deleting listing. Please try again.');
            }
        };

        // Extend switchTab to load trader data
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'trader') {
                loadTraderTab();
            }
        };

        // Check URL params for direct tab access
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('tab') === 'trader') {
            // Will be handled after login
            window.pendingTab = 'trader';
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => {})
                .catch(err => console.error('[SW] Registration failed:', err));
        }
    </script>
    <script src="/js/nav-menu.js"></script>
    <script src="/js/stats-helpers.js"></script>
    <script src="/js/feedback.js"></script>
</body>
</html>
