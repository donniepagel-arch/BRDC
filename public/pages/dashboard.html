<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FF469A">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap');

        :root {
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --text-light: #f0f0f0;
            --text-dim: #8a8aa3;
            --border-color: rgba(255,255,255,0.15);
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        html, body { min-height: 100%; overflow-x: hidden; width: 100%; }
        body {
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0f0f23 100%);
            color: var(--text-light);
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* Header Bar */
        .header-bar {
            background: var(--bg-panel);
            border-bottom: 3px solid var(--pink);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .back-btn, .logout-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .back-btn:hover, .logout-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: var(--pink);
        }

        .logout-btn { margin-left: auto; }

        /* Floating chat bubble container */
        .chat-bubble-container {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 9998;
        }

        .floating-chat-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--teal) 0%, #147a94 100%);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(145, 215, 235, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .floating-chat-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(145, 215, 235, 0.6);
        }
        .floating-chat-btn:active {
            transform: scale(0.95);
        }
        .floating-chat-btn .unread-badge {
            position: absolute;
            top: -4px;
            right: -4px;
        }

        /* Expanded chat menu */
        .chat-expanded-menu {
            position: absolute;
            bottom: 60px;
            right: 0;
            display: none;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            padding-bottom: 10px;
        }

        .chat-bubble-container.expanded .chat-expanded-menu {
            display: flex;
            animation: fadeInUp 0.3s ease;
        }

        .chat-bubble-container.expanded .floating-chat-btn {
            background: linear-gradient(135deg, var(--pink) 0%, #c4386a 100%);
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Chat room circles (vertical) */
        .chat-rooms-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .chat-room-circle {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-panel);
            border: 2px solid var(--teal);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            font-size: 18px;
            transition: transform 0.2s, border-color 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .chat-room-circle:hover {
            transform: scale(1.1);
            border-color: var(--yellow);
        }

        .chat-room-circle .room-label {
            position: absolute;
            right: 54px;
            background: var(--bg-panel);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            border: 1px solid rgba(255,255,255,0.2);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .chat-room-circle:hover .room-label {
            opacity: 1;
        }

        /* DM circles (horizontal row) */
        .chat-dms-section {
            display: flex;
            flex-direction: row-reverse;
            gap: 8px;
            align-items: center;
        }

        .chat-dm-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-panel);
            border: 2px solid var(--pink);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            font-size: 14px;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .chat-dm-circle:hover {
            transform: scale(1.1);
            border-color: var(--yellow);
        }

        .chat-dm-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-dm-circle .dm-initial {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--pink);
        }

        /* Group DM - overlapping circles */
        .chat-dm-group {
            display: flex;
            flex-direction: row-reverse;
        }

        .chat-dm-group .chat-dm-circle {
            margin-left: -12px;
        }

        .chat-dm-group .chat-dm-circle:last-child {
            margin-left: 0;
        }

        /* Circle unread badge */
        .circle-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--pink);
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-panel);
        }

        .circle-badge.hidden { display: none; }

        .unread-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--pink);
            color: white;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--bg-panel);
        }

        .unread-badge.hidden { display: none; }

        /* League/Tournament Cards */
        .league-team-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-left: 4px solid var(--teal);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }

        .league-team-card.tournament {
            border-left-color: var(--yellow);
        }

        .league-team-card.past {
            opacity: 0.6;
            border-left-color: #666;
        }

        .league-team-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .league-team-header:hover .league-team-name {
            color: var(--yellow);
        }

        .league-team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
            transition: color 0.2s;
        }

        .league-team-card.tournament .league-team-name {
            color: var(--yellow);
        }

        .league-team-league {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-top: 2px;
        }

        .league-team-stats {
            text-align: right;
        }

        .league-team-stats .stat-label {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
        }

        .league-team-stats .stat-value {
            font-size: 16px;
            color: var(--yellow);
            font-weight: bold;
        }

        .teammates-section {
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 12px;
        }

        .teammates-title {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .teammate-row {
            display: flex;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
        }

        .teammate-row:last-child {
            border-bottom: none;
        }

        .teammate-row:hover {
            background: rgba(255,255,255,0.05);
            margin: 0 -10px;
            padding-left: 10px;
            padding-right: 10px;
        }

        .teammate-level {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
            background: rgba(255,255,255,0.1);
        }

        .teammate-level.level-a { background: rgba(255,70,154,0.3); color: var(--pink); }
        .teammate-level.level-b { background: rgba(145,215,235,0.3); color: var(--teal); }
        .teammate-level.level-c { background: rgba(253,216,53,0.3); color: var(--yellow); }

        .teammate-name {
            flex: 1;
            font-size: 14px;
        }

        .teammate-name.captain::after {
            content: ' ‚≠ê';
            font-size: 12px;
        }

        .teammate-stats {
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }

        .teammate-stats span {
            margin-left: 12px;
        }

        .teammate-stats .value {
            color: var(--yellow);
            font-weight: bold;
        }

        /* Team Cards Grid - Clean mobile design */
        .team-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        .team-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .team-card:hover {
            border-color: var(--teal);
            transform: translateY(-2px);
        }

        .team-card.past {
            opacity: 0.5;
        }

        .team-card-league {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .team-card-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
            margin-bottom: 8px;
            line-height: 1.1;
        }

        .team-card-record {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--yellow);
        }

        .team-card-arrow {
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-dim);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .team-card:hover .team-card-arrow {
            opacity: 1;
        }

        .header-logo {
            width: 40px;
            height: 40px;

        }

        .header-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            letter-spacing: 3px;
            color: var(--pink);
        }

        /* Container */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page */
        .login-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            
        }

        .login-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--pink);
            letter-spacing: 3px;
            margin-bottom: 30px;
        }

        .login-box {
            background: var(--bg-panel);
            border: 3px solid #000;
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: 380px;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.4);
        }

        .login-form-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--teal);
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group { margin-bottom: 16px; }

        .form-label {
            display: block;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 16px;
            background: rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            font-size: 24px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--yellow);
            text-align: center;
            letter-spacing: 4px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--pink);
            background: rgba(255,70,154,0.1);
            box-shadow: 0 0 20px rgba(255,70,154,0.3);
        }

        .form-input::placeholder {
            color: rgba(253, 216, 53, 0.4);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(180deg, var(--pink) 0%, #d63384 100%);
            border: 3px solid #000;
            border-radius: 10px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
        }

        .login-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid var(--danger);
            border-radius: 8px;
            padding: 12px;
            color: #fca5a5;
            font-size: 13px;
            text-align: center;
            margin-bottom: 16px;
        }

        .login-links {
            text-align: center;
            margin-top: 20px;
            font-size: 13px;
        }

        .login-links a {
            color: var(--teal);
            text-decoration: none;
        }

        .login-links a:hover { text-decoration: underline; }

        .dashboard-content { display: none; }

        /* Welcome Section */
        /* Profile Header - Clean Mobile-First Design */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            margin-bottom: 15px;
        }

        .player-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--pink), var(--teal));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid #000;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            flex-shrink: 0;
        }

        .player-avatar:hover .avatar-edit-overlay {
            opacity: 1;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-edit-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 18px;
        }

        .avatar-input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }

        .profile-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 1px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-stats-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .profile-stat {
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .profile-stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--yellow);
        }

        .profile-stat-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .profile-link {
            font-size: 12px;
            color: var(--teal);
            text-decoration: none;
            margin-top: 4px;
            display: inline-block;
        }

        .profile-link:hover {
            color: var(--yellow);
            text-decoration: underline;
        }

        /* Profile Actions (gear + admin) */
        .profile-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .settings-icon-btn {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
            line-height: 1;
        }

        .settings-icon-btn:hover {
            transform: rotate(45deg);
        }

        /* Admin Button */
        .admin-btn {
            background: linear-gradient(180deg, var(--yellow) 0%, #f59e0b 100%);
            border: 2px solid #000;
            border-radius: 8px;
            padding: 8px 12px;
            color: #000;
            font-family: 'Bebas Neue', cursive;
            font-size: 12px;
            letter-spacing: 1px;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .admin-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 3px 3px 0 rgba(0,0,0,0.4);
        }

        /* Settings Tab Styles */
        .settings-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .settings-section h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--teal);
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 14px;
        }

        .setting-label small {
            display: block;
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .notification-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255,255,255,0.1);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.sms {
            background: var(--pink);
        }

        .toggle-switch.email {
            background: var(--teal);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.email::after {
            transform: translateX(24px);
        }

        .toggle-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 40px;
        }

        .toggle-label.active {
            color: var(--yellow);
            font-weight: bold;
        }

        .profile-edit-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .profile-edit-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .profile-edit-form label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }

        .profile-edit-form input {
            padding: 10px 12px;
            background: rgba(255,255,255,0.08);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .profile-edit-form input:focus {
            outline: none;
            border-color: var(--teal);
        }

        .save-btn {
            background: linear-gradient(180deg, var(--pink) 0%, #c4386a 100%);
            border: 2px solid #000;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
        }

        .save-btn:hover {
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
        }

        /* Editable Profile Fields */
        .profile-field {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-field:last-child {
            border-bottom: none;
        }

        .profile-field-info {
            flex: 1;
        }

        .profile-field-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .profile-field-value {
            font-size: 15px;
            color: var(--text-primary);
        }

        .profile-field-value.empty {
            color: var(--text-dim);
            font-style: italic;
        }

        .profile-field-edit {
            display: none;
            flex: 1;
        }

        .profile-field-edit input {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-dark);
            border: 2px solid var(--teal);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .profile-field-edit input:focus {
            outline: none;
        }

        .profile-field.editing .profile-field-info {
            display: none;
        }

        .profile-field.editing .profile-field-edit {
            display: block;
        }

        .profile-field.editing .edit-btn {
            display: none;
        }

        .profile-field.editing .save-field-btn,
        .profile-field.editing .cancel-field-btn {
            display: inline-flex;
        }

        .edit-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 12px;
            color: var(--teal);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-btn:hover {
            background: rgba(145, 215, 235, 0.2);
            border-color: var(--teal);
        }

        .edit-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .edit-btn.disabled:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--border-color);
        }

        .save-field-btn, .cancel-field-btn {
            display: none;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin-left: 6px;
        }

        .save-field-btn {
            background: var(--success);
            color: white;
        }

        .cancel-field-btn {
            background: rgba(255,255,255,0.1);
            color: var(--text-dim);
        }

        .profile-field-actions {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .field-locked-hint {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 2px;
        }

        /* Privacy Toggle Styles */
        .privacy-setting {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .privacy-setting:last-child {
            border-bottom: none;
        }

        .privacy-info {
            flex: 1;
        }

        .privacy-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .privacy-desc {
            font-size: 11px;
            color: var(--text-dim);
        }

        .privacy-toggle {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .privacy-toggle.on {
            background: var(--success);
        }

        .privacy-toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .privacy-toggle.on::after {
            transform: translateX(20px);
        }

        /* Tabs */
        .tab-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            border-bottom: 3px solid var(--border-color);
            padding-bottom: 5px;
        }

        .tab {
            background: rgba(0,0,0,0.3);
            border: 2px solid transparent;
            padding: 12px 20px;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px 8px 0 0;
        }

        .tab:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        .tab.active {
            background: var(--pink);
            color: white;
            border-color: var(--pink);
        }

        .tab.captain-tab {
            display: none;
        }

        .tab.captain-tab.show {
            display: block;
            background: rgba(145, 215, 235, 0.2);
        }

        .tab.captain-tab.show.active {
            background: var(--teal);
            color: #000;
        }

        .tab.director-tab.show {
            display: block;
            background: rgba(255, 215, 0, 0.2);
        }

        .tab.director-tab.show.active {
            background: var(--yellow);
            color: #000;
        }

        /* Sub-tabs (inside main tabs) */
        .sub-tab-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
        }

        .sub-tab {
            background: rgba(0,0,0,0.2);
            border: none;
            padding: 10px 18px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 1px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px 6px 0 0;
        }

        .sub-tab:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        .sub-tab.active {
            background: var(--teal);
            color: #000;
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        .director-list {
            display: grid;
            gap: 12px;
        }

        .director-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-card);
            border: 3px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .director-item:hover {
            border-color: var(--yellow);
            transform: translateY(-2px);
        }

        .director-item-info h4 {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .director-item-info p {
            font-size: 12px;
            color: var(--text-dim);
        }

        .director-item-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .director-item-status.active { background: var(--success); color: #000; }
        .director-item-status.registration { background: var(--teal); color: #000; }
        .director-item-status.draft { background: var(--yellow); color: #000; }

        /* History Tab Styles */
        .history-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .history-filters select {
            padding: 10px 15px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            min-width: 150px;
        }

        .match-history-item {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .match-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border-color);
        }

        .match-history-date {
            font-size: 12px;
            color: var(--text-dim);
        }

        .match-history-league {
            font-size: 11px;
            color: var(--teal);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .match-history-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
        }

        .match-history-team {
            text-align: center;
            flex: 1;
        }

        .match-history-team.winner {
            color: var(--yellow);
        }

        .match-history-team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
        }

        .match-history-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            padding: 0 20px;
            color: var(--pink);
        }

        .match-history-result {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 20px;
            margin-top: 5px;
            display: inline-block;
        }

        .match-history-result.win { background: var(--success); color: white; }
        .match-history-result.loss { background: var(--danger); color: white; }
        .match-history-result.tie { background: var(--yellow); color: #000; }

        .match-history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid var(--border-color);
        }

        .match-history-stat {
            text-align: center;
        }

        .match-history-stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
        }

        .match-history-stat-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        /* Stats Tab Styles */
        .stats-filters, .stats-source-filter {
            margin-bottom: 20px;
        }

        .stats-filters select, .stats-source-filter select {
            padding: 10px 15px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            min-width: 200px;
            width: 100%;
            max-width: 300px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-card .stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--pink);
            line-height: 1;
        }

        .stat-card .stat-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .stats-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-section h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-name {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-val {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: white;
        }

        /* Achievements Grid */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .achievement {
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.2s;
        }

        .achievement.unlocked {
            border-color: var(--yellow);
            background: rgba(253, 216, 53, 0.1);
        }

        .achievement.locked {
            opacity: 0.5;
        }

        .achievement-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .achievement-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .achievement-desc {
            font-size: 10px;
            color: var(--text-dim);
        }

        .achievement-progress {
            margin-top: 8px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .achievement-progress-bar {
            height: 100%;
            background: var(--yellow);
            transition: width 0.3s;
        }
        .director-item-status.completed { background: #666; color: #fff; }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Calendar Styles */
        .calendar-container {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .cal-month {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 1px;
        }

        .cal-nav {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .cal-nav:hover {
            background: var(--pink);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 5px;
        }

        .cal-day-header {
            text-align: center;
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            padding: 5px;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .cal-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            position: relative;
            min-height: 40px;
        }

        .cal-day:hover {
            background: rgba(255,255,255,0.1);
        }

        .cal-day.other-month {
            color: var(--text-dim);
            opacity: 0.4;
        }

        .cal-day.today {
            background: rgba(255, 70, 154, 0.2);
            border: 2px solid var(--pink);
        }

        .cal-day.has-event {
            background: rgba(145, 215, 235, 0.15);
        }

        .cal-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--teal);
        }

        .cal-day.has-tournament::after {
            background: var(--yellow);
        }

        .cal-day.has-multiple::after {
            width: 12px;
            border-radius: 3px;
        }

        /* Event Popup */
        .event-popup {
            background: var(--bg-panel);
            border: 3px solid var(--pink);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .event-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .event-popup-header span {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
        }

        .popup-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 18px;
            cursor: pointer;
        }

        .popup-close:hover {
            color: var(--pink);
        }

        .event-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .event-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .event-item:last-child {
            margin-bottom: 0;
        }

        .event-type-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .event-type-badge.league {
            background: var(--teal);
            color: #000;
        }

        .event-type-badge.tournament {
            background: var(--yellow);
            color: #000;
        }

        .event-type-badge.social {
            background: var(--pink);
            color: white;
        }

        .event-type-badge.upcoming-tournament {
            background: #FF9800;
            color: #000;
        }

        .event-type-badge.deadline {
            background: #e53935;
            color: white;
        }

        /* Calendar Legend */
        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--text-dim);
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-dot.league { background: var(--teal); }
        .legend-dot.tournament { background: var(--yellow); }
        .legend-dot.upcoming-tournament { background: #FF9800; }
        .legend-dot.deadline { background: #e53935; }
        .legend-dot.social { background: var(--pink); }

        /* Calendar day indicators for different event types */
        .cal-day.has-deadline::before {
            content: '';
            position: absolute;
            bottom: 4px;
            left: calc(50% - 10px);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #e53935;
        }

        .cal-day.has-upcoming::before {
            content: '';
            position: absolute;
            bottom: 4px;
            left: calc(50% + 4px);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #FF9800;
        }

        .cal-day.has-social::after {
            background: var(--pink) !important;
        }

        /* Match Card Layout */
        .match-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 12px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }

        .match-card-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-bottom: 2px solid #000;
        }

        .match-team-side {
            text-align: center;
        }

        .match-team-side.left {
            text-align: left;
        }

        .match-team-side.right {
            text-align: right;
        }

        .match-team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            color: var(--teal);
        }

        .match-team-record {
            font-size: 12px;
            color: var(--yellow);
            font-weight: 600;
        }

        .match-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--text-primary);
            line-height: 1;
            margin-top: 4px;
        }

        .match-team-side.winner .match-team-name {
            color: var(--yellow);
        }

        .match-team-side.winner .match-score {
            color: var(--yellow);
        }

        .winner-star {
            color: #FFD700;
            font-size: 28px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.5);
            vertical-align: middle;
            margin: 0 4px;
            animation: star-pulse 2s ease-in-out infinite;
        }

        @keyframes star-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.9; }
        }

        .match-card-header.completed {
            background: rgba(0,0,0,0.4);
        }

        .match-center {
            text-align: center;
            padding: 0 15px;
        }

        .match-week {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        .match-vs {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--pink);
            line-height: 1;
        }

        .match-card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        .match-roster {
            padding: 10px;
        }

        .match-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .match-row:last-child {
            border-bottom: none;
        }

        .match-player-cell {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            font-size: 11px;
        }

        .match-player-cell.left {
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .match-player-cell.right {
            flex-direction: row-reverse;
        }

        .match-roster-title {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 6px;
            letter-spacing: 1px;
        }

        .match-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .match-player:last-child {
            border-bottom: none;
        }

        .match-player-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .match-player-name.captain::before {
            content: '‚òÖ ';
            color: var(--yellow);
        }

        .match-player-stats {
            color: var(--text-dim);
            font-size: 10px;
            text-align: right;
        }

        .match-card-footer {
            padding: 10px 12px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .match-card-link {
            display: inline-block;
            padding: 6px 16px;
            background: var(--teal);
            color: #000;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 4px;
            text-decoration: none;
            cursor: pointer;
        }

        .match-card-link:hover {
            background: var(--yellow);
        }

        /* Non-league event items */
        .event-card {
            background: var(--bg-card);
            border: 3px solid #000;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }

        .event-card:hover {
            background: var(--bg-panel);
        }

        .event-details {
            flex: 1;
        }

        .event-title {
            font-weight: 600;
            font-size: 14px;
        }

        .event-subtitle {
            font-size: 12px;
            color: var(--text-dim);
        }

        .stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--yellow);
        }

        .stat-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
        }

        .stats-link {
            text-align: center;
            margin-bottom: 20px;
        }

        .stats-link a {
            color: var(--teal);
            font-size: 13px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .stats-link a:hover {
            color: var(--yellow);
            text-decoration: underline;
        }

        /* Team Selector */
        .team-selector {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .team-selector label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 8px;
            display: block;
        }

        .team-selector select {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        /* Team Name Editor */
        .team-name-editor {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .team-name-display {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .team-name-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
        }
        .team-name-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--primary-pink);
            flex: 1;
        }
        .edit-team-name-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-dim);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        .edit-team-name-btn:hover {
            border-color: var(--primary-pink);
            color: var(--primary-pink);
        }
        .team-name-edit {
            margin-top: 10px;
        }
        .team-name-edit input {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .team-name-edit input:focus {
            outline: none;
            border-color: var(--primary-pink);
        }
        .team-name-buttons {
            display: flex;
            gap: 10px;
        }
        .save-name-btn {
            flex: 1;
            padding: 10px;
            background: var(--primary-pink);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            cursor: pointer;
        }
        .cancel-name-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-dim);
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            cursor: pointer;
        }

        /* Schedule Table */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--border-color);
        }

        .schedule-table th {
            background: var(--bg-panel);
            padding: 15px;
            text-align: left;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 1px;
            color: var(--teal);
        }

        .schedule-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .schedule-table tr:last-child td {
            border-bottom: none;
        }

        .availability-btns {
            display: flex;
            gap: 8px;
        }

        .avail-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            background: transparent;
            color: white;
        }

        .avail-btn.confirm {
            border-color: var(--success);
            color: var(--success);
        }

        .avail-btn.confirm:hover, .avail-btn.confirm.selected {
            background: var(--success);
            color: #000;
        }

        .avail-btn.cant {
            border-color: var(--danger);
            color: var(--danger);
        }

        .avail-btn.cant:hover, .avail-btn.cant.selected {
            background: var(--danger);
            color: white;
        }

        .match-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .match-status.upcoming { background: var(--yellow); color: #000; }
        .match-status.completed { background: var(--success); color: #000; }
        .match-status.in-progress { background: var(--pink); color: white; }

        /* New Match Card Layout */
        .match-cards-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .match-section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--teal);
            letter-spacing: 1px;
            margin: 20px 0 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }

        .match-section-title:first-child {
            margin-top: 0;
        }

        .match-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .match-card.past {
            opacity: 0.8;
        }

        .match-card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 12px;
            background: var(--bg-panel);
            border-bottom: 2px solid var(--border-color);
        }

        .match-week {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--pink);
            letter-spacing: 2px;
        }

        .match-date {
            font-size: 13px;
            color: rgba(255,255,255,0.7);
        }

        .match-card-body {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr auto;
            gap: 0;
            align-items: stretch;
        }

        @media (max-width: 700px) {
            .match-card-body {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .match-avail-btn {
                width: 100% !important;
                border-radius: 0 !important;
            }

            .match-team-section {
                padding: 10px !important;
            }

            .match-center-divider {
                display: none;
            }
        }

        .match-avail-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 12px;
            width: 70px;
            border: none;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .match-avail-btn .icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .match-avail-btn.cant-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .match-avail-btn.cant-btn:hover,
        .match-avail-btn.cant-btn.selected {
            background: #ef4444;
            color: white;
        }

        .match-avail-btn.in-btn {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .match-avail-btn.in-btn:hover,
        .match-avail-btn.in-btn.selected {
            background: #22c55e;
            color: white;
        }

        .match-avail-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .match-team-section {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .match-team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .match-team-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--teal);
            cursor: pointer;
        }

        .match-team-name:hover {
            color: var(--pink);
        }

        .match-team-record {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }

        .match-player-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            font-size: 13px;
        }

        .match-player-row.unavailable {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .match-player-row.sub {
            background: rgba(253, 216, 53, 0.15);
            border: 1px solid rgba(253, 216, 53, 0.3);
        }

        .match-player-row.confirmed {
            background: rgba(34, 197, 94, 0.1);
        }

        .match-player-level {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: var(--pink);
            width: 20px;
        }

        .match-player-name {
            flex: 1;
            cursor: pointer;
        }

        .match-player-name:hover {
            color: var(--pink);
        }

        .match-player-stats {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
        }

        .match-center-divider {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            min-width: 90px;
            background: var(--bg-panel);
            border-left: 2px solid var(--border-color);
            border-right: 2px solid var(--border-color);
        }

        .match-center-week {
            font-family: 'Bebas Neue', cursive;
            font-size: 26px;
            color: var(--pink);
            letter-spacing: 2px;
            line-height: 1;
        }

        .match-center-date {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
        }

        .match-result {
            text-align: center;
            padding: 8px;
            background: var(--bg-panel);
            border-top: 2px solid var(--border-color);
        }

        .match-result-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            color: var(--pink);
        }

        .match-result-score.won {
            color: var(--success);
        }

        .match-result-score.lost {
            color: #ef4444;
        }

        .match-result-label {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* All Teams View */
        .all-teams-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .all-teams-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: var(--bg-panel);
            cursor: pointer;
            border-bottom: 2px solid var(--border-color);
        }

        .all-teams-header:hover {
            background: rgba(255,255,255,0.05);
        }

        .all-teams-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
            letter-spacing: 1px;
        }

        .all-teams-league {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            flex: 1;
        }

        .all-teams-expand {
            font-size: 12px;
            color: rgba(255,255,255,0.4);
        }

        .all-teams-next .match-card {
            border: none;
            border-radius: 0;
        }

        .all-teams-full {
            padding: 10px;
            border-top: 2px solid var(--border-color);
        }

        .all-teams-full .match-card {
            margin-bottom: 10px;
        }

        /* Roster Cards */
        .roster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .roster-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .roster-card.captain-card {
            border-color: var(--teal);
        }

        .player-position {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--teal);
            margin-bottom: 5px;
        }

        .player-name-roster {
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .player-stats-mini {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .stat-mini {
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-mini-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .stat-mini-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--yellow);
        }

        /* Contact Section */
        .contact-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .contact-section h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
            margin-bottom: 15px;
        }

        .contact-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 15px;
        }

        .contact-textarea:focus {
            outline: none;
            border-color: var(--teal);
        }

        .recipient-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .recipient-checkboxes label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .send-btn {
            background: linear-gradient(180deg, var(--teal) 0%, #5ba3b5 100%);
            border: 3px solid #000;
            border-radius: 10px;
            padding: 14px 30px;
            color: #000;
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        }

        .send-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }

        /* Captain Sub-tabs */
        .captain-subtabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .captain-subtab {
            background: rgba(0,0,0,0.3);
            border: 2px solid var(--border-color);
            padding: 10px 18px;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            color: white;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .captain-subtab:hover {
            background: rgba(255,255,255,0.1);
        }

        .captain-subtab.active {
            background: var(--teal);
            color: #000;
            border-color: var(--teal);
        }

        .captain-subcontent {
            display: none;
        }

        .captain-subcontent.active {
            display: block;
        }

        /* Lineup Builder */
        .lineup-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .lineup-game {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            color: var(--pink);
            min-width: 80px;
        }

        .lineup-select {
            flex: 1;
            padding: 10px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .action-btn {
            flex: 1;
            min-width: 150px;
            padding: 14px 20px;
            background: rgba(255,255,255,0.08);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
            text-decoration: none;
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: var(--pink);
        }

        .action-btn.primary {
            background: linear-gradient(180deg, var(--pink) 0%, #d63384 100%);
            border-color: #000;
        }

        /* Subs List */
        .subs-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .sub-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
        }

        .sub-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .sub-info {
            font-size: 13px;
            color: var(--text-dim);
            margin-bottom: 10px;
        }

        .sub-btn {
            padding: 8px 16px;
            background: var(--teal);
            border: 2px solid #000;
            border-radius: 6px;
            color: #000;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
        }

        /* Recent Messages Section */
        .messages-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .messages-section h3 {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--teal);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .conversation-item:hover {
            background: rgba(255,255,255,0.08);
        }

        .conversation-item.unread {
            border-left: 3px solid var(--pink);
        }

        .conversation-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--pink), var(--teal));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .conversation-preview {
            font-size: 12px;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            font-size: 11px;
            color: var(--text-dim);
        }

        .conversation-unread-badge {
            background: var(--pink);
            color: white;
            font-size: 10px;
            font-weight: 700;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view-all-link {
            display: block;
            text-align: center;
            color: var(--teal);
            font-size: 13px;
            padding: 10px;
            margin-top: 10px;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.15s;
        }

        .view-all-link:hover {
            background: rgba(145, 215, 235, 0.1);
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            .profile-header {
                gap: 12px;
            }
            .profile-name {
                font-size: 20px;
            }
            .profile-stats-row {
                gap: 12px;
            }
            .profile-stat-value {
                font-size: 18px;
            }
            .admin-btn {
                padding: 6px 10px;
                font-size: 11px;
            }
            .tab {
                padding: 10px 12px;
                font-size: 13px;
            }
            .tab-container {
                gap: 3px;
            }
            .calendar-container {
                padding: 12px;
            }
            .cal-day {
                min-height: 36px;
                font-size: 13px;
            }
            .team-cards-grid {
                grid-template-columns: 1fr;
            }
            .settings-section {
                padding: 15px;
            }
            .setting-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Initial Loading Screen (shown while checking session) -->
    <div id="initialLoader" style="display: flex; flex-direction: column; align-items: center; justify-content: center; position: fixed; inset: 0; background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%); z-index: 9999;">
        <img src="/images/gold_logo.png" alt="BRDC" style="height: 80px; margin-bottom: 20px;">
        <div style="width: 40px; height: 40px; border: 3px solid rgba(255,70,154,0.3); border-top-color: #FF469A; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
    </div>

    <!-- Login Page (hidden initially) -->
    <div class="login-page" id="loginPage" style="display: none;">
        <img src="/images/gold_logo.png" alt="BRDC" class="login-logo">
        <h1 class="login-title">BRDC DASHBOARD</h1>

        <div class="login-box">
            <div class="login-form-title">LOGIN</div>

            <div class="login-error" id="loginError" style="display: none;"></div>

            <div class="form-group">
                <label class="form-label">Your 8-Digit PIN</label>
                <input type="password" class="form-input" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" inputmode="numeric" pattern="[0-9]*" autocomplete="off">
            </div>

            <button class="login-btn" id="loginBtn" onclick="login()">LOGIN</button>

            <div class="login-links">
                <a href="#" onclick="showForgotPin()">Forgot PIN?</a>
                <span style="color: var(--text-dim); margin: 0 10px;">|</span>
                <a href="/pages/register.html">New Player? Register</a>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div class="dashboard-content" id="dashboardContent">
        <div class="header-bar">
            <a href="/" style="text-decoration: none;">
                <img src="/images/gold_logo.png" alt="BRDC" class="header-logo" style="cursor: pointer;">
            </a>
            <span class="header-title">DASHBOARD</span>
            <button class="logout-btn" onclick="logout()">LOGOUT</button>
        </div>

        <div class="container">
            <!-- Profile Header - Clean Design -->
            <div class="profile-header">
                <div class="player-avatar" id="playerAvatar" title="Click to change photo">
                    <span id="avatarEmoji">üë§</span>
                    <img id="avatarImage" style="display: none;" alt="Profile">
                    <div class="avatar-edit-overlay">üì∑</div>
                    <input type="file" class="avatar-input" id="avatarInput" accept="image/*">
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="welcomeName">Welcome!</div>
                    <div class="profile-stats-row">
                        <div class="profile-stat">
                            <span class="profile-stat-value" id="statAvg">-</span>
                            <span class="profile-stat-label">501</span>
                        </div>
                        <div class="profile-stat">
                            <span class="profile-stat-value" id="statMpr">-</span>
                            <span class="profile-stat-label">MPR</span>
                        </div>
                    </div>
                    <a href="/pages/player-profile.html" class="profile-link" id="fullStatsLink">View Full Profile ‚Üí</a>
                </div>
                <div class="profile-actions">
                    <button class="settings-icon-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
                    <a href="/pages/admin.html" class="admin-btn" id="adminLink" style="display: none;">
                        üîß ADMIN
                    </a>
                </div>
            </div>

            <!-- Main Tabs -->
            <div class="tab-container">
                <div class="tab active" onclick="switchTab('schedule')">üìÖ SCHEDULE</div>
                <div class="tab" onclick="switchTab('activity')">üéØ ACTIVITY</div>
                <div class="tab captain-tab" id="captainTabBtn" onclick="switchTab('captain')">üö¢ CAPTAIN</div>
                <div class="tab director-tab" id="directorTabBtn" onclick="switchTab('director')" style="display: none;">üëë DIRECTOR</div>
            </div>

            <!-- SCHEDULE Tab (formerly teams) -->
            <div id="scheduleTab" class="tab-content active">
                <!-- Calendar View -->
                <div class="calendar-container" id="calendarContainer">
                    <div class="calendar-header">
                        <button class="cal-nav" onclick="changeMonth(-1)">‚óÄ</button>
                        <span class="cal-month" id="calMonth">January 2026</span>
                        <button class="cal-nav" onclick="changeMonth(1)">‚ñ∂</button>
                    </div>
                    <div class="calendar-grid">
                        <div class="cal-day-header">Sun</div>
                        <div class="cal-day-header">Mon</div>
                        <div class="cal-day-header">Tue</div>
                        <div class="cal-day-header">Wed</div>
                        <div class="cal-day-header">Thu</div>
                        <div class="cal-day-header">Fri</div>
                        <div class="cal-day-header">Sat</div>
                    </div>
                    <div class="calendar-days" id="calendarDays">
                        <!-- Days filled by JS -->
                    </div>

                    <!-- Calendar Legend -->
                    <div class="calendar-legend">
                        <div class="legend-item"><span class="legend-dot league"></span>League Match</div>
                        <div class="legend-item"><span class="legend-dot tournament"></span>My Tournament</div>
                        <div class="legend-item"><span class="legend-dot upcoming-tournament"></span>Upcoming Tournament</div>
                        <div class="legend-item"><span class="legend-dot deadline"></span>Registration Deadline</div>
                        <div class="legend-item"><span class="legend-dot social"></span>Social/Casual</div>
                    </div>
                </div>

                <!-- Event Popup -->
                <div class="event-popup" id="eventPopup" style="display: none;">
                    <div class="event-popup-header">
                        <span id="eventPopupDate">January 15, 2026</span>
                        <button class="popup-close" onclick="closeEventPopup()">‚úï</button>
                    </div>
                    <div class="event-popup-content" id="eventPopupContent">
                        <!-- Events for selected day -->
                    </div>
                </div>

                <!-- Recent Messages Section -->
                <div class="messages-section" id="recentMessagesSection" style="display: none;">
                    <h3>RECENT MESSAGES <span id="totalUnreadCount" style="font-size: 14px; color: var(--pink);"></span></h3>
                    <div id="recentMessagesList">
                        <div class="empty-state">Loading...</div>
                    </div>
                    <a href="/pages/messages.html" class="view-all-link">View All Messages ‚Üí</a>
                </div>

                <div class="action-buttons">
                    <a href="/pages/messages.html" class="action-btn">MESSAGES</a>
                    <a href="/pages/browse-events.html" class="action-btn">BROWSE EVENTS</a>
                </div>
            </div>

            <!-- CAPTAIN Tab -->
            <div id="captainTab" class="tab-content">
                <div class="team-selector" id="captainTeamSelector">
                    <label>SELECT TEAM TO MANAGE</label>
                    <select id="captainTeamSelect" onchange="loadCaptainTeam()"></select>
                </div>

                <!-- Team Name Editor -->
                <div class="team-name-editor" id="teamNameEditor" style="display: none;">
                    <div class="team-name-display">
                        <span class="team-name-label">TEAM NAME:</span>
                        <span class="team-name-value" id="currentTeamName">-</span>
                        <button class="edit-team-name-btn" onclick="showTeamNameEdit()">‚úèÔ∏è EDIT</button>
                    </div>
                    <div class="team-name-edit" id="teamNameEditForm" style="display: none;">
                        <input type="text" id="newTeamNameInput" placeholder="Enter new team name" maxlength="50">
                        <div class="team-name-buttons">
                            <button class="save-name-btn" onclick="saveTeamName()">SAVE</button>
                            <button class="cancel-name-btn" onclick="cancelTeamNameEdit()">CANCEL</button>
                        </div>
                    </div>
                </div>

                <!-- Captain Sub-tabs -->
                <div class="captain-subtabs">
                    <div class="captain-subtab active" onclick="switchCaptainSubtab('roster')">ROSTER</div>
                    <div class="captain-subtab" onclick="switchCaptainSubtab('schedule')">SCHEDULE</div>
                    <div class="captain-subtab" onclick="switchCaptainSubtab('lineup')">SET LINEUP</div>
                    <div class="captain-subtab" onclick="switchCaptainSubtab('subs')">SUBS</div>
                    <div class="captain-subtab" onclick="switchCaptainSubtab('contact')">üì± CONTACT</div>
                </div>

                <!-- Roster Sub-content -->
                <div id="captainRoster" class="captain-subcontent active">
                    <div class="roster-grid" id="rosterGrid">
                        <div class="empty-state">Loading roster...</div>
                    </div>
                </div>

                <!-- Schedule Sub-content -->
                <div id="captainSchedule" class="captain-subcontent">
                    <div id="captainScheduleTable">
                        <div class="empty-state">Loading schedule...</div>
                    </div>
                </div>

                <!-- Lineup Sub-content -->
                <div id="captainLineup" class="captain-subcontent">
                    <div class="team-selector">
                        <label>SELECT MATCH</label>
                        <select id="lineupMatchSelect" onchange="loadLineupForMatch()">
                            <option value="">-- Select upcoming match --</option>
                        </select>
                    </div>
                    <div id="lineupBuilder" style="display: none;"></div>
                    <button class="send-btn" onclick="saveLineup()" style="margin-top: 15px; display: none;" id="saveLineupBtn">üíæ SAVE LINEUP</button>
                </div>

                <!-- Subs Sub-content -->
                <div id="captainSubs" class="captain-subcontent">
                    <div class="subs-list" id="subsList">
                        <div class="empty-state">Loading subs...</div>
                    </div>
                </div>

                <!-- Contact Sub-content -->
                <div id="captainContact" class="captain-subcontent">
                    <div class="contact-section">
                        <h3>üí¨ MESSAGE YOUR TEAM</h3>
                        <div class="recipient-checkboxes">
                            <label><input type="checkbox" id="contactAllPlayers" checked> All Players</label>
                            <label><input type="checkbox" id="contactSubs"> Subs Only</label>
                        </div>
                        <p style="font-size: 12px; color: var(--text-dim); margin-bottom: 10px;">Insert:
                            <span style="color: var(--teal); cursor: pointer;" onclick="insertCaptainTag('[first_name]')">[first_name]</span>
                            <span style="color: var(--teal); cursor: pointer;" onclick="insertCaptainTag('[next_match_date]')">[next_match_date]</span>
                        </p>
                        <textarea id="captainMessage" class="contact-textarea" placeholder="Type your message to the team..."></textarea>
                        <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; background: rgba(255,70,154,0.1); border: 2px solid var(--pink); border-radius: 8px;">
                                <input type="checkbox" id="alsoSendSMS" style="width: 18px; height: 18px; accent-color: var(--pink);">
                                <span style="font-size: 14px; font-weight: 600;">üì± Also send as TEXT</span>
                            </label>
                        </div>
                        <button class="send-btn" onclick="sendTeamMessage()">üí¨ SEND MESSAGE</button>
                    </div>
                </div>
            </div>

            <!-- ACTIVITY Tab (leagues, tournaments, history, stats) -->
            <div id="activityTab" class="tab-content">
                <div class="sub-tab-container">
                    <div class="sub-tab active" onclick="switchActivitySubTab('leagues')">üèÜ Leagues</div>
                    <div class="sub-tab" onclick="switchActivitySubTab('tournaments')">üéØ Tournaments</div>
                    <div class="sub-tab" onclick="switchActivitySubTab('history')">üìú History</div>
                    <div class="sub-tab" onclick="switchActivitySubTab('stats')">üìä Stats</div>
                </div>
                <div id="leaguesSubTab" class="sub-tab-content active">
                    <div id="leaguesContent">
                        <div class="empty-state">Loading leagues...</div>
                    </div>
                </div>
                <div id="tournamentsSubTab" class="sub-tab-content">
                    <div id="tournamentsContent">
                        <div class="empty-state">Loading tournaments...</div>
                    </div>
                </div>
                <div id="historySubTab" class="sub-tab-content">
                    <div class="history-filters">
                        <select id="historyLeagueFilter" onchange="filterMatchHistory()">
                            <option value="all">All Leagues</option>
                        </select>
                        <select id="historyGameFilter" onchange="filterMatchHistory()">
                            <option value="all">All Games</option>
                            <option value="x01">501 Only</option>
                            <option value="cricket">Cricket Only</option>
                        </select>
                    </div>
                    <div id="matchHistoryContent">
                        <div class="empty-state">Loading match history...</div>
                    </div>
                </div>
                <!-- Stats Sub-Tab (inside Activity) -->
                <div id="statsSubTab" class="sub-tab-content">
                    <!-- Stats Overview Cards -->
                    <div class="stats-overview" id="statsOverview">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalMatches">-</div>
                        <div class="stat-label">Matches Played</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statWinRate">-</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statOverall3DA">-</div>
                        <div class="stat-label">Overall 3DA</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statOverallMPR">-</div>
                        <div class="stat-label">Overall MPR</div>
                    </div>
                </div>

                <!-- X01 Stats Section -->
                <div class="stats-section">
                    <h3>501 Statistics</h3>
                    <div class="stats-grid" id="x01StatsGrid">
                        <div class="stat-row">
                            <span class="stat-name">3-Dart Average</span>
                            <span class="stat-val" id="stat501Avg">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">First 9 Average</span>
                            <span class="stat-val" id="stat501First9">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Checkout %</span>
                            <span class="stat-val" id="stat501Checkout">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Avg Checkout</span>
                            <span class="stat-val" id="stat501AvgOut">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">High Checkout</span>
                            <span class="stat-val" id="stat501HighOut">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Legs Won/Played</span>
                            <span class="stat-val" id="stat501Legs">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">180s</span>
                            <span class="stat-val" id="stat501_180s">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">140+</span>
                            <span class="stat-val" id="stat501_140s">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">100+</span>
                            <span class="stat-val" id="stat501_100s">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">High Score</span>
                            <span class="stat-val" id="stat501High">-</span>
                        </div>
                    </div>
                </div>

                <!-- Cricket Stats Section -->
                <div class="stats-section">
                    <h3>Cricket Statistics</h3>
                    <div class="stats-grid" id="cricketStatsGrid">
                        <div class="stat-row">
                            <span class="stat-name">Marks Per Round</span>
                            <span class="stat-val" id="statCricketMPR">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Legs Won/Played</span>
                            <span class="stat-val" id="statCricketLegs">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Win Rate</span>
                            <span class="stat-val" id="statCricketWinRate">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Total Marks</span>
                            <span class="stat-val" id="statCricketMarks">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">Total Rounds</span>
                            <span class="stat-val" id="statCricketRounds">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">6+ Mark Rounds</span>
                            <span class="stat-val" id="statCricket6Mark">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">9 Mark Rounds</span>
                            <span class="stat-val" id="statCricket9Mark">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">High Round</span>
                            <span class="stat-val" id="statCricketHighRound">-</span>
                        </div>
                    </div>
                </div>

                <!-- Achievements Section -->
                <div class="stats-section">
                    <h3>Achievements</h3>
                    <div class="achievements-grid" id="achievementsGrid">
                        <div class="empty-state">Loading achievements...</div>
                    </div>
                </div>
                </div><!-- End statsSubTab -->
            </div><!-- End activityTab -->

            <!-- DIRECTOR Tab -->
            <div id="directorTab" class="tab-content">
                <div class="director-section">
                    <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--yellow); margin-bottom: 20px;">üëë Leagues You're Directing</h3>
                    <div id="directorLeaguesList" class="director-list">
                        <div class="empty-state">Loading...</div>
                    </div>
                </div>
                <div class="director-section" style="margin-top: 30px;">
                    <h3 style="font-family: 'Bebas Neue', cursive; font-size: 24px; color: var(--teal); margin-bottom: 20px;">üèÜ Tournaments You're Directing</h3>
                    <div id="directorTournamentsList" class="director-list">
                        <div class="empty-state">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS Tab -->
            <div id="settingsTab" class="tab-content">
                <!-- Edit Profile Section -->
                <div class="settings-section">
                    <h3>Edit Profile</h3>

                    <!-- First Name (locked) -->
                    <div class="profile-field" id="firstNameField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">First Name</div>
                            <div class="profile-field-value" id="firstNameValue">-</div>
                            <div class="field-locked-hint">Contact admin to change first name</div>
                        </div>
                        <div class="profile-field-edit">
                            <input type="text" id="editFirstName">
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn disabled" title="Contact admin to change">Locked</button>
                        </div>
                    </div>

                    <!-- Last Name (editable) -->
                    <div class="profile-field" id="lastNameField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">Last Name</div>
                            <div class="profile-field-value" id="lastNameValue">-</div>
                        </div>
                        <div class="profile-field-edit">
                            <input type="text" id="editLastName">
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn" onclick="startEditField('lastName')">Edit</button>
                            <button class="save-field-btn" onclick="saveField('lastName')">‚úì</button>
                            <button class="cancel-field-btn" onclick="cancelEditField('lastName')">‚úï</button>
                        </div>
                    </div>

                    <!-- Phone (editable) -->
                    <div class="profile-field" id="phoneField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">Phone</div>
                            <div class="profile-field-value" id="phoneValue">-</div>
                        </div>
                        <div class="profile-field-edit">
                            <input type="tel" id="editPhone" placeholder="(555) 123-4567">
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn" onclick="startEditField('phone')">Edit</button>
                            <button class="save-field-btn" onclick="saveField('phone')">‚úì</button>
                            <button class="cancel-field-btn" onclick="cancelEditField('phone')">‚úï</button>
                        </div>
                    </div>

                    <!-- Email (editable) -->
                    <div class="profile-field" id="emailField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">Email</div>
                            <div class="profile-field-value" id="emailValue">-</div>
                        </div>
                        <div class="profile-field-edit">
                            <input type="email" id="editEmail" placeholder="you@example.com">
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn" onclick="startEditField('email')">Edit</button>
                            <button class="save-field-btn" onclick="saveField('email')">‚úì</button>
                            <button class="cancel-field-btn" onclick="cancelEditField('email')">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- Privacy Settings Section -->
                <div class="settings-section">
                    <h3>Privacy Settings</h3>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Show Phone Number</div>
                            <div class="privacy-desc">Allow other players to see your phone number on your profile</div>
                        </div>
                        <div class="privacy-toggle" id="privacyPhone" onclick="togglePrivacy('show_phone')"></div>
                    </div>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Show Email Address</div>
                            <div class="privacy-desc">Allow other players to see your email on your profile</div>
                        </div>
                        <div class="privacy-toggle" id="privacyEmail" onclick="togglePrivacy('show_email')"></div>
                    </div>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Public Stats</div>
                            <div class="privacy-desc">Show your stats on public leaderboards and profiles</div>
                        </div>
                        <div class="privacy-toggle on" id="privacyStats" onclick="togglePrivacy('show_stats')"></div>
                    </div>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Allow Messages</div>
                            <div class="privacy-desc">Receive direct messages from other players</div>
                        </div>
                        <div class="privacy-toggle on" id="privacyMessages" onclick="togglePrivacy('allow_messages')"></div>
                    </div>
                </div>

                <!-- Notifications Section -->
                <div class="settings-section">
                    <h3>Notifications</h3>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">SMS Text Messages</div>
                            <div class="privacy-desc">Receive match reminders and updates via text</div>
                        </div>
                        <div class="privacy-toggle on" id="notifySms" onclick="toggleNotification('sms')"></div>
                    </div>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Email Notifications</div>
                            <div class="privacy-desc">Receive updates and announcements via email</div>
                        </div>
                        <div class="privacy-toggle" id="notifyEmail" onclick="toggleNotification('email')"></div>
                    </div>

                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Push Notifications</div>
                            <div class="privacy-desc">Receive instant alerts on your device</div>
                        </div>
                        <div class="privacy-toggle" id="notifyPush" onclick="toggleNotification('push')"></div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div class="settings-section">
                    <h3>Profile</h3>

                    <!-- Bio -->
                    <div class="profile-field" id="bioField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">Bio</div>
                            <div class="profile-field-value" id="bioValue">Not set</div>
                        </div>
                        <div class="profile-field-edit">
                            <textarea id="editBio" maxlength="200" placeholder="Tell us about yourself..." style="width: 100%; padding: 8px 12px; background: var(--bg-dark); border: 2px solid var(--teal); border-radius: 6px; color: white; font-size: 14px; min-height: 60px; resize: vertical;"></textarea>
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn" onclick="startEditField('bio')">Edit</button>
                            <button class="save-field-btn" onclick="saveField('bio')">‚úì</button>
                            <button class="cancel-field-btn" onclick="cancelEditField('bio')">‚úï</button>
                        </div>
                    </div>

                    <!-- Home Bar -->
                    <div class="profile-field" id="homeBarField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">Home Bar</div>
                            <div class="profile-field-value" id="homeBarValue">Not set</div>
                        </div>
                        <div class="profile-field-edit">
                            <input type="text" id="editHomeBar" maxlength="100" placeholder="Where do you usually play?">
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn" onclick="startEditField('homeBar')">Edit</button>
                            <button class="save-field-btn" onclick="saveField('homeBar')">‚úì</button>
                            <button class="cancel-field-btn" onclick="cancelEditField('homeBar')">‚úï</button>
                        </div>
                    </div>

                    <!-- Preferred Game -->
                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Preferred Game</div>
                            <div class="privacy-desc">Your favorite game type</div>
                        </div>
                        <select id="preferredGame" onchange="savePreferredGame()" style="padding: 8px 12px; background: var(--bg-dark); border: 2px solid var(--border-color); border-radius: 6px; color: white; font-size: 14px;">
                            <option value="">No preference</option>
                            <option value="501">501</option>
                            <option value="cricket">Cricket</option>
                        </select>
                    </div>
                </div>

                <!-- Integrations Section -->
                <div class="settings-section">
                    <h3>Integrations</h3>

                    <!-- DartConnect ID -->
                    <div class="profile-field" id="dartconnectField">
                        <div class="profile-field-info">
                            <div class="profile-field-label">DartConnect Player ID</div>
                            <div class="profile-field-value" id="dartconnectValue">Not linked</div>
                            <div class="field-locked-hint">Find your ID in your DartConnect profile URL</div>
                        </div>
                        <div class="profile-field-edit">
                            <input type="text" id="editDartconnect" placeholder="e.g., 12345">
                        </div>
                        <div class="profile-field-actions">
                            <button class="edit-btn" onclick="startEditField('dartconnect')">Link</button>
                            <button class="save-field-btn" onclick="saveField('dartconnect')">‚úì</button>
                            <button class="cancel-field-btn" onclick="cancelEditField('dartconnect')">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- Account Section -->
                <div class="settings-section">
                    <h3>Account</h3>

                    <!-- Current PIN display -->
                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Your PIN</div>
                            <div class="privacy-desc" id="currentPinDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
                        </div>
                        <button class="edit-btn" onclick="togglePinVisibility()" id="showPinBtn">Show</button>
                    </div>

                    <!-- Generate New PIN -->
                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Generate New PIN</div>
                            <div class="privacy-desc">Get a new random PIN (old one will stop working)</div>
                        </div>
                        <button class="edit-btn" onclick="generateNewPin()" style="background: rgba(255,70,154,0.2); border-color: var(--pink); color: var(--pink);">New PIN</button>
                    </div>

                    <!-- Export Data -->
                    <div class="privacy-setting">
                        <div class="privacy-info">
                            <div class="privacy-title">Export My Data</div>
                            <div class="privacy-desc">Download all your stats and profile data</div>
                        </div>
                        <button class="edit-btn" onclick="exportMyData()">Export</button>
                    </div>

                    <!-- Delete Account -->
                    <div class="privacy-setting" style="border-bottom: none;">
                        <div class="privacy-info">
                            <div class="privacy-title" style="color: var(--danger);">Delete Account</div>
                            <div class="privacy-desc">Permanently delete your account and all data</div>
                        </div>
                        <button class="edit-btn" onclick="confirmDeleteAccount()" style="background: rgba(239,68,68,0.2); border-color: var(--danger); color: var(--danger);">Delete</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Floating Chat Button with Expandable Menu -->
    <div class="chat-bubble-container" id="chatBubbleContainer">
        <!-- Expanded Menu -->
        <div class="chat-expanded-menu">
            <!-- Chat Rooms (vertical) -->
            <div class="chat-rooms-section" id="chatRoomsSection">
                <!-- Rooms will be inserted by JS -->
            </div>
            <!-- DMs (horizontal) -->
            <div class="chat-dms-section" id="chatDmsSection">
                <!-- DMs will be inserted by JS -->
            </div>
        </div>
        <!-- Main Button -->
        <button class="floating-chat-btn" onclick="toggleChatMenu()" title="Messages">
            üí¨
            <span class="unread-badge hidden" id="headerUnreadBadge">0</span>
        </button>
    </div>

    <!-- Director Selector Modal -->
    <div id="directorModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-panel); border: 4px solid #000; border-radius: 16px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 8px 8px 0 rgba(0,0,0,0.5);">
            <h3 style="font-family: 'Bebas Neue', cursive; font-size: 28px; margin-bottom: 20px; color: var(--yellow);">üëë SELECT LEAGUE</h3>
            <select id="directorLeagueSelect" style="width: 100%; padding: 14px; background: var(--bg-dark); border: 2px solid var(--border-color); border-radius: 8px; color: white; font-size: 16px; margin-bottom: 20px;"></select>
            <div style="display: flex; gap: 10px;">
                <button class="action-btn" onclick="closeDirectorModal()" style="flex: 1;">CANCEL</button>
                <button class="action-btn primary" onclick="goToDirectorDashboard()" style="flex: 1;">OPEN</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { callFunction, uploadImage, showLoading, hideLoading, db } from '/js/firebase-config.js';
        import { collection, doc, getDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Dynamic import for push notifications (fail-safe)
        let initializePushNotifications = async () => false;
        try {
            const pushModule = await import('/js/push-notifications.js');
            initializePushNotifications = pushModule.initializePushNotifications;
        } catch (e) {
            console.warn('Push notifications not available:', e.message);
        }

        let currentPlayer = null;
        let dashboardData = null;
        let selectedTeamId = null;
        let selectedCaptainTeamId = null;
        let captainTeamData = null;

        // Avatar upload handling
        document.getElementById('avatarInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                return;
            }

            if (!currentPlayer) {
                alert('Please log in first');
                return;
            }

            showLoading('Uploading photo...');
            try {
                const photoUrl = await uploadImage(file, 'players');

                // Update player profile with new photo
                const result = await callFunction('updateGlobalPlayer', {
                    player_id: currentPlayer.id,
                    photo_url: photoUrl
                });

                if (result.success) {
                    // Show the uploaded image
                    document.getElementById('avatarImage').src = photoUrl;
                    document.getElementById('avatarImage').style.display = 'block';
                    document.getElementById('avatarEmoji').style.display = 'none';
                    currentPlayer.photo_url = photoUrl;
                }
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Photo upload failed:', error);
                alert('Failed to upload photo. Please try again.');
            }
        });

        // Check for saved session
        window.onload = function() {
            const savedSession = localStorage.getItem('brdc_session');
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    if (session.player_id) {
                        loadDashboard(session.player_id, session.source_type, session.league_id);
                        return;
                    }
                } catch (e) {
                    localStorage.removeItem('brdc_session');
                }
            }
            showLoginPage();
        };

        function hideInitialLoader() {
            const loader = document.getElementById('initialLoader');
            if (loader) loader.style.display = 'none';
        }

        function showLoginPage() {
            hideInitialLoader();
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function showDashboard() {
            hideInitialLoader();
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
        }

        window.login = async function() {
            const pin = document.getElementById('pinInput').value.trim();
            const errorDiv = document.getElementById('loginError');
            const btn = document.getElementById('loginBtn');

            errorDiv.style.display = 'none';

            if (pin.length !== 8) {
                errorDiv.textContent = 'Please enter your 8-digit PIN';
                errorDiv.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'LOGGING IN...';

            try {
                const result = await callFunction('globalLogin', { pin: pin });

                if (result.success) {
                    currentPlayer = result.player;
                    localStorage.setItem('brdc_session', JSON.stringify({
                        player_id: currentPlayer.id,
                        name: currentPlayer.name,
                        pin: pin, // Save PIN for messaging
                        source_type: currentPlayer.source_type || 'global',
                        league_id: currentPlayer.league_id || null,
                        logged_in_at: Date.now()
                    }));
                    loadDashboard(currentPlayer.id, currentPlayer.source_type, currentPlayer.league_id);
                } else {
                    errorDiv.textContent = result.error || 'Login failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = error.message || 'Login failed. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'LOGIN';
            }
        };

        async function loadDashboard(playerId, sourceType, leagueId) {
            try {
                const result = await callFunction('getDashboardData', {
                    player_id: playerId,
                    source_type: sourceType || 'global',
                    league_id: leagueId || null
                });

                if (result.success) {
                    dashboardData = result.dashboard;
                    currentPlayer = dashboardData.player;
                    renderDashboard();
                    showDashboard();

                    // Initialize push notifications after successful login
                    if (currentPlayer?.id) {
                        initializePushNotifications(currentPlayer.id).then(enabled => {
                            console.log('Push notifications:', enabled ? 'enabled' : 'not enabled');
                        }).catch(err => console.log('Push init error:', err));
                    }
                } else {
                    localStorage.removeItem('brdc_session');
                    showLoginPage();
                }
            } catch (error) {
                console.error('Load dashboard error:', error);
                localStorage.removeItem('brdc_session');
                showLoginPage();
            }
        }

        function renderDashboard() {
            const player = dashboardData.player;
            const roles = dashboardData.roles;

            // Profile header
            document.getElementById('welcomeName').textContent = player.name;

            // Show photo if exists, otherwise emoji
            if (player.photo_url) {
                document.getElementById('avatarImage').src = player.photo_url;
                document.getElementById('avatarImage').style.display = 'block';
                document.getElementById('avatarEmoji').style.display = 'none';
            } else {
                document.getElementById('avatarEmoji').textContent = player.isBot ? 'ü§ñ' : 'üë§';
                document.getElementById('avatarImage').style.display = 'none';
                document.getElementById('avatarEmoji').style.display = 'flex';
            }

            // Load notification settings (handled in populateSettingsForm)

            // Stats - handle multiple formats:
            // 1. Flat league stats (x01_legs_played, cricket_total_marks, etc.)
            // 2. unified_stats.totals format
            // 3. Global player format (stats.x01 / stats.cricket)
            const stats = player.stats || {};
            let x01Avg = '-';
            let mpr = '-';
            let ton180s = 0;
            let highOut = '-';
            let matchesPlayed = 0;
            let matchesWon = 0;
            let first9Avg = '-';
            let checkoutEff = '-';

            // Check for flat league stats format (from stats collection)
            if (stats.x01_total_darts !== undefined || stats.x01_legs_played !== undefined) {
                // League stats collection format: flat fields
                x01Avg = stats.x01_total_darts > 0 ? (stats.x01_total_points / stats.x01_total_darts * 3).toFixed(1) : '-';
                mpr = stats.cricket_total_rounds > 0 ? (stats.cricket_total_marks / stats.cricket_total_rounds).toFixed(2) : '-';
                ton180s = stats.x01_tons_180 || stats.x01_ton_80 || stats.x01_ton_eighties || 0;
                highOut = stats.x01_high_checkout || '-';
                matchesPlayed = (stats.x01_legs_played || 0) + (stats.cricket_legs_played || 0);
                matchesWon = (stats.x01_legs_won || 0) + (stats.cricket_legs_won || 0);
                // New DartConnect-compatible stats
                first9Avg = stats.x01_first9_avg ? stats.x01_first9_avg.toFixed(1) :
                    (stats.x01_first9_darts > 0 ? (stats.x01_first9_points / stats.x01_first9_darts * 3).toFixed(1) : '-');
                checkoutEff = stats.x01_checkout_efficiency ? stats.x01_checkout_efficiency.toFixed(1) + '%' :
                    (stats.x01_checkout_opps > 0 ? (stats.x01_checkouts / stats.x01_checkout_opps * 100).toFixed(1) + '%' : '-');
            }
            // Check for unified_stats format (league players)
            else if (stats.totals) {
                // League player format: unified_stats.totals
                const totals = stats.totals;
                // Use canonical field x01_three_dart_avg or legacy three_dart_avg
                x01Avg = totals.x01_three_dart_avg ? totals.x01_three_dart_avg.toFixed(1) :
                    (totals.three_dart_avg ? totals.three_dart_avg.toFixed(1) : '-');
                mpr = totals.cricket_mpr ? totals.cricket_mpr.toFixed(2) : '-';
                ton180s = totals.ton_eighties || totals['180s'] || 0;
                highOut = totals.high_checkout || '-';
                matchesPlayed = totals.matches_played || totals.legs_played || 0;
                matchesWon = totals.matches_won || totals.legs_won || 0;
                first9Avg = totals.first9_avg ? totals.first9_avg.toFixed(1) : '-';
                checkoutEff = totals.checkout_efficiency ? totals.checkout_efficiency.toFixed(1) + '%' : '-';
            } else {
                // Global player format: stats.x01 / stats.cricket
                const x01 = stats.x01 || {};
                const cricket = stats.cricket || {};
                x01Avg = x01.total_darts > 0 ? (x01.total_points / x01.total_darts * 3).toFixed(1) : '-';
                mpr = cricket.total_rounds > 0 ? (cricket.total_marks / cricket.total_rounds).toFixed(2) : '-';
                ton180s = x01.ton_eighties || 0;
                highOut = x01.high_checkout || '-';
                matchesPlayed = stats.matches_played || 0;
                matchesWon = stats.matches_won || 0;
                first9Avg = x01.first9_avg ? x01.first9_avg.toFixed(1) : '-';
                checkoutEff = x01.checkout_efficiency ? x01.checkout_efficiency.toFixed(1) + '%' : '-';
            }

            document.getElementById('statAvg').textContent = x01Avg;
            document.getElementById('statMpr').textContent = mpr;

            // Full stats link - include league_id for league players
            let statsUrl = `/pages/player-profile.html?player_id=${player.id}`;
            if (player.league_id) {
                statsUrl += `&league_id=${player.league_id}`;
            }
            document.getElementById('fullStatsLink').href = statsUrl;

            // Admin link (show for admins only)
            if (player.isAdmin) {
                document.getElementById('adminLink').style.display = 'block';
            }

            // Director tab (show if directing any leagues/tournaments)
            if (roles.directing && roles.directing.length > 0) {
                document.getElementById('directorTabBtn').classList.add('show');
                document.getElementById('directorTabBtn').style.display = 'block';
                populateDirectorTab(roles.directing);
            }

            // Captain tab (show if captain of any teams)
            if (roles.captaining && roles.captaining.length > 0) {
                document.getElementById('captainTabBtn').classList.add('show');
                document.getElementById('captainTabBtn').style.display = 'block';
                populateCaptainTeamSelect(roles.captaining);
            }

            // Teams tab - populate team selector
            console.log('roles.playing:', roles.playing);
            if (roles.playing && roles.playing.length > 0) {
                populateTeamSelect(roles.playing);
            }

            // Load calendar (default tab)
            console.log('allTeams before loadCalendar:', allTeams);
            loadCalendar();

            // Load recent messages
            loadRecentMessages();
        }

        // ============================================================================
        // MESSAGING FUNCTIONS
        // ============================================================================

        async function loadRecentMessages() {
            if (!currentPlayer) return;

            // Get PIN from session for messaging functions
            const session = JSON.parse(localStorage.getItem('brdc_session') || '{}');
            const playerPin = session.pin || currentPlayer.pin;

            // Skip if no PIN available (messaging requires PIN)
            if (!playerPin) {
                console.log('No PIN available for messaging');
                return;
            }

            try {
                // Get conversations for this player
                const result = await callFunction('getConversations', {
                    player_pin: playerPin,
                    limit: 5
                });

                if (result.success && result.conversations && result.conversations.length > 0) {
                    renderRecentMessages(result.conversations);
                    document.getElementById('recentMessagesSection').style.display = 'block';
                }

                // Get unread count for header badge
                const unreadResult = await callFunction('getUnreadCount', {
                    player_pin: playerPin
                });

                if (unreadResult.success) {
                    updateUnreadBadge(unreadResult.total_unread || 0);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function renderRecentMessages(conversations) {
            const container = document.getElementById('recentMessagesList');

            if (!conversations || conversations.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><p>No messages yet</p></div>';
                return;
            }

            let totalUnread = 0;
            let html = '';

            conversations.forEach(conv => {
                const unreadCount = conv.unread_count || 0;
                totalUnread += unreadCount;

                // Get other participant name
                const otherName = conv.other_participant_name || 'Unknown';
                const initials = otherName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

                // Format time
                const timeStr = formatMessageTime(conv.last_message?.timestamp);
                const preview = conv.last_message?.text || 'No messages';

                html += `
                    <div class="conversation-item ${unreadCount > 0 ? 'unread' : ''}" onclick="openConversation('${conv.id}')">
                        <div class="conversation-avatar">${initials}</div>
                        <div class="conversation-info">
                            <div class="conversation-name">${otherName}</div>
                            <div class="conversation-preview">${preview.substring(0, 50)}${preview.length > 50 ? '...' : ''}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="conversation-time">${timeStr}</div>
                            ${unreadCount > 0 ? `<div class="conversation-unread-badge">${unreadCount}</div>` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // Update total unread count display
            if (totalUnread > 0) {
                document.getElementById('totalUnreadCount').textContent = `(${totalUnread} unread)`;
            } else {
                document.getElementById('totalUnreadCount').textContent = '';
            }
        }

        function formatMessageTime(timestamp) {
            if (!timestamp) return '';

            let date;
            if (timestamp._seconds) {
                date = new Date(timestamp._seconds * 1000);
            } else if (typeof timestamp === 'string') {
                date = new Date(timestamp);
            } else {
                date = new Date(timestamp);
            }

            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'now';
            if (minutes < 60) return `${minutes}m`;
            if (hours < 24) return `${hours}h`;
            if (days < 7) return `${days}d`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function updateUnreadBadge(count) {
            const badge = document.getElementById('headerUnreadBadge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        window.openConversation = function(conversationId) {
            window.location.href = `/pages/conversation.html?id=${conversationId}`;
        };

        window.goToMessages = function() {
            window.location.href = '/pages/messages.html';
        };

        // Chat bubble expansion
        let chatBubbleData = { rooms: [], dms: [] };

        window.toggleChatMenu = function() {
            const container = document.getElementById('chatBubbleContainer');
            const isExpanded = container.classList.contains('expanded');

            if (isExpanded) {
                container.classList.remove('expanded');
            } else {
                container.classList.add('expanded');
                loadChatBubbles();
            }
        };

        // Close chat menu when clicking outside
        document.addEventListener('click', function(e) {
            const container = document.getElementById('chatBubbleContainer');
            if (container && !container.contains(e.target) && container.classList.contains('expanded')) {
                container.classList.remove('expanded');
            }
        });

        async function loadChatBubbles() {
            if (!currentPlayer) return;

            const session = JSON.parse(localStorage.getItem('brdc_session') || '{}');
            const playerPin = session.pin || currentPlayer.pin;
            if (!playerPin) return;

            const roomsSection = document.getElementById('chatRoomsSection');
            const dmsSection = document.getElementById('chatDmsSection');

            try {
                // Load team/league chat rooms
                const rooms = [];

                // Add team chat rooms for teams player is on
                if (allTeams && allTeams.length > 0) {
                    allTeams.forEach(team => {
                        rooms.push({
                            id: `team_${team.team_id}`,
                            type: 'team',
                            name: team.team_name || 'Team Chat',
                            icon: 'üéØ',
                            unread: 0 // Would need real unread count from backend
                        });
                    });
                }

                // Render room circles (vertical)
                if (rooms.length > 0) {
                    roomsSection.innerHTML = rooms.map(room => `
                        <div class="chat-room-circle" onclick="openChatRoom('${room.id}')" title="${room.name}">
                            ${room.icon}
                            <span class="room-label">${room.name}</span>
                            ${room.unread > 0 ? `<span class="circle-badge">${room.unread}</span>` : ''}
                        </div>
                    `).join('');
                } else {
                    roomsSection.innerHTML = '';
                }

                // Load DM conversations
                const result = await callFunction('getConversations', {
                    player_pin: playerPin,
                    limit: 6
                });

                if (result.success && result.conversations && result.conversations.length > 0) {
                    const dms = result.conversations.map(conv => {
                        const otherName = conv.other_participant_name || 'Unknown';
                        const initial = otherName.charAt(0).toUpperCase();
                        const photoUrl = conv.other_participant_photo || null;
                        const participantCount = conv.participant_count || 2;

                        return {
                            id: conv.id,
                            name: otherName,
                            initial: initial,
                            photo: photoUrl,
                            unread: conv.unread_count || 0,
                            isGroup: participantCount > 2,
                            participants: conv.participants || []
                        };
                    });

                    // Render DM circles (horizontal)
                    dmsSection.innerHTML = dms.map(dm => {
                        if (dm.isGroup && dm.participants.length > 2) {
                            // Group DM - overlapping circles
                            const groupCircles = dm.participants.slice(0, 3).map((p, i) => {
                                const pInitial = (p.name || 'U').charAt(0).toUpperCase();
                                return `<div class="chat-dm-circle" style="z-index: ${3-i}">
                                    ${p.photo_url ? `<img src="${p.photo_url}" alt="">` : `<span class="dm-initial">${pInitial}</span>`}
                                </div>`;
                            }).join('');
                            return `
                                <div class="chat-dm-group" onclick="openConversation('${dm.id}')" title="${dm.name}">
                                    ${groupCircles}
                                    ${dm.unread > 0 ? `<span class="circle-badge" style="position: absolute; top: -4px; right: -4px;">${dm.unread}</span>` : ''}
                                </div>
                            `;
                        } else {
                            // Single DM
                            return `
                                <div class="chat-dm-circle" onclick="openConversation('${dm.id}')" title="${dm.name}">
                                    ${dm.photo ? `<img src="${dm.photo}" alt="">` : `<span class="dm-initial">${dm.initial}</span>`}
                                    ${dm.unread > 0 ? `<span class="circle-badge">${dm.unread}</span>` : ''}
                                </div>
                            `;
                        }
                    }).join('');
                } else {
                    dmsSection.innerHTML = '';
                }

                // If no rooms and no DMs, show a single "go to messages" option
                if (rooms.length === 0 && (!result.conversations || result.conversations.length === 0)) {
                    roomsSection.innerHTML = `
                        <div class="chat-room-circle" onclick="goToMessages()" title="Messages">
                            üì®
                            <span class="room-label">Open Messages</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading chat bubbles:', error);
                roomsSection.innerHTML = `
                    <div class="chat-room-circle" onclick="goToMessages()" title="Messages">
                        üì®
                        <span class="room-label">Open Messages</span>
                    </div>
                `;
            }
        }

        window.openChatRoom = function(roomId) {
            // For now, go to messages page - could be enhanced with room-specific view
            window.location.href = `/pages/messages.html?room=${roomId}`;
        };

        // Store all teams for "all teams" view
        let allTeams = [];

        function populateTeamSelect(teams) {
            if (teams.length === 0) return;
            allTeams = teams;
        }

        function populateCaptainTeamSelect(teams) {
            const select = document.getElementById('captainTeamSelect');
            select.innerHTML = teams.map(t =>
                `<option value="${t.league_id}|${t.team_id}">${t.team_name} - ${t.league_name}</option>`
            ).join('');

            // Auto-select first team
            if (teams.length > 0) {
                selectedCaptainTeamId = teams[0].team_id;
                loadCaptainTeam();
            }
        }

        let currentLeagueId = null;

        window.loadTeamSchedule = async function() {
            const select = document.getElementById('teamSelect');
            const container = document.getElementById('teamScheduleContainer');
            container.innerHTML = '<div class="empty-state">Loading schedule...</div>';

            // Handle "All Teams" view
            if (select.value === 'all') {
                await loadAllTeamsView();
                return;
            }

            const [leagueId, teamId] = select.value.split('|');
            selectedTeamId = teamId;
            currentLeagueId = leagueId;

            try {
                const result = await callFunction('getTeamScheduleEnhanced', {
                    league_id: leagueId,
                    team_id: teamId,
                    player_id: currentPlayer.id
                });

                if (result.success) {
                    renderTeamScheduleEnhanced(result);
                } else {
                    container.innerHTML = '<div class="empty-state">Could not load schedule</div>';
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
                container.innerHTML = '<div class="empty-state">Error loading schedule</div>';
            }
        };

        // Load view showing next match for each team
        async function loadAllTeamsView() {
            const container = document.getElementById('teamScheduleContainer');

            if (allTeams.length === 0) {
                container.innerHTML = '<div class="empty-state">No teams found</div>';
                return;
            }

            try {
                // Load schedule for each team in parallel
                const schedulePromises = allTeams.map(async (t) => {
                    const leagueId = t.id || t.league_id;
                    const result = await callFunction('getTeamScheduleEnhanced', {
                        league_id: leagueId,
                        team_id: t.team_id,
                        player_id: currentPlayer.id
                    });
                    return {
                        team: t,
                        leagueId,
                        ...result
                    };
                });

                const allSchedules = await Promise.all(schedulePromises);

                // Render "All Teams" view - show next upcoming match for each team
                let html = '<div class="match-cards-container">';

                allSchedules.forEach(schedule => {
                    if (!schedule.success) return;

                    const nextMatch = schedule.upcoming?.[0];
                    const teamName = schedule.team.team_name || 'My Team';
                    const leagueName = schedule.team.name || schedule.team.league_name || '';

                    html += `<div class="all-teams-section">`;
                    html += `<div class="all-teams-header" onclick="toggleTeamExpand('${schedule.team.team_id}')">
                        <span class="all-teams-title">${teamName}</span>
                        <span class="all-teams-league">${leagueName}</span>
                        <span class="all-teams-expand" id="expand-${schedule.team.team_id}">‚ñº</span>
                    </div>`;

                    if (nextMatch) {
                        currentLeagueId = schedule.leagueId;
                        html += `<div class="all-teams-next">${renderMatchCard(nextMatch, schedule.leagueId, false)}</div>`;
                    } else {
                        html += `<div class="empty-state" style="padding: 15px;">No upcoming matches</div>`;
                    }

                    // Hidden section for full schedule
                    html += `<div class="all-teams-full" id="full-${schedule.team.team_id}" style="display: none;">`;
                    if (schedule.upcoming?.length > 1) {
                        schedule.upcoming.slice(1).forEach(match => {
                            html += renderMatchCard(match, schedule.leagueId, false);
                        });
                    }
                    if (schedule.past?.length > 0) {
                        html += '<div class="match-section-title">PAST MATCHES</div>';
                        schedule.past.forEach(match => {
                            html += renderMatchCard(match, schedule.leagueId, true);
                        });
                    }
                    html += `</div></div>`;
                });

                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading all teams:', error);
                container.innerHTML = '<div class="empty-state">Error loading schedules</div>';
            }
        }

        window.toggleTeamExpand = function(teamId) {
            const fullSection = document.getElementById('full-' + teamId);
            const expandIcon = document.getElementById('expand-' + teamId);
            if (fullSection.style.display === 'none') {
                fullSection.style.display = 'block';
                expandIcon.textContent = '‚ñ≤';
            } else {
                fullSection.style.display = 'none';
                expandIcon.textContent = '‚ñº';
            }
        };

        function renderTeamScheduleEnhanced(data) {
            const container = document.getElementById('teamScheduleContainer');
            const { upcoming, past, league_id } = data;

            if ((!upcoming || upcoming.length === 0) && (!past || past.length === 0)) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üìÖ</div><p>No matches scheduled yet.</p></div>';
                return;
            }

            let html = '<div class="match-cards-container">';

            // Upcoming matches
            if (upcoming && upcoming.length > 0) {
                html += '<div class="match-section-title">UPCOMING MATCHES</div>';
                upcoming.forEach(match => {
                    html += renderMatchCard(match, league_id, false);
                });
            }

            // Past matches
            if (past && past.length > 0) {
                html += '<div class="match-section-title">PAST MATCHES</div>';
                past.forEach(match => {
                    html += renderMatchCard(match, league_id, true);
                });
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderMatchCard(match, leagueId, isPast) {
            const dateStr = match.match_date
                ? new Date(match.match_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
                : 'TBD';

            const myAvail = match.my_availability || 'unknown';
            const cantSelected = myAvail === 'unavailable' ? 'selected' : '';
            const inSelected = myAvail === 'confirmed' ? 'selected' : '';

            // Render player rows for a team
            const renderRoster = (roster, availability, isMyTeam, isPast, match) => {
                if (!roster || roster.length === 0) {
                    return '<div class="match-player-row"><span class="match-player-name">No players</span></div>';
                }

                return roster.map(p => {
                    let rowClass = '';
                    if (isMyTeam && availability) {
                        const avail = availability[p.id] || 'unknown';
                        if (avail === 'unavailable') rowClass = 'unavailable';
                        else if (avail === 'sub') rowClass = 'sub';
                        else if (avail === 'confirmed') rowClass = 'confirmed';
                    }

                    // Use match-specific stats for past matches if available
                    // Canonical: x01_three_dart_avg, cricket_mpr. Legacy: x01_avg, mpr
                    let x01Stat = p.x01_three_dart_avg || p.x01_avg || '-';
                    let mprStat = p.cricket_mpr || p.mpr || '-';
                    if (isPast && match && match.player_stats && match.player_stats[p.id]) {
                        const stats = match.player_stats[p.id];
                        x01Stat = stats.x01_three_dart_avg || stats.x01_avg || x01Stat;
                        mprStat = stats.cricket_mpr || stats.mpr || mprStat;
                    }

                    return `
                        <div class="match-player-row ${rowClass}">
                            <span class="match-player-level">${p.level || ''}</span>
                            <span class="match-player-name" onclick="viewPlayer('${p.id}')">${p.name}</span>
                            <span class="match-player-stats">${x01Stat} / ${mprStat}</span>
                        </div>
                    `;
                }).join('');
            };

            let resultHtml = '';
            if (isPast && match.completed) {
                const resultClass = match.won ? 'won' : 'lost';
                const resultLabel = match.won ? 'WIN' : 'LOSS';
                resultHtml = `
                    <div class="match-result">
                        <div class="match-result-label">${resultLabel}</div>
                        <div class="match-result-score ${resultClass}">${match.my_score} - ${match.their_score}</div>
                    </div>
                `;
            }

            return `
                <div class="match-card ${isPast ? 'past' : ''}">
                    <div class="match-card-body">
                        <button class="match-avail-btn cant-btn ${cantSelected}"
                                onclick="updateAvailability('${leagueId}', '${match.id}', 'unavailable')"
                                ${isPast ? 'disabled' : ''}>
                            <span class="icon">‚úó</span>
                            CAN'T
                        </button>

                        <div class="match-team-section">
                            <div class="match-team-header">
                                <span class="match-team-name" onclick="viewTeam('${match.my_team.id}')">${match.my_team.name}</span>
                                <span class="match-team-record">${match.my_team.record}</span>
                            </div>
                            ${renderRoster(match.my_team.roster, match.my_team.availability, true, isPast, match)}
                        </div>

                        <div class="match-center-divider">
                            <div class="match-center-week">WK ${match.week}</div>
                            <div class="match-center-date">${dateStr}</div>
                        </div>

                        <div class="match-team-section">
                            <div class="match-team-header">
                                <span class="match-team-name" onclick="viewTeam('${match.opponent.id}')">${match.opponent.name}</span>
                                <span class="match-team-record">${match.opponent.record}</span>
                            </div>
                            ${renderRoster(match.opponent.roster, null, false, isPast, match)}
                        </div>

                        <button class="match-avail-btn in-btn ${inSelected}"
                                onclick="updateAvailability('${leagueId}', '${match.id}', 'confirmed')"
                                ${isPast ? 'disabled' : ''}>
                            <span class="icon">‚úì</span>
                            I'M IN
                        </button>
                    </div>
                    ${resultHtml}
                </div>
            `;
        }

        // Notification preference toggle functions
        function loadNotificationSettings() {
            if (!currentPlayer) return;

            const notifications = currentPlayer.notifications || {};

            // Default: SMS on, email off, push off (needs permission)
            const smsEnabled = notifications.sms ?? true;
            const emailEnabled = notifications.email ?? false;
            const pushEnabled = notifications.push ?? false;

            document.getElementById('notifySms').classList.toggle('on', smsEnabled);
            document.getElementById('notifyEmail').classList.toggle('on', emailEnabled);
            document.getElementById('notifyPush').classList.toggle('on', pushEnabled);
        }

        window.toggleNotification = async function(type) {
            if (!currentPlayer) return;

            const toggleEl = document.getElementById(`notify${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const currentValue = toggleEl.classList.contains('on');
            const newValue = !currentValue;

            // Special handling for push notifications - need permission
            if (type === 'push' && newValue) {
                try {
                    // Request push notification permission
                    if (typeof initializePushNotifications === 'function') {
                        const granted = await initializePushNotifications(currentPlayer.id);
                        if (!granted) {
                            alert('Push notification permission was denied. Please enable it in your browser settings.');
                            return;
                        }
                    } else {
                        alert('Push notifications are not available in this browser.');
                        return;
                    }
                } catch (err) {
                    console.error('Push permission error:', err);
                    alert('Could not enable push notifications.');
                    return;
                }
            }

            // Optimistic UI update
            toggleEl.classList.toggle('on', newValue);

            try {
                // Update notification settings via updateGlobalPlayer
                const notifications = { ...(currentPlayer.notifications || {}) };
                notifications[type] = newValue;

                const result = await callFunction('updateGlobalPlayer', {
                    player_id: currentPlayer.id,
                    notifications: notifications
                });

                if (result.success) {
                    currentPlayer.notifications = notifications;
                } else {
                    // Revert on failure
                    toggleEl.classList.toggle('on', currentValue);
                    alert(result.error || 'Failed to update notification setting');
                }
            } catch (error) {
                console.error('Error updating notification:', error);
                // Revert on error
                toggleEl.classList.toggle('on', currentValue);
                alert('Error updating notification setting');
            }
        };

        window.viewPlayer = function(playerId) {
            window.location.href = `/pages/player-public.html?id=${playerId}`;
        };

        window.viewTeam = function(teamId) {
            if (currentLeagueId) {
                window.location.href = `/pages/team-profile.html?league=${currentLeagueId}&team=${teamId}`;
            }
        };

        window.updateAvailability = async function(leagueId, matchId, status) {
            try {
                const result = await callFunction('updatePlayerAvailability', {
                    league_id: leagueId,
                    match_id: matchId,
                    player_id: currentPlayer.id,
                    status: status
                });

                if (result.success) {
                    // Reload schedule to show updated status
                    loadTeamSchedule();
                    if (status === 'unavailable') {
                        alert('Your captain has been notified to find a substitute.');
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error updating availability: ' + error.message);
            }
        };

        // ============================================================================
        // CAPTAIN FUNCTIONS
        // ============================================================================

        window.loadCaptainTeam = async function() {
            const select = document.getElementById('captainTeamSelect');
            const [leagueId, teamId] = select.value.split('|');
            selectedCaptainTeamId = teamId;
            selectedCaptainLeagueId = leagueId;

            try {
                const result = await callFunction('getCaptainTeamData', {
                    league_id: leagueId,
                    team_id: teamId,
                    captain_id: currentPlayer.id
                });

                if (result.success) {
                    captainTeamData = result;

                    // Show team name editor
                    const teamNameEditor = document.getElementById('teamNameEditor');
                    const teamNameValue = document.getElementById('currentTeamName');
                    teamNameEditor.style.display = 'block';
                    teamNameValue.textContent = result.team_name || 'Unnamed Team';

                    renderCaptainRoster(result.roster);
                    renderCaptainSchedule(result.schedule, leagueId);
                    renderSubsList(result.subs);
                    populateLineupMatchSelect(result.schedule);
                }
            } catch (error) {
                console.error('Error loading captain team:', error);
            }
        };

        // Team name editing functions
        let selectedCaptainLeagueId = null;

        window.showTeamNameEdit = function() {
            const currentName = document.getElementById('currentTeamName').textContent;
            document.getElementById('newTeamNameInput').value = currentName;
            document.getElementById('teamNameEditForm').style.display = 'block';
            document.querySelector('.team-name-display').style.display = 'none';
            document.getElementById('newTeamNameInput').focus();
        };

        window.cancelTeamNameEdit = function() {
            document.getElementById('teamNameEditForm').style.display = 'none';
            document.querySelector('.team-name-display').style.display = 'flex';
        };

        window.saveTeamName = async function() {
            const newName = document.getElementById('newTeamNameInput').value.trim();
            if (!newName) {
                alert('Please enter a team name');
                return;
            }

            try {
                const result = await callFunction('updateTeamName', {
                    league_id: selectedCaptainLeagueId,
                    team_id: selectedCaptainTeamId,
                    captain_id: currentPlayer.id,
                    team_name: newName
                });

                if (result.success) {
                    document.getElementById('currentTeamName').textContent = newName;
                    cancelTeamNameEdit();

                    // Update the dropdown too
                    const select = document.getElementById('captainTeamSelect');
                    const selectedOption = select.options[select.selectedIndex];
                    const parts = selectedOption.text.split(' - ');
                    if (parts.length > 1) {
                        selectedOption.text = newName + ' - ' + parts.slice(1).join(' - ');
                    }
                } else {
                    alert('Error: ' + (result.error || 'Could not update team name'));
                }
            } catch (error) {
                console.error('Error updating team name:', error);
                alert('Error updating team name: ' + error.message);
            }
        };

        function renderCaptainRoster(roster) {
            const grid = document.getElementById('rosterGrid');

            if (!roster || roster.length === 0) {
                grid.innerHTML = '<div class="empty-state">No players on roster</div>';
                return;
            }

            const posLabel = (pos) => ['', 'A', 'B', 'C'][pos] || pos;
            grid.innerHTML = roster.map(p => `
                <div class="roster-card ${p.is_captain ? 'captain-card' : ''}">
                    <div class="player-position">${posLabel(p.position)} ${p.is_captain ? '- CAPTAIN' : ''}</div>
                    <div class="player-name-roster">${p.name}</div>
                    <div class="player-stats-mini">
                        <div class="stat-mini">
                            <div class="stat-mini-label">X01 Avg</div>
                            <div class="stat-mini-value">${p.x01_three_dart_avg || p.x01_avg || '-'}</div>
                        </div>
                        <div class="stat-mini">
                            <div class="stat-mini-label">MPR</div>
                            <div class="stat-mini-value">${p.cricket_mpr || p.mpr || '-'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderCaptainSchedule(schedule, leagueId) {
            const container = document.getElementById('captainScheduleTable');

            if (!schedule || schedule.length === 0) {
                container.innerHTML = '<div class="empty-state">No matches scheduled</div>';
                return;
            }

            const posLabel = (pos) => ['', 'A', 'B', 'C', 'D'][pos] || pos;

            // Separate into upcoming and past
            const upcoming = schedule.filter(m => !m.completed);
            const past = schedule.filter(m => m.completed);

            let html = '<div class="match-cards-container">';

            if (upcoming.length > 0) {
                html += '<div class="match-section-title">UPCOMING MATCHES</div>';
                upcoming.forEach(match => {
                    html += renderCaptainMatchCard(match, posLabel);
                });
            }

            if (past.length > 0) {
                html += '<div class="match-section-title">COMPLETED MATCHES</div>';
                past.forEach(match => {
                    html += renderCaptainMatchCard(match, posLabel, true);
                });
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function renderCaptainMatchCard(match, posLabel, isPast = false) {
            const dateStr = match.match_date
                ? new Date(match.match_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
                : 'TBD';

            const renderLineup = (players, isYourTeam) => {
                if (!players || players.length === 0) {
                    return '<div class="match-player-row" style="color: var(--text-dim);">No roster data</div>';
                }
                return players.map(p => {
                    let rowClass = 'match-player-row';
                    let statusIcon = '';

                    // Color coding based on status
                    if (p.is_sub) {
                        rowClass += ' sub';
                        statusIcon = '<span style="color: #fdd835; margin-left: 5px;" title="Substitute">SUB</span>';
                    } else if (p.needs_fillin) {
                        rowClass += ' unavailable';
                        statusIcon = '<span style="color: #ef4444; margin-left: 5px;" title="Needs Fill-in">NEED SUB</span>';
                    } else if (p.availability === 'confirmed' && isYourTeam) {
                        rowClass += ' confirmed';
                        statusIcon = '<span style="color: #22c55e; margin-left: 5px;">‚úì</span>';
                    } else if (p.availability === 'unavailable' && isYourTeam) {
                        rowClass += ' unavailable';
                        statusIcon = '<span style="color: #ef4444; margin-left: 5px;">‚úó</span>';
                    }

                    return `
                        <div class="${rowClass}">
                            <span class="match-player-level">${posLabel(p.position)}</span>
                            <span class="match-player-name">${p.name || 'Unknown'}${statusIcon}</span>
                            <span class="match-player-stats">${p.x01_three_dart_avg || p.x01_avg || '-'} / ${p.cricket_mpr || p.mpr || '-'}</span>
                        </div>
                    `;
                }).join('');
            };

            return `
                <div class="match-card ${isPast ? 'past' : ''}">
                    <div class="match-card-body">
                        <div class="match-team-section">
                            <div class="match-team-header">
                                <span class="match-team-name">${match.home_team_name || 'Home'}</span>
                                ${match.is_home ? '<span style="color: var(--pink); font-size: 10px;">YOUR TEAM</span>' : ''}
                            </div>
                            ${renderLineup(match.home_lineup, match.is_home)}
                        </div>
                        <div class="match-center-divider">
                            <div class="match-center-week">WK ${match.week}</div>
                            <div class="match-center-date">${dateStr}</div>
                            ${match.completed ? '<div style="color: var(--success); font-size: 10px; margin-top: 5px;">DONE</div>' :
                              match.in_progress ? '<div style="color: var(--pink); font-size: 10px; margin-top: 5px;">LIVE</div>' : ''}
                        </div>
                        <div class="match-team-section">
                            <div class="match-team-header">
                                <span class="match-team-name">${match.away_team_name || 'Away'}</span>
                                ${!match.is_home ? '<span style="color: var(--pink); font-size: 10px;">YOUR TEAM</span>' : ''}
                            </div>
                            ${renderLineup(match.away_lineup, !match.is_home)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSubsList(subs) {
            const container = document.getElementById('subsList');

            if (!subs || subs.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üë•</div><p>No substitute players available</p></div>';
                return;
            }

            container.innerHTML = subs.map(s => `
                <div class="sub-card">
                    <div class="sub-name">${s.name}</div>
                    <div class="sub-info">${s.phone || 'No phone'} ‚Ä¢ ${s.preferred_level || 'Any level'}</div>
                    <button class="sub-btn" onclick="contactSub('${s.id}', '${s.name}', '${s.phone || ''}')">üì± CONTACT</button>
                </div>
            `).join('');
        }

        function populateLineupMatchSelect(schedule) {
            const select = document.getElementById('lineupMatchSelect');
            const upcoming = schedule.filter(m => !m.completed);

            select.innerHTML = '<option value="">-- Select upcoming match --</option>' +
                upcoming.map(m => {
                    const dateStr = m.match_date ? new Date(m.match_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'TBD';
                    return `<option value="${m.id}">Week ${m.week} vs ${m.opponent_name} (${dateStr})</option>`;
                }).join('');
        }

        window.loadLineupForMatch = async function() {
            const matchId = document.getElementById('lineupMatchSelect').value;
            const builder = document.getElementById('lineupBuilder');
            const saveBtn = document.getElementById('saveLineupBtn');

            if (!matchId) {
                builder.style.display = 'none';
                saveBtn.style.display = 'none';
                return;
            }

            // Get match format and current lineup
            const roster = captainTeamData.roster || [];
            const match = captainTeamData.schedule.find(m => m.id === matchId);
            const format = match?.format || captainTeamData.match_format || [];

            let html = '';
            format.forEach((game, i) => {
                const gameNum = i + 1;
                const gameType = game.type === 'doubles' ? 'DOUBLES' : 'SINGLES';
                const gameFormat = game.format?.toUpperCase() || '501';

                html += `<div class="lineup-row">
                    <div class="lineup-game">G${gameNum} - ${gameType}<br><span style="font-size: 12px; color: var(--text-dim);">${gameFormat}</span></div>
                    <select class="lineup-select" id="lineup_g${gameNum}_p1">
                        <option value="">Select Player</option>
                        ${roster.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                    </select>
                    ${game.type === 'doubles' ? `
                    <select class="lineup-select" id="lineup_g${gameNum}_p2">
                        <option value="">Select Partner</option>
                        ${roster.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                    </select>` : ''}
                </div>`;
            });

            builder.innerHTML = html;
            builder.style.display = 'block';
            saveBtn.style.display = 'block';
        };

        window.saveLineup = async function() {
            const matchId = document.getElementById('lineupMatchSelect').value;
            if (!matchId) return;

            const format = captainTeamData.match_format || [];
            const lineup = [];

            format.forEach((game, i) => {
                const gameNum = i + 1;
                const p1 = document.getElementById(`lineup_g${gameNum}_p1`)?.value;
                const p2 = document.getElementById(`lineup_g${gameNum}_p2`)?.value;

                lineup.push({
                    game: gameNum,
                    player1_id: p1 || null,
                    player2_id: game.type === 'doubles' ? (p2 || null) : null
                });
            });

            try {
                const [leagueId, teamId] = document.getElementById('captainTeamSelect').value.split('|');
                const result = await callFunction('setMatchLineup', {
                    league_id: leagueId,
                    match_id: matchId,
                    team_id: teamId,
                    captain_id: currentPlayer.id,
                    lineup: lineup
                });

                if (result.success) {
                    alert('Lineup saved!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving lineup: ' + error.message);
            }
        };

        window.contactSub = function(subId, subName, phone) {
            if (!phone) {
                alert(`${subName} does not have a phone number on file.`);
                return;
            }
            // Switch to contact tab and pre-fill
            switchCaptainSubtab('contact');
            document.getElementById('contactAllPlayers').checked = false;
            document.getElementById('contactSubs').checked = false;
            document.getElementById('captainMessage').value = `Hi ${subName.split(' ')[0]}, are you available to sub this week?`;
        };

        window.insertCaptainTag = function(tag) {
            const textarea = document.getElementById('captainMessage');
            const start = textarea.selectionStart;
            const text = textarea.value;
            textarea.value = text.substring(0, start) + tag + text.substring(textarea.selectionEnd);
            textarea.focus();
        };

        window.sendTeamMessage = async function() {
            const message = document.getElementById('captainMessage').value.trim();
            if (!message) {
                alert('Please enter a message');
                return;
            }

            const allPlayers = document.getElementById('contactAllPlayers').checked;
            const subsOnly = document.getElementById('contactSubs').checked;
            const alsoSendSMS = document.getElementById('alsoSendSMS').checked;

            if (!allPlayers && !subsOnly) {
                alert('Please select recipients');
                return;
            }

            try {
                const [leagueId, teamId] = document.getElementById('captainTeamSelect').value.split('|');
                const result = await callFunction('sendCaptainMessage', {
                    league_id: leagueId,
                    team_id: teamId,
                    captain_id: currentPlayer.id,
                    message: message,
                    send_sms: alsoSendSMS,
                    recipients: {
                        all_players: allPlayers,
                        subs_only: subsOnly
                    }
                });

                if (result.success) {
                    const smsNote = alsoSendSMS ? ' (SMS also sent)' : '';
                    alert(`Message sent to ${result.sent} player(s)!${smsNote}`);
                    document.getElementById('captainMessage').value = '';
                    document.getElementById('alsoSendSMS').checked = false;
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error sending message: ' + error.message);
            }
        };

        // ============================================================================
        // DIRECTOR FUNCTIONS
        // ============================================================================

        window.openDirectorDashboard = function() {
            const leagues = dashboardData.roles.directing || [];

            if (leagues.length === 1) {
                // Go directly to that league
                const league = leagues[0];
                const url = league.type === 'tournament'
                    ? `/pages/director-dashboard.html?tournament=${league.id}`
                    : `/pages/league-director.html?league_id=${league.id}`;
                window.location.href = url;
            } else {
                // Show selector modal
                const select = document.getElementById('directorLeagueSelect');
                select.innerHTML = leagues.map(l =>
                    `<option value="${l.type}|${l.id}">${l.name} (${l.type})</option>`
                ).join('');
                document.getElementById('directorModal').style.display = 'flex';
            }
        };

        window.closeDirectorModal = function() {
            document.getElementById('directorModal').style.display = 'none';
        };

        window.goToDirectorDashboard = function() {
            const [type, id] = document.getElementById('directorLeagueSelect').value.split('|');
            const url = type === 'tournament'
                ? `/pages/director-dashboard.html?tournament=${id}`
                : `/pages/league-director.html?league_id=${id}`;
            window.location.href = url;
        };

        function populateDirectorTab(directing) {
            const leagues = directing.filter(d => d.type === 'league');
            const tournaments = directing.filter(d => d.type === 'tournament');

            // Populate leagues list
            const leaguesList = document.getElementById('directorLeaguesList');
            if (leagues.length === 0) {
                leaguesList.innerHTML = '<div class="empty-state">No leagues</div>';
            } else {
                leaguesList.innerHTML = leagues.map(l => {
                    const statusClass = l.status === 'active' ? 'active' :
                                       l.status === 'registration' ? 'registration' :
                                       l.status === 'draft' ? 'draft' : 'completed';
                    const statusText = (l.status || 'registration').toUpperCase();
                    return `
                        <a href="/pages/league-director.html?league_id=${l.id}" class="director-item" style="text-decoration: none; color: inherit;">
                            <div class="director-item-info">
                                <h4>${l.name}</h4>
                                <p>${l.player_count || 0} players ‚Ä¢ ${l.team_count || 0} teams</p>
                            </div>
                            <span class="director-item-status ${statusClass}">${statusText}</span>
                        </a>
                    `;
                }).join('');
            }

            // Populate tournaments list
            const tournamentsList = document.getElementById('directorTournamentsList');
            if (tournaments.length === 0) {
                tournamentsList.innerHTML = '<div class="empty-state">No tournaments</div>';
            } else {
                tournamentsList.innerHTML = tournaments.map(t => {
                    const statusClass = t.status === 'active' ? 'active' :
                                       t.status === 'registration' ? 'registration' : 'completed';
                    const statusText = (t.status || 'registration').toUpperCase();
                    return `
                        <a href="/pages/director-dashboard.html?tournament=${t.id}" class="director-item" style="text-decoration: none; color: inherit;">
                            <div class="director-item-info">
                                <h4>${t.name}</h4>
                                <p>${t.participant_count || 0} participants</p>
                            </div>
                            <span class="director-item-status ${statusClass}">${statusText}</span>
                        </a>
                    `;
                }).join('');
            }
        }

        // ============================================================================
        // TAB SWITCHING
        // ============================================================================

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-container > .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.dashboard-content > .container > .tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Load data for specific tabs
            if (tabName === 'schedule' && !scheduleLoaded) {
                loadCalendar();
            }
            if (tabName === 'activity') {
                // Load leagues data if not loaded (default sub-tab)
                if (!leaguesLoaded) {
                    loadLeaguesTab();
                }
            }
        };

        // Open settings (via gear icon)
        window.openSettings = function() {
            // Remove active state from all tabs
            document.querySelectorAll('.tab-container > .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.dashboard-content > .container > .tab-content').forEach(c => c.classList.remove('active'));

            // Show settings tab
            document.getElementById('settingsTab').classList.add('active');
            populateSettingsForm();
        };

        // Sub-tab switching for ACTIVITY tab (leagues, tournaments, history, stats)
        window.switchActivitySubTab = function(subTabName) {
            // Update sub-tab buttons within activity tab
            const activityTab = document.getElementById('activityTab');
            activityTab.querySelectorAll('.sub-tab-container .sub-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update sub-tab content within activity tab
            activityTab.querySelectorAll('.sub-tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(subTabName + 'SubTab').classList.add('active');

            // Load data for sub-tabs
            if (subTabName === 'leagues' && !leaguesLoaded) {
                loadLeaguesTab();
            }
            if (subTabName === 'tournaments' && !tournamentsLoaded) {
                loadTournamentsTab();
            }
            if (subTabName === 'history' && !historyLoaded) {
                loadMatchHistory();
            }
            if (subTabName === 'stats' && !statsLoaded) {
                loadDetailedStats();
            }
        };

        // ============================================================================
        // CALENDAR / SCHEDULE
        // ============================================================================

        let scheduleLoaded = false;
        let currentCalendarDate = new Date();
        let calendarEvents = [];

        async function loadCalendar() {
            scheduleLoaded = true;
            await loadCalendarEvents();
            renderCalendar();
        }

        async function loadCalendarEvents() {
            calendarEvents = [];
            if (!currentPlayer) return;

            try {
                // Load league matches from all teams
                console.log('Loading calendar events, allTeams:', allTeams.length);
                for (const team of allTeams) {
                    const leagueId = team.id || team.league_id;
                    const teamId = team.team_id;
                    const matchesSnap = await getDocs(collection(db, 'leagues', leagueId, 'matches'));
                    // Collect unique match dates for this league
                    const leagueMatchDates = new Map(); // date -> first match info
                    let teamMatchCount = 0;

                    matchesSnap.forEach(docSnap => {
                        const match = docSnap.data();
                        const isTeamMatch = !teamId ||
                            match.home_team_id === teamId ||
                            match.away_team_id === teamId;

                        const dateStr = match.match_date || match.date || match.scheduled_date;

                        if (isTeamMatch && dateStr) {
                            teamMatchCount++;
                            // Determine opponent name
                            let opponent = `Week ${match.week || '?'}`;
                            if (teamId) {
                                const oppName = match.home_team_id === teamId
                                    ? match.away_team_name
                                    : match.home_team_name;
                                opponent = (match.home_team_id === teamId ? 'vs ' : '@ ') + (oppName || 'TBD');
                            }

                            calendarEvents.push({
                                type: 'league',
                                date: dateStr,
                                title: team.team_name || team.name || 'League Match',
                                subtitle: opponent,
                                leagueId: leagueId,
                                matchId: docSnap.id,
                                week: match.week,
                                homeTeamId: match.home_team_id,
                                awayTeamId: match.away_team_id,
                                homeTeamName: match.home_team_name,
                                awayTeamName: match.away_team_name
                            });
                        }

                        // Track all league dates in case team has no matches
                        if (dateStr && !leagueMatchDates.has(dateStr)) {
                            leagueMatchDates.set(dateStr, {
                                week: match.week,
                                matchId: docSnap.id
                            });
                        }
                    });

                    // If team has no matches in schedule, show all league nights
                    if (teamMatchCount === 0 && leagueMatchDates.size > 0) {
                        console.log('Team not in schedule, showing all', leagueMatchDates.size, 'league nights');
                        leagueMatchDates.forEach((info, dateStr) => {
                            calendarEvents.push({
                                type: 'league',
                                date: dateStr,
                                title: team.name || 'League Night',
                                subtitle: `Week ${info.week || '?'}`,
                                leagueId: leagueId,
                                matchId: info.matchId
                            });
                        });
                    }
                }

                console.log('League loading complete, now loading tournaments...');
                // Load tournaments - both registered and upcoming
                const tournamentsSnap = await getDocs(collection(db, 'tournaments'));
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                console.log('Tournaments found:', tournamentsSnap.size, 'today:', today.toISOString());

                for (const tDoc of tournamentsSnap.docs) {
                    const tournament = tDoc.data();
                    const dateStr = tournament.tournament_date || tournament.date;
                    const regDeadline = tournament.registration_deadline;

                    // Check if player is registered
                    const regSnap = await getDocs(
                        query(collection(db, 'tournaments', tDoc.id, 'registrations'),
                            where('player_id', '==', currentPlayer.id))
                    );
                    const isRegistered = !regSnap.empty;

                    // Tournament date event
                    if (dateStr) {
                        const tourneyDate = new Date(dateStr + 'T12:00:00');
                        console.log('Tournament:', tournament.tournament_name, 'date:', dateStr, 'status:', tournament.status, 'isRegistered:', isRegistered, 'tourneyDate >= today:', tourneyDate >= today);

                        if (isRegistered) {
                            // Registered tournament
                            calendarEvents.push({
                                type: 'tournament',
                                date: dateStr,
                                title: tournament.tournament_name || tournament.name || 'Tournament',
                                subtitle: tournament.venue_name || '',
                                tournamentId: tDoc.id
                            });
                        } else if (tourneyDate >= today && tournament.status !== 'completed') {
                            // Upcoming tournament not registered for
                            console.log('Adding upcoming tournament to calendar:', tournament.tournament_name);
                            calendarEvents.push({
                                type: 'upcoming-tournament',
                                date: dateStr,
                                title: tournament.tournament_name || tournament.name || 'Upcoming Tournament',
                                subtitle: 'Not registered - ' + (tournament.venue_name || 'Click to register'),
                                tournamentId: tDoc.id
                            });
                        }
                    }

                    // Registration deadline event (only for unregistered upcoming tournaments)
                    if (regDeadline && !isRegistered) {
                        const deadlineDate = new Date(regDeadline + 'T12:00:00');
                        if (deadlineDate >= today) {
                            calendarEvents.push({
                                type: 'deadline',
                                deadlineType: 'tournament',
                                date: regDeadline,
                                title: 'Registration Deadline',
                                subtitle: (tournament.tournament_name || tournament.name || 'Tournament') + ' closes',
                                tournamentId: tDoc.id
                            });
                        }
                    }
                }

                // Load league registration deadlines
                const leaguesSnap = await getDocs(collection(db, 'leagues'));
                for (const lDoc of leaguesSnap.docs) {
                    const league = lDoc.data();
                    const regDeadline = league.registration_deadline || league.registration_end;

                    // Check if player is already in this league
                    const isInLeague = allTeams.some(t => (t.id || t.league_id) === lDoc.id);

                    if (regDeadline && !isInLeague && league.status !== 'completed') {
                        const deadlineDate = new Date(regDeadline + 'T12:00:00');
                        if (deadlineDate >= today) {
                            calendarEvents.push({
                                type: 'deadline',
                                deadlineType: 'league',
                                date: regDeadline,
                                title: 'League Registration Deadline',
                                subtitle: (league.league_name || league.name || 'League') + ' registration closes',
                                leagueId: lDoc.id
                            });
                        }
                    }
                }

                // Load social/casual matches (pickup games, casual events)
                try {
                    const socialSnap = await getDocs(collection(db, 'pickup_games'));
                    socialSnap.forEach(docSnap => {
                        const game = docSnap.data();
                        const dateStr = game.date || game.game_date;
                        if (dateStr) {
                            const gameDate = new Date(dateStr + 'T12:00:00');
                            if (gameDate >= today && game.status !== 'completed') {
                                calendarEvents.push({
                                    type: 'social',
                                    date: dateStr,
                                    title: game.title || 'Casual Darts',
                                    subtitle: game.venue_name || game.location || 'Social event',
                                    gameId: docSnap.id
                                });
                            }
                        }
                    });
                } catch (e) {
                    // pickup_games collection may not exist
                    console.log('No pickup games collection');
                }

                console.log('Calendar events loaded:', calendarEvents.length, calendarEvents);
            } catch (error) {
                console.error('Error loading calendar events:', error);
            }
        }

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const today = new Date();

            document.getElementById('calMonth').textContent =
                currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startPad = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            let html = '';

            // Previous month padding
            const prevMonth = new Date(year, month, 0);
            for (let i = startPad - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                html += `<div class="cal-day other-month">${day}</div>`;
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                // Match events by extracting just the YYYY-MM-DD part (first 10 chars)
                const dayEvents = calendarEvents.filter(e => {
                    if (!e.date) return false;
                    const eventDateStr = e.date.substring(0, 10); // Get just YYYY-MM-DD
                    return eventDateStr === dateStr;
                });

                let classes = 'cal-day';
                if (isToday) classes += ' today';
                if (dayEvents.length > 0) {
                    classes += ' has-event';
                    if (dayEvents.some(e => e.type === 'tournament')) classes += ' has-tournament';
                    if (dayEvents.some(e => e.type === 'upcoming-tournament')) classes += ' has-upcoming';
                    if (dayEvents.some(e => e.type === 'deadline')) classes += ' has-deadline';
                    if (dayEvents.some(e => e.type === 'social')) classes += ' has-social';
                    if (dayEvents.length > 1) classes += ' has-multiple';
                }

                html += `<div class="${classes}" onclick="showDayEvents('${dateStr}')">${day}</div>`;
            }

            // Next month padding
            const totalCells = startPad + daysInMonth;
            const remaining = 7 - (totalCells % 7);
            if (remaining < 7) {
                for (let i = 1; i <= remaining; i++) {
                    html += `<div class="cal-day other-month">${i}</div>`;
                }
            }

            document.getElementById('calendarDays').innerHTML = html;
        }

        window.changeMonth = function(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        };

        window.showDayEvents = async function(dateStr) {
            const dayEvents = calendarEvents.filter(e => e.date && e.date.startsWith(dateStr));
            const popup = document.getElementById('eventPopup');
            const content = document.getElementById('eventPopupContent');

            const date = new Date(dateStr + 'T12:00:00');
            document.getElementById('eventPopupDate').textContent =
                date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

            if (dayEvents.length === 0) {
                content.innerHTML = '<div class="empty-state" style="padding: 20px;">No events scheduled</div>';
            } else {
                // Build initial HTML - different layout for league matches vs other events
                content.innerHTML = dayEvents.map((event, idx) => {
                    const eventId = event.leagueId || event.tournamentId || event.gameId || '';
                    const deadlineType = event.deadlineType || '';

                    if (event.type === 'league' && event.matchId) {
                        // League match card - will be populated by loadMatchDetails
                        return `<div class="match-card" id="matchCard${idx}" data-league-id="${event.leagueId}">
                            <div style="padding: 20px; text-align: center; color: var(--text-dim);">Loading match...</div>
                        </div>`;
                    } else {
                        // Non-league events (tournaments, deadlines, social)
                        const eventTypeLabel = getEventTypeLabel(event.type);
                        return `
                        <div class="event-card" onclick="goToEvent('${event.type}', '${eventId}', '${deadlineType}')">
                            <span class="event-type-badge ${event.type}">${eventTypeLabel}</span>
                            <div class="event-details">
                                <div class="event-title">${event.title}</div>
                                <div class="event-subtitle">${event.subtitle}</div>
                            </div>
                        </div>`;
                    }
                }).join('');

                // Auto-load league match details
                dayEvents.forEach((event, idx) => {
                    if (event.type === 'league' && event.matchId) {
                        loadMatchCard(idx, event);
                    }
                });
            }

            popup.style.display = 'block';
        };

        async function loadMatchCard(idx, event) {
            const cardEl = document.getElementById(`matchCard${idx}`);
            if (!cardEl) return;

            const { leagueId, matchId, week } = event;
            let { homeTeamId, awayTeamId } = event;

            try {
                // Always get match data for score/winner info
                let matchStatus = 'scheduled';
                let homeScore = 0;
                let awayScore = 0;
                let matchWinner = null;

                const matchDoc = await getDoc(doc(db, 'leagues', leagueId, 'matches', matchId));
                if (matchDoc.exists()) {
                    const matchData = matchDoc.data();
                    homeTeamId = homeTeamId || matchData.home_team_id;
                    awayTeamId = awayTeamId || matchData.away_team_id;
                    matchStatus = matchData.status || 'scheduled';
                    homeScore = matchData.home_score || 0;
                    awayScore = matchData.away_score || 0;
                    matchWinner = matchData.winner; // 'home', 'away', or 'tie'
                }

                if (!homeTeamId || !awayTeamId) {
                    cardEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim);">Match info not available</div>';
                    return;
                }

                // Fetch team data, all league players, and completed matches for records
                const [homeTeamDoc, awayTeamDoc, allPlayersSnap, completedMatchesSnap] = await Promise.all([
                    getDoc(doc(db, 'leagues', leagueId, 'teams', homeTeamId)),
                    getDoc(doc(db, 'leagues', leagueId, 'teams', awayTeamId)),
                    getDocs(collection(db, 'leagues', leagueId, 'players')),
                    getDocs(query(collection(db, 'leagues', leagueId, 'matches'), where('status', '==', 'completed')))
                ]);

                const homeTeam = homeTeamDoc.data() || {};
                const awayTeam = awayTeamDoc.data() || {};

                // Calculate team records from completed matches
                const teamRecords = {};
                completedMatchesSnap.forEach(doc => {
                    const m = doc.data();
                    if (!teamRecords[m.home_team_id]) teamRecords[m.home_team_id] = { wins: 0, losses: 0, ties: 0 };
                    if (!teamRecords[m.away_team_id]) teamRecords[m.away_team_id] = { wins: 0, losses: 0, ties: 0 };

                    if (m.home_score > m.away_score) {
                        teamRecords[m.home_team_id].wins++;
                        teamRecords[m.away_team_id].losses++;
                    } else if (m.away_score > m.home_score) {
                        teamRecords[m.away_team_id].wins++;
                        teamRecords[m.home_team_id].losses++;
                    } else {
                        teamRecords[m.home_team_id].ties++;
                        teamRecords[m.away_team_id].ties++;
                    }
                });

                // Group players by team_id
                const homeRoster = [];
                const awayRoster = [];
                allPlayersSnap.forEach(d => {
                    const player = { id: d.id, ...d.data() };
                    if (player.team_id === homeTeamId) {
                        homeRoster.push(player);
                    } else if (player.team_id === awayTeamId) {
                        awayRoster.push(player);
                    }
                });

                // Sort by position (captain first)
                homeRoster.sort((a, b) => (a.position || 99) - (b.position || 99));
                awayRoster.sort((a, b) => (a.position || 99) - (b.position || 99));

                console.log('Match card - homeRoster:', homeRoster);
                console.log('Match card - awayRoster:', awayRoster);

                // Get player stats - player document may have stats directly embedded
                const playerStats = {};

                // First check if stats are embedded in player docs
                [...homeRoster, ...awayRoster].forEach(p => {
                    // Check for embedded stats in player doc (canonical or legacy fields)
                    if (p.x01_three_dart_avg || p.ppd || p.x01_ppd || p.cricket_mpr || p.mpr || p.stats) {
                        playerStats[p.id] = p.stats || p;
                    }
                });

                // Also try to get stats from aggregated_stats collection
                const playerIds = [...homeRoster.map(p => p.id), ...awayRoster.map(p => p.id)].filter(Boolean);

                await Promise.all(playerIds.map(async (playerId) => {
                    try {
                        // Try aggregated_stats first
                        let statsDoc = await getDoc(doc(db, 'leagues', leagueId, 'aggregated_stats', playerId));
                        if (!statsDoc.exists()) {
                            // Fall back to stats collection
                            statsDoc = await getDoc(doc(db, 'leagues', leagueId, 'stats', playerId));
                        }
                        if (statsDoc.exists()) {
                            playerStats[playerId] = { ...playerStats[playerId], ...statsDoc.data() };
                        }
                    } catch (e) {
                        console.log('Error fetching stats for', playerId, e);
                    }
                }));

                // Team records - use calculated records from completed matches
                const homeRec = teamRecords[homeTeamId] || { wins: 0, losses: 0, ties: 0 };
                const awayRec = teamRecords[awayTeamId] || { wins: 0, losses: 0, ties: 0 };
                const homeRecord = getTeamRecord(homeRec);
                const awayRecord = getTeamRecord(awayRec);

                // Determine if user is home or away - "vs" means home, "@" means away
                const userIsHome = event.subtitle?.startsWith('vs');

                // Put user's team on left, opponent on right
                const leftTeam = userIsHome ? homeTeam : awayTeam;
                const rightTeam = userIsHome ? awayTeam : homeTeam;
                const leftRoster = userIsHome ? homeRoster : awayRoster;
                const rightRoster = userIsHome ? awayRoster : homeRoster;
                const leftRecord = userIsHome ? homeRecord : awayRecord;
                const rightRecord = userIsHome ? awayRecord : homeRecord;
                const leftTeamId = userIsHome ? homeTeamId : awayTeamId;
                const rightTeamId = userIsHome ? awayTeamId : homeTeamId;

                // Determine winner for completed matches
                const isCompleted = matchStatus === 'completed';
                const leftScore = userIsHome ? homeScore : awayScore;
                const rightScore = userIsHome ? awayScore : homeScore;
                const leftWon = isCompleted && leftScore > rightScore;
                const rightWon = isCompleted && rightScore > leftScore;

                // Build paired roster rows (captain vs captain, B vs B, C vs C)
                const maxPlayers = Math.max(leftRoster.length, rightRoster.length, 3);
                let rosterRows = '';
                for (let i = 0; i < maxPlayers; i++) {
                    const leftPlayer = leftRoster[i];
                    const rightPlayer = rightRoster[i];

                    const leftName = leftPlayer ? getPlayerName(leftPlayer) : '';
                    const rightName = rightPlayer ? getPlayerName(rightPlayer) : '';
                    // Use stats-helpers.js formatStats with playerStats lookup
                    const leftPlayerStats = leftPlayer ? playerStats[leftPlayer.id] || {} : {};
                    const rightPlayerStats = rightPlayer ? playerStats[rightPlayer.id] || {} : {};
                    const leftStatsStr = leftPlayer ? formatStats(leftPlayerStats) : '';
                    const rightStatsStr = rightPlayer ? formatStats(rightPlayerStats) : '';
                    const leftCaptain = leftPlayer && (leftPlayer.is_captain || leftPlayer.position === 1);
                    const rightCaptain = rightPlayer && (rightPlayer.is_captain || rightPlayer.position === 1);

                    rosterRows += `
                        <div class="match-row">
                            <div class="match-player-cell left">
                                <span class="match-player-name${leftCaptain ? ' captain' : ''}">${leftName}</span>
                                <span class="match-player-stats">${leftStatsStr}</span>
                            </div>
                            <div class="match-player-cell right">
                                <span class="match-player-stats">${rightStatsStr}</span>
                                <span class="match-player-name${rightCaptain ? ' captain' : ''}">${rightName}</span>
                            </div>
                        </div>`;
                }

                // Render match card - user's team always on left
                // Show big gold star next to winning team name for completed matches
                const winnerStar = '<span class="winner-star">‚òÖ</span>';

                cardEl.innerHTML = `
                    <div class="match-card-header${isCompleted ? ' completed' : ''}">
                        <div class="match-team-side left${leftWon ? ' winner' : ''}">
                            <div class="match-team-name">${leftWon ? winnerStar : ''}${getTeamName(leftTeam)}</div>
                            <div class="match-team-record">${leftRecord}</div>
                            ${isCompleted ? `<div class="match-score">${leftScore}</div>` : ''}
                        </div>
                        <div class="match-center">
                            <div class="match-week">WEEK ${week || '?'}</div>
                            <div class="match-vs">${isCompleted ? 'FINAL' : (userIsHome ? 'VS' : '@')}</div>
                        </div>
                        <div class="match-team-side right${rightWon ? ' winner' : ''}">
                            <div class="match-team-name">${getTeamName(rightTeam)}${rightWon ? winnerStar : ''}</div>
                            <div class="match-team-record">${rightRecord}</div>
                            ${isCompleted ? `<div class="match-score">${rightScore}</div>` : ''}
                        </div>
                    </div>
                    <div class="match-card-body">
                        ${rosterRows}
                    </div>
                    <div class="match-card-footer">
                        <span class="match-card-link" onclick="goToEvent('league', '${leagueId}')">View League</span>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading match card:', error);
                cardEl.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">Error loading match</div>';
            }
        }

        function getEventTypeLabel(type) {
            const labels = {
                'league': 'League',
                'tournament': 'Tournament',
                'upcoming-tournament': 'Upcoming',
                'deadline': 'Deadline',
                'social': 'Social'
            };
            return labels[type] || type;
        }

        window.closeEventPopup = function() {
            document.getElementById('eventPopup').style.display = 'none';
        };

        window.goToEvent = function(type, id, deadlineType) {
            if (!id) return;
            if (type === 'league') {
                window.location.href = `/pages/league-view.html?league_id=${id}`;
            } else if (type === 'tournament' || type === 'upcoming-tournament') {
                window.location.href = `/pages/tournament-view.html?tournament_id=${id}`;
            } else if (type === 'deadline') {
                // Deadlines link to the league/tournament page for registration
                if (deadlineType === 'league') {
                    window.location.href = `/pages/league-view.html?league_id=${id}`;
                } else {
                    window.location.href = `/pages/tournament-view.html?tournament_id=${id}`;
                }
            } else if (type === 'social') {
                window.location.href = `/pages/online-play.html`;
            }
        };

        // ============================================================================
        // SETTINGS TAB
        // ============================================================================

        async function populateSettingsForm() {
            if (!currentPlayer) return;

            // Always fetch full player data from Firestore to get all fields
            try {
                const playerDoc = await getDoc(doc(db, 'players', currentPlayer.id));
                if (playerDoc.exists()) {
                    const fullData = playerDoc.data();
                    // Merge additional fields into currentPlayer
                    currentPlayer.phone = fullData.phone || '';
                    currentPlayer.email = fullData.email || '';
                    currentPlayer.first_name = fullData.first_name || currentPlayer.first_name || '';
                    currentPlayer.last_name = fullData.last_name || currentPlayer.last_name || '';
                    currentPlayer.privacy = fullData.privacy || {};
                    currentPlayer.notifications = fullData.notifications || {};
                    currentPlayer.pin = fullData.pin || '';
                    // Profile fields
                    currentPlayer.bio = fullData.bio || '';
                    currentPlayer.home_bar = fullData.home_bar || '';
                    currentPlayer.preferred_game = fullData.preferred_game || '';
                    currentPlayer.dartconnect_id = fullData.dartconnect_id || '';
                }
            } catch (err) {
                console.log('Could not fetch full player data:', err);
            }

            // Populate display values - Edit Profile section
            document.getElementById('firstNameValue').textContent = currentPlayer.first_name || '-';
            document.getElementById('lastNameValue').textContent = currentPlayer.last_name || '-';

            const phoneVal = currentPlayer.phone || '';
            const emailVal = currentPlayer.email || '';

            const phoneDisplay = document.getElementById('phoneValue');
            const emailDisplay = document.getElementById('emailValue');

            phoneDisplay.textContent = phoneVal || 'Not set';
            phoneDisplay.classList.toggle('empty', !phoneVal);

            emailDisplay.textContent = emailVal || 'Not set';
            emailDisplay.classList.toggle('empty', !emailVal);

            // Populate edit inputs
            document.getElementById('editFirstName').value = currentPlayer.first_name || '';
            document.getElementById('editLastName').value = currentPlayer.last_name || '';
            document.getElementById('editPhone').value = phoneVal;
            document.getElementById('editEmail').value = emailVal;

            // Profile section
            const bioVal = currentPlayer.bio || '';
            const homeBarVal = currentPlayer.home_bar || '';
            const dartconnectVal = currentPlayer.dartconnect_id || '';

            document.getElementById('bioValue').textContent = bioVal || 'Not set';
            document.getElementById('bioValue').classList.toggle('empty', !bioVal);
            document.getElementById('editBio').value = bioVal;

            document.getElementById('homeBarValue').textContent = homeBarVal || 'Not set';
            document.getElementById('homeBarValue').classList.toggle('empty', !homeBarVal);
            document.getElementById('editHomeBar').value = homeBarVal;

            document.getElementById('preferredGame').value = currentPlayer.preferred_game || '';

            // Integrations section
            document.getElementById('dartconnectValue').textContent = dartconnectVal || 'Not linked';
            document.getElementById('dartconnectValue').classList.toggle('empty', !dartconnectVal);
            document.getElementById('editDartconnect').value = dartconnectVal;

            // Load privacy settings
            loadPrivacySettings();

            // Load notification settings
            loadNotificationSettings();
        }

        function loadPrivacySettings() {
            if (!currentPlayer) return;

            const privacy = currentPlayer.privacy || {};

            // Default: phone/email hidden, stats/messages visible
            const showPhone = privacy.show_phone ?? false;
            const showEmail = privacy.show_email ?? false;
            const showStats = privacy.show_stats ?? true;
            const allowMessages = privacy.allow_messages ?? true;

            document.getElementById('privacyPhone').classList.toggle('on', showPhone);
            document.getElementById('privacyEmail').classList.toggle('on', showEmail);
            document.getElementById('privacyStats').classList.toggle('on', showStats);
            document.getElementById('privacyMessages').classList.toggle('on', allowMessages);
        }

        // Inline field editing
        window.startEditField = function(field) {
            const fieldEl = document.getElementById(`${field}Field`);
            fieldEl.classList.add('editing');

            // Focus the input
            const input = document.getElementById(`edit${field.charAt(0).toUpperCase() + field.slice(1)}`);
            if (input) {
                input.focus();
                input.select();
            }
        };

        window.cancelEditField = function(field) {
            const fieldEl = document.getElementById(`${field}Field`);
            fieldEl.classList.remove('editing');

            // Reset input to original value
            const inputId = `edit${field.charAt(0).toUpperCase() + field.slice(1)}`;
            const input = document.getElementById(inputId);

            if (field === 'lastName') input.value = currentPlayer.last_name || '';
            else if (field === 'phone') input.value = currentPlayer.phone || '';
            else if (field === 'email') input.value = currentPlayer.email || '';
            else if (field === 'bio') input.value = currentPlayer.bio || '';
            else if (field === 'homeBar') input.value = currentPlayer.home_bar || '';
            else if (field === 'dartconnect') input.value = currentPlayer.dartconnect_id || '';
        };

        window.saveField = async function(field) {
            if (!currentPlayer) return;

            const inputId = `edit${field.charAt(0).toUpperCase() + field.slice(1)}`;
            const input = document.getElementById(inputId);
            const newValue = input.value.trim();

            // Validation
            if (field === 'lastName' && !newValue) {
                alert('Last name is required');
                return;
            }

            if (field === 'email' && newValue && !newValue.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            try {
                const updateData = {
                    player_id: currentPlayer.id
                };

                // Map field to API field name
                if (field === 'lastName') {
                    updateData.last_name = newValue;
                    updateData.first_name = currentPlayer.first_name;
                } else if (field === 'phone') {
                    updateData.phone = newValue;
                } else if (field === 'email') {
                    updateData.email = newValue;
                } else if (field === 'bio') {
                    updateData.bio = newValue;
                } else if (field === 'homeBar') {
                    updateData.home_bar = newValue;
                } else if (field === 'dartconnect') {
                    updateData.dartconnect_id = newValue;
                }

                const result = await callFunction('updateGlobalPlayer', updateData);

                if (result.success) {
                    // Update local data and UI
                    if (field === 'lastName') {
                        currentPlayer.last_name = newValue;
                        currentPlayer.name = `${currentPlayer.first_name} ${newValue}`;
                        document.getElementById('welcomeName').textContent = currentPlayer.name;
                        document.getElementById('lastNameValue').textContent = newValue;
                    } else if (field === 'phone') {
                        currentPlayer.phone = newValue;
                        const phoneDisplay = document.getElementById('phoneValue');
                        phoneDisplay.textContent = newValue || 'Not set';
                        phoneDisplay.classList.toggle('empty', !newValue);
                    } else if (field === 'email') {
                        currentPlayer.email = newValue;
                        const emailDisplay = document.getElementById('emailValue');
                        emailDisplay.textContent = newValue || 'Not set';
                        emailDisplay.classList.toggle('empty', !newValue);
                    } else if (field === 'bio') {
                        currentPlayer.bio = newValue;
                        document.getElementById('bioValue').textContent = newValue || 'Not set';
                        document.getElementById('bioValue').classList.toggle('empty', !newValue);
                    } else if (field === 'homeBar') {
                        currentPlayer.home_bar = newValue;
                        document.getElementById('homeBarValue').textContent = newValue || 'Not set';
                        document.getElementById('homeBarValue').classList.toggle('empty', !newValue);
                    } else if (field === 'dartconnect') {
                        currentPlayer.dartconnect_id = newValue;
                        document.getElementById('dartconnectValue').textContent = newValue || 'Not linked';
                        document.getElementById('dartconnectValue').classList.toggle('empty', !newValue);
                    }

                    // Update session storage for name fields
                    if (field === 'lastName') {
                        const session = JSON.parse(localStorage.getItem('brdc_session') || '{}');
                        session.last_name = newValue;
                        session.name = currentPlayer.name;
                        localStorage.setItem('brdc_session', JSON.stringify(session));
                    }

                    // Exit edit mode
                    document.getElementById(`${field}Field`).classList.remove('editing');
                } else {
                    alert(result.error || 'Failed to update');
                }
            } catch (error) {
                console.error('Error saving field:', error);
                alert('Error saving changes');
            }
        };

        // Privacy toggle
        window.togglePrivacy = async function(setting) {
            if (!currentPlayer) return;

            const toggleEl = document.getElementById(`privacy${setting.split('_').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('')}`);
            const currentValue = toggleEl.classList.contains('on');
            const newValue = !currentValue;

            // Optimistic UI update
            toggleEl.classList.toggle('on', newValue);

            try {
                // Update privacy settings via updateGlobalPlayer
                const privacy = { ...(currentPlayer.privacy || {}) };
                privacy[setting] = newValue;

                const result = await callFunction('updateGlobalPlayer', {
                    player_id: currentPlayer.id,
                    privacy: privacy
                });

                if (result.success) {
                    currentPlayer.privacy = privacy;
                } else {
                    // Revert on failure
                    toggleEl.classList.toggle('on', currentValue);
                    alert(result.error || 'Failed to update privacy setting');
                }
            } catch (error) {
                console.error('Error updating privacy:', error);
                // Revert on error
                toggleEl.classList.toggle('on', currentValue);
                alert('Error updating privacy setting');
            }
        };

        // Save preferred game dropdown
        window.savePreferredGame = async function() {
            if (!currentPlayer) return;
            const newValue = document.getElementById('preferredGame').value;

            try {
                const result = await callFunction('updateGlobalPlayer', {
                    player_id: currentPlayer.id,
                    preferred_game: newValue
                });

                if (result.success) {
                    currentPlayer.preferred_game = newValue;
                }
            } catch (error) {
                console.error('Error saving preferred game:', error);
            }
        };

        // PIN visibility toggle
        let pinVisible = false;
        window.togglePinVisibility = function() {
            pinVisible = !pinVisible;
            const display = document.getElementById('currentPinDisplay');
            const btn = document.getElementById('showPinBtn');

            if (pinVisible) {
                display.textContent = currentPlayer.pin || 'Unknown';
                btn.textContent = 'Hide';
            } else {
                display.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                btn.textContent = 'Show';
            }
        };

        // Generate new PIN
        window.generateNewPin = async function() {
            if (!currentPlayer) return;

            if (!confirm('Generate a new PIN? Your old PIN will stop working immediately.')) {
                return;
            }

            try {
                const result = await callFunction('generateNewPin', {
                    player_id: currentPlayer.id
                });

                if (result.success && result.new_pin) {
                    currentPlayer.pin = result.new_pin;
                    alert(`Your new PIN is: ${result.new_pin}\n\nPlease save this somewhere safe!`);

                    // Update session
                    const session = JSON.parse(localStorage.getItem('brdc_session') || '{}');
                    session.pin = result.new_pin;
                    localStorage.setItem('brdc_session', JSON.stringify(session));

                    // Show new PIN
                    pinVisible = true;
                    document.getElementById('currentPinDisplay').textContent = result.new_pin;
                    document.getElementById('showPinBtn').textContent = 'Hide';
                } else {
                    alert(result.error || 'Failed to generate new PIN');
                }
            } catch (error) {
                console.error('Error generating PIN:', error);
                alert('Error generating new PIN');
            }
        };

        // Export player data
        window.exportMyData = async function() {
            if (!currentPlayer) return;

            try {
                // Fetch full player data
                const playerDoc = await getDoc(doc(db, 'players', currentPlayer.id));
                if (!playerDoc.exists()) {
                    alert('Could not find player data');
                    return;
                }

                const data = {
                    profile: playerDoc.data(),
                    exported_at: new Date().toISOString()
                };

                // Remove sensitive fields
                delete data.profile.pin;

                // Create download
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `brdc-player-data-${currentPlayer.id}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data');
            }
        };

        // Delete account confirmation
        window.confirmDeleteAccount = async function() {
            if (!currentPlayer) return;

            const confirmed = prompt(
                'This will permanently delete your account and all data.\n\n' +
                'Type "DELETE" to confirm:'
            );

            if (confirmed !== 'DELETE') {
                if (confirmed !== null) {
                    alert('Account deletion cancelled. You must type "DELETE" exactly.');
                }
                return;
            }

            try {
                const result = await callFunction('deletePlayerAccount', {
                    player_id: currentPlayer.id,
                    confirmation: 'DELETE'
                });

                if (result.success) {
                    alert('Your account has been deleted.');
                    localStorage.removeItem('brdc_session');
                    window.location.href = '/';
                } else {
                    alert(result.error || 'Failed to delete account');
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('Error deleting account. Please contact support.');
            }
        };

        // ============================================================================
        // LEAGUES TAB
        // ============================================================================

        // Leagues tab data
        let leaguesLoaded = false;

        async function loadLeaguesTab() {
            const container = document.getElementById('leaguesContent');
            if (!currentPlayer) {
                container.innerHTML = '<div class="empty-state">Please log in to view leagues</div>';
                return;
            }

            try {
                // Use allTeams which is already loaded (from roles.playing)
                if (!allTeams || allTeams.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 48px; margin-bottom: 15px;">üèÜ</div>
                            <div>No leagues found</div>
                            <div style="font-size: 12px; margin-top: 8px; color: #666;">Join a league to see your teammates here</div>
                        </div>
                    `;
                    leaguesLoaded = true;
                    return;
                }

                let html = '<div class="team-cards-grid">';

                for (const team of allTeams) {
                    // roles.playing uses: id (league), name (league), team_id, team_name
                    const leagueId = team.id || team.league_id;
                    const leagueName = team.name || team.league_name || 'League';
                    const teamId = team.team_id;  // This is the correct field from roles.playing
                    const teamName = team.team_name || 'My Team';
                    const isPast = team.status === 'completed';

                    // Get team record if we have a team_id
                    let wins = 0, losses = 0;
                    if (teamId) {
                        try {
                            const teamDoc = await getDoc(doc(db, 'leagues', leagueId, 'teams', teamId));
                            if (teamDoc.exists()) {
                                const teamData = teamDoc.data();
                                wins = teamData.wins || 0;
                                losses = teamData.losses || 0;
                            }
                        } catch (e) { /* ignore */ }
                    }

                    // Only link to league-team if we have a team_id, otherwise link to league-view
                    const linkUrl = teamId
                        ? `/pages/league-team.html?league_id=${leagueId}&team_id=${teamId}`
                        : `/pages/league-view.html?league_id=${leagueId}`;

                    html += `
                        <div class="team-card ${isPast ? 'past' : ''}" onclick="window.location.href='${linkUrl}'">
                            <div class="team-card-league">${leagueName}</div>
                            <div class="team-card-name">${teamName}</div>
                            <div class="team-card-record">${wins} - ${losses}</div>
                            <div class="team-card-arrow">‚Üí</div>
                        </div>
                    `;
                }

                html += '</div>';
                container.innerHTML = html;
                leaguesLoaded = true;
            } catch (error) {
                console.error('Error loading leagues tab:', error);
                container.innerHTML = '<div class="empty-state">Error loading leagues</div>';
            }
        }

        // ============================================================================
        // MATCH HISTORY TAB
        // ============================================================================

        let historyLoaded = false;
        let matchHistoryData = [];

        async function loadMatchHistory() {
            const container = document.getElementById('matchHistoryContent');
            const leagueFilter = document.getElementById('historyLeagueFilter');

            if (!currentPlayer) {
                container.innerHTML = '<div class="empty-state">Please log in to view match history</div>';
                return;
            }

            container.innerHTML = '<div class="empty-state">Loading match history...</div>';

            try {
                matchHistoryData = [];

                // Populate league filter dropdown
                let filterHtml = '<option value="all">All Leagues</option>';
                for (const team of allTeams) {
                    const leagueId = team.id || team.league_id;
                    const leagueName = team.name || team.league_name || 'League';
                    filterHtml += `<option value="${leagueId}">${leagueName}</option>`;
                }
                leagueFilter.innerHTML = filterHtml;

                // Load matches from all leagues the player is in
                for (const team of allTeams) {
                    const leagueId = team.id || team.league_id;
                    const leagueName = team.name || team.league_name || 'League';
                    const teamId = team.team_id;

                    if (!teamId) continue;

                    // Get completed matches where player's team participated
                    const matchesSnap = await getDocs(
                        query(
                            collection(db, 'leagues', leagueId, 'matches'),
                            where('status', '==', 'completed')
                        )
                    );

                    for (const matchDoc of matchesSnap.docs) {
                        const match = matchDoc.data();

                        // Check if this team was in the match
                        if (match.home_team_id !== teamId && match.away_team_id !== teamId) continue;

                        const isHome = match.home_team_id === teamId;
                        const myScore = isHome ? (match.home_score || 0) : (match.away_score || 0);
                        const oppScore = isHome ? (match.away_score || 0) : (match.home_score || 0);
                        const oppTeamName = isHome ? (match.away_team_name || 'Opponent') : (match.home_team_name || 'Opponent');
                        const myTeamName = isHome ? (match.home_team_name || team.team_name) : (match.away_team_name || team.team_name);

                        let result = 'tie';
                        if (myScore > oppScore) result = 'win';
                        else if (oppScore > myScore) result = 'loss';

                        // Get player's individual stats from this match
                        let playerMatchStats = null;
                        if (match.player_stats && match.player_stats[currentPlayer.id]) {
                            playerMatchStats = match.player_stats[currentPlayer.id];
                        }

                        matchHistoryData.push({
                            matchId: matchDoc.id,
                            leagueId: leagueId,
                            leagueName: leagueName,
                            date: match.date || match.match_date || '',
                            week: match.week,
                            myTeamName: myTeamName,
                            oppTeamName: oppTeamName,
                            myScore: myScore,
                            oppScore: oppScore,
                            result: result,
                            playerStats: playerMatchStats
                        });
                    }
                }

                // Sort by date descending
                matchHistoryData.sort((a, b) => new Date(b.date) - new Date(a.date));

                historyLoaded = true;
                filterMatchHistory();

            } catch (error) {
                console.error('Error loading match history:', error);
                container.innerHTML = '<div class="empty-state">Error loading match history</div>';
            }
        }

        window.filterMatchHistory = function() {
            const container = document.getElementById('matchHistoryContent');
            const leagueFilter = document.getElementById('historyLeagueFilter').value;
            const gameFilter = document.getElementById('historyGameFilter').value;

            let filtered = matchHistoryData;

            if (leagueFilter !== 'all') {
                filtered = filtered.filter(m => m.leagueId === leagueFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">No match history found</div>';
                return;
            }

            let html = '';
            for (const match of filtered) {
                const dateStr = match.date ? new Date(match.date + 'T12:00:00').toLocaleDateString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
                }) : 'Unknown date';

                const resultClass = match.result;
                const resultText = match.result.toUpperCase();

                // Player stats for this match
                let statsHtml = '';
                if (match.playerStats) {
                    const ps = match.playerStats;
                    const x01Avg = ps.x01_three_dart_avg || ps.x01_avg || ps.three_dart_avg;
                    const mpr = ps.cricket_mpr || ps.mpr;
                    const checkout = ps.x01_high_checkout || ps.high_checkout;

                    statsHtml = `
                        <div class="match-history-stats">
                            ${x01Avg ? `<div class="match-history-stat"><div class="match-history-stat-value">${Number(x01Avg).toFixed(1)}</div><div class="match-history-stat-label">3DA</div></div>` : ''}
                            ${mpr ? `<div class="match-history-stat"><div class="match-history-stat-value">${Number(mpr).toFixed(2)}</div><div class="match-history-stat-label">MPR</div></div>` : ''}
                            ${ps.x01_legs_won != null ? `<div class="match-history-stat"><div class="match-history-stat-value">${ps.x01_legs_won}/${ps.x01_legs_played || 0}</div><div class="match-history-stat-label">501 Legs</div></div>` : ''}
                            ${ps.cricket_legs_won != null ? `<div class="match-history-stat"><div class="match-history-stat-value">${ps.cricket_legs_won}/${ps.cricket_legs_played || 0}</div><div class="match-history-stat-label">Cricket</div></div>` : ''}
                            ${checkout ? `<div class="match-history-stat"><div class="match-history-stat-value">${checkout}</div><div class="match-history-stat-label">High Out</div></div>` : ''}
                        </div>
                    `;
                }

                html += `
                    <div class="match-history-item">
                        <div class="match-history-header">
                            <span class="match-history-date">${dateStr}${match.week ? ` ‚Ä¢ Week ${match.week}` : ''}</span>
                            <span class="match-history-league">${match.leagueName}</span>
                        </div>
                        <div class="match-history-teams">
                            <div class="match-history-team ${match.result === 'win' ? 'winner' : ''}">
                                <div class="match-history-team-name">${match.myTeamName}</div>
                                <span class="match-history-result ${resultClass}">${resultText}</span>
                            </div>
                            <div class="match-history-score">${match.myScore} - ${match.oppScore}</div>
                            <div class="match-history-team ${match.result === 'loss' ? 'winner' : ''}">
                                <div class="match-history-team-name">${match.oppTeamName}</div>
                            </div>
                        </div>
                        ${statsHtml}
                    </div>
                `;
            }

            container.innerHTML = html;
        };

        // ============================================================================
        // STATS TAB
        // ============================================================================

        let statsLoaded = false;

        async function loadDetailedStats() {
            if (!currentPlayer) return;

            const statsFilter = document.getElementById('statsLeagueFilter');

            // Populate filter dropdown
            let filterHtml = '<option value="all">All-Time Stats</option>';
            for (const team of allTeams) {
                const leagueId = team.id || team.league_id;
                const leagueName = team.name || team.league_name || 'League';
                filterHtml += `<option value="${leagueId}">${leagueName}</option>`;
            }
            statsFilter.innerHTML = filterHtml;

            await loadStatsForFilter('all');
            loadAchievements();
            statsLoaded = true;
        }

        window.loadDetailedStats = async function() {
            const filter = document.getElementById('statsLeagueFilter').value;
            await loadStatsForFilter(filter);
        };

        async function loadStatsForFilter(filter) {
            // Aggregate stats across leagues or for specific league
            let x01Stats = {
                total_points: 0, total_darts: 0, legs_won: 0, legs_played: 0,
                first9_points: 0, first9_darts: 0,
                checkouts_hit: 0, checkout_attempts: 0, checkout_total: 0,
                high_checkout: 0, high_score: 0,
                ton180: 0, ton140: 0, ton100: 0
            };
            let cricketStats = {
                total_marks: 0, total_rounds: 0, legs_won: 0, legs_played: 0,
                six_mark_rounds: 0, nine_mark_rounds: 0, high_round: 0
            };
            let totalMatches = 0;
            let matchWins = 0;

            try {
                for (const team of allTeams) {
                    const leagueId = team.id || team.league_id;

                    if (filter !== 'all' && filter !== leagueId) continue;

                    // Try aggregated_stats first
                    const aggStatsDoc = await getDoc(doc(db, 'leagues', leagueId, 'aggregated_stats', currentPlayer.id));

                    if (aggStatsDoc.exists()) {
                        const s = aggStatsDoc.data();

                        // X01 stats
                        x01Stats.total_points += s.x01_total_points || 0;
                        x01Stats.total_darts += s.x01_total_darts || 0;
                        x01Stats.legs_won += s.x01_legs_won || 0;
                        x01Stats.legs_played += s.x01_legs_played || 0;
                        x01Stats.first9_points += s.x01_first9_points || 0;
                        x01Stats.first9_darts += s.x01_first9_darts || 0;
                        x01Stats.checkouts_hit += s.x01_checkouts_hit || 0;
                        x01Stats.checkout_attempts += s.x01_checkout_attempts || 0;
                        x01Stats.checkout_total += s.x01_total_checkout_points || 0;
                        x01Stats.high_checkout = Math.max(x01Stats.high_checkout, s.x01_high_checkout || 0);
                        x01Stats.high_score = Math.max(x01Stats.high_score, s.x01_high_score || 0);
                        x01Stats.ton180 += s.x01_ton_80 || s.x01_180s || 0;
                        x01Stats.ton140 += s.x01_ton_40 || s.x01_140s || 0;
                        x01Stats.ton100 += s.x01_tons || s.x01_100s || 0;

                        // Cricket stats
                        cricketStats.total_marks += s.cricket_total_marks || 0;
                        cricketStats.total_rounds += s.cricket_total_rounds || 0;
                        cricketStats.legs_won += s.cricket_legs_won || 0;
                        cricketStats.legs_played += s.cricket_legs_played || 0;
                        cricketStats.six_mark_rounds += s.cricket_6_mark_rounds || 0;
                        cricketStats.nine_mark_rounds += s.cricket_9_mark_rounds || 0;
                        cricketStats.high_round = Math.max(cricketStats.high_round, s.cricket_high_round || 0);

                        totalMatches += s.matches_played || 0;
                        matchWins += s.matches_won || 0;
                    }
                }

                // Calculate derived stats
                const x01Avg = x01Stats.total_darts > 0 ? (x01Stats.total_points / x01Stats.total_darts * 3).toFixed(1) : '-';
                const first9Avg = x01Stats.first9_darts > 0 ? (x01Stats.first9_points / x01Stats.first9_darts * 3).toFixed(1) : '-';
                const checkoutPct = x01Stats.checkout_attempts > 0 ? ((x01Stats.checkouts_hit / x01Stats.checkout_attempts) * 100).toFixed(1) + '%' : '-';
                const avgCheckout = x01Stats.checkouts_hit > 0 ? (x01Stats.checkout_total / x01Stats.checkouts_hit).toFixed(1) : '-';
                const x01WinRate = x01Stats.legs_played > 0 ? ((x01Stats.legs_won / x01Stats.legs_played) * 100).toFixed(0) + '%' : '-';

                const mpr = cricketStats.total_rounds > 0 ? (cricketStats.total_marks / cricketStats.total_rounds).toFixed(2) : '-';
                const cricketWinRate = cricketStats.legs_played > 0 ? ((cricketStats.legs_won / cricketStats.legs_played) * 100).toFixed(0) + '%' : '-';

                const overallWinRate = totalMatches > 0 ? ((matchWins / totalMatches) * 100).toFixed(0) + '%' : '-';

                // Update overview cards
                document.getElementById('statTotalMatches').textContent = totalMatches || '-';
                document.getElementById('statWinRate').textContent = overallWinRate;
                document.getElementById('statOverall3DA').textContent = x01Avg;
                document.getElementById('statOverallMPR').textContent = mpr;

                // Update X01 stats
                document.getElementById('stat501Avg').textContent = x01Avg;
                document.getElementById('stat501First9').textContent = first9Avg;
                document.getElementById('stat501Checkout').textContent = checkoutPct;
                document.getElementById('stat501AvgOut').textContent = avgCheckout;
                document.getElementById('stat501HighOut').textContent = x01Stats.high_checkout || '-';
                document.getElementById('stat501Legs').textContent = x01Stats.legs_played > 0 ? `${x01Stats.legs_won}/${x01Stats.legs_played} (${x01WinRate})` : '-';
                document.getElementById('stat501_180s').textContent = x01Stats.ton180 || '0';
                document.getElementById('stat501_140s').textContent = x01Stats.ton140 || '0';
                document.getElementById('stat501_100s').textContent = x01Stats.ton100 || '0';
                document.getElementById('stat501High').textContent = x01Stats.high_score || '-';

                // Update Cricket stats
                document.getElementById('statCricketMPR').textContent = mpr;
                document.getElementById('statCricketLegs').textContent = cricketStats.legs_played > 0 ? `${cricketStats.legs_won}/${cricketStats.legs_played}` : '-';
                document.getElementById('statCricketWinRate').textContent = cricketWinRate;
                document.getElementById('statCricketMarks').textContent = cricketStats.total_marks || '-';
                document.getElementById('statCricketRounds').textContent = cricketStats.total_rounds || '-';
                document.getElementById('statCricket6Mark').textContent = cricketStats.six_mark_rounds || '0';
                document.getElementById('statCricket9Mark').textContent = cricketStats.nine_mark_rounds || '0';
                document.getElementById('statCricketHighRound').textContent = cricketStats.high_round || '-';

            } catch (error) {
                console.error('Error loading detailed stats:', error);
            }
        }

        function loadAchievements() {
            const container = document.getElementById('achievementsGrid');

            // Define achievements based on stats
            const achievements = [
                { id: '180_club', icon: 'üéØ', name: 'The 180 Club', desc: 'Hit your first 180', check: () => currentPlayer.stats?.x01_ton_80 > 0 || currentPlayer.stats?.x01_180s > 0 },
                { id: 'ton_80_master', icon: 'üíØ', name: '180 Master', desc: 'Hit 10 180s', check: () => (currentPlayer.stats?.x01_ton_80 || currentPlayer.stats?.x01_180s || 0) >= 10 },
                { id: 'high_roller', icon: 'üèÜ', name: 'High Roller', desc: '100+ checkout', check: () => (currentPlayer.stats?.x01_high_checkout || 0) >= 100 },
                { id: 'checkout_king', icon: 'üëë', name: 'Checkout King', desc: '150+ checkout', check: () => (currentPlayer.stats?.x01_high_checkout || 0) >= 150 },
                { id: 'sharp_shooter', icon: 'üéØ', name: 'Sharp Shooter', desc: '50+ 3DA', check: () => get3DA(currentPlayer.stats) >= 50 },
                { id: 'pro_average', icon: '‚≠ê', name: 'Pro Average', desc: '60+ 3DA', check: () => get3DA(currentPlayer.stats) >= 60 },
                { id: 'cricket_star', icon: 'ü¶ó', name: 'Cricket Star', desc: '2.5+ MPR', check: () => getMPR(currentPlayer.stats) >= 2.5 },
                { id: 'cricket_pro', icon: 'üåü', name: 'Cricket Pro', desc: '3.0+ MPR', check: () => getMPR(currentPlayer.stats) >= 3.0 },
                { id: 'first_win', icon: 'üèÖ', name: 'First Victory', desc: 'Win your first match', check: () => (currentPlayer.stats?.matches_won || 0) >= 1 },
                { id: 'veteran', icon: 'üéñÔ∏è', name: 'Veteran', desc: 'Play 10 matches', check: () => (currentPlayer.stats?.matches_played || 0) >= 10 },
                { id: 'regular', icon: 'üìÖ', name: 'Regular', desc: 'Play 25 matches', check: () => (currentPlayer.stats?.matches_played || 0) >= 25 },
                { id: 'dedicated', icon: 'üí™', name: 'Dedicated', desc: 'Play 50 matches', check: () => (currentPlayer.stats?.matches_played || 0) >= 50 },
            ];

            let html = '';
            for (const ach of achievements) {
                const unlocked = ach.check();
                html += `
                    <div class="achievement ${unlocked ? 'unlocked' : 'locked'}">
                        <div class="achievement-icon">${ach.icon}</div>
                        <div class="achievement-name">${ach.name}</div>
                        <div class="achievement-desc">${ach.desc}</div>
                    </div>
                `;
            }

            container.innerHTML = html || '<div class="empty-state">No achievements yet</div>';
        }

        // Helper functions for achievements (if not already defined)
        function get3DA(stats) {
            if (!stats) return 0;
            if (stats.x01_three_dart_avg) return Number(stats.x01_three_dart_avg);
            if (stats.x01_total_darts > 0) return (stats.x01_total_points / stats.x01_total_darts) * 3;
            return stats.x01_avg || stats.three_dart_avg || stats.ppd || 0;
        }

        function getMPR(stats) {
            if (!stats) return 0;
            if (stats.cricket_mpr) return Number(stats.cricket_mpr);
            if (stats.cricket_total_rounds > 0) return stats.cricket_total_marks / stats.cricket_total_rounds;
            return stats.mpr || 0;
        }

        // Tournaments tab data
        let tournamentsLoaded = false;

        async function loadTournamentsTab() {
            const container = document.getElementById('tournamentsContent');
            if (!currentPlayer) {
                container.innerHTML = '<div class="empty-state">Please log in to view tournaments</div>';
                return;
            }

            try {
                // Find tournaments player has participated in
                const tournamentsSnap = await getDocs(collection(db, 'tournaments'));
                const playerTournaments = [];

                for (const tournDoc of tournamentsSnap.docs) {
                    const tournament = tournDoc.data();
                    const tournamentId = tournDoc.id;

                    // Check if player is registered
                    try {
                        const regSnap = await getDocs(
                            query(
                                collection(db, 'tournaments', tournamentId, 'registrations'),
                                where('player_id', '==', currentPlayer.id)
                            )
                        );

                        if (!regSnap.empty) {
                            // Get player stats for this tournament
                            let playerStats = { x01_three_dart_avg: '-', cricket_mpr: '-' };
                            try {
                                const statsDoc = await getDoc(doc(db, 'tournaments', tournamentId, 'stats', currentPlayer.id));
                                if (statsDoc.exists()) {
                                    const s = statsDoc.data();
                                    // Calculate 3DA from components if available, else use canonical/legacy fields
                                    if (s.x01_total_darts > 0) {
                                        playerStats.x01_three_dart_avg = (s.x01_total_points / s.x01_total_darts * 3).toFixed(1);
                                    } else if (s.x01_three_dart_avg != null) {
                                        playerStats.x01_three_dart_avg = Number(s.x01_three_dart_avg).toFixed(1);
                                    } else if (s.x01_avg != null) {
                                        playerStats.x01_three_dart_avg = Number(s.x01_avg).toFixed(1);
                                    }
                                    // Calculate MPR from components if available, else use canonical/legacy fields
                                    if (s.cricket_total_rounds > 0) {
                                        playerStats.cricket_mpr = (s.cricket_total_marks / s.cricket_total_rounds).toFixed(2);
                                    } else if (s.cricket_mpr != null) {
                                        playerStats.cricket_mpr = Number(s.cricket_mpr).toFixed(2);
                                    } else if (s.mpr != null) {
                                        playerStats.cricket_mpr = Number(s.mpr).toFixed(2);
                                    }
                                }
                            } catch (e) { /* stats not available */ }

                            playerTournaments.push({
                                id: tournamentId,
                                name: tournament.tournament_name || tournament.name || 'Tournament',
                                date: tournament.date || tournament.start_date,
                                status: tournament.status,
                                ...playerStats
                            });
                        }
                    } catch (e) { /* skip */ }
                }

                if (playerTournaments.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div style="font-size: 48px; margin-bottom: 15px;">üéØ</div>
                            <div>No tournaments found</div>
                            <div style="font-size: 12px; margin-top: 8px; color: #666;">Register for a tournament to see it here</div>
                        </div>
                    `;
                    tournamentsLoaded = true;
                    return;
                }

                // Sort by date (most recent first)
                playerTournaments.sort((a, b) => {
                    const dateA = a.date?.toDate?.() || new Date(a.date || 0);
                    const dateB = b.date?.toDate?.() || new Date(b.date || 0);
                    return dateB - dateA;
                });

                container.innerHTML = playerTournaments.map(t => {
                    const isPast = t.status === 'completed';
                    const dateStr = t.date
                        ? (t.date.toDate ? t.date.toDate() : new Date(t.date)).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                        : '';

                    return `
                        <div class="league-team-card tournament ${isPast ? 'past' : ''}" onclick="window.location.href='/pages/tournament-view.html?tournament_id=${t.id}'">
                            <div class="league-team-header">
                                <div>
                                    <div class="league-team-name">${t.name}</div>
                                    <div class="league-team-league">${dateStr}</div>
                                </div>
                                <div class="league-team-stats">
                                    <div><span class="stat-label">3DA:</span> <span class="stat-value">${t.x01_three_dart_avg}</span></div>
                                    <div><span class="stat-label">MPR:</span> <span class="stat-value">${t.cricket_mpr}</span></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                tournamentsLoaded = true;
            } catch (error) {
                console.error('Error loading tournaments tab:', error);
                container.innerHTML = '<div class="empty-state">Error loading tournaments</div>';
            }
        }

        window.switchCaptainSubtab = function(subtabName) {
            document.querySelectorAll('.captain-subtab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.captain-subcontent').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById('captain' + subtabName.charAt(0).toUpperCase() + subtabName.slice(1)).classList.add('active');
        };

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================

        window.logout = function() {
            localStorage.removeItem('brdc_session');
            currentPlayer = null;
            document.getElementById('pinInput').value = '';
            showLoginPage();
        };

        window.showForgotPin = function() {
            const email = prompt('Enter your email address to recover your PIN:');
            if (email) {
                callFunction('recoverPin', { email: email })
                    .then(result => {
                        alert(result.message || 'If an account exists, your PIN has been sent to your email.');
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
            }
            return false;
        };

        // Handle Enter key
        document.getElementById('pinInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => {})
                .catch(err => console.error('[SW] Registration failed:', err));
        }
    </script>
    <script src="/js/nav-menu.js"></script>
    <script src="/js/stats-helpers.js"></script>
    <script src="/js/feedback.js"></script>
</body>
</html>
