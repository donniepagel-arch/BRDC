<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cricket Scorer - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    
    <!-- PWA / iOS Standalone Mode -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cricket Scorer">
    <link rel="apple-touch-icon" href="/images/favicon.png">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        :root {
            --pink: #FF469A;
            --blue-light: #1F85AF;
            --blue-dark: #001F4D;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --black: #000000;
            --white: #FFFFFF;
            --gray: #6B7280;
            --gray-light: #E5E7EB;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
        }

        body {
            background: linear-gradient(180deg, var(--blue-light) 0%, var(--blue-dark) 100%);
            overflow: hidden;
            touch-action: manipulation;
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            width: 100dvw;
            position: fixed;
            top: 0;
            left: 0;
        }

        /* WELCOME SCREEN */
        .welcome-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            width: 100dvw;
            position: fixed;
            top: 0;
            left: 0;
        }

        .welcome-container {
            background: var(--white);
            border: 4px solid var(--black);
            box-shadow: 12px 12px 0 rgba(0, 0, 0, 1);
            padding: 60px 40px;
            max-width: 600px;
            text-align: center;
        }

        .welcome-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 64px;
            color: var(--pink);
            text-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
            margin-bottom: 16px;
            letter-spacing: 4px;
        }

        .welcome-subtitle {
            font-size: 18px;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 40px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .welcome-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .welcome-btn {
            padding: 24px 40px;
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            border: 4px solid var(--black);
            cursor: pointer;
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 1);
            transition: all 0.2s;
            letter-spacing: 2px;
            background: var(--teal);
            color: var(--black);
        }

        .welcome-btn:hover {
            transform: translateY(-4px);
            box-shadow: 10px 10px 0 rgba(0, 0, 0, 1);
        }

        /* GAME SCREEN */
        .game-screen {
            display: none;
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            width: 100dvw;
            padding: 8px;
            overflow: hidden;
        }

        .game-container {
            background: var(--white);
            border: 4px solid var(--black);
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 1);
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* MAIN CONTENT */
        .game-content {
            display: grid;
            grid-template-columns: 70% 30%;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* LEFT: SCOREBOARD */
        .scoreboard {
            border-right: 4px solid var(--black);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .score-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 12px;
            border-bottom: 4px solid var(--black);
            background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%);
            flex-shrink: 0;
        }

        .player-score-area {
            text-align: center;
            padding: 10px;
            border: 3px solid var(--black);
            background: var(--white);
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .player-score-area.active {
            background: var(--pink);
            border-color: var(--black);
            box-shadow: 5px 5px 0 rgba(0, 0, 0, 0.8);
        }

        .player-score-area.active .player-score-display,
        .player-score-area.active .score-value {
            color: var(--white);
            text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.5);
        }

        .player-score-area input {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--black);
            background: transparent;
            border: 2px dashed var(--pink);
            text-align: center;
            padding: 4px;
            width: 100%;
            letter-spacing: 2px;
            margin-bottom: 6px;
        }

        .player-score-area input:focus {
            outline: none;
            border: 2px solid var(--pink);
            background: rgba(255, 70, 154, 0.1);
        }

        .player-score-area input::placeholder {
            color: var(--pink);
            opacity: 0.6;
        }

        .player-score-display {
            display: none;
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--black);
            letter-spacing: 2px;
            margin-bottom: 6px;
        }

        .game-started .player-score-area input {
            display: none;
        }

        .game-started .player-score-display {
            display: block;
        }

        .score-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 52px;
            color: var(--pink);
            text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.2);
            letter-spacing: 2px;
            line-height: 1;
        }

        .cricket-board {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 8px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .number-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 12px;
            padding: 5px 10px;
            background: var(--white);
            border: 3px solid var(--black);
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .number-row.p1-leading {
            background: linear-gradient(90deg, var(--pink) 0%, rgba(255, 70, 154, 0.3) 50%, var(--white) 100%);
        }

        .number-row.p2-leading {
            background: linear-gradient(270deg, var(--teal) 0%, rgba(145, 215, 235, 0.3) 50%, var(--white) 100%);
        }

        .number-row.both-closed {
            background: var(--gray-light);
            opacity: 0.6;
        }

        .marks {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            font-weight: 900;
            color: var(--black);
            letter-spacing: 2px;
            text-align: center;
        }

        /* Circled X for closed numbers */
        .marks.closed {
            font-size: 0;
        }

        .marks.closed::before {
            content: 'X';
            font-size: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border: 4px solid var(--black);
            border-radius: 50%;
            background: var(--yellow);
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.4);
        }

        .marks.player1 {
            text-align: right;
        }

        .marks.player2 {
            text-align: left;
        }

        .number-label {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--black);
            letter-spacing: 2px;
            text-align: center;
            min-width: 90px;
            background: var(--yellow);
            border: 4px solid var(--black);
            padding: 4px 10px;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 1);
        }

        .stats-row {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            border-top: 4px solid var(--black);
            background: var(--gray-light);
            flex-shrink: 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--gray);
            margin-bottom: 2px;
        }

        .stat-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--pink);
        }

        /* RIGHT: INPUT PANEL */
        .input-panel {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: hidden;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            flex: 1;
        }

        .input-btn {
            border: 3px solid var(--black);
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 1);
            transition: all 0.15s;
            background: var(--teal);
            color: var(--black);
            letter-spacing: 1px;
            padding: 10px 6px;
            user-select: none;
            -webkit-user-select: none;
            min-height: 45px;
        }

        .input-btn:active {
            transform: translateY(2px);
            box-shadow: 1px 1px 0 rgba(0, 0, 0, 1);
        }

        .input-btn:hover {
            background: #7DC8E0;
        }

        .input-btn.single {
            background: var(--white);
        }

        .input-btn.single:hover {
            background: var(--gray-light);
        }

        .input-btn.double {
            background: var(--teal);
        }

        .input-btn.double:hover {
            background: #7DC8E0;
        }

        .input-btn.triple {
            background: var(--pink);
            color: var(--white);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
        }

        .input-btn.triple:hover {
            background: #E03786;
        }

        .input-btn.action {
            background: var(--yellow);
        }

        .input-btn.action:hover {
            background: #F9D71C;
        }

        .input-btn.miss {
            background: #E03786;
            color: var(--white);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
        }

        .input-btn.miss:hover {
            background: #C82D71;
        }

        .dart-count {
            background: linear-gradient(135deg, var(--gray-light) 0%, #d1d5db 100%);
            border: 3px solid var(--black);
            padding: 8px;
            text-align: center;
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .dart-count-label {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--gray);
            margin-bottom: 3px;
        }

        .dart-count-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--pink);
            letter-spacing: 2px;
        }

        .last-turn {
            background: linear-gradient(135deg, var(--gray-light) 0%, #d1d5db 100%);
            border: 3px solid var(--black);
            padding: 8px;
            text-align: center;
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .last-turn-label {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--gray);
            margin-bottom: 4px;
        }

        .last-turn-value {
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            color: var(--black);
            letter-spacing: 1px;
            line-height: 1.2;
        }

        /* WINNER MODAL */
        .winner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .winner-modal.active {
            display: flex;
        }

        .winner-content {
            background: var(--white);
            border: 6px solid var(--black);
            box-shadow: 16px 16px 0 rgba(0, 0, 0, 1);
            padding: 60px;
            text-align: center;
            max-width: 600px;
        }

        .winner-trophy {
            font-size: 120px;
            margin-bottom: 20px;
        }

        .winner-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 96px;
            color: var(--pink);
            text-shadow: 6px 6px 0 rgba(0, 0, 0, 0.3);
            margin-bottom: 40px;
            letter-spacing: 4px;
        }

        .winner-stats {
            margin-bottom: 40px;
            font-size: 24px;
            font-weight: 700;
        }

        .new-game-btn {
            padding: 20px 40px;
            background: var(--pink);
            color: var(--white);
            border: 4px solid var(--black);
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            cursor: pointer;
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 1);
            letter-spacing: 2px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
        }

        .new-game-btn:hover {
            background: #E03786;
            transform: translateY(-4px);
            box-shadow: 10px 10px 0 rgba(0, 0, 0, 1);
        }

        .hidden {
            display: none !important;
        }

        /* Bot Selection */
        .bot-select-btn {
            background: rgba(145,215,235,0.3);
            border: 2px solid var(--teal);
            padding: 6px 10px;
            color: var(--teal);
            font-size: 12px;
            font-weight: 800;
            cursor: pointer;
            margin-top: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .bot-select-btn:active { transform: scale(0.95); }
        .bot-select-btn.selected { background: var(--teal); color: var(--black); }

        .game-started .bot-select-btn { display: none; }

        .bot-btn-container {
            position: relative;
            display: inline-block;
        }

        .bot-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 4px;
            background: var(--white);
            border: 3px solid var(--teal);
            z-index: 100;
            min-width: 160px;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.5);
        }

        .bot-dropdown.open { display: block; }

        .bot-option {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            transition: background 0.15s;
            text-align: left;
        }

        .bot-option:last-child { border-bottom: none; }
        .bot-option:hover, .bot-option:active { background: rgba(145,215,235,0.3); }
        .bot-option.disabled { opacity: 0.4; cursor: not-allowed; }

        .bot-option-name {
            font-weight: 700;
            color: var(--teal);
            font-size: 13px;
        }

        .bot-option-avg {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <!-- WELCOME SCREEN -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-container">
            <div class="welcome-title">üéØ CRICKET</div>
            <div class="welcome-subtitle">Burning River Dart Club</div>
            <div class="welcome-buttons">
                <button class="welcome-btn" onclick="startGame()">START GAME</button>
            </div>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div class="game-screen" id="gameScreen">
        <div class="game-container">
            <!-- MAIN CONTENT -->
            <div class="game-content">
                <!-- LEFT: SCOREBOARD -->
                <div class="scoreboard">
                    <!-- PLAYER SCORES -->
                    <div class="score-header">
                        <div class="player-score-area">
                            <input type="text" id="player1NameInput" placeholder="TAP TO ENTER NAME" maxlength="20">
                            <div class="player-score-display" id="player1NameDisplay">PLAYER 1</div>
                            <div class="bot-btn-container">
                                <button class="bot-select-btn" id="bot1Btn" onclick="toggleBotDropdown(1)">&#129302; BOT</button>
                                <div class="bot-dropdown" id="botDropdown1"></div>
                            </div>
                            <div class="score-value" id="player1Score">0</div>
                        </div>
                        <div class="player-score-area">
                            <input type="text" id="player2NameInput" placeholder="TAP TO ENTER NAME" maxlength="20">
                            <div class="player-score-display" id="player2NameDisplay">PLAYER 2</div>
                            <div class="bot-btn-container">
                                <button class="bot-select-btn" id="bot2Btn" onclick="toggleBotDropdown(2)">&#129302; BOT</button>
                                <div class="bot-dropdown" id="botDropdown2"></div>
                            </div>
                            <div class="score-value" id="player2Score">0</div>
                        </div>
                    </div>

                    <!-- CRICKET BOARD -->
                    <div class="cricket-board">
                        <div class="number-row" data-number="20">
                            <div class="marks player1" id="p1-20"></div>
                            <div class="number-label">20</div>
                            <div class="marks player2" id="p2-20"></div>
                        </div>

                        <div class="number-row" data-number="19">
                            <div class="marks player1" id="p1-19"></div>
                            <div class="number-label">19</div>
                            <div class="marks player2" id="p2-19"></div>
                        </div>

                        <div class="number-row" data-number="18">
                            <div class="marks player1" id="p1-18"></div>
                            <div class="number-label">18</div>
                            <div class="marks player2" id="p2-18"></div>
                        </div>

                        <div class="number-row" data-number="17">
                            <div class="marks player1" id="p1-17"></div>
                            <div class="number-label">17</div>
                            <div class="marks player2" id="p2-17"></div>
                        </div>

                        <div class="number-row" data-number="16">
                            <div class="marks player1" id="p1-16"></div>
                            <div class="number-label">16</div>
                            <div class="marks player2" id="p2-16"></div>
                        </div>

                        <div class="number-row" data-number="15">
                            <div class="marks player1" id="p1-15"></div>
                            <div class="number-label">15</div>
                            <div class="marks player2" id="p2-15"></div>
                        </div>

                        <div class="number-row" data-number="25">
                            <div class="marks player1" id="p1-25"></div>
                            <div class="number-label">BULL</div>
                            <div class="marks player2" id="p2-25"></div>
                        </div>
                    </div>

                    <!-- STATS -->
                    <div class="stats-row">
                        <div class="stat-item">
                            <div class="stat-label">MPR</div>
                            <div class="stat-value" id="p1-mpr">0.0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Closed</div>
                            <div class="stat-value" id="p1-closed">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Closed</div>
                            <div class="stat-value" id="p2-closed">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">MPR</div>
                            <div class="stat-value" id="p2-mpr">0.0</div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: INPUT PANEL -->
                <div class="input-panel">
                    <div class="dart-count">
                        <div class="dart-count-label">Darts Thrown</div>
                        <div class="dart-count-value" id="dartCount">0 / 3</div>
                    </div>

                    <div class="input-grid">
                        <!-- 20s -->
                        <button class="input-btn single" data-hit="S20">20</button>
                        <button class="input-btn double" data-hit="D20">D20</button>
                        <button class="input-btn triple" data-hit="T20">T20</button>
                        
                        <!-- 19s -->
                        <button class="input-btn single" data-hit="S19">19</button>
                        <button class="input-btn double" data-hit="D19">D19</button>
                        <button class="input-btn triple" data-hit="T19">T19</button>
                        
                        <!-- 18s -->
                        <button class="input-btn single" data-hit="S18">18</button>
                        <button class="input-btn double" data-hit="D18">D18</button>
                        <button class="input-btn triple" data-hit="T18">T18</button>
                        
                        <!-- 17s -->
                        <button class="input-btn single" data-hit="S17">17</button>
                        <button class="input-btn double" data-hit="D17">D17</button>
                        <button class="input-btn triple" data-hit="T17">T17</button>
                        
                        <!-- 16s -->
                        <button class="input-btn single" data-hit="S16">16</button>
                        <button class="input-btn double" data-hit="D16">D16</button>
                        <button class="input-btn triple" data-hit="T16">T16</button>
                        
                        <!-- 15s -->
                        <button class="input-btn single" data-hit="S15">15</button>
                        <button class="input-btn double" data-hit="D15">D15</button>
                        <button class="input-btn triple" data-hit="T15">T15</button>
                        
                        <!-- Bulls -->
                        <button class="input-btn single" data-hit="S25">BULL</button>
                        <button class="input-btn double" data-hit="DBULL">DBULL</button>
                        <button class="input-btn triple" style="visibility: hidden;"></button>
                        
                        <!-- Actions -->
                        <button class="input-btn action" onclick="handleUndo()">UNDO</button>
                        <button class="input-btn miss" onclick="handleMiss()">MISS</button>
                        <button class="input-btn triple" style="visibility: hidden;"></button>
                    </div>

                    <div class="last-turn">
                        <div class="last-turn-label">Last Turn</div>
                        <div class="last-turn-value" id="lastTurn">‚Äî</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WINNER MODAL -->
    <div class="winner-modal" id="winnerModal">
        <div class="winner-content">
            <div class="winner-trophy">üèÜ</div>
            <div class="winner-title" id="winnerName">PLAYER 1 WINS!</div>
            <div class="winner-stats" id="winnerStats"></div>
            <div id="saveGameSection" style="margin: 30px 0;">
                <p style="font-weight: 700; margin-bottom: 15px;">Save this game to track your stats?</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="new-game-btn" onclick="saveCricketGame()" style="background: #4CAF50; font-size: 24px; padding: 15px 25px;">SAVE GAME</button>
                    <button class="new-game-btn" onclick="skipSaveGame()" style="background: #6b7280; font-size: 24px; padding: 15px 25px;">SKIP</button>
                </div>
                <p id="saveStatus" style="margin-top: 15px; font-size: 14px; color: #6b7280;"></p>
            </div>
            <button class="new-game-btn" id="newGameBtn" style="display: none;" onclick="resetGame()">NEW GAME</button>
        </div>
    </div>

    <script>
        // Mobile error display for debugging
        window.onerror = function(msg, url, line) {
            alert('Error: ' + msg + '\nLine: ' + line);
            return false;
        };

        // GAME STATE
        const gameState = {
            player1: {
                name: 'PLAYER 1',
                score: 0,
                marks: { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, 25: 0 },
                totalMarks: 0,
                dartsThrown: 0,
                rounds: 0
            },
            player2: {
                name: 'PLAYER 2',
                score: 0,
                marks: { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, 25: 0 },
                totalMarks: 0,
                dartsThrown: 0,
                rounds: 0
            },
            currentPlayer: 1,
            currentTurn: [],
            lastTurn: [],
            gameStarted: false
        };

        const numbers = [20, 19, 18, 17, 16, 15, 25];

        // BOT SELECTION
        let registeredBots = [];
        let selectedBots = { 1: null, 2: null };
        const BOT_AVG_LABELS = {
            easy: '~40 avg',
            medium: '~55 avg',
            league: '~65 avg',
            hard: '~75 avg',
            pro: '~90 avg'
        };

        async function loadRegisteredBots() {
            try {
                const CLOUD_URL = 'https://us-central1-brdc-v2.cloudfunctions.net';
                const response = await fetch(`${CLOUD_URL}/getBots`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const result = await response.json();
                registeredBots = result.bots || [];
                updateBotDropdowns();
            } catch (error) {
                console.error('Error loading bots:', error);
            }
        }

        function toggleBotDropdown(playerNum) {
            const dropdown = document.getElementById(`botDropdown${playerNum}`);
            const otherDropdown = document.getElementById(`botDropdown${playerNum === 1 ? 2 : 1}`);
            otherDropdown.classList.remove('open');
            dropdown.classList.toggle('open');
        }

        function updateBotDropdowns() {
            [1, 2].forEach(playerNum => {
                const container = document.getElementById(`botDropdown${playerNum}`);
                const otherBotId = selectedBots[playerNum === 1 ? 2 : 1]?.id;

                if (registeredBots.length === 0) {
                    container.innerHTML = `
                        <div class="bot-option disabled">
                            <div class="bot-option-name" style="color: #666;">No bots available</div>
                            <div class="bot-option-avg">Add bots in Admin Portal</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = registeredBots.map(bot => {
                    const isOtherBot = bot.id === otherBotId;
                    const avgLabel = BOT_AVG_LABELS[bot.difficulty] || '~55 avg';
                    return `
                        <div class="bot-option ${isOtherBot ? 'disabled' : ''}" onclick="${isOtherBot ? '' : `selectBot(${playerNum}, '${bot.id}')`}">
                            <div class="bot-option-name">${bot.name}${isOtherBot ? ' (P' + (playerNum === 1 ? 2 : 1) + ')' : ''}</div>
                            <div class="bot-option-avg">${bot.difficulty.charAt(0).toUpperCase() + bot.difficulty.slice(1)} - ${avgLabel}</div>
                        </div>
                    `;
                }).join('') + `
                    ${selectedBots[playerNum] ? `
                        <div class="bot-option" onclick="clearBot(${playerNum})" style="background: rgba(255,70,154,0.1);">
                            <div class="bot-option-name" style="color: var(--pink);">Clear Bot</div>
                        </div>
                    ` : ''}
                `;
            });
        }

        function selectBot(playerNum, botId) {
            const bot = registeredBots.find(b => b.id === botId);
            if (!bot) return;

            selectedBots[playerNum] = bot;
            document.getElementById(`player${playerNum}NameInput`).value = bot.name;
            document.getElementById(`player${playerNum}NameInput`).disabled = true;
            document.getElementById(`bot${playerNum}Btn`).classList.add('selected');
            document.getElementById(`botDropdown${playerNum}`).classList.remove('open');

            // Store bot info in gameState
            gameState[`player${playerNum}`].isBot = true;
            gameState[`player${playerNum}`].botDifficulty = bot.difficulty;
            gameState[`player${playerNum}`].registeredBotId = bot.id;

            updateBotDropdowns();
        }

        function clearBot(playerNum) {
            selectedBots[playerNum] = null;
            document.getElementById(`player${playerNum}NameInput`).value = '';
            document.getElementById(`player${playerNum}NameInput`).disabled = false;
            document.getElementById(`bot${playerNum}Btn`).classList.remove('selected');
            document.getElementById(`botDropdown${playerNum}`).classList.remove('open');

            gameState[`player${playerNum}`].isBot = false;
            gameState[`player${playerNum}`].botDifficulty = null;
            gameState[`player${playerNum}`].registeredBotId = null;

            updateBotDropdowns();
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.bot-btn-container')) {
                document.querySelectorAll('.bot-dropdown').forEach(d => d.classList.remove('open'));
            }
        });

        // Load bots on page load
        loadRegisteredBots();

        // KNOCKOUT MODE DETECTION
        let knockoutContext = null;
        const urlParams = new URLSearchParams(window.location.search);
        const isKnockoutMode = urlParams.get('knockout') === 'true';

        if (isKnockoutMode) {
            // Load knockout context from localStorage
            try {
                knockoutContext = JSON.parse(localStorage.getItem('knockoutContext'));
            } catch (e) {
                // No knockout context
            }

            // Pre-fill player names from URL params
            const p1Name = urlParams.get('p1');
            const p2Name = urlParams.get('p2');

            if (p1Name) document.getElementById('player1NameInput').value = p1Name;
            if (p2Name) document.getElementById('player2NameInput').value = p2Name;

            // Auto-start game when coming from knockout bracket
            setTimeout(() => {
                startGame();
            }, 100);
        }

        // Lock in player names on first dart
        function startScoring() {
            if (!gameState.gameStarted) {
                const p1Input = document.getElementById('player1NameInput');
                const p2Input = document.getElementById('player2NameInput');
                
                gameState.player1.name = p1Input.value.trim() || 'PLAYER 1';
                gameState.player2.name = p2Input.value.trim() || 'PLAYER 2';
                
                document.getElementById('player1NameDisplay').textContent = gameState.player1.name.toUpperCase();
                document.getElementById('player2NameDisplay').textContent = gameState.player2.name.toUpperCase();
                
                document.getElementById('gameScreen').classList.add('game-started');
                gameState.gameStarted = true;
            }
        }

        // Initialize event listeners
        function initGame() {
            document.querySelectorAll('[data-hit]').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    this.disabled = true;
                    setTimeout(() => this.disabled = false, 250);
                    handleHit(this.dataset.hit);
                });
            });
        }

        function startGame() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            updateDisplay();
        }

        function handleHit(hit) {
            startScoring();
            
            const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            const opponent = gameState.currentPlayer === 1 ? gameState.player2 : gameState.player1;
            
            let number, marksToAdd;
            
            // Parse the hit
            if (hit === 'DBULL') {
                number = 25;
                marksToAdd = 2;
            } else if (hit === 'S25') {
                number = 25;
                marksToAdd = 1;
            } else if (hit.startsWith('T')) {
                number = parseInt(hit.substring(1));
                marksToAdd = 3;
            } else if (hit.startsWith('D')) {
                number = parseInt(hit.substring(1));
                marksToAdd = 2;
            } else if (hit.startsWith('S')) {
                number = parseInt(hit.substring(1));
                marksToAdd = 1;
            } else {
                number = parseInt(hit);
                marksToAdd = 1;
            }
            
            // Add to current turn for display
            gameState.currentTurn.push(hit);
            
            // Add marks
            const previousMarks = currentPlayer.marks[number];
            const newMarks = Math.min(previousMarks + marksToAdd, 3);
            const actualMarksAdded = newMarks - previousMarks;
            
            currentPlayer.marks[number] = newMarks;
            currentPlayer.totalMarks += actualMarksAdded;
            currentPlayer.dartsThrown++;

            // Calculate score
            if (newMarks === 3 && opponent.marks[number] < 3) {
                const overflow = (previousMarks + marksToAdd) - 3;
                if (overflow > 0) {
                    currentPlayer.score += number * overflow;
                }
            } else if (previousMarks === 3 && opponent.marks[number] < 3) {
                currentPlayer.score += number * marksToAdd;
            }
            
            updateDisplay();
            
            if (gameState.currentTurn.length >= 3) {
                setTimeout(() => autoNextTurn(), 500);
            }
            
            checkWin();
        }

        function handleMiss() {
            startScoring();
            gameState.currentTurn.push('MISS');
            const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            currentPlayer.dartsThrown++;
            updateDisplay();
            
            if (gameState.currentTurn.length >= 3) {
                setTimeout(() => autoNextTurn(), 500);
            }
        }

        function handleUndo() {
            if (gameState.currentTurn.length === 0) return;

            const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            const lastHit = gameState.currentTurn.pop();
            currentPlayer.dartsThrown--;

            if (lastHit === 'MISS') {
                updateDisplay();
                return;
            }
            const opponent = gameState.currentPlayer === 1 ? gameState.player2 : gameState.player1;
            
            let number, marksToRemove;
            
            if (lastHit === 'DBULL') {
                number = 25;
                marksToRemove = 2;
            } else if (lastHit === 'S25') {
                number = 25;
                marksToRemove = 1;
            } else if (lastHit.startsWith('T')) {
                number = parseInt(lastHit.substring(1));
                marksToRemove = 3;
            } else if (lastHit.startsWith('D')) {
                number = parseInt(lastHit.substring(1));
                marksToRemove = 2;
            } else if (lastHit.startsWith('S')) {
                number = parseInt(lastHit.substring(1));
                marksToRemove = 1;
            } else {
                number = parseInt(lastHit);
                marksToRemove = 1;
            }
            
            const previousMarks = currentPlayer.marks[number];
            const newMarks = Math.max(previousMarks - marksToRemove, 0);
            const actualMarksRemoved = previousMarks - newMarks;
            
            if (previousMarks > 3 && opponent.marks[number] < 3) {
                const scoringMarks = Math.min(marksToRemove, previousMarks - 3);
                currentPlayer.score -= number * scoringMarks;
            } else if (previousMarks === 3 && newMarks < 3 && opponent.marks[number] < 3) {
                const originalHit = previousMarks - newMarks;
                const marksBeforeHit = newMarks;
                const overflow = (marksBeforeHit + originalHit) - 3;
                if (overflow > 0) {
                    currentPlayer.score -= number * overflow;
                }
            }
            
            currentPlayer.marks[number] = newMarks;
            currentPlayer.totalMarks -= actualMarksRemoved;
            
            updateDisplay();
        }

        function autoNextTurn() {
            if (gameState.currentTurn.length > 0) {
                gameState.lastTurn = [...gameState.currentTurn];
                document.getElementById('lastTurn').textContent = gameState.lastTurn.join(', ');
                gameState.currentTurn = [];
                
                const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
                currentPlayer.rounds++;
            }
            
            gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('dartCount').textContent = `${gameState.currentTurn.length} / 3`;
            
            document.getElementById('player1Score').textContent = gameState.player1.score;
            document.getElementById('player2Score').textContent = gameState.player2.score;
            
            document.getElementById('player1NameDisplay').textContent = gameState.player1.name;
            document.getElementById('player2NameDisplay').textContent = gameState.player2.name;
            
            const p1Area = document.querySelector('.player-score-area:first-child');
            const p2Area = document.querySelector('.player-score-area:last-child');
            
            if (gameState.currentPlayer === 1) {
                p1Area.classList.add('active');
                p2Area.classList.remove('active');
            } else {
                p2Area.classList.add('active');
                p1Area.classList.remove('active');
            }
            
            numbers.forEach(num => {
                const p1Marks = gameState.player1.marks[num];
                const p2Marks = gameState.player2.marks[num];
                
                document.getElementById(`p1-${num}`).textContent = getMarkSymbol(p1Marks);
                document.getElementById(`p2-${num}`).textContent = getMarkSymbol(p2Marks);
                
                if (p1Marks >= 3) {
                    document.getElementById(`p1-${num}`).classList.add('closed');
                } else {
                    document.getElementById(`p1-${num}`).classList.remove('closed');
                }
                
                if (p2Marks >= 3) {
                    document.getElementById(`p2-${num}`).classList.add('closed');
                } else {
                    document.getElementById(`p2-${num}`).classList.remove('closed');
                }
                
                const row = document.querySelector(`.number-row[data-number="${num}"]`);
                row.classList.remove('p1-leading', 'p2-leading', 'both-closed');
                
                if (p1Marks >= 3 && p2Marks >= 3) {
                    row.classList.add('both-closed');
                } else if (p1Marks >= 3 && p2Marks < 3) {
                    row.classList.add('p1-leading');
                } else if (p2Marks >= 3 && p1Marks < 3) {
                    row.classList.add('p2-leading');
                }
            });
            
            updateStats();
        }

        function getMarkSymbol(marks) {
            if (marks === 0) return '';
            if (marks === 1) return '/';
            if (marks === 2) return '//';
            if (marks >= 3) return 'X';
        }

        function updateStats() {
            // MPR = (totalMarks / dartsThrown) * 3  (DartConnect formula)
            const p1MPR = gameState.player1.dartsThrown > 0 ?
                ((gameState.player1.totalMarks / gameState.player1.dartsThrown) * 3).toFixed(1) : '0.0';
            const p2MPR = gameState.player2.dartsThrown > 0 ?
                ((gameState.player2.totalMarks / gameState.player2.dartsThrown) * 3).toFixed(1) : '0.0';
            
            document.getElementById('p1-mpr').textContent = p1MPR;
            document.getElementById('p2-mpr').textContent = p2MPR;
            
            const p1Closed = numbers.filter(n => gameState.player1.marks[n] >= 3).length;
            const p2Closed = numbers.filter(n => gameState.player2.marks[n] >= 3).length;
            
            document.getElementById('p1-closed').textContent = p1Closed;
            document.getElementById('p2-closed').textContent = p2Closed;
        }

        function checkWin() {
            const p1 = gameState.player1;
            const p2 = gameState.player2;
            
            const p1AllClosed = numbers.every(n => p1.marks[n] >= 3);
            const p2AllClosed = numbers.every(n => p2.marks[n] >= 3);
            
            let winner = null;
            
            if (p1AllClosed && p1.score >= p2.score) {
                winner = p1;
            } else if (p2AllClosed && p2.score >= p1.score) {
                winner = p2;
            }
            
            if (winner) {
                setTimeout(() => showWinner(winner), 800);
            }
        }

        function showWinner(winner) {
            document.getElementById('winnerName').textContent = winner.name + ' WINS!';
            document.getElementById('winnerStats').textContent =
                `Final Score: ${gameState.player1.score} - ${gameState.player2.score}`;
            document.getElementById('winnerModal').classList.add('active');

            // If knockout mode, show different UI
            if (isKnockoutMode && knockoutContext) {
                const saveSection = document.getElementById('saveGameSection');
                saveSection.innerHTML = `
                    <p style="font-weight: 700; margin-bottom: 15px;">Match Complete!</p>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="new-game-btn" onclick="submitKnockoutResult()" style="background: #FF469A; font-size: 24px; padding: 15px 25px;">BACK TO BRACKET</button>
                    </div>
                    <p id="saveStatus" style="margin-top: 15px; font-size: 14px; color: #6b7280;"></p>
                `;
            }
        }

        // Submit knockout match result
        async function submitKnockoutResult() {
            if (!knockoutContext) {
                window.location.href = '/pages/knockout.html';
                return;
            }

            const saveStatus = document.getElementById('saveStatus');
            saveStatus.textContent = 'Submitting result...';

            try {
                // For cricket, winner is based on score (points)
                const score1 = gameState.player1.score;
                const score2 = gameState.player2.score;
                const winnerIndex = score1 > score2 ? 0 : 1;

                const response = await fetch(`${CLOUD_FUNCTIONS_URL}/submitKnockoutMatch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        knockout_id: knockoutContext.knockout_id,
                        match_number: knockoutContext.match_number,
                        winner_index: winnerIndex,
                        score: [1, 0] // Cricket uses 1-0 for win/loss since it's single game
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear knockout context and go back to bracket
                    localStorage.removeItem('knockoutContext');
                    window.location.href = `/pages/knockout.html?id=${knockoutContext.knockout_id}`;
                } else {
                    saveStatus.textContent = 'Error: ' + result.error;
                    saveStatus.style.color = '#E03786';
                }
            } catch (error) {
                console.error('Error submitting knockout result:', error);
                saveStatus.textContent = 'Failed to submit. Going back to bracket...';
                saveStatus.style.color = '#E03786';
                // Still go back even on error
                setTimeout(() => {
                    window.location.href = `/pages/knockout.html?id=${knockoutContext.knockout_id}`;
                }, 2000);
            }
        }
        window.submitKnockoutResult = submitKnockoutResult;

        function resetGame() {
            gameState.player1 = {
                name: 'PLAYER 1',
                score: 0,
                marks: { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, 25: 0 },
                totalMarks: 0,
                dartsThrown: 0,
                rounds: 0
            };
            gameState.player2 = {
                name: 'PLAYER 2',
                score: 0,
                marks: { 20: 0, 19: 0, 18: 0, 17: 0, 16: 0, 15: 0, 25: 0 },
                totalMarks: 0,
                dartsThrown: 0,
                rounds: 0
            };
            gameState.currentPlayer = 1;
            gameState.currentTurn = [];
            gameState.lastTurn = [];
            gameState.gameStarted = false;

            document.getElementById('lastTurn').textContent = '‚Äî';
            document.getElementById('dartCount').textContent = '0 / 3';
            document.getElementById('winnerModal').classList.remove('active');
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameScreen').classList.remove('game-started');
            document.getElementById('welcomeScreen').style.display = 'flex';

            // Reset save game UI
            const saveSection = document.getElementById('saveGameSection');
            if (saveSection) {
                saveSection.innerHTML = `
                    <p style="font-weight: 700; margin-bottom: 15px;">Save this game to track your stats?</p>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="new-game-btn" onclick="saveCricketGame()" style="background: #4CAF50; font-size: 24px; padding: 15px 25px;">SAVE GAME</button>
                        <button class="new-game-btn" onclick="skipSaveGame()" style="background: #6b7280; font-size: 24px; padding: 15px 25px;">SKIP</button>
                    </div>
                    <p id="saveStatus" style="margin-top: 15px; font-size: 14px; color: #6b7280;"></p>
                `;
            }
            document.getElementById('newGameBtn').style.display = 'none';
        }

        // CLOUD FUNCTION URL
        const CLOUD_FUNCTIONS_URL = 'https://us-central1-brdc-v2.cloudfunctions.net';

        // Calculate cricket stats for saving
        // MPR = (totalMarks / dartsThrown) * 3
        function calculateCricketStats(player, isWinner) {
            return {
                rounds: player.rounds,
                marks: player.totalMarks,
                darts_thrown: player.dartsThrown,
                mpr: player.dartsThrown > 0 ? ((player.totalMarks / player.dartsThrown) * 3).toFixed(2) : 0,
                five_mark_rounds: 0, // Would need turn tracking
                seven_mark_rounds: 0,
                nine_mark_rounds: 0,
                three_bulls: 0,
                hat_tricks: 0
            };
        }

        async function saveCricketGame() {
            const saveStatus = document.getElementById('saveStatus');
            saveStatus.textContent = 'Saving game...';
            saveStatus.style.color = '#6b7280';

            try {
                // Use stored PIN or prompt for it
                let player1Pin = localStorage.getItem('brdc_player_pin') || null;
                let player2Pin = null;

                // Check if players are bots
                const player1IsBot = gameState.player1.isBot || false;
                const player2IsBot = gameState.player2.isBot || false;

                if (!player1Pin && !player1IsBot) {
                    player1Pin = prompt(`Enter PIN for ${gameState.player1.name} to track stats (or leave blank for guest):`);
                    if (player1Pin) localStorage.setItem('brdc_player_pin', player1Pin.toUpperCase());
                }

                if (!player2IsBot) {
                    player2Pin = prompt(`Enter PIN for ${gameState.player2.name} to track stats (or leave blank for guest):`);
                }

                const p1AllClosed = numbers.every(n => gameState.player1.marks[n] >= 3);
                const winnerIndex = (p1AllClosed && gameState.player1.score >= gameState.player2.score) ? 0 : 1;

                const p1Stats = calculateCricketStats(gameState.player1, winnerIndex === 0);
                const p2Stats = calculateCricketStats(gameState.player2, winnerIndex === 1);

                const payload = {
                    game_type: 'cricket',
                    players: [
                        { pin: player1Pin?.toUpperCase() || null, name: gameState.player1.name, is_bot: player1IsBot },
                        { pin: player2Pin?.toUpperCase() || null, name: gameState.player2.name, is_bot: player2IsBot }
                    ],
                    winner_index: winnerIndex,
                    legs: [{
                        winner: winnerIndex === 0 ? 'player1' : 'player2',
                        player1_stats: p1Stats,
                        player2_stats: p2Stats
                    }],
                    match_config: {
                        bestOfLegs: 1,
                        bestOfSets: 1
                    }
                };

                const response = await fetch(`${CLOUD_FUNCTIONS_URL}/savePickupGame`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    saveStatus.textContent = 'Game saved! Stats updated.';
                    saveStatus.style.color = '#4CAF50';
                } else {
                    throw new Error(result.error || 'Failed to save');
                }
            } catch (error) {
                console.error('Error saving game:', error);
                saveStatus.textContent = 'Failed to save: ' + error.message;
                saveStatus.style.color = '#E03786';
            }

            document.getElementById('saveGameSection').innerHTML = '';
            document.getElementById('newGameBtn').style.display = 'block';
        }

        function skipSaveGame() {
            document.getElementById('saveGameSection').innerHTML = '';
            document.getElementById('newGameBtn').style.display = 'block';
        }

        // Initialize
        initGame();

        // Hide Safari address bar on iOS
        window.addEventListener('load', function() {
            setTimeout(() => window.scrollTo(0, 1), 0);
        });

        // Warn user before leaving with game in progress
        window.onbeforeunload = function(e) {
            const winnerModalActive = document.getElementById('winnerModal')?.classList.contains('active');
            if (gameState.gameStarted && !winnerModalActive) {
                e.preventDefault();
                return "You have a game in progress. Are you sure you want to leave?";
            }
        };
    </script>
<script src="/js/feedback.js"></script>
</body>
</html>