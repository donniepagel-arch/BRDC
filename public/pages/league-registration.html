<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>League Registration - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --pink: #FF469A;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-card: #1e2a47;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --text-muted: #666;
            --border: rgba(255, 255, 255, 0.1);
            --border-strong: #000;
            --success: #10b981;
            --error: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(255, 70, 154, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(145, 215, 235, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .card {
            background: var(--bg-panel);
            border: 4px solid var(--border-strong);
            border-radius: 16px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, var(--pink), #d63384);
            padding: 24px;
            text-align: center;
        }

        .card-header h1 {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            letter-spacing: 3px;
            color: white;
            text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3);
        }

        .card-header .league-name {
            font-size: 20px;
            color: rgba(255,255,255,0.9);
            margin-top: 8px;
        }

        .card-body {
            padding: 30px;
        }

        .league-info {
            background: var(--bg-card);
            border: 2px solid var(--border-strong);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .league-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .league-info-row:last-child {
            border-bottom: none;
        }

        .league-info-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .league-info-value {
            font-weight: 600;
            color: var(--teal);
        }

        /* Mode Selection */
        .mode-selector {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .mode-card {
            flex: 1;
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-card:hover {
            border-color: var(--pink);
            transform: translateY(-2px);
        }

        .mode-card.active {
            border-color: var(--pink);
            background: rgba(255, 70, 154, 0.15);
        }

        .mode-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .mode-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 1px;
            color: var(--pink);
            margin-bottom: 8px;
        }

        .mode-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Form Styles */
        .form-section {
            margin-bottom: 24px;
        }

        .form-section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            letter-spacing: 1px;
            color: var(--teal);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 1px;
            color: var(--teal);
            margin-bottom: 6px;
        }

        .form-group label .required {
            color: var(--pink);
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 3px solid var(--border-strong);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--teal);
        }

        input::placeholder {
            color: var(--text-muted);
        }

        .helper-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Player Roster */
        .roster-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .roster-slot {
            background: var(--bg-card);
            border: 2px solid var(--border-strong);
            border-radius: 10px;
            padding: 16px;
        }

        .roster-slot.captain {
            border-color: var(--yellow);
            background: rgba(253, 216, 53, 0.1);
        }

        .roster-slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .roster-slot-badge {
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            padding: 4px 10px;
            border-radius: 4px;
            background: var(--pink);
            color: white;
        }

        .roster-slot.captain .roster-slot-badge {
            background: var(--yellow);
            color: #000;
        }

        .roster-slot-remove {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }

        .roster-slot-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .roster-slot-fields.single {
            grid-template-columns: 1fr;
        }

        .add-player-btn {
            width: 100%;
            padding: 14px;
            background: transparent;
            border: 3px dashed var(--border);
            border-radius: 10px;
            color: var(--text-secondary);
            font-family: 'Bebas Neue', cursive;
            font-size: 16px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-player-btn:hover {
            border-color: var(--teal);
            color: var(--teal);
            background: rgba(145, 215, 235, 0.1);
        }

        /* Captain Selection */
        .captain-select {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .captain-option {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 2px solid var(--border-strong);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .captain-option:hover {
            border-color: var(--yellow);
        }

        .captain-option.active {
            border-color: var(--yellow);
            background: rgba(253, 216, 53, 0.2);
            color: var(--yellow);
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--pink), #d63384);
            border: 4px solid var(--border-strong);
            border-radius: 12px;
            color: white;
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.5);
        }

        .submit-btn:hover {
            transform: translate(-3px, -3px);
            box-shadow: 9px 9px 0 rgba(0, 0, 0, 0.5);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Alerts */
        .alert {
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.15);
            border-color: var(--error);
            color: var(--error);
        }

        .alert-warning {
            background: rgba(253, 216, 53, 0.15);
            border-color: var(--yellow);
            color: var(--yellow);
        }

        .alert-info {
            background: rgba(145, 215, 235, 0.15);
            border-color: var(--teal);
            color: var(--teal);
        }

        /* PIN Lookup */
        .pin-lookup {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .pin-lookup input {
            flex: 1;
            text-align: center;
            font-size: 18px;
            letter-spacing: 4px;
        }

        .pin-lookup button {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--teal), #5ab8d4);
            border: 3px solid var(--border-strong);
            border-radius: 8px;
            color: #000;
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3);
        }

        .lookup-status {
            font-size: 0.85rem;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .lookup-status.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .lookup-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: rgba(255,255,255,0.2);
            transition: 0.3s;
            border-radius: 28px;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--pink);
            border-color: var(--pink);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-card);
            border-top-color: var(--pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Current Sign-ups Section */
        .signups-section {
            background: var(--bg-card);
            border: 2px solid var(--border-strong);
            border-radius: 10px;
            padding: 20px;
            margin-top: 24px;
        }

        .signups-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .signups-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            letter-spacing: 2px;
            color: var(--yellow);
        }

        .signups-count {
            background: var(--pink);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
        }

        .signups-filter {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 14px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--pink);
        }

        .filter-btn.active {
            background: var(--pink);
            border-color: var(--pink);
            color: white;
        }

        .signups-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .signup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .signup-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .signup-team {
            font-size: 12px;
            color: var(--teal);
        }

        .signup-type {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(145, 215, 235, 0.2);
            color: var(--teal);
        }

        .signup-type.free-agent {
            background: rgba(253, 216, 53, 0.2);
            color: var(--yellow);
        }

        .signup-type.captain {
            background: rgba(255, 70, 154, 0.2);
            color: var(--pink);
        }

        .no-signups {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-style: italic;
        }

        @media (max-width: 640px) {
            .mode-selector {
                flex-direction: column;
            }
            .roster-slot-fields {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="appContainer">
            <div class="card">
                <div class="card-body loading">
                    <div class="loading-spinner"></div>
                    <p>Loading league information...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, doc, getDoc, collection, getDocs, query, where, callFunction } from '/js/firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        const leagueId = urlParams.get('league_id');

        let leagueData = null;
        let registrationMode = null; // 'individual', 'team', 'free_agent'
        let rosterPlayers = [];
        let captainIndex = 0; // Index of captain in roster
        let registrantData = null; // Logged in user data
        let allSignups = []; // All current sign-ups
        let signupFilter = 'all'; // Current filter: 'all', 'teams', 'free_agents'

        window.onload = async function() {
            if (!leagueId) {
                showError('Missing league_id in URL');
                return;
            }
            await loadLeagueData();
        };

        async function loadLeagueData() {
            try {
                const leagueDoc = await getDoc(doc(db, 'leagues', leagueId));

                if (!leagueDoc.exists()) {
                    throw new Error('League not found');
                }

                leagueData = { id: leagueId, ...leagueDoc.data() };

                // Get teams with their players
                const teamsSnap = await getDocs(collection(db, 'leagues', leagueId, 'teams'));
                const teams = [];
                teamsSnap.forEach(teamDoc => {
                    const teamData = teamDoc.data();
                    teams.push({ id: teamDoc.id, ...teamData });
                    // Add team players to signups
                    if (teamData.players) {
                        teamData.players.forEach((player, idx) => {
                            allSignups.push({
                                name: player.name,
                                team: teamData.name,
                                type: idx === 0 ? 'captain' : 'team',
                                email: player.email
                            });
                        });
                    }
                });

                // Get free agents
                const freeAgentsSnap = await getDocs(query(
                    collection(db, 'leagues', leagueId, 'registrations'),
                    where('type', '==', 'free_agent')
                ));
                freeAgentsSnap.forEach(regDoc => {
                    const regData = regDoc.data();
                    allSignups.push({
                        name: regData.name || regData.full_name,
                        team: null,
                        type: 'free_agent',
                        email: regData.email
                    });
                });

                // Get individual registrations (draft leagues)
                const individualsSnap = await getDocs(query(
                    collection(db, 'leagues', leagueId, 'registrations'),
                    where('type', '==', 'individual')
                ));
                individualsSnap.forEach(regDoc => {
                    const regData = regDoc.data();
                    allSignups.push({
                        name: regData.name || regData.full_name,
                        team: null,
                        type: 'individual',
                        email: regData.email
                    });
                });

                leagueData.teamCount = teamsSnap.size;
                leagueData.freeAgentCount = freeAgentsSnap.size + individualsSnap.size;

                renderPage();

            } catch (error) {
                console.error('Error loading league:', error);
                showError('Failed to load league data: ' + error.message);
            }
        }

        function renderPage() {
            const isClosed = leagueData.status === 'active' || leagueData.status === 'completed' || leagueData.registration_closed;
            const isDraft = leagueData.league_mode !== 'team';

            if (isClosed) {
                showClosed();
                return;
            }

            if (isDraft) {
                // Draft league - show individual registration
                registrationMode = 'individual';
                renderIndividualForm();
            } else {
                // Team league - show mode selection
                renderModeSelection();
            }
        }

        function renderModeSelection() {
            const allowFreeAgents = leagueData.allow_free_agents !== false;

            const html = `
                <div class="card">
                    <div class="card-header">
                        <h1>LEAGUE REGISTRATION</h1>
                        <div class="league-name">${leagueData.league_name}</div>
                    </div>
                    <div class="card-body">
                        ${renderLeagueInfo()}
                        ${renderSignupsSection()}

                        <div class="form-section-title">How would you like to register?</div>

                        <div class="mode-selector">
                            <div class="mode-card" onclick="selectMode('team')">
                                <div class="mode-icon">üë•</div>
                                <div class="mode-title">REGISTER A TEAM</div>
                                <div class="mode-desc">Sign up your team with ${leagueData.min_players || 3}-${leagueData.max_roster || 4} players</div>
                            </div>
                            ${allowFreeAgents ? `
                                <div class="mode-card" onclick="selectMode('free_agent')">
                                    <div class="mode-icon">üéØ</div>
                                    <div class="mode-title">JOIN AS FREE AGENT</div>
                                    <div class="mode-desc">Looking for a team? Join the free agent pool</div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="alert alert-info">
                            <strong>Current Registrations:</strong><br>
                            ${leagueData.teamCount || 0} teams registered${allowFreeAgents ? `, ${leagueData.freeAgentCount || 0} free agents` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('appContainer').innerHTML = html;
        }

        window.selectMode = function(mode) {
            registrationMode = mode;

            if (mode === 'team') {
                renderTeamForm();
            } else if (mode === 'free_agent') {
                renderFreeAgentForm();
            }
        };

        // Helper to convert 24hr to 12hr format
        function formatTime12hr(time24) {
            if (!time24) return 'TBD';
            const [hours, minutes] = time24.split(':');
            const h = parseInt(hours);
            const suffix = h >= 12 ? 'PM' : 'AM';
            const hour12 = h % 12 || 12;
            return `${hour12}:${minutes} ${suffix}`;
        }

        // Helper to describe match format
        function formatMatchDescription(matchFormat) {
            if (!matchFormat || matchFormat.length === 0) return 'TBD';
            const gameTypes = matchFormat.map(r => {
                const type = r.game_type || r.type || '501';
                if (type === 'cricket') return 'Cricket';
                if (type === 'corks_choice') return "Cork's Choice";
                return type;
            });
            const uniqueTypes = [...new Set(gameTypes)];
            if (uniqueTypes.length === 1) return `${matchFormat.length} √ó ${uniqueTypes[0]}`;
            return matchFormat.length + ' rounds (Mixed)';
        }

        function renderLeagueInfo() {
            const startDate = leagueData.start_date ? new Date(leagueData.start_date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' }) : 'TBD';
            const startTime = formatTime12hr(leagueData.start_time);

            // Format game settings
            const gameFormat = leagueData.format || '501';
            const checkout = leagueData.checkout || 'double';
            const checkoutLabel = checkout === 'double' ? 'Double Out' : checkout === 'master' ? 'Master Out' : 'Straight Out';
            const bestOf = leagueData.best_of || 3;
            const bestOfLabel = bestOf === 1 ? '1 Leg' : `Best of ${bestOf}`;

            // Format cork option
            const corkOptionLabels = {
                'alternate_random_first_last': 'Alternate (random first/last)',
                'random_every_leg': 'Random every leg',
                'away_team_option': 'Away team option',
                'home_team_option': 'Home team option',
                'loser_option': 'Loser option',
                'winner_option': 'Winner option'
            };
            const corkOption = corkOptionLabels[leagueData.cork_option] || 'Alternate';

            return `
                <div class="league-info">
                    <div class="league-info-row">
                        <span class="league-info-label">Start Date</span>
                        <span class="league-info-value">${startDate}</span>
                    </div>
                    <div class="league-info-row">
                        <span class="league-info-label">Venue</span>
                        <span class="league-info-value">${leagueData.venue_name || 'TBD'}</span>
                    </div>
                    <div class="league-info-row">
                        <span class="league-info-label">League Night</span>
                        <span class="league-info-value">${(leagueData.league_night || 'TBD').charAt(0).toUpperCase() + (leagueData.league_night || '').slice(1)}s @ ${startTime}</span>
                    </div>
                    <div class="league-info-row">
                        <span class="league-info-label">Rounds Per Night</span>
                        <span class="league-info-value">${leagueData.rounds_per_match || leagueData.games_per_match || 'TBD'}</span>
                    </div>
                    <div class="league-info-row">
                        <span class="league-info-label">Match Format</span>
                        <span class="league-info-value">${formatMatchDescription(leagueData.match_format)}</span>
                    </div>
                    <div class="league-info-row">
                        <span class="league-info-label">Game Format</span>
                        <span class="league-info-value">${gameFormat.toUpperCase()} ${checkoutLabel}</span>
                    </div>
                    <div class="league-info-row">
                        <span class="league-info-label">Legs Per Game</span>
                        <span class="league-info-value">${bestOfLabel}</span>
                    </div>
                    <div class="league-info-row">
                        <span class="league-info-label">Cork Rules</span>
                        <span class="league-info-value">${corkOption}</span>
                    </div>
                    <div class="league-info-row">
                        <span class="league-info-label">Nightly Players Required</span>
                        <span class="league-info-value">${leagueData.min_players || 3} minimum</span>
                    </div>
                    <div class="league-info-row">
                        <span class="league-info-label">Max Team Roster</span>
                        <span class="league-info-value">${leagueData.max_roster || 4} players</span>
                    </div>
                    ${leagueData.session_fee > 0 ? `
                        <div class="league-info-row">
                            <span class="league-info-label">Entry Fee</span>
                            <span class="league-info-value">$${parseFloat(leagueData.session_fee).toFixed(2)}/player</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Render current sign-ups section
        function renderSignupsSection() {
            if (allSignups.length === 0) {
                return `
                    <div class="signups-section">
                        <div class="signups-header">
                            <span class="signups-title">CURRENT SIGN-UPS</span>
                            <span class="signups-count">0</span>
                        </div>
                        <div class="no-signups">No registrations yet. Be the first to sign up!</div>
                    </div>
                `;
            }

            const filtered = signupFilter === 'all' ? allSignups :
                signupFilter === 'teams' ? allSignups.filter(s => s.team) :
                allSignups.filter(s => !s.team);

            const listHtml = filtered.map(signup => {
                const typeClass = signup.type === 'free_agent' || signup.type === 'individual' ? 'free-agent' :
                    signup.type === 'captain' ? 'captain' : '';
                const typeLabel = signup.type === 'free_agent' ? 'Free Agent' :
                    signup.type === 'individual' ? 'Individual' :
                    signup.type === 'captain' ? 'Captain' : 'Team Member';

                return `
                    <div class="signup-item">
                        <div>
                            <div class="signup-name">${signup.name}</div>
                            ${signup.team ? `<div class="signup-team">${signup.team}</div>` : ''}
                        </div>
                        <span class="signup-type ${typeClass}">${typeLabel}</span>
                    </div>
                `;
            }).join('');

            const teamCount = allSignups.filter(s => s.team).length;
            const freeCount = allSignups.filter(s => !s.team).length;

            return `
                <div class="signups-section">
                    <div class="signups-header">
                        <span class="signups-title">CURRENT SIGN-UPS</span>
                        <span class="signups-count">${allSignups.length}</span>
                    </div>
                    <div class="signups-filter">
                        <button class="filter-btn ${signupFilter === 'all' ? 'active' : ''}" onclick="filterSignups('all')">All (${allSignups.length})</button>
                        <button class="filter-btn ${signupFilter === 'teams' ? 'active' : ''}" onclick="filterSignups('teams')">Teams (${teamCount})</button>
                        <button class="filter-btn ${signupFilter === 'free' ? 'active' : ''}" onclick="filterSignups('free')">Free Agents (${freeCount})</button>
                    </div>
                    <div class="signups-list">
                        ${listHtml}
                    </div>
                </div>
            `;
        }

        window.filterSignups = function(filter) {
            signupFilter = filter;
            // Re-render the current page
            renderPage();
        };

        function renderIndividualForm() {
            const html = `
                <div class="card">
                    <div class="card-header">
                        <h1>LEAGUE REGISTRATION</h1>
                        <div class="league-name">${leagueData.league_name}</div>
                    </div>
                    <div class="card-body">
                        ${renderLeagueInfo()}
                        ${renderSignupsSection()}

                        <div class="alert alert-info">
                            <strong>Draft League</strong><br>
                            Register as an individual player. Teams will be formed through a draft.
                        </div>

                        <form id="registrationForm" onsubmit="submitIndividualRegistration(event)">
                            <div class="form-section">
                                <div class="form-section-title">üë§ Your Information</div>

                                <div class="form-group">
                                    <label>Have a PIN? Look up your info</label>
                                    <div class="pin-lookup">
                                        <input type="text" id="pinLookup" placeholder="12345678" maxlength="8">
                                        <button type="button" onclick="lookupPlayer()">LOOKUP</button>
                                    </div>
                                    <div id="pinLookupStatus"></div>
                                </div>

                                <div class="form-group">
                                    <label>Full Name <span class="required">*</span></label>
                                    <input type="text" name="full_name" id="fullName" required placeholder="John Smith">
                                </div>

                                <div class="form-group">
                                    <label>Email <span class="required">*</span></label>
                                    <input type="email" name="email" id="email" required placeholder="john@example.com">
                                </div>

                                <div class="form-group">
                                    <label>Phone <span class="required">*</span></label>
                                    <input type="tel" name="phone" id="phone" required placeholder="555-123-4567">
                                </div>

                                <div class="form-group">
                                    <label>Skill Level</label>
                                    <select name="level">
                                        <option value="">Select level...</option>
                                        <option value="A">A - Advanced</option>
                                        <option value="B">B - Intermediate</option>
                                        <option value="C">C - Beginner</option>
                                    </select>
                                </div>
                            </div>

                            <input type="hidden" name="player_id" id="playerId" value="">

                            <button type="submit" class="submit-btn">REGISTER FOR LEAGUE</button>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('appContainer').innerHTML = html;
        }

        function renderTeamForm() {
            const minPlayers = leagueData.min_players || 3;
            const maxRoster = leagueData.max_roster || 4;

            // Initialize roster with minimum slots
            if (rosterPlayers.length === 0) {
                for (let i = 0; i < minPlayers; i++) {
                    rosterPlayers.push({ name: '', email: '', phone: '', player_id: '' });
                }
            }

            const html = `
                <div class="card">
                    <div class="card-header">
                        <h1>REGISTER YOUR TEAM</h1>
                        <div class="league-name">${leagueData.league_name}</div>
                    </div>
                    <div class="card-body">
                        ${renderLeagueInfo()}
                        ${renderSignupsSection()}

                        <button type="button" onclick="selectMode(null); renderModeSelection();" style="background: none; border: none; color: var(--teal); cursor: pointer; margin-bottom: 20px; font-size: 0.9rem;">
                            ‚Üê Back to options
                        </button>

                        <form id="teamRegistrationForm" onsubmit="submitTeamRegistration(event)">
                            <div class="form-section">
                                <div class="form-section-title">üèÜ Team Info</div>

                                <div class="form-group">
                                    <label>Team Name</label>
                                    <input type="text" name="team_name" placeholder="Leave blank to set later">
                                    <span class="helper-text">Captain can set/change this later</span>
                                </div>
                            </div>

                            <div class="form-section">
                                <div class="form-section-title">üë• Team Roster (${minPlayers}-${maxRoster} players)</div>

                                <div class="roster-list" id="rosterList">
                                    ${renderRosterSlots()}
                                </div>

                                ${rosterPlayers.length < maxRoster ? `
                                    <button type="button" class="add-player-btn" onclick="addRosterSlot()">
                                        + ADD PLAYER
                                    </button>
                                ` : ''}

                                <span class="helper-text" style="display: block; margin-top: 12px;">
                                    Need ${minPlayers} players minimum. Can add up to ${maxRoster} total.
                                </span>
                            </div>

                            <div class="form-section">
                                <div class="form-section-title">üëë Captain Selection</div>
                                <div class="captain-select" id="captainSelect">
                                    ${rosterPlayers.map((p, i) => `
                                        <div class="captain-option ${i === captainIndex ? 'active' : ''}" onclick="setCaptain(${i})">
                                            ${p.name || `Player ${i + 1}`}
                                        </div>
                                    `).join('')}
                                </div>
                                <span class="helper-text">Captain manages the team and receives match notifications</span>
                            </div>

                            <div class="alert alert-warning">
                                <strong>Note:</strong> All players will receive a text/email to complete their registration and get their PIN.
                            </div>

                            <button type="submit" class="submit-btn">REGISTER TEAM</button>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('appContainer').innerHTML = html;
        }

        function renderRosterSlots() {
            return rosterPlayers.map((player, index) => {
                const isCaptain = index === captainIndex;
                return `
                    <div class="roster-slot ${isCaptain ? 'captain' : ''}" data-index="${index}">
                        <div class="roster-slot-header">
                            <span class="roster-slot-badge">${isCaptain ? 'üëë CAPTAIN' : `PLAYER ${index + 1}`}</span>
                            ${index >= (leagueData.min_players || 3) ? `
                                <button type="button" class="roster-slot-remove" onclick="removeRosterSlot(${index})">√ó</button>
                            ` : ''}
                        </div>
                        <div class="form-group" style="margin-bottom: 8px;">
                            <div class="pin-lookup">
                                <input type="text" placeholder="PIN (optional)" maxlength="8" onchange="lookupRosterPlayer(${index}, this.value)">
                                <button type="button" onclick="lookupRosterPlayer(${index}, this.previousElementSibling.value)">LOOKUP</button>
                            </div>
                        </div>
                        <div class="roster-slot-fields">
                            <div class="form-group">
                                <label>Name <span class="required">*</span></label>
                                <input type="text" name="roster_name_${index}" value="${player.name}" required placeholder="Full Name"
                                       onchange="updateRosterPlayer(${index}, 'name', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Email <span class="required">*</span></label>
                                <input type="email" name="roster_email_${index}" value="${player.email}" required placeholder="email@example.com"
                                       onchange="updateRosterPlayer(${index}, 'email', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" name="roster_phone_${index}" value="${player.phone}" placeholder="555-123-4567"
                                       onchange="updateRosterPlayer(${index}, 'phone', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Level</label>
                                <select name="roster_level_${index}" onchange="updateRosterPlayer(${index}, 'level', this.value)">
                                    <option value="">Select...</option>
                                    <option value="A" ${player.level === 'A' ? 'selected' : ''}>A</option>
                                    <option value="B" ${player.level === 'B' ? 'selected' : ''}>B</option>
                                    <option value="C" ${player.level === 'C' ? 'selected' : ''}>C</option>
                                </select>
                            </div>
                        </div>
                        <input type="hidden" name="roster_player_id_${index}" value="${player.player_id || ''}">
                    </div>
                `;
            }).join('');
        }

        window.addRosterSlot = function() {
            const maxRoster = leagueData.max_roster || 4;
            if (rosterPlayers.length >= maxRoster) return;

            rosterPlayers.push({ name: '', email: '', phone: '', player_id: '' });
            renderTeamForm();
        };

        window.removeRosterSlot = function(index) {
            const minPlayers = leagueData.min_players || 3;
            if (rosterPlayers.length <= minPlayers) return;

            rosterPlayers.splice(index, 1);
            if (captainIndex >= rosterPlayers.length) {
                captainIndex = 0;
            }
            renderTeamForm();
        };

        window.updateRosterPlayer = function(index, field, value) {
            rosterPlayers[index][field] = value;
            // Update captain select names
            const captainSelect = document.getElementById('captainSelect');
            if (captainSelect && field === 'name') {
                const options = captainSelect.querySelectorAll('.captain-option');
                options[index].textContent = value || `Player ${index + 1}`;
            }
        };

        window.setCaptain = function(index) {
            captainIndex = index;
            document.querySelectorAll('.captain-option').forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });
            document.querySelectorAll('.roster-slot').forEach((el, i) => {
                el.classList.toggle('captain', i === index);
                const badge = el.querySelector('.roster-slot-badge');
                badge.textContent = i === index ? 'üëë CAPTAIN' : `PLAYER ${i + 1}`;
            });
        };

        window.lookupRosterPlayer = async function(index, pin) {
            if (!pin || pin.length < 5) return;

            try {
                const result = await callFunction('playerLogin', { pin });
                if (result.success && result.player) {
                    const player = result.player;
                    rosterPlayers[index] = {
                        name: player.name || `${player.first_name || ''} ${player.last_name || ''}`.trim(),
                        email: player.email || '',
                        phone: player.phone || '',
                        level: player.level || '',
                        player_id: player.player_id || ''
                    };
                    renderTeamForm();
                }
            } catch (e) {
                console.error('Lookup failed:', e);
            }
        };

        function renderFreeAgentForm() {
            const html = `
                <div class="card">
                    <div class="card-header">
                        <h1>JOIN AS FREE AGENT</h1>
                        <div class="league-name">${leagueData.league_name}</div>
                    </div>
                    <div class="card-body">
                        ${renderLeagueInfo()}
                        ${renderSignupsSection()}

                        <button type="button" onclick="selectMode(null); renderModeSelection();" style="background: none; border: none; color: var(--teal); cursor: pointer; margin-bottom: 20px; font-size: 0.9rem;">
                            ‚Üê Back to options
                        </button>

                        <div class="alert alert-info">
                            <strong>Free Agent Pool</strong><br>
                            You'll be added to a pool where team captains can recruit you, or you can form your own team with other free agents.
                        </div>

                        <form id="freeAgentForm" onsubmit="submitFreeAgentRegistration(event)">
                            <div class="form-section">
                                <div class="form-section-title">üë§ Your Information</div>

                                <div class="form-group">
                                    <label>Have a PIN? Look up your info</label>
                                    <div class="pin-lookup">
                                        <input type="text" id="pinLookup" placeholder="12345678" maxlength="8">
                                        <button type="button" onclick="lookupPlayer()">LOOKUP</button>
                                    </div>
                                    <div id="pinLookupStatus"></div>
                                </div>

                                <div class="form-group">
                                    <label>Full Name <span class="required">*</span></label>
                                    <input type="text" name="full_name" id="fullName" required placeholder="John Smith">
                                </div>

                                <div class="form-group">
                                    <label>Email <span class="required">*</span></label>
                                    <input type="email" name="email" id="email" required placeholder="john@example.com">
                                </div>

                                <div class="form-group">
                                    <label>Phone <span class="required">*</span></label>
                                    <input type="tel" name="phone" id="phone" required placeholder="555-123-4567">
                                </div>

                                <div class="form-group">
                                    <label>Skill Level</label>
                                    <select name="level" id="level">
                                        <option value="">Select level...</option>
                                        <option value="A">A - Advanced</option>
                                        <option value="B">B - Intermediate</option>
                                        <option value="C">C - Beginner</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Note (optional)</label>
                                    <input type="text" name="note" placeholder="e.g., Looking for competitive team, available every week">
                                    <span class="helper-text">This will be visible to team captains</span>
                                </div>
                            </div>

                            <input type="hidden" name="player_id" id="playerId" value="">

                            <button type="submit" class="submit-btn">JOIN FREE AGENT POOL</button>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('appContainer').innerHTML = html;
        }

        // Player PIN lookup
        window.lookupPlayer = async function() {
            const pin = document.getElementById('pinLookup').value;
            const statusEl = document.getElementById('pinLookupStatus');

            if (!pin || pin.length < 5) {
                statusEl.innerHTML = '<div class="lookup-status error">Enter a valid PIN</div>';
                return;
            }

            try {
                statusEl.innerHTML = '<div class="lookup-status">Looking up...</div>';
                const result = await callFunction('playerLogin', { pin });

                if (result.success && result.player) {
                    const player = result.player;
                    document.getElementById('fullName').value = player.name || `${player.first_name || ''} ${player.last_name || ''}`.trim();
                    document.getElementById('email').value = player.email || '';
                    document.getElementById('phone').value = player.phone || '';
                    document.getElementById('playerId').value = player.player_id || '';
                    if (document.getElementById('level') && player.level) {
                        document.getElementById('level').value = player.level;
                    }
                    statusEl.innerHTML = `<div class="lookup-status success">Found: ${player.name || player.first_name}</div>`;
                } else {
                    statusEl.innerHTML = '<div class="lookup-status error">PIN not found</div>';
                }
            } catch (e) {
                statusEl.innerHTML = '<div class="lookup-status error">Lookup failed</div>';
            }
        };

        // Form submissions
        window.submitIndividualRegistration = async function(e) {
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('.submit-btn');
            btn.disabled = true;
            btn.textContent = 'REGISTERING...';

            try {
                const formData = new FormData(form);
                const result = await callFunction('registerForLeague', {
                    league_id: leagueId,
                    type: 'individual',
                    full_name: formData.get('full_name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    level: formData.get('level') || null,
                    player_id: formData.get('player_id') || null
                });

                if (result.success) {
                    showSuccess('individual', result);
                } else {
                    throw new Error(result.error || 'Registration failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'REGISTER FOR LEAGUE';
            }
        };

        window.submitTeamRegistration = async function(e) {
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('.submit-btn');
            btn.disabled = true;
            btn.textContent = 'REGISTERING TEAM...';

            // Validate roster
            const minPlayers = leagueData.min_players || 3;
            const filledPlayers = rosterPlayers.filter(p => p.name && p.email);

            if (filledPlayers.length < minPlayers) {
                alert(`Please fill in at least ${minPlayers} players with name and email.`);
                btn.disabled = false;
                btn.textContent = 'REGISTER TEAM';
                return;
            }

            try {
                const formData = new FormData(form);
                const result = await callFunction('registerTeam', {
                    league_id: leagueId,
                    team_name: formData.get('team_name') || null,
                    roster: filledPlayers,
                    captain_index: captainIndex
                });

                if (result.success) {
                    showSuccess('team', result);
                } else {
                    throw new Error(result.error || 'Registration failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'REGISTER TEAM';
            }
        };

        window.submitFreeAgentRegistration = async function(e) {
            e.preventDefault();
            const form = e.target;
            const btn = form.querySelector('.submit-btn');
            btn.disabled = true;
            btn.textContent = 'JOINING...';

            try {
                const formData = new FormData(form);
                const result = await callFunction('registerFreeAgent', {
                    league_id: leagueId,
                    full_name: formData.get('full_name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    level: formData.get('level') || null,
                    note: formData.get('note') || null,
                    player_id: formData.get('player_id') || null
                });

                if (result.success) {
                    showSuccess('free_agent', result);
                } else {
                    throw new Error(result.error || 'Registration failed');
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'JOIN FREE AGENT POOL';
            }
        };

        function showSuccess(type, result) {
            let message = '';
            let nextSteps = '';

            if (type === 'individual') {
                message = "You're registered for the draft!";
                nextSteps = "You'll be notified when teams are drafted.";
            } else if (type === 'team') {
                message = "Your team has been registered!";
                nextSteps = result.pending_captain ?
                    "The designated captain will receive an email to confirm." :
                    "All players will receive their registration confirmation.";
            } else if (type === 'free_agent') {
                message = "You're in the Free Agent pool!";
                nextSteps = "Team captains can now see you and send invites. You can also invite other free agents to form a team.";
            }

            const html = `
                <div class="card">
                    <div class="card-header">
                        <h1>SUCCESS!</h1>
                        <div class="league-name">${leagueData.league_name}</div>
                    </div>
                    <div class="card-body" style="text-align: center;">
                        <div style="font-size: 80px; margin-bottom: 20px;">üéâ</div>
                        <h2 style="font-family: 'Bebas Neue', cursive; font-size: 32px; margin-bottom: 15px;">${message}</h2>
                        <p style="font-size: 16px; color: var(--text-secondary); margin-bottom: 20px;">${nextSteps}</p>

                        ${result.pin ? `
                            <div style="background: var(--bg-card); border: 3px solid var(--yellow); border-radius: 10px; padding: 20px; margin: 20px 0;">
                                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">Your PIN</div>
                                <div style="font-family: 'JetBrains Mono', monospace; font-size: 28px; letter-spacing: 4px; color: var(--yellow);">${result.pin}</div>
                                <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">Save this! Use it to log in.</div>
                            </div>
                        ` : ''}

                        <div style="background: var(--teal); border: 3px solid var(--border-strong); padding: 16px; border-radius: 10px; margin: 20px 0;">
                            <strong>Check your email/phone</strong><br>
                            <span style="font-size: 0.9rem;">We've sent confirmation with next steps.</span>
                        </div>

                        <a href="/pages/league-standings.html?league_id=${leagueId}" class="submit-btn" style="display: inline-block; text-decoration: none; margin-top: 20px;">
                            VIEW LEAGUE PAGE
                        </a>
                    </div>
                </div>
            `;

            document.getElementById('appContainer').innerHTML = html;
        }

        function showClosed() {
            document.getElementById('appContainer').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h1>REGISTRATION CLOSED</h1>
                        <div class="league-name">${leagueData.league_name}</div>
                    </div>
                    <div class="card-body" style="text-align: center;">
                        <div style="font-size: 60px; margin-bottom: 20px;">üö´</div>
                        <p style="font-size: 18px; margin-bottom: 20px;">Registration for this league has closed.</p>
                        <a href="/pages/league-standings.html?league_id=${leagueId}" class="submit-btn" style="display: inline-block; text-decoration: none;">
                            VIEW LEAGUE PAGE
                        </a>
                    </div>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('appContainer').innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <div class="alert alert-error">
                            <strong>Error</strong><br>${message}
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
    <script src="/js/nav-menu.js"></script>
</body>
</html>
