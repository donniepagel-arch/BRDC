<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dart Scorer - BRDC</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dart Scorer">
    <link rel="apple-touch-icon" href="/images/favicon.png">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        :root {
            --pink: #FF469A;
            --blue-light: #1F85AF;
            --blue-dark: #001F4D;
            --teal: #91D7EB;
            --yellow: #FDD835;
            --black: #000000;
            --white: #FFFFFF;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            overflow-x: hidden;
            width: 100%;
        }

        body {
            background: linear-gradient(180deg, var(--blue-light) 0%, var(--blue-dark) 100%);
            overflow: hidden;
            touch-action: manipulation;
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            width: 100dvw;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .screen.active {
            display: flex;
        }

        /* WELCOME SCREEN */
        .welcome-screen {
            align-items: center;
            justify-content: center;
        }

        .welcome-container {
            background: var(--white);
            border: 4px solid var(--black);
            box-shadow: 12px 12px 0 rgba(0, 0, 0, 1);
            padding: 60px 40px;
            max-width: 600px;
            text-align: center;
        }

        .welcome-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 64px;
            color: var(--pink);
            text-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
            margin-bottom: 16px;
            letter-spacing: 4px;
        }

        .welcome-subtitle {
            font-size: 18px;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 40px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .welcome-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .welcome-btn {
            padding: 24px 40px;
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            border: 4px solid var(--black);
            cursor: pointer;
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 1);
            transition: all 0.2s;
            letter-spacing: 2px;
        }

        .welcome-btn:hover {
            transform: translateY(-4px);
            box-shadow: 10px 10px 0 rgba(0, 0, 0, 1);
        }

        .btn-primary {
            background: var(--pink);
            color: var(--white);
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
        }

        .btn-secondary {
            background: var(--teal);
            color: var(--black);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .btn-tertiary {
            background: var(--yellow);
            color: var(--black);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* SETUP SCREEN */
        .setup-screen {
            padding: 20px;
            align-items: flex-start;
            justify-content: flex-start;
            overflow-y: auto;
        }

        .setup-container {
            background: var(--white);
            border: 4px solid var(--black);
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 1);
            padding: 30px;
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
        }

        .setup-header {
            background: var(--pink);
            padding: 20px;
            margin: -30px -30px 20px -30px;
            border-bottom: 4px solid var(--black);
        }

        .setup-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 42px;
            color: var(--white);
            text-shadow: 4px 4px 0 rgba(0, 0, 0, 0.8);
            letter-spacing: 3px;
        }

        .section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--pink);
            margin: 20px 0 12px 0;
            letter-spacing: 2px;
            border-bottom: 2px solid var(--pink);
            padding-bottom: 4px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--black);
            margin-bottom: 6px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 3px solid var(--black);
            font-size: 16px;
            font-weight: 600;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 1);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--pink);
            box-shadow: 0 0 0 2px rgba(255, 70, 154, 0.3), 4px 4px 0 rgba(0, 0, 0, 1);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Bot Selection */
        .player-input-row {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .player-input-row .form-input {
            flex: 1;
        }

        .bot-btn {
            background: rgba(145,215,235,0.2);
            border: 3px solid var(--teal);
            padding: 12px 14px;
            color: var(--teal);
            font-size: 13px;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            white-space: nowrap;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 1);
        }

        .bot-btn:active { transform: scale(0.95); }
        .bot-btn.selected { background: var(--teal); color: var(--black); }

        .bot-btn-container {
            position: relative;
        }

        .bot-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--white);
            border: 3px solid var(--teal);
            z-index: 100;
            min-width: 180px;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.5);
        }

        .bot-dropdown.open { display: block; }

        .bot-option {
            padding: 12px 14px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            transition: background 0.15s;
        }

        .bot-option:last-child { border-bottom: none; }
        .bot-option:hover, .bot-option:active { background: rgba(145,215,235,0.3); }
        .bot-option.disabled { opacity: 0.4; cursor: not-allowed; }

        .bot-option-name {
            font-weight: 700;
            color: var(--teal);
            font-size: 14px;
        }

        .bot-option-avg {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        .clear-bot-btn {
            background: none;
            border: none;
            color: var(--pink);
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            margin-left: 8px;
        }

        .toggle-group {
            display: flex;
            gap: 8px;
        }

        .toggle-btn {
            flex: 1;
            padding: 12px;
            border: 3px solid var(--black);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 1);
            background: #e5e7eb;
            color: var(--black);
            transition: all 0.2s;
        }

        .toggle-btn:hover {
            background: #d1d5db;
        }

        .toggle-btn.active {
            background: var(--pink);
            color: var(--white);
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 1);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 3px solid var(--black);
            cursor: pointer;
            background: #f9fafb;
            transition: all 0.2s;
        }

        .radio-option:hover {
            background: #e5e7eb;
        }

        .radio-option.active {
            background: var(--teal);
            border-color: var(--black);
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 1);
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-option label {
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
        }

        .leg-games-container {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 12px;
            padding: 12px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
        }

        .leg-games-container.active {
            display: grid;
        }

        .leg-game-item {
            display: flex;
            flex-direction: column;
        }

        .leg-game-item label {
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #6b7280;
        }

        .leg-game-item select {
            padding: 8px;
            border: 2px solid var(--black);
            font-size: 14px;
            font-weight: 600;
        }

        .options-inline {
            display: flex;
            gap: 12px;
        }

        .options-inline > div {
            flex: 1;
        }

        .option-label {
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 6px;
            color: #6b7280;
            text-transform: uppercase;
        }

        .start-game-btn {
            width: 100%;
            padding: 18px;
            margin-top: 20px;
            background: var(--pink);
            color: var(--white);
            border: 4px solid var(--black);
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 1);
            letter-spacing: 2px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
        }

        .start-game-btn:hover {
            background: #E03786;
            transform: translateY(-2px);
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 1);
        }

        .back-btn {
            width: 100%;
            padding: 12px;
            background: #6b7280;
            color: var(--white);
            border: 4px solid var(--black);
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 1);
            letter-spacing: 2px;
            margin-top: 12px;
        }

        .back-btn:hover {
            background: #4b5563;
        }

        .doubles-fields {
            display: none;
        }

        .doubles-fields.active {
            display: block;
        }

        /* EXIT BUTTON */
        .exit-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #dc2626;
            color: var(--white);
            border: 3px solid var(--black);
            font-family: 'Bebas Neue', cursive;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 1);
            letter-spacing: 2px;
            z-index: 100;
        }

        .exit-btn:hover {
            background: #b91c1c;
            transform: translateY(-2px);
            box-shadow: 5px 5px 0 rgba(0, 0, 0, 1);
        }

        /* CORK POPUP */
        .cork-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .cork-popup.active {
            display: flex;
        }

        .cork-content {
            background: var(--white);
            border: 6px solid var(--black);
            box-shadow: 12px 12px 0 rgba(0, 0, 0, 1);
            padding: 40px;
            text-align: center;
            max-width: 500px;
        }

        .cork-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 48px;
            color: var(--pink);
            text-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            letter-spacing: 3px;
        }

        .cork-message {
            font-size: 18px;
            font-weight: 700;
            margin: 20px 0;
            color: #6b7280;
        }

        .cork-result {
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            color: var(--teal);
            margin: 20px 0;
            letter-spacing: 2px;
        }

        .game-select-btns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }

        .game-select-btn {
            padding: 16px;
            background: var(--teal);
            color: var(--black);
            border: 3px solid var(--black);
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 1);
        }

        .game-select-btn:hover {
            background: #7DC8E0;
        }

        .game-select-btn.selected {
            background: var(--yellow);
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 1);
        }

        .cork-btn {
            padding: 16px 32px;
            background: var(--pink);
            color: var(--white);
            border: 4px solid var(--black);
            font-family: 'Bebas Neue', cursive;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 1);
            letter-spacing: 2px;
            margin-top: 20px;
        }

        .cork-btn:hover {
            background: #E03786;
        }

        .cork-btn.hidden {
            display: none;
        }

        .cork-subtitle {
            font-family: 'Bebas Neue', cursive;
            font-size: 28px;
            color: var(--black);
            margin: 15px 0;
            letter-spacing: 2px;
        }

        .cork-player-btns {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .cork-player-btn {
            padding: 20px 30px;
            background: var(--teal);
            color: var(--black);
            border: 4px solid var(--black);
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 1);
            letter-spacing: 1px;
            min-width: 140px;
        }

        .cork-player-btn:hover {
            background: #7DC8E0;
        }

        .cork-player-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 1);
        }

        .cork-choice-btns {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 25px 0;
        }

        .cork-choice-btn {
            padding: 25px 20px;
            background: var(--white);
            border: 4px solid var(--black);
            cursor: pointer;
            box-shadow: 5px 5px 0 rgba(0, 0, 0, 1);
            min-width: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .cork-choice-btn:hover {
            background: #f0f0f0;
        }

        .cork-choice-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 1);
        }

        .cork-choice-btn .choice-icon {
            font-size: 32px;
        }

        .cork-choice-btn .choice-label {
            font-family: 'Bebas Neue', cursive;
            font-size: 22px;
            color: var(--pink);
            letter-spacing: 1px;
        }

        .cork-choice-btn .choice-desc {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
        }

        /* GAME SCREEN - continues from your existing CSS */
        .game-screen {
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            width: 100dvw;
            background: var(--blue-dark);
            overflow: hidden;
        }

        .game-screen.active {
            display: grid;
        }

        @media (orientation: landscape) {
            .game-screen.active {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr;
            }

            .scores-panel {
                grid-column: 1;
                grid-row: 1;
            }

            .input-panel {
                grid-column: 2;
                grid-row: 1;
                border-left: 4px solid var(--black);
                border-top: none;
            }
        }

        @media (orientation: portrait) {
            .game-screen.active {
                grid-template-columns: 1fr;
                grid-template-rows: 35vh 65vh;
            }

            .scores-panel {
                grid-column: 1;
                grid-row: 1;
                flex-direction: row !important;
                gap: 8px;
                padding: 8px;
            }

            .input-panel {
                grid-column: 1;
                grid-row: 2;
                border-left: none;
                border-top: 4px solid var(--black);
                padding: 10px;
            }

            .player-score-card {
                flex: 1;
                padding: 10px;
                height: auto;
                max-height: none;
                grid-template-columns: 1fr 150px;
                gap: 10px;
            }

            .player-name {
                font-size: 18px;
            }

            .player-name-input {
                font-size: 18px;
            }

            .leg-score {
                font-size: 14px;
            }

            .averages {
                gap: 8px;
                padding: 10px 5px;
            }

            .avg-label {
                font-size: 9px;
            }

            .avg-value {
                font-size: 20px;
            }

            .remaining-score {
                font-size: clamp(60px, 15vw, 120px);
            }

            .throw-item {
                padding: 5px 6px;
                font-size: 12px;
            }

            .throw-number {
                font-size: 10px;
            }

            .throw-score {
                font-size: 14px;
            }

            .input-display {
                padding: 15px;
                min-height: 60px;
            }

            .input-text {
                font-size: clamp(24px, 6vw, 40px);
            }

            .outshot-hint {
                font-size: clamp(14px, 3vw, 18px);
            }

            .input-btn {
                font-size: 28px;
            }

            .side-btn {
                font-size: 22px;
            }

            .number-btn {
                font-size: 32px;
            }

            .preset-btn {
                font-size: 24px;
            }

            .action-btn {
                font-size: 20px;
            }

            .input-grid {
                gap: 6px;
            }

            .dart-selector {
                gap: 8px;
            }

            .dart-option {
                width: 50px;
                height: 50px;
            }

            .dart-icon {
                font-size: 24px;
            }

            .dart-label {
                font-size: 9px;
            }
        }

        .scores-panel {
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        .player-score-card {
            background: var(--white);
            border: 4px solid var(--black);
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 1);
            padding: 20px;
            transition: all 0.3s;
            display: grid;
            grid-template-columns: 1fr 200px;
            grid-template-rows: auto 1fr;
            gap: 15px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .player-score-card.active {
            transform: scale(1.05);
            box-shadow: 10px 10px 0 rgba(0, 0, 0, 1);
            border-color: var(--pink);
        }

        .player-score-card.inactive {
            opacity: 0.6;
        }

        .player-header {
            grid-column: 1;
            grid-row: 1;
        }

        .player-name {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: var(--black);
            margin-bottom: 5px;
            letter-spacing: 2px;
        }

        .player-name-input {
            font-family: 'Bebas Neue', cursive;
            font-size: 32px;
            color: var(--black);
            background: transparent;
            border: 2px dashed var(--pink);
            text-align: center;
            padding: 5px;
            width: 100%;
            letter-spacing: 2px;
            transition: all 0.3s;
        }

        .player-name-input:focus {
            outline: none;
            border: 2px solid var(--pink);
            background: rgba(255, 70, 154, 0.1);
        }

        .player-name-input::placeholder {
            color: var(--pink);
            opacity: 0.6;
        }

        .player-name-display {
            display: none;
        }

        .game-started .player-name-input {
            display: none;
        }

        .game-started .player-name-display {
            display: block;
        }

        .leg-score {
            font-family: 'Bebas Neue', cursive;
            font-size: 20px;
            color: var(--pink);
            letter-spacing: 1px;
        }

        .stats-column {
            grid-column: 2;
            grid-row: 1 / 3;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
            min-height: 0;
        }

        .averages {
            display: flex;
            flex-direction: row;
            gap: 15px;
            justify-content: space-around;
            background: #f9fafb;
            padding: 15px 10px;
            border: 2px solid #e5e7eb;
            flex-shrink: 0;
        }

        .avg-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .avg-label {
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 700;
            color: var(--black);
            opacity: 0.6;
            margin-bottom: 5px;
        }

        .avg-value {
            font-size: 32px;
            font-family: 'Bebas Neue', cursive;
            color: var(--pink);
            line-height: 1;
        }

        .throw-history {
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
            flex: 1;
            min-height: 0;
        }

        .throw-history::-webkit-scrollbar {
            width: 6px;
        }

        .throw-history::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .throw-history::-webkit-scrollbar-thumb {
            background: var(--pink);
            border-radius: 3px;
        }

        .throw-history::-webkit-scrollbar-thumb:hover {
            background: #E03786;
        }

        .throw-item {
            padding: 8px 10px;
            background: #e5e7eb;
            border: 2px solid #d1d5db;
            font-size: 16px;
            font-weight: 700;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .throw-item:hover {
            background: var(--teal);
            color: var(--black);
            transform: translateX(4px);
        }

        .throw-number {
            color: var(--pink);
            font-family: 'Bebas Neue', cursive;
            font-size: 14px;
        }

        .throw-score {
            font-size: 18px;
        }

        .score-main {
            grid-column: 1;
            grid-row: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .remaining-score {
            font-family: 'Bebas Neue', cursive;
            font-size: clamp(80px, 20vw, 220px);
            font-weight: 900;
            color: var(--pink);
            text-shadow: 6px 6px 0 rgba(0, 0, 0, 0.8);
            line-height: 1;
        }

        .player-score-card.active .remaining-score {
            color: var(--yellow);
            text-shadow: 6px 6px 0 rgba(0, 0, 0, 1);
        }

        .input-panel {
            background: var(--white);
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 10px;
            overflow: hidden;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: auto repeat(4, 1fr);
            gap: 8px;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        .input-display {
            background: var(--yellow);
            border: 4px solid var(--black);
            padding: 20px;
            text-align: center;
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 1);
            grid-column: 2 / 5;
            grid-row: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            gap: 5px;
        }

        .input-text {
            font-family: 'Bebas Neue', cursive;
            font-size: clamp(32px, 8vw, 56px);
            color: var(--black);
            letter-spacing: 4px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.2);
        }

        .outshot-hint {
            font-size: clamp(16px, 4vw, 20px);
            font-weight: 700;
            color: var(--black);
            opacity: 0.7;
        }

        .dart-selector {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 8px;
        }

        .dart-option {
            width: 60px;
            height: 60px;
            border: 3px solid var(--black);
            background: var(--white);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 3px 3px 0 rgba(0, 0, 0, 1);
        }

        .dart-option:hover {
            background: var(--teal);
            transform: translateY(-2px);
            box-shadow: 5px 5px 0 rgba(0, 0, 0, 1);
        }

        .dart-option.selected {
            background: var(--pink);
            border-color: var(--black);
            box-shadow: 5px 5px 0 rgba(0, 0, 0, 1);
        }

        .dart-icon {
            font-size: 28px;
            line-height: 1;
        }

        .dart-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            margin-top: 2px;
            color: var(--black);
        }

        .input-btn {
            border: 4px solid var(--black);
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 1);
            transition: all 0.15s;
            background: var(--teal);
            color: var(--black);
            letter-spacing: 2px;
            min-height: 0;
            user-select: none;
            -webkit-user-select: none;
        }

        .input-btn:active {
            transform: translateY(2px);
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 1);
        }

        .input-btn:hover {
            background: #7DC8E0;
        }

        .side-btn {
            grid-column: 1;
            font-size: 28px;
            background: #e5e7eb;
        }

        .side-btn:hover {
            background: #d1d5db;
        }

        .number-btn {
            background: var(--white);
            font-size: 44px;
        }

        .number-btn:hover {
            background: var(--teal);
        }

        .preset-btn {
            background: var(--pink);
            color: var(--white);
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
            font-size: 32px;
        }

        .preset-btn:hover {
            background: #E03786;
        }

        .action-btn {
            font-size: 24px;
            background: var(--yellow);
        }

        .action-btn:hover {
            background: #F9D71C;
        }

        .action-btn.miss,
        .action-btn.btn-back {
            background: #E03786;
            color: var(--white);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);
        }

        .action-btn.miss:hover,
        .action-btn.btn-back:hover {
            background: #C82D71;
        }

        .btn-back { grid-column: 1; grid-row: 1; }
        .btn-undo { grid-column: 1; grid-row: 1; }
        .btn-miss { grid-column: 5; grid-row: 1; }
        .btn-enter { grid-column: 5; grid-row: 1; }
        
        .btn-26 { grid-column: 1; grid-row: 2; }
        .btn-40 { grid-column: 1; grid-row: 3; }
        .btn-41 { grid-column: 1; grid-row: 4; }
        .btn-43 { grid-column: 1; grid-row: 5; }
        
        .btn-45 { grid-column: 5; grid-row: 2; }
        .btn-60 { grid-column: 5; grid-row: 3; }
        .btn-81 { grid-column: 5; grid-row: 4; }
        .btn-85 { grid-column: 5; grid-row: 5; }
        
        .btn-1 { grid-column: 2; grid-row: 2; }
        .btn-2 { grid-column: 3; grid-row: 2; }
        .btn-3 { grid-column: 4; grid-row: 2; }
        .btn-4 { grid-column: 2; grid-row: 3; }
        .btn-5 { grid-column: 3; grid-row: 3; }
        .btn-6 { grid-column: 4; grid-row: 3; }
        .btn-7 { grid-column: 2; grid-row: 4; }
        .btn-8 { grid-column: 3; grid-row: 4; }
        .btn-9 { grid-column: 4; grid-row: 4; }
        
        .btn-x { grid-column: 2; grid-row: 5; }
        .btn-0 { grid-column: 3; grid-row: 5; }
        .btn-plus { grid-column: 4; grid-row: 5; }
        
        .btn-100 { grid-column: 2; grid-row: 5; }
        .btn-180 { grid-column: 3; grid-row: 5; }
        .btn-140 { grid-column: 4; grid-row: 5; }
        .btn-bust { grid-column: 3; grid-row: 5; }

        .hidden { display: none !important; }

        .winner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .winner-modal.active {
            display: flex;
        }

        .winner-content {
            background: var(--white);
            border: 6px solid var(--black);
            box-shadow: 16px 16px 0 rgba(0, 0, 0, 1);
            padding: 60px;
            text-align: center;
            max-width: 600px;
        }

        .winner-trophy {
            font-size: 120px;
            margin-bottom: 20px;
        }

        .winner-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 96px;
            color: var(--pink);
            text-shadow: 6px 6px 0 rgba(0, 0, 0, 0.3);
            margin-bottom: 40px;
            letter-spacing: 4px;
        }

        .winner-stats {
            margin-bottom: 40px;
            font-size: 24px;
            font-weight: 700;
        }

        .new-game-btn {
            padding: 20px 40px;
            background: var(--pink);
            color: var(--white);
            border: 4px solid var(--black);
            font-family: 'Bebas Neue', cursive;
            font-size: 36px;
            cursor: pointer;
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 1);
            letter-spacing: 2px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
        }

        .new-game-btn:hover {
            background: #E03786;
            transform: translateY(-4px);
            box-shadow: 10px 10px 0 rgba(0, 0, 0, 1);
        }
    </style>
</head>
<body>
    <!-- WELCOME SCREEN -->
    <div class="welcome-screen screen active" id="welcomeScreen">
        <div class="welcome-container">
            <div class="welcome-title">üéØ DART SCORER</div>
            <div class="welcome-subtitle">Burning River Dart Club</div>
            <div class="welcome-buttons">
                <button class="welcome-btn btn-primary" onclick="showPinEntry()">Enter Match PIN</button>
                <button class="welcome-btn btn-secondary" onclick="showSetup()">Play Now</button>
            </div>
        </div>
    </div>

    <!-- SETUP SCREEN - COMPREHENSIVE -->
    <div class="setup-screen screen" id="setupScreen">
        <div class="setup-container">
            <div class="setup-header">
                <div class="setup-title">MATCH SETUP</div>
            </div>

            <!-- PLAYERS SECTION -->
            <div class="section-title">PLAYERS</div>
            
            <div class="form-group">
                <label class="form-label">Match Type</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" onclick="setMatchType('singles')">SINGLES</button>
                    <button class="toggle-btn" onclick="setMatchType('doubles')">DOUBLES</button>
                </div>
            </div>

            <div id="singlesFields">
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Player 1 Name</label>
                        <div class="player-input-row">
                            <input type="text" id="player1Name" class="form-input" placeholder="Enter name">
                            <div class="bot-btn-container">
                                <button class="bot-btn" id="bot1Btn" onclick="toggleBotDropdown(1)">&#129302; BOT</button>
                                <div class="bot-dropdown" id="botDropdown1"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Player 2 Name</label>
                        <div class="player-input-row">
                            <input type="text" id="player2Name" class="form-input" placeholder="Enter name">
                            <div class="bot-btn-container">
                                <button class="bot-btn" id="bot2Btn" onclick="toggleBotDropdown(2)">&#129302; BOT</button>
                                <div class="bot-dropdown" id="botDropdown2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="doublesFields" class="doubles-fields">
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Team 1 Name</label>
                        <input type="text" id="team1Name" class="form-input" placeholder="Team 1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Team 2 Name</label>
                        <input type="text" id="team2Name" class="form-input" placeholder="Team 2">
                    </div>
                </div>
            </div>

            <!-- MATCH FORMAT SECTION -->
            <div class="section-title">MATCH FORMAT</div>
            
            <div class="grid-2">
                <div class="form-group">
                    <label class="form-label">Best of (Legs)</label>
                    <select id="bestOfLegs" class="form-select" onchange="updateLegGames()">
                        <option value="1">1 Leg</option>
                        <option value="3" selected>3 Legs</option>
                        <option value="5">5 Legs</option>
                        <option value="7">7 Legs</option>
                        <option value="9">9 Legs</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Best of (Sets)</label>
                    <select id="bestOfSets" class="form-select">
                        <option value="1" selected>1 Set</option>
                        <option value="3">3 Sets</option>
                        <option value="5">5 Sets</option>
                    </select>
                </div>
            </div>

            <!-- GAME FORMAT SECTION -->
            <div class="section-title">GAME FORMAT</div>
            
            <div class="form-group">
                <label class="form-label">Game Selection Mode</label>
                <div class="radio-group">
                    <div class="radio-option active" onclick="setGameFormat('same')">
                        <input type="radio" name="gameFormat" value="same" checked>
                        <label>Same game all legs</label>
                    </div>
                    <div class="radio-option" onclick="setGameFormat('different')">
                        <input type="radio" name="gameFormat" value="different">
                        <label>Different game each leg</label>
                    </div>
                    <div class="radio-option" onclick="setGameFormat('corks-choice')">
                        <input type="radio" name="gameFormat" value="corks-choice">
                        <label>Cork's choice (winner picks game)</label>
                    </div>
                </div>
            </div>

            <div id="sameGameSelect">
                <div class="form-group">
                    <label class="form-label">Select Game</label>
                    <select id="gameType" class="form-select" onchange="toggleCustomScore()">
                        <option value="501">501</option>
                        <option value="301">301</option>
                        <option value="701">701</option>
                        <option value="custom">Custom (X01)</option>
                    </select>
                </div>
                <div class="form-group hidden" id="customScoreGroup">
                    <label class="form-label">Custom Score (must end in 01)</label>
                    <input type="number" id="customScore" class="form-input" placeholder="e.g. 901" value="901">
                </div>
            </div>

            <div id="legGamesContainer" class="leg-games-container"></div>

            <!-- STARTING RULES SECTION -->
            <div class="section-title">STARTING RULES</div>
            
            <div class="form-group">
                <div class="radio-group">
                    <div class="radio-option active" onclick="setStartingRule('alternate')">
                        <input type="radio" name="startingRule" value="alternate" checked>
                        <label>Alternate start</label>
                    </div>
                    <div class="radio-option" onclick="setStartingRule('cork-first')">
                        <input type="radio" name="startingRule" value="cork-first">
                        <label>Cork first and deciding leg</label>
                    </div>
                    <div class="radio-option" onclick="setStartingRule('cork-every')">
                        <input type="radio" name="startingRule" value="cork-every">
                        <label>Cork every leg</label>
                    </div>
                    <div class="radio-option" onclick="setStartingRule('loser')">
                        <input type="radio" name="startingRule" value="loser">
                        <label>Loser starts next leg</label>
                    </div>
                    <div class="radio-option" onclick="setStartingRule('select')">
                        <input type="radio" name="startingRule" value="select">
                        <label>Select starter (manual)</label>
                    </div>
                </div>
            </div>

            <!-- GAME OPTIONS SECTION -->
            <div class="section-title">GAME OPTIONS</div>
            
            <div class="options-inline">
                <div>
                    <div class="option-label">DOUBLE IN</div>
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="toggleDI(false)">OFF</button>
                        <button class="toggle-btn" onclick="toggleDI(true)">ON</button>
                    </div>
                </div>
                <div>
                    <div class="option-label">OUT RULE</div>
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="setOutOption('free')">FREE</button>
                        <button class="toggle-btn" onclick="setOutOption('double')">DOUBLE</button>
                        <button class="toggle-btn" onclick="setOutOption('master')">MASTER</button>
                    </div>
                </div>
            </div>

            <button class="start-game-btn" onclick="startGame()">START GAME</button>
            <button class="back-btn" onclick="showWelcome()">‚Üê BACK</button>
        </div>
    </div>

    <!-- CORK POPUP -->
    <div class="cork-popup" id="corkPopup">
        <div class="cork-content">
            <div class="cork-title" id="corkTitle">CORK FOR START</div>

            <!-- Step 1: Randomize -->
            <div id="corkStep1">
                <div class="cork-message">Tap to randomize who has option</div>
                <button class="cork-btn" onclick="randomizeCork()">üéØ RANDOMIZE</button>
            </div>

            <!-- Step 2: Who got it? -->
            <div id="corkStep2" class="hidden">
                <div class="cork-message" id="corkOptionMessage">Player has option on cork</div>
                <div class="cork-subtitle">WHO GOT IT?</div>
                <div class="cork-player-btns">
                    <button class="cork-player-btn" id="corkPlayer1Btn" onclick="selectCorkWinner(1)">PLAYER 1</button>
                    <button class="cork-player-btn" id="corkPlayer2Btn" onclick="selectCorkWinner(2)">PLAYER 2</button>
                </div>
            </div>

            <!-- Step 3a: Game OR Start choice -->
            <div id="corkStep3Choice" class="hidden">
                <div class="cork-message" id="corkWinnerMessage">Winner chooses:</div>
                <div class="cork-choice-btns">
                    <button class="cork-choice-btn" onclick="corkChooseOption('game')">
                        <span class="choice-icon">üéÆ</span>
                        <span class="choice-label">PICK GAME</span>
                        <span class="choice-desc">Opponent starts</span>
                    </button>
                    <button class="cork-choice-btn" onclick="corkChooseOption('start')">
                        <span class="choice-icon">üéØ</span>
                        <span class="choice-label">PICK START</span>
                        <span class="choice-desc">Play default game</span>
                    </button>
                </div>
            </div>

            <!-- Step 3b: Game selection -->
            <div id="corkStep3Game" class="hidden">
                <div class="cork-message">Select game for this leg:</div>
                <div class="game-select-btns">
                    <button class="game-select-btn" onclick="selectCorkGame(501)">501</button>
                    <button class="game-select-btn" onclick="selectCorkGame(301)">301</button>
                    <button class="game-select-btn" onclick="selectCorkGame(701)">701</button>
                    <button class="game-select-btn" onclick="selectCorkGame('cricket')">CRICKET</button>
                    <button class="game-select-btn" onclick="selectCorkGame('custom')">CUSTOM</button>
                </div>
            </div>

            <!-- Final: Start button -->
            <button class="cork-btn hidden" id="corkStartBtn" onclick="startLegFromCork()">START LEG</button>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div class="game-screen screen" id="gameScreen">
        <button class="exit-btn" onclick="exitGame()">EXIT</button>
        
        <div class="scores-panel">
            <div class="player-score-card active" id="player1Card">
                <div class="player-header">
                    <input type="text" class="player-name-input" id="player1NameInput" placeholder="TAP TO ENTER NAME" maxlength="20">
                    <div class="player-name player-name-display" id="player1NameDisplay">PLAYER 1</div>
                    <div class="leg-score" id="player1LegScore">LEGS: 0 | SETS: 0</div>
                </div>
                
                <div class="score-main">
                    <div class="remaining-score" id="player1Score">501</div>
                </div>
                
                <div class="stats-column">
                    <div class="averages">
                        <div class="avg-item">
                            <div class="avg-label">Leg Avg</div>
                            <div class="avg-value" id="player1LegAvg">0.0</div>
                        </div>
                        <div class="avg-item">
                            <div class="avg-label">Match Avg</div>
                            <div class="avg-value" id="player1MatchAvg">0.0</div>
                        </div>
                    </div>
                    <div class="throw-history" id="player1History"></div>
                </div>
            </div>

            <div class="player-score-card inactive" id="player2Card">
                <div class="player-header">
                    <input type="text" class="player-name-input" id="player2NameInput" placeholder="TAP TO ENTER NAME" maxlength="20">
                    <div class="player-name player-name-display" id="player2NameDisplay">PLAYER 2</div>
                    <div class="leg-score" id="player2LegScore">LEGS: 0 | SETS: 0</div>
                </div>
                
                <div class="score-main">
                    <div class="remaining-score" id="player2Score">501</div>
                </div>
                
                <div class="stats-column">
                    <div class="averages">
                        <div class="avg-item">
                            <div class="avg-label">Leg Avg</div>
                            <div class="avg-value" id="player2LegAvg">0.0</div>
                        </div>
                        <div class="avg-item">
                            <div class="avg-label">Match Avg</div>
                            <div class="avg-value" id="player2MatchAvg">0.0</div>
                        </div>
                    </div>
                    <div class="throw-history" id="player2History"></div>
                </div>
            </div>
        </div>

        <div class="input-panel">
            <div class="input-grid">
                <button class="input-btn action-btn btn-back">BACK</button>
                <button class="input-btn action-btn btn-undo hidden">UNDO</button>
                
                <div class="input-display">
                    <div class="input-text" id="inputDisplay">PLAYER 1 UP</div>
                    <div class="outshot-hint hidden" id="outshotHint"></div>
                    <div class="dart-selector hidden" id="dartSelector">
                        <div class="dart-option" data-dart="1">
                            <div class="dart-icon">üéØ</div>
                            <div class="dart-label">1st</div>
                        </div>
                        <div class="dart-option" data-dart="2">
                            <div class="dart-icon">üéØ</div>
                            <div class="dart-label">2nd</div>
                        </div>
                        <div class="dart-option" data-dart="3">
                            <div class="dart-icon">üéØ</div>
                            <div class="dart-label">3rd</div>
                        </div>
                    </div>
                </div>
                
                <button class="input-btn action-btn miss btn-miss">MISS</button>
                <button class="input-btn action-btn btn-enter hidden">ENTER</button>

                <button class="input-btn side-btn btn-26" data-value="26">26</button>
                <button class="input-btn side-btn btn-40" data-value="40">40</button>
                <button class="input-btn side-btn btn-41" data-value="41">41</button>
                <button class="input-btn side-btn btn-43" data-value="43">43</button>

                <button class="input-btn side-btn btn-45" data-value="45">45</button>
                <button class="input-btn side-btn btn-60" data-value="60">60</button>
                <button class="input-btn side-btn btn-81" data-value="81">81</button>
                <button class="input-btn side-btn btn-85" data-value="85">85</button>

                <button class="input-btn number-btn btn-1" data-value="1">1</button>
                <button class="input-btn number-btn btn-2" data-value="2">2</button>
                <button class="input-btn number-btn btn-3" data-value="3">3</button>
                <button class="input-btn number-btn btn-4" data-value="4">4</button>
                <button class="input-btn number-btn btn-5" data-value="5">5</button>
                <button class="input-btn number-btn btn-6" data-value="6">6</button>
                <button class="input-btn number-btn btn-7" data-value="7">7</button>
                <button class="input-btn number-btn btn-8" data-value="8">8</button>
                <button class="input-btn number-btn btn-9" data-value="9">9</button>

                <button class="input-btn action-btn btn-x" data-value="x">√ó</button>
                <button class="input-btn number-btn btn-0" data-value="0">0</button>
                <button class="input-btn action-btn btn-plus" data-value="+">+</button>

                <button class="input-btn preset-btn btn-100 hidden" data-value="100">100</button>
                <button class="input-btn preset-btn btn-180 hidden" data-value="180">180</button>
                <button class="input-btn preset-btn btn-140 hidden" data-value="140">140</button>
                <button class="input-btn preset-btn btn-bust hidden">BUST</button>
            </div>
        </div>
    </div>

    <!-- WINNER MODAL -->
    <div class="winner-modal" id="winnerModal">
        <div class="winner-content">
            <div class="winner-trophy">üèÜ</div>
            <div class="winner-title" id="winnerName">PLAYER 1 WINS!</div>
            <div class="winner-stats" id="winnerStats"></div>
            <div id="saveGameSection" style="margin: 30px 0;">
                <p style="font-weight: 700; margin-bottom: 15px;">Save this game to track your stats?</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="cork-btn" onclick="savePickupGame()" style="background: #4CAF50;">SAVE GAME</button>
                    <button class="cork-btn" onclick="skipSaveGame()" style="background: #6b7280;">SKIP</button>
                </div>
                <p id="saveStatus" style="margin-top: 15px; font-size: 14px; color: #6b7280;"></p>
            </div>
            <button class="new-game-btn" id="newGameBtn" style="display: none;" onclick="resetToWelcome()">NEW GAME</button>
        </div>
    </div>

    <!-- CHECKOUT CONFIRMATION MODAL (Double/Master Out) -->
    <div class="winner-modal" id="checkoutModal">
        <div class="winner-content" style="padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 20px;">üéØ</div>
            <div class="winner-title" id="checkoutModalTitle" style="font-size: 48px; margin-bottom: 30px;">CHECKOUT</div>
            <div style="margin-bottom: 10px; font-size: 18px; font-weight: 700;">Was this a valid checkout?</div>
            <div id="checkoutModalButtons" style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;"></div>
        </div>
    </div>

    <!-- CHECKOUT DARTS MODAL -->
    <div class="winner-modal" id="checkoutDartsModal">
        <div class="winner-content" style="padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 20px;">üéØ</div>
            <div class="winner-title" id="checkoutDartsTitle" style="font-size: 48px; margin-bottom: 30px;">CHECKOUT</div>
            <div style="margin-bottom: 20px; font-size: 18px; font-weight: 700;">How many darts to checkout?</div>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="cork-btn" onclick="selectCheckoutDarts(1)" style="font-size: 36px; padding: 20px 30px;">1</button>
                <button class="cork-btn" onclick="selectCheckoutDarts(2)" style="font-size: 36px; padding: 20px 30px;">2</button>
                <button class="cork-btn" onclick="selectCheckoutDarts(3)" style="font-size: 36px; padding: 20px 30px;">3</button>
            </div>
        </div>
    </div>

    <script>
        // Mobile error display for debugging
        window.onerror = function(msg, url, line) {
            alert('Error: ' + msg + '\nLine: ' + line);
            return false;
        };

        // OUTSHOT COMBINATIONS
        const OUTSHOTS = {
            2: ['D1'], 4: ['D2'], 6: ['D3'], 8: ['D4'], 10: ['D5'],
            12: ['D6'], 14: ['D7'], 16: ['D8'], 18: ['D9'], 20: ['D10'],
            22: ['D11'], 24: ['D12'], 26: ['D13'], 28: ['D14'], 30: ['D15'],
            32: ['D16'], 34: ['D17'], 36: ['D18'], 38: ['D19'], 40: ['D20'],
            41: ['9-D16'], 43: ['3-D20', '11-D16'], 44: ['12-D16', '4-D20'],
            45: ['13-D16', '5-D20'], 46: ['6-D20', '14-D16'], 47: ['15-D16', '7-D20'],
            48: ['8-D20', '16-D16'], 49: ['17-D16', '9-D20'], 50: ['10-D20', '18-D16'],
            51: ['19-D16', '11-D20'], 52: ['12-D20', '20-D16'], 53: ['13-D20'],
            54: ['14-D20'], 55: ['15-D20'], 56: ['16-D20'], 57: ['17-D20'],
            58: ['18-D20'], 59: ['19-D20'], 60: ['20-D20'],
            61: ['T15-D8', '25-D18'], 62: ['T10-D16', '10-D26'], 63: ['T13-D12', '13-D25'],
            64: ['T16-D8', 'T14-D11'], 65: ['T11-D16', '25-D20'], 66: ['T10-D18'],
            67: ['T17-D8', '17-D25'], 68: ['T20-D4', 'T16-D10'], 69: ['T19-D6', '19-D25'],
            70: ['T18-D8', 'T10-D20'], 71: ['T13-D16', '13-D27'], 72: ['T16-D12'],
            73: ['T19-D8'], 74: ['T14-D16'], 75: ['T17-D12'], 76: ['T20-D8', 'T16-D14'],
            77: ['T19-D10'], 78: ['T18-D12'], 79: ['T13-D20', 'T19-D11'], 80: ['T20-D10'],
            81: ['T19-D12'], 82: ['BULL-D16', 'T14-D20'], 83: ['T17-D16'], 84: ['T20-D12'],
            85: ['T15-D20'], 86: ['T18-D16'], 87: ['T17-D18'], 88: ['T16-D20'],
            89: ['T19-D16'], 90: ['T18-D18', 'T20-D15'], 91: ['T17-D20'], 92: ['T20-D16'],
            93: ['T19-D18'], 94: ['T18-D20'], 95: ['T19-D19'], 96: ['T20-D18'],
            97: ['T19-D20'], 98: ['T20-D19'], 99: ['T19-D21'], 100: ['T20-D20'],
            101: ['T17-BULL'], 102: ['T20-D21'], 103: ['T19-D23'], 104: ['T18-BULL'],
            105: ['T20-D22.5'], 106: ['T20-D23'], 107: ['T19-BULL'], 108: ['T20-D24'],
            109: ['T20-D24.5'], 110: ['T20-BULL'], 
            111: ['T19-18-D18'], 112: ['T20-20-D16'], 113: ['T19-20-D18'], 114: ['T20-18-D18'],
            115: ['T20-19-D19'], 116: ['T20-20-D18'], 117: ['T20-17-D20'], 118: ['T20-18-D20'],
            119: ['T20-19-D20'], 120: ['T20-20-D20'],
            121: ['T20-17-BULL'], 122: ['T18-18-BULL'], 123: ['T19-18-BULL'], 124: ['T20-18-BULL'],
            125: ['T18-19-BULL'], 126: ['T19-19-BULL'], 127: ['T20-17-BULL'], 128: ['T18-20-BULL'],
            129: ['T19-20-BULL'], 130: ['T20-20-BULL'],
            131: ['T20-19-BULL'], 132: ['BULL-BULL-D16'], 133: ['T20-19-D18'], 134: ['T20-20-D17'],
            135: ['BULL-BULL-D17.5'], 136: ['T20-20-D18'], 137: ['T20-19-D20'], 138: ['T20-18-BULL'],
            139: ['T20-19-BULL'], 140: ['T20-20-BULL'],
            141: ['T20-T19-D12'], 142: ['T20-T14-D20'], 143: ['T20-T17-D16'], 144: ['T20-T20-D12'],
            145: ['T20-T19-D14'], 146: ['T20-T18-D16'], 147: ['T20-T17-D18'], 148: ['T20-T20-D14'],
            149: ['T20-T19-D16'], 150: ['T20-T18-D18'], 151: ['T20-T17-D20'], 152: ['T20-T20-D16'],
            153: ['T20-T19-D18'], 154: ['T20-T18-D20'], 155: ['T20-T19-D19'], 156: ['T20-T20-D18'],
            157: ['T20-T19-D20'], 158: ['T20-T20-D19'], 160: ['T20-T20-D20'],
            161: ['T20-T17-BULL'], 164: ['T20-T18-BULL'], 167: ['T20-T19-BULL'], 170: ['T20-T20-BULL']
        };

        // GAME STATE
        const gameState = {
            player1: { name: '', legs: 0, sets: 0, score: 501, throws: [], currentThrow: [] },
            player2: { name: '', legs: 0, sets: 0, score: 501, throws: [], currentThrow: [] },
            currentPlayer: 1,
            matchType: 'singles',
            gameFormat: 'same',
            startingRule: 'alternate',
            selectedGameType: 501,
            legGames: [],
            currentLegGame: 501,
            startingScore: 501,
            bestOfLegs: 3,
            bestOfSets: 1,
            currentLeg: 1,
            currentSet: 1,
            inOption: 'free',
            outOption: 'free',
            inputValue: '',
            inputMode: 'preset',
            gameStarted: false,
            selectedDart: null,
            showingOutshot: false,
            corkWinner: null,
            lastLegWinner: null
        };

        // CACHED DOM ELEMENTS
        const elements = {
            welcomeScreen: document.getElementById('welcomeScreen'),
            setupScreen: document.getElementById('setupScreen'),
            gameScreen: document.getElementById('gameScreen'),
            winnerModal: document.getElementById('winnerModal'),
            corkPopup: document.getElementById('corkPopup'),
            inputDisplay: document.getElementById('inputDisplay'),
            outshotHint: document.getElementById('outshotHint'),
            dartSelector: document.getElementById('dartSelector'),
            player1Score: document.getElementById('player1Score'),
            player2Score: document.getElementById('player2Score'),
            player1Card: document.getElementById('player1Card'),
            player2Card: document.getElementById('player2Card'),
            player1LegScore: document.getElementById('player1LegScore'),
            player2LegScore: document.getElementById('player2LegScore'),
            player1LegAvg: document.getElementById('player1LegAvg'),
            player2LegAvg: document.getElementById('player2LegAvg'),
            player1MatchAvg: document.getElementById('player1MatchAvg'),
            player2MatchAvg: document.getElementById('player2MatchAvg'),
            player1History: document.getElementById('player1History'),
            player2History: document.getElementById('player2History'),
            player1NameInput: document.getElementById('player1NameInput'),
            player2NameInput: document.getElementById('player2NameInput'),
            player1NameDisplay: document.getElementById('player1NameDisplay'),
            player2NameDisplay: document.getElementById('player2NameDisplay'),
            winnerName: document.getElementById('winnerName'),
            winnerStats: document.getElementById('winnerStats')
        };

        const shortcuts = ['26', '40', '41', '43', '45', '60', '81', '85', '100', '180', '140'];

        // BOT SELECTION
        let registeredBots = [];
        let selectedBots = { 1: null, 2: null };
        const BOT_AVG_LABELS = {
            easy: '~40 avg',
            medium: '~55 avg',
            league: '~65 avg',
            hard: '~75 avg',
            pro: '~90 avg'
        };

        async function loadRegisteredBots() {
            try {
                const CLOUD_URL = 'https://us-central1-brdc-v2.cloudfunctions.net';
                const response = await fetch(`${CLOUD_URL}/getBots`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const result = await response.json();
                registeredBots = result.bots || [];
                updateBotDropdowns();
            } catch (error) {
                console.error('Error loading bots:', error);
            }
        }

        function toggleBotDropdown(playerNum) {
            const dropdown = document.getElementById(`botDropdown${playerNum}`);
            const otherDropdown = document.getElementById(`botDropdown${playerNum === 1 ? 2 : 1}`);
            otherDropdown.classList.remove('open');
            dropdown.classList.toggle('open');
        }

        function updateBotDropdowns() {
            [1, 2].forEach(playerNum => {
                const container = document.getElementById(`botDropdown${playerNum}`);
                const otherBotId = selectedBots[playerNum === 1 ? 2 : 1]?.id;

                if (registeredBots.length === 0) {
                    container.innerHTML = `
                        <div class="bot-option disabled">
                            <div class="bot-option-name" style="color: #666;">No bots available</div>
                            <div class="bot-option-avg">Add bots in Admin Portal</div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = registeredBots.map(bot => {
                    const isOtherBot = bot.id === otherBotId;
                    const avgLabel = BOT_AVG_LABELS[bot.difficulty] || '~55 avg';
                    return `
                        <div class="bot-option ${isOtherBot ? 'disabled' : ''}" onclick="${isOtherBot ? '' : `selectBot(${playerNum}, '${bot.id}')`}">
                            <div class="bot-option-name">${bot.name}${isOtherBot ? ' (P${playerNum === 1 ? 2 : 1})' : ''}</div>
                            <div class="bot-option-avg">${bot.difficulty.charAt(0).toUpperCase() + bot.difficulty.slice(1)} - ${avgLabel}</div>
                        </div>
                    `;
                }).join('') + `
                    ${selectedBots[playerNum] ? `
                        <div class="bot-option" onclick="clearBot(${playerNum})" style="background: rgba(255,70,154,0.1);">
                            <div class="bot-option-name" style="color: var(--pink);">Clear Bot</div>
                        </div>
                    ` : ''}
                `;
            });
        }

        function selectBot(playerNum, botId) {
            const bot = registeredBots.find(b => b.id === botId);
            if (!bot) return;

            selectedBots[playerNum] = bot;
            document.getElementById(`player${playerNum}Name`).value = bot.name;
            document.getElementById(`player${playerNum}Name`).disabled = true;
            document.getElementById(`bot${playerNum}Btn`).classList.add('selected');
            document.getElementById(`botDropdown${playerNum}`).classList.remove('open');

            // Store bot info in gameState
            gameState[`player${playerNum}`].isBot = true;
            gameState[`player${playerNum}`].botDifficulty = bot.difficulty;
            gameState[`player${playerNum}`].registeredBotId = bot.id;

            updateBotDropdowns();
        }

        function clearBot(playerNum) {
            selectedBots[playerNum] = null;
            document.getElementById(`player${playerNum}Name`).value = '';
            document.getElementById(`player${playerNum}Name`).disabled = false;
            document.getElementById(`bot${playerNum}Btn`).classList.remove('selected');
            document.getElementById(`botDropdown${playerNum}`).classList.remove('open');

            gameState[`player${playerNum}`].isBot = false;
            gameState[`player${playerNum}`].botDifficulty = null;
            gameState[`player${playerNum}`].registeredBotId = null;

            updateBotDropdowns();
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.bot-btn-container')) {
                document.querySelectorAll('.bot-dropdown').forEach(d => d.classList.remove('open'));
            }
        });

        // Load bots on page load
        loadRegisteredBots();

        // KNOCKOUT MODE DETECTION
        let knockoutContext = null;
        const urlParams = new URLSearchParams(window.location.search);
        const isKnockoutMode = urlParams.get('knockout') === 'true';

        if (isKnockoutMode) {
            // Load knockout context from localStorage
            try {
                knockoutContext = JSON.parse(localStorage.getItem('knockoutContext'));
            } catch (e) {
                console.log('No knockout context found');
            }

            // Pre-fill player names from URL params
            const p1Name = urlParams.get('p1');
            const p2Name = urlParams.get('p2');
            const bestOf = urlParams.get('bestOf');
            const startScore = urlParams.get('startScore');

            if (p1Name) document.getElementById('player1Name').value = p1Name;
            if (p2Name) document.getElementById('player2Name').value = p2Name;
            if (bestOf) document.getElementById('bestOfLegs').value = bestOf;
            if (startScore) document.getElementById('gameType').value = startScore;

            console.log('Knockout mode enabled:', knockoutContext);

            // Show setup screen briefly then auto-start game
            setTimeout(() => {
                // Switch to setup screen first (required for form fields)
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('setupScreen').classList.add('active');

                // Start game after a brief moment
                setTimeout(() => {
                    startGame();
                }, 50);
            }, 100);
        }

        // SCREEN NAVIGATION
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showWelcome() {
            showScreen('welcomeScreen');
        }

        function showSetup() {
            showScreen('setupScreen');
        }

        function showPinEntry() {
            // Redirect to main site for match PIN entry
            window.location.href = '/';
        }

        function exitGame() {
            if (confirm('Exit game? Progress will be lost.')) {
                resetToWelcome();
            }
        }

        // SETUP FUNCTIONS
        function setMatchType(type) {
            gameState.matchType = type;
            document.querySelectorAll('[onclick^="setMatchType"]').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (type === 'doubles') {
                document.getElementById('singlesFields').style.display = 'none';
                document.getElementById('doublesFields').classList.add('active');
            } else {
                document.getElementById('singlesFields').style.display = 'block';
                document.getElementById('doublesFields').classList.remove('active');
            }
        }

        function setGameFormat(format) {
            gameState.gameFormat = format;
            
            // Remove active from all game format options
            document.querySelectorAll('[name="gameFormat"]').forEach(radio => {
                const option = radio.closest('.radio-option');
                if (option) option.classList.remove('active');
            });
            
            // Add active to clicked option and check radio
            const clickedOption = event.target.closest('.radio-option');
            if (clickedOption) {
                clickedOption.classList.add('active');
                const radio = clickedOption.querySelector('input[type="radio"]');
                if (radio) radio.checked = true;
            }
            
            const sameGameSelect = document.getElementById('sameGameSelect');
            const legGamesContainer = document.getElementById('legGamesContainer');
            
            if (format === 'same') {
                sameGameSelect.style.display = 'block';
                legGamesContainer.classList.remove('active');
            } else if (format === 'different') {
                sameGameSelect.style.display = 'none';
                legGamesContainer.classList.add('active');
                updateLegGames();
            } else {
                sameGameSelect.style.display = 'none';
                legGamesContainer.classList.remove('active');
            }
        }

        function toggleCustomScore() {
            const gameType = document.getElementById('gameType').value;
            const customGroup = document.getElementById('customScoreGroup');
            if (gameType === 'custom') {
                customGroup.classList.remove('hidden');
            } else {
                customGroup.classList.add('hidden');
            }
        }

        function updateLegGames() {
            if (gameState.gameFormat !== 'different') return;
            
            const numLegs = parseInt(document.getElementById('bestOfLegs').value);
            const container = document.getElementById('legGamesContainer');
            container.innerHTML = '';
            
            for (let i = 1; i <= numLegs; i++) {
                const div = document.createElement('div');
                div.className = 'leg-game-item';
                div.innerHTML = `
                    <label>Leg ${i}</label>
                    <select class="leg-game-select" data-leg="${i}">
                        <option value="501">501</option>
                        <option value="301">301</option>
                        <option value="701">701</option>
                        <option value="custom">Custom</option>
                    </select>
                `;
                container.appendChild(div);
            }
        }

        function setStartingRule(rule) {
            gameState.startingRule = rule;
            
            // Remove active from all starting rule options
            document.querySelectorAll('[name="startingRule"]').forEach(radio => {
                const option = radio.closest('.radio-option');
                if (option) option.classList.remove('active');
            });
            
            // Add active to clicked option and check radio
            const clickedOption = event.target.closest('.radio-option');
            if (clickedOption) {
                clickedOption.classList.add('active');
                const radio = clickedOption.querySelector('input[type="radio"]');
                if (radio) radio.checked = true;
            }
        }

        function toggleDI(enabled) {
            gameState.inOption = enabled ? 'double' : 'free';
            event.target.parentElement.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function setOutOption(option) {
            gameState.outOption = option;
            event.target.parentElement.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Legacy function for backwards compatibility
        function toggleDO(enabled) {
            setOutOption(enabled ? 'double' : 'free');
        }

        // GAME START
        function startGame() {
            // Get player names
            if (gameState.matchType === 'singles') {
                gameState.player1.name = document.getElementById('player1Name').value.trim() || 'Player 1';
                gameState.player2.name = document.getElementById('player2Name').value.trim() || 'Player 2';
            } else {
                gameState.player1.name = document.getElementById('team1Name').value.trim() || 'Team 1';
                gameState.player2.name = document.getElementById('team2Name').value.trim() || 'Team 2';
            }
            
            // Set names on game screen
            elements.player1NameInput.value = gameState.player1.name;
            elements.player2NameInput.value = gameState.player2.name;
            
            // Get game type
            if (gameState.gameFormat === 'same') {
                const gameType = document.getElementById('gameType').value;
                if (gameType === 'custom') {
                    gameState.startingScore = parseInt(document.getElementById('customScore').value) || 501;
                    gameState.selectedGameType = 'custom';
                } else {
                    gameState.startingScore = parseInt(gameType);
                    gameState.selectedGameType = parseInt(gameType);
                }
            } else if (gameState.gameFormat === 'different') {
                const selects = document.querySelectorAll('.leg-game-select');
                gameState.legGames = [];
                selects.forEach(select => {
                    gameState.legGames.push(select.value);
                });
                gameState.startingScore = parseInt(gameState.legGames[0]) || 501;
            }
            
            gameState.bestOfLegs = parseInt(document.getElementById('bestOfLegs').value);
            gameState.bestOfSets = parseInt(document.getElementById('bestOfSets').value);
            
            // Check if we need cork
            if (needsCork()) {
                showCorkPopup();
            } else {
                initializeGame();
            }
        }

        function needsCork() {
            return gameState.startingRule === 'cork-every' || gameState.startingRule === 'cork-first';
        }

        // Cork state
        let corkState = {
            optionPlayer: null,  // Who has option (from randomize)
            winner: null,        // Who actually won the cork
            chosenOption: null   // 'game' or 'start' (for game-or-start mode)
        };

        function showCorkPopup() {
            // Reset cork state
            corkState = { optionPlayer: null, winner: null, chosenOption: null };

            // Set title based on mode
            const titleEl = document.getElementById('corkTitle');
            if (gameState.gameFormat === 'corks-choice') {
                titleEl.textContent = 'CORK TO SELECT GAME & START';
            } else {
                titleEl.textContent = 'CORK FOR START';
            }

            // Reset all steps
            document.getElementById('corkStep1').classList.remove('hidden');
            document.getElementById('corkStep2').classList.add('hidden');
            document.getElementById('corkStep3Choice').classList.add('hidden');
            document.getElementById('corkStep3Game').classList.add('hidden');
            document.getElementById('corkStartBtn').classList.add('hidden');

            // Set player names on buttons
            document.getElementById('corkPlayer1Btn').textContent = gameState.player1.name.toUpperCase();
            document.getElementById('corkPlayer2Btn').textContent = gameState.player2.name.toUpperCase();

            elements.corkPopup.classList.add('active');
        }

        window.randomizeCork = function() {
            const step1 = document.getElementById('corkStep1');
            const step2 = document.getElementById('corkStep2');
            const msgEl = document.getElementById('corkOptionMessage');

            // Shuffle animation
            step1.innerHTML = '<div class="cork-message" style="font-size: 24px;">üéØ Randomizing...</div>';

            let shuffleCount = 0;
            const shuffleInterval = setInterval(() => {
                const randomPlayer = Math.random() < 0.5 ? 1 : 2;
                const name = randomPlayer === 1 ? gameState.player1.name : gameState.player2.name;
                step1.innerHTML = `<div class="cork-message" style="font-size: 24px;">üéØ ${name.toUpperCase()}</div>`;
                shuffleCount++;

                if (shuffleCount >= 10) {
                    clearInterval(shuffleInterval);

                    // Final result
                    corkState.optionPlayer = Math.random() < 0.5 ? 1 : 2;
                    const winnerName = corkState.optionPlayer === 1 ? gameState.player1.name : gameState.player2.name;

                    setTimeout(() => {
                        step1.classList.add('hidden');
                        msgEl.textContent = `${winnerName.toUpperCase()} has option on cork`;
                        step2.classList.remove('hidden');
                    }, 300);
                }
            }, 100);
        };

        window.selectCorkWinner = function(player) {
            corkState.winner = player;
            gameState.corkWinner = player;
            gameState.currentPlayer = player;

            const winnerName = player === 1 ? gameState.player1.name : gameState.player2.name;

            document.getElementById('corkStep2').classList.add('hidden');

            // Determine next step based on game format
            if (gameState.gameFormat === 'corks-choice') {
                // Winner picks game AND starts
                document.getElementById('corkWinnerMessage').textContent = `${winnerName.toUpperCase()} selects game:`;
                document.getElementById('corkStep3Game').classList.remove('hidden');
            } else {
                // Just cork for start - go directly to game
                document.getElementById('corkStartBtn').classList.remove('hidden');
            }
        };

        window.corkChooseOption = function(option) {
            corkState.chosenOption = option;
            const winnerName = corkState.winner === 1 ? gameState.player1.name : gameState.player2.name;

            document.getElementById('corkStep3Choice').classList.add('hidden');

            if (option === 'game') {
                // Winner picks game, opponent starts
                gameState.currentPlayer = corkState.winner === 1 ? 2 : 1;
                document.getElementById('corkStep3Game').classList.remove('hidden');
            } else {
                // Winner starts, play default game
                gameState.currentPlayer = corkState.winner;
                document.getElementById('corkStartBtn').classList.remove('hidden');
            }
        };

        window.selectCorkGame = function(game) {
            document.querySelectorAll('.game-select-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');

            if (game === 'cricket') {
                // Redirect to cricket scorer with player names
                const params = new URLSearchParams();
                if (gameState.player1.name && gameState.player1.name !== 'PLAYER 1') {
                    params.set('p1', gameState.player1.name);
                }
                if (gameState.player2.name && gameState.player2.name !== 'PLAYER 2') {
                    params.set('p2', gameState.player2.name);
                }
                // Pass who starts (opponent of cork winner)
                params.set('starter', gameState.currentPlayer);
                window.location.href = '/pages/cricket.html?' + params.toString();
                return;
            } else if (game === 'custom') {
                const customScore = prompt('Enter custom score (must end in 01):', '901');
                if (customScore && parseInt(customScore) % 100 === 1) {
                    gameState.currentLegGame = parseInt(customScore);
                    gameState.startingScore = parseInt(customScore);
                } else {
                    return; // Invalid, don't proceed
                }
            } else {
                gameState.currentLegGame = game;
                gameState.startingScore = game;
            }

            document.getElementById('corkStartBtn').classList.remove('hidden');
        };

        window.startLegFromCork = function() {
            elements.corkPopup.classList.remove('active');
            initializeGame();
        };

        function initializeGame() {
            gameState.player1.score = gameState.startingScore;
            gameState.player2.score = gameState.startingScore;
            gameState.player1.throws = [];
            gameState.player2.throws = [];
            gameState.player1.currentThrow = [];
            gameState.player2.currentThrow = [];
            gameState.gameStarted = false;

            showScreen('gameScreen');
            updateDisplay();
        }

        // INPUT HANDLING
        function initializeEventListeners() {
            const inputGrid = document.querySelector('.input-grid');
            inputGrid.addEventListener('click', handleInputClick);

            elements.dartSelector.addEventListener('click', handleDartSelection);

            document.body.addEventListener('touchmove', function(e) {
                if (!e.target.closest('.throw-history')) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        function handleInputClick(e) {
            const btn = e.target.closest('.input-btn');
            if (!btn) return;

            if (btn.disabled) return;
            btn.disabled = true;
            setTimeout(() => btn.disabled = false, 200);

            const classList = btn.classList;
            
            if (classList.contains('btn-back')) {
                clearInput();
            } else if (classList.contains('btn-undo')) {
                undoInput();
            } else if (classList.contains('btn-miss')) {
                missAll();
            } else if (classList.contains('btn-enter')) {
                enterScore();
            } else if (classList.contains('btn-bust')) {
                bustTurn();
            } else if (btn.dataset.value) {
                addToInput(btn.dataset.value);
            }
        }

        function handleDartSelection(e) {
            const dartOption = e.target.closest('.dart-option');
            if (!dartOption) return;

            document.querySelectorAll('.dart-option').forEach(d => d.classList.remove('selected'));
            dartOption.classList.add('selected');
            gameState.selectedDart = parseInt(dartOption.dataset.dart);
            
            finishGameWithDart(gameState.selectedDart);
        }

        function finishGameWithDart(dartNumber) {
            const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            const winningScore = currentPlayer.score;
            currentPlayer.score = 0;
            currentPlayer.throws.push({ total: winningScore, checkout: true, dart: dartNumber });
            
            winLeg();
        }

        function startScoring() {
            if (!gameState.gameStarted) {
                gameState.player1.name = elements.player1NameInput.value.trim() || gameState.player1.name || 'Player 1';
                gameState.player2.name = elements.player2NameInput.value.trim() || gameState.player2.name || 'Player 2';
                
                elements.player1NameDisplay.textContent = gameState.player1.name.toUpperCase();
                elements.player2NameDisplay.textContent = gameState.player2.name.toUpperCase();
                
                elements.gameScreen.classList.add('game-started');
                gameState.gameStarted = true;
            }
        }

        function addToInput(value) {
            if (shortcuts.includes(value)) {
                gameState.inputValue = value;
                enterScore();
                return;
            }

            gameState.inputValue += value;
            gameState.inputMode = 'typing';
            updateInputDisplay();
            switchToTypingMode();
        }

        function clearInput() {
            gameState.inputValue = '';
            gameState.inputMode = 'preset';
            gameState.showingOutshot = false;
            updateInputDisplay();
            switchToPresetMode();
        }

        function undoInput() {
            gameState.inputValue = gameState.inputValue.slice(0, -1);
            if (gameState.inputValue === '') {
                clearInput();
            } else {
                updateInputDisplay();
            }
        }

        function updateInputDisplay() {
            if (!gameState.gameStarted) {
                const currentPlayerName = gameState.currentPlayer === 1 ? 
                    (elements.player1NameInput.value.trim() || gameState.player1.name || 'PLAYER 1') : 
                    (elements.player2NameInput.value.trim() || gameState.player2.name || 'PLAYER 2');
                elements.inputDisplay.textContent = currentPlayerName.toUpperCase() + ' UP';
                elements.outshotHint.classList.add('hidden');
                elements.dartSelector.classList.add('hidden');
                return;
            }

            const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            
            if (gameState.inputValue === '' && OUTSHOTS[currentPlayer.score] && currentPlayer.score <= 170) {
                gameState.showingOutshot = true;
                const outs = OUTSHOTS[currentPlayer.score];
                elements.inputDisplay.textContent = currentPlayer.score.toString();
                elements.outshotHint.textContent = outs[0];
                elements.outshotHint.classList.remove('hidden');
                elements.dartSelector.classList.remove('hidden');
            } else if (gameState.inputValue === '') {
                elements.inputDisplay.textContent = currentPlayer.name.toUpperCase() + ' UP';
                elements.outshotHint.classList.add('hidden');
                elements.dartSelector.classList.add('hidden');
                gameState.showingOutshot = false;
            } else {
                elements.inputDisplay.textContent = gameState.inputValue;
                elements.outshotHint.classList.add('hidden');
                elements.dartSelector.classList.add('hidden');
                gameState.showingOutshot = false;
            }
        }

        function switchToTypingMode() {
            document.querySelector('.btn-back').classList.add('hidden');
            document.querySelector('.btn-undo').classList.remove('hidden');
            document.querySelector('.btn-miss').classList.add('hidden');
            document.querySelector('.btn-enter').classList.remove('hidden');

            document.querySelector('.btn-x').classList.remove('hidden');
            document.querySelector('.btn-0').classList.remove('hidden');
            document.querySelector('.btn-plus').classList.remove('hidden');

            document.querySelector('.btn-100').classList.add('hidden');
            document.querySelector('.btn-180').classList.add('hidden');
            document.querySelector('.btn-140').classList.add('hidden');
            document.querySelector('.btn-bust').classList.add('hidden');
        }

        function switchToPresetMode() {
            document.querySelector('.btn-back').classList.remove('hidden');
            document.querySelector('.btn-undo').classList.add('hidden');
            document.querySelector('.btn-miss').classList.remove('hidden');
            document.querySelector('.btn-enter').classList.add('hidden');

            document.querySelector('.btn-x').classList.add('hidden');
            document.querySelector('.btn-0').classList.add('hidden');
            document.querySelector('.btn-plus').classList.add('hidden');

            const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            
            document.querySelector('.btn-100').classList.remove('hidden');
            document.querySelector('.btn-140').classList.remove('hidden');
            
            if (currentPlayer.score <= 170 && gameState.gameStarted) {
                document.querySelector('.btn-bust').classList.remove('hidden');
                document.querySelector('.btn-180').classList.add('hidden');
            } else {
                document.querySelector('.btn-180').classList.remove('hidden');
                document.querySelector('.btn-bust').classList.add('hidden');
            }
        }

        // Impossible 3-dart scores between 160-180
        const IMPOSSIBLE_SCORES = [163, 166, 169, 172, 173, 175, 176, 178, 179];

        function enterScore() {
            startScoring();

            let score = 0;
            let expression = gameState.inputValue.replace(/x/g, '*').replace(/\s/g, '');

            if (expression.includes('*')) {
                const parts = expression.split('*');
                if (parts.length === 2) {
                    score = (parseInt(parts[0]) || 0) * (parseInt(parts[1]) || 0);
                }
            } else if (expression.includes('+')) {
                const parts = expression.split('+');
                score = parts.reduce((sum, part) => sum + (parseInt(part) || 0), 0);
            } else {
                score = parseInt(expression) || 0;
            }

            if (score > 180) {
                alert('Maximum score per turn is 180!');
                clearInput();
                return;
            }

            // Check for impossible scores
            if (IMPOSSIBLE_SCORES.includes(score)) {
                alert('Invalid score - ' + score + ' is not achievable with 3 darts');
                clearInput();
                return;
            }

            const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            const newScore = currentPlayer.score - score;

            // Check for bust conditions based on out option
            let isBust = false;
            if (newScore < 0) {
                isBust = true;
            } else if (gameState.outOption === 'double' && newScore === 1) {
                // Can't checkout on 1 with double out
                isBust = true;
            } else if (gameState.outOption === 'master' && newScore === 1) {
                // Can't checkout on 1 with master out (need double or triple)
                isBust = true;
            }

            if (isBust) {
                currentPlayer.throws.push({ total: score, bust: true });
                alert('BUST!');
                endTurn();
                return;
            }

            if (newScore === 0) {
                // Checkout! But need to validate for double/master out
                if (gameState.outOption === 'double') {
                    // Show confirmation for double out
                    showCheckoutModal(score, 'double');
                } else if (gameState.outOption === 'master') {
                    // Show confirmation for master out (double or triple)
                    showCheckoutModal(score, 'master');
                } else {
                    // Free out - just show dart count modal
                    showCheckoutDartsModal(score);
                }
                return;
            }

            // Regular score
            currentPlayer.score = newScore;
            currentPlayer.throws.push({ total: score });
            endTurn();
        }

        // Store pending checkout for confirmation flow
        let pendingCheckout = null;

        function showCheckoutModal(score, outType) {
            pendingCheckout = { score, outType };
            const modal = document.getElementById('checkoutModal');
            const title = document.getElementById('checkoutModalTitle');
            const buttons = document.getElementById('checkoutModalButtons');

            if (outType === 'double') {
                title.textContent = 'DOUBLE OUT CHECKOUT';
                buttons.innerHTML = `
                    <button class="cork-btn" onclick="confirmCheckout('double')">YES - DOUBLE OUT</button>
                    <button class="cork-btn" style="background: #666;" onclick="cancelCheckout()">NO - BUST</button>
                `;
            } else if (outType === 'master') {
                title.textContent = 'MASTER OUT CHECKOUT';
                buttons.innerHTML = `
                    <button class="cork-btn" onclick="confirmCheckout('double')">DOUBLE OUT</button>
                    <button class="cork-btn" style="background: var(--teal); color: #000;" onclick="confirmCheckout('triple')">TRIPLE OUT</button>
                    <button class="cork-btn" style="background: #666;" onclick="cancelCheckout()">BUST</button>
                `;
            }

            modal.classList.add('active');
        }

        function confirmCheckout(finishType) {
            document.getElementById('checkoutModal').classList.remove('active');
            // Now show dart count modal
            showCheckoutDartsModal(pendingCheckout.score, finishType);
        }

        function cancelCheckout() {
            document.getElementById('checkoutModal').classList.remove('active');
            const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            currentPlayer.throws.push({ total: pendingCheckout.score, bust: true });
            alert('BUST!');
            pendingCheckout = null;
            clearInput();
            endTurn();
        }

        function showCheckoutDartsModal(score, finishType = 'free') {
            pendingCheckout = { score, finishType };
            const modal = document.getElementById('checkoutDartsModal');
            document.getElementById('checkoutDartsTitle').textContent = 'CHECKOUT: ' + score;
            modal.classList.add('active');
        }

        function selectCheckoutDarts(darts) {
            document.getElementById('checkoutDartsModal').classList.remove('active');
            const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            currentPlayer.score = 0;
            currentPlayer.throws.push({
                total: pendingCheckout.score,
                checkout: true,
                checkout_darts: darts,
                finish_type: pendingCheckout.finishType
            });
            pendingCheckout = null;
            clearInput();
            winLeg();
        }

        function missAll() {
            startScoring();
            const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            currentPlayer.throws.push({ total: 0 });
            endTurn();
        }

        function bustTurn() {
            startScoring();
            const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            currentPlayer.throws.push({ total: 0, bust: true });
            endTurn();
        }

        function endTurn() {
            const currentPlayer = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            currentPlayer.currentThrow = [];
            
            gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
            gameState.selectedDart = null;
            
            document.querySelectorAll('.dart-option').forEach(d => d.classList.remove('selected'));
            
            updateDisplay();
            clearInput();
        }

        function winLeg() {
            const winner = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            const loser = gameState.currentPlayer === 1 ? gameState.player2 : gameState.player1;
            winner.legs++;
            gameState.lastLegWinner = gameState.currentPlayer;

            const legsToWin = Math.ceil(gameState.bestOfLegs / 2);
            
            if (winner.legs >= legsToWin) {
                // Won the set
                winner.sets++;
                const setsToWin = Math.ceil(gameState.bestOfSets / 2);
                
                if (winner.sets >= setsToWin) {
                    // Won the match
                    showWinner(winner);
                } else {
                    // Start new set
                    alert(`${winner.name} wins the set! Sets: ${gameState.player1.sets} - ${gameState.player2.sets}`);
                    gameState.player1.legs = 0;
                    gameState.player2.legs = 0;
                    resetLeg();
                }
            } else {
                // Continue in current set
                alert(`${winner.name} wins the leg! Legs: ${gameState.player1.legs} - ${gameState.player2.legs}`);
                resetLeg();
            }
        }

        function resetLeg() {
            gameState.player1.score = gameState.startingScore;
            gameState.player2.score = gameState.startingScore;
            gameState.player1.throws = [];
            gameState.player2.throws = [];
            gameState.player1.currentThrow = [];
            gameState.player2.currentThrow = [];
            
            // Determine who starts next leg
            if (gameState.startingRule === 'alternate') {
                gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
            } else if (gameState.startingRule === 'loser') {
                gameState.currentPlayer = gameState.lastLegWinner === 1 ? 2 : 1;
            } else if (gameState.startingRule === 'cork-every') {
                showCorkPopup();
                return;
            }
            
            updateDisplay();
        }

        function showWinner(winner) {
            elements.winnerName.textContent = winner.name.toUpperCase() + ' WINS!';
            elements.winnerStats.textContent = `Final Score: ${gameState.player1.sets} - ${gameState.player2.sets} (Sets)`;
            elements.winnerModal.classList.add('active');

            // If knockout mode, show different UI
            if (isKnockoutMode && knockoutContext) {
                const saveSection = document.getElementById('saveGameSection');
                saveSection.innerHTML = `
                    <p style="font-weight: 700; margin-bottom: 15px;">Match Complete!</p>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="cork-btn" onclick="submitKnockoutResult()" style="background: var(--pink);">BACK TO BRACKET</button>
                    </div>
                    <p id="saveStatus" style="margin-top: 15px; font-size: 14px; color: #6b7280;"></p>
                `;
            }
        }

        // Submit knockout match result
        async function submitKnockoutResult() {
            if (!knockoutContext) {
                window.location.href = '/pages/knockout.html';
                return;
            }

            const saveStatus = document.getElementById('saveStatus');
            saveStatus.textContent = 'Submitting result...';

            try {
                const score1 = gameState.player1.legs;
                const score2 = gameState.player2.legs;
                const winnerIndex = score1 > score2 ? 0 : 1;

                const response = await fetch(`${CLOUD_FUNCTIONS_URL}/submitKnockoutMatch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        knockout_id: knockoutContext.knockout_id,
                        match_number: knockoutContext.match_number,
                        winner_index: winnerIndex,
                        score: [score1, score2]
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear knockout context and go back to bracket
                    localStorage.removeItem('knockoutContext');
                    window.location.href = `/pages/knockout.html?id=${knockoutContext.knockout_id}`;
                } else {
                    saveStatus.textContent = 'Error: ' + result.error;
                    saveStatus.style.color = '#E03786';
                }
            } catch (error) {
                console.error('Error submitting knockout result:', error);
                saveStatus.textContent = 'Failed to submit. Going back to bracket...';
                saveStatus.style.color = '#E03786';
                // Still go back even on error
                setTimeout(() => {
                    window.location.href = `/pages/knockout.html?id=${knockoutContext.knockout_id}`;
                }, 2000);
            }
        }
        window.submitKnockoutResult = submitKnockoutResult;

        function updateAverages(player, legAvgEl, matchAvgEl) {
            const throws = player.throws;
            
            if (throws.length === 0) {
                legAvgEl.textContent = '0.0';
                matchAvgEl.textContent = '0.0';
                return;
            }

            const legTotal = throws.reduce((sum, t) => sum + (t.bust ? 0 : t.total), 0);
            const legAvg = throws.length > 0 ? (legTotal / throws.length).toFixed(1) : '0.0';
            
            legAvgEl.textContent = legAvg;
            matchAvgEl.textContent = legAvg;
        }

        function resetToWelcome() {
            elements.winnerModal.classList.remove('active');
            elements.gameScreen.classList.remove('game-started');

            gameState.player1 = { name: '', score: 501, legs: 0, sets: 0, throws: [], currentThrow: [] };
            gameState.player2 = { name: '', score: 501, legs: 0, sets: 0, throws: [], currentThrow: [] };
            gameState.currentPlayer = 1;
            gameState.selectedGameType = 501;
            gameState.startingScore = 501;
            gameState.bestOfLegs = 3;
            gameState.bestOfSets = 1;
            gameState.inOption = 'free';
            gameState.outOption = 'free';
            gameState.inputValue = '';
            gameState.inputMode = 'preset';
            gameState.gameStarted = false;
            gameState.selectedDart = null;
            gameState.showingOutshot = false;

            // Reset match stats for pickup game tracking
            matchStats.legs = [];
            matchStats.player1_match = { darts: 0, points: 0, tons: 0, ton_40: 0, ton_80: 0, checkouts: 0, checkout_points: 0 };
            matchStats.player2_match = { darts: 0, points: 0, tons: 0, ton_40: 0, ton_80: 0, checkouts: 0, checkout_points: 0 };

            // Reset save game UI
            const saveSection = document.getElementById('saveGameSection');
            if (saveSection) {
                saveSection.innerHTML = `
                    <p style="font-weight: 700; margin-bottom: 15px;">Save this game to track your stats?</p>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="cork-btn" onclick="savePickupGame()" style="background: #4CAF50;">SAVE GAME</button>
                        <button class="cork-btn" onclick="skipSaveGame()" style="background: #6b7280;">SKIP</button>
                    </div>
                    <p id="saveStatus" style="margin-top: 15px; font-size: 14px; color: #6b7280;"></p>
                `;
            }
            document.getElementById('newGameBtn').style.display = 'none';

            showWelcome();
        }

        function updateDisplay() {
            requestAnimationFrame(() => {
                elements.player1NameDisplay.textContent = gameState.player1.name.toUpperCase();
                elements.player2NameDisplay.textContent = gameState.player2.name.toUpperCase();

                elements.player1LegScore.textContent = `LEGS: ${gameState.player1.legs} | SETS: ${gameState.player1.sets}`;
                elements.player2LegScore.textContent = `LEGS: ${gameState.player2.legs} | SETS: ${gameState.player2.sets}`;

                updateAverages(gameState.player1, elements.player1LegAvg, elements.player1MatchAvg);
                updateAverages(gameState.player2, elements.player2LegAvg, elements.player2MatchAvg);

                elements.player1Score.textContent = gameState.player1.score;
                elements.player2Score.textContent = gameState.player2.score;

                if (gameState.currentPlayer === 1) {
                    elements.player1Card.classList.add('active');
                    elements.player1Card.classList.remove('inactive');
                    elements.player2Card.classList.remove('active');
                    elements.player2Card.classList.add('inactive');
                } else {
                    elements.player2Card.classList.add('active');
                    elements.player2Card.classList.remove('inactive');
                    elements.player1Card.classList.remove('active');
                    elements.player1Card.classList.add('inactive');
                }

                updateThrowHistory(elements.player1History, gameState.player1.throws);
                updateThrowHistory(elements.player2History, gameState.player2.throws);

                updateInputDisplay();
                switchToPresetMode();
            });
        }

        function updateThrowHistory(container, throws) {
            const displayThrows = throws.slice(-6);
            const startIndex = Math.max(0, throws.length - 6);
            
            const fragment = document.createDocumentFragment();
            
            displayThrows.forEach((throwData, idx) => {
                const throwNum = startIndex + idx + 1;
                const div = document.createElement('div');
                div.className = 'throw-item';
                
                let displayText = throwData.total.toString();
                if (throwData.bust) {
                    displayText += ' <span style="color: #E03786;">(BUST)</span>';
                } else if (throwData.checkout) {
                    displayText += ' <span style="color: #4CAF50;">‚úì (OUT)</span>';
                }
                
                div.innerHTML = `
                    <span class="throw-number">#${throwNum}</span>
                    <span class="throw-score">${displayText}</span>
                `;
                fragment.appendChild(div);
            });
            
            container.innerHTML = '';
            container.appendChild(fragment);
            container.scrollTop = container.scrollHeight;
        }

        // MATCH STATS TRACKING
        const matchStats = {
            legs: [],
            player1_match: { darts: 0, points: 0, tons: 0, ton_40: 0, ton_80: 0, checkouts: 0, checkout_points: 0 },
            player2_match: { darts: 0, points: 0, tons: 0, ton_40: 0, ton_80: 0, checkouts: 0, checkout_points: 0 }
        };

        function countTons(throws) {
            let tons = 0, ton_40 = 0, ton_80 = 0, ton_00 = 0, ton_20 = 0, ton_60 = 0, one_seventyone = 0, high_score = 0;
            throws.forEach(t => {
                if (t.bust) return;
                const score = t.total;
                if (score > high_score) high_score = score;
                if (score >= 100 && score < 120) { tons++; ton_00++; }
                else if (score >= 120 && score < 140) { tons++; ton_20++; }
                else if (score >= 140 && score < 160) { tons++; ton_40++; }
                else if (score >= 160 && score < 180) { tons++; ton_60++; ton_80++; }
                else if (score === 180) { tons++; ton_80++; }
                if (score === 171) one_seventyone++;
            });
            return { tons, ton_00, ton_20, ton_40, ton_60, ton_80, one_seventyone, high_score };
        }

        function calculateLegStats(player, isWinner) {
            const throws = player.throws;

            // Calculate total darts - account for checkout darts (may be 1, 2, or 3)
            let totalDarts = 0;
            let checkoutDarts = 3; // default

            for (const t of throws) {
                if (t.checkout && (t.dart || t.checkout_darts)) {
                    // Checkout throw - use actual darts thrown (1, 2, or 3)
                    const darts = t.checkout_darts || t.dart || 3;
                    totalDarts += darts;
                    checkoutDarts = darts;
                } else if (t.checkout) {
                    // Checkout without dart count - assume 3
                    totalDarts += 3;
                    checkoutDarts = 3;
                } else {
                    // Normal throw - always 3 darts
                    totalDarts += 3;
                }
            }

            const totalPoints = throws.reduce((sum, t) => sum + (t.bust ? 0 : t.total), 0);
            const first9Points = throws.slice(0, 3).reduce((sum, t) => sum + (t.bust ? 0 : t.total), 0);
            const tonStats = countTons(throws);

            const stats = {
                darts_thrown: totalDarts,
                points_scored: totalPoints,
                first9_darts: Math.min(throws.length, 3) * 3,
                first9_points: first9Points,
                ...tonStats,
                checkout_attempts: isWinner ? 1 : 0,
                checkout_darts: isWinner ? checkoutDarts : 0
            };

            if (isWinner) {
                const lastThrow = throws[throws.length - 1];
                if (lastThrow && lastThrow.checkout) {
                    stats.checkout = lastThrow.total;
                    if (lastThrow.finish_type) {
                        stats.finish_type = lastThrow.finish_type;
                    }
                }
            }

            return stats;
        }

        function recordLegEnd(winner) {
            const p1Stats = calculateLegStats(gameState.player1, winner === 1);
            const p2Stats = calculateLegStats(gameState.player2, winner === 2);

            matchStats.legs.push({
                winner: winner === 1 ? 'player1' : 'player2',
                player1_stats: p1Stats,
                player2_stats: p2Stats
            });

            // Accumulate match totals
            matchStats.player1_match.darts += p1Stats.darts_thrown;
            matchStats.player1_match.points += p1Stats.points_scored;
            matchStats.player1_match.tons += p1Stats.tons;
            matchStats.player2_match.darts += p2Stats.darts_thrown;
            matchStats.player2_match.points += p2Stats.points_scored;
            matchStats.player2_match.tons += p2Stats.tons;
        }

        // CLOUD FUNCTION URL (update to your project)
        const CLOUD_FUNCTIONS_URL = 'https://us-central1-brdc-v2.cloudfunctions.net';

        async function savePickupGame() {
            const saveStatus = document.getElementById('saveStatus');
            saveStatus.textContent = 'Saving game...';
            saveStatus.style.color = '#6b7280';

            try {
                // Use stored PIN or prompt for it
                let player1Pin = localStorage.getItem('brdc_player_pin') || null;
                let player2Pin = null;

                // Check if player 1 is a bot
                const player1IsBot = gameState.player1.isBot || false;
                const player2IsBot = gameState.player2.isBot || false;

                if (!player1Pin && !player1IsBot) {
                    player1Pin = prompt(`Enter PIN for ${gameState.player1.name} to track stats (or leave blank for guest):`);
                    if (player1Pin) localStorage.setItem('brdc_player_pin', player1Pin.toUpperCase());
                }

                if (!player2IsBot) {
                    player2Pin = prompt(`Enter PIN for ${gameState.player2.name} to track stats (or leave blank for guest):`);
                }

                const winnerIndex = gameState.player1.sets > gameState.player2.sets ? 0 : 1;

                const payload = {
                    game_type: gameState.startingScore.toString(),
                    players: [
                        { pin: player1Pin?.toUpperCase() || null, name: gameState.player1.name, is_bot: player1IsBot },
                        { pin: player2Pin?.toUpperCase() || null, name: gameState.player2.name, is_bot: player2IsBot }
                    ],
                    winner_index: winnerIndex,
                    legs: matchStats.legs,
                    match_config: {
                        bestOfLegs: gameState.bestOfLegs,
                        bestOfSets: gameState.bestOfSets,
                        outOption: gameState.outOption, // 'free', 'double', or 'master'
                        inOption: gameState.inOption,   // 'free' or 'double'
                        // Legacy fields for backwards compatibility
                        doubleOut: gameState.outOption === 'double',
                        masterOut: gameState.outOption === 'master',
                        doubleIn: gameState.inOption === 'double'
                    }
                };

                const response = await fetch(`${CLOUD_FUNCTIONS_URL}/savePickupGame`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.success) {
                    saveStatus.textContent = 'Game saved! Stats updated.';
                    saveStatus.style.color = '#4CAF50';
                } else {
                    throw new Error(result.error || 'Failed to save');
                }
            } catch (error) {
                console.error('Error saving game:', error);
                saveStatus.textContent = 'Failed to save: ' + error.message;
                saveStatus.style.color = '#E03786';
            }

            document.getElementById('saveGameSection').innerHTML = '';
            document.getElementById('newGameBtn').style.display = 'block';
        }

        function skipSaveGame() {
            document.getElementById('saveGameSection').innerHTML = '';
            document.getElementById('newGameBtn').style.display = 'block';
        }

        // Modify winLeg to record stats
        const originalWinLeg = winLeg;
        winLeg = function() {
            recordLegEnd(gameState.currentPlayer);
            originalWinLeg();
        };

        // Initialize
        initializeEventListeners();
        updateInputDisplay();

        window.addEventListener('load', function() {
            setTimeout(() => window.scrollTo(0, 1), 0);
        });

        // Warn user before leaving with game in progress
        window.onbeforeunload = function(e) {
            const legsToWin = Math.ceil(gameState.bestOfLegs / 2);
            const matchComplete = (gameState.players[0].legs >= legsToWin || gameState.players[1].legs >= legsToWin);
            if (gameState.gameStarted && !matchComplete) {
                e.preventDefault();
                return "You have a game in progress. Are you sure you want to leave?";
            }
        };
    </script>
<script src="/js/feedback.js"></script>
</body>
