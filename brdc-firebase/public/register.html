<!DOCTYPE html>
<html>
<head>
  <title>Register | BRDC</title>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, addDoc, collection } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { RegistrationForm } from '/components.js';

    const app = initializeApp({/*config*/});
    const db = getFirestore(app);
    const eventId = new URLSearchParams(location.search).get('event_id');

    async function load() {
      const eventDoc = await getDoc(doc(db, 'events', eventId));
      const event = eventDoc.data();
      const tournamentDoc = await getDoc(doc(db, 'tournaments', event.tournament_id));
      const tournament = tournamentDoc.data();
      
      document.body.innerHTML = RegistrationForm({ event, tournament });
      document.getElementById('registrationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        await addDoc(collection(db, 'registrations'), {
          event_id: eventId,
          tournament_id: event.tournament_id,
          full_name_snapshot: formData.get('full_name'),
          email_snapshot: formData.get('email'),
          phone_snapshot: formData.get('phone'),
          sms_opt_in: formData.get('sms_opt_in') === 'on',
          status: 'active',
          created_at: new Date()
        });
        alert('Registered!');
      });
    }
    load();
  </script>
</head>
<body></body>
</html>